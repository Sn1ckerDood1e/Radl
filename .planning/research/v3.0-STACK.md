# v3.0 Stack Additions: Native Mobile & Legal Compliance

**Milestone:** Production Polish & Native Mobile Apps
**Researched:** 2026-01-29
**Confidence:** HIGH (verified with official documentation and recent sources)

## Executive Summary

Radl v3.0 needs: (1) native iOS/Android apps for App Store presence, (2) legal document pages (Terms of Service, Privacy Policy). This research recommends **Capacitor 8** for native app wrapping using the `server.url` approach (loading hosted PWA), and **@next/mdx** for static legal pages.

**Key insight:** Radl's existing architecture (92 API routes, SSR pages, Supabase auth) prevents static export. The app MUST use Capacitor's hosted URL approach rather than bundling static assets.

---

## Native Mobile Apps

### Recommendation: Capacitor 8 with server.url

**Decision:** Use Capacitor 8 to wrap the hosted PWA, NOT a static export.

**Why Capacitor over React Native rebuild:**
- Radl already has 136k LOC TypeScript, mobile-optimized UI, PWA infrastructure
- React Native would require complete UI rewrite (6+ months of work)
- Capacitor wraps existing code with native shell (2-3 weeks of work)
- Existing push notifications, offline support, gestures all work

**Why server.url over static export:**
- Radl has 92 API routes and dynamic SSR pages
- Next.js static export (`output: 'export'`) does NOT support:
  - API routes
  - Server-side rendering (getServerSideProps)
  - Server Actions
  - Middleware
- Radl uses ALL of these features
- Static export would require complete architectural rewrite

### Capacitor 8 Core Packages

| Package | Version | Purpose |
|---------|---------|---------|
| `@capacitor/core` | ^8.0.1 | Runtime bridge between web and native |
| `@capacitor/cli` | ^8.0.1 | Build and sync commands |
| `@capacitor/ios` | ^8.0.1 | iOS native project template |
| `@capacitor/android` | ^8.0.1 | Android native project template |

### Essential Capacitor Plugins

| Plugin | Version | Purpose | Why Needed |
|--------|---------|---------|------------|
| `@capacitor/app` | ^8.0.0 | App lifecycle, URL handling | Deep links, app state |
| `@capacitor/splash-screen` | ^8.0.0 | Native splash screen | App Store requirement |
| `@capacitor/status-bar` | ^8.0.0 | Status bar control | iOS/Android styling |
| `@capacitor/push-notifications` | ^8.0.0 | Native push notifications | Replace web push on native |
| `@capacitor/haptics` | ^8.0.0 | Vibration feedback | Enhanced UX on native |
| `@capacitor/share` | ^8.0.0 | Native share sheet | Lineup/roster sharing |
| `@capacitor/keyboard` | ^8.0.0 | Keyboard control | Form input handling |

### Capacitor 8 Requirements

| Requirement | Version |
|-------------|---------|
| Node.js | 22.x LTS |
| Xcode | 26.0+ |
| iOS Deployment Target | 15.0+ |
| Android Studio | Otter 2025.2.1+ |
| Android minSdk | 24 |
| Android targetSdk | 36 |

### Configuration Approach

```typescript
// capacitor.config.ts
import type { CapacitorConfig } from '@capacitor/cli';

const config: CapacitorConfig = {
  appId: 'com.radl.app',
  appName: 'Radl',
  webDir: 'out', // Not used with server.url
  server: {
    // Load hosted PWA instead of bundled assets
    url: 'https://app.radl.io',
    // Allow navigation within app domain
    allowNavigation: ['app.radl.io', '*.supabase.co'],
  },
  ios: {
    contentInset: 'automatic',
    // Use safe area CSS variables
    handleApplicationNotifications: false, // Use web push
  },
  android: {
    // Handle edge-to-edge properly
    // Capacitor 8 removed adjustMarginsForEdgeToEdge
  },
  plugins: {
    SplashScreen: {
      launchShowDuration: 2000,
      backgroundColor: '#1a1a2e', // Radl brand color
    },
    PushNotifications: {
      presentationOptions: ['badge', 'sound', 'alert'],
    },
  },
};

export default config;
```

### App Store Approval Strategy

**Risk:** Apple may reject "web wrapper" apps under Guideline 4.2 (Minimum Functionality).

**Mitigation:**
1. Use native push notifications via `@capacitor/push-notifications` (not web push)
2. Implement native splash screen with proper branding
3. Add native share functionality for lineups/rosters
4. Add haptic feedback for drag-and-drop operations
5. Implement deep linking for invitation codes
6. Handle offline states with native UI (not browser error)

**What makes Radl acceptable:**
- Substantial team management functionality (not just content display)
- Rich interactive features (drag-drop lineups, QR scanning)
- Native feature integration (push, share, haptics)
- Offline-first architecture with Dexie.js

### Installation

```bash
# Core Capacitor
npm install @capacitor/core@^8.0.1
npm install -D @capacitor/cli@^8.0.1

# Platform packages
npm install @capacitor/ios@^8.0.1 @capacitor/android@^8.0.1

# Essential plugins
npm install @capacitor/app@^8.0.0 \
  @capacitor/splash-screen@^8.0.0 \
  @capacitor/status-bar@^8.0.0 \
  @capacitor/push-notifications@^8.0.0 \
  @capacitor/haptics@^8.0.0 \
  @capacitor/share@^8.0.0 \
  @capacitor/keyboard@^8.0.0

# Initialize platforms
npx cap init
npx cap add ios
npx cap add android
```

### Push Notifications: Native vs Web

**Current state:** Radl uses web-push library with Serwist service worker.

**Native app approach:**
- Keep web push for PWA users (browser, installed PWA)
- Use `@capacitor/push-notifications` for App Store/Play Store versions
- Both use same backend API with Supabase
- Detect platform and use appropriate token registration

```typescript
// Detection pattern
import { Capacitor } from '@capacitor/core';

const isNative = Capacitor.isNativePlatform();
// true on iOS/Android app, false on web/PWA
```

---

## Legal Document Pages

### Recommendation: @next/mdx

**Decision:** Use `@next/mdx` for Terms of Service and Privacy Policy pages.

**Why @next/mdx:**
- Native Next.js integration (no runtime overhead)
- Files become routes automatically (app/legal/terms/page.mdx)
- Works with existing Tailwind prose styling
- Build-time processing (fast page loads)
- No additional runtime dependencies

**Why NOT react-markdown:**
- Requires runtime processing
- Larger client bundle
- Overkill for static legal content

**Why NOT external services (Termageddon, Termly):**
- Legal content is straightforward for a SaaS
- External services add cost ($10-30/month)
- Content can be maintained in-repo with version control
- No third-party dependency for core legal pages

### @next/mdx Setup

| Package | Version | Purpose |
|---------|---------|---------|
| `@next/mdx` | ^16.1.3 | MDX processing for Next.js |
| `@mdx-js/loader` | ^3.1.0 | Webpack loader for MDX |
| `@mdx-js/react` | ^3.1.0 | React context for MDX |
| `@types/mdx` | ^2.0.13 | TypeScript definitions |

### Configuration

```typescript
// next.config.ts
import type { NextConfig } from "next";
import withSerwistInit from "@serwist/next";
import createMDX from '@next/mdx';

const revision = crypto.randomUUID();

const withSerwist = withSerwistInit({
  swSrc: "src/app/sw.ts",
  swDest: "public/sw.js",
  additionalPrecacheEntries: [{ url: "/~offline", revision }],
});

const withMDX = createMDX({
  // Optionally add remark/rehype plugins
  options: {
    remarkPlugins: [],
    rehypePlugins: [],
  },
});

const nextConfig: NextConfig = {
  pageExtensions: ['js', 'jsx', 'md', 'mdx', 'ts', 'tsx'],
  outputFileTracingIncludes: {
    "/*": ["./src/generated/prisma/**/*"],
  },
};

// Compose plugins: withMDX wraps config, then withSerwist wraps result
export default withSerwist(withMDX(nextConfig));
```

```typescript
// mdx-components.tsx (in src/ directory)
import type { MDXComponents } from 'mdx/types';

export function useMDXComponents(components: MDXComponents): MDXComponents {
  return {
    // Use Tailwind prose classes for legal docs
    h1: ({ children }) => (
      <h1 className="text-3xl font-bold mb-6">{children}</h1>
    ),
    h2: ({ children }) => (
      <h2 className="text-2xl font-semibold mt-8 mb-4">{children}</h2>
    ),
    p: ({ children }) => (
      <p className="mb-4 text-muted-foreground">{children}</p>
    ),
    ul: ({ children }) => (
      <ul className="list-disc pl-6 mb-4 space-y-2">{children}</ul>
    ),
    ...components,
  };
}
```

### File Structure

```
src/app/
  legal/
    layout.tsx          # Legal pages layout with prose styling
    terms/
      page.mdx          # Terms of Service content
    privacy/
      page.mdx          # Privacy Policy content
    cookies/
      page.mdx          # Cookie Policy (optional)
```

### Installation

```bash
npm install @next/mdx@^16.1.3 @mdx-js/loader@^3.1.0 @mdx-js/react@^3.1.0
npm install -D @types/mdx@^2.0.13
```

---

## What NOT to Add

### Do NOT Add: React Native
- **Why:** Would require complete UI rewrite of 136k LOC
- **Time:** 6+ months vs 2-3 weeks for Capacitor
- **Risk:** Lose all PWA functionality, offline support, existing testing

### Do NOT Add: Tauri Mobile
- **Why:** Mobile support still maturing (beta), plugin ecosystem limited
- **Better for:** Desktop apps, not mobile-first
- **Risk:** Less community support, fewer native plugins

### Do NOT Add: Expo
- **Why:** Requires React Native codebase
- **Same problem as React Native:** Complete rewrite

### Do NOT Add: Static Export Configuration
- **Why:** Incompatible with existing architecture (API routes, SSR, middleware)
- **Would break:** Authentication, data fetching, real-time features

### Do NOT Add: next-mdx-remote
- **Why:** Overkill for local static legal documents
- **Use case:** CMS-driven content, not local files
- **Maintenance:** Not as actively maintained as @next/mdx

### Do NOT Add: External Legal Services Initially
- **Why:** Can always migrate later if needed
- **Cost:** $10-30/month for services like Termageddon
- **Alternative:** Use template generators (Termly, TermsFeed) for initial content, self-host as MDX

---

## Complete Package Additions

### Production Dependencies

```json
{
  "@capacitor/core": "^8.0.1",
  "@capacitor/ios": "^8.0.1",
  "@capacitor/android": "^8.0.1",
  "@capacitor/app": "^8.0.0",
  "@capacitor/splash-screen": "^8.0.0",
  "@capacitor/status-bar": "^8.0.0",
  "@capacitor/push-notifications": "^8.0.0",
  "@capacitor/haptics": "^8.0.0",
  "@capacitor/share": "^8.0.0",
  "@capacitor/keyboard": "^8.0.0",
  "@next/mdx": "^16.1.3",
  "@mdx-js/loader": "^3.1.0",
  "@mdx-js/react": "^3.1.0"
}
```

### Dev Dependencies

```json
{
  "@capacitor/cli": "^8.0.1",
  "@types/mdx": "^2.0.13"
}
```

### Installation Commands

```bash
# Capacitor Core + CLI
npm install @capacitor/core@^8.0.1 @capacitor/ios@^8.0.1 @capacitor/android@^8.0.1
npm install -D @capacitor/cli@^8.0.1

# Capacitor Plugins
npm install @capacitor/app@^8.0.0 @capacitor/splash-screen@^8.0.0 \
  @capacitor/status-bar@^8.0.0 @capacitor/push-notifications@^8.0.0 \
  @capacitor/haptics@^8.0.0 @capacitor/share@^8.0.0 @capacitor/keyboard@^8.0.0

# MDX Support
npm install @next/mdx@^16.1.3 @mdx-js/loader@^3.1.0 @mdx-js/react@^3.1.0
npm install -D @types/mdx@^2.0.13

# Initialize Capacitor
npx cap init "Radl" "com.radl.app"
npx cap add ios
npx cap add android
```

---

## Integration Points with Existing Stack

### Serwist + Capacitor

- Service worker continues to work in Capacitor WebView
- Offline caching works as expected
- Push handling needs platform detection:
  - Native: Use @capacitor/push-notifications
  - Web: Use existing web-push + service worker

### Supabase + Capacitor

- Authentication continues to work (cookies in WebView)
- May need to handle deep links for auth callbacks
- Consider @capacitor/browser for OAuth flows if needed

### @use-gesture/react + Capacitor

- Touch gestures work in WebView
- Add @capacitor/haptics for physical feedback on gestures
- Existing vaul (drawer) and swipe gestures unchanged

### Dexie.js + Capacitor

- IndexedDB works in WebView
- Offline-first patterns continue to work
- No changes needed

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Apple rejection (4.2) | Medium | High | Add native features (push, haptics, share) |
| server.url limitations | Low | Medium | Native plugins still work, just no bundled assets |
| Push notification token handling | Medium | Medium | Platform detection, dual registration |
| Deep link handling | Low | Low | Capacitor App plugin handles this |
| Node 22 requirement | Low | Low | Upgrade CI/CD and local environments |

---

## Confidence Assessment

| Component | Confidence | Verification |
|-----------|------------|--------------|
| Capacitor 8 approach | HIGH | Official docs, verified release notes |
| server.url viability | MEDIUM | Community reports, some gray area with Apple |
| @next/mdx integration | HIGH | Official Next.js docs, version verified |
| Plugin versions | HIGH | npm registry, GitHub releases |
| Node.js 22 requirement | HIGH | Official Capacitor 8 docs |

---

## Sources

### Capacitor
- [Capacitor 8 Announcement](https://ionic.io/blog/announcing-capacitor-8)
- [Capacitor 8 Update Guide](https://capacitorjs.com/docs/updating/8-0)
- [server.url Production Discussion](https://github.com/ionic-team/capacitor/discussions/4080)
- [Next.js + Capacitor Tutorial](https://capgo.app/blog/building-a-native-mobile-app-with-nextjs-and-capacitor/)

### Next.js MDX
- [Next.js MDX Guide](https://nextjs.org/docs/app/guides/mdx)
- [@next/mdx npm](https://www.npmjs.com/package/@next/mdx)
- [Multiple Config Wrappers](https://github.com/vercel/next.js/discussions/40710)

### App Store Guidelines
- [App Store Review Guidelines](https://developer.apple.com/app-store/review/guidelines/)
- [WebView App Approval Guide](https://www.mobiloud.com/blog/app-store-review-guidelines-webview-wrapper)
- [2025 Review Checklist](https://nextnative.dev/blog/app-store-review-guidelines)
