---
phase: 30-equipment-flow-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false
requirements:
  - EQUP-01
  - EQUP-02
  - EQUP-03
  - EQUP-04

must_haves:
  truths:
    - "Admin can add equipment with name, type, status and it appears in equipment list"
    - "Equipment shows usage history when assigned to practice lineups"
    - "Anonymous user can scan QR code and submit damage report without login"
    - "Coach can view damage report details and mark issue as resolved"
  artifacts: []
  key_links: []
---

<objective>
Manual E2E verification of complete equipment flow

Purpose: Verify all equipment-related features work end-to-end. This phase tests the equipment lifecycle from creation through damage resolution, including QR code scanning for public damage reporting.

Output: Verified working equipment flow with documented test results.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-equipment-flow-testing/30-RESEARCH.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Verify: Equipment CRUD with all fields (EQUP-01)</name>
  <what-built>
Equipment management with:
- Create form: type selector (SHELL, OAR, LAUNCH, OTHER)
- All fields: name, manufacturer, serialNumber, yearAcquired, purchasePrice, notes
- Shell-specific: boatClass (required for SHELL), weightCategory
- Status values: ACTIVE, INACTIVE, RETIRED
- QR code display on detail page
  </what-built>
  <how-to-verify>
**Prerequisites:**
- Logged in as COACH with an existing team
- Navigate to `/{teamSlug}/equipment`

**Test Steps:**

**Create SHELL Equipment (Full Fields):**

1. Click "Add Equipment" or navigate to `/{teamSlug}/equipment/new`
2. Select Type: **SHELL**
3. Verify shell-specific fields appear:
   - Boat Class dropdown (should be required)
   - Weight Category dropdown
4. Fill ALL fields:
   - Name: "Varsity 8+ Test"
   - Boat Class: EIGHT_8_PLUS (or "Eight 8+")
   - Weight Category: HEAVYWEIGHT
   - Manufacturer: "Vespoli"
   - Serial Number: "V2024-001"
   - Year Acquired: 2024
   - Purchase Price: 45000
   - Notes: "Test equipment for E2E verification"
5. Submit form
6. Verify redirect to equipment list or detail page
7. Verify equipment appears in list with correct name and type

**Test boatClass Required Validation:**

8. Click "Add Equipment" again
9. Select Type: SHELL
10. Fill only: Name: "Validation Test Shell"
11. Leave Boat Class empty
12. Attempt to submit
13. Verify validation error: "Boat class required for shells"

**Create Non-Shell Equipment:**

14. Click "Add Equipment"
15. Select Type: **OAR**
16. Verify shell-specific fields do NOT appear
17. Fill: Name: "Starboard Sweep Set"
18. Submit and verify creation

19. Click "Add Equipment"
20. Select Type: **LAUNCH**
21. Fill: Name: "Coach Launch 1"
22. Submit and verify creation

23. Click "Add Equipment"
24. Select Type: **OTHER**
25. Fill: Name: "Cox Boxes (4 pack)"
26. Submit and verify creation

**Read - Detail Page:**

27. Click on "Varsity 8+ Test" to open detail page
28. Verify all fields display correctly:
    - Name, Type, Status badge (ACTIVE)
    - Manufacturer, Serial Number
    - Year Acquired, Purchase Price
    - Boat Class, Weight Category
    - Notes
29. Verify QR code section displays (coach view)
30. Verify "Last Inspected: Never" or similar

**Update - Edit Equipment:**

31. Click "Edit" button on detail page
32. Modify fields:
    - Name: "Varsity 8+ Renamed"
    - Manufacturer: "Vespoli USA"
    - Notes: "Updated notes"
33. Save changes
34. Verify changes persist on detail page
35. Refresh page and verify changes still show

**Status Transitions:**

36. On equipment detail page, find "Change Status" or status toggle
37. Click to change status from ACTIVE to INACTIVE
38. Verify status badge updates
39. Click again to change to RETIRED
40. Verify status badge updates
41. Click again to return to ACTIVE
42. Refresh page and verify status persists

**Expected Results:**
- [ ] SHELL type shows boatClass and weightCategory fields
- [ ] boatClass is required for SHELL type (validation error if empty)
- [ ] OAR, LAUNCH, OTHER types do NOT show shell fields
- [ ] All optional fields save correctly (manufacturer, serial, year, price, notes)
- [ ] Equipment appears in list after creation
- [ ] Detail page shows all fields
- [ ] QR code displays on detail page (coach only)
- [ ] Edit form pre-fills existing values
- [ ] Edit saves and persists changes
- [ ] Status cycles: ACTIVE -> INACTIVE -> RETIRED -> ACTIVE
- [ ] Status change persists after refresh
  </how-to-verify>
  <resume-signal>Type "equp-01-passed" if all checks pass, or describe any issues found</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Verify: Usage tracking through lineup assignments (EQUP-02)</name>
  <what-built>
Automatic equipment usage logging:
- Usage log created when equipment assigned to lineup
- Usage history displayed on equipment detail page
- Usage summary on equipment list page
- Links to practices from usage history
  </what-built>
  <how-to-verify>
**Prerequisites:**
- Equipment created from EQUP-01 test (e.g., "Varsity 8+ Renamed")
- Logged in as COACH
- At least 2-4 athletes on team roster

**Test Steps:**

**Create Practice with Lineup:**

1. Navigate to `/{teamSlug}/practices`
2. Create new practice (or use bulk-create):
   - Name: "Morning Row - Usage Test"
   - Date: tomorrow
   - Times: 6:00 AM - 8:00 AM
3. Open practice detail page
4. Add a WATER block
5. In the water block, click "Add Boat" or "Add Lineup"
6. Select the equipment: "Varsity 8+ Renamed"
7. Verify boat diagram/lineup view appears
8. Assign at least 2 athletes to seats (drag from roster)
9. Click "Save Lineups"
10. Verify save success (toast or confirmation)

**Verify Usage History:**

11. Navigate to equipment detail: `/{teamSlug}/equipment/{id}` for "Varsity 8+ Renamed"
12. Scroll to "Usage History" section (or similar)
13. Verify the practice appears:
    - Practice name: "Morning Row - Usage Test"
    - Practice date
14. Click on practice link in usage history
15. Verify navigation to practice detail page

**Create Second Practice:**

16. Navigate back to practices
17. Create another practice:
    - Name: "Afternoon Row - Usage Test"
    - Date: day after tomorrow
18. Add WATER block
19. Add lineup with SAME equipment: "Varsity 8+ Renamed"
20. Assign athletes and save

**Verify Usage Count:**

21. Navigate back to equipment detail for "Varsity 8+ Renamed"
22. Verify usage history now shows 2 entries
23. Verify both practices listed with correct names/dates

**Verify List Page Summary:**

24. Navigate to equipment list: `/{teamSlug}/equipment`
25. Look for "Most Used" section or usage summary
26. Verify "Varsity 8+ Renamed" appears (if it's in top 5)
27. Verify usage count shows (should be 2)
28. Look for "Recent Usage" section
29. Verify recent practices with equipment assignments display

**Expected Results:**
- [ ] Practice created with WATER block
- [ ] Equipment selected for lineup
- [ ] Athletes assigned to lineup seats
- [ ] Lineup saved successfully
- [ ] Usage history shows on equipment detail page
- [ ] Practice name and date display in usage history
- [ ] Practice link navigates correctly
- [ ] Multiple practices create multiple usage entries
- [ ] Usage count increments correctly
- [ ] Equipment list shows usage summary (Most Used or Recent)
  </how-to-verify>
  <resume-signal>Type "equp-02-passed" if all checks pass, or describe any issues found</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Verify: QR damage reporting without login (EQUP-03)</name>
  <what-built>
Public damage reporting via QR code:
- QR code on equipment detail page (coach view)
- Download QR as high-quality PNG
- Public report page at /report/{equipmentId}
- Form: reporterName, location, description, severity, category, photo
- Rate limiting + honeypot for spam prevention
- Success confirmation with reference ID
  </what-built>
  <how-to-verify>
**Prerequisites:**
- Equipment created from earlier tests (e.g., "Varsity 8+ Renamed")
- Logged in as COACH to view QR code
- Mobile device with camera for QR scanning (optional but recommended)

**Test Steps:**

**QR Code Generation:**

1. As COACH: Navigate to equipment detail for "Varsity 8+ Renamed"
2. Locate QR code section
3. Verify QR code displays:
   - QR code image visible
   - Equipment name label shows
   - "Scan to report damage" caption (or similar)
4. Click "Download PNG" button
5. Verify PNG file downloads
6. Verify filename: `qr-varsity-8-renamed.png` (or similar)
7. Open downloaded PNG and verify quality (should be high resolution)

**URL Navigation Test:**

8. Right-click QR code and copy report URL (or note URL from component)
9. URL format should be: `{base}/report/{equipmentId}`
10. Open a NEW INCOGNITO/PRIVATE browser window
11. Paste the report URL and navigate
12. Verify NO login prompt - page loads immediately
13. Verify page displays:
    - Team name or logo
    - Equipment name: "Varsity 8+ Renamed"
    - Damage report form

**Form Submission Test:**

14. Fill the form with MINOR severity:
    - Reporter Name: "Test Reporter"
    - Location: "Starboard side bow"
    - Description: "Small scratch on hull, cosmetic only. Testing damage report submission." (min 10 chars)
    - Severity: MINOR
    - Category: "Hull" (if dropdown available)
15. Submit WITHOUT photo first
16. Verify success confirmation:
    - Success message displays
    - Reference ID shows (optional)
17. Click "Report Another Issue" or similar
18. Verify form resets for new submission

**Photo Upload Test:**

19. Fill form again:
    - Reporter Name: "Photo Test"
    - Location: "Port rigger"
    - Description: "Testing photo upload functionality with a JPEG image."
    - Severity: MODERATE
20. Click photo upload or "Add Photo"
21. Select a JPEG image (under 10MB)
22. Verify preview displays
23. Test "Remove" button - click to remove photo
24. Re-add photo
25. Submit form
26. Verify success

**Photo Format Tests:**

27. Fill form with:
    - Description: "Testing PNG upload format."
    - Severity: MINOR
28. Upload PNG image
29. Submit and verify success

30. Fill form with:
    - Description: "Testing WebP upload format."
    - Severity: MINOR
31. Upload WebP image (if you have one)
32. Submit and verify success

**Photo Size Limit:**

33. Fill form
34. Try uploading file > 10MB
35. Verify error message about file size

**Real QR Scan (Mobile Device):**

36. Display the QR code PNG on your computer screen (or print it)
37. On mobile device, open camera app
38. Point camera at QR code
39. Verify QR detection and link appears
40. Tap link to open
41. Verify report page loads on mobile
42. Verify form is mobile-responsive (fields stack vertically)
43. Test photo capture from device camera
44. Fill and submit report from mobile
45. Verify success on mobile

**Honeypot Test (Optional - Advanced):**

46. Using browser dev tools on report page:
47. Inspect form and find hidden "website" or "honeypot" field
48. Manually fill the hidden field with any value
49. Fill rest of form normally
50. Submit
51. Verify "success" response (silently rejected - no report created)
52. As COACH: Check equipment damage history
53. Verify the honeypot submission was NOT recorded

**Expected Results:**
- [ ] QR code displays on equipment detail (coach view)
- [ ] Download PNG works with good quality
- [ ] Report URL loads without login (incognito)
- [ ] Team name and equipment name display on report page
- [ ] Form has all required fields (name, location, description, severity)
- [ ] Form has optional fields (category, photo)
- [ ] Description requires minimum 10 characters
- [ ] Severity levels available: MINOR, MODERATE, CRITICAL
- [ ] Submit without photo succeeds
- [ ] Success confirmation with optional reference ID
- [ ] Photo preview displays before submit
- [ ] Remove photo button works
- [ ] JPEG upload works
- [ ] PNG upload works
- [ ] File > 10MB shows error
- [ ] QR scan opens report page on mobile
- [ ] Mobile form is responsive
- [ ] Mobile photo capture works
  </how-to-verify>
  <resume-signal>Type "equp-03-passed" if all checks pass, or describe any issues found</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Verify: Damage report viewing and resolution (EQUP-04)</name>
  <what-built>
Damage report management:
- Damage history section on equipment detail
- Open/resolved status with visual distinction
- Photo lightbox for full-size images
- "Mark Resolved" button (coach only)
- RBAC enforcement (athletes cannot resolve)
- Notifications for coaches
  </what-built>
  <how-to-verify>
**Prerequisites:**
- Damage reports created from EQUP-03 test
- Equipment: "Varsity 8+ Renamed" should have multiple reports
- Logged in as COACH

**Test Steps:**

**Viewing Damage Reports:**

1. As COACH: Navigate to equipment detail for "Varsity 8+ Renamed"
2. Scroll to "Damage History" section
3. Verify open count displays: "(X open)" or similar
4. Verify reports listed in reverse chronological order (newest first)
5. Verify OPEN reports have visual distinction:
   - Red border or background
   - Status badge showing "OPEN"
6. Verify each report shows:
   - Severity badge (color-coded: MINOR=yellow, MODERATE=orange, CRITICAL=red)
   - Category tag (if submitted with category)
   - Reporter name
   - Location
   - Description (may be truncated)
   - Timestamp (reported date)

**Photo Lightbox:**

7. Find a report with photo (from EQUP-03 photo tests)
8. Click on photo thumbnail
9. Verify lightbox opens:
   - Full-size image displays
   - Background darkens/dims
10. Click X button or outside image to close
11. Verify lightbox closes smoothly

**Long Description Handling:**

12. If any report has long description (500+ chars):
13. Verify description truncates with "..." or "Show more"
14. Click "Show more" or expand button
15. Verify full description displays
16. Click "Show less" or collapse button
17. Verify description collapses

**Resolve a Report:**

18. Find an OPEN report with MINOR severity
19. Click "Mark Resolved" button
20. Verify immediate UI update:
    - Status changes to RESOLVED
    - "Mark Resolved" button disappears
    - "Resolved: {date}" timestamp appears
    - Report styling changes (grayed out)
21. Verify open count decrements
22. Refresh the page (Ctrl+R / Cmd+R)
23. Verify resolution persists:
    - Report still shows RESOLVED
    - Timestamp still shows

**Resolve Additional Reports:**

24. Resolve another OPEN report (MODERATE severity if available)
25. Verify same behavior as step 18-23
26. Note: Leave at least one report OPEN for RBAC test

**RBAC Test - Athlete View:**

27. Log out of COACH account
28. Log in as ATHLETE on the same team
29. Navigate to equipment detail for "Varsity 8+ Renamed"
30. Verify athlete CAN see:
    - Equipment details
    - Damage history section
    - Report list with statuses
31. Verify athlete CANNOT see:
    - "Mark Resolved" button (hidden or disabled)
    - QR code section (coach-only feature)
32. Find an OPEN report
33. Confirm there is no way to resolve it as athlete

**Notification Test (CRITICAL Severity):**

34. Log back in as COACH
35. Open a NEW incognito window
36. Navigate to report URL: `/report/{equipmentId}`
37. Submit a CRITICAL damage report:
    - Reporter Name: "Critical Test"
    - Location: "Hull crack"
    - Description: "Major structural damage found - hull crack spreading. Boat should not be used until inspected."
    - Severity: **CRITICAL**
38. Verify success confirmation

39. In main browser as COACH:
40. Check notification bell icon (top nav)
41. Verify new notification appears
42. Verify notification format: "[CRITICAL] Damage: Varsity 8+ Renamed" (or similar)
43. Click notification and verify navigation

44. (Optional) Check email inbox if email notifications configured
45. Verify email received for CRITICAL report

**Non-CRITICAL Notification Test:**

46. Submit another damage report with MODERATE severity
47. Check coach notifications
48. Verify in-app notification received
49. Verify NO email sent for MODERATE (in-app only)

**Expected Results:**
- [ ] Damage history section shows all reports
- [ ] Open count displays correctly
- [ ] OPEN reports have red/highlighted styling
- [ ] RESOLVED reports are grayed out
- [ ] Severity badges are color-coded
- [ ] Reporter name, location, description display
- [ ] Photo thumbnail displays for reports with photos
- [ ] Photo lightbox opens on click
- [ ] Lightbox closes on X or outside click
- [ ] Long descriptions truncate with expand/collapse
- [ ] "Mark Resolved" button visible for OPEN reports (coach)
- [ ] Clicking resolve updates status immediately
- [ ] Resolved timestamp appears
- [ ] Resolution persists after refresh
- [ ] Open count decrements after resolve
- [ ] ATHLETE cannot see "Mark Resolved" button
- [ ] ATHLETE cannot see QR code section
- [ ] CRITICAL report triggers in-app notification
- [ ] CRITICAL report triggers email notification (if configured)
- [ ] MODERATE report triggers in-app notification only
  </how-to-verify>
  <resume-signal>Type "equp-04-passed" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
## Summary Checklist

After all checkpoints pass:

| Requirement | Status | Notes |
|-------------|--------|-------|
| EQUP-01: Equipment CRUD with all fields | | |
| EQUP-02: Usage tracking via lineup assignment | | |
| EQUP-03: QR damage reporting without login | | |
| EQUP-04: Damage report viewing and resolution | | |

## Known Limitations

Document any issues found but deemed acceptable:
- Facility-owned equipment (teamId = null) cannot receive damage reports
- Usage logs persist even if lineup deleted (historical data preserved)
- QR code URL requires NEXT_PUBLIC_APP_URL in production
- Rate limiting: 5 reports per IP per hour (may affect rapid testing)
</verification>

<success_criteria>
- All 4 checkpoint tasks pass human verification
- Equipment can be created with all field types (SHELL with boat class, non-SHELL types)
- Usage tracking automatically logs when equipment assigned to lineups
- Anonymous users can report damage via QR code without login
- Coaches can view and resolve damage reports
- Athletes can view but not resolve reports (RBAC verified)
</success_criteria>

<output>
After completion, create `.planning/phases/30-equipment-flow-testing/30-01-SUMMARY.md` documenting test results with pass/fail for each requirement.
</output>
