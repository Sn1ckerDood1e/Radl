---
phase: 17-facility-ui-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/generated/prisma/index.ts
autonomous: true

must_haves:
  truths:
    - "Equipment bookings can be tracked in database"
    - "Booking status (pending, approved, denied, cancelled) is enforced"
    - "Facilities can configure booking window limit"
    - "Equipment requests generate notifications"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "EquipmentBooking model, Facility.bookingWindowDays, NotificationType.EQUIPMENT_REQUEST"
      contains: "model EquipmentBooking"
  key_links:
    - from: "EquipmentBooking"
      to: "Equipment"
      via: "equipmentId foreign key"
      pattern: "equipmentId\\s+String"
    - from: "EquipmentBooking"
      to: "Practice"
      via: "practiceId optional foreign key"
      pattern: "practiceId\\s+String\\?"
---

<objective>
Add database schema for equipment booking system and facility configuration.

Purpose: The booking system requires tracking reservations, their status, and conflict detection. This schema change is foundational for the entire equipment reservation feature (FAC-07).

Output: Updated Prisma schema with EquipmentBooking model, Facility.bookingWindowDays field, and EQUIPMENT_REQUEST notification type.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/17-facility-ui-features/17-CONTEXT.md
@.planning/phases/17-facility-ui-features/17-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add EquipmentBooking model and supporting schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the following to prisma/schema.prisma:

1. Add BookingStatus enum after existing enums:
```prisma
enum BookingStatus {
  PENDING    // Request awaiting approval
  APPROVED   // Confirmed booking
  DENIED     // Request rejected
  CANCELLED  // Booking cancelled by requester
}
```

2. Add EquipmentBooking model after Equipment model:
```prisma
// Equipment booking for shared equipment reservation
model EquipmentBooking {
  id           String        @id @default(uuid())
  equipmentId  String
  clubId       String        // Club making the booking
  practiceId   String?       // Optional: linked to practice (automatic booking)
  startTime    DateTime
  endTime      DateTime
  status       BookingStatus @default(PENDING)
  requestedBy  String        // userId who created request
  approvedBy   String?       // userId who approved (if approved)
  deniedReason String?       // Reason for denial (if denied)
  notes        String?       // Optional booking notes
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  equipment    Equipment     @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  club         Team          @relation("ClubBookings", fields: [clubId], references: [id], onDelete: Cascade)
  practice     Practice?     @relation(fields: [practiceId], references: [id], onDelete: SetNull)

  @@index([equipmentId, startTime, endTime])
  @@index([clubId])
  @@index([practiceId])
  @@index([status])
}
```

3. Add bookingWindowDays to Facility model (after billingType):
```prisma
  bookingWindowDays Int @default(30)  // How far in advance clubs can book shared equipment
```

4. Add EQUIPMENT_REQUEST to NotificationType enum:
```prisma
enum NotificationType {
  DAMAGE_REPORT
  LINEUP_ASSIGNMENT
  PRACTICE_CHANGE
  PRACTICE_CANCELLED
  ATHLETE_JOINED
  EQUIPMENT_REQUEST    // New: booking request notification
}
```

5. Add relations to existing models:
- Add to Equipment model: `bookings EquipmentBooking[]`
- Add to Team model: `equipmentBookings EquipmentBooking[] @relation("ClubBookings")`
- Add to Practice model: `equipmentBookings EquipmentBooking[]`
  </action>
  <verify>Run `npx prisma validate` - should pass with no errors</verify>
  <done>Schema validates successfully with EquipmentBooking model, BookingStatus enum, Facility.bookingWindowDays, and EQUIPMENT_REQUEST notification type</done>
</task>

<task type="auto">
  <name>Task 2: Generate Prisma client and verify types</name>
  <files>src/generated/prisma/index.ts</files>
  <action>
Run Prisma client generation to update TypeScript types:
```bash
npx prisma generate
```

Then verify the generated types include:
- BookingStatus enum
- EquipmentBooking type with all fields
- Equipment type with bookings relation
- Team type with equipmentBookings relation
- Facility type with bookingWindowDays field
- NotificationType with EQUIPMENT_REQUEST
  </action>
  <verify>Run `npx tsc --noEmit` - TypeScript compilation should pass</verify>
  <done>Prisma client generated with all new types available for use in application code</done>
</task>

<task type="auto">
  <name>Task 3: Push schema to database</name>
  <files>prisma/schema.prisma</files>
  <action>
Push the schema changes to the database:
```bash
npx prisma db push
```

This will:
1. Create EquipmentBooking table
2. Add bookingWindowDays column to Facility table (default 30)
3. Update NotificationType enum to include EQUIPMENT_REQUEST
4. Create indexes for efficient queries

Note: Use `db push` for development. Production deployments should use proper migrations.
  </action>
  <verify>Run `npx prisma db push` completes without errors. Verify table exists: `npx prisma studio` and check EquipmentBooking table is visible</verify>
  <done>Database schema updated with EquipmentBooking table and Facility.bookingWindowDays column</done>
</task>

</tasks>

<verification>
1. Schema validation: `npx prisma validate` passes
2. Type generation: `npx prisma generate` succeeds
3. TypeScript: `npx tsc --noEmit` passes
4. Database: `npx prisma db push` succeeds
5. Table exists: Can query `SELECT * FROM "EquipmentBooking" LIMIT 1;` without error (empty result is fine)
</verification>

<success_criteria>
- EquipmentBooking model exists with all required fields (equipmentId, clubId, practiceId, startTime, endTime, status, requestedBy, approvedBy)
- BookingStatus enum has PENDING, APPROVED, DENIED, CANCELLED values
- Facility model has bookingWindowDays field with default 30
- NotificationType enum includes EQUIPMENT_REQUEST
- All relations properly defined (Equipment.bookings, Team.equipmentBookings, Practice.equipmentBookings)
- TypeScript types generated and compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/17-facility-ui-features/17-01-SUMMARY.md`
</output>
