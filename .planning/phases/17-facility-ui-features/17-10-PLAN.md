---
phase: 17-facility-ui-features
plan: 10
type: execute
wave: 5
depends_on: [17-05, 17-06]
files_modified:
  - src/components/practices/booking-request-dialog.tsx
  - src/components/practices/equipment-availability-panel.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Coaches can request shared equipment when creating practices"
    - "Equipment availability panel shows booking status"
    - "Conflict information is displayed when equipment is unavailable"
    - "Request dialog allows submitting booking with notes"
  artifacts:
    - path: "src/components/practices/booking-request-dialog.tsx"
      provides: "Dialog for requesting equipment booking"
      exports: ["BookingRequestDialog"]
    - path: "src/components/practices/equipment-availability-panel.tsx"
      provides: "Enhanced availability panel with booking integration"
      min_lines: 150
  key_links:
    - from: "booking-request-dialog.tsx"
      to: "/api/equipment/bookings"
      via: "fetch POST"
      pattern: "fetch.*bookings.*POST"
---

<objective>
Integrate equipment booking into the practice creation flow for clubs.

Purpose: Clubs need to request shared equipment as part of practice creation, seeing availability and submitting booking requests (FAC-07).

Output: Enhanced equipment availability panel with booking request capability, integrated into practice form.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/17-facility-ui-features/17-CONTEXT.md
@.planning/phases/17-facility-ui-features/17-05-SUMMARY.md
@src/components/practices/equipment-availability-panel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create booking request dialog component</name>
  <files>src/components/practices/booking-request-dialog.tsx</files>
  <action>
Create `src/components/practices/booking-request-dialog.tsx`:

```tsx
'use client';

import { useState } from 'react';
import { format } from 'date-fns';
import { Loader2, Ship, Calendar, AlertTriangle } from 'lucide-react';
import { Button } from '@/components/ui/button';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';

interface BookingConflict {
  bookingId: string;
  clubName: string;
  startTime: string;
  endTime: string;
  status: string;
}

interface BookingRequestDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  equipment: {
    id: string;
    name: string;
    type: string;
    boatClass: string | null;
  };
  startTime: Date;
  endTime: Date;
  practiceId?: string;
  onSuccess?: () => void;
}

export function BookingRequestDialog({
  open,
  onOpenChange,
  equipment,
  startTime,
  endTime,
  practiceId,
  onSuccess,
}: BookingRequestDialogProps) {
  const [notes, setNotes] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [conflicts, setConflicts] = useState<BookingConflict[] | null>(null);

  const handleSubmit = async () => {
    setIsSubmitting(true);
    setError(null);
    setConflicts(null);

    try {
      const response = await fetch('/api/equipment/bookings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          equipmentId: equipment.id,
          practiceId,
          startTime: startTime.toISOString(),
          endTime: endTime.toISOString(),
          notes: notes || undefined,
        }),
      });

      const result = await response.json();

      if (!response.ok) {
        if (result.conflicts) {
          setConflicts(result.conflicts);
        }
        throw new Error(result.error || 'Failed to create booking request');
      }

      onSuccess?.();
      onOpenChange(false);
      setNotes('');
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Something went wrong');
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Ship className="h-5 w-5 text-[var(--accent)]" />
            Request Equipment
          </DialogTitle>
          <DialogDescription>
            Request to book this equipment for your practice
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          {/* Equipment Info */}
          <div className="bg-[var(--surface-2)] rounded-lg p-3">
            <p className="font-medium text-[var(--text-primary)]">{equipment.name}</p>
            <p className="text-sm text-[var(--text-muted)]">
              {equipment.type}
              {equipment.boatClass && ` - ${equipment.boatClass.replace(/_/g, ' ')}`}
            </p>
          </div>

          {/* Time Info */}
          <div className="flex items-center gap-2 text-sm text-[var(--text-secondary)]">
            <Calendar className="h-4 w-4" />
            <span>
              {format(startTime, 'EEEE, MMMM d')} &middot;{' '}
              {format(startTime, 'h:mm a')} - {format(endTime, 'h:mm a')}
            </span>
          </div>

          {/* Conflict Warning */}
          {conflicts && conflicts.length > 0 && (
            <div className="bg-amber-500/10 border border-amber-500/30 rounded-lg p-3">
              <div className="flex items-start gap-2">
                <AlertTriangle className="h-4 w-4 text-amber-400 mt-0.5 flex-shrink-0" />
                <div>
                  <p className="text-sm font-medium text-amber-300">Booking Conflict</p>
                  <p className="text-xs text-amber-300/80 mt-1">
                    This equipment is already booked:
                  </p>
                  <ul className="mt-2 space-y-1">
                    {conflicts.map((conflict) => (
                      <li key={conflict.bookingId} className="text-xs text-amber-300/80">
                        {conflict.clubName}: {format(new Date(conflict.startTime), 'MMM d h:mm a')} - {format(new Date(conflict.endTime), 'h:mm a')} ({conflict.status})
                      </li>
                    ))}
                  </ul>
                </div>
              </div>
            </div>
          )}

          {/* Error */}
          {error && !conflicts && (
            <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-3">
              <p className="text-sm text-red-400">{error}</p>
            </div>
          )}

          {/* Notes */}
          <div>
            <label className="block text-sm font-medium text-[var(--text-secondary)] mb-2">
              Notes (optional)
            </label>
            <textarea
              value={notes}
              onChange={(e) => setNotes(e.target.value)}
              rows={2}
              className="w-full px-3 py-2 bg-[var(--surface-2)] border border-[var(--border)] rounded-lg text-[var(--text-primary)] text-sm focus:outline-none focus:ring-2 focus:ring-[var(--accent)]"
              placeholder="Reason for request, specific needs, etc."
            />
          </div>

          {/* Info */}
          <p className="text-xs text-[var(--text-muted)]">
            Your request will be sent to the facility admin for approval. You'll be notified when it's reviewed.
          </p>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={() => onOpenChange(false)}>
            Cancel
          </Button>
          <Button onClick={handleSubmit} disabled={isSubmitting}>
            {isSubmitting ? (
              <>
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                Submitting...
              </>
            ) : (
              'Submit Request'
            )}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>BookingRequestDialog component handles equipment booking with conflict display</done>
</task>

<task type="auto">
  <name>Task 2: Enhance equipment availability panel with booking</name>
  <files>src/components/practices/equipment-availability-panel.tsx</files>
  <action>
Update `src/components/practices/equipment-availability-panel.tsx` to include booking functionality:

```tsx
'use client';

import { useState, useEffect } from 'react';
import { ChevronDown, ChevronUp, AlertTriangle, CheckCircle, Ship, Clock, Send } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { BookingRequestDialog } from './booking-request-dialog';

interface EquipmentItem {
  id: string;
  name: string;
  type: string;
  boatClass: string | null;
  isAvailable: boolean;
  unavailableReasons: string[];
  ownerType: 'FACILITY' | 'CLUB' | 'TEAM';
  isShared: boolean;
  pendingBooking?: {
    id: string;
    status: string;
    startTime: string;
    endTime: string;
  };
}

interface EquipmentAvailabilityPanelProps {
  className?: string;
  practiceId?: string;
  practiceDate?: Date;
  practiceStartTime?: Date;
  practiceEndTime?: Date;
  onBookingCreated?: () => void;
}

export function EquipmentAvailabilityPanel({
  className,
  practiceId,
  practiceDate,
  practiceStartTime,
  practiceEndTime,
  onBookingCreated,
}: EquipmentAvailabilityPanelProps) {
  const [isExpanded, setIsExpanded] = useState(false);
  const [equipment, setEquipment] = useState<EquipmentItem[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [hasFetched, setHasFetched] = useState(false);

  // Booking dialog state
  const [selectedEquipment, setSelectedEquipment] = useState<EquipmentItem | null>(null);
  const [isBookingDialogOpen, setIsBookingDialogOpen] = useState(false);

  // Lazy load: only fetch when panel is expanded for the first time
  useEffect(() => {
    if (isExpanded && !hasFetched) {
      fetchEquipment();
    }
  }, [isExpanded, hasFetched]);

  const fetchEquipment = async () => {
    setIsLoading(true);
    setError(null);
    try {
      // Fetch both team equipment and shared facility equipment
      const response = await fetch('/api/equipment?includeShared=true');
      if (!response.ok) throw new Error('Failed to load equipment');
      const data = await response.json();

      // Mark equipment with pending bookings for this time slot
      const equipmentWithBookings = data.equipment.map((item: EquipmentItem) => {
        // For shared equipment, check if there's a pending booking for practice time
        if ((item.ownerType === 'FACILITY' || item.isShared) && practiceStartTime && practiceEndTime) {
          // This would ideally be computed server-side, but for simplicity we show the base data
          return item;
        }
        return item;
      });

      setEquipment(equipmentWithBookings);
      setHasFetched(true);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to load equipment');
    } finally {
      setIsLoading(false);
    }
  };

  const handleRequestBooking = (item: EquipmentItem) => {
    setSelectedEquipment(item);
    setIsBookingDialogOpen(true);
  };

  const handleBookingSuccess = () => {
    // Refresh equipment list to show updated booking status
    fetchEquipment();
    onBookingCreated?.();
  };

  // Count available vs unavailable
  const availableCount = equipment.filter(e => e.isAvailable).length;
  const unavailableCount = equipment.filter(e => !e.isAvailable).length;
  const sharedCount = equipment.filter(e => e.ownerType === 'FACILITY' || e.isShared).length;

  // Group by type (SHELL, OAR, LAUNCH, OTHER)
  const groupedEquipment = equipment.reduce((acc, item) => {
    const group = acc[item.type] || [];
    group.push(item);
    acc[item.type] = group;
    return acc;
  }, {} as Record<string, EquipmentItem[]>);

  const typeOrder = ['SHELL', 'OAR', 'LAUNCH', 'OTHER'];
  const typeLabels: Record<string, string> = {
    SHELL: 'Boats',
    OAR: 'Oars',
    LAUNCH: 'Launches',
    OTHER: 'Other Equipment',
  };

  return (
    <>
      <div className={`border border-zinc-700 rounded-lg bg-zinc-800/50 ${className || ''}`}>
        {/* Header - always visible */}
        <button
          type="button"
          onClick={() => setIsExpanded(!isExpanded)}
          className="w-full px-4 py-3 flex items-center justify-between text-left hover:bg-zinc-800 transition-colors rounded-lg"
        >
          <div className="flex items-center gap-2">
            <Ship className="h-4 w-4 text-zinc-400" />
            <span className="text-sm font-medium text-zinc-300">Equipment Availability</span>
            {hasFetched && (
              <span className="text-xs text-zinc-500">
                ({availableCount} available{unavailableCount > 0 ? `, ${unavailableCount} unavailable` : ''})
                {sharedCount > 0 && ` Â· ${sharedCount} shared`}
              </span>
            )}
          </div>
          {isExpanded ? (
            <ChevronUp className="h-4 w-4 text-zinc-500" />
          ) : (
            <ChevronDown className="h-4 w-4 text-zinc-500" />
          )}
        </button>

        {/* Expanded content */}
        {isExpanded && (
          <div className="px-4 pb-4 border-t border-zinc-700">
            {isLoading && (
              <p className="text-sm text-zinc-500 py-4 text-center">Loading equipment...</p>
            )}

            {error && (
              <p className="text-sm text-red-400 py-4 text-center">{error}</p>
            )}

            {!isLoading && !error && equipment.length === 0 && (
              <p className="text-sm text-zinc-500 py-4 text-center">No equipment found</p>
            )}

            {!isLoading && !error && equipment.length > 0 && (
              <div className="space-y-4 pt-3">
                {/* Shared equipment notice */}
                {sharedCount > 0 && (
                  <div className="flex items-start gap-2 p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                    <Clock className="h-4 w-4 text-blue-400 mt-0.5 flex-shrink-0" />
                    <p className="text-xs text-blue-300">
                      {sharedCount} piece{sharedCount > 1 ? 's' : ''} of shared facility equipment available. Click &quot;Request&quot; to book for this practice.
                    </p>
                  </div>
                )}

                {/* Unavailable equipment alert */}
                {unavailableCount > 0 && (
                  <div className="flex items-start gap-2 p-3 bg-amber-500/10 border border-amber-500/30 rounded-lg">
                    <AlertTriangle className="h-4 w-4 text-amber-400 mt-0.5 flex-shrink-0" />
                    <p className="text-xs text-amber-300">
                      {unavailableCount} piece{unavailableCount > 1 ? 's' : ''} of equipment {unavailableCount > 1 ? 'are' : 'is'} currently unavailable due to damage or maintenance.
                    </p>
                  </div>
                )}

                {/* Equipment list grouped by type */}
                {typeOrder
                  .filter(type => groupedEquipment[type]?.length > 0)
                  .map(type => (
                    <div key={type}>
                      <h4 className="text-xs font-medium text-zinc-500 uppercase tracking-wide mb-2">
                        {typeLabels[type]}
                      </h4>
                      <div className="space-y-1">
                        {groupedEquipment[type].map(item => (
                          <EquipmentRow
                            key={item.id}
                            item={item}
                            canBook={!!practiceStartTime && !!practiceEndTime}
                            onRequestBooking={() => handleRequestBooking(item)}
                          />
                        ))}
                      </div>
                    </div>
                  ))}
              </div>
            )}

            {/* Info note */}
            <p className="text-xs text-zinc-600 mt-4 pt-3 border-t border-zinc-700">
              Equipment assignment happens in lineups. Shared equipment requires booking approval from facility admin.
            </p>
          </div>
        )}
      </div>

      {/* Booking Request Dialog */}
      {selectedEquipment && practiceStartTime && practiceEndTime && (
        <BookingRequestDialog
          open={isBookingDialogOpen}
          onOpenChange={setIsBookingDialogOpen}
          equipment={selectedEquipment}
          startTime={practiceStartTime}
          endTime={practiceEndTime}
          practiceId={practiceId}
          onSuccess={handleBookingSuccess}
        />
      )}
    </>
  );
}

function EquipmentRow({
  item,
  canBook,
  onRequestBooking,
}: {
  item: EquipmentItem;
  canBook: boolean;
  onRequestBooking: () => void;
}) {
  const [showReasons, setShowReasons] = useState(false);
  const isShared = item.ownerType === 'FACILITY' || item.isShared;

  if (item.isAvailable) {
    return (
      <div className="flex items-center justify-between py-1.5 px-2 rounded bg-zinc-800/50">
        <div className="flex items-center gap-2">
          <CheckCircle className="h-3.5 w-3.5 text-emerald-500 flex-shrink-0" />
          <span className="text-sm text-zinc-300">{item.name}</span>
          {item.boatClass && (
            <span className="text-xs text-zinc-500">({item.boatClass.replace(/_/g, ' ')})</span>
          )}
          {isShared && (
            <span className="text-xs px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-400">
              Shared
            </span>
          )}
        </div>
        {isShared && canBook && (
          <Button
            type="button"
            variant="ghost"
            size="sm"
            onClick={onRequestBooking}
            className="h-7 text-xs"
          >
            <Send className="h-3 w-3 mr-1" />
            Request
          </Button>
        )}
      </div>
    );
  }

  return (
    <div className="py-1.5 px-2 rounded bg-red-500/5 border border-red-500/10">
      <button
        type="button"
        onClick={() => setShowReasons(!showReasons)}
        className="w-full flex items-center gap-2 text-left"
      >
        <AlertTriangle className="h-3.5 w-3.5 text-red-400 flex-shrink-0" />
        <span className="text-sm text-zinc-400 line-through">{item.name}</span>
        {item.boatClass && (
          <span className="text-xs text-zinc-600 line-through">({item.boatClass.replace(/_/g, ' ')})</span>
        )}
        {isShared && (
          <span className="text-xs px-1.5 py-0.5 rounded bg-blue-500/10 text-blue-400/60">
            Shared
          </span>
        )}
        <span className="text-xs text-red-400 ml-auto">Unavailable</span>
      </button>
      {showReasons && item.unavailableReasons.length > 0 && (
        <ul className="mt-2 ml-5 space-y-1">
          {item.unavailableReasons.map((reason, idx) => (
            <li key={idx} className="text-xs text-red-300/70">
              - {reason}
            </li>
          ))}
        </ul>
      )}
    </div>
  );
}
```
  </action>
  <verify>Navigate to practice creation, expand equipment panel - should show shared equipment with Request button</verify>
  <done>Equipment availability panel shows shared equipment with booking request functionality</done>
</task>

</tasks>

<verification>
1. Build: `npm run build` passes
2. Panel shows shared equipment: Shared/facility equipment marked with "Shared" badge
3. Request button: Available shared equipment shows "Request" button
4. Dialog opens: Clicking Request opens booking dialog with equipment details
5. Submit request: Submitting creates booking request via API
6. Conflict display: If equipment is booked, shows conflict information
7. Success callback: After successful booking, panel refreshes
</verification>

<success_criteria>
- Equipment availability panel shows shared facility equipment
- Shared equipment has visual indicator ("Shared" badge)
- Available shared equipment has "Request" button
- BookingRequestDialog shows equipment name, type, time slot
- Submitting request calls /api/equipment/bookings POST
- Conflicts are displayed if equipment is already booked
- Success triggers refresh of equipment list
- Notes field allows adding booking notes
</success_criteria>

<output>
After completion, create `.planning/phases/17-facility-ui-features/17-10-SUMMARY.md`
</output>
