---
phase: 39-membership-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/validations/membership.ts
  - src/app/api/admin/memberships/route.ts
  - src/app/api/admin/memberships/[membershipId]/route.ts
  - src/app/api/admin/clubs/[clubId]/members/route.ts
autonomous: true

must_haves:
  truths:
    - "Super admin can add a user to a club with specified roles via API"
    - "Super admin can remove a user from a club via API"
    - "Super admin can change a user's roles within a club via API"
    - "Adding existing member returns 409 with option to update"
    - "All membership mutations are audit logged"
  artifacts:
    - path: "src/lib/validations/membership.ts"
      provides: "Zod schemas for membership operations"
      exports: ["addMembershipSchema", "updateMembershipSchema"]
    - path: "src/app/api/admin/memberships/route.ts"
      provides: "Create membership endpoint"
      exports: ["POST"]
    - path: "src/app/api/admin/memberships/[membershipId]/route.ts"
      provides: "Update and delete membership endpoints"
      exports: ["PATCH", "DELETE"]
    - path: "src/app/api/admin/clubs/[clubId]/members/route.ts"
      provides: "List club members endpoint"
      exports: ["GET"]
  key_links:
    - from: "src/app/api/admin/memberships/route.ts"
      to: "prisma.clubMembership.create"
      via: "Prisma client"
      pattern: "prisma\\.clubMembership\\.(create|findUnique)"
    - from: "src/app/api/admin/memberships/[membershipId]/route.ts"
      to: "prisma.clubMembership.update"
      via: "Prisma client"
      pattern: "prisma\\.clubMembership\\.(update|delete)"
---

<objective>
Create core API endpoints for super admin membership management operations.

Purpose: Enable super admins to directly manage user-club relationships (add, remove, change roles) without invitation flows, providing the backend for MEMB-01, MEMB-02, MEMB-03.

Output: Four API routes - create membership, update membership roles, delete membership, list club members.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-membership-management/39-CONTEXT.md
@.planning/phases/39-membership-management/39-RESEARCH.md
@prisma/schema.prisma (ClubMembership model)
@src/lib/audit/actions.ts (ADMIN_MEMBERSHIP_ADDED, ADMIN_MEMBERSHIP_REMOVED)
@src/app/api/admin/users/[userId]/route.ts (pattern for admin API routes)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create membership validation schemas</name>
  <files>src/lib/validations/membership.ts</files>
  <action>
Create Zod validation schemas for membership operations:

```typescript
import { z } from 'zod';

const roleEnum = z.enum(['FACILITY_ADMIN', 'CLUB_ADMIN', 'COACH', 'ATHLETE', 'PARENT']);

/**
 * Schema for adding a user to a club.
 */
export const addMembershipSchema = z.object({
  clubId: z.string().uuid('Invalid club ID'),
  userId: z.string().uuid('Invalid user ID'),
  roles: z
    .array(roleEnum)
    .min(1, 'At least one role is required')
    .default(['ATHLETE']),
});

export type AddMembershipInput = z.infer<typeof addMembershipSchema>;

/**
 * Schema for updating membership roles.
 */
export const updateMembershipSchema = z.object({
  roles: z
    .array(roleEnum)
    .min(1, 'At least one role is required'),
});

export type UpdateMembershipInput = z.infer<typeof updateMembershipSchema>;
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/lib/validations/membership.ts`</verify>
  <done>membership.ts exports addMembershipSchema and updateMembershipSchema with proper validation</done>
</task>

<task type="auto">
  <name>Task 2: Create membership CRUD API routes</name>
  <files>src/app/api/admin/memberships/route.ts, src/app/api/admin/memberships/[membershipId]/route.ts</files>
  <action>
**POST /api/admin/memberships** - Create membership (add user to club):

1. Verify super admin via `getSuperAdminContext()`
2. Parse body with `addMembershipSchema`
3. Verify club exists: `prisma.team.findUnique({ where: { id: clubId } })`
4. Verify user exists: `getUserById(userId)` from Supabase admin
5. Check existing membership: `prisma.clubMembership.findUnique({ where: { clubId_userId: { clubId, userId } } })`
   - If exists and isActive: return 409 with existingMembership
   - If exists and !isActive: reactivate with `update({ isActive: true, roles })`
6. Create new membership: `prisma.clubMembership.create({ data: { clubId, userId, roles, isActive: true } })`
7. Audit log with `ADMIN_MEMBERSHIP_ADDED`
8. Return 201 with membership

**PATCH /api/admin/memberships/[membershipId]** - Update roles:

1. Verify super admin
2. Parse body with `updateMembershipSchema`
3. Find membership by ID, return 404 if not found
4. Update roles: `prisma.clubMembership.update({ where: { id }, data: { roles } })`
5. Audit log with `ADMIN_ROLE_CHANGED` (use existing action for role changes)
6. Return updated membership

**DELETE /api/admin/memberships/[membershipId]** - Remove from club:

1. Verify super admin
2. Find membership by ID, return 404 if not found
3. Soft delete: `prisma.clubMembership.update({ where: { id }, data: { isActive: false } })`
4. Audit log with `ADMIN_MEMBERSHIP_REMOVED`
5. Return success

Follow the exact patterns from `src/app/api/admin/users/[userId]/route.ts`:
- Use `RouteParams` interface with `Promise<{ param: string }>`
- Use `unauthorizedResponse()`, `notFoundResponse()`, `serverErrorResponse()`
- Create audit logger with `createAdminAuditLogger(request, adminContext.userId)`
  </action>
  <verify>
- `curl -X POST /api/admin/memberships` with valid body returns 201
- `curl -X POST /api/admin/memberships` with existing user returns 409
- `curl -X PATCH /api/admin/memberships/[id]` updates roles
- `curl -X DELETE /api/admin/memberships/[id]` soft deletes
  </verify>
  <done>Membership CRUD endpoints handle add, update roles, and remove operations with audit logging</done>
</task>

<task type="auto">
  <name>Task 3: Create club members list endpoint</name>
  <files>src/app/api/admin/clubs/[clubId]/members/route.ts</files>
  <action>
**GET /api/admin/clubs/[clubId]/members** - List club members:

1. Verify super admin via `getSuperAdminContext()`
2. Extract clubId from params
3. Verify club exists: `prisma.team.findUnique({ where: { id: clubId } })`
4. Fetch members with user info:

```typescript
const memberships = await prisma.clubMembership.findMany({
  where: { clubId, isActive: true },
  orderBy: { joinedAt: 'asc' },
});

// For each membership, fetch user details from Supabase
const membersWithUserInfo = await Promise.all(
  memberships.map(async (m) => {
    const user = await getUserById(m.userId);
    return {
      id: m.id,
      userId: m.userId,
      email: user?.email || 'Unknown',
      displayName: user?.user_metadata?.display_name || user?.user_metadata?.full_name || null,
      roles: m.roles,
      joinedAt: m.joinedAt,
    };
  })
);
```

5. Return { members: membersWithUserInfo, total: membersWithUserInfo.length }

Consider pagination for clubs with many members (optional - CONTEXT.md leaves to Claude's discretion).
  </action>
  <verify>`curl /api/admin/clubs/[clubId]/members` returns list of members with user info</verify>
  <done>Club members endpoint returns member list with user email and name for display</done>
</task>

</tasks>

<verification>
1. Run `npm run build` - should complete without errors
2. Test POST /api/admin/memberships - creates membership, returns 201
3. Test POST with existing member - returns 409 Conflict
4. Test PATCH /api/admin/memberships/[id] - updates roles
5. Test DELETE /api/admin/memberships/[id] - soft deletes (isActive: false)
6. Test GET /api/admin/clubs/[clubId]/members - returns member list
7. Verify audit logs created for all mutations
</verification>

<success_criteria>
- All API endpoints respond correctly to valid requests
- Validation errors return 400 with helpful messages
- Existing member returns 409 with membershipId for update option
- Soft delete sets isActive: false (not hard delete)
- Audit logs capture before/after state for all mutations
- TypeScript compiles with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/39-membership-management/39-01-SUMMARY.md`
</output>
