---
phase: 39-membership-management
plan: 02
type: execute
wave: 2
depends_on: ["39-01"]
files_modified:
  - src/components/admin/users/membership-list.tsx
  - src/components/admin/memberships/add-to-club-dialog.tsx
  - src/components/admin/memberships/edit-roles-dialog.tsx
  - src/components/admin/memberships/user-search-combobox.tsx
  - src/components/admin/memberships/role-selector.tsx
  - src/app/(admin)/admin/users/[userId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Super admin can add user to any club from user detail page"
    - "Super admin can edit user's roles in any club via inline action"
    - "Super admin can remove user from any club via inline action"
    - "User search dropdown shows matching users as you type"
    - "Role selection allows multiple roles via checkboxes"
  artifacts:
    - path: "src/components/admin/memberships/add-to-club-dialog.tsx"
      provides: "Dialog for adding user to a club"
      exports: ["AddToClubDialog"]
    - path: "src/components/admin/memberships/edit-roles-dialog.tsx"
      provides: "Dialog for editing membership roles"
      exports: ["EditRolesDialog"]
    - path: "src/components/admin/memberships/user-search-combobox.tsx"
      provides: "Searchable user dropdown"
      exports: ["UserSearchCombobox"]
    - path: "src/components/admin/memberships/role-selector.tsx"
      provides: "Multi-role checkbox selector"
      exports: ["RoleSelector"]
  key_links:
    - from: "src/app/(admin)/admin/users/[userId]/page.tsx"
      to: "AddToClubDialog"
      via: "import and render"
      pattern: "AddToClubDialog"
    - from: "src/components/admin/users/membership-list.tsx"
      to: "EditRolesDialog"
      via: "dropdown action"
      pattern: "(EditRolesDialog|onEditRoles)"
---

<objective>
Enhance user detail page with membership management actions.

Purpose: Allow super admins to add users to clubs, edit their roles, and remove them - all from the user detail page (MEMB-04 enhancement for MEMB-01, MEMB-02, MEMB-03 from user-centric view).

Output: Membership list with inline actions, add-to-club dialog, edit-roles dialog, supporting components.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-membership-management/39-CONTEXT.md
@.planning/phases/39-membership-management/39-RESEARCH.md
@src/components/admin/users/membership-list.tsx (existing component to enhance)
@src/app/(admin)/admin/users/[userId]/page.tsx (user detail page to modify)
@src/components/ui/command.tsx (cmdk for search)
@src/components/ui/dialog.tsx (dialog component)
@src/components/ui/checkbox.tsx (for role selection)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared membership components</name>
  <files>src/components/admin/memberships/user-search-combobox.tsx, src/components/admin/memberships/role-selector.tsx</files>
  <action>
**UserSearchCombobox** - Searchable dropdown for selecting users:

```typescript
'use client';

import { useState } from 'react';
import { Check, ChevronsUpDown, Loader2 } from 'lucide-react';
import { cn } from '@/lib/utils';
import { Button } from '@/components/ui/button';
import {
  Command,
  CommandEmpty,
  CommandGroup,
  CommandInput,
  CommandItem,
  CommandList,
} from '@/components/ui/command';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import { useDebouncedCallback } from '@/hooks/use-debounced-callback';

interface User {
  id: string;
  email: string;
  displayName?: string | null;
}

interface UserSearchComboboxProps {
  value: User | null;
  onSelect: (user: User | null) => void;
  placeholder?: string;
  disabled?: boolean;
}

export function UserSearchCombobox({
  value,
  onSelect,
  placeholder = 'Search users...',
  disabled = false,
}: UserSearchComboboxProps) {
  const [open, setOpen] = useState(false);
  const [query, setQuery] = useState('');
  const [results, setResults] = useState<User[]>([]);
  const [isLoading, setIsLoading] = useState(false);

  const searchUsers = useDebouncedCallback(async (searchTerm: string) => {
    if (!searchTerm || searchTerm.length < 2) {
      setResults([]);
      return;
    }

    setIsLoading(true);
    try {
      const res = await fetch(`/api/admin/users?search=${encodeURIComponent(searchTerm)}&limit=10`);
      if (res.ok) {
        const data = await res.json();
        setResults(data.users.map((u: any) => ({
          id: u.id,
          email: u.email,
          displayName: u.displayName,
        })));
      }
    } finally {
      setIsLoading(false);
    }
  }, 300);

  return (
    <Popover open={open} onOpenChange={setOpen}>
      <PopoverTrigger asChild>
        <Button
          variant="outline"
          role="combobox"
          aria-expanded={open}
          className="w-full justify-between"
          disabled={disabled}
        >
          {value ? (value.displayName || value.email) : placeholder}
          <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-[400px] p-0" align="start">
        <Command shouldFilter={false}>
          <CommandInput
            placeholder="Type to search..."
            value={query}
            onValueChange={(v) => {
              setQuery(v);
              searchUsers(v);
            }}
          />
          <CommandList>
            {isLoading && (
              <div className="flex items-center justify-center p-4">
                <Loader2 className="h-4 w-4 animate-spin" />
              </div>
            )}
            <CommandEmpty>{query.length < 2 ? 'Type at least 2 characters' : 'No users found'}</CommandEmpty>
            <CommandGroup>
              {results.map((user) => (
                <CommandItem
                  key={user.id}
                  value={user.id}
                  onSelect={() => {
                    onSelect(user);
                    setOpen(false);
                    setQuery('');
                  }}
                >
                  <Check
                    className={cn('mr-2 h-4 w-4', value?.id === user.id ? 'opacity-100' : 'opacity-0')}
                  />
                  <div>
                    <p className="font-medium">{user.displayName || user.email}</p>
                    {user.displayName && <p className="text-sm text-muted-foreground">{user.email}</p>}
                  </div>
                </CommandItem>
              ))}
            </CommandGroup>
          </CommandList>
        </Command>
      </PopoverContent>
    </Popover>
  );
}
```

**RoleSelector** - Multi-role checkbox selection:

```typescript
'use client';

import { Checkbox } from '@/components/ui/checkbox';

const ROLES = [
  { value: 'FACILITY_ADMIN', label: 'Facility Admin', description: 'Full facility access' },
  { value: 'CLUB_ADMIN', label: 'Club Admin', description: 'Manage club settings and members' },
  { value: 'COACH', label: 'Coach', description: 'Create practices and lineups' },
  { value: 'ATHLETE', label: 'Athlete', description: 'View assigned practices' },
  { value: 'PARENT', label: 'Parent', description: 'View athlete information' },
] as const;

interface RoleSelectorProps {
  value: string[];
  onChange: (roles: string[]) => void;
  disabled?: boolean;
}

export function RoleSelector({ value, onChange, disabled = false }: RoleSelectorProps) {
  const toggleRole = (role: string) => {
    if (value.includes(role)) {
      onChange(value.filter((r) => r !== role));
    } else {
      onChange([...value, role]);
    }
  };

  return (
    <div className="space-y-2">
      {ROLES.map((role) => (
        <label
          key={role.value}
          className="flex items-start gap-3 p-3 rounded-lg border border-[var(--border-subtle)] cursor-pointer hover:bg-[var(--surface-2)] transition-colors"
        >
          <Checkbox
            checked={value.includes(role.value)}
            onCheckedChange={() => toggleRole(role.value)}
            disabled={disabled}
          />
          <div className="flex-1">
            <p className="font-medium text-[var(--text-primary)]">{role.label}</p>
            <p className="text-sm text-[var(--text-muted)]">{role.description}</p>
          </div>
        </label>
      ))}
    </div>
  );
}
```

Create directory: `src/components/admin/memberships/`
  </action>
  <verify>TypeScript compiles without errors for both components</verify>
  <done>UserSearchCombobox and RoleSelector components created with proper styling and accessibility</done>
</task>

<task type="auto">
  <name>Task 2: Create membership dialogs</name>
  <files>src/components/admin/memberships/add-to-club-dialog.tsx, src/components/admin/memberships/edit-roles-dialog.tsx</files>
  <action>
**AddToClubDialog** - Dialog for adding user to a club:

Props: `{ open, onOpenChange, userId, onSuccess }`

Content:
1. Club search combobox (adapt UserSearchCombobox pattern but for clubs - fetch from `/api/admin/clubs?search=`)
2. RoleSelector for selecting roles (default: ['ATHLETE'])
3. Add button that POSTs to `/api/admin/memberships`
4. Handle 409 (already member) with appropriate message
5. Call onSuccess and close on success

Create a ClubSearchCombobox similar to UserSearchCombobox but fetching clubs.

**EditRolesDialog** - Dialog for editing membership roles:

Props: `{ open, onOpenChange, membership: { id, clubName, roles }, onSuccess }`

Content:
1. Display club name (read-only)
2. RoleSelector with current roles pre-selected
3. Save button that PATCHes to `/api/admin/memberships/[membershipId]`
4. Call onSuccess and close on success

Both dialogs use:
- `Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription` from `@/components/ui/dialog`
- `Button` with loading state
- `showSuccessToast`, `showErrorToast` from `@/lib/toast-helpers`
  </action>
  <verify>Both dialogs render and submit forms correctly</verify>
  <done>AddToClubDialog and EditRolesDialog components handle membership creation and role editing</done>
</task>

<task type="auto">
  <name>Task 3: Enhance MembershipList with actions and integrate into user detail page</name>
  <files>src/components/admin/users/membership-list.tsx, src/app/(admin)/admin/users/[userId]/page.tsx</files>
  <action>
**Enhance MembershipList:**

1. Add optional `onEditRoles` and `onRemove` callback props
2. Add Actions column with dropdown menu:
   - "Edit Roles" - calls onEditRoles(membership)
   - "Remove from Club" - calls onRemove(membership)
3. Use `DropdownMenu` from `@/components/ui/dropdown-menu`
4. Use `MoreHorizontal` icon from lucide-react

```typescript
interface MembershipListProps {
  memberships: Membership[];
  onEditRoles?: (membership: Membership) => void;
  onRemove?: (membership: Membership) => void;
}
```

**Update user detail page:**

Convert to client component wrapper pattern (like ClubEditClient) to manage dialog state:

1. Create `src/app/(admin)/admin/users/[userId]/user-detail-client.tsx` that receives user data
2. Add state for:
   - `addToClubOpen` (boolean)
   - `editRolesOpen` (boolean)
   - `selectedMembership` (Membership | null)
   - `removeDialogOpen` (boolean)
3. Add "Add to Club" button next to "Club Memberships" header
4. Pass callbacks to MembershipList: onEditRoles, onRemove
5. Include AddToClubDialog, EditRolesDialog
6. For remove: Use confirmation dialog then DELETE to `/api/admin/memberships/[id]`
7. On success: `router.refresh()` to reload data

Keep server component page.tsx minimal - just fetch data and render client component.
  </action>
  <verify>
- User detail page shows "Add to Club" button
- Clicking membership action shows Edit Roles / Remove options
- Edit Roles opens dialog with current roles
- Remove shows confirmation then deletes
  </verify>
  <done>User detail page has full membership management with add, edit roles, and remove actions</done>
</task>

</tasks>

<verification>
1. Run `npm run build` - should complete without errors
2. Navigate to /admin/users/[userId] - see "Add to Club" button
3. Click "Add to Club" - dialog opens with club search and role selection
4. Add user to club - success toast, membership appears in list
5. Click membership actions - dropdown with Edit Roles and Remove
6. Edit Roles - dialog with checkboxes, save updates roles
7. Remove from Club - confirmation, then removed from list
</verification>

<success_criteria>
- Add to Club dialog with club search and multi-role selection works
- Edit Roles dialog pre-populates current roles and saves changes
- Remove action with confirmation soft-deletes membership
- User search combobox debounces and shows results as you type
- All actions show appropriate success/error toasts
- Page refreshes to show updated membership list
</success_criteria>

<output>
After completion, create `.planning/phases/39-membership-management/39-02-SUMMARY.md`
</output>
