---
phase: 21-equipment-readiness
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - src/lib/equipment/readiness.ts
autonomous: true

must_haves:
  truths:
    - "Readiness calculation considers manual override, critical damage, inspection days, moderate damage"
    - "Status hierarchy: OUT_OF_SERVICE > NEEDS_ATTENTION > INSPECT_SOON > READY"
    - "Null lastInspectedAt treated as never inspected (OUT_OF_SERVICE)"
  artifacts:
    - path: "src/lib/equipment/readiness.ts"
      provides: "Threshold-based readiness calculation"
      exports: ["calculateReadinessStatus", "ReadinessStatus", "EquipmentReadinessResult"]
      min_lines: 80
  key_links:
    - from: "src/lib/equipment/readiness.ts"
      to: "prisma schema"
      via: "Equipment and DamageReport types"
      pattern: "lastInspectedAt|severity"
---

<objective>
Extend the existing readiness calculation logic with threshold-based status computation.

Purpose: Transform equipment inspection dates and damage reports into one of 4 readiness states (READY, INSPECT_SOON, NEEDS_ATTENTION, OUT_OF_SERVICE) using team-configurable thresholds.

Output: Updated readiness.ts with calculateReadinessStatus function, ReadinessStatus type, and threshold-aware calculation logic.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-equipment-readiness/21-CONTEXT.md
@.planning/phases/21-equipment-readiness/21-RESEARCH.md
@src/lib/equipment/readiness.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ReadinessStatus type and threshold interface</name>
  <files>src/lib/equipment/readiness.ts</files>
  <action>
Add new types at the top of the file (after existing imports):

```typescript
/**
 * Equipment readiness status levels (traffic light pattern).
 * Order matters: most severe to least severe for priority checks.
 */
export type ReadinessStatus = 'OUT_OF_SERVICE' | 'NEEDS_ATTENTION' | 'INSPECT_SOON' | 'READY';

/**
 * Team-configurable thresholds for readiness calculation.
 * All values are in days since last inspection.
 */
export interface ReadinessThresholds {
  inspectSoonDays: number;      // Default: 14 - yellow warning
  needsAttentionDays: number;   // Default: 21 - amber alert
  outOfServiceDays: number;     // Default: 30 - red/blocked
}

/**
 * Default thresholds matching TeamSettings schema defaults.
 */
export const DEFAULT_READINESS_THRESHOLDS: ReadinessThresholds = {
  inspectSoonDays: 14,
  needsAttentionDays: 21,
  outOfServiceDays: 30,
};

/**
 * Result of readiness calculation including status and context.
 */
export interface EquipmentReadinessResult {
  status: ReadinessStatus;
  reasons: string[];
  daysSinceInspection: number | null;
}
```
  </action>
  <verify>grep -n "ReadinessStatus\|ReadinessThresholds" src/lib/equipment/readiness.ts shows type definitions</verify>
  <done>ReadinessStatus type and ReadinessThresholds interface exported from readiness.ts</done>
</task>

<task type="auto">
  <name>Task 2: Implement calculateReadinessStatus function</name>
  <files>src/lib/equipment/readiness.ts</files>
  <action>
Add the main calculation function after the types. Follow the priority order from RESEARCH.md:

```typescript
/**
 * Equipment data needed for readiness calculation.
 * Extends base Equipment with inspection date and damage reports.
 */
export interface EquipmentForReadiness {
  manualUnavailable: boolean;
  manualUnavailableNote: string | null;
  lastInspectedAt: Date | null;
  damageReports: Array<{
    id: string;
    severity: 'MINOR' | 'MODERATE' | 'CRITICAL';
    status: 'OPEN' | 'RESOLVED';
    location: string;
  }>;
}

/**
 * Calculate equipment readiness status based on multiple factors.
 *
 * Priority order (first match wins):
 * 1. Manual override (manualUnavailable) -> OUT_OF_SERVICE
 * 2. CRITICAL damage reports -> OUT_OF_SERVICE
 * 3. Days since inspection > outOfServiceDays -> OUT_OF_SERVICE
 * 4. Never inspected (null lastInspectedAt) -> OUT_OF_SERVICE
 * 5. Days > needsAttentionDays OR MODERATE damage -> NEEDS_ATTENTION
 * 6. Days > inspectSoonDays -> INSPECT_SOON
 * 7. All checks pass -> READY
 *
 * @param equipment - Equipment with damage reports included
 * @param thresholds - Team-configured threshold values
 * @returns Readiness status with reasons and inspection days
 */
export function calculateReadinessStatus(
  equipment: EquipmentForReadiness,
  thresholds: ReadinessThresholds = DEFAULT_READINESS_THRESHOLDS
): EquipmentReadinessResult {
  const reasons: string[] = [];

  // 1. Manual override takes absolute precedence
  if (equipment.manualUnavailable) {
    return {
      status: 'OUT_OF_SERVICE',
      reasons: [equipment.manualUnavailableNote || 'Marked unavailable by coach'],
      daysSinceInspection: calculateDaysSince(equipment.lastInspectedAt),
    };
  }

  // Filter to open damage reports only
  const openReports = equipment.damageReports.filter(r => r.status === 'OPEN');

  // 2. CRITICAL damage reports -> immediate OUT_OF_SERVICE
  const criticalReports = openReports.filter(r => r.severity === 'CRITICAL');
  if (criticalReports.length > 0) {
    return {
      status: 'OUT_OF_SERVICE',
      reasons: criticalReports.map(r => `Critical damage: ${r.location}`),
      daysSinceInspection: calculateDaysSince(equipment.lastInspectedAt),
    };
  }

  // 3. Calculate days since inspection
  const daysSince = calculateDaysSince(equipment.lastInspectedAt);

  // 4. Never inspected or extremely overdue -> OUT_OF_SERVICE
  if (daysSince === null) {
    return {
      status: 'OUT_OF_SERVICE',
      reasons: ['No inspection record'],
      daysSinceInspection: null,
    };
  }

  if (daysSince > thresholds.outOfServiceDays) {
    return {
      status: 'OUT_OF_SERVICE',
      reasons: [`${daysSince} days since inspection (limit: ${thresholds.outOfServiceDays})`],
      daysSinceInspection: daysSince,
    };
  }

  // 5. MODERATE damage or approaching out-of-service -> NEEDS_ATTENTION
  const moderateReports = openReports.filter(r => r.severity === 'MODERATE');
  if (daysSince > thresholds.needsAttentionDays || moderateReports.length > 0) {
    if (moderateReports.length > 0) {
      reasons.push(`${moderateReports.length} moderate damage report(s)`);
    }
    if (daysSince > thresholds.needsAttentionDays) {
      reasons.push(`${daysSince} days since inspection`);
    }
    return {
      status: 'NEEDS_ATTENTION',
      reasons,
      daysSinceInspection: daysSince,
    };
  }

  // 6. Approaching inspection due -> INSPECT_SOON
  if (daysSince > thresholds.inspectSoonDays) {
    return {
      status: 'INSPECT_SOON',
      reasons: [`${daysSince} days since inspection`],
      daysSinceInspection: daysSince,
    };
  }

  // 7. All good -> READY
  return {
    status: 'READY',
    reasons: [],
    daysSinceInspection: daysSince,
  };
}

/**
 * Calculate days since a given date, or null if date is null.
 */
function calculateDaysSince(date: Date | null): number | null {
  if (!date) return null;
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  return Math.floor(diffMs / (1000 * 60 * 60 * 24));
}
```

Keep the existing computeEquipmentReadiness and computeMultipleEquipmentReadiness functions - they are still used for the simpler availability check. The new calculateReadinessStatus is the threshold-aware version.
  </action>
  <verify>grep -n "calculateReadinessStatus\|OUT_OF_SERVICE\|INSPECT_SOON" src/lib/equipment/readiness.ts shows function and status checks</verify>
  <done>calculateReadinessStatus function implemented with correct priority order and threshold logic</done>
</task>

<task type="auto">
  <name>Task 3: Add batch calculation helper</name>
  <files>src/lib/equipment/readiness.ts</files>
  <action>
Add a helper for calculating readiness on multiple equipment items (for list pages and dashboard):

```typescript
/**
 * Calculate readiness status for multiple equipment items.
 * Use for batch processing in list pages and dashboard widgets.
 *
 * @param equipmentList - Array of equipment with damage reports
 * @param thresholds - Team-configured threshold values
 * @returns Array of equipment with readiness result attached
 */
export function calculateMultipleReadinessStatus<T extends EquipmentForReadiness>(
  equipmentList: T[],
  thresholds: ReadinessThresholds = DEFAULT_READINESS_THRESHOLDS
): Array<T & { readiness: EquipmentReadinessResult }> {
  return equipmentList.map(equipment => ({
    ...equipment,
    readiness: calculateReadinessStatus(equipment, thresholds),
  }));
}

/**
 * Aggregate readiness status counts for fleet health overview.
 *
 * @param equipmentList - Array of equipment with damage reports
 * @param thresholds - Team-configured threshold values
 * @returns Count of equipment in each status category
 */
export function aggregateFleetHealth<T extends EquipmentForReadiness>(
  equipmentList: T[],
  thresholds: ReadinessThresholds = DEFAULT_READINESS_THRESHOLDS
): Record<ReadinessStatus, number> {
  const counts: Record<ReadinessStatus, number> = {
    READY: 0,
    INSPECT_SOON: 0,
    NEEDS_ATTENTION: 0,
    OUT_OF_SERVICE: 0,
  };

  for (const equipment of equipmentList) {
    const { status } = calculateReadinessStatus(equipment, thresholds);
    counts[status]++;
  }

  return counts;
}
```
  </action>
  <verify>grep -n "calculateMultipleReadinessStatus\|aggregateFleetHealth" src/lib/equipment/readiness.ts shows both helpers</verify>
  <done>Batch calculation helpers for list pages and dashboard widget exported</done>
</task>

</tasks>

<verification>
1. Type exports: `grep "export type ReadinessStatus\|export interface ReadinessThresholds" src/lib/equipment/readiness.ts`
2. Function exports: `grep "export function calculateReadinessStatus\|export function aggregateFleetHealth" src/lib/equipment/readiness.ts`
3. Priority order: Manual override checked before damage reports checked before inspection days
4. Null handling: `grep "daysSince === null" src/lib/equipment/readiness.ts` shows null check
5. TypeScript: `npx tsc --noEmit` passes
</verification>

<success_criteria>
- ReadinessStatus type with 4 statuses exported
- ReadinessThresholds interface with 3 threshold fields exported
- calculateReadinessStatus function implements correct priority order
- Null lastInspectedAt returns OUT_OF_SERVICE with "No inspection record"
- calculateMultipleReadinessStatus for batch processing
- aggregateFleetHealth for dashboard widget counts
- All existing exports preserved (computeEquipmentReadiness, etc.)
</success_criteria>

<output>
After completion, create `.planning/phases/21-equipment-readiness/21-02-SUMMARY.md`
</output>
