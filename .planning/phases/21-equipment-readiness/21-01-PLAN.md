---
phase: 21-equipment-readiness
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/generated/prisma/*
autonomous: true

must_haves:
  truths:
    - "Equipment model has lastInspectedAt field"
    - "TeamSettings model has readiness threshold fields"
    - "DamageReport model has resolutionNote and archivedAt fields"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Schema extensions for readiness"
      contains: "lastInspectedAt"
    - path: "src/generated/prisma/index.d.ts"
      provides: "Generated Prisma types"
  key_links:
    - from: "prisma/schema.prisma"
      to: "src/generated/prisma"
      via: "prisma generate"
      pattern: "lastInspectedAt.*DateTime"
---

<objective>
Extend Prisma schema with fields required for equipment readiness calculation.

Purpose: Provide data foundation for threshold-based readiness status calculation including inspection dates, configurable thresholds per team, and maintenance workflow with resolution notes.

Output: Updated schema with Equipment.lastInspectedAt, TeamSettings threshold fields, DamageReport.resolutionNote and archivedAt fields.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-equipment-readiness/21-CONTEXT.md
@.planning/phases/21-equipment-readiness/21-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Equipment model with lastInspectedAt</name>
  <files>prisma/schema.prisma</files>
  <action>
Add lastInspectedAt field to Equipment model:

```prisma
model Equipment {
  // ... existing fields ...
  lastInspectedAt       DateTime?  // When equipment was last inspected (null = never)
  // ... rest of fields ...
}
```

Place after manualUnavailableNote field, before ownership hierarchy fields.

Default is null (never inspected) - this is intentional per CONTEXT.md. Equipment with null lastInspectedAt will show OUT_OF_SERVICE status until first inspection.
  </action>
  <verify>grep -n "lastInspectedAt" prisma/schema.prisma shows field defined</verify>
  <done>Equipment model has lastInspectedAt DateTime? field</done>
</task>

<task type="auto">
  <name>Task 2: Extend TeamSettings with readiness thresholds</name>
  <files>prisma/schema.prisma</files>
  <action>
Add readiness threshold fields to TeamSettings model:

```prisma
model TeamSettings {
  id                           String   @id @default(uuid())
  teamId                       String   @unique
  damageNotifyUserIds          String[]
  // NEW: Equipment readiness thresholds (days since inspection)
  readinessInspectSoonDays     Int      @default(14)   // Yellow: approaching inspection
  readinessNeedsAttentionDays  Int      @default(21)   // Amber: overdue for inspection
  readinessOutOfServiceDays    Int      @default(30)   // Red: must inspect before use
  createdAt                    DateTime @default(now())
  updatedAt                    DateTime @updatedAt
  // ... relations ...
}
```

Default thresholds from CONTEXT.md: 14/21/30 days.
  </action>
  <verify>grep -n "readinessInspectSoonDays" prisma/schema.prisma shows all 3 threshold fields</verify>
  <done>TeamSettings model has readinessInspectSoonDays, readinessNeedsAttentionDays, readinessOutOfServiceDays fields with defaults</done>
</task>

<task type="auto">
  <name>Task 3: Extend DamageReport with resolutionNote and archivedAt</name>
  <files>prisma/schema.prisma</files>
  <action>
Add maintenance workflow fields to DamageReport model:

```prisma
model DamageReport {
  // ... existing fields through resolvedBy ...
  resolutionNote   String?    // Optional note on how issue was resolved
  archivedAt       DateTime?  // When report was archived (MINOR reports after resolution)
  createdAt        DateTime   @default(now())
  // ... relations and indexes ...
}
```

Place resolutionNote after resolvedBy, archivedAt after resolutionNote.

Per CONTEXT.md: MINOR reports get archived after resolution (archivedAt set), CRITICAL/MODERATE kept forever (archivedAt stays null).
  </action>
  <verify>grep -n "resolutionNote\|archivedAt" prisma/schema.prisma shows both fields in DamageReport</verify>
  <done>DamageReport model has resolutionNote String? and archivedAt DateTime? fields</done>
</task>

<task type="auto">
  <name>Task 4: Run Prisma migration and generate client</name>
  <files>src/generated/prisma/*</files>
  <action>
Run Prisma commands to apply schema changes:

1. Generate migration:
   ```bash
   npx prisma migrate dev --name add_equipment_readiness_fields
   ```

2. Verify generated types include new fields:
   - Equipment should have lastInspectedAt?: Date | null
   - TeamSettings should have readinessInspectSoonDays, readinessNeedsAttentionDays, readinessOutOfServiceDays
   - DamageReport should have resolutionNote?: string | null, archivedAt?: Date | null

If migration already exists or DB is in sync, use:
   ```bash
   npx prisma db push
   npx prisma generate
   ```
  </action>
  <verify>npx prisma validate && grep "lastInspectedAt" src/generated/prisma/index.d.ts</verify>
  <done>Prisma client regenerated with all new fields available in TypeScript types</done>
</task>

</tasks>

<verification>
1. Schema validation: `npx prisma validate` passes
2. Field presence check:
   - `grep "lastInspectedAt" prisma/schema.prisma` shows DateTime?
   - `grep "readinessInspectSoonDays" prisma/schema.prisma` shows Int @default(14)
   - `grep "resolutionNote" prisma/schema.prisma` shows String?
3. Type generation: `src/generated/prisma/index.d.ts` contains all new field types
</verification>

<success_criteria>
- Equipment.lastInspectedAt field exists with DateTime? type
- TeamSettings has 3 threshold fields with correct defaults (14, 21, 30)
- DamageReport has resolutionNote and archivedAt fields
- Prisma client regenerated successfully
- No migration errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-equipment-readiness/21-01-SUMMARY.md`
</output>
