---
phase: 21-equipment-readiness
plan: 04
type: execute
wave: 3
depends_on: ["21-02", "21-03"]
files_modified:
  - src/app/(dashboard)/[teamSlug]/equipment/page.tsx
  - src/app/(dashboard)/[teamSlug]/equipment/[id]/page.tsx
  - src/app/(dashboard)/[teamSlug]/equipment/equipment-list-client.tsx
  - src/app/api/equipment/[id]/route.ts
  - src/app/api/team-settings/route.ts
  - src/app/(dashboard)/[teamSlug]/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "Equipment list page shows readiness badge for each item"
    - "Equipment detail page shows readiness badge and 'Mark as Inspected' button"
    - "Mark as Inspected button updates lastInspectedAt to current time"
    - "Settings page has readiness threshold configuration form"
  artifacts:
    - path: "src/app/(dashboard)/[teamSlug]/equipment/page.tsx"
      provides: "Equipment list with readiness badges"
    - path: "src/app/(dashboard)/[teamSlug]/equipment/[id]/page.tsx"
      provides: "Equipment detail with badge and inspection button"
    - path: "src/app/(dashboard)/[teamSlug]/settings/page.tsx"
      provides: "Readiness threshold settings section"
    - path: "src/app/api/equipment/[id]/route.ts"
      provides: "PATCH endpoint with markInspected support"
    - path: "src/app/api/team-settings/route.ts"
      provides: "GET/PATCH with threshold fields"
  key_links:
    - from: "src/app/(dashboard)/[teamSlug]/equipment/page.tsx"
      to: "src/lib/equipment/readiness.ts"
      via: "calculateMultipleReadinessStatus import"
      pattern: "calculateMultipleReadinessStatus"
    - from: "src/app/api/equipment/[id]/route.ts"
      to: "prisma.equipment.update"
      via: "lastInspectedAt field"
      pattern: "lastInspectedAt.*new Date"
---

<objective>
Integrate readiness badges and inspection workflow into the equipment UI pages and extend API endpoints.

Purpose: Make readiness status visible on equipment list and detail pages, allow coaches to mark equipment as inspected, and provide settings UI for threshold configuration.

Output: Equipment pages show readiness badges, detail page has "Mark as Inspected" button, settings page has threshold configuration form.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-equipment-readiness/21-CONTEXT.md
@.planning/phases/21-equipment-readiness/21-RESEARCH.md
@src/app/(dashboard)/[teamSlug]/equipment/page.tsx
@src/app/(dashboard)/[teamSlug]/equipment/[id]/page.tsx
@src/app/api/team-settings/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend equipment list page with readiness calculation and badges</name>
  <files>src/app/(dashboard)/[teamSlug]/equipment/page.tsx, src/app/(dashboard)/[teamSlug]/equipment/equipment-list-client.tsx</files>
  <action>
Update the server component (page.tsx) to fetch readiness data and calculate status:

1. In page.tsx, update the equipment query to include damage reports and lastInspectedAt:
```typescript
import { calculateMultipleReadinessStatus, DEFAULT_READINESS_THRESHOLDS } from '@/lib/equipment/readiness';

// Update equipment query to include readiness data
const [equipment, settings] = await Promise.all([
  prisma.equipment.findMany({
    where: { teamId: team.id },
    include: {
      damageReports: {
        where: { status: 'OPEN' },
        select: { id: true, severity: true, status: true, location: true },
      },
    },
    orderBy: [{ type: 'asc' }, { name: 'asc' }],
  }),
  prisma.teamSettings.findUnique({
    where: { teamId: team.id },
    select: {
      readinessInspectSoonDays: true,
      readinessNeedsAttentionDays: true,
      readinessOutOfServiceDays: true,
    },
  }),
]);

// Build thresholds from settings or use defaults
const thresholds = {
  inspectSoonDays: settings?.readinessInspectSoonDays ?? 14,
  needsAttentionDays: settings?.readinessNeedsAttentionDays ?? 21,
  outOfServiceDays: settings?.readinessOutOfServiceDays ?? 30,
};

// Calculate readiness for all equipment
const equipmentWithReadiness = calculateMultipleReadinessStatus(equipment, thresholds);
```

2. Pass readiness data to the client component.

3. In equipment-list-client.tsx, add ReadinessBadge to each equipment row:
```typescript
import { ReadinessBadge } from '@/components/equipment/readiness-badge';

// In the equipment card/row, add after the name:
<ReadinessBadge status={equipment.readiness.status} />
```

Place the badge after the equipment name, before the equipment type indicator. Use a flex container to align them.
  </action>
  <verify>grep -n "ReadinessBadge\|calculateMultipleReadinessStatus" src/app/\(dashboard\)/\[teamSlug\]/equipment/page.tsx</verify>
  <done>Equipment list page calculates and displays readiness badges for each item</done>
</task>

<task type="auto">
  <name>Task 2: Add readiness badge and "Mark as Inspected" to equipment detail page</name>
  <files>src/app/(dashboard)/[teamSlug]/equipment/[id]/page.tsx</files>
  <action>
Update the detail page to show readiness status and inspection button:

1. Fetch settings and calculate readiness:
```typescript
import { calculateReadinessStatus, DEFAULT_READINESS_THRESHOLDS } from '@/lib/equipment/readiness';

// Add settings fetch to the parallel query
const [equipment, settings] = await Promise.all([
  prisma.equipment.findFirst({
    where: { id, teamId: team.id },
    include: {
      damageReports: {
        orderBy: { createdAt: 'desc' },
      },
    },
  }),
  prisma.teamSettings.findUnique({
    where: { teamId: team.id },
    select: {
      readinessInspectSoonDays: true,
      readinessNeedsAttentionDays: true,
      readinessOutOfServiceDays: true,
    },
  }),
]);

// Calculate readiness
const thresholds = {
  inspectSoonDays: settings?.readinessInspectSoonDays ?? 14,
  needsAttentionDays: settings?.readinessNeedsAttentionDays ?? 21,
  outOfServiceDays: settings?.readinessOutOfServiceDays ?? 30,
};

// Need to add lastInspectedAt to equipment select
const readiness = calculateReadinessStatus({
  manualUnavailable: equipment.manualUnavailable,
  manualUnavailableNote: equipment.manualUnavailableNote,
  lastInspectedAt: equipment.lastInspectedAt,
  damageReports: equipment.damageReports.filter(r => r.status === 'OPEN').map(r => ({
    id: r.id,
    severity: r.severity,
    status: r.status,
    location: r.location,
  })),
}, thresholds);
```

2. Add readiness badge in the header section:
```typescript
import { ReadinessBadge } from '@/components/equipment/readiness-badge';

// In the header, after the equipment name
<div className="flex items-center gap-3">
  <h1 className="text-2xl font-bold text-white">{equipment.name}</h1>
  <ReadinessBadge status={readiness.status} />
</div>
```

3. Add "Mark as Inspected" button (coaches only) and inspection info display.

Pass equipmentId, readiness, lastInspectedAt, and isCoach to a client component (EquipmentDetail or create InspectionSection) that handles the button click.

The button should call PATCH /api/equipment/[id] with `{ markInspected: true }`.
  </action>
  <verify>grep -n "ReadinessBadge\|lastInspectedAt\|markInspected" src/app/\(dashboard\)/\[teamSlug\]/equipment/\[id\]/page.tsx</verify>
  <done>Equipment detail page shows readiness badge, last inspection date, and Mark as Inspected button for coaches</done>
</task>

<task type="auto">
  <name>Task 3: Extend equipment API with markInspected support</name>
  <files>src/app/api/equipment/[id]/route.ts</files>
  <action>
Update or create the PATCH endpoint to support marking equipment as inspected:

```typescript
import { z } from 'zod';

const updateEquipmentSchema = z.object({
  // ... existing fields ...
  markInspected: z.boolean().optional(),
});

export async function PATCH(request: NextRequest, { params }: RouteParams) {
  const { user, claims, error } = await getClaimsForApiRoute();
  if (error || !user) return unauthorizedResponse();
  if (claims.user_role !== 'COACH') return forbiddenResponse('Only coaches can update equipment');

  const { id } = await params;
  const body = await request.json();

  const validationResult = updateEquipmentSchema.safeParse(body);
  if (!validationResult.success) {
    return NextResponse.json({ error: 'Validation failed', details: validationResult.error.flatten() }, { status: 400 });
  }

  // Verify equipment belongs to user's team
  const equipment = await prisma.equipment.findFirst({
    where: { id, teamId: claims.team_id },
  });

  if (!equipment) {
    return NextResponse.json({ error: 'Equipment not found' }, { status: 404 });
  }

  const updateData: Record<string, any> = {};

  if (validationResult.data.markInspected) {
    updateData.lastInspectedAt = new Date();
  }

  // ... handle other update fields ...

  const updated = await prisma.equipment.update({
    where: { id },
    data: updateData,
  });

  return NextResponse.json(updated);
}
```

If the route file doesn't exist, create it. If it exists, extend the existing PATCH handler.
  </action>
  <verify>grep -n "markInspected\|lastInspectedAt" src/app/api/equipment/\[id\]/route.ts</verify>
  <done>Equipment API PATCH endpoint supports markInspected: true to set lastInspectedAt to current time</done>
</task>

<task type="auto">
  <name>Task 4: Extend team settings API with readiness threshold fields</name>
  <files>src/app/api/team-settings/route.ts</files>
  <action>
Update the team settings API to support readiness threshold fields:

1. Update the validation schema:
```typescript
const updateSettingsSchema = z.object({
  damageNotifyUserIds: z.array(z.string().uuid()).optional(),
  primaryColor: z.string().regex(/^#[0-9A-Fa-f]{6}$/).optional(),
  secondaryColor: z.string().regex(/^#[0-9A-Fa-f]{6}$/).optional(),
  // NEW: Readiness threshold fields
  readinessInspectSoonDays: z.number().int().min(1).max(365).optional(),
  readinessNeedsAttentionDays: z.number().int().min(1).max(365).optional(),
  readinessOutOfServiceDays: z.number().int().min(1).max(365).optional(),
});
```

2. Update GET response to include threshold fields:
```typescript
const settingsResponse = {
  damageNotifyUserIds: settings?.damageNotifyUserIds || [],
  readinessInspectSoonDays: settings?.readinessInspectSoonDays ?? 14,
  readinessNeedsAttentionDays: settings?.readinessNeedsAttentionDays ?? 21,
  readinessOutOfServiceDays: settings?.readinessOutOfServiceDays ?? 30,
};
```

3. Update PATCH handler to support threshold updates:
```typescript
const { readinessInspectSoonDays, readinessNeedsAttentionDays, readinessOutOfServiceDays } = validationResult.data;

// Handle readiness threshold updates
if (readinessInspectSoonDays !== undefined || readinessNeedsAttentionDays !== undefined || readinessOutOfServiceDays !== undefined) {
  const updateData: Record<string, number> = {};
  if (readinessInspectSoonDays !== undefined) updateData.readinessInspectSoonDays = readinessInspectSoonDays;
  if (readinessNeedsAttentionDays !== undefined) updateData.readinessNeedsAttentionDays = readinessNeedsAttentionDays;
  if (readinessOutOfServiceDays !== undefined) updateData.readinessOutOfServiceDays = readinessOutOfServiceDays;

  await prisma.teamSettings.upsert({
    where: { teamId: claims.team_id },
    update: updateData,
    create: {
      teamId: claims.team_id,
      ...updateData,
    },
  });

  return NextResponse.json({ success: true, settings: updateData });
}
```
  </action>
  <verify>grep -n "readinessInspectSoonDays\|readinessNeedsAttentionDays\|readinessOutOfServiceDays" src/app/api/team-settings/route.ts</verify>
  <done>Team settings API GET returns threshold fields, PATCH accepts threshold updates</done>
</task>

<task type="auto">
  <name>Task 5: Add readiness threshold settings section to settings page</name>
  <files>src/app/(dashboard)/[teamSlug]/settings/page.tsx</files>
  <action>
Add a new section to the settings page for configuring readiness thresholds:

1. Add state for threshold values:
```typescript
const [inspectSoonDays, setInspectSoonDays] = useState(14);
const [needsAttentionDays, setNeedsAttentionDays] = useState(21);
const [outOfServiceDays, setOutOfServiceDays] = useState(30);
const [savingThresholds, setSavingThresholds] = useState(false);
const [thresholdSuccess, setThresholdSuccess] = useState(false);
```

2. Update fetchSettings to load threshold values:
```typescript
if (data.settings) {
  setInspectSoonDays(data.settings.readinessInspectSoonDays ?? 14);
  setNeedsAttentionDays(data.settings.readinessNeedsAttentionDays ?? 21);
  setOutOfServiceDays(data.settings.readinessOutOfServiceDays ?? 30);
}
```

3. Add save handler:
```typescript
const handleSaveThresholds = async () => {
  setSavingThresholds(true);
  setError(null);
  setThresholdSuccess(false);

  try {
    const response = await fetch('/api/team-settings', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        readinessInspectSoonDays: inspectSoonDays,
        readinessNeedsAttentionDays: needsAttentionDays,
        readinessOutOfServiceDays: outOfServiceDays,
      }),
    });

    if (!response.ok) throw new Error('Failed to save thresholds');

    setThresholdSuccess(true);
    setTimeout(() => setThresholdSuccess(false), 3000);
  } catch (err) {
    setError(err instanceof Error ? err.message : 'Failed to save thresholds');
  } finally {
    setSavingThresholds(false);
  }
};
```

4. Add UI section (place after Team Colors section, before Notifications):
```tsx
{/* Equipment Readiness Thresholds */}
<div className="bg-zinc-800/50 rounded-xl p-6 border border-zinc-700/50">
  <h2 className="text-lg font-semibold text-white mb-4">Equipment Readiness Thresholds</h2>
  <p className="text-sm text-zinc-400 mb-6">
    Configure when equipment is flagged for inspection based on days since last inspection.
  </p>

  <div className="space-y-4">
    <div>
      <label className="block text-sm text-zinc-300 mb-2">
        Inspect Soon (yellow) - days
      </label>
      <input
        type="number"
        min="1"
        max="365"
        value={inspectSoonDays}
        onChange={(e) => setInspectSoonDays(parseInt(e.target.value) || 14)}
        className="w-full px-3 py-2 bg-zinc-900 border border-zinc-700 rounded-lg text-white focus:outline-none focus:border-emerald-500"
      />
    </div>

    <div>
      <label className="block text-sm text-zinc-300 mb-2">
        Needs Attention (amber) - days
      </label>
      <input
        type="number"
        min="1"
        max="365"
        value={needsAttentionDays}
        onChange={(e) => setNeedsAttentionDays(parseInt(e.target.value) || 21)}
        className="w-full px-3 py-2 bg-zinc-900 border border-zinc-700 rounded-lg text-white focus:outline-none focus:border-emerald-500"
      />
    </div>

    <div>
      <label className="block text-sm text-zinc-300 mb-2">
        Out of Service (red) - days
      </label>
      <input
        type="number"
        min="1"
        max="365"
        value={outOfServiceDays}
        onChange={(e) => setOutOfServiceDays(parseInt(e.target.value) || 30)}
        className="w-full px-3 py-2 bg-zinc-900 border border-zinc-700 rounded-lg text-white focus:outline-none focus:border-emerald-500"
      />
    </div>

    <button
      onClick={handleSaveThresholds}
      disabled={savingThresholds}
      className="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 disabled:bg-emerald-600/50 text-white rounded-lg text-sm font-medium transition-colors"
    >
      {savingThresholds ? 'Saving...' : 'Save Thresholds'}
    </button>

    {thresholdSuccess && (
      <p className="text-sm text-emerald-400">Thresholds saved successfully!</p>
    )}
  </div>
</div>
```
  </action>
  <verify>grep -n "readinessInspectSoonDays\|Equipment Readiness Thresholds" src/app/\(dashboard\)/\[teamSlug\]/settings/page.tsx</verify>
  <done>Settings page has Equipment Readiness Thresholds section with 3 number inputs and save button</done>
</task>

</tasks>

<verification>
1. Equipment list: Visit /{teamSlug}/equipment - badges visible for each item
2. Equipment detail: Visit /{teamSlug}/equipment/{id} - badge and "Mark as Inspected" button visible (coaches only)
3. Mark as Inspected: Click button, page refreshes with updated lastInspectedAt
4. Settings: Visit /{teamSlug}/settings - threshold configuration section exists
5. Threshold save: Change thresholds, save, verify equipment statuses update on list page
6. TypeScript: `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Equipment list page shows ReadinessBadge for each item with correct status color
- Equipment detail page shows ReadinessBadge in header
- Detail page shows last inspection date (or "Never" if null)
- "Mark as Inspected" button visible for coaches, updates equipment and refreshes status
- Settings page has "Equipment Readiness Thresholds" section
- Threshold inputs accept numbers 1-365
- Save button persists thresholds via PATCH /api/team-settings
- Threshold changes immediately affect equipment status calculation (server-rendered on page load)
</success_criteria>

<output>
After completion, create `.planning/phases/21-equipment-readiness/21-04-SUMMARY.md`
</output>
