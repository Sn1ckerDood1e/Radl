---
phase: 21-equipment-readiness
plan: 06
type: execute
wave: 3
depends_on: ["21-02", "21-03"]
files_modified:
  - src/app/api/team-settings/route.ts
  - src/app/(dashboard)/[teamSlug]/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "Settings page has readiness threshold configuration form"
    - "Threshold changes persist to database"
    - "Saved thresholds affect equipment status calculation"
  artifacts:
    - path: "src/app/(dashboard)/[teamSlug]/settings/page.tsx"
      provides: "Readiness threshold settings section"
    - path: "src/app/api/team-settings/route.ts"
      provides: "GET/PATCH with threshold fields"
  key_links:
    - from: "src/app/(dashboard)/[teamSlug]/settings/page.tsx"
      to: "/api/team-settings"
      via: "fetch PATCH"
      pattern: "fetch.*team-settings"
    - from: "src/app/api/team-settings/route.ts"
      to: "prisma.teamSettings"
      via: "upsert with thresholds"
      pattern: "readinessInspectSoonDays"
---

<objective>
Add readiness threshold configuration to team settings API and settings page.

Purpose: Allow teams to customize the inspection thresholds that determine when equipment shows yellow, amber, and red status badges.

Output: Settings API supports threshold fields, settings page has threshold configuration form.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-equipment-readiness/21-CONTEXT.md
@.planning/phases/21-equipment-readiness/21-RESEARCH.md
@src/app/api/team-settings/route.ts
@src/app/(dashboard)/[teamSlug]/settings/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend team settings API with readiness threshold fields</name>
  <files>src/app/api/team-settings/route.ts</files>
  <action>
Update the team settings API to support readiness threshold fields:

1. Update the validation schema:
```typescript
const updateSettingsSchema = z.object({
  damageNotifyUserIds: z.array(z.string().uuid()).optional(),
  primaryColor: z.string().regex(/^#[0-9A-Fa-f]{6}$/).optional(),
  secondaryColor: z.string().regex(/^#[0-9A-Fa-f]{6}$/).optional(),
  // NEW: Readiness threshold fields
  readinessInspectSoonDays: z.number().int().min(1).max(365).optional(),
  readinessNeedsAttentionDays: z.number().int().min(1).max(365).optional(),
  readinessOutOfServiceDays: z.number().int().min(1).max(365).optional(),
});
```

2. Update GET response to include threshold fields:
```typescript
const settingsResponse = {
  damageNotifyUserIds: settings?.damageNotifyUserIds || [],
  readinessInspectSoonDays: settings?.readinessInspectSoonDays ?? 14,
  readinessNeedsAttentionDays: settings?.readinessNeedsAttentionDays ?? 21,
  readinessOutOfServiceDays: settings?.readinessOutOfServiceDays ?? 30,
};
```

3. Update PATCH handler to support threshold updates:
```typescript
const { readinessInspectSoonDays, readinessNeedsAttentionDays, readinessOutOfServiceDays } = validationResult.data;

// Handle readiness threshold updates
if (readinessInspectSoonDays !== undefined || readinessNeedsAttentionDays !== undefined || readinessOutOfServiceDays !== undefined) {
  const updateData: Record<string, number> = {};
  if (readinessInspectSoonDays !== undefined) updateData.readinessInspectSoonDays = readinessInspectSoonDays;
  if (readinessNeedsAttentionDays !== undefined) updateData.readinessNeedsAttentionDays = readinessNeedsAttentionDays;
  if (readinessOutOfServiceDays !== undefined) updateData.readinessOutOfServiceDays = readinessOutOfServiceDays;

  await prisma.teamSettings.upsert({
    where: { teamId: claims.team_id },
    update: updateData,
    create: {
      teamId: claims.team_id,
      ...updateData,
    },
  });

  return NextResponse.json({ success: true, settings: updateData });
}
```
  </action>
  <verify>grep -n "readinessInspectSoonDays\|readinessNeedsAttentionDays\|readinessOutOfServiceDays" src/app/api/team-settings/route.ts</verify>
  <done>Team settings API GET returns threshold fields, PATCH accepts threshold updates</done>
</task>

<task type="auto">
  <name>Task 2: Add readiness threshold settings section to settings page</name>
  <files>src/app/(dashboard)/[teamSlug]/settings/page.tsx</files>
  <action>
Add a new section to the settings page for configuring readiness thresholds:

1. Add state for threshold values:
```typescript
const [inspectSoonDays, setInspectSoonDays] = useState(14);
const [needsAttentionDays, setNeedsAttentionDays] = useState(21);
const [outOfServiceDays, setOutOfServiceDays] = useState(30);
const [savingThresholds, setSavingThresholds] = useState(false);
const [thresholdSuccess, setThresholdSuccess] = useState(false);
```

2. Update fetchSettings to load threshold values:
```typescript
if (data.settings) {
  setInspectSoonDays(data.settings.readinessInspectSoonDays ?? 14);
  setNeedsAttentionDays(data.settings.readinessNeedsAttentionDays ?? 21);
  setOutOfServiceDays(data.settings.readinessOutOfServiceDays ?? 30);
}
```

3. Add save handler:
```typescript
const handleSaveThresholds = async () => {
  setSavingThresholds(true);
  setError(null);
  setThresholdSuccess(false);

  try {
    const response = await fetch('/api/team-settings', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        readinessInspectSoonDays: inspectSoonDays,
        readinessNeedsAttentionDays: needsAttentionDays,
        readinessOutOfServiceDays: outOfServiceDays,
      }),
    });

    if (!response.ok) throw new Error('Failed to save thresholds');

    setThresholdSuccess(true);
    setTimeout(() => setThresholdSuccess(false), 3000);
  } catch (err) {
    setError(err instanceof Error ? err.message : 'Failed to save thresholds');
  } finally {
    setSavingThresholds(false);
  }
};
```

4. Add UI section (place after Team Colors section, before Notifications):
```tsx
{/* Equipment Readiness Thresholds */}
<div className="bg-zinc-800/50 rounded-xl p-6 border border-zinc-700/50">
  <h2 className="text-lg font-semibold text-white mb-4">Equipment Readiness Thresholds</h2>
  <p className="text-sm text-zinc-400 mb-6">
    Configure when equipment is flagged for inspection based on days since last inspection.
  </p>

  <div className="space-y-4">
    <div>
      <label className="block text-sm text-zinc-300 mb-2">
        Inspect Soon (yellow) - days
      </label>
      <input
        type="number"
        min="1"
        max="365"
        value={inspectSoonDays}
        onChange={(e) => setInspectSoonDays(parseInt(e.target.value) || 14)}
        className="w-full px-3 py-2 bg-zinc-900 border border-zinc-700 rounded-lg text-white focus:outline-none focus:border-emerald-500"
      />
    </div>

    <div>
      <label className="block text-sm text-zinc-300 mb-2">
        Needs Attention (amber) - days
      </label>
      <input
        type="number"
        min="1"
        max="365"
        value={needsAttentionDays}
        onChange={(e) => setNeedsAttentionDays(parseInt(e.target.value) || 21)}
        className="w-full px-3 py-2 bg-zinc-900 border border-zinc-700 rounded-lg text-white focus:outline-none focus:border-emerald-500"
      />
    </div>

    <div>
      <label className="block text-sm text-zinc-300 mb-2">
        Out of Service (red) - days
      </label>
      <input
        type="number"
        min="1"
        max="365"
        value={outOfServiceDays}
        onChange={(e) => setOutOfServiceDays(parseInt(e.target.value) || 30)}
        className="w-full px-3 py-2 bg-zinc-900 border border-zinc-700 rounded-lg text-white focus:outline-none focus:border-emerald-500"
      />
    </div>

    <button
      onClick={handleSaveThresholds}
      disabled={savingThresholds}
      className="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 disabled:bg-emerald-600/50 text-white rounded-lg text-sm font-medium transition-colors"
    >
      {savingThresholds ? 'Saving...' : 'Save Thresholds'}
    </button>

    {thresholdSuccess && (
      <p className="text-sm text-emerald-400">Thresholds saved successfully!</p>
    )}
  </div>
</div>
```
  </action>
  <verify>grep -n "readinessInspectSoonDays\|Equipment Readiness Thresholds" src/app/\(dashboard\)/\[teamSlug\]/settings/page.tsx</verify>
  <done>Settings page has Equipment Readiness Thresholds section with 3 number inputs and save button</done>
</task>

</tasks>

<verification>
1. Settings: Visit /{teamSlug}/settings - threshold configuration section exists
2. Threshold save: Change thresholds, save, verify API returns success
3. Threshold persistence: Refresh page, verify saved values are loaded
4. TypeScript: `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Settings page has "Equipment Readiness Thresholds" section
- Threshold inputs accept numbers 1-365
- Save button persists thresholds via PATCH /api/team-settings
- Threshold changes immediately affect equipment status calculation (server-rendered on page load)
</success_criteria>

<output>
After completion, create `.planning/phases/21-equipment-readiness/21-06-SUMMARY.md`
</output>
