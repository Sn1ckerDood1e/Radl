---
phase: 37-user-management
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/admin/users/route.ts
  - src/app/api/admin/users/[userId]/deactivate/route.ts
  - src/app/api/admin/users/[userId]/reactivate/route.ts
  - src/app/api/admin/users/[userId]/reset-password/route.ts
autonomous: true

must_haves:
  truths:
    - "Super admin can create a new user without self-signup"
    - "Created user receives password setup email"
    - "Super admin can deactivate a user blocking their login"
    - "Super admin can reactivate a deactivated user"
    - "Super admin can send password reset link to user"
  artifacts:
    - path: "src/app/api/admin/users/route.ts"
      provides: "POST create user endpoint"
      exports: ["POST"]
    - path: "src/app/api/admin/users/[userId]/deactivate/route.ts"
      provides: "POST deactivate user"
      exports: ["POST"]
    - path: "src/app/api/admin/users/[userId]/reactivate/route.ts"
      provides: "POST reactivate user"
      exports: ["POST"]
    - path: "src/app/api/admin/users/[userId]/reset-password/route.ts"
      provides: "POST password reset link"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/admin/users/route.ts"
      to: "src/lib/supabase/admin.ts"
      via: "getSupabaseAdmin().auth.admin.createUser"
      pattern: "createUser"
    - from: "deactivate/route.ts"
      to: "src/lib/supabase/admin.ts"
      via: "updateUserById with ban_duration"
      pattern: "ban_duration"
---

<objective>
Create admin user management operations: create, deactivate, reactivate, password reset

Purpose: Enables super admin to fully manage user lifecycle (USER-03, USER-06, USER-07, USER-08)
Output: Working API routes for user creation and account status management
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 36 admin auth infrastructure
@.planning/phases/36-admin-foundation-auth/36-02-SUMMARY.md

# Existing patterns
@src/lib/auth/admin-authorize.ts
@src/lib/audit/logger.ts
@src/lib/audit/actions.ts
@src/lib/errors/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add POST Create User to Users Route</name>
  <files>src/app/api/admin/users/route.ts</files>
  <action>
Add POST handler to create a new user bypassing signup flow (USER-03).

Implementation:
1. Verify super admin via getSuperAdminContext()
2. Parse body: { email: string, displayName?: string, phone?: string }
3. Validate email format
4. Check if user already exists via getSupabaseAdmin().auth.admin.listUsers with email filter
5. If exists, return 409 Conflict with existing user info
6. Create user via Supabase Admin API:
```typescript
const { data, error } = await supabase.auth.admin.createUser({
  email,
  email_confirm: false,  // Don't auto-confirm
  user_metadata: {
    display_name: displayName || null,
    phone: phone || null,
  },
});
```
7. Send password setup email via:
```typescript
await supabase.auth.admin.inviteUserByEmail(email);
```
   This sends a "magic link" that allows the user to set their password.
8. Log admin action:
   - action: 'ADMIN_USER_CREATED'
   - targetType: 'User'
   - targetId: newUser.id
   - afterState: { email, displayName }
9. Return 201 with created user data

Error handling:
- 400 for invalid email format
- 409 if email already exists
- 500 for Supabase API errors (with error ref)
  </action>
  <verify>
Test with curl:
```bash
curl -X POST -H "Cookie: $(cat /tmp/admin-cookie)" -H "Content-Type: application/json" \
  -d '{"email":"newuser@example.com","displayName":"Test User"}' \
  http://localhost:3000/api/admin/users
```
Verify 201 response with user object, check email arrives at inbox.
  </verify>
  <done>POST /api/admin/users creates user and sends password setup email</done>
</task>

<task type="auto">
  <name>Task 2: Create Deactivate and Reactivate Endpoints</name>
  <files>
    src/app/api/admin/users/[userId]/deactivate/route.ts
    src/app/api/admin/users/[userId]/reactivate/route.ts
  </files>
  <action>
Create endpoints for user deactivation (USER-06) and reactivation (USER-07).

**POST /api/admin/users/[userId]/deactivate**:
1. Verify super admin
2. Get current user state from Supabase
3. Check user exists, return 404 if not
4. Check user not already deactivated (banned_until is set)
5. Deactivate via Supabase Admin API:
```typescript
// Ban for 100 years = effectively permanent but reversible
await supabase.auth.admin.updateUserById(userId, {
  ban_duration: '876000h',  // 100 years in hours
});
```
6. Log admin action:
   - action: 'ADMIN_USER_DEACTIVATED'
   - targetType: 'User'
   - targetId: userId
   - beforeState: { email, isDeactivated: false }
   - afterState: { email, isDeactivated: true }
7. Return 200 with { success: true, user: {...} }

**POST /api/admin/users/[userId]/reactivate**:
1. Verify super admin
2. Get current user state from Supabase
3. Check user exists, return 404 if not
4. Check user is currently deactivated (banned_until is set)
5. Reactivate via Supabase Admin API:
```typescript
await supabase.auth.admin.updateUserById(userId, {
  ban_duration: 'none',  // Remove ban
});
```
6. Log admin action:
   - action: 'ADMIN_USER_REACTIVATED'
   - targetType: 'User'
   - targetId: userId
   - beforeState: { email, isDeactivated: true }
   - afterState: { email, isDeactivated: false }
7. Return 200 with { success: true, user: {...} }

Both endpoints should:
- Return 401 for non-admin
- Return 404 for non-existent user
- Return 400 if trying to deactivate already-deactivated or reactivate already-active
  </action>
  <verify>
Test with curl:
```bash
# Deactivate
curl -X POST -H "Cookie: $(cat /tmp/admin-cookie)" \
  http://localhost:3000/api/admin/users/{userId}/deactivate

# Reactivate
curl -X POST -H "Cookie: $(cat /tmp/admin-cookie)" \
  http://localhost:3000/api/admin/users/{userId}/reactivate
```
Verify deactivated user cannot log in, reactivated user can log in again.
  </verify>
  <done>Deactivate and reactivate endpoints work with audit logging</done>
</task>

<task type="auto">
  <name>Task 3: Create Password Reset Endpoint</name>
  <files>src/app/api/admin/users/[userId]/reset-password/route.ts</files>
  <action>
Create endpoint to send password reset link (USER-08).

**POST /api/admin/users/[userId]/reset-password**:
1. Verify super admin
2. Get user from Supabase by ID
3. Check user exists, return 404 if not
4. Check user is not deactivated (can't reset password for banned user)
5. Generate password recovery link via Supabase Admin API:
```typescript
const { data, error } = await supabase.auth.admin.generateLink({
  type: 'recovery',
  email: user.email,
  options: {
    redirectTo: `${process.env.NEXT_PUBLIC_APP_URL}/reset-password`,
  },
});
```
   Note: This generates a link but doesn't send email automatically.

6. Send email with recovery link:
   - Option A: Use Supabase's built-in email by calling resetPasswordForEmail
   - Option B: Use the generated link with custom email template

   For simplicity, use Supabase's built-in:
```typescript
// This sends the password reset email via Supabase
const { error } = await supabase.auth.resetPasswordForEmail(user.email, {
  redirectTo: `${process.env.NEXT_PUBLIC_APP_URL}/reset-password`,
});
```

7. Log admin action:
   - action: 'ADMIN_PASSWORD_RESET'
   - targetType: 'User'
   - targetId: userId
   - metadata: { email: user.email }
8. Return 200 with { success: true, message: 'Password reset email sent' }

Note: The resetPasswordForEmail uses the anon client, but since this is admin-initiated, we should use the admin client to ensure it works even if the user account has issues. If there's a method on auth.admin for this, use that instead.

Alternative approach if direct admin password reset is needed:
```typescript
// Generate a link that the admin can share
const { data } = await supabase.auth.admin.generateLink({
  type: 'recovery',
  email: user.email,
});
// data.properties.action_link contains the reset URL
```
  </action>
  <verify>
Test with curl:
```bash
curl -X POST -H "Cookie: $(cat /tmp/admin-cookie)" \
  http://localhost:3000/api/admin/users/{userId}/reset-password
```
Verify email arrives with password reset link, link works to reset password.
  </verify>
  <done>Password reset endpoint sends recovery email and logs action</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Create user returns 201 and sends password setup email
3. Deactivate blocks user login, returns appropriate status
4. Reactivate restores user login ability
5. Password reset sends recovery email
6. All actions logged to audit log with before/after state
7. All endpoints return 401 for non-admin users
</verification>

<success_criteria>
- POST /api/admin/users creates user and sends invite email
- POST /api/admin/users/[userId]/deactivate sets ban_duration, user cannot login
- POST /api/admin/users/[userId]/reactivate removes ban, user can login
- POST /api/admin/users/[userId]/reset-password sends recovery email
- Requirements USER-03, USER-06, USER-07, USER-08 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/37-user-management/37-02-SUMMARY.md`
</output>
