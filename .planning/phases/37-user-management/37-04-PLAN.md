---
phase: 37-user-management
plan: 04
type: execute
wave: 2
depends_on: ["37-01", "37-02"]
files_modified:
  - src/app/(admin)/admin/users/[userId]/page.tsx
  - src/app/(admin)/admin/users/new/page.tsx
  - src/components/admin/users/user-detail-card.tsx
  - src/components/admin/users/user-form.tsx
  - src/components/admin/users/membership-list.tsx
autonomous: true

must_haves:
  truths:
    - "Super admin can view detailed user profile including all memberships"
    - "Super admin can create a new user via form"
    - "Super admin can edit existing user profile"
    - "User memberships show facility, club, roles, and join date"
  artifacts:
    - path: "src/app/(admin)/admin/users/[userId]/page.tsx"
      provides: "User detail page"
      min_lines: 40
    - path: "src/app/(admin)/admin/users/new/page.tsx"
      provides: "Create user page"
      min_lines: 20
    - path: "src/components/admin/users/user-detail-card.tsx"
      provides: "User profile display"
      exports: ["UserDetailCard"]
    - path: "src/components/admin/users/user-form.tsx"
      provides: "Create/edit user form"
      exports: ["UserForm"]
    - path: "src/components/admin/users/membership-list.tsx"
      provides: "Membership table"
      exports: ["MembershipList"]
  key_links:
    - from: "src/app/(admin)/admin/users/[userId]/page.tsx"
      to: "/api/admin/users/[userId]"
      via: "fetch for user details"
      pattern: "fetch.*api/admin/users"
    - from: "src/components/admin/users/user-form.tsx"
      to: "/api/admin/users"
      via: "POST for create, PATCH for edit"
      pattern: "fetch.*api/admin/users"
---

<objective>
Create user detail page, create user page, and supporting components

Purpose: Provides UI for viewing user details and creating/editing users (USER-03, USER-04, USER-05 UI)
Output: Working detail and form pages at /admin/users/[userId] and /admin/users/new
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 37 API plans
@.planning/phases/37-user-management/37-01-PLAN.md
@.planning/phases/37-user-management/37-02-PLAN.md

# Admin UI patterns
@src/app/(admin)/layout.tsx
@src/components/admin/platform-stats.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create User Detail Page</name>
  <files>src/app/(admin)/admin/users/[userId]/page.tsx</files>
  <action>
Create the user detail page showing profile and memberships.

1. Server component that fetches user data:
```typescript
import { cookies } from 'next/headers';
import { notFound } from 'next/navigation';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { UserDetailCard } from '@/components/admin/users/user-detail-card';
import { MembershipList } from '@/components/admin/users/membership-list';

interface Props {
  params: Promise<{ userId: string }>;
}

export default async function UserDetailPage({ params }: Props) {
  const { userId } = await params;

  const cookieStore = await cookies();
  const cookieHeader = cookieStore.getAll()
    .map(c => `${c.name}=${c.value}`)
    .join('; ');

  const res = await fetch(
    `${process.env.NEXT_PUBLIC_APP_URL}/api/admin/users/${userId}`,
    {
      headers: { Cookie: cookieHeader },
      cache: 'no-store',
    }
  );

  if (res.status === 404) {
    notFound();
  }

  if (!res.ok) {
    throw new Error('Failed to fetch user');
  }

  const user = await res.json();

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <Link href="/admin/users" className="text-sm text-muted-foreground hover:underline">
            &larr; Back to Users
          </Link>
          <h1 className="text-2xl font-bold mt-2">User Details</h1>
        </div>
        <div className="space-x-2">
          <Link href={`/admin/users/${userId}/edit`}>
            <Button variant="outline">Edit User</Button>
          </Link>
        </div>
      </div>

      <UserDetailCard user={user} />

      <div>
        <h2 className="text-lg font-semibold mb-4">Memberships ({user.memberships.length})</h2>
        <MembershipList memberships={user.memberships} />
      </div>
    </div>
  );
}
```

2. Add loading.tsx and not-found.tsx in same folder:

**loading.tsx**:
```tsx
import { Skeleton } from '@/components/ui/skeleton';

export default function Loading() {
  return (
    <div className="space-y-6">
      <Skeleton className="h-8 w-48" />
      <Skeleton className="h-64 w-full" />
      <Skeleton className="h-48 w-full" />
    </div>
  );
}
```

**not-found.tsx**:
```tsx
import Link from 'next/link';
import { Button } from '@/components/ui/button';

export default function NotFound() {
  return (
    <div className="flex flex-col items-center justify-center py-12">
      <h1 className="text-2xl font-bold mb-4">User Not Found</h1>
      <p className="text-muted-foreground mb-6">
        The user you're looking for doesn't exist or has been deleted.
      </p>
      <Link href="/admin/users">
        <Button>Back to Users</Button>
      </Link>
    </div>
  );
}
```
  </action>
  <verify>Visit /admin/users/{validId} shows user details, /admin/users/invalid-id shows not found</verify>
  <done>User detail page renders with profile and memberships</done>
</task>

<task type="auto">
  <name>Task 2: Create User Form Component</name>
  <files>src/components/admin/users/user-form.tsx</files>
  <action>
Create reusable form component for create and edit modes.

1. Client component with react-hook-form:
```typescript
'use client';

import { useRouter } from 'next/navigation';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { toast } from 'sonner';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';

const userSchema = z.object({
  email: z.string().email('Invalid email address'),
  displayName: z.string().optional(),
  phone: z.string().optional(),
});

type UserFormData = z.infer<typeof userSchema>;

interface Props {
  mode: 'create' | 'edit';
  userId?: string;
  defaultValues?: Partial<UserFormData>;
}

export function UserForm({ mode, userId, defaultValues }: Props) {
  const router = useRouter();

  const form = useForm<UserFormData>({
    resolver: zodResolver(userSchema),
    defaultValues: {
      email: defaultValues?.email || '',
      displayName: defaultValues?.displayName || '',
      phone: defaultValues?.phone || '',
    },
    mode: 'onTouched',
  });

  const onSubmit = async (data: UserFormData) => {
    try {
      const url = mode === 'create'
        ? '/api/admin/users'
        : `/api/admin/users/${userId}`;

      const res = await fetch(url, {
        method: mode === 'create' ? 'POST' : 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.error || 'Failed to save user');
      }

      toast.success(mode === 'create' ? 'User created! Password setup email sent.' : 'User updated');
      router.push('/admin/users');
      router.refresh();
    } catch (error) {
      toast.error(error instanceof Error ? error.message : 'Failed to save user');
    }
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>{mode === 'create' ? 'Create User' : 'Edit User'}</CardTitle>
        <CardDescription>
          {mode === 'create'
            ? 'Create a new user. They will receive an email to set their password.'
            : 'Update user profile information.'}
        </CardDescription>
      </CardHeader>
      <CardContent>
        <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="email">Email *</Label>
            <Input
              id="email"
              type="email"
              {...form.register('email')}
              disabled={mode === 'edit'} // Can't change email after creation (Supabase limitation)
            />
            {form.formState.errors.email && (
              <p className="text-sm text-destructive">{form.formState.errors.email.message}</p>
            )}
            {mode === 'edit' && (
              <p className="text-sm text-muted-foreground">Email cannot be changed after account creation</p>
            )}
          </div>

          <div className="space-y-2">
            <Label htmlFor="displayName">Display Name</Label>
            <Input
              id="displayName"
              {...form.register('displayName')}
              placeholder="John Smith"
            />
          </div>

          <div className="space-y-2">
            <Label htmlFor="phone">Phone</Label>
            <Input
              id="phone"
              type="tel"
              {...form.register('phone')}
              placeholder="+1 (555) 123-4567"
            />
          </div>

          <div className="flex gap-2 pt-4">
            <Button type="submit" disabled={form.formState.isSubmitting}>
              {form.formState.isSubmitting ? 'Saving...' : mode === 'create' ? 'Create User' : 'Save Changes'}
            </Button>
            <Button type="button" variant="outline" onClick={() => router.back()}>
              Cancel
            </Button>
          </div>
        </form>
      </CardContent>
    </Card>
  );
}
```

Note: Email editing may be possible with Supabase admin API - check and enable if supported. If not, show as disabled with explanation.
  </action>
  <verify>Form validates email, submits to correct endpoint, shows success/error toasts</verify>
  <done>User form component works for both create and edit modes</done>
</task>

<task type="auto">
  <name>Task 3: Create New User Page and Supporting Components</name>
  <files>
    src/app/(admin)/admin/users/new/page.tsx
    src/components/admin/users/user-detail-card.tsx
    src/components/admin/users/membership-list.tsx
  </files>
  <action>
Create the new user page and remaining detail components.

**src/app/(admin)/admin/users/new/page.tsx**:
```tsx
import Link from 'next/link';
import { UserForm } from '@/components/admin/users/user-form';

export default function NewUserPage() {
  return (
    <div className="space-y-6">
      <div>
        <Link href="/admin/users" className="text-sm text-muted-foreground hover:underline">
          &larr; Back to Users
        </Link>
        <h1 className="text-2xl font-bold mt-2">Create User</h1>
      </div>

      <div className="max-w-xl">
        <UserForm mode="create" />
      </div>
    </div>
  );
}
```

**src/components/admin/users/user-detail-card.tsx**:
```tsx
import { Badge } from '@/components/ui/badge';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { formatDistanceToNow } from 'date-fns';

interface User {
  id: string;
  email: string;
  displayName: string | null;
  phone: string | null;
  createdAt: string;
  lastSignInAt: string | null;
  isDeactivated: boolean;
  emailConfirmedAt: string | null;
}

export function UserDetailCard({ user }: { user: User }) {
  return (
    <Card>
      <CardHeader>
        <div className="flex items-center justify-between">
          <CardTitle>{user.displayName || 'No Name'}</CardTitle>
          <Badge variant={user.isDeactivated ? 'destructive' : 'default'}>
            {user.isDeactivated ? 'Deactivated' : 'Active'}
          </Badge>
        </div>
      </CardHeader>
      <CardContent>
        <dl className="grid grid-cols-2 gap-4 text-sm">
          <div>
            <dt className="text-muted-foreground">Email</dt>
            <dd className="font-medium">{user.email}</dd>
          </div>
          <div>
            <dt className="text-muted-foreground">Phone</dt>
            <dd className="font-medium">{user.phone || '-'}</dd>
          </div>
          <div>
            <dt className="text-muted-foreground">Created</dt>
            <dd className="font-medium">
              {formatDistanceToNow(new Date(user.createdAt), { addSuffix: true })}
            </dd>
          </div>
          <div>
            <dt className="text-muted-foreground">Last Sign In</dt>
            <dd className="font-medium">
              {user.lastSignInAt
                ? formatDistanceToNow(new Date(user.lastSignInAt), { addSuffix: true })
                : 'Never'}
            </dd>
          </div>
          <div>
            <dt className="text-muted-foreground">Email Verified</dt>
            <dd className="font-medium">
              {user.emailConfirmedAt ? 'Yes' : 'No'}
            </dd>
          </div>
          <div>
            <dt className="text-muted-foreground">User ID</dt>
            <dd className="font-mono text-xs">{user.id}</dd>
          </div>
        </dl>
      </CardContent>
    </Card>
  );
}
```

**src/components/admin/users/membership-list.tsx**:
```tsx
import { Badge } from '@/components/ui/badge';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { formatDistanceToNow } from 'date-fns';

interface Membership {
  clubId: string;
  clubName: string;
  clubSlug: string;
  facilityId: string | null;
  facilityName: string | null;
  roles: string[];
  isActive: boolean;
  joinedAt: string;
}

export function MembershipList({ memberships }: { memberships: Membership[] }) {
  if (memberships.length === 0) {
    return (
      <div className="text-center py-8 text-muted-foreground">
        No memberships found
      </div>
    );
  }

  return (
    <Table>
      <TableHeader>
        <TableRow>
          <TableHead>Facility</TableHead>
          <TableHead>Club</TableHead>
          <TableHead>Roles</TableHead>
          <TableHead>Status</TableHead>
          <TableHead>Joined</TableHead>
        </TableRow>
      </TableHeader>
      <TableBody>
        {memberships.map((m) => (
          <TableRow key={m.clubId}>
            <TableCell>{m.facilityName || '-'}</TableCell>
            <TableCell className="font-medium">{m.clubName}</TableCell>
            <TableCell>
              <div className="flex flex-wrap gap-1">
                {m.roles.map((role) => (
                  <Badge key={role} variant="outline" className="text-xs">
                    {role}
                  </Badge>
                ))}
              </div>
            </TableCell>
            <TableCell>
              <Badge variant={m.isActive ? 'default' : 'secondary'}>
                {m.isActive ? 'Active' : 'Inactive'}
              </Badge>
            </TableCell>
            <TableCell className="text-muted-foreground">
              {formatDistanceToNow(new Date(m.joinedAt), { addSuffix: true })}
            </TableCell>
          </TableRow>
        ))}
      </TableBody>
    </Table>
  );
}
```
  </action>
  <verify>
1. /admin/users/new shows create form
2. Form submits and creates user
3. User detail page shows all fields
4. Membership list shows facility, club, roles
  </verify>
  <done>New user page and detail components working</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. /admin/users/new shows create form
3. Creating user sends email and redirects to list
4. /admin/users/[userId] shows full profile
5. Memberships display with facility/club hierarchy
6. Edit mode disables email field
</verification>

<success_criteria>
- /admin/users/new creates user and sends password setup email
- /admin/users/[userId] displays user profile and all memberships
- Edit functionality updates user metadata
- Memberships show facility -> club -> roles hierarchy
- Forms have validation and error handling
</success_criteria>

<output>
After completion, create `.planning/phases/37-user-management/37-04-SUMMARY.md`
</output>
