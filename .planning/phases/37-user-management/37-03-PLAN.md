---
phase: 37-user-management
plan: 03
type: execute
wave: 2
depends_on: ["37-01", "37-02"]
files_modified:
  - src/app/(admin)/admin/users/page.tsx
  - src/app/(admin)/admin/users/loading.tsx
  - src/components/admin/users/user-list-table.tsx
  - src/components/admin/users/user-search.tsx
  - src/components/admin/users/user-actions-dropdown.tsx
autonomous: true

must_haves:
  truths:
    - "Super admin can browse paginated user list in admin panel"
    - "Super admin can search users from the list page"
    - "Super admin can see user email, name, status, and membership count"
    - "Super admin can access user actions (view, deactivate, reset password) from list"
  artifacts:
    - path: "src/app/(admin)/admin/users/page.tsx"
      provides: "User list page with pagination"
      min_lines: 50
    - path: "src/components/admin/users/user-list-table.tsx"
      provides: "Paginated table component"
      exports: ["UserListTable"]
    - path: "src/components/admin/users/user-search.tsx"
      provides: "Search input with debounce"
      exports: ["UserSearch"]
    - path: "src/components/admin/users/user-actions-dropdown.tsx"
      provides: "Actions dropdown menu"
      exports: ["UserActionsDropdown"]
  key_links:
    - from: "src/app/(admin)/admin/users/page.tsx"
      to: "/api/admin/users"
      via: "fetch in server component"
      pattern: "fetch.*api/admin/users"
    - from: "src/components/admin/users/user-list-table.tsx"
      to: "src/components/admin/users/user-actions-dropdown.tsx"
      via: "renders UserActionsDropdown per row"
      pattern: "UserActionsDropdown"
---

<objective>
Create the admin users list page with table, search, and pagination

Purpose: Provides UI for browsing and managing platform users (USER-01, USER-02 UI)
Output: Working admin users list page at /admin/users
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 37 API plans (must be complete)
@.planning/phases/37-user-management/37-01-PLAN.md
@.planning/phases/37-user-management/37-02-PLAN.md

# Admin UI patterns from Phase 36
@src/app/(admin)/layout.tsx
@src/components/admin/admin-sidebar.tsx
@src/components/admin/platform-stats.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create User List Page and Loading State</name>
  <files>
    src/app/(admin)/admin/users/page.tsx
    src/app/(admin)/admin/users/loading.tsx
  </files>
  <action>
Create the admin users list page as a server component with client-side interactivity.

**src/app/(admin)/admin/users/page.tsx**:

1. Server component that receives searchParams (page, search)
2. Fetch users from internal API using fetch with cookies forwarded:
```typescript
import { cookies } from 'next/headers';

export default async function AdminUsersPage({
  searchParams,
}: {
  searchParams: Promise<{ page?: string; search?: string }>;
}) {
  const params = await searchParams;
  const page = parseInt(params.page || '1', 10);
  const search = params.search || '';

  const cookieStore = await cookies();
  const cookieHeader = cookieStore.getAll()
    .map(c => `${c.name}=${c.value}`)
    .join('; ');

  const url = new URL('/api/admin/users', process.env.NEXT_PUBLIC_APP_URL);
  url.searchParams.set('page', String(page));
  if (search) url.searchParams.set('search', search);

  const res = await fetch(url.toString(), {
    headers: { Cookie: cookieHeader },
    cache: 'no-store',
  });

  const data = await res.json();
  // ...render
}
```

3. Layout structure:
```tsx
<div className="space-y-6">
  <div className="flex items-center justify-between">
    <h1 className="text-2xl font-bold">Users</h1>
    <Link href="/admin/users/new">
      <Button>Create User</Button>
    </Link>
  </div>

  <UserSearch defaultValue={search} />

  <UserListTable users={data.users} />

  <Pagination
    page={page}
    hasMore={data.hasMore}
    total={data.total}
    perPage={data.perPage}
  />
</div>
```

4. Import Button, Link from shadcn/ui and next/link

**src/app/(admin)/admin/users/loading.tsx**:
```tsx
import { Skeleton } from '@/components/ui/skeleton';

export default function Loading() {
  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <Skeleton className="h-8 w-32" />
        <Skeleton className="h-10 w-28" />
      </div>
      <Skeleton className="h-10 w-full max-w-md" />
      <div className="space-y-2">
        {Array.from({ length: 10 }).map((_, i) => (
          <Skeleton key={i} className="h-16 w-full" />
        ))}
      </div>
    </div>
  );
}
```
  </action>
  <verify>Visit /admin/users as super admin, verify loading skeleton appears then data loads</verify>
  <done>Admin users page renders with data from API</done>
</task>

<task type="auto">
  <name>Task 2: Create User List Table and Search Components</name>
  <files>
    src/components/admin/users/user-list-table.tsx
    src/components/admin/users/user-search.tsx
  </files>
  <action>
Create the table and search components for the users list.

**src/components/admin/users/user-list-table.tsx**:

1. Client component ("use client") for interactivity
2. Props:
```typescript
interface User {
  id: string;
  email: string;
  displayName: string | null;
  createdAt: string;
  lastSignInAt: string | null;
  isDeactivated: boolean;
  membershipCount: number;
}

interface Props {
  users: User[];
}
```

3. Table structure using shadcn Table components:
- Columns: Email, Name, Status, Memberships, Created, Last Login, Actions
- Status column: Badge showing "Active" (green) or "Deactivated" (red)
- Actions column: UserActionsDropdown component

4. Format dates using Intl.DateTimeFormat or date-fns
5. Show "No users found" if empty array

**src/components/admin/users/user-search.tsx**:

1. Client component with debounced search
2. Use useRouter and useSearchParams from next/navigation
3. Input with search icon, placeholder "Search by email, name, facility, or club..."
4. Debounce 300ms before updating URL params
5. Clear button when search has value

```typescript
'use client';

import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import { useDebouncedCallback } from 'use-debounce';
import { Input } from '@/components/ui/input';
import { Search, X } from 'lucide-react';

export function UserSearch({ defaultValue = '' }: { defaultValue?: string }) {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  const handleSearch = useDebouncedCallback((term: string) => {
    const params = new URLSearchParams(searchParams);
    if (term) {
      params.set('search', term);
      params.delete('page'); // Reset to page 1 on search
    } else {
      params.delete('search');
    }
    router.push(`${pathname}?${params.toString()}`);
  }, 300);

  // ... render input with onChange={e => handleSearch(e.target.value)}
}
```

Note: If use-debounce is not installed, use a simple setTimeout-based debounce or check if it's already in package.json.
  </action>
  <verify>
1. Table displays user data correctly
2. Search input updates URL params after debounce
3. Table shows loading state during search
  </verify>
  <done>User list table and search components working</done>
</task>

<task type="auto">
  <name>Task 3: Create User Actions Dropdown</name>
  <files>src/components/admin/users/user-actions-dropdown.tsx</files>
  <action>
Create dropdown menu with actions for each user row.

1. Client component
2. Props: { user: User, onActionComplete?: () => void }
3. Use shadcn DropdownMenu components
4. Actions:
   - View Details (navigates to /admin/users/[userId])
   - Edit (navigates to /admin/users/[userId]?edit=true or /admin/users/[userId]/edit)
   - Reset Password (calls API, shows toast)
   - Deactivate / Reactivate (calls API, shows toast, refreshes)

5. Implementation for actions that call API:
```typescript
const handleResetPassword = async () => {
  try {
    const res = await fetch(`/api/admin/users/${user.id}/reset-password`, {
      method: 'POST',
    });
    if (!res.ok) throw new Error('Failed to reset password');
    toast.success('Password reset email sent');
  } catch (error) {
    toast.error('Failed to send reset email');
  }
};

const handleDeactivate = async () => {
  try {
    const res = await fetch(`/api/admin/users/${user.id}/deactivate`, {
      method: 'POST',
    });
    if (!res.ok) throw new Error('Failed to deactivate');
    toast.success('User deactivated');
    router.refresh(); // Refresh server component
  } catch (error) {
    toast.error('Failed to deactivate user');
  }
};
```

6. Conditional rendering:
   - Show "Deactivate" for active users
   - Show "Reactivate" for deactivated users
   - Deactivate action should have confirmation dialog

7. Use AlertDialog for destructive actions (deactivate):
```tsx
<AlertDialog>
  <AlertDialogTrigger asChild>
    <DropdownMenuItem onSelect={e => e.preventDefault()}>
      Deactivate
    </DropdownMenuItem>
  </AlertDialogTrigger>
  <AlertDialogContent>
    <AlertDialogHeader>
      <AlertDialogTitle>Deactivate User?</AlertDialogTitle>
      <AlertDialogDescription>
        This will prevent {user.email} from logging in. You can reactivate them later.
      </AlertDialogDescription>
    </AlertDialogHeader>
    <AlertDialogFooter>
      <AlertDialogCancel>Cancel</AlertDialogCancel>
      <AlertDialogAction onClick={handleDeactivate}>Deactivate</AlertDialogAction>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>
```

8. Import toast from sonner (already in project)
  </action>
  <verify>
1. Dropdown opens on click
2. View Details navigates to detail page
3. Reset Password shows success toast
4. Deactivate shows confirmation, then deactivates and refreshes
5. Reactivate works for deactivated users
  </verify>
  <done>User actions dropdown with all operations working</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. /admin/users page loads with user data
3. Search filters users with debounced input
4. Pagination navigates between pages
5. Actions dropdown works for all operations
6. Toasts show success/error feedback
</verification>

<success_criteria>
- Admin users page at /admin/users displays paginated user list
- Search input filters by email/name/facility/club
- Table shows status badges (Active/Deactivated)
- Actions dropdown provides View, Edit, Reset Password, Deactivate/Reactivate
- All actions call correct API endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/37-user-management/37-03-SUMMARY.md`
</output>
