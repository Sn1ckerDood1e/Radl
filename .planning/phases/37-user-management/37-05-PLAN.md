---
phase: 37-user-management
plan: 05
type: execute
wave: 3
depends_on: ["37-01", "37-02", "37-03"]
files_modified:
  - src/app/api/admin/users/bulk/route.ts
  - src/app/(admin)/admin/users/bulk/page.tsx
  - src/components/admin/users/bulk-upload-form.tsx
  - src/hooks/use-admin-csv-parser.ts
autonomous: true

must_haves:
  truths:
    - "Super admin can upload CSV file with user data"
    - "CSV is validated before processing"
    - "Bulk creation shows progress feedback"
    - "Created users receive password setup emails"
    - "Partial failures are reported without blocking successful creations"
  artifacts:
    - path: "src/app/api/admin/users/bulk/route.ts"
      provides: "POST bulk create users"
      exports: ["POST"]
    - path: "src/app/(admin)/admin/users/bulk/page.tsx"
      provides: "Bulk upload page"
      min_lines: 30
    - path: "src/components/admin/users/bulk-upload-form.tsx"
      provides: "CSV upload with preview"
      exports: ["BulkUploadForm"]
    - path: "src/hooks/use-admin-csv-parser.ts"
      provides: "CSV parsing for admin bulk operations"
      exports: ["useAdminCSVParser"]
  key_links:
    - from: "src/components/admin/users/bulk-upload-form.tsx"
      to: "src/hooks/use-admin-csv-parser.ts"
      via: "useAdminCSVParser hook"
      pattern: "useAdminCSVParser"
    - from: "src/components/admin/users/bulk-upload-form.tsx"
      to: "/api/admin/users/bulk"
      via: "POST with parsed data"
      pattern: "fetch.*api/admin/users/bulk"
---

<objective>
Create bulk user creation via CSV upload with progress feedback

Purpose: Enables super admin to create multiple users in one operation (USER-09)
Output: Working bulk upload page at /admin/users/bulk with CSV parsing and progress
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 37 API plans
@.planning/phases/37-user-management/37-01-PLAN.md
@.planning/phases/37-user-management/37-02-PLAN.md

# Existing CSV parser pattern
@src/hooks/use-csv-parser.ts

# Supabase admin client
@src/lib/supabase/admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Admin CSV Parser Hook</name>
  <files>src/hooks/use-admin-csv-parser.ts</files>
  <action>
Create a CSV parser hook for admin bulk user operations.

Based on existing use-csv-parser.ts pattern but for admin user creation:

```typescript
import { useState } from 'react';
import Papa from 'papaparse';

export interface ParsedAdminUser {
  email: string;
  displayName?: string;
  phone?: string;
}

export interface ParseResult {
  valid: ParsedAdminUser[];
  errors: Array<{ row: number; message: string }>;
}

/**
 * CSV parser hook for admin bulk user creation.
 *
 * Expected CSV format:
 * email,name,phone
 * user@example.com,John Smith,+1234567890
 *
 * - email: Required, must be valid email format
 * - name: Optional, maps to displayName
 * - phone: Optional
 */
export function useAdminCSVParser() {
  const [result, setResult] = useState<ParseResult | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const parseFile = (file: File | null) => {
    setError(null);
    setResult(null);

    if (!file) return;

    if (!file.name.endsWith('.csv')) {
      setError('Please upload a CSV file');
      return;
    }

    setIsLoading(true);

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      transformHeader: (header) => header.trim().toLowerCase(),
      complete: (results) => {
        const data = results.data as Record<string, string>[];
        const valid: ParsedAdminUser[] = [];
        const errors: Array<{ row: number; message: string }> = [];

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const seenEmails = new Set<string>();

        for (let i = 0; i < data.length; i++) {
          const row = data[i];
          const rowNum = i + 2; // Account for header row

          // Check required email
          const email = row.email?.trim();
          if (!email) {
            errors.push({ row: rowNum, message: 'Missing email' });
            continue;
          }

          // Validate email format
          if (!emailRegex.test(email)) {
            errors.push({ row: rowNum, message: `Invalid email format: ${email}` });
            continue;
          }

          // Check for duplicates within file
          if (seenEmails.has(email.toLowerCase())) {
            errors.push({ row: rowNum, message: `Duplicate email: ${email}` });
            continue;
          }
          seenEmails.add(email.toLowerCase());

          valid.push({
            email,
            displayName: row.name?.trim() || row.displayname?.trim() || undefined,
            phone: row.phone?.trim() || undefined,
          });
        }

        setResult({ valid, errors });
        setIsLoading(false);
      },
      error: (err) => {
        setError(`Failed to parse CSV: ${err.message}`);
        setIsLoading(false);
      },
    });
  };

  const clear = () => {
    setResult(null);
    setError(null);
  };

  return {
    result,
    isLoading,
    error,
    parseFile,
    clear,
  };
}
```
  </action>
  <verify>Hook parses CSV correctly, validates emails, detects duplicates</verify>
  <done>Admin CSV parser hook with validation</done>
</task>

<task type="auto">
  <name>Task 2: Create Bulk Users API Endpoint</name>
  <files>src/app/api/admin/users/bulk/route.ts</files>
  <action>
Create POST endpoint for bulk user creation (USER-09).

Implementation:
1. Verify super admin via getSuperAdminContext()
2. Parse body: { users: Array<{ email, displayName?, phone? }> }
3. Validate array has at least 1 user, max 100 users per batch
4. Process each user:
   - Check if email exists (skip if exists)
   - Create user via Supabase admin API
   - Send password setup email
   - Track success/failure

5. Response structure:
```typescript
{
  total: number;       // Total users attempted
  created: number;     // Successfully created
  skipped: number;     // Skipped (already exists)
  failed: number;      // Failed with error
  results: Array<{
    email: string;
    status: 'created' | 'skipped' | 'failed';
    error?: string;
    userId?: string;
  }>;
}
```

6. Log admin action once for batch:
   - action: 'ADMIN_USERS_BULK_CREATED' (add to actions.ts)
   - targetType: 'User'
   - metadata: { total, created, skipped, failed }

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getSuperAdminContext } from '@/lib/auth/admin-authorize';
import { getSupabaseAdmin } from '@/lib/supabase/admin';
import { createAdminAuditLogger } from '@/lib/audit/logger';
import { unauthorizedResponse, serverErrorResponse } from '@/lib/errors';

interface BulkUserInput {
  email: string;
  displayName?: string;
  phone?: string;
}

export async function POST(request: NextRequest) {
  try {
    const adminContext = await getSuperAdminContext();
    if (!adminContext) return unauthorizedResponse();

    const body = await request.json();
    const users: BulkUserInput[] = body.users;

    if (!Array.isArray(users) || users.length === 0) {
      return NextResponse.json(
        { error: 'No users provided' },
        { status: 400 }
      );
    }

    if (users.length > 100) {
      return NextResponse.json(
        { error: 'Maximum 100 users per batch' },
        { status: 400 }
      );
    }

    const supabase = getSupabaseAdmin();
    const results: Array<{
      email: string;
      status: 'created' | 'skipped' | 'failed';
      error?: string;
      userId?: string;
    }> = [];

    let created = 0;
    let skipped = 0;
    let failed = 0;

    for (const user of users) {
      try {
        // Check if user exists
        const { data: existing } = await supabase.auth.admin.listUsers({
          page: 1,
          perPage: 1,
        });

        // Search for email in existing users
        const existingUser = existing?.users?.find(
          u => u.email?.toLowerCase() === user.email.toLowerCase()
        );

        if (existingUser) {
          results.push({ email: user.email, status: 'skipped' });
          skipped++;
          continue;
        }

        // Create user
        const { data: newUser, error: createError } = await supabase.auth.admin.createUser({
          email: user.email,
          email_confirm: false,
          user_metadata: {
            display_name: user.displayName || null,
            phone: user.phone || null,
          },
        });

        if (createError) {
          results.push({ email: user.email, status: 'failed', error: createError.message });
          failed++;
          continue;
        }

        // Send invite email
        await supabase.auth.admin.inviteUserByEmail(user.email);

        results.push({ email: user.email, status: 'created', userId: newUser.user?.id });
        created++;
      } catch (err) {
        results.push({
          email: user.email,
          status: 'failed',
          error: err instanceof Error ? err.message : 'Unknown error',
        });
        failed++;
      }
    }

    // Audit log
    const audit = createAdminAuditLogger(request, adminContext.userId);
    await audit.log({
      action: 'ADMIN_USER_CREATED', // Use existing action, will create multiple logs
      targetType: 'User',
      metadata: {
        bulk: true,
        total: users.length,
        created,
        skipped,
        failed,
      },
    });

    return NextResponse.json({
      total: users.length,
      created,
      skipped,
      failed,
      results,
    });
  } catch (error) {
    return serverErrorResponse(error, 'admin/users/bulk:POST');
  }
}
```

Note: The listUsers check should be improved for performance - currently checks page by page. For production, consider building an email lookup cache or using a different approach.
  </action>
  <verify>
Test with curl:
```bash
curl -X POST -H "Cookie: $(cat /tmp/admin-cookie)" -H "Content-Type: application/json" \
  -d '{"users":[{"email":"bulk1@test.com"},{"email":"bulk2@test.com","displayName":"Bulk User"}]}' \
  http://localhost:3000/api/admin/users/bulk
```
Verify response shows created/skipped/failed counts.
  </verify>
  <done>Bulk create API endpoint processes array of users</done>
</task>

<task type="auto">
  <name>Task 3: Create Bulk Upload Page and Form</name>
  <files>
    src/app/(admin)/admin/users/bulk/page.tsx
    src/components/admin/users/bulk-upload-form.tsx
  </files>
  <action>
Create the bulk upload page with CSV preview and progress.

**src/app/(admin)/admin/users/bulk/page.tsx**:
```tsx
import Link from 'next/link';
import { BulkUploadForm } from '@/components/admin/users/bulk-upload-form';

export default function BulkUploadPage() {
  return (
    <div className="space-y-6">
      <div>
        <Link href="/admin/users" className="text-sm text-muted-foreground hover:underline">
          &larr; Back to Users
        </Link>
        <h1 className="text-2xl font-bold mt-2">Bulk Create Users</h1>
        <p className="text-muted-foreground">
          Upload a CSV file to create multiple users at once.
        </p>
      </div>

      <BulkUploadForm />
    </div>
  );
}
```

**src/components/admin/users/bulk-upload-form.tsx**:
```tsx
'use client';

import { useState, useRef } from 'react';
import { useRouter } from 'next/navigation';
import { toast } from 'sonner';
import { Upload, FileSpreadsheet, AlertCircle, CheckCircle, XCircle, Loader2 } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Badge } from '@/components/ui/badge';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Progress } from '@/components/ui/progress';
import { useAdminCSVParser, type ParsedAdminUser } from '@/hooks/use-admin-csv-parser';

interface UploadResult {
  total: number;
  created: number;
  skipped: number;
  failed: number;
  results: Array<{
    email: string;
    status: 'created' | 'skipped' | 'failed';
    error?: string;
  }>;
}

export function BulkUploadForm() {
  const router = useRouter();
  const fileInputRef = useRef<HTMLInputElement>(null);
  const { result, isLoading: isParsing, error: parseError, parseFile, clear } = useAdminCSVParser();
  const [isUploading, setIsUploading] = useState(false);
  const [uploadResult, setUploadResult] = useState<UploadResult | null>(null);

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    setUploadResult(null);
    parseFile(file || null);
  };

  const handleUpload = async () => {
    if (!result?.valid.length) return;

    setIsUploading(true);
    try {
      const res = await fetch('/api/admin/users/bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ users: result.valid }),
      });

      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.error || 'Failed to create users');
      }

      const data: UploadResult = await res.json();
      setUploadResult(data);

      if (data.created > 0) {
        toast.success(`Created ${data.created} user(s)`);
      }
    } catch (error) {
      toast.error(error instanceof Error ? error.message : 'Failed to create users');
    } finally {
      setIsUploading(false);
    }
  };

  const handleReset = () => {
    clear();
    setUploadResult(null);
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };

  return (
    <div className="space-y-6">
      {/* CSV Format Guide */}
      <Card>
        <CardHeader>
          <CardTitle className="text-base">CSV Format</CardTitle>
          <CardDescription>
            Your CSV file should have the following columns
          </CardDescription>
        </CardHeader>
        <CardContent>
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Column</TableHead>
                <TableHead>Required</TableHead>
                <TableHead>Example</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              <TableRow>
                <TableCell className="font-mono">email</TableCell>
                <TableCell><Badge>Required</Badge></TableCell>
                <TableCell>user@example.com</TableCell>
              </TableRow>
              <TableRow>
                <TableCell className="font-mono">name</TableCell>
                <TableCell><Badge variant="outline">Optional</Badge></TableCell>
                <TableCell>John Smith</TableCell>
              </TableRow>
              <TableRow>
                <TableCell className="font-mono">phone</TableCell>
                <TableCell><Badge variant="outline">Optional</Badge></TableCell>
                <TableCell>+1 555-123-4567</TableCell>
              </TableRow>
            </TableBody>
          </Table>
        </CardContent>
      </Card>

      {/* File Upload */}
      <Card>
        <CardHeader>
          <CardTitle className="text-base">Upload CSV</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="flex items-center gap-4">
            <input
              ref={fileInputRef}
              type="file"
              accept=".csv"
              onChange={handleFileChange}
              className="hidden"
              id="csv-upload"
            />
            <Button
              variant="outline"
              onClick={() => fileInputRef.current?.click()}
              disabled={isParsing || isUploading}
            >
              <Upload className="h-4 w-4 mr-2" />
              Choose File
            </Button>
            {result && (
              <Button variant="ghost" onClick={handleReset}>
                Clear
              </Button>
            )}
          </div>

          {parseError && (
            <Alert variant="destructive" className="mt-4">
              <AlertCircle className="h-4 w-4" />
              <AlertDescription>{parseError}</AlertDescription>
            </Alert>
          )}
        </CardContent>
      </Card>

      {/* Parse Results Preview */}
      {result && (
        <Card>
          <CardHeader>
            <CardTitle className="text-base flex items-center gap-2">
              <FileSpreadsheet className="h-5 w-5" />
              Preview ({result.valid.length} valid, {result.errors.length} errors)
            </CardTitle>
          </CardHeader>
          <CardContent>
            {result.errors.length > 0 && (
              <Alert variant="destructive" className="mb-4">
                <AlertCircle className="h-4 w-4" />
                <AlertDescription>
                  <ul className="list-disc list-inside">
                    {result.errors.slice(0, 5).map((err, i) => (
                      <li key={i}>Row {err.row}: {err.message}</li>
                    ))}
                    {result.errors.length > 5 && (
                      <li>...and {result.errors.length - 5} more errors</li>
                    )}
                  </ul>
                </AlertDescription>
              </Alert>
            )}

            {result.valid.length > 0 && (
              <>
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead>Email</TableHead>
                      <TableHead>Name</TableHead>
                      <TableHead>Phone</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {result.valid.slice(0, 10).map((user, i) => (
                      <TableRow key={i}>
                        <TableCell>{user.email}</TableCell>
                        <TableCell>{user.displayName || '-'}</TableCell>
                        <TableCell>{user.phone || '-'}</TableCell>
                      </TableRow>
                    ))}
                    {result.valid.length > 10 && (
                      <TableRow>
                        <TableCell colSpan={3} className="text-center text-muted-foreground">
                          ...and {result.valid.length - 10} more users
                        </TableCell>
                      </TableRow>
                    )}
                  </TableBody>
                </Table>

                <div className="mt-4 flex justify-end">
                  <Button onClick={handleUpload} disabled={isUploading}>
                    {isUploading && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
                    Create {result.valid.length} Users
                  </Button>
                </div>
              </>
            )}
          </CardContent>
        </Card>
      )}

      {/* Upload Results */}
      {uploadResult && (
        <Card>
          <CardHeader>
            <CardTitle className="text-base">Results</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-3 gap-4 mb-4">
              <div className="text-center p-4 bg-green-50 dark:bg-green-950 rounded-lg">
                <CheckCircle className="h-6 w-6 text-green-600 mx-auto mb-2" />
                <div className="text-2xl font-bold text-green-600">{uploadResult.created}</div>
                <div className="text-sm text-muted-foreground">Created</div>
              </div>
              <div className="text-center p-4 bg-yellow-50 dark:bg-yellow-950 rounded-lg">
                <AlertCircle className="h-6 w-6 text-yellow-600 mx-auto mb-2" />
                <div className="text-2xl font-bold text-yellow-600">{uploadResult.skipped}</div>
                <div className="text-sm text-muted-foreground">Skipped</div>
              </div>
              <div className="text-center p-4 bg-red-50 dark:bg-red-950 rounded-lg">
                <XCircle className="h-6 w-6 text-red-600 mx-auto mb-2" />
                <div className="text-2xl font-bold text-red-600">{uploadResult.failed}</div>
                <div className="text-sm text-muted-foreground">Failed</div>
              </div>
            </div>

            {uploadResult.results.some(r => r.status !== 'created') && (
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>Email</TableHead>
                    <TableHead>Status</TableHead>
                    <TableHead>Details</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {uploadResult.results
                    .filter(r => r.status !== 'created')
                    .map((r, i) => (
                      <TableRow key={i}>
                        <TableCell>{r.email}</TableCell>
                        <TableCell>
                          <Badge variant={r.status === 'skipped' ? 'outline' : 'destructive'}>
                            {r.status}
                          </Badge>
                        </TableCell>
                        <TableCell className="text-sm text-muted-foreground">
                          {r.status === 'skipped' ? 'User already exists' : r.error}
                        </TableCell>
                      </TableRow>
                    ))}
                </TableBody>
              </Table>
            )}

            <div className="mt-4 flex justify-end gap-2">
              <Button variant="outline" onClick={handleReset}>
                Upload Another
              </Button>
              <Button onClick={() => router.push('/admin/users')}>
                Back to Users
              </Button>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
```
  </action>
  <verify>
1. Visit /admin/users/bulk
2. Upload a CSV file
3. Preview shows valid users and errors
4. Click Create button
5. Results show created/skipped/failed counts
  </verify>
  <done>Bulk upload page with CSV preview and results display</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. CSV parser validates emails and detects duplicates
3. API creates users in batch with progress
4. UI shows preview before upload
5. Results display success/skip/fail for each user
6. Password emails sent to created users
</verification>

<success_criteria>
- /admin/users/bulk shows CSV upload form
- CSV parsing validates email format and detects duplicates
- Preview shows valid users before submission
- API creates up to 100 users per batch
- Results show which users were created/skipped/failed
- Requirement USER-09 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/37-user-management/37-05-SUMMARY.md`
</output>
