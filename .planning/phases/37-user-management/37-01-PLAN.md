---
phase: 37-user-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/admin/users/route.ts
  - src/app/api/admin/users/[userId]/route.ts
  - src/lib/supabase/admin.ts
autonomous: true

must_haves:
  truths:
    - "Super admin can list all platform users with pagination"
    - "Super admin can search users by email, name, facility, or club"
    - "Super admin can view individual user details with memberships"
    - "Super admin can edit user profile (name, email, phone)"
  artifacts:
    - path: "src/app/api/admin/users/route.ts"
      provides: "GET users list with pagination and search"
      exports: ["GET"]
    - path: "src/app/api/admin/users/[userId]/route.ts"
      provides: "GET user details, PATCH edit user"
      exports: ["GET", "PATCH"]
    - path: "src/lib/supabase/admin.ts"
      provides: "Supabase admin client for user operations"
      exports: ["getSupabaseAdmin"]
  key_links:
    - from: "src/app/api/admin/users/route.ts"
      to: "src/lib/auth/admin-authorize.ts"
      via: "getSuperAdminContext()"
      pattern: "getSuperAdminContext"
    - from: "src/app/api/admin/users/[userId]/route.ts"
      to: "src/lib/supabase/admin.ts"
      via: "getSupabaseAdmin() for auth operations"
      pattern: "getSupabaseAdmin"
---

<objective>
Create core admin user API endpoints for listing, searching, viewing, and editing users

Purpose: Enables super admin to browse and manage all platform users (USER-01, USER-02, USER-04, USER-05)
Output: Working API routes for user CRUD operations with pagination and search
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 36 admin auth infrastructure
@.planning/phases/36-admin-foundation-auth/36-02-SUMMARY.md

# Existing patterns
@src/lib/auth/admin-authorize.ts
@src/lib/audit/logger.ts
@src/lib/errors/index.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase Admin Client</name>
  <files>src/lib/supabase/admin.ts</files>
  <action>
Create a Supabase admin client using the service role key for admin operations.

```typescript
import { createClient } from '@supabase/supabase-js';

/**
 * Get Supabase admin client with service role for admin operations.
 *
 * SECURITY: This client bypasses RLS and has full database access.
 * Only use in admin API routes after verifying super admin status.
 *
 * Used for:
 * - Creating users (bypasses signup flow)
 * - Listing all users (auth.admin.listUsers)
 * - Updating user auth data (email, password reset)
 * - Deactivating/reactivating users (ban_duration)
 */
export function getSupabaseAdmin() {
  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
  const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;

  if (!serviceRoleKey) {
    throw new Error('SUPABASE_SERVICE_ROLE_KEY is not configured');
  }

  return createClient(supabaseUrl, serviceRoleKey, {
    auth: {
      autoRefreshToken: false,
      persistSession: false,
    },
  });
}
```
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>Supabase admin client exported from src/lib/supabase/admin.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create Users List API with Pagination and Search</name>
  <files>src/app/api/admin/users/route.ts</files>
  <action>
Create GET endpoint for listing users with pagination and search (USER-01, USER-02).

Implementation requirements:
1. Verify super admin via getSuperAdminContext()
2. Parse query params: page (default 1), search (optional), per_page (default 25)
3. For search:
   - If search query provided, first get matching user IDs from Supabase auth.admin.listUsers
   - Then query Prisma for ClubMemberships to get facility/club matches
   - Combine and deduplicate user IDs
4. For listing without search:
   - Use Supabase auth.admin.listUsers with pagination (perPage: 25)
5. For each user, fetch:
   - ClubMembership records with club -> facility names
   - Join with Supabase user data (email, created_at, last_sign_in_at, banned_until)
6. Return: { users: [...], total, page, perPage, hasMore }

Search fields (USER-02):
- email: Direct match from Supabase listUsers
- name: Match against user_metadata.display_name from Supabase
- facility: Match via ClubMembership -> Team -> Facility name
- club: Match via ClubMembership -> Team name

Response shape per user:
```typescript
{
  id: string;              // Supabase user ID
  email: string;
  displayName: string | null;  // From user_metadata
  createdAt: string;       // ISO timestamp
  lastSignInAt: string | null;
  isDeactivated: boolean;  // banned_until is set
  membershipCount: number; // Number of club memberships
}
```

Use existing patterns:
- getSuperAdminContext() from admin-authorize.ts
- unauthorizedResponse(), serverErrorResponse() from errors
- createAdminAuditLogger() is NOT needed for reads
  </action>
  <verify>
Test with curl:
```bash
# List first page
curl -H "Cookie: $(cat /tmp/admin-cookie)" http://localhost:3000/api/admin/users

# Search by email
curl -H "Cookie: $(cat /tmp/admin-cookie)" "http://localhost:3000/api/admin/users?search=test@example.com"

# Page 2
curl -H "Cookie: $(cat /tmp/admin-cookie)" "http://localhost:3000/api/admin/users?page=2"
```
Verify 401 for non-admin, 200 with users array for admin.
  </verify>
  <done>GET /api/admin/users returns paginated user list with search support</done>
</task>

<task type="auto">
  <name>Task 3: Create User Detail and Edit API</name>
  <files>src/app/api/admin/users/[userId]/route.ts</files>
  <action>
Create GET and PATCH endpoints for user details and editing (USER-04, USER-05).

**GET /api/admin/users/[userId]** (USER-04):
1. Verify super admin
2. Fetch user from Supabase: auth.admin.getUserById(userId)
3. Fetch all ClubMemberships for this user with club and facility details
4. Return comprehensive user detail:
```typescript
{
  id: string;
  email: string;
  phone: string | null;         // From user_metadata
  displayName: string | null;   // From user_metadata
  createdAt: string;
  lastSignInAt: string | null;
  isDeactivated: boolean;
  emailConfirmedAt: string | null;
  memberships: Array<{
    clubId: string;
    clubName: string;
    clubSlug: string;
    facilityId: string | null;
    facilityName: string | null;
    roles: Role[];
    isActive: boolean;
    joinedAt: string;
  }>;
}
```

**PATCH /api/admin/users/[userId]** (USER-05):
1. Verify super admin
2. Parse body: { displayName?: string, email?: string, phone?: string }
3. Validate email format if provided
4. Get current user state for audit log beforeState
5. Update via Supabase admin API:
   - email: auth.admin.updateUserById(userId, { email })
   - displayName, phone: auth.admin.updateUserById(userId, { user_metadata: { display_name, phone } })
6. Log admin action with createAdminAuditLogger():
   - action: 'ADMIN_USER_UPDATED' (add to actions.ts if missing, or use existing pattern)
   - targetType: 'User'
   - targetId: userId
   - beforeState/afterState with changed fields
7. Return updated user

Note: If 'ADMIN_USER_UPDATED' action doesn't exist, check existing actions in src/lib/audit/actions.ts and use the most appropriate one or add it.
  </action>
  <verify>
Test with curl:
```bash
# Get user detail
curl -H "Cookie: $(cat /tmp/admin-cookie)" http://localhost:3000/api/admin/users/{userId}

# Edit user
curl -X PATCH -H "Cookie: $(cat /tmp/admin-cookie)" -H "Content-Type: application/json" \
  -d '{"displayName":"New Name"}' \
  http://localhost:3000/api/admin/users/{userId}
```
Verify 404 for non-existent user, 200 with full details for existing user.
  </verify>
  <done>GET and PATCH /api/admin/users/[userId] working with audit logging</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Users list API returns paginated results with 25 per page default
3. Search filters users by email, name, facility, or club name
4. User detail API returns full membership information
5. User edit API updates user_metadata and logs to audit log
6. All endpoints return 401 for non-admin users
</verification>

<success_criteria>
- GET /api/admin/users returns { users, total, page, perPage, hasMore }
- GET /api/admin/users?search=X filters results across email/name/facility/club
- GET /api/admin/users/[userId] returns user with all memberships
- PATCH /api/admin/users/[userId] updates user and logs to audit
- Requirements USER-01, USER-02, USER-04, USER-05 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/37-user-management/37-01-SUMMARY.md`
</output>
