---
phase: 13-facility-auth-integration
plan: 05
type: execute
wave: 4
depends_on: ["13-01", "13-02", "13-03", "13-04"]
files_modified:
  - src/app/(dashboard)/layout.tsx
  - src/components/layout/dashboard-header.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard layout wraps children in AbilityProvider with correct UserContext"
    - "UserContext includes facilityId, clubId, roles, and viewMode"
    - "Header displays ContextSwitcher instead of legacy ClubSwitcher"
    - "User with no valid context redirects to onboarding"
  artifacts:
    - path: "src/app/(dashboard)/layout.tsx"
      provides: "Dashboard layout with AbilityProvider integration"
    - path: "src/components/layout/dashboard-header.tsx"
      provides: "Header using ContextSwitcher"
  key_links:
    - from: "src/app/(dashboard)/layout.tsx"
      to: "src/components/permissions/ability-provider.tsx"
      via: "AbilityProvider wrapper"
      pattern: "<AbilityProvider"
    - from: "src/app/(dashboard)/layout.tsx"
      to: "src/lib/auth/claims.ts"
      via: "getClaimsForApiRoute call"
      pattern: "getClaimsForApiRoute"
    - from: "src/components/layout/dashboard-header.tsx"
      to: "src/components/layout/context-switcher.tsx"
      via: "ContextSwitcher usage"
      pattern: "<ContextSwitcher"
---

<objective>
Wire AbilityProvider and ContextSwitcher into dashboard layout.

Purpose: Every dashboard page gets CASL abilities from context. Header shows unified context switcher. Invalid context redirects to onboarding.

Output: Updated dashboard layout with permissions and context switching integrated.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/13-facility-auth-integration/13-CONTEXT.md
@.planning/phases/13-facility-auth-integration/13-RESEARCH.md
@.planning/phases/13-facility-auth-integration/13-01-SUMMARY.md
@.planning/phases/13-facility-auth-integration/13-02-SUMMARY.md
@.planning/phases/13-facility-auth-integration/13-03-SUMMARY.md
@.planning/phases/13-facility-auth-integration/13-04-SUMMARY.md

@src/app/(dashboard)/layout.tsx
@src/components/layout/dashboard-header.tsx
@src/components/permissions/ability-provider.tsx
@src/lib/permissions/ability.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update dashboard layout with AbilityProvider</name>
  <files>src/app/(dashboard)/layout.tsx</files>
  <action>
Update the dashboard layout to:

1. Import AbilityProvider and getClaimsForApiRoute:
```typescript
import { AbilityProvider } from '@/components/permissions/ability-provider';
import { getClaimsForApiRoute } from '@/lib/auth/claims';
import type { UserContext } from '@/lib/permissions/ability';
```

2. Replace existing claims/team logic with new claims helper:
```typescript
// Get validated claims with viewMode
const { user, facilityId, clubId, roles, viewMode, error } = await getClaimsForApiRoute();

if (error || !user) {
  redirect('/login');
}

// Check if user has valid context
if (!clubId && !facilityId) {
  // No memberships - redirect to onboarding/club selection
  redirect('/onboarding');
}
```

3. Construct UserContext for AbilityProvider:
```typescript
const userContext: UserContext = {
  userId: user.id,
  facilityId: facilityId ?? undefined,
  clubId: clubId ?? '',  // Empty string for facility-only view
  roles: roles as UserContext['roles'],
  viewMode: viewMode ?? 'club',  // Default to club for legacy
};
```

4. Wrap children in AbilityProvider:
```typescript
return (
  <AbilityProvider user={userContext}>
    <TeamColorProvider colors={teamColors}>
      {/* ... rest of layout ... */}
    </TeamColorProvider>
  </AbilityProvider>
);
```

5. Keep existing team color logic but derive from clubId:
```typescript
// Get team colors from current club
let teamColors = { primaryColor: '#10b981', secondaryColor: '#6ee7b7' };
if (clubId) {
  const team = await prisma.team.findUnique({
    where: { id: clubId },
    select: { primaryColor: true, secondaryColor: true },
  });
  if (team) {
    teamColors = { primaryColor: team.primaryColor, secondaryColor: team.secondaryColor };
  }
}
```

6. Fetch available contexts for header (SSR hydration):
```typescript
// Get contexts for header switcher
const contextResponse = await fetch(`${process.env.NEXT_PUBLIC_APP_URL}/api/context/available`, {
  headers: { Cookie: request.headers.get('cookie') || '' },
  cache: 'no-store',
});
const contexts = contextResponse.ok ? await contextResponse.json() : null;
```

Alternative to fetch (simpler): Inline the context query since we're server-side:
```typescript
const facilityMemberships = await prisma.facilityMembership.findMany({
  where: { userId: user.id, isActive: true },
  include: { facility: { select: { id: true, name: true, slug: true } } },
});
const clubMemberships = await prisma.clubMembership.findMany({
  where: { userId: user.id, isActive: true },
  include: { club: { select: { id: true, name: true, slug: true, logoUrl: true, primaryColor: true, facilityId: true } } },
});

// Build contexts object for header
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
grep shows AbilityProvider: `grep -n "AbilityProvider" src/app/(dashboard)/layout.tsx`
  </verify>
  <done>
Dashboard layout:
- Wraps children in AbilityProvider with UserContext
- Redirects to onboarding if no valid context
- Passes contexts to header for switcher
  </done>
</task>

<task type="auto">
  <name>Task 2: Update dashboard header to use ContextSwitcher</name>
  <files>src/components/layout/dashboard-header.tsx</files>
  <action>
Update DashboardHeader to use new ContextSwitcher:

1. Update imports:
```typescript
import { ContextSwitcher } from './context-switcher';
// Remove or keep ClubSwitcher import for fallback
```

2. Update props interface:
```typescript
interface DashboardHeaderProps {
  team: Team | null;  // Keep for backward compatibility
  contexts?: AvailableContextsResponse;  // New: from layout
}

// Add type for contexts (or import from context-switcher)
interface AvailableContextsResponse {
  facility?: {
    id: string;
    name: string;
    slug: string;
    isFacilityAdmin: boolean;
  };
  clubs: Array<{
    id: string;
    name: string;
    slug: string;
    logoUrl: string | null;
    primaryColor: string;
    roles: string[];
  }>;
  currentContext: {
    viewMode: 'facility' | 'club' | null;
    facilityId: string | null;
    clubId: string | null;
  };
}
```

3. Replace ClubSwitcher with ContextSwitcher in render:
```typescript
{/* Context Switcher (replaces ClubSwitcher and legacy team display) */}
{contexts ? (
  <ContextSwitcher initialContexts={contexts} />
) : team ? (
  // Fallback to legacy team display for backward compat
  <div className="flex items-center gap-2">
    {/* ... existing team display ... */}
  </div>
) : null}
```

4. Update currentSlug derivation for links:
```typescript
const currentSlug = contexts?.currentContext.viewMode === 'facility'
  ? contexts.facility?.slug
  : contexts?.clubs.find(c => c.id === contexts.currentContext.clubId)?.slug
    ?? team?.slug;
```

5. Remove clubs and currentClubId props (replaced by contexts).
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
grep shows ContextSwitcher: `grep -n "ContextSwitcher" src/components/layout/dashboard-header.tsx`
  </verify>
  <done>
Dashboard header:
- Uses ContextSwitcher with SSR-hydrated contexts
- Falls back to legacy team display if no contexts
- Correctly derives currentSlug for navigation links
  </done>
</task>

<task type="auto">
  <name>Task 3: Create onboarding redirect page</name>
  <files>src/app/(auth)/onboarding/page.tsx</files>
  <action>
Create simple onboarding page at `src/app/(auth)/onboarding/page.tsx`:

```typescript
import Link from 'next/link';

export default function OnboardingPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-[var(--background)]">
      <div className="max-w-md w-full p-8 bg-[var(--surface-1)] rounded-lg border border-[var(--border)]">
        <h1 className="text-2xl font-bold text-[var(--text-primary)] mb-4">
          Welcome to Radl
        </h1>
        <p className="text-[var(--text-secondary)] mb-6">
          You're not currently a member of any clubs. Please contact your club administrator to receive an invitation, or create a new club.
        </p>
        <div className="flex flex-col gap-3">
          <Link
            href="/clubs/join"
            className="w-full py-2 px-4 bg-[var(--accent)] text-white rounded-lg text-center font-medium hover:opacity-90 transition-opacity"
          >
            Join a Club
          </Link>
          <Link
            href="/clubs/create"
            className="w-full py-2 px-4 border border-[var(--border)] text-[var(--text-primary)] rounded-lg text-center font-medium hover:bg-[var(--surface-2)] transition-colors"
          >
            Create a Club
          </Link>
        </div>
      </div>
    </div>
  );
}
```

This page catches users with no active memberships.
  </action>
  <verify>
File exists: `ls -la src/app/(auth)/onboarding/page.tsx`
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
Onboarding page exists for users with no club memberships:
- Clear messaging about next steps
- Links to join or create club
  </done>
</task>

</tasks>

<verification>
- [ ] Dashboard layout imports and uses AbilityProvider
- [ ] UserContext constructed with facilityId, clubId, roles, viewMode
- [ ] No-membership users redirect to /onboarding
- [ ] Header uses ContextSwitcher with SSR contexts
- [ ] Onboarding page created
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
Dashboard fully integrated with facility auth:
1. Every page has CASL abilities via context
2. Header shows context switcher for all users
3. Invalid/missing context gracefully handled
4. Backward compatibility with legacy team-only mode
</success_criteria>

<output>
After completion, create `.planning/phases/13-facility-auth-integration/13-05-SUMMARY.md`
</output>
