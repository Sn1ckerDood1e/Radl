---
phase: 13-facility-auth-integration
plan: 04
type: execute
wave: 3
depends_on: ["13-01", "13-02"]
files_modified:
  - src/components/layout/context-switcher.tsx
  - src/app/api/context/available/route.ts
autonomous: true

must_haves:
  truths:
    - "Facility admin sees facility at top of dropdown, then clubs underneath"
    - "Switching to facility view calls /api/context/switch with facilityId only"
    - "Switching to club view calls /api/context/switch with facilityId + clubId"
    - "JWT session refreshed after context switch"
    - "Router cache invalidated after switch"
  artifacts:
    - path: "src/components/layout/context-switcher.tsx"
      provides: "Unified context switcher supporting facility and club views"
      exports: ["ContextSwitcher"]
    - path: "src/app/api/context/available/route.ts"
      provides: "API returning user's available contexts"
      exports: ["GET"]
  key_links:
    - from: "src/components/layout/context-switcher.tsx"
      to: "/api/context/switch"
      via: "fetch POST call"
      pattern: "fetch.*api/context/switch"
    - from: "src/components/layout/context-switcher.tsx"
      to: "supabase.auth.refreshSession"
      via: "JWT refresh after switch"
      pattern: "refreshSession"
---

<objective>
Create context switcher UI component that supports both facility-level and club-level views.

Purpose: Facility admins need to switch between facility overview and individual club views. The dropdown shows facility at top (for facility admins) with clubs grouped underneath.

Output: ContextSwitcher component and API endpoint for available contexts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/13-facility-auth-integration/13-CONTEXT.md
@.planning/phases/13-facility-auth-integration/13-RESEARCH.md
@.planning/phases/13-facility-auth-integration/13-01-SUMMARY.md
@.planning/phases/13-facility-auth-integration/13-02-SUMMARY.md

@src/components/layout/club-switcher.tsx
@src/app/api/clubs/switch/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create available contexts API</name>
  <files>src/app/api/context/available/route.ts</files>
  <action>
Create API endpoint at `src/app/api/context/available/route.ts`:

**GET /api/context/available**

Returns all contexts available to the current user:

```typescript
interface AvailableContextsResponse {
  facility?: {
    id: string;
    name: string;
    slug: string;
    isFacilityAdmin: boolean;  // Can user view at facility level?
  };
  clubs: Array<{
    id: string;
    name: string;
    slug: string;
    logoUrl: string | null;
    primaryColor: string;
    roles: string[];
  }>;
  currentContext: {
    viewMode: 'facility' | 'club' | null;
    facilityId: string | null;
    clubId: string | null;
  };
}
```

**Logic:**

1. Get claims via getClaimsForApiRoute()
2. Fetch user's ClubMemberships with club and club.facility relations
3. Group by facility:
   - If user belongs to clubs in same facility, show that facility
   - Check if user has FACILITY_ADMIN via FacilityMembership
4. Return structured response with current context from claims

For facility admin detection:
```typescript
const facilityMembership = await prisma.facilityMembership.findFirst({
  where: {
    facilityId: facility.id,
    userId: user.id,
    isActive: true,
    roles: { has: 'FACILITY_ADMIN' },
  },
});
const isFacilityAdmin = !!facilityMembership;
```

Import helpers and prisma as needed.
  </action>
  <verify>
Endpoint exists: `ls -la src/app/api/context/available/route.ts`
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
GET /api/context/available returns:
- Facility info with isFacilityAdmin flag
- List of clubs with roles
- Current context (viewMode, facilityId, clubId)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ContextSwitcher component</name>
  <files>src/components/layout/context-switcher.tsx</files>
  <action>
Create new component at `src/components/layout/context-switcher.tsx`:

**Props interface:**
```typescript
interface ContextSwitcherProps {
  initialContexts?: AvailableContextsResponse;  // SSR hydration
}
```

**Component structure:**

1. State: contexts data, isOpen, isSwitching
2. useEffect: Fetch from /api/context/available if not hydrated
3. Derive current display from contexts.currentContext

**Dropdown rendering:**

If user has facility (contexts.facility exists):
- Show current context name (facility name or club name)
- Dropdown structure:
  ```
  [Facility Name] (Facility View)   <- Only if isFacilityAdmin
  ────────────────────────────────
  [Club 1 Name]                     <- Club options
  [Club 2 Name]
  ```
- Separator between facility and clubs (if facility admin)
- Club options show roles badges like existing club-switcher

If no facility (legacy single-club):
- Behave like existing club-switcher (simple club list)

**Switch handler:**
```typescript
async function handleSwitch(type: 'facility' | 'club', clubId?: string) {
  setIsSwitching(true);
  try {
    const body = type === 'facility'
      ? { facilityId: contexts.facility.id }
      : { facilityId: contexts.facility.id, clubId };

    const response = await fetch('/api/context/switch', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });

    if (!response.ok) throw new Error('Switch failed');

    // Refresh JWT to update claims
    const supabase = createClient();
    await supabase.auth.refreshSession();

    // Navigate and invalidate cache
    const data = await response.json();
    const newPath = data.viewMode === 'facility'
      ? `/facility/${contexts.facility.slug}`
      : `/${data.club.slug}`;

    router.push(newPath);
    router.refresh();
  } catch (error) {
    console.error('Context switch failed:', error);
  } finally {
    setIsSwitching(false);
  }
}
```

**Styling:**
- Match existing club-switcher styles (dark theme, var(--surface-*), var(--text-*))
- Facility option styled distinctly (perhaps with icon or different background)
- Current selection has checkmark
- Loading state during switch

Import createClient from '@/lib/supabase/client' for browser-side Supabase.
  </action>
  <verify>
File exists: `ls -la src/components/layout/context-switcher.tsx`
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
ContextSwitcher component:
- Shows facility option for FACILITY_ADMIN users
- Shows club options for all users
- Handles context switch with JWT refresh
- Invalidates router cache after switch
  </done>
</task>

</tasks>

<verification>
- [ ] /api/context/available endpoint returns facility, clubs, currentContext
- [ ] ContextSwitcher renders facility option when isFacilityAdmin
- [ ] Switching calls /api/context/switch with correct payload
- [ ] JWT refreshSession called after successful switch
- [ ] router.refresh() called to invalidate cache
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
Context switcher UI complete:
1. Facility admins see facility at top of dropdown
2. All users see their clubs
3. Switch triggers API -> JWT refresh -> cache invalidation -> navigation
4. Current context clearly indicated
</success_criteria>

<output>
After completion, create `.planning/phases/13-facility-auth-integration/13-04-SUMMARY.md`
</output>
