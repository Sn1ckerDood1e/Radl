---
phase: 13-facility-auth-integration
plan: 06
type: execute
wave: 4
depends_on: ["13-05"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Context switching works end-to-end (facility view and club view)"
    - "CASL abilities correctly scope permissions based on viewMode"
    - "Invalid cookie recovery happens transparently"
    - "JWT claims update after context switch"
  artifacts: []
  key_links: []
---

<objective>
End-to-end verification of facility auth integration.

Purpose: Confirm all components work together: context switching, permission scoping, cache invalidation, and fallback handling.

Output: Verified facility auth flow ready for Phase 17 (Facility UI).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/13-facility-auth-integration/13-CONTEXT.md
@.planning/phases/13-facility-auth-integration/13-RESEARCH.md
@.planning/phases/13-facility-auth-integration/13-01-SUMMARY.md
@.planning/phases/13-facility-auth-integration/13-02-SUMMARY.md
@.planning/phases/13-facility-auth-integration/13-03-SUMMARY.md
@.planning/phases/13-facility-auth-integration/13-04-SUMMARY.md
@.planning/phases/13-facility-auth-integration/13-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify TypeScript compilation</name>
  <files></files>
  <action>
Run full TypeScript check to ensure no type errors:

```bash
npx tsc --noEmit
```

Check for any errors in:
- src/lib/permissions/ability.ts (UserContext, defineAbilityFor)
- src/lib/auth/claims.ts (ClaimsResult, viewMode)
- src/lib/auth/context-validator.ts (validateAndRecoverContext)
- src/app/api/context/switch/route.ts (POST handler)
- src/app/api/context/available/route.ts (GET handler)
- src/components/layout/context-switcher.tsx (ContextSwitcher)
- src/app/(dashboard)/layout.tsx (AbilityProvider integration)
  </action>
  <verify>Exit code 0 from tsc --noEmit</verify>
  <done>TypeScript compilation passes with no errors</done>
</task>

<task type="auto">
  <name>Task 2: Verify API endpoints respond</name>
  <files></files>
  <action>
Start dev server and test API endpoints:

```bash
# Start server if not running
npm run dev &

# Wait for server
sleep 5

# Test available contexts endpoint (should return 401 without auth)
curl -s http://localhost:3000/api/context/available | jq .

# Test switch endpoint (should return 401 without auth)
curl -s -X POST http://localhost:3000/api/context/switch \
  -H "Content-Type: application/json" \
  -d '{"facilityId":"test"}' | jq .
```

Verify:
- /api/context/available returns JSON (401 unauthorized is expected without auth)
- /api/context/switch returns JSON (401 unauthorized is expected without auth)
- No 500 errors (indicates code crashes)
  </action>
  <verify>Both endpoints return valid JSON responses (401 or success)</verify>
  <done>API endpoints functional and responding to requests</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete facility auth integration:
- Context switching between facility and club views
- CASL permissions scoped by viewMode
- Context switcher UI in header
- Invalid cookie auto-recovery
- JWT session refresh on switch
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Login as a user with FACILITY_ADMIN role (or create test data)
3. Verify context switcher appears in header
4. If facility admin:
   - Click dropdown, verify "Facility View" option appears at top
   - Switch to facility view, verify URL changes to /facility/[slug]
   - Switch to a club, verify URL changes to /[club-slug]
   - Verify no stale data (practice list should update)
5. Test invalid cookie recovery:
   - Open browser dev tools > Application > Cookies
   - Manually change rowops_current_club to invalid UUID
   - Refresh page
   - Verify you land in valid context (no error page)
6. Verify permissions:
   - In facility view: Edit buttons should be hidden for practices/lineups
   - In club view (as non-COACH): Edit buttons should be hidden
   - In club view (as COACH): Edit buttons should appear
  </how-to-verify>
  <resume-signal>Type "verified" if all checks pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
- [ ] TypeScript compiles without errors
- [ ] API endpoints respond (no 500 errors)
- [ ] Context switcher visible in header
- [ ] Facility admin can switch to facility view
- [ ] Club switching works with cache invalidation
- [ ] Invalid cookie auto-recovers
- [ ] CASL permissions hide unavailable actions
</verification>

<success_criteria>
Phase 13 complete when:
1. All automated checks pass
2. Manual verification confirms switching flow works
3. Permissions correctly scope based on viewMode
4. No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/13-facility-auth-integration/13-06-SUMMARY.md`
</output>
