---
phase: 13-facility-auth-integration
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/app/api/context/switch/route.ts
  - src/lib/auth/claims.ts
autonomous: true

must_haves:
  truths:
    - "User can switch to facility-level view (facilityId set, clubId cleared)"
    - "User can switch to club view within their facility"
    - "API verifies membership before allowing switch"
    - "Cookie update happens atomically with response"
  artifacts:
    - path: "src/app/api/context/switch/route.ts"
      provides: "Unified context switch endpoint"
      exports: ["POST"]
    - path: "src/lib/auth/claims.ts"
      provides: "Updated getClaimsForApiRoute with viewMode derivation"
      exports: ["getClaimsForApiRoute", "ClaimsResult"]
  key_links:
    - from: "src/app/api/context/switch/route.ts"
      to: "src/lib/auth/facility-context.ts"
      via: "Cookie setters"
      pattern: "setCurrentFacilityId|setCurrentClubId|clearCurrentClubId"
    - from: "src/lib/auth/claims.ts"
      to: "src/lib/permissions/ability.ts"
      via: "UserContext derivation"
      pattern: "viewMode.*facility.*club"
  notes:
    - "SC-1 (JWT claims include facility_id/club_id): Already satisfied by Phase 12's custom_access_token_hook at supabase/migrations/00006_facility_access_token_hook.sql - injects facility_id, club_id, and user_roles into JWT claims"
---

<objective>
Create unified context switch API and update claims helper to derive viewMode.

Purpose: Single API endpoint for all context switches (facility view, club view) with proper membership verification. Claims helper computes viewMode from cookie state for ability factory.

Output: POST /api/context/switch endpoint and updated getClaimsForApiRoute with viewMode.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/13-facility-auth-integration/13-CONTEXT.md
@.planning/phases/13-facility-auth-integration/13-RESEARCH.md
@.planning/phases/13-facility-auth-integration/13-01-SUMMARY.md

@src/app/api/clubs/switch/route.ts
@src/lib/auth/claims.ts
@src/lib/auth/club-context.ts
@src/lib/auth/facility-context.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unified context switch API</name>
  <files>src/app/api/context/switch/route.ts</files>
  <action>
Create new API route at `src/app/api/context/switch/route.ts`:

**Request body:**
```typescript
interface SwitchRequest {
  facilityId: string;
  clubId?: string;  // Omit for facility-level view
}
```

**Logic:**

1. Authenticate user via getClaimsForApiRoute()
2. Validate request body (facilityId required, clubId optional)

3. If ONLY facilityId provided (facility-level view):
   - Verify user has FacilityMembership with isActive=true
   - Verify user has FACILITY_ADMIN role in that membership
   - Set facility cookie via setCurrentFacilityId(facilityId)
   - Clear club cookie via clearCurrentClubId()
   - Return { success: true, viewMode: 'facility', facility: { id, name, slug } }

4. If BOTH facilityId and clubId provided (club view):
   - Verify ClubMembership with isActive=true for that clubId
   - Verify club belongs to the specified facility (club.facilityId === facilityId)
   - Set facility cookie via setCurrentFacilityId(facilityId)
   - Set club cookie via setCurrentClubId(clubId)
   - Return { success: true, viewMode: 'club', club: { id, name, slug }, roles: membership.roles }

5. Return 403 if membership verification fails
6. Return 400 if request validation fails

Import from existing helpers:
- getClaimsForApiRoute from '@/lib/auth/claims'
- setCurrentFacilityId, clearCurrentFacilityId from '@/lib/auth/facility-context'
- setCurrentClubId, clearCurrentClubId from '@/lib/auth/club-context'
- prisma from '@/lib/prisma'
- unauthorizedResponse, forbiddenResponse, serverErrorResponse from '@/lib/errors'
  </action>
  <verify>
Endpoint exists: `ls -la src/app/api/context/switch/route.ts`
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
POST /api/context/switch endpoint handles:
- Facility-level switch (facilityId only)
- Club switch (facilityId + clubId)
- Membership verification for both cases
  </done>
</task>

<task type="auto">
  <name>Task 2: Update getClaimsForApiRoute with viewMode derivation</name>
  <files>src/lib/auth/claims.ts</files>
  <action>
Update ClaimsResult interface to include viewMode:

```typescript
export type ClaimsResult = {
  user: User | null;
  claims: CustomJwtPayload | null;
  facilityId: string | null;
  clubId: string | null;
  roles: string[];
  viewMode: 'facility' | 'club' | null;  // Add this
  error: string | null;
};
```

Update getClaimsForApiRoute to compute viewMode:

```typescript
// Derive viewMode from cookie state
let viewMode: 'facility' | 'club' | null = null;

if (facilityId && !clubId) {
  // Facility cookie set but no club - facility-level view
  viewMode = 'facility';
} else if (facilityId && clubId) {
  // Both set - club view within facility
  viewMode = 'club';
} else if (clubId) {
  // Only club set (legacy path) - treat as club view
  viewMode = 'club';
}
// null viewMode = no facility context (legacy team-only)
```

Return viewMode in the result object.

This viewMode will be used by layouts to construct UserContext for ability factory.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
grep shows viewMode logic: `grep -n "viewMode" src/lib/auth/claims.ts`
  </verify>
  <done>
getClaimsForApiRoute returns viewMode derived from cookie state:
- 'facility' when only facilityId cookie set
- 'club' when both facilityId and clubId cookies set
- null when no facility context
  </done>
</task>

</tasks>

<verification>
- [ ] API route created at src/app/api/context/switch/route.ts
- [ ] POST handler validates facilityId (required) and clubId (optional)
- [ ] Membership verification for facility-level and club-level switches
- [ ] ClaimsResult includes viewMode field
- [ ] getClaimsForApiRoute computes viewMode from cookies
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
Context switch infrastructure complete:
1. Single API endpoint handles all context switches
2. Membership verified before allowing switch
3. Cookies updated atomically
4. Claims helper provides viewMode for ability factory
</success_criteria>

<output>
After completion, create `.planning/phases/13-facility-auth-integration/13-02-SUMMARY.md`
</output>
