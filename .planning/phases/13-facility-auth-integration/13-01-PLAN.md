---
phase: 13-facility-auth-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/permissions/ability.ts
  - src/lib/permissions/subjects.ts
  - src/components/permissions/ability-provider.tsx
autonomous: true

must_haves:
  truths:
    - "FACILITY_ADMIN in facility viewMode has read access to all clubs' data"
    - "FACILITY_ADMIN in club viewMode has read-only access to that club only"
    - "FACILITY_ADMIN cannot create/update lineups or practices (no-inheritance RBAC)"
    - "viewMode determines permission scope for FACILITY_ADMIN"
  artifacts:
    - path: "src/lib/permissions/ability.ts"
      provides: "Extended defineAbilityFor with viewMode support"
      exports: ["defineAbilityFor", "UserContext", "AppAbility"]
    - path: "src/components/permissions/ability-provider.tsx"
      provides: "AbilityProvider accepting extended UserContext"
  key_links:
    - from: "src/lib/permissions/ability.ts"
      to: "src/components/permissions/ability-provider.tsx"
      via: "UserContext type import"
      pattern: "import.*UserContext.*ability"
---

<objective>
Update CASL ability factory to support facility hierarchy with viewMode-based permission scoping.

Purpose: Foundation for facility admin read-only drill-down pattern. FACILITY_ADMIN permissions differ based on whether they're viewing at facility level (broad read) or club level (scoped read-only).

Output: Extended UserContext type and defineAbilityFor function that handles viewMode.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/13-facility-auth-integration/13-CONTEXT.md
@.planning/phases/13-facility-auth-integration/13-RESEARCH.md

@src/lib/permissions/ability.ts
@src/lib/permissions/subjects.ts
@src/components/permissions/ability-provider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend UserContext with facility fields</name>
  <files>src/lib/permissions/ability.ts</files>
  <action>
Update the UserContext interface to include:
- `facilityId?: string` - Current facility ID (optional for backward compat)
- `viewMode: 'facility' | 'club' | null` - Determines permission scope

Keep all existing fields (userId, clubId, roles, linkedAthleteIds).

Add JSDoc explaining viewMode semantics:
- 'facility': FACILITY_ADMIN viewing at facility level (broad read)
- 'club': FACILITY_ADMIN drilling into specific club (scoped read-only)
- null: No facility context (legacy team-only mode)
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>UserContext includes facilityId and viewMode fields with JSDoc</done>
</task>

<task type="auto">
  <name>Task 2: Update defineAbilityFor with viewMode logic</name>
  <files>src/lib/permissions/ability.ts</files>
  <action>
Extend the FACILITY_ADMIN permission block to check viewMode:

**viewMode === 'facility' (facility-level view):**
- `can('read', 'Team')` - All teams in facility (no filter)
- `can('read', 'Practice')` - All practices in facility
- `can('read', 'Lineup')` - All lineups in facility
- `can('read', 'Equipment')` - All equipment (facility + club owned)
- `can('read', 'AthleteProfile')` - All athletes in facility
- `can('read', 'Season')` - All seasons
- `can('read', 'Regatta')` - All regattas
- `can('read', 'Entry')` - All entries
- `can('manage', 'Facility', { id: user.facilityId })` - Can edit own facility profile
- `can('view-audit-log', 'AuditLog')` - All audit logs
- Keep existing: assign-role, export-data, manage-api-keys, invite/remove-member

**viewMode === 'club' (club drill-down):**
- `can('read', 'Team', { id: user.clubId })` - Specific club only
- `can('read', 'Practice', { teamId: user.clubId })` - Club's practices
- `can('read', 'Lineup')` - Club's lineups (filtered server-side)
- `can('read', 'Equipment', { teamId: user.clubId })` - Club's equipment
- `can('read', 'AthleteProfile')` - View roster (filtered server-side)
- `can('read', 'Season', { teamId: user.clubId })` - Club's seasons
- `can('read', 'Regatta', { teamId: user.clubId })` - Club's regattas
- `can('read', 'Entry')` - Entries (filtered server-side)
- `can('view-audit-log', 'AuditLog')` - Audit logs (filtered server-side)
- NO manage/create/update permissions (read-only drill-down)
- NO assign-role, invite/remove-member in club drill-down

**No viewMode (legacy/null):** Keep current FACILITY_ADMIN behavior unchanged for backward compat.

IMPORTANT: No-inheritance RBAC - FACILITY_ADMIN cannot create lineups/practices even in facility view. Only read permissions.
  </action>
  <verify>
Run: `npx tsc --noEmit`
Verify ability conditions by checking output of `grep -n "viewMode" src/lib/permissions/ability.ts`
  </verify>
  <done>
defineAbilityFor handles viewMode:
- 'facility': broad read + facility management
- 'club': scoped read-only
- null/undefined: legacy behavior preserved
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Facility subject to CASL subjects</name>
  <files>src/lib/permissions/subjects.ts</files>
  <action>
Add 'Facility' to the AppSubjects type union if not already present.

Check existing subjects list and add:
```typescript
| 'Facility'
```

This enables `can('manage', 'Facility')` checks in ability factory.
  </action>
  <verify>`grep -n "Facility" src/lib/permissions/subjects.ts` shows Facility in type</verify>
  <done>Facility subject available for CASL ability checks</done>
</task>

</tasks>

<verification>
- [ ] TypeScript compiles: `npx tsc --noEmit`
- [ ] UserContext has facilityId and viewMode fields
- [ ] defineAbilityFor has viewMode conditional logic for FACILITY_ADMIN
- [ ] Facility subject added to subjects.ts
- [ ] Existing roles (CLUB_ADMIN, COACH, ATHLETE, PARENT) unchanged
</verification>

<success_criteria>
CASL ability factory supports facility hierarchy:
1. UserContext accepts facilityId and viewMode
2. FACILITY_ADMIN permissions vary by viewMode
3. No breaking changes to existing roles
4. TypeScript types remain sound
</success_criteria>

<output>
After completion, create `.planning/phases/13-facility-auth-integration/13-01-SUMMARY.md`
</output>
