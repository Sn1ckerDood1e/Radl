---
phase: 40-audit-log-viewer-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/admin/audit-logs/route.ts
  - src/app/api/admin/audit-logs/export/route.ts
  - src/app/(admin)/admin/audit/page.tsx
  - src/app/(admin)/admin/audit/loading.tsx
  - src/components/admin/audit/audit-log-table.tsx
  - src/components/admin/audit/audit-filters.tsx
  - src/components/admin/audit/state-diff-display.tsx
  - src/components/admin/audit/export-audit-button.tsx
autonomous: true

must_haves:
  truths:
    - "Super admin can browse audit log with pagination"
    - "Super admin can filter by action type, actor (user ID), and date range"
    - "Super admin can expand any row to see before/after state diff"
    - "Super admin can export filtered audit log as CSV"
    - "CSV export action is itself logged to audit log"
  artifacts:
    - path: "src/app/api/admin/audit-logs/route.ts"
      provides: "Super admin audit log list API with filters and pagination"
      exports: ["GET"]
    - path: "src/app/api/admin/audit-logs/export/route.ts"
      provides: "Super admin audit log CSV export API"
      exports: ["GET"]
    - path: "src/app/(admin)/admin/audit/page.tsx"
      provides: "Audit log viewer page"
      min_lines: 60
    - path: "src/components/admin/audit/audit-log-table.tsx"
      provides: "Expandable table with state diff"
      min_lines: 80
    - path: "src/components/admin/audit/audit-filters.tsx"
      provides: "Action, actor, and date range filters"
      min_lines: 100
  key_links:
    - from: "src/app/(admin)/admin/audit/page.tsx"
      to: "/api/admin/audit-logs"
      via: "server-side fetch with cookie forwarding"
      pattern: "fetch.*api/admin/audit-logs"
    - from: "src/components/admin/audit/export-audit-button.tsx"
      to: "/api/admin/audit-logs/export"
      via: "client-side fetch with blob download"
      pattern: "fetch.*api/admin/audit-logs/export"
    - from: "src/app/api/admin/audit-logs/export/route.ts"
      to: "prisma.auditLog.create"
      via: "audit the export action"
      pattern: "createAdminAuditLogger.*DATA_EXPORTED"
---

<objective>
Build complete audit log viewer for super admins with filtering, state diff display, and CSV export.

Purpose: Complete v3.1 Admin Panel milestone by enabling super admins to review and export audit history for compliance and debugging.

Output: Functional `/admin/audit` page with table, filters, expandable rows showing before/after state, and CSV export functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-audit-log-viewer-export/40-RESEARCH.md

# Existing admin patterns
@radl/src/app/(admin)/admin/users/page.tsx
@radl/src/app/api/admin/users/route.ts
@radl/src/components/admin/users/user-list-table.tsx
@radl/src/components/admin/users/user-search.tsx

# Audit infrastructure
@radl/src/lib/audit/actions.ts
@radl/src/lib/audit/logger.ts
@radl/src/app/api/audit-logs/export/route.ts

# Admin auth
@radl/src/lib/auth/admin-authorize.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create super admin audit log API endpoints</name>
  <files>
    src/app/api/admin/audit-logs/route.ts
    src/app/api/admin/audit-logs/export/route.ts
  </files>
  <action>
Create two API routes for super admin audit log access:

**GET /api/admin/audit-logs (list with filters)**

Follow existing `/api/admin/users/route.ts` pattern:
1. Use `getSuperAdminContext()` for auth (bypasses CASL tenant scoping)
2. Parse query params: `page`, `perPage` (default 25, max 100), `action`, `userId`, `startDate`, `endDate`
3. Build Prisma where clause:
   - If `action`: `where.action = action`
   - If `userId`: `where.userId = userId`
   - If `startDate` or `endDate`: `where.createdAt = { gte: new Date(startDate), lte: new Date(endDate) }`
   - Do NOT filter by clubId (super admin sees all logs including 'PLATFORM')
4. Query with pagination: `prisma.auditLog.findMany({ where, orderBy: { createdAt: 'desc' }, take: perPage, skip: (page - 1) * perPage })`
5. Also run `prisma.auditLog.count({ where })` for total
6. Enrich each log with `actionDescription` from `AUDIT_ACTION_DESCRIPTIONS[log.action]`
7. Return `{ logs, pagination: { page, perPage, total, totalPages } }`

**GET /api/admin/audit-logs/export (CSV export)**

Follow existing `/api/audit-logs/export/route.ts` pattern but for super admin:
1. Use `getSuperAdminContext()` for auth
2. Parse same filters as list endpoint (action, userId, startDate, endDate)
3. Build same where clause (no clubId filter)
4. Query ALL matching logs (no pagination): `prisma.auditLog.findMany({ where, orderBy: { createdAt: 'desc' } })`
5. IMPORTANT: Audit the export action using `createAdminAuditLogger`:
   ```typescript
   const audit = createAdminAuditLogger(request, adminContext.userId);
   await audit.log({
     action: 'DATA_EXPORTED',
     targetType: 'AuditLog',
     metadata: { filters: { action, userId, startDate, endDate }, recordCount: logs.length },
   });
   ```
6. Generate CSV with headers: ID, Timestamp, Action, Action Description, User ID, Target Type, Target ID, Club ID, IP Address, User Agent, Metadata
7. Use `escapeCSV()` helper (copy from existing export route)
8. Return `new NextResponse(csv, { headers: { 'Content-Type': 'text/csv', 'Content-Disposition': 'attachment; filename="audit-logs-YYYY-MM-DD.csv"' } })`

Import from existing modules:
- `getSuperAdminContext` from `@/lib/auth/admin-authorize`
- `createAdminAuditLogger` from `@/lib/audit/logger`
- `AUDIT_ACTION_DESCRIPTIONS` from `@/lib/audit/actions`
- `unauthorizedResponse, serverErrorResponse` from `@/lib/errors`
  </action>
  <verify>
```bash
# Start dev server if not running
cd /home/hb/radl && npm run dev &

# Test list endpoint (requires super admin session - will get 401 without it)
curl -s http://localhost:3000/api/admin/audit-logs | head -c 200

# Check TypeScript compiles
cd /home/hb/radl && npx tsc --noEmit --skipLibCheck 2>&1 | grep -E "audit-logs" || echo "No TS errors in audit-logs routes"
```
  </verify>
  <done>
- GET /api/admin/audit-logs returns paginated logs with filters
- GET /api/admin/audit-logs/export returns CSV file
- Export action logs itself to AuditLog with DATA_EXPORTED action
- Both endpoints require super admin auth
  </done>
</task>

<task type="auto">
  <name>Task 2: Create audit log page with table and expandable rows</name>
  <files>
    src/app/(admin)/admin/audit/page.tsx
    src/app/(admin)/admin/audit/loading.tsx
    src/components/admin/audit/audit-log-table.tsx
    src/components/admin/audit/state-diff-display.tsx
  </files>
  <action>
Create the audit log viewer page and table components:

**page.tsx - Server component**

Follow existing `/admin/users/page.tsx` pattern:
1. Define `PageProps` with searchParams: `page`, `action`, `userId`, `startDate`, `endDate`
2. Create `getAuditLogs()` function:
   - Use `cookies()` to get cookie header for auth forwarding
   - Build URLSearchParams from all filter params
   - Fetch from `/api/admin/audit-logs?${params}` with cookie header
   - Return parsed JSON or null on error
3. Render page structure:
   - Header: "Audit Log" title with total count
   - AuditFilters component (pass initialFilters from searchParams)
   - AuditLogTable component (pass logs array)
   - Pagination controls (copy from users/page.tsx, adjust links to /admin/audit)

**loading.tsx**

Simple loading skeleton matching other admin pages:
```tsx
export default function Loading() {
  return (
    <div className="space-y-6">
      <div className="h-8 w-48 bg-[var(--surface-2)] animate-pulse rounded" />
      <div className="h-12 w-full bg-[var(--surface-2)] animate-pulse rounded" />
      <div className="h-96 w-full bg-[var(--surface-2)] animate-pulse rounded" />
    </div>
  );
}
```

**audit-log-table.tsx - Client component**

Create expandable table with state diff:
1. Define `AuditLogItem` interface matching API response (id, createdAt, action, actionDescription, userId, targetType, targetId, clubId, ipAddress, metadata)
2. Use `useState<Set<string>>` for `expandedRows` to track which rows are expanded
3. Create `toggleRow(id)` function to add/remove from Set
4. Table structure:
   - Headers: Timestamp, Action, Actor (userId), Target, Details (expand button)
   - Each row: format createdAt with `toLocaleString()`, show actionDescription, userId, `${targetType} ${targetId || ''}`
   - If `metadata.beforeState` or `metadata.afterState` exists, show expand button (ChevronRight/ChevronDown icons)
   - When expanded, render StateDiffDisplay in a colspan row below

**state-diff-display.tsx**

Side-by-side JSON display:
1. Props: `beforeState: Record<string, unknown> | null`, `afterState: Record<string, unknown> | null`
2. If both null, show "No state changes recorded"
3. Render two-column grid:
   - Left: "Before" heading + `<pre>` with `JSON.stringify(beforeState, null, 2)`
   - Right: "After" heading + `<pre>` with `JSON.stringify(afterState, null, 2)`
4. Style: `bg-[var(--surface-2)] p-3 rounded text-xs overflow-auto max-h-60`

Use Lucide icons: `ChevronDown`, `ChevronRight` from 'lucide-react'
  </action>
  <verify>
```bash
# Check files exist
ls -la /home/hb/radl/src/app/\(admin\)/admin/audit/
ls -la /home/hb/radl/src/components/admin/audit/

# TypeScript check
cd /home/hb/radl && npx tsc --noEmit --skipLibCheck 2>&1 | grep -E "admin/audit" || echo "No TS errors"

# Manual verification: Navigate to http://localhost:3000/admin/audit as super admin
```
  </verify>
  <done>
- Audit log page displays at /admin/audit
- Table shows timestamp, action, actor, target columns
- Rows with state changes have expand button
- Expanded rows show before/after JSON side-by-side
- Loading skeleton displays while fetching
  </done>
</task>

<task type="auto">
  <name>Task 3: Create filter components and export button</name>
  <files>
    src/components/admin/audit/audit-filters.tsx
    src/components/admin/audit/export-audit-button.tsx
  </files>
  <action>
Create filter bar and export functionality:

**audit-filters.tsx - Client component**

Filter bar with action dropdown, actor input, date range picker, and export button:

1. Props: `initialFilters: { action?: string; userId?: string; startDate?: string; endDate?: string }`
2. Use `useRouter()` and `useSearchParams()` for URL-based filtering
3. Create `updateFilter(key, value)` function:
   - Build new URLSearchParams from current
   - Set/delete the key based on value
   - Always reset page to 1 when filters change
   - `router.push(\`/admin/audit?${params}\`)`

**Action type dropdown:**
- Use Select from `@/components/ui/select` (existing shadcn component)
- Populate options from `AUDITABLE_ACTIONS` and `AUDIT_ACTION_DESCRIPTIONS`
- "All Actions" option with value "all" (clears filter)
- Width: w-[250px]

**Actor (User ID) input:**
- Simple text input with placeholder "Filter by User ID"
- Debounce 300ms before applying filter (use setTimeout pattern)
- Or apply on blur for simpler implementation

**Date range picker:**
- Use Popover from `@/components/ui/popover` + DayPicker from `react-day-picker`
- Import: `import { DayPicker } from 'react-day-picker'` and `import 'react-day-picker/dist/style.css'`
- State: `useState<{ from?: Date; to?: Date }>({})`
- Mode: `mode="range"` on DayPicker
- Display: Button showing "Select Date Range" or formatted range using `format()` from date-fns
- Apply button inside popover to trigger URL update

**Layout:**
- Flex row with gap-4
- Filters on left, ExportAuditButton on right (ml-auto)

**export-audit-button.tsx - Client component**

Download button that triggers CSV export:
1. Props: `filters: { action?: string; userId?: string; startDate?: string; endDate?: string }`
2. State: `useState(false)` for `exporting`
3. `handleExport()` async function:
   - Set exporting true
   - Build URLSearchParams from filters
   - Fetch `/api/admin/audit-logs/export?${params}`
   - Check response.ok, throw on error
   - Get blob: `const blob = await response.blob()`
   - Create download: `window.URL.createObjectURL(blob)`, create `<a>`, set href and download filename, click, cleanup
   - Catch errors, show console.error (or toast if available)
   - Finally: setExporting(false) after 500ms delay (prevents double-click)
4. Render Button with Download icon from lucide-react
   - Text: "Exporting..." when exporting, "Export CSV" otherwise
   - Disabled when exporting
   - variant="outline"
  </action>
  <verify>
```bash
# TypeScript check
cd /home/hb/radl && npx tsc --noEmit --skipLibCheck 2>&1 | grep -E "audit-filters|export-audit" || echo "No TS errors"

# Manual verification steps:
# 1. Navigate to /admin/audit as super admin
# 2. Test action dropdown - should filter table
# 3. Test date range picker - should filter table
# 4. Test Export CSV button - should download file
# 5. Check audit log for DATA_EXPORTED entry after export
```
  </verify>
  <done>
- Action type dropdown filters by AUDITABLE_ACTIONS
- Date range picker filters by startDate/endDate
- User ID input filters by actor
- Export CSV button downloads filtered results
- Filters update URL for bookmarkable/shareable views
- Export action creates audit log entry
  </done>
</task>

</tasks>

<verification>
All phase requirements verified:

**AUDT-02: Audit log viewer in admin panel**
- `/admin/audit` page with table showing all audit logs
- Filterable by action type (dropdown with all AUDITABLE_ACTIONS)
- Filterable by actor (user ID text input)
- Filterable by date range (react-day-picker date range selector)
- Before/after state diff visible via expandable rows

**AUDT-03: Audit log export**
- Export CSV button downloads filtered results
- Date range filter applied to export
- Export action itself is audited (DATA_EXPORTED)

**Success Criteria:**
1. Super admin can browse audit log with filters for action type, actor, and date range - VERIFIED via filters updating URL and table
2. Super admin can see before/after state diff for any logged action - VERIFIED via expandable rows with StateDiffDisplay
3. Super admin can export filtered audit log as CSV - VERIFIED via ExportAuditButton triggering download

**Commands to verify:**
```bash
cd /home/hb/radl

# TypeScript compilation
npx tsc --noEmit --skipLibCheck

# Check all files created
ls -la src/app/api/admin/audit-logs/
ls -la src/app/api/admin/audit-logs/export/
ls -la src/app/\(admin\)/admin/audit/
ls -la src/components/admin/audit/
```
</verification>

<success_criteria>
- [ ] GET /api/admin/audit-logs returns paginated, filterable audit logs
- [ ] GET /api/admin/audit-logs/export returns CSV download
- [ ] /admin/audit page displays table with all logs
- [ ] Filters (action, actor, date range) update URL and table
- [ ] Expandable rows show before/after state diff
- [ ] Export CSV button downloads filtered results
- [ ] Export action logs DATA_EXPORTED to audit log
- [ ] TypeScript compiles without errors
- [ ] All success criteria from phase requirements met
</success_criteria>

<output>
After completion, create `.planning/phases/40-audit-log-viewer-export/40-01-SUMMARY.md`
</output>
