---
phase: 12-facility-schema-migration
plan: 07
type: execute
wave: 5
depends_on: ["12-04", "12-05", "12-06"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Existing team data continues working after migration"
    - "RLS prevents cross-tenant data access"
    - "JWT claims include facility_id and club_id"
    - "Equipment visibility follows ownership hierarchy"
  artifacts: []
  key_links:
    - from: "Application"
      to: "Database"
      via: "RLS enforcement"
      pattern: "RLS policy check"
---

<objective>
Verify facility schema migration end-to-end

Purpose: Confirm all migration components work together - schema, data migration, RLS policies, JWT claims, and TypeScript helpers. This validates FAC-01, FAC-02, FAC-04 requirements.
Output: Verified working facility hierarchy with documented test results
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-facility-schema-migration/12-RESEARCH.md
@.planning/phases/12-facility-schema-migration/12-01-SUMMARY.md
@.planning/phases/12-facility-schema-migration/12-04-SUMMARY.md
@.planning/phases/12-facility-schema-migration/12-05-SUMMARY.md
@.planning/phases/12-facility-schema-migration/12-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify schema and data migration</name>
  <files></files>
  <action>
Run verification queries in Supabase SQL Editor:

1. Check all teams have facilities:
```sql
SELECT
  'Teams without facility' as check,
  COUNT(*) as count
FROM "Team"
WHERE "facilityId" IS NULL;
-- Should return 0
```

2. Check all equipment has ownership:
```sql
SELECT
  'Equipment without owner type' as check,
  COUNT(*) as count
FROM "Equipment"
WHERE "ownerType" IS NULL
  AND "teamId" IS NOT NULL;
-- Should return 0
```

3. Check facility-team relationships:
```sql
SELECT
  f.name as facility_name,
  f.slug,
  COUNT(t.id) as clubs_count,
  COUNT(e.id) as equipment_count
FROM "Facility" f
LEFT JOIN "Team" t ON t."facilityId" = f.id
LEFT JOIN "Equipment" e ON e."clubId" = t.id
GROUP BY f.id, f.name, f.slug;
```

4. Verify equipment ownership distribution:
```sql
SELECT
  "ownerType",
  COUNT(*) as count
FROM "Equipment"
GROUP BY "ownerType";
-- Should show TEAM for all existing equipment
```
  </action>
  <verify>
All checks pass:
1. 0 teams without facility
2. 0 equipment without owner type
3. Facilities have expected club counts
4. Equipment shows TEAM ownership
  </verify>
  <done>Schema and data migration verified</done>
</task>

<task type="auto">
  <name>Task 2: Verify RLS policies</name>
  <files></files>
  <action>
Test RLS isolation using SQL Editor with role switching:

1. Check RLS is enabled:
```sql
SELECT tablename, rowsecurity
FROM pg_tables
WHERE schemaname = 'public'
  AND tablename IN ('Facility', 'FacilityMembership', 'Equipment', 'Team');
-- All should show true
```

2. Check policies exist:
```sql
SELECT tablename, policyname, cmd
FROM pg_policies
WHERE schemaname = 'public'
  AND tablename IN ('Facility', 'FacilityMembership', 'Equipment')
ORDER BY tablename, policyname;
```

3. Verify helper functions exist:
```sql
SELECT routine_name
FROM information_schema.routines
WHERE routine_schema = 'public'
  AND routine_name IN (
    'get_current_facility_id',
    'get_current_club_id',
    'get_current_team_id',
    'has_role',
    'is_facility_admin',
    'is_coach_or_higher'
  );
-- Should return 6 rows
```

4. Test helper function with mock JWT (run as authenticated):
```sql
-- This tests the function exists and handles null gracefully
SELECT
  public.get_current_facility_id() IS NULL as facility_null_ok,
  public.get_current_club_id() IS NULL as club_null_ok,
  public.has_role('COACH') = false as has_role_ok;
```
  </action>
  <verify>
1. All tables have rowsecurity = true
2. Policies exist for Facility (2), FacilityMembership (4), Equipment (4)
3. All 6+ helper functions exist
4. Helper functions handle null JWT gracefully
  </verify>
  <done>RLS policies verified</done>
</task>

<task type="auto">
  <name>Task 3: Verify TypeScript compilation and types</name>
  <files></files>
  <action>
Run TypeScript verification:

1. Full type check:
```bash
npx tsc --noEmit
```

2. Check Prisma types generated correctly:
```bash
ls -la src/generated/prisma/
# Should include index.d.ts with Facility, FacilityMembership types
```

3. Verify new types are accessible:
```bash
grep -l "Facility" src/generated/prisma/index.d.ts
# Should find the file

grep "EquipmentOwnerType" src/generated/prisma/index.d.ts
# Should find the enum
```

4. Verify claims types compile:
```bash
grep "facility_id" src/lib/auth/claims.ts
# Should find the field
```
  </action>
  <verify>
1. tsc --noEmit exits with code 0
2. Prisma types include Facility, FacilityMembership, EquipmentOwnerType
3. claims.ts has facility_id field
  </verify>
  <done>TypeScript types verified</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete facility schema migration:
- Facility model with full profile fields
- FacilityMembership for facility-level roles
- Equipment ownership hierarchy (FACILITY/CLUB/TEAM)
- RLS policies enforcing tenant isolation
- JWT claims with facility_id/club_id
- TypeScript helpers for facility context
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Open Prisma Studio: `npx prisma studio`
3. Navigate to Facility table - should exist with data (one per existing team)
4. Navigate to Equipment table - all should have ownerType = TEAM
5. Open app in browser - existing functionality should work unchanged
6. Check browser DevTools -> Application -> Cookies for radl_current_facility (may not exist yet - that's OK)

Key checks:
- [ ] App loads without errors
- [ ] Existing team data visible
- [ ] Equipment list shows all equipment
- [ ] No permission errors for existing users
  </how-to-verify>
  <resume-signal>Type "verified" if all checks pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
- All SQL verification queries pass
- TypeScript compiles without errors
- Application starts and existing functionality works
- Prisma Studio shows correct data migration
</verification>

<success_criteria>
Requirements validation:
- FAC-01: Facility model exists with clubs relation (CHECK: Facility.clubs relation works)
- FAC-02: Equipment has ownerType for FACILITY/CLUB/TEAM ownership (CHECK: enum exists, data migrated)
- FAC-04: RLS enforces tenant isolation (CHECK: policies active, helper functions work)

Technical validation:
- Zero teams without facilityId
- Zero equipment without ownerType
- All RLS policies active
- TypeScript compiles cleanly
- Application runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-facility-schema-migration/12-07-SUMMARY.md`
</output>
