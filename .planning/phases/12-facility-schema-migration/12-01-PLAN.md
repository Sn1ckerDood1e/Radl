---
phase: 12-facility-schema-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "Facility model exists with full profile fields"
    - "Equipment has ownerType enum (FACILITY, CLUB, TEAM)"
    - "Team can reference a Facility"
    - "FacilityMembership tracks facility-level roles"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Facility model, EquipmentOwnerType enum, BillingType enum, FacilityMembership model, updated Team and Equipment relations"
      contains: "model Facility"
  key_links:
    - from: "Team"
      to: "Facility"
      via: "facilityId foreign key"
      pattern: "facility.*Facility.*FacilityClubs"
    - from: "Equipment"
      to: "Facility"
      via: "facilityId foreign key"
      pattern: "facility.*Facility.*FacilityEquipment"
---

<objective>
Create Prisma schema for facility hierarchy

Purpose: Database supports facility->club->team hierarchy with equipment ownership types. This is the foundation for all subsequent migration steps.
Output: Updated schema.prisma with Facility model, enums, and relationships
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-facility-schema-migration/12-RESEARCH.md
@.planning/phases/12-facility-schema-migration/12-CONTEXT.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Facility model and enums to schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the following to prisma/schema.prisma:

1. Add BillingType enum after existing enums:
```prisma
enum BillingType {
  FACILITY   // Facility pays for all clubs
  CLUB       // Each club has own subscription
  HYBRID     // Mix - some clubs pay, some don't
}

enum EquipmentOwnerType {
  FACILITY  // Shared across facility (boathouse boats)
  CLUB      // Club-exclusive (club-owned boats)
  TEAM      // Legacy team-owned (backward compat)
}
```

2. Add Facility model (place after Team model):
```prisma
// Facility model (boathouse/organization level)
model Facility {
  id           String   @id @default(uuid())
  name         String
  slug         String   @unique
  // Location
  address      String?
  city         String?
  state        String?
  country      String?  @default("US")
  timezone     String   @default("America/New_York")
  coordinates  Json?    // { lat: number, lng: number }
  // Contact
  phone        String?
  email        String?
  website      String?
  // Branding
  logoUrl      String?
  description  String?
  // Billing (hybrid model)
  billingType  BillingType @default(FACILITY)
  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  clubs         Team[]   @relation("FacilityClubs")
  equipment     Equipment[]  @relation("FacilityEquipment")
  memberships   FacilityMembership[]

  @@index([slug])
}
```

3. Add FacilityMembership model (after ClubMembership):
```prisma
// FacilityMembership for facility-level roles (FACILITY_ADMIN)
model FacilityMembership {
  id           String   @id @default(uuid())
  facilityId   String
  userId       String   // Supabase auth user ID
  roles        Role[]   // FACILITY_ADMIN only at this level
  isActive     Boolean  @default(true)
  joinedAt     DateTime @default(now())
  updatedAt    DateTime @updatedAt

  facility     Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  @@unique([facilityId, userId])
  @@index([userId])
  @@index([facilityId])
}
```
  </action>
  <verify>Run `npx prisma validate` - should pass with no errors</verify>
  <done>Facility model and enums exist in schema.prisma</done>
</task>

<task type="auto">
  <name>Task 2: Update Team and Equipment models with facility relationships</name>
  <files>prisma/schema.prisma</files>
  <action>
Update existing models in prisma/schema.prisma:

1. Update Team model - add facilityId field and relation:
```prisma
model Team {
  // ... existing fields (keep all)
  facilityId     String?  // NEW: nullable for backward compat during migration

  // ... existing relations
  facility       Facility? @relation("FacilityClubs", fields: [facilityId], references: [id])
  clubEquipment  Equipment[] @relation("ClubEquipment")  // NEW: for club-owned equipment

  @@index([facilityId])  // NEW index
}
```

2. Update Equipment model - add ownership hierarchy fields:
Change `teamId String` to `teamId String?` (make optional for facility-owned equipment).

Add new fields after teamId:
```prisma
  // Ownership hierarchy (NEW)
  ownerType  EquipmentOwnerType @default(TEAM)
  facilityId String?
  clubId     String?
  isShared   Boolean  @default(false)  // For club equipment shared with facility
```

Add new relations (keep existing team relation but update to optional):
```prisma
  team       Team?     @relation(fields: [teamId], references: [id], onDelete: Cascade)  // Make optional
  facility   Facility? @relation("FacilityEquipment", fields: [facilityId], references: [id])
  club       Team?     @relation("ClubEquipment", fields: [clubId], references: [id])
```

Add new indexes:
```prisma
  @@index([facilityId])
  @@index([clubId])
  @@index([ownerType])
```

IMPORTANT: The existing `team Team @relation(...)` becomes `team Team? @relation(...)` - add the ? for optional.
  </action>
  <verify>Run `npx prisma validate` - should pass with no errors</verify>
  <done>Team has facilityId field, Equipment has ownerType/facilityId/clubId/isShared fields</done>
</task>

<task type="auto">
  <name>Task 3: Generate Prisma migration</name>
  <files>prisma/migrations/</files>
  <action>
Run Prisma migration with a descriptive name:

```bash
npx prisma migrate dev --name facility_schema
```

This will:
1. Generate migration SQL in prisma/migrations/
2. Apply migration to development database
3. Regenerate Prisma Client

If migration fails due to existing data:
- The migration should add columns as nullable (facilityId, clubId on Equipment)
- ownerType has @default(TEAM) so existing rows get TEAM
- isShared has @default(false) so existing rows get false

After migration succeeds, verify generated client has new types:
```bash
ls src/generated/prisma/index.d.ts
```
  </action>
  <verify>
1. `npx prisma migrate status` shows no pending migrations
2. `npx prisma studio` opens without errors
3. Facility table exists in database (visible in Prisma Studio)
  </verify>
  <done>Migration applied, Facility/FacilityMembership tables exist, Equipment has new columns</done>
</task>

</tasks>

<verification>
- `npx prisma validate` passes
- `npx prisma migrate status` shows all migrations applied
- Prisma Studio shows Facility, FacilityMembership tables
- Equipment table has ownerType, facilityId, clubId, isShared columns
- Team table has facilityId column
</verification>

<success_criteria>
- Facility model exists with all profile fields (name, slug, location, contact, branding, billing)
- EquipmentOwnerType enum has FACILITY, CLUB, TEAM values
- BillingType enum has FACILITY, CLUB, HYBRID values
- FacilityMembership model exists with facilityId, userId, roles fields
- Team.facilityId exists (nullable for backward compat)
- Equipment has ownerType (default TEAM), facilityId, clubId, isShared fields
- All relations properly defined with indexes
</success_criteria>

<output>
After completion, create `.planning/phases/12-facility-schema-migration/12-01-SUMMARY.md`
</output>
