---
phase: 12-facility-schema-migration
plan: 04
type: execute
wave: 3
depends_on: ["12-01", "12-02", "12-03"]
files_modified:
  - supabase/migrations/00007_facility_data_migration.sql
autonomous: true

must_haves:
  truths:
    - "Every existing Team has a Facility wrapper with same name"
    - "Every existing Equipment has ownerType set to TEAM"
    - "Every existing Equipment has clubId set to teamId"
    - "No Team has NULL facilityId after migration"
  artifacts:
    - path: "supabase/migrations/00007_facility_data_migration.sql"
      provides: "Data migration script for existing teams and equipment"
      contains: "INSERT INTO.*Facility"
  key_links:
    - from: "Team"
      to: "Facility"
      via: "slug matching and facilityId update"
      pattern: "UPDATE.*Team.*facilityId"
    - from: "Equipment"
      to: "ownerType"
      via: "default to TEAM"
      pattern: "UPDATE.*Equipment.*ownerType"
---

<objective>
Migrate existing data to facility hierarchy

Purpose: Existing teams need facility wrappers, existing equipment needs ownership type set. This enables RLS policies and application code to work with existing data.
Output: Data migration SQL that creates facilities for teams and sets equipment ownership
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-facility-schema-migration/12-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create data migration SQL</name>
  <files>supabase/migrations/00007_facility_data_migration.sql</files>
  <action>
Create supabase/migrations/00007_facility_data_migration.sql with:

```sql
-- Data Migration: Create Facility Wrappers and Set Equipment Ownership
-- Run this AFTER Prisma schema migration has created the tables
-- Run this in Supabase SQL Editor

-- =============================================================================
-- Step 1: Create Facility Wrapper for Each Existing Team
-- =============================================================================
-- Each existing team gets a facility with the same name/slug
-- This maintains backward compatibility for single-team installations

INSERT INTO "Facility" (id, name, slug, timezone, "createdAt", "updatedAt")
SELECT
  gen_random_uuid(),
  t.name,
  t.slug,
  'America/New_York',  -- Default timezone
  t."createdAt",
  NOW()
FROM "Team" t
WHERE t."facilityId" IS NULL
  AND NOT EXISTS (
    SELECT 1 FROM "Facility" f WHERE f.slug = t.slug
  );

-- Log how many facilities were created
DO $$
DECLARE
  facilities_created INTEGER;
BEGIN
  SELECT COUNT(*) INTO facilities_created
  FROM "Facility" f
  WHERE EXISTS (
    SELECT 1 FROM "Team" t
    WHERE t.slug = f.slug AND t."facilityId" IS NULL
  );
  RAISE NOTICE 'Created % facility wrappers for existing teams', facilities_created;
END $$;

-- =============================================================================
-- Step 2: Link Teams to Their Facility Wrappers
-- =============================================================================

UPDATE "Team" t
SET "facilityId" = f.id
FROM "Facility" f
WHERE f.slug = t.slug
  AND t."facilityId" IS NULL;

-- Log how many teams were linked
DO $$
DECLARE
  teams_linked INTEGER;
BEGIN
  SELECT COUNT(*) INTO teams_linked FROM "Team" WHERE "facilityId" IS NOT NULL;
  RAISE NOTICE 'Linked % teams to facilities', teams_linked;
END $$;

-- =============================================================================
-- Step 3: Migrate Equipment to TEAM Ownership
-- =============================================================================
-- All existing equipment becomes team-owned (the legacy model)
-- clubId is set to teamId for consistency with new hierarchy

UPDATE "Equipment"
SET
  "ownerType" = 'TEAM',
  "clubId" = "teamId",
  "isShared" = false
WHERE "ownerType" IS NULL
  AND "teamId" IS NOT NULL;

-- For equipment that already has ownerType but missing clubId
UPDATE "Equipment"
SET "clubId" = "teamId"
WHERE "clubId" IS NULL
  AND "teamId" IS NOT NULL
  AND "ownerType" = 'TEAM';

-- Log how much equipment was migrated
DO $$
DECLARE
  equipment_migrated INTEGER;
BEGIN
  SELECT COUNT(*) INTO equipment_migrated
  FROM "Equipment"
  WHERE "ownerType" = 'TEAM';
  RAISE NOTICE 'Migrated % equipment items to TEAM ownership', equipment_migrated;
END $$;

-- =============================================================================
-- Step 4: Verification
-- =============================================================================

DO $$
DECLARE
  unlinked_teams INTEGER;
  orphan_equipment INTEGER;
  missing_owner_type INTEGER;
BEGIN
  -- Check for teams without facility
  SELECT COUNT(*) INTO unlinked_teams
  FROM "Team"
  WHERE "facilityId" IS NULL;

  -- Check for equipment without owner type
  SELECT COUNT(*) INTO missing_owner_type
  FROM "Equipment"
  WHERE "ownerType" IS NULL
    AND "teamId" IS NOT NULL;

  -- Check for equipment without clubId
  SELECT COUNT(*) INTO orphan_equipment
  FROM "Equipment"
  WHERE "clubId" IS NULL
    AND "teamId" IS NOT NULL;

  IF unlinked_teams > 0 THEN
    RAISE EXCEPTION 'MIGRATION FAILED: % teams without facility', unlinked_teams;
  END IF;

  IF missing_owner_type > 0 THEN
    RAISE EXCEPTION 'MIGRATION FAILED: % equipment without owner type', missing_owner_type;
  END IF;

  IF orphan_equipment > 0 THEN
    RAISE EXCEPTION 'MIGRATION FAILED: % equipment without club assignment', orphan_equipment;
  END IF;

  RAISE NOTICE 'MIGRATION COMPLETE: All teams linked to facilities, all equipment has owner type';
END $$;

-- =============================================================================
-- Summary Query (run manually to verify)
-- =============================================================================
-- SELECT
--   'Teams' as entity,
--   COUNT(*) as total,
--   COUNT("facilityId") as with_facility
-- FROM "Team"
-- UNION ALL
-- SELECT
--   'Equipment' as entity,
--   COUNT(*) as total,
--   COUNT("ownerType") as with_owner_type
-- FROM "Equipment"
-- UNION ALL
-- SELECT
--   'Facilities' as entity,
--   COUNT(*) as total,
--   COUNT(*) as created
-- FROM "Facility";
```
  </action>
  <verify>File exists at supabase/migrations/00007_facility_data_migration.sql</verify>
  <done>Data migration SQL file created</done>
</task>

<task type="auto">
  <name>Task 2: Apply data migration</name>
  <files>supabase/migrations/00007_facility_data_migration.sql</files>
  <action>
Run the data migration in Supabase SQL Editor:

1. Open Supabase Dashboard -> SQL Editor
2. Copy contents of supabase/migrations/00007_facility_data_migration.sql
3. Run the SQL
4. Check NOTICE messages for migration counts

Verify migration success with these queries:

```sql
-- Check all teams have facilities
SELECT COUNT(*) as teams_without_facility
FROM "Team"
WHERE "facilityId" IS NULL;
-- Should return 0

-- Check all equipment has owner type
SELECT COUNT(*) as equipment_without_owner
FROM "Equipment"
WHERE "ownerType" IS NULL AND "teamId" IS NOT NULL;
-- Should return 0

-- Summary of facilities created
SELECT
  f.name as facility_name,
  f.slug,
  COUNT(t.id) as clubs_count
FROM "Facility" f
LEFT JOIN "Team" t ON t."facilityId" = f.id
GROUP BY f.id, f.name, f.slug;
```
  </action>
  <verify>
1. Run verification queries - all return 0 for missing data
2. At least one Facility exists if any Team existed
3. All Equipment has ownerType = 'TEAM' and clubId set
  </verify>
  <done>Data migration applied, all teams have facilities, all equipment has ownership</done>
</task>

</tasks>

<verification>
- SQL file exists at supabase/migrations/00007_facility_data_migration.sql
- No Team has NULL facilityId (SELECT COUNT(*) WHERE facilityId IS NULL returns 0)
- No Equipment has NULL ownerType (SELECT COUNT(*) WHERE ownerType IS NULL returns 0)
- Number of Facilities equals number of Teams (one-to-one wrapper)
- All Equipment has clubId = teamId
</verification>

<success_criteria>
- Every existing Team has a corresponding Facility with same slug
- Team.facilityId points to the wrapper Facility
- Equipment.ownerType = 'TEAM' for all existing equipment
- Equipment.clubId = Equipment.teamId for all existing equipment
- Equipment.isShared = false for all existing equipment
- Migration is idempotent (running twice doesn't break anything)
</success_criteria>

<output>
After completion, create `.planning/phases/12-facility-schema-migration/12-04-SUMMARY.md`
</output>
