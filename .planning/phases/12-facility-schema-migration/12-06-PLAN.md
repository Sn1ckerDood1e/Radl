---
phase: 12-facility-schema-migration
plan: 06
type: execute
wave: 4
depends_on: ["12-02", "12-03"]
files_modified:
  - src/lib/auth/claims.ts
  - src/lib/auth/facility-context.ts
autonomous: true

must_haves:
  truths:
    - "CustomJwtPayload includes facility_id field"
    - "Application can read current facility from cookie"
    - "Application can set current facility in cookie"
    - "Claims helper returns facilityId alongside clubId"
  artifacts:
    - path: "src/lib/auth/claims.ts"
      provides: "Extended claims interface with facility_id"
      contains: "facility_id"
    - path: "src/lib/auth/facility-context.ts"
      provides: "Facility context cookie management"
      contains: "getCurrentFacilityId"
  key_links:
    - from: "src/lib/auth/claims.ts"
      to: "JWT decoding"
      via: "CustomJwtPayload interface"
      pattern: "facility_id.*string.*null"
    - from: "src/lib/auth/facility-context.ts"
      to: "Next.js cookies"
      via: "cookies() API"
      pattern: "cookies.*FACILITY_COOKIE"
---

<objective>
Create TypeScript helpers for facility context

Purpose: Application code needs to read facility context from JWT claims and cookies. These helpers provide consistent access to facility/club hierarchy.
Output: Extended claims interface and facility context cookie helpers
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-facility-schema-migration/12-RESEARCH.md
@src/lib/auth/claims.ts
@src/lib/auth/club-context.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend CustomJwtPayload interface</name>
  <files>src/lib/auth/claims.ts</files>
  <action>
Update src/lib/auth/claims.ts to include facility_id in the JWT claims interface and return it from getClaimsForApiRoute.

1. Update CustomJwtPayload interface to add facility_id:
```typescript
export interface CustomJwtPayload {
  sub: string;
  email: string;
  // Facility hierarchy (NEW)
  facility_id: string | null;
  club_id?: string | null;
  // Legacy - kept for backward compatibility
  team_id: string | null;
  user_role: 'COACH' | 'ATHLETE' | 'PARENT' | null;
  user_roles?: string[];
}
```

2. Update ClaimsResult type to include facilityId:
```typescript
export type ClaimsResult = {
  user: User | null;
  claims: CustomJwtPayload | null;
  facilityId: string | null;   // NEW
  clubId: string | null;
  roles: string[];
  error: string | null;
};
```

3. Update getClaimsForApiRoute function:
- Import getCurrentFacilityId from './facility-context'
- After getting clubId, also get facilityId:
```typescript
// Get current facility from cookie
const facilityId = await getCurrentFacilityId();
```
- If no facilityId from cookie, use claims.facility_id
- Return facilityId in the result object

4. Add database fallback for facility_id (similar to team_id fallback):
- If claims.facility_id is null but clubId exists, look up Team.facilityId
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>CustomJwtPayload includes facility_id, ClaimsResult includes facilityId</done>
</task>

<task type="auto">
  <name>Task 2: Create facility context helper</name>
  <files>src/lib/auth/facility-context.ts</files>
  <action>
Create src/lib/auth/facility-context.ts following the same pattern as club-context.ts:

```typescript
import { cookies } from 'next/headers';

export const FACILITY_COOKIE_NAME = 'radl_current_facility';
const FACILITY_COOKIE_MAX_AGE = 60 * 60 * 24 * 365; // 1 year

/**
 * Gets the current facility ID from the httpOnly cookie.
 * Returns null if no facility selected (user needs to select one).
 */
export async function getCurrentFacilityId(): Promise<string | null> {
  const cookieStore = await cookies();
  return cookieStore.get(FACILITY_COOKIE_NAME)?.value ?? null;
}

/**
 * Sets the current facility ID in httpOnly cookie.
 * Called when user switches facilities or on initial facility detection.
 */
export async function setCurrentFacilityId(facilityId: string): Promise<void> {
  const cookieStore = await cookies();
  cookieStore.set(FACILITY_COOKIE_NAME, facilityId, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'lax',
    maxAge: FACILITY_COOKIE_MAX_AGE,
    path: '/',
  });
}

/**
 * Clears the current facility cookie.
 * Called on logout or when user is removed from facility.
 */
export async function clearCurrentFacilityId(): Promise<void> {
  const cookieStore = await cookies();
  cookieStore.delete(FACILITY_COOKIE_NAME);
}

/**
 * Auto-detects facility from user's club membership.
 * Returns facilityId if user has a single facility, null if multiple or none.
 * Used during initial login to auto-set facility context.
 */
export async function detectUserFacility(userId: string): Promise<string | null> {
  // Import here to avoid circular dependency
  const { prisma } = await import('@/lib/prisma');

  // Get unique facilities user belongs to
  const memberships = await prisma.clubMembership.findMany({
    where: {
      userId,
      isActive: true,
    },
    select: {
      club: {
        select: {
          facilityId: true,
        },
      },
    },
  });

  const facilityIds = [...new Set(
    memberships
      .map(m => m.club.facilityId)
      .filter((id): id is string => id !== null)
  )];

  // If user belongs to exactly one facility, return it
  if (facilityIds.length === 1) {
    return facilityIds[0];
  }

  // Multiple facilities or no facility - user must choose
  return null;
}
```
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>facility-context.ts exists with get/set/clear/detect functions</done>
</task>

<task type="auto">
  <name>Task 3: Wire up facility context in claims helper</name>
  <files>src/lib/auth/claims.ts</files>
  <action>
Complete the integration in src/lib/auth/claims.ts:

1. Add import at top of file:
```typescript
import { getCurrentFacilityId } from './facility-context';
```

2. Update getClaimsForApiRoute to fetch and return facilityId:

After the existing clubId retrieval, add:
```typescript
// Get current facility from cookie
let facilityId = await getCurrentFacilityId();

// Database fallback: If facilityId is null but clubId exists, look up team's facility
if (!facilityId && clubId) {
  const team = await prisma.team.findUnique({
    where: { id: clubId },
    select: { facilityId: true },
  });
  if (team?.facilityId) {
    facilityId = team.facilityId;
  }
}

// Also check JWT claims as fallback
if (!facilityId && claims.facility_id) {
  facilityId = claims.facility_id;
}
```

3. Update the return statement to include facilityId:
```typescript
return {
  user,
  claims,
  facilityId,  // NEW
  clubId: clubId || claims.team_id,
  roles,
  error: null,
};
```

4. Update error return to include facilityId: null:
```typescript
return { user: null, claims: null, facilityId: null, clubId: null, roles: [], error: '...' };
```
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. getClaimsForApiRoute returns facilityId in result
  </verify>
  <done>claims.ts returns facilityId from cookie or JWT with database fallback</done>
</task>

</tasks>

<verification>
- src/lib/auth/claims.ts updated with facility_id in interface
- src/lib/auth/facility-context.ts created with cookie helpers
- getClaimsForApiRoute returns facilityId
- TypeScript compiles without errors
- Pattern matches existing club-context.ts style
</verification>

<success_criteria>
- CustomJwtPayload.facility_id exists (string | null)
- ClaimsResult.facilityId exists (string | null)
- getCurrentFacilityId() reads from cookie
- setCurrentFacilityId() writes to cookie
- clearCurrentFacilityId() deletes cookie
- detectUserFacility() finds user's facility from memberships
- Database fallback works when cookie and JWT are stale
- API routes can access facilityId via getClaimsForApiRoute()
</success_criteria>

<output>
After completion, create `.planning/phases/12-facility-schema-migration/12-06-SUMMARY.md`
</output>
