---
phase: 12-facility-schema-migration
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - supabase/migrations/00005_facility_rls_helpers.sql
autonomous: true

must_haves:
  truths:
    - "RLS can extract facility_id from JWT claims"
    - "RLS can extract club_id from JWT claims"
    - "RLS can check if user has specific role"
  artifacts:
    - path: "supabase/migrations/00005_facility_rls_helpers.sql"
      provides: "Helper functions for facility hierarchy RLS"
      contains: "get_current_facility_id"
  key_links:
    - from: "RLS policies"
      to: "JWT claims"
      via: "current_setting('request.jwt.claims')"
      pattern: "request\\.jwt\\.claims"
---

<objective>
Create RLS helper functions for facility hierarchy

Purpose: RLS policies need reusable functions to extract facility/club context from JWT claims. These functions are used by all hierarchical RLS policies.
Output: SQL migration with get_current_facility_id(), get_current_club_id(), has_role() functions
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-facility-schema-migration/12-RESEARCH.md
@supabase/migrations/00002_rls_policies.sql
@supabase/migrations/00003_custom_access_token_hook.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RLS helper functions SQL migration</name>
  <files>supabase/migrations/00005_facility_rls_helpers.sql</files>
  <action>
Create supabase/migrations/00005_facility_rls_helpers.sql with:

```sql
-- RLS Helper Functions for Facility Hierarchy
-- Extracts tenant context from JWT claims (connection-pooling safe)
-- Run this in Supabase SQL Editor after Prisma migration

-- =============================================================================
-- Helper Functions
-- =============================================================================

-- Get facility_id from JWT claims
-- Returns NULL if not set (user not in any facility)
CREATE OR REPLACE FUNCTION public.get_current_facility_id()
RETURNS uuid
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = ''
AS $$
  SELECT NULLIF(
    (current_setting('request.jwt.claims', true)::jsonb ->> 'facility_id'),
    ''
  )::uuid
$$;

-- Get club_id from JWT claims
-- Returns NULL if not set (user not in any club)
CREATE OR REPLACE FUNCTION public.get_current_club_id()
RETURNS uuid
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = ''
AS $$
  SELECT NULLIF(
    (current_setting('request.jwt.claims', true)::jsonb ->> 'club_id'),
    ''
  )::uuid
$$;

-- Get team_id from JWT claims (backward compatibility alias)
-- Returns club_id value (team = club in current schema)
CREATE OR REPLACE FUNCTION public.get_current_team_id()
RETURNS uuid
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = ''
AS $$
  SELECT public.get_current_club_id()
$$;

-- Check if current user has a specific role in their current context
-- Reads from user_roles array in JWT claims
CREATE OR REPLACE FUNCTION public.has_role(required_role text)
RETURNS boolean
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = ''
AS $$
  SELECT COALESCE(
    required_role = ANY(
      ARRAY(
        SELECT jsonb_array_elements_text(
          COALESCE(
            current_setting('request.jwt.claims', true)::jsonb -> 'user_roles',
            '[]'::jsonb
          )
        )
      )
    ),
    false
  )
$$;

-- Check if user has any of the specified roles
CREATE OR REPLACE FUNCTION public.has_any_role(required_roles text[])
RETURNS boolean
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = ''
AS $$
  SELECT EXISTS (
    SELECT 1
    FROM unnest(required_roles) AS r(role)
    WHERE public.has_role(r.role)
  )
$$;

-- Check if user is facility admin (convenience function)
CREATE OR REPLACE FUNCTION public.is_facility_admin()
RETURNS boolean
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = ''
AS $$
  SELECT public.has_role('FACILITY_ADMIN')
$$;

-- Check if user is club admin or higher
CREATE OR REPLACE FUNCTION public.is_club_admin_or_higher()
RETURNS boolean
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = ''
AS $$
  SELECT public.has_any_role(ARRAY['FACILITY_ADMIN', 'CLUB_ADMIN'])
$$;

-- Check if user is coach or higher
CREATE OR REPLACE FUNCTION public.is_coach_or_higher()
RETURNS boolean
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = ''
AS $$
  SELECT public.has_any_role(ARRAY['FACILITY_ADMIN', 'CLUB_ADMIN', 'COACH'])
$$;

-- =============================================================================
-- Grant Permissions
-- =============================================================================

GRANT EXECUTE ON FUNCTION public.get_current_facility_id TO authenticated;
GRANT EXECUTE ON FUNCTION public.get_current_club_id TO authenticated;
GRANT EXECUTE ON FUNCTION public.get_current_team_id TO authenticated;
GRANT EXECUTE ON FUNCTION public.has_role TO authenticated;
GRANT EXECUTE ON FUNCTION public.has_any_role TO authenticated;
GRANT EXECUTE ON FUNCTION public.is_facility_admin TO authenticated;
GRANT EXECUTE ON FUNCTION public.is_club_admin_or_higher TO authenticated;
GRANT EXECUTE ON FUNCTION public.is_coach_or_higher TO authenticated;

-- =============================================================================
-- Documentation
-- =============================================================================
--
-- Usage in RLS policies:
--
-- -- Facility-owned equipment visible to facility members
-- "facilityId" = (SELECT public.get_current_facility_id())
--
-- -- Club-owned equipment visible to club members
-- "clubId" = (SELECT public.get_current_club_id())
--
-- -- Only facility admins can modify
-- public.is_facility_admin()
--
-- -- Coaches and above can edit
-- public.is_coach_or_higher()
--
-- NOTE: These functions read from JWT claims, which are set by the
-- custom_access_token_hook. JWT claims are immutable per request and
-- safe for use with connection pooling (Supavisor transaction mode).
```
  </action>
  <verify>File exists at supabase/migrations/00005_facility_rls_helpers.sql</verify>
  <done>SQL migration file created with all helper functions</done>
</task>

<task type="auto">
  <name>Task 2: Apply RLS helper functions to database</name>
  <files>supabase/migrations/00005_facility_rls_helpers.sql</files>
  <action>
Run the SQL migration in Supabase:

Option A - If using Supabase CLI:
```bash
supabase db push
```

Option B - If using Supabase Dashboard:
1. Open Supabase Dashboard -> SQL Editor
2. Copy contents of supabase/migrations/00005_facility_rls_helpers.sql
3. Run the SQL

Verify functions were created by running this query in SQL Editor:
```sql
SELECT routine_name
FROM information_schema.routines
WHERE routine_schema = 'public'
  AND routine_name IN (
    'get_current_facility_id',
    'get_current_club_id',
    'get_current_team_id',
    'has_role',
    'has_any_role',
    'is_facility_admin',
    'is_club_admin_or_higher',
    'is_coach_or_higher'
  );
```

Should return 8 rows.
  </action>
  <verify>
Run verification query - returns 8 functions:
- get_current_facility_id
- get_current_club_id
- get_current_team_id
- has_role
- has_any_role
- is_facility_admin
- is_club_admin_or_higher
- is_coach_or_higher
  </verify>
  <done>All 8 helper functions exist in database</done>
</task>

</tasks>

<verification>
- SQL file exists at supabase/migrations/00005_facility_rls_helpers.sql
- All 8 functions created in public schema
- Functions are granted to authenticated role
- Functions use STABLE and SECURITY DEFINER correctly
</verification>

<success_criteria>
- get_current_facility_id() returns UUID from JWT claims
- get_current_club_id() returns UUID from JWT claims
- get_current_team_id() aliases get_current_club_id() for backward compat
- has_role(text) checks if role in JWT user_roles array
- has_any_role(text[]) checks if any role matches
- is_facility_admin(), is_club_admin_or_higher(), is_coach_or_higher() convenience functions work
- All functions are connection-pooling safe (read from JWT, not session vars)
</success_criteria>

<output>
After completion, create `.planning/phases/12-facility-schema-migration/12-02-SUMMARY.md`
</output>
