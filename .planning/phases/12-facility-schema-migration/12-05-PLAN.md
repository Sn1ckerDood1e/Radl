---
phase: 12-facility-schema-migration
plan: 05
type: execute
wave: 3
depends_on: ["12-01", "12-02"]
files_modified:
  - supabase/migrations/00008_facility_rls_policies.sql
autonomous: true

must_haves:
  truths:
    - "Facility table has RLS enabled and enforced"
    - "FacilityMembership table has RLS enabled and enforced"
    - "Equipment RLS supports hierarchical ownership (FACILITY, CLUB, TEAM)"
    - "Shared equipment visible to facility members"
  artifacts:
    - path: "supabase/migrations/00008_facility_rls_policies.sql"
      provides: "RLS policies for facility hierarchy"
      contains: "CREATE POLICY.*facility"
  key_links:
    - from: "Equipment RLS"
      to: "ownerType"
      via: "CASE statement checking ownership level"
      pattern: "CASE.*ownerType"
    - from: "Facility RLS"
      to: "get_current_facility_id"
      via: "Helper function call"
      pattern: "get_current_facility_id"
---

<objective>
Create RLS policies for facility hierarchy

Purpose: RLS enforces tenant isolation at database level. Policies ensure users only see data from their facility/club/team based on ownership hierarchy.
Output: SQL migration with RLS policies for Facility, FacilityMembership, and updated Equipment
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-facility-schema-migration/12-RESEARCH.md
@supabase/migrations/00004_equipment_rls.sql
@supabase/migrations/00005_facility_rls_helpers.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RLS policies SQL migration</name>
  <files>supabase/migrations/00008_facility_rls_policies.sql</files>
  <action>
Create supabase/migrations/00008_facility_rls_policies.sql with:

```sql
-- RLS Policies for Facility Hierarchy
-- Run this in Supabase SQL Editor after helper functions and data migration

-- =============================================================================
-- Enable RLS on New Tables
-- =============================================================================

ALTER TABLE "Facility" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "FacilityMembership" ENABLE ROW LEVEL SECURITY;

-- =============================================================================
-- Facility Policies
-- =============================================================================

-- Users can view facilities they belong to:
-- 1. Facility matches their JWT facility_id claim
-- 2. They have FacilityMembership in that facility
-- 3. They have ClubMembership in a club under that facility
CREATE POLICY "facility_select" ON "Facility"
  FOR SELECT
  TO authenticated
  USING (
    -- Direct match via JWT claim
    id = (SELECT public.get_current_facility_id())
    -- Or membership in facility
    OR EXISTS (
      SELECT 1 FROM "FacilityMembership" fm
      WHERE fm."facilityId" = "Facility".id
        AND fm."userId" = auth.uid()::text
        AND fm."isActive" = true
    )
    -- Or membership in a club under this facility
    OR EXISTS (
      SELECT 1 FROM "ClubMembership" cm
      JOIN "Team" t ON t.id = cm."clubId"
      WHERE t."facilityId" = "Facility".id
        AND cm."userId" = auth.uid()::text
        AND cm."isActive" = true
    )
  );

-- Only facility admins can update facility
CREATE POLICY "facility_update" ON "Facility"
  FOR UPDATE
  TO authenticated
  USING (
    id = (SELECT public.get_current_facility_id())
    AND public.is_facility_admin()
  )
  WITH CHECK (
    id = (SELECT public.get_current_facility_id())
    AND public.is_facility_admin()
  );

-- Insert handled via service role (facility creation flow)
-- No direct insert policy for users

-- =============================================================================
-- FacilityMembership Policies
-- =============================================================================

-- Users can view memberships in their facility
CREATE POLICY "facility_membership_select" ON "FacilityMembership"
  FOR SELECT
  TO authenticated
  USING (
    "facilityId" = (SELECT public.get_current_facility_id())
  );

-- Only facility admins can manage memberships
CREATE POLICY "facility_membership_insert" ON "FacilityMembership"
  FOR INSERT
  TO authenticated
  WITH CHECK (
    "facilityId" = (SELECT public.get_current_facility_id())
    AND public.is_facility_admin()
  );

CREATE POLICY "facility_membership_update" ON "FacilityMembership"
  FOR UPDATE
  TO authenticated
  USING (
    "facilityId" = (SELECT public.get_current_facility_id())
    AND public.is_facility_admin()
  )
  WITH CHECK (
    "facilityId" = (SELECT public.get_current_facility_id())
    AND public.is_facility_admin()
  );

CREATE POLICY "facility_membership_delete" ON "FacilityMembership"
  FOR DELETE
  TO authenticated
  USING (
    "facilityId" = (SELECT public.get_current_facility_id())
    AND public.is_facility_admin()
  );

-- =============================================================================
-- Update Equipment Policies for Hierarchical Ownership
-- =============================================================================

-- Drop existing equipment policies to replace with hierarchical ones
DROP POLICY IF EXISTS "equipment_select" ON "Equipment";
DROP POLICY IF EXISTS "equipment_insert" ON "Equipment";
DROP POLICY IF EXISTS "equipment_update" ON "Equipment";
DROP POLICY IF EXISTS "equipment_delete" ON "Equipment";

-- Equipment SELECT: Hierarchical visibility based on ownerType
CREATE POLICY "equipment_select" ON "Equipment"
  FOR SELECT
  TO authenticated
  USING (
    -- Legacy/Team-owned: visible to club/team members
    (
      ("ownerType" IS NULL OR "ownerType" = 'TEAM')
      AND (
        "teamId" = (SELECT public.get_current_club_id())
        OR "clubId" = (SELECT public.get_current_club_id())
      )
    )
    -- Club-owned: visible to club members
    OR (
      "ownerType" = 'CLUB'
      AND "clubId" = (SELECT public.get_current_club_id())
    )
    -- Facility-owned: visible to all facility members
    OR (
      "ownerType" = 'FACILITY'
      AND "facilityId" = (SELECT public.get_current_facility_id())
    )
    -- Shared club equipment: visible to facility members
    OR (
      "ownerType" = 'CLUB'
      AND "isShared" = true
      AND EXISTS (
        SELECT 1 FROM "Team" t
        WHERE t.id = "Equipment"."clubId"
          AND t."facilityId" = (SELECT public.get_current_facility_id())
      )
    )
  );

-- Equipment INSERT: Based on target ownership
CREATE POLICY "equipment_insert" ON "Equipment"
  FOR INSERT
  TO authenticated
  WITH CHECK (
    -- Club/team equipment: coach or higher in the club
    (
      ("ownerType" IN ('CLUB', 'TEAM') OR "ownerType" IS NULL)
      AND (
        "clubId" = (SELECT public.get_current_club_id())
        OR "teamId" = (SELECT public.get_current_club_id())
      )
      AND public.is_coach_or_higher()
    )
    -- Facility equipment: facility admin only
    OR (
      "ownerType" = 'FACILITY'
      AND "facilityId" = (SELECT public.get_current_facility_id())
      AND public.is_facility_admin()
    )
  );

-- Equipment UPDATE: Based on ownership
CREATE POLICY "equipment_update" ON "Equipment"
  FOR UPDATE
  TO authenticated
  USING (
    -- Club/team equipment: coach or higher can update
    (
      ("ownerType" IN ('CLUB', 'TEAM') OR "ownerType" IS NULL)
      AND (
        "clubId" = (SELECT public.get_current_club_id())
        OR "teamId" = (SELECT public.get_current_club_id())
      )
      AND public.is_coach_or_higher()
    )
    -- Facility equipment: facility admin can update
    OR (
      "ownerType" = 'FACILITY'
      AND "facilityId" = (SELECT public.get_current_facility_id())
      AND public.is_facility_admin()
    )
  )
  WITH CHECK (
    -- Same rules for new values
    (
      ("ownerType" IN ('CLUB', 'TEAM') OR "ownerType" IS NULL)
      AND (
        "clubId" = (SELECT public.get_current_club_id())
        OR "teamId" = (SELECT public.get_current_club_id())
      )
      AND public.is_coach_or_higher()
    )
    OR (
      "ownerType" = 'FACILITY'
      AND "facilityId" = (SELECT public.get_current_facility_id())
      AND public.is_facility_admin()
    )
  );

-- Equipment DELETE: Based on ownership
CREATE POLICY "equipment_delete" ON "Equipment"
  FOR DELETE
  TO authenticated
  USING (
    -- Club/team equipment: coach or higher can delete
    (
      ("ownerType" IN ('CLUB', 'TEAM') OR "ownerType" IS NULL)
      AND (
        "clubId" = (SELECT public.get_current_club_id())
        OR "teamId" = (SELECT public.get_current_club_id())
      )
      AND public.is_coach_or_higher()
    )
    -- Facility equipment: facility admin can delete
    OR (
      "ownerType" = 'FACILITY'
      AND "facilityId" = (SELECT public.get_current_facility_id())
      AND public.is_facility_admin()
    )
  );

-- =============================================================================
-- Documentation
-- =============================================================================
--
-- Equipment Visibility Rules:
--   - TEAM-owned: Only visible to that team/club's members
--   - CLUB-owned: Only visible to that club's members
--   - FACILITY-owned: Visible to ALL clubs in the facility
--   - CLUB-owned + isShared: Visible to ALL clubs in the facility
--
-- Equipment Modification Rules:
--   - TEAM/CLUB-owned: COACH or higher in that club
--   - FACILITY-owned: FACILITY_ADMIN only
--
-- This enables scenarios like:
--   - Chattanooga Rowing (facility) owns 8 boats visible to all clubs
--   - Lookout Rowing Club owns 4 boats visible only to their members
--   - LRC marks 1 boat as "shared" so Chattanooga Juniors can also see/use it
```
  </action>
  <verify>File exists at supabase/migrations/00008_facility_rls_policies.sql</verify>
  <done>RLS policies SQL file created</done>
</task>

<task type="auto">
  <name>Task 2: Apply RLS policies to database</name>
  <files>supabase/migrations/00008_facility_rls_policies.sql</files>
  <action>
Run the RLS migration in Supabase SQL Editor:

1. Open Supabase Dashboard -> SQL Editor
2. Copy contents of supabase/migrations/00008_facility_rls_policies.sql
3. Run the SQL

Verify RLS is enabled and policies created:

```sql
-- Check RLS is enabled on tables
SELECT
  schemaname,
  tablename,
  rowsecurity
FROM pg_tables
WHERE schemaname = 'public'
  AND tablename IN ('Facility', 'FacilityMembership', 'Equipment');

-- Check policies exist
SELECT
  schemaname,
  tablename,
  policyname,
  cmd
FROM pg_policies
WHERE schemaname = 'public'
  AND tablename IN ('Facility', 'FacilityMembership', 'Equipment')
ORDER BY tablename, policyname;
```
  </action>
  <verify>
1. All three tables show rowsecurity = true
2. Facility has facility_select, facility_update policies
3. FacilityMembership has 4 policies (select, insert, update, delete)
4. Equipment has 4 policies (select, insert, update, delete) with hierarchical logic
  </verify>
  <done>RLS policies applied and verified</done>
</task>

</tasks>

<verification>
- SQL file exists at supabase/migrations/00008_facility_rls_policies.sql
- RLS enabled on Facility, FacilityMembership tables
- Equipment RLS policies updated for hierarchical ownership
- Policies use helper functions (get_current_facility_id, is_facility_admin, etc.)
</verification>

<success_criteria>
- Facility table: RLS enabled, select/update policies working
- FacilityMembership table: RLS enabled, full CRUD policies working
- Equipment table: RLS policies check ownerType for visibility
- FACILITY-owned equipment visible to all facility members
- CLUB-owned + isShared equipment visible to facility members
- TEAM/CLUB-owned equipment restricted to club members
- Only FACILITY_ADMIN can manage facility-owned equipment
- Only COACH+ can manage club/team-owned equipment
</success_criteria>

<output>
After completion, create `.planning/phases/12-facility-schema-migration/12-05-SUMMARY.md`
</output>
