---
phase: 15-mobile-pwa-improvements
plan: 05
type: execute
wave: 3
depends_on: ["15-02", "15-03", "15-04"]
files_modified:
  - src/components/pwa/install-banner.tsx
  - src/hooks/use-pwa-install.ts
  - src/app/globals.css
autonomous: true

must_haves:
  truths:
    - "iOS users see manual Add to Home Screen instructions"
    - "Android/Chrome users see install prompt via beforeinstallprompt"
    - "Install prompt is dismissible and respects 30-day cooldown"
    - "Mobile viewport CSS ensures proper responsive behavior"
  artifacts:
    - path: "src/hooks/use-pwa-install.ts"
      provides: "Hook for PWA installation state and prompt handling"
      exports: ["usePwaInstall"]
    - path: "src/components/pwa/install-banner.tsx"
      provides: "Enhanced install banner with iOS instructions"
      exports: ["InstallBanner"]
  key_links:
    - from: "src/components/pwa/install-banner.tsx"
      to: "src/hooks/use-pwa-install.ts"
      via: "import usePwaInstall"
      pattern: "usePwaInstall"
---

<objective>
Enhance PWA install experience with iOS-specific instructions and ensure mobile responsive CSS is complete.

Purpose: iOS Safari doesn't support beforeinstallprompt, so users need manual "Add to Home Screen" instructions. Additionally, ensure all mobile CSS foundations are in place for consistent responsive behavior.
Output: Enhanced install banner with iOS support, usePwaInstall hook, mobile CSS utilities.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/15-mobile-pwa-improvements/15-CONTEXT.md
@.planning/phases/15-mobile-pwa-improvements/15-RESEARCH.md
@src/components/pwa/install-banner.tsx (current implementation)
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usePwaInstall hook</name>
  <files>src/hooks/use-pwa-install.ts</files>
  <action>
    Extract PWA install logic from install-banner.tsx into a reusable hook.

    The hook should:
    1. Capture beforeinstallprompt event (Chromium browsers)
    2. Detect iOS devices (no beforeinstallprompt support)
    3. Check if already installed (standalone mode)
    4. Manage dismiss state with localStorage (30-day cooldown)

    Interface:
    ```typescript
    interface UsePwaInstallReturn {
      canInstall: boolean;        // True if install prompt is available
      isInstalled: boolean;       // True if running as installed PWA
      isIOS: boolean;             // True if iOS device (needs manual instructions)
      isDismissed: boolean;       // True if user dismissed within 30 days
      promptInstall: () => Promise<'accepted' | 'dismissed' | null>;
      dismiss: () => void;        // Dismiss and set cooldown
    }
    ```

    Implementation notes:
    - iOS detection: /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream
    - Standalone check: window.matchMedia('(display-mode: standalone)').matches OR navigator.standalone (iOS)
    - Store dismiss timestamp in localStorage with key 'rowops-install-dismissed'
    - Check if dismissed within DISMISS_DURATION_DAYS (30 days)

    The promptInstall function should:
    1. If no deferred prompt, return null
    2. Call deferredPrompt.prompt()
    3. Await deferredPrompt.userChoice
    4. If dismissed, call dismiss() to set cooldown
    5. Return outcome ('accepted' | 'dismissed')

    Export as named export: `export function usePwaInstall()`
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>usePwaInstall hook handles install prompt, iOS detection, and dismiss state</done>
</task>

<task type="auto">
  <name>Task 2: Enhance InstallBanner with iOS instructions</name>
  <files>src/components/pwa/install-banner.tsx</files>
  <action>
    Refactor the existing InstallBanner component to use usePwaInstall hook and add iOS-specific instructions.

    Changes:
    1. Replace inline state management with usePwaInstall hook
    2. Add iOS-specific UI when isIOS is true

    iOS instructions UI:
    - Show "Install RowOps" title
    - Show step-by-step instructions:
      1. "Tap the Share button" (with Share icon)
      2. "Scroll down and tap 'Add to Home Screen'"
      3. "Tap 'Add' to install"
    - Include visual icons for each step
    - Use a different button: "Got it" instead of "Install"

    Android/Chrome UI (existing):
    - Keep current design with "Install" button that triggers native prompt
    - Use promptInstall from hook

    Visibility logic:
    - Don't show if isInstalled
    - Don't show if isDismissed
    - Show if isIOS (with instructions) OR canInstall (with prompt button)

    The banner should use the existing bottom sheet style from current implementation.
    Remove the duplicate helper functions (isStandalone, isDismissed, saveDismissal) and use hook instead.

    Keep the existing:
    - DISMISS_STORAGE_KEY constant (or move to hook)
    - Bottom-fixed positioning
    - Current visual design (app icon, styling)
  </action>
  <verify>Banner shows correct UI for iOS vs Android</verify>
  <done>InstallBanner uses usePwaInstall hook and shows iOS instructions when appropriate</done>
</task>

<task type="auto">
  <name>Task 3: Add mobile CSS utilities</name>
  <files>src/app/globals.css</files>
  <action>
    Add CSS utilities for mobile responsiveness if not already present.

    Add the following to globals.css (after existing content):

    ```css
    /* =============================================================================
       Mobile PWA Utilities
       ============================================================================= */

    /* Safe area insets for notched devices (iPhone X+) */
    .safe-area-inset-top {
      padding-top: env(safe-area-inset-top);
    }

    .safe-area-inset-bottom {
      padding-bottom: env(safe-area-inset-bottom);
    }

    /* Prevent pull-to-refresh on PWA (optional, can cause issues) */
    .no-overscroll {
      overscroll-behavior: none;
    }

    /* Mobile viewport height fix (100vh issues on mobile browsers) */
    .min-h-screen-mobile {
      min-height: 100vh;
      min-height: 100dvh;
    }

    /* Touch manipulation for swipeable elements */
    .touch-pan-y {
      touch-action: pan-y;
    }

    .touch-pan-x {
      touch-action: pan-x;
    }

    /* Mobile-friendly focus styles */
    @media (max-width: 767px) {
      /* Remove tap highlight on mobile */
      button, a, [role="button"] {
        -webkit-tap-highlight-color: transparent;
      }

      /* Ensure dialogs and drawers respect safe areas */
      [data-radix-popper-content-wrapper] {
        padding-bottom: env(safe-area-inset-bottom);
      }
    }
    ```

    These utilities support:
    - Safe area handling for notched phones
    - Mobile viewport height fixes
    - Touch action controls for gesture handling
    - Removal of tap highlight color
  </action>
  <verify>CSS file contains mobile utilities</verify>
  <done>Mobile CSS utilities added to globals.css</done>
</task>

</tasks>

<verification>
1. `cat src/hooks/use-pwa-install.ts` shows usePwaInstall hook
2. `cat src/components/pwa/install-banner.tsx` shows refactored component using hook
3. `grep -A 20 "Mobile PWA Utilities" src/app/globals.css` shows mobile CSS
4. `npm run build` completes without errors
5. Manual test:
   - iOS Safari: Shows manual Add to Home Screen instructions
   - Chrome Android: Shows install button that triggers native prompt
   - After dismissing: Banner doesn't reappear for 30 days
</verification>

<success_criteria>
- usePwaInstall hook cleanly encapsulates all PWA install logic
- iOS users see step-by-step Add to Home Screen instructions
- Android/Chrome users get native install prompt
- Mobile CSS utilities support safe areas and touch handling
- Install banner respects 30-day dismiss cooldown
</success_criteria>

<output>
After completion, create `.planning/phases/15-mobile-pwa-improvements/15-05-SUMMARY.md`
</output>
