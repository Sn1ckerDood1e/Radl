---
phase: 15-mobile-pwa-improvements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/use-sync-status.ts
  - src/components/pwa/sync-status-indicator.tsx
  - src/components/layout/dashboard-header.tsx
autonomous: true

must_haves:
  truths:
    - "Network indicator shows offline status when disconnected"
    - "Network indicator shows pending count when mutations are queued"
    - "Network indicator is hidden when online with no pending changes"
    - "Indicator is tappable to show sync queue details when issues exist"
  artifacts:
    - path: "src/hooks/use-sync-status.ts"
      provides: "Hook combining online status and sync queue state"
      exports: ["useSyncStatus"]
    - path: "src/components/pwa/sync-status-indicator.tsx"
      provides: "Header-integrated network status indicator"
      exports: ["SyncStatusIndicator"]
  key_links:
    - from: "src/hooks/use-sync-status.ts"
      to: "src/hooks/use-online-status.ts"
      via: "import useOnlineStatus"
      pattern: "useOnlineStatus"
    - from: "src/hooks/use-sync-status.ts"
      to: "src/lib/db/hooks.ts"
      via: "import useSyncQueueCount"
      pattern: "useSyncQueueCount"
    - from: "src/components/layout/dashboard-header.tsx"
      to: "src/components/pwa/sync-status-indicator.tsx"
      via: "import and render"
      pattern: "SyncStatusIndicator"
---

<objective>
Create an enhanced network status indicator for the header that shows offline/syncing/pending states.

Purpose: Users need clear visual feedback about their connectivity and sync status, especially when making changes offline that need to sync later.
Output: useSyncStatus hook, SyncStatusIndicator component, integrated into header.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/15-mobile-pwa-improvements/15-CONTEXT.md
@.planning/phases/15-mobile-pwa-improvements/15-RESEARCH.md
@src/hooks/use-online-status.ts
@src/lib/db/hooks.ts
@src/lib/db/sync-queue.ts
@src/components/pwa/sync-status.tsx (current basic implementation)
@src/components/layout/dashboard-header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSyncStatus hook</name>
  <files>src/hooks/use-sync-status.ts</files>
  <action>
    Create a hook that combines online status, sync state, and pending count.

    The hook should:
    1. Use existing useOnlineStatus() from src/hooks/use-online-status.ts
    2. Use useSyncQueueCount() from src/lib/db/hooks.ts
    3. Track syncing state (set to true when processSyncQueue is called)
    4. Track error state (set when sync fails)
    5. Compute a SyncState: 'online' | 'offline' | 'pending' | 'syncing' | 'error'

    State logic:
    - If !isOnline: state = 'offline'
    - If isSyncing: state = 'syncing'
    - If hasError: state = 'error'
    - If pendingCount > 0: state = 'pending'
    - Otherwise: state = 'online'

    Return type:
    ```typescript
    interface SyncStatusResult {
      isOnline: boolean;
      state: SyncState;
      pendingCount: number;
      hasPending: boolean;
      hasError: boolean;
      lastError: string | null;
      triggerSync: () => Promise<void>;
      clearError: () => void;
    }
    ```

    The triggerSync function should:
    1. Set isSyncing to true
    2. Call processSyncQueue() from src/lib/db/sync-queue.ts
    3. Handle errors by setting error state
    4. Set isSyncing to false when complete

    Export as named export: `export function useSyncStatus()`
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>useSyncStatus hook exists and returns online/pending/syncing/error state</done>
</task>

<task type="auto">
  <name>Task 2: Create SyncStatusIndicator component</name>
  <files>src/components/pwa/sync-status-indicator.tsx</files>
  <action>
    Create a header-integrated network status indicator component.

    Design requirements (from CONTEXT.md Decision 7):
    - Hidden when online and no pending changes (state === 'online')
    - Show when: offline, syncing, pending changes, sync error
    - Subtle pulse animation when pending changes
    - Tappable only when issues exist (shows sync queue info, retry option)

    Visual states:
    1. **Offline**: CloudOff icon, amber background, "Offline" text
    2. **Pending**: Cloud icon with badge, blue background, pulse animation, shows count
    3. **Syncing**: RefreshCw icon (spinning), blue background, "Syncing" text
    4. **Error**: AlertCircle icon, red background, "Sync failed" text

    When tapped (and has issues):
    - Use a Popover or simple dropdown showing:
      - Current status message
      - Pending count (if any)
      - Last error message (if error)
      - "Retry" button (calls triggerSync)
      - "Clear error" button (if error)

    Use Tailwind classes for styling:
    - Offline: bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-200
    - Pending/Syncing: bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200
    - Error: bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200
    - Use animate-pulse for pending state
    - Use animate-spin for syncing icon

    Component should be compact for header placement (h-8 max).
    Use lucide-react icons (Cloud, CloudOff, RefreshCw, AlertCircle).

    Export as named export: `export function SyncStatusIndicator()`
  </action>
  <verify>Component renders correctly in isolation</verify>
  <done>SyncStatusIndicator shows appropriate state and is tappable when issues exist</done>
</task>

<task type="auto">
  <name>Task 3: Integrate into dashboard header</name>
  <files>src/components/layout/dashboard-header.tsx</files>
  <action>
    Replace the basic SyncStatus component with the new SyncStatusIndicator.

    Changes:
    1. Remove import: `import { SyncStatus } from '@/components/pwa/sync-status';`
    2. Add import: `import { SyncStatusIndicator } from '@/components/pwa/sync-status-indicator';`
    3. Replace `<SyncStatus />` with `<SyncStatusIndicator />`

    The indicator should remain in the same position (right side of header, between ThemeToggle and NotificationBell).

    Keep all other header functionality unchanged.
  </action>
  <verify>Header renders with new SyncStatusIndicator component</verify>
  <done>Dashboard header uses SyncStatusIndicator instead of basic SyncStatus</done>
</task>

</tasks>

<verification>
1. `cat src/hooks/use-sync-status.ts` shows useSyncStatus hook with proper state logic
2. `cat src/components/pwa/sync-status-indicator.tsx` shows SyncStatusIndicator component
3. `cat src/components/layout/dashboard-header.tsx` imports SyncStatusIndicator
4. `npm run build` completes without errors
5. Manual test: Toggle network offline in DevTools, indicator should appear
</verification>

<success_criteria>
- useSyncStatus hook properly combines online status and sync queue state
- SyncStatusIndicator hidden when online with no pending
- SyncStatusIndicator visible with appropriate styling for offline/pending/syncing/error
- Indicator is tappable and shows details when issues exist
- Header successfully integrates new indicator
</success_criteria>

<output>
After completion, create `.planning/phases/15-mobile-pwa-improvements/15-02-SUMMARY.md`
</output>
