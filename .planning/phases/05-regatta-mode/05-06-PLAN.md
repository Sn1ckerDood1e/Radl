---
phase: 05-regatta-mode
plan: 06
type: execute
wave: 3
depends_on: ["05-04"]
files_modified:
  - supabase/functions/process-race-notifications/index.ts
  - src/lib/push/triggers.ts
autonomous: true
user_setup:
  - service: supabase
    why: "pg_cron extension for scheduled notification processing"
    dashboard_config:
      - task: "Enable pg_cron extension"
        location: "Supabase Dashboard -> Database -> Extensions -> pg_cron"
      - task: "Create cron job for notification processor"
        location: "Supabase Dashboard -> SQL Editor (run migration SQL)"

must_haves:
  truths:
    - "Notifications are processed automatically every 5 minutes"
    - "Athletes in lineup receive notification before race"
    - "Notification includes meeting location if set"
    - "Sent notifications are marked to prevent duplicates"
  artifacts:
    - path: "supabase/functions/process-race-notifications/index.ts"
      provides: "Cron-triggered notification processor"
      min_lines: 50
    - path: "src/lib/push/triggers.ts"
      provides: "notifyRaceReminder trigger function"
      contains: "notifyRaceReminder"
  key_links:
    - from: "pg_cron"
      to: "process-race-notifications"
      via: "HTTP POST every 5 minutes"
      pattern: "http_post.*process-race-notifications"
    - from: "process-race-notifications"
      to: "send-notification"
      via: "supabase.functions.invoke"
      pattern: "functions\\.invoke.*send-notification"
---

<objective>
Implement scheduled race notifications using Supabase pg_cron and Edge Functions.

Purpose: Enables REG-05 (race notifications) with configurable timing before races.
Output: Edge Function for notification processing, pg_cron job, and race reminder trigger.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-regatta-mode/05-RESEARCH.md

# Prior plan output
@.planning/phases/05-regatta-mode/05-04-SUMMARY.md

# Existing notification infrastructure
@src/lib/push/triggers.ts
@supabase/functions/send-notification/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create race notification processor Edge Function</name>
  <files>supabase/functions/process-race-notifications/index.ts</files>
  <action>
Create supabase/functions/process-race-notifications/index.ts:

```typescript
// Supabase Edge Function for processing scheduled race notifications
// Triggered by pg_cron every 5 minutes
//
// This function:
// 1. Finds NotificationConfig records due in the next 5 minutes
// 2. Gets athletes in the entry's lineup
// 3. Sends push notification via send-notification function
// 4. Marks notifications as sent

// @ts-expect-error Deno imports not recognized by TypeScript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
// @ts-expect-error Deno imports not recognized by TypeScript
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

interface NotificationWithEntry {
  id: string;
  entryId: string;
  leadTimeMinutes: number;
  entry: {
    eventName: string;
    scheduledTime: string;
    meetingLocation: string | null;
    regatta: {
      id: string;
      name: string;
      teamId: string;
      timezone: string | null;
    };
  };
}

interface EntrySeat {
  athlete: {
    teamMember: {
      userId: string;
    };
  };
}

serve(async (req: Request) => {
  try {
    // Only allow POST requests (from cron or direct invocation)
    if (req.method !== 'POST') {
      return new Response(JSON.stringify({ error: 'Method not allowed' }), {
        status: 405,
        headers: { 'Content-Type': 'application/json' },
      });
    }

    // Get Supabase credentials
    const supabaseUrl = Deno.env.get('SUPABASE_URL');
    const supabaseKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY');

    if (!supabaseUrl || !supabaseKey) {
      return new Response(
        JSON.stringify({ error: 'Supabase configuration missing' }),
        { status: 500, headers: { 'Content-Type': 'application/json' } }
      );
    }

    const supabase = createClient(supabaseUrl, supabaseKey);

    // Find notifications due in the next 5 minutes
    const now = new Date();
    const fiveMinutesFromNow = new Date(now.getTime() + 5 * 60 * 1000);

    const { data: dueNotifications, error: fetchError } = await supabase
      .from('NotificationConfig')
      .select(`
        id,
        entryId,
        leadTimeMinutes,
        entry:Entry(
          eventName,
          scheduledTime,
          meetingLocation,
          regatta:Regatta(
            id,
            name,
            teamId,
            timezone
          )
        )
      `)
      .eq('notificationSent', false)
      .not('scheduledFor', 'is', null)
      .lte('scheduledFor', fiveMinutesFromNow.toISOString())
      .gte('scheduledFor', now.toISOString());

    if (fetchError) {
      console.error('Error fetching notifications:', fetchError);
      return new Response(
        JSON.stringify({ error: 'Failed to fetch notifications' }),
        { status: 500, headers: { 'Content-Type': 'application/json' } }
      );
    }

    if (!dueNotifications || dueNotifications.length === 0) {
      return new Response(
        JSON.stringify({ processed: 0, message: 'No notifications due' }),
        { headers: { 'Content-Type': 'application/json' } }
      );
    }

    console.log(`Processing ${dueNotifications.length} race notifications`);

    let successCount = 0;
    let failCount = 0;

    // Process each notification
    for (const notification of dueNotifications as unknown as NotificationWithEntry[]) {
      try {
        const entry = notification.entry;
        const regatta = entry.regatta;

        // Get athletes in the lineup for this entry
        const { data: lineup } = await supabase
          .from('EntryLineup')
          .select(`
            seats:EntrySeat(
              athlete:AthleteProfile(
                teamMember:TeamMember(
                  userId
                )
              )
            )
          `)
          .eq('entryId', notification.entryId)
          .single();

        if (!lineup || !lineup.seats || lineup.seats.length === 0) {
          console.log(`No lineup for entry ${notification.entryId}, skipping notification`);
          // Mark as sent to prevent reprocessing
          await supabase
            .from('NotificationConfig')
            .update({ notificationSent: true, sentAt: new Date().toISOString() })
            .eq('id', notification.id);
          continue;
        }

        // Extract user IDs from lineup
        const userIds = (lineup.seats as EntrySeat[])
          .map((s) => s.athlete?.teamMember?.userId)
          .filter(Boolean);

        if (userIds.length === 0) {
          console.log(`No user IDs for entry ${notification.entryId}`);
          await supabase
            .from('NotificationConfig')
            .update({ notificationSent: true, sentAt: new Date().toISOString() })
            .eq('id', notification.id);
          continue;
        }

        // Format race time
        const raceTime = new Date(entry.scheduledTime);
        const timeStr = raceTime.toLocaleTimeString('en-US', {
          hour: 'numeric',
          minute: '2-digit',
          timeZone: regatta.timezone || 'America/New_York',
        });

        // Build notification body
        let body = `Race at ${timeStr}`;
        if (entry.meetingLocation) {
          body = `Meet at ${entry.meetingLocation} - Race at ${timeStr}`;
        }

        // Send notification via existing send-notification function
        const { error: sendError } = await supabase.functions.invoke('send-notification', {
          body: {
            teamId: regatta.teamId,
            userIds,
            title: `Race Reminder: ${entry.eventName}`,
            body,
            url: `/regattas/${regatta.id}`,
            tag: `race-${notification.entryId}`,
          },
        });

        if (sendError) {
          console.error(`Failed to send notification for entry ${notification.entryId}:`, sendError);
          failCount++;
          continue;
        }

        // Mark notification as sent
        await supabase
          .from('NotificationConfig')
          .update({
            notificationSent: true,
            sentAt: new Date().toISOString(),
          })
          .eq('id', notification.id);

        console.log(`Sent race notification for ${entry.eventName} to ${userIds.length} athletes`);
        successCount++;
      } catch (err) {
        console.error(`Error processing notification ${notification.id}:`, err);
        failCount++;
      }
    }

    return new Response(
      JSON.stringify({
        processed: dueNotifications.length,
        success: successCount,
        failed: failCount,
      }),
      { headers: { 'Content-Type': 'application/json' } }
    );
  } catch (err) {
    console.error('Edge function error:', err);
    return new Response(
      JSON.stringify({ error: 'Internal server error' }),
      { status: 500, headers: { 'Content-Type': 'application/json' } }
    );
  }
});
```
  </action>
  <verify>Check file syntax is valid TypeScript</verify>
  <done>Race notification processor Edge Function created</done>
</task>

<task type="auto">
  <name>Task 2: Add notifyRaceReminder trigger for manual notifications</name>
  <files>src/lib/push/triggers.ts</files>
  <action>
Add the following function to src/lib/push/triggers.ts (at the end of the file):

```typescript
/**
 * Notify athletes about an upcoming race (manual trigger).
 * Used for ad-hoc race reminders outside the automated schedule.
 *
 * @param teamId - Team ID for notification routing
 * @param athleteUserIds - User IDs of athletes to notify
 * @param eventName - Name of the event/race
 * @param raceTime - Scheduled race time
 * @param meetingLocation - Optional meeting location
 * @param regattaId - Regatta ID for URL
 * @param entryId - Entry ID for tag
 */
export function notifyRaceReminder(
  teamId: string,
  athleteUserIds: string[],
  eventName: string,
  raceTime: Date,
  meetingLocation: string | null,
  regattaId: string,
  entryId: string
): void {
  if (athleteUserIds.length === 0) return;

  const timeStr = raceTime.toLocaleTimeString('en-US', {
    hour: 'numeric',
    minute: '2-digit',
  });

  let body = `Race at ${timeStr}`;
  if (meetingLocation) {
    body = `Meet at ${meetingLocation} - Race at ${timeStr}`;
  }

  sendNotification({
    teamId,
    userIds: athleteUserIds,
    title: `Race Reminder: ${eventName}`,
    body,
    url: `/regattas/${regattaId}`,
    tag: `race-${entryId}`,
  });
}
```
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors</verify>
  <done>Manual race reminder trigger added to existing triggers file</done>
</task>

<task type="auto">
  <name>Task 3: Create pg_cron setup migration</name>
  <files>supabase/migrations/20260121_race_notifications_cron.sql</files>
  <action>
Create supabase/migrations/20260121_race_notifications_cron.sql:

```sql
-- Enable pg_cron extension (if not already enabled)
-- Note: This must be run by a superuser or via Supabase dashboard
-- CREATE EXTENSION IF NOT EXISTS pg_cron;

-- Enable pg_net extension for HTTP calls (if not already enabled)
-- CREATE EXTENSION IF NOT EXISTS pg_net;

-- Schedule the race notification processor to run every 5 minutes
-- This calls the process-race-notifications Edge Function
--
-- To set up:
-- 1. Enable pg_cron and pg_net extensions in Supabase dashboard
-- 2. Run this SQL in the SQL editor with proper credentials
--
-- Note: Replace <your-project-ref> with your Supabase project reference
-- The service role key should be set via Supabase secrets, not hardcoded

/*
SELECT cron.schedule(
  'process-race-notifications',
  '*/5 * * * *',  -- Every 5 minutes
  $$
  SELECT net.http_post(
    url := 'https://<your-project-ref>.supabase.co/functions/v1/process-race-notifications',
    headers := jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer ' || current_setting('app.settings.service_role_key', true)
    ),
    body := '{}'::jsonb
  );
  $$
);
*/

-- To check scheduled jobs:
-- SELECT * FROM cron.job;

-- To unschedule:
-- SELECT cron.unschedule('process-race-notifications');

-- Alternative: Use Supabase scheduled Edge Function (if available)
-- This can be configured in supabase/config.toml:
--
-- [functions.process-race-notifications]
-- schedule = "*/5 * * * *"
```

Also create a README for the cron setup at supabase/CRON_SETUP.md:

```markdown
# Race Notifications Cron Setup

The race notification system uses pg_cron to trigger the `process-race-notifications` Edge Function every 5 minutes.

## Setup Steps

### 1. Enable Extensions

In Supabase Dashboard -> Database -> Extensions:
- Enable `pg_cron`
- Enable `pg_net`

### 2. Deploy the Edge Function

```bash
supabase functions deploy process-race-notifications
```

### 3. Create the Cron Job

In Supabase Dashboard -> SQL Editor, run:

```sql
-- Replace YOUR_PROJECT_REF with your project reference (e.g., abcdefghijkl)
SELECT cron.schedule(
  'process-race-notifications',
  '*/5 * * * *',
  $$
  SELECT net.http_post(
    url := 'https://YOUR_PROJECT_REF.supabase.co/functions/v1/process-race-notifications',
    headers := jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer ' || current_setting('supabase.service_role_key', true)
    ),
    body := '{}'::jsonb
  );
  $$
);
```

### 4. Verify Setup

Check that the job is scheduled:

```sql
SELECT * FROM cron.job WHERE jobname = 'process-race-notifications';
```

View recent executions:

```sql
SELECT * FROM cron.job_run_details
WHERE jobid = (SELECT jobid FROM cron.job WHERE jobname = 'process-race-notifications')
ORDER BY start_time DESC
LIMIT 10;
```

## How It Works

1. **Every 5 minutes**: pg_cron triggers the Edge Function
2. **Edge Function queries**: Finds `NotificationConfig` records where:
   - `notificationSent = false`
   - `scheduledFor` is within the next 5 minutes
3. **For each due notification**:
   - Gets athletes in the entry's lineup
   - Calls `send-notification` Edge Function
   - Marks `notificationSent = true`

## Troubleshooting

### Notifications not sending

1. Check cron job is running: `SELECT * FROM cron.job_run_details ORDER BY start_time DESC LIMIT 5;`
2. Check Edge Function logs in Supabase dashboard
3. Verify `scheduledFor` is set correctly on NotificationConfig records
4. Ensure VAPID keys are configured for push notifications

### Duplicate notifications

The `notificationSent` flag prevents duplicates. If you see duplicates:
1. Check if the flag is being set to `true` after sending
2. Verify there's no race condition in the Edge Function

### Testing

Manually invoke the Edge Function:

```bash
supabase functions invoke process-race-notifications --no-verify-jwt
```
```
  </action>
  <verify>Files created with correct SQL syntax</verify>
  <done>pg_cron setup migration and documentation created</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Edge Function file is syntactically valid
3. Migration SQL is valid
4. Documentation explains setup steps clearly
5. notifyRaceReminder function added to triggers.ts
</verification>

<success_criteria>
- Edge Function processes notifications due in next 5 minutes
- Function queries NotificationConfig where scheduledFor is upcoming
- Athletes in lineup receive notification via send-notification
- Notification includes meeting location if set
- notificationSent flag prevents duplicate sends
- Manual notifyRaceReminder trigger available for ad-hoc use
- pg_cron setup documented with SQL and instructions
- REG-05 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/05-regatta-mode/05-06-SUMMARY.md`
</output>
