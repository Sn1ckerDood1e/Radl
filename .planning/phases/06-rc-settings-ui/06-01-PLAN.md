---
phase: 06-rc-settings-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - prisma/schema.prisma
  - src/app/(dashboard)/layout.tsx
  - src/app/api/regatta-central/auto-sync/route.ts
autonomous: true

must_haves:
  truths:
    - "Sonner toasts display correctly when triggered"
    - "Auto-sync API accepts PATCH with enabled boolean"
    - "Schema has autoSyncEnabled field on RegattaCentralConnection"
  artifacts:
    - path: "src/app/api/regatta-central/auto-sync/route.ts"
      provides: "Auto-sync toggle endpoint"
      exports: ["PATCH"]
    - path: "prisma/schema.prisma"
      provides: "autoSyncEnabled field"
      contains: "autoSyncEnabled"
  key_links:
    - from: "src/app/api/regatta-central/auto-sync/route.ts"
      to: "prisma.regattaCentralConnection"
      via: "update query"
      pattern: "prisma\\.regattaCentralConnection\\.update"
---

<objective>
Set up toast infrastructure and auto-sync API for RC settings UI.

Purpose: Sonner provides user feedback for all RC operations; auto-sync toggle needs a backend endpoint.
Output: Sonner configured, schema updated with autoSyncEnabled field, auto-sync API route ready.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-rc-settings-ui/06-RESEARCH.md

# Existing patterns
@src/app/api/regatta-central/status/route.ts
@src/app/api/regatta-central/connect/route.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Sonner and configure Toaster</name>
  <files>package.json, src/app/(dashboard)/layout.tsx</files>
  <action>
1. Install sonner:
   ```bash
   npm install sonner
   ```

2. Add Toaster to the dashboard layout (src/app/(dashboard)/layout.tsx):
   - Import `Toaster` from 'sonner'
   - Add `<Toaster />` component after children with these props:
     - position="bottom-right"
     - richColors
     - closeButton
     - theme="dark" (matches app theme)
   - Place it inside the fragment, after children

This enables toast notifications throughout the dashboard for RC operations.
  </action>
  <verify>
1. Run `npm ls sonner` - should show sonner installed
2. Check layout.tsx contains Toaster import and component
  </verify>
  <done>Sonner installed, Toaster added to dashboard layout with dark theme styling</done>
</task>

<task type="auto">
  <name>Task 2: Add autoSyncEnabled to schema and create API route</name>
  <files>prisma/schema.prisma, src/app/api/regatta-central/auto-sync/route.ts</files>
  <action>
1. Update prisma/schema.prisma - add to RegattaCentralConnection model:
   ```prisma
   autoSyncEnabled Boolean   @default(false)
   ```
   Place it after `lastSyncAt` field.

2. Run schema migration:
   ```bash
   npx prisma db push
   ```

3. Create src/app/api/regatta-central/auto-sync/route.ts:

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { getClaimsForApiRoute } from '@/lib/auth/claims';
import { unauthorizedResponse, forbiddenResponse, notFoundResponse, serverErrorResponse } from '@/lib/errors';
import { z } from 'zod';

const autoSyncSchema = z.object({
  enabled: z.boolean(),
});

// GET: Check current auto-sync status
export async function GET() {
  try {
    const { user, claims, error } = await getClaimsForApiRoute();
    if (error || !user) return unauthorizedResponse();
    if (!claims?.team_id) return forbiddenResponse('No team associated with user');

    const connection = await prisma.regattaCentralConnection.findUnique({
      where: { teamId: claims.team_id },
      select: { autoSyncEnabled: true },
    });

    if (!connection) {
      return NextResponse.json({ connected: false, autoSyncEnabled: false });
    }

    return NextResponse.json({ connected: true, autoSyncEnabled: connection.autoSyncEnabled });
  } catch (error) {
    return serverErrorResponse(error, 'regatta-central/auto-sync:GET');
  }
}

// PATCH: Toggle auto-sync on/off
export async function PATCH(request: NextRequest) {
  try {
    const { user, claims, error } = await getClaimsForApiRoute();
    if (error || !user) return unauthorizedResponse();
    if (!claims?.team_id) return forbiddenResponse('No team associated with user');
    if (claims.user_role !== 'COACH') return forbiddenResponse('Only coaches can configure auto-sync');

    const body = await request.json();
    const validationResult = autoSyncSchema.safeParse(body);

    if (!validationResult.success) {
      return NextResponse.json(
        { error: 'Validation failed', details: validationResult.error.flatten() },
        { status: 400 }
      );
    }

    const { enabled } = validationResult.data;

    // Verify connection exists
    const connection = await prisma.regattaCentralConnection.findUnique({
      where: { teamId: claims.team_id },
    });

    if (!connection) {
      return notFoundResponse('Regatta Central connection');
    }

    // Update auto-sync setting
    await prisma.regattaCentralConnection.update({
      where: { teamId: claims.team_id },
      data: { autoSyncEnabled: enabled },
    });

    return NextResponse.json({ success: true, autoSyncEnabled: enabled });
  } catch (error) {
    return serverErrorResponse(error, 'regatta-central/auto-sync:PATCH');
  }
}
```

The route follows existing RC API patterns with:
- Claims-based auth (coach-only for PATCH)
- Zod validation
- Standard error responses
- Both GET (status check) and PATCH (toggle)
  </action>
  <verify>
1. Run `npx prisma validate` - should pass
2. Check schema.prisma contains autoSyncEnabled field
3. Check auto-sync/route.ts exports GET and PATCH
4. Run `npm run build` - should compile without errors
  </verify>
  <done>Schema has autoSyncEnabled field, auto-sync API route handles GET and PATCH</done>
</task>

</tasks>

<verification>
1. `npm ls sonner` shows package installed
2. `npx prisma validate` passes
3. `npm run build` compiles successfully
4. Dashboard layout imports and renders Toaster
5. Auto-sync route file exists with GET and PATCH exports
</verification>

<success_criteria>
- Sonner installed and Toaster rendered in dashboard layout
- RegattaCentralConnection model has autoSyncEnabled field
- Auto-sync API route accepts GET (status) and PATCH (toggle) requests
- All code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-rc-settings-ui/06-01-SUMMARY.md`
</output>
