---
phase: 25-api-authentication-jwt-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/25-api-authentication-jwt-security/25-01-AUDIT-REPORT.md
autonomous: true

must_haves:
  truths:
    - "All 80+ API routes are catalogued with their authentication method"
    - "Every API route either requires authentication or is explicitly whitelisted as public"
    - "Public routes are justified and documented"
    - "No route bypasses middleware authentication"
  artifacts:
    - path: ".planning/phases/25-api-authentication-jwt-security/25-01-AUDIT-REPORT.md"
      provides: "Complete API route authentication audit"
      contains: "AUTH-01 compliance"
  key_links:
    - from: "src/middleware.ts"
      to: "src/app/api/**/route.ts"
      via: "Middleware intercepts all API requests"
      pattern: "getUser|getAuthContext|isPublicRoute"
---

<objective>
Audit all API routes to verify they require authentication (AUTH-01).

Purpose: Ensure no API endpoint is accidentally exposed without authentication. This is the foundation for all other JWT security checks - we must first know which routes exist and their auth patterns.

Output: Comprehensive audit report documenting every API route's authentication status.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key files to audit
@src/middleware.ts
@src/lib/auth/get-auth-context.ts
@src/lib/auth/claims.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Catalogue all API routes and their authentication patterns</name>
  <files>.planning/phases/25-api-authentication-jwt-security/25-01-AUDIT-REPORT.md</files>
  <action>
    1. List all API routes in src/app/api/**/*.ts using glob
    2. For each route, determine its authentication pattern:
       - Uses getAuthContext() - protected via session + CASL
       - Uses supabase.auth.getUser() - protected via session
       - Uses CRON_SECRET header - protected via cron secret
       - In publicRoutes/publicPrefixes in middleware.ts - intentionally public
       - None of the above - VULNERABILITY

    3. Categorize routes into:
       - PROTECTED: Routes that call getAuthContext() or getUser()
       - PUBLIC (JUSTIFIED): Routes in publicRoutes/publicPrefixes with valid reason
       - PUBLIC (UNJUSTIFIED): Routes without auth that should have it
       - CRON: Routes protected by CRON_SECRET
       - API_KEY: Routes that accept API key auth via middleware

    4. Check middleware.ts for:
       - CVE-2025-29927 vulnerability (x-middleware-subrequest header bypass)
       - Proper publicRoutes and publicPrefixes definitions
       - Correct matcher config (no static files, images, etc.)

    5. Create audit report with:
       - Route inventory table (path, methods, auth pattern)
       - Public routes justification table
       - Findings summary (compliant vs. issues)
       - AUTH-01 compliance status
  </action>
  <verify>
    Report exists at .planning/phases/25-api-authentication-jwt-security/25-01-AUDIT-REPORT.md with:
    - Complete route inventory (80+ routes)
    - Every route has auth pattern identified
    - No routes marked as "UNKNOWN" or "UNAUDITED"
  </verify>
  <done>
    Every API route is documented with its authentication method.
    AUTH-01 compliance status is determined.
    Any unprotected routes are flagged for remediation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify middleware security and fix issues</name>
  <files>src/middleware.ts</files>
  <action>
    Based on Task 1 audit findings, verify:

    1. CVE-2025-29927 protection:
       - Middleware MUST NOT trust x-middleware-subrequest header
       - If any code reads this header, it's a vulnerability
       - Check Next.js version is 16.0.12+ (fixed version)

    2. Public routes are minimal:
       - /login, /signup, /auth/callback - required for auth flow
       - /join/* - invite acceptance (needs to work before login)
       - /report/* - QR damage reports (anonymous by design)
       - /api/equipment/* - supports anonymous damage reports
       - Any other public route needs explicit justification

    3. API key auth bypass is correct:
       - Only applies to /api/* routes
       - Excludes /api/auth/* routes
       - Validates key before allowing through

    4. If Task 1 found any unprotected routes that should be protected:
       - Add getAuthContext() calls to those routes
       - Document fixes in audit report

    5. If CVE-2025-29927 vulnerability found:
       - Add header stripping in middleware (strip x-middleware-subrequest)
       - Or verify Next.js version is 16.0.12+ which fixes this
  </action>
  <verify>
    - grep for "x-middleware-subrequest" in codebase returns no results (no vulnerable code)
    - Next.js version in package.json is 16.0.12+ (currently 16.1.3 - GOOD)
    - All routes from Task 1 marked as PROTECTED have auth checks
  </verify>
  <done>
    Middleware correctly authenticates all non-public routes.
    No CVE-2025-29927 vulnerability present.
    Public routes are justified and minimal.
    AUTH-01: PASS
  </done>
</task>

</tasks>

<verification>
AUTH-01 Verification Checklist:
- [ ] All API routes catalogued in audit report
- [ ] Each route has documented auth pattern
- [ ] No routes accept unauthenticated requests without justification
- [ ] Middleware correctly intercepts all protected routes
- [ ] CVE-2025-29927 not present (Next.js 16.1.3+)
- [ ] Public routes list is minimal and justified
</verification>

<success_criteria>
- Complete audit report exists
- All 80+ API routes documented
- AUTH-01 requirement is met (no unprotected endpoints without justification)
- No critical vulnerabilities found or all found vulnerabilities fixed
</success_criteria>

<output>
After completion, create `.planning/phases/25-api-authentication-jwt-security/25-01-SUMMARY.md`
</output>
