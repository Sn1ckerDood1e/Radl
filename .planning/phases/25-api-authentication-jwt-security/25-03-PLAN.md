---
phase: 25-api-authentication-jwt-security
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/25-api-authentication-jwt-security/25-03-AUDIT-REPORT.md
autonomous: true

must_haves:
  truths:
    - "User can log in and receive valid session"
    - "Session persists across browser refresh"
    - "User can log out and session is invalidated"
    - "Token refresh extends session without re-authentication"
  artifacts:
    - path: ".planning/phases/25-api-authentication-jwt-security/25-03-AUDIT-REPORT.md"
      provides: "Session management testing results"
      contains: "AUTH-05, AUTH-06, AUTH-07 compliance"
  key_links:
    - from: "src/app/(auth)/login/page.tsx"
      to: "supabase.auth.signInWithPassword"
      via: "Client-side auth flow"
      pattern: "signInWithPassword"
    - from: "src/middleware.ts"
      to: "session cookies"
      via: "Cookie refresh on each request"
      pattern: "setAll.*cookiesToSet"
---

<objective>
Test session persistence, logout behavior, and token refresh (AUTH-05, AUTH-06, AUTH-07).

Purpose: Ensure users can log in, stay logged in across sessions, log out securely, and have their sessions extended without friction. This validates the user experience of authentication.

Output: Session management test report with pass/fail status for each requirement.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Session handling code
@src/app/(auth)/login/page.tsx
@src/middleware.ts
@src/lib/supabase/server.ts
@src/lib/supabase/client.ts
@src/lib/auth/club-context.ts
@src/components/layout/context-switcher.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit login and session persistence implementation</name>
  <files>.planning/phases/25-api-authentication-jwt-security/25-03-AUDIT-REPORT.md</files>
  <action>
    Static analysis of session management code:

    1. AUTH-05 - Session Persistence:
       a. Login flow (src/app/(auth)/login/page.tsx):
          - Uses supabase.auth.signInWithPassword()
          - Supabase SSR client stores session in httpOnly cookies
          - Check for proper cookie settings

       b. Middleware session refresh (src/middleware.ts):
          - Every request creates fresh Supabase client
          - getUser() refreshes session token if needed
          - setAll() callback updates cookies with new tokens
          - This is the key to persistence - verify it works

       c. Server component access (src/lib/supabase/server.ts):
          - Uses cookies() from next/headers
          - setAll has try/catch for Server Component limitation
          - Middleware handles refresh, so this is OK

    2. AUTH-06 - Logout Implementation:
       a. Search for logout/signOut implementation:
          - grep for "signOut" in codebase
          - Check if logout button exists in UI
          - If missing: FLAG AS ISSUE

       b. Logout should:
          - Call supabase.auth.signOut()
          - Clear club/facility context cookies
          - Redirect to login page

       c. Cookie clearing (src/lib/auth/club-context.ts):
          - clearCurrentClubId() exists
          - Should be called on logout

    3. AUTH-07 - Token Refresh:
       a. Automatic refresh via middleware:
          - getUser() handles refresh internally
          - No explicit refreshSession() needed for normal flow

       b. Manual refresh for context switch:
          - context-switcher.tsx line 124: refreshSession()
          - This is correct for forcing JWT claim update

       c. Verify refresh doesn't require re-auth:
          - Supabase uses refresh tokens (long-lived)
          - Access tokens (short-lived) refresh silently

    4. Document findings with code references
  </action>
  <verify>
    - Login uses signInWithPassword() correctly
    - Middleware refreshes tokens on each request
    - Logout implementation exists (or flagged as missing)
    - Token refresh doesn't require password re-entry
  </verify>
  <done>
    Session management code audit complete.
    AUTH-05 (persistence) status documented.
    AUTH-06 (logout) status documented.
    AUTH-07 (refresh) status documented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify logout functionality exists</name>
  <files>.planning/phases/25-api-authentication-jwt-security/25-03-AUDIT-REPORT.md</files>
  <action>
    Deep dive into logout implementation:

    1. Search for existing logout:
       ```bash
       grep -r "signOut" src/
       grep -r "logout" src/ (case-insensitive)
       grep -r "sign-out" src/
       ```

    2. Check settings pages for logout button:
       - src/app/(dashboard)/[teamSlug]/settings/page.tsx
       - src/app/(dashboard)/[teamSlug]/settings/security/page.tsx
       - Look for any "Log out" or "Sign out" button

    3. Check navigation components:
       - src/components/layout/navigation-sidebar.tsx
       - src/components/layout/bottom-navigation.tsx
       - Look for user menu with logout option

    4. If logout is MISSING:
       - Document as AUTH-06 ISSUE
       - Note: User may have to manually clear cookies to log out
       - This is a security concern (no clean logout)

    5. If logout EXISTS:
       - Verify it calls supabase.auth.signOut()
       - Verify it clears context cookies (club, facility)
       - Verify it redirects to /login

    6. Document findings in audit report with specific code locations
  </action>
  <verify>
    - Logout functionality located (or documented as missing)
    - If exists: signOut() + cookie clear + redirect verified
    - If missing: Flagged as AUTH-06 issue requiring fix
  </verify>
  <done>
    Logout implementation status determined.
    AUTH-06 compliance documented.
    Any missing functionality flagged for remediation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create session management test guide</name>
  <files>.planning/phases/25-api-authentication-jwt-security/25-03-AUDIT-REPORT.md</files>
  <action>
    Document manual testing steps for session management:

    1. AUTH-05 - Session Persistence Test:
       ```
       Steps:
       1. Log in with valid credentials
       2. Verify redirect to dashboard
       3. Close browser tab (not browser)
       4. Open new tab, navigate to app
       5. Should still be logged in (no login prompt)

       Expected: Session persists across tab close
       How it works: httpOnly cookies survive tab close

       Additional test:
       1. Log in
       2. Close entire browser
       3. Reopen browser, navigate to app
       4. May need to log in again (depends on cookie expiry)
       ```

    2. AUTH-06 - Logout Test:
       ```
       Steps:
       1. Log in
       2. Navigate to [logout location]
       3. Click logout
       4. Should redirect to /login
       5. Try to access /api/practices
       6. Should get 401 or redirect to login

       Expected: Session fully invalidated
       ```

    3. AUTH-07 - Token Refresh Test:
       ```
       Steps:
       1. Log in
       2. Note current time
       3. Wait 15+ minutes (access token expiry)
       4. Make API request (e.g., navigate to practices)
       5. Should work without login prompt

       Expected: Session extended silently
       How it works: Refresh token used to get new access token
       ```

    4. Edge cases to document:
       - Multiple tabs: Session should sync
       - Context switch: refreshSession() updates claims
       - Browser cookie settings: Third-party cookie blocks

    5. Add curl commands for API-level testing where applicable
  </action>
  <verify>
    Audit report includes:
    - Manual test steps for AUTH-05, AUTH-06, AUTH-07
    - Expected behaviors documented
    - Edge cases noted
  </verify>
  <done>
    Session management test guide complete.
    All three requirements have test procedures.
    Manual testing can verify compliance.
  </done>
</task>

</tasks>

<verification>
Session Management Verification Checklist:
- [ ] Login uses Supabase signInWithPassword()
- [ ] Middleware refreshes session on each request
- [ ] Logout functionality exists and is accessible
- [ ] Logout clears both auth and context cookies
- [ ] Token refresh works without re-authentication
- [ ] Test procedures documented for all requirements
</verification>

<success_criteria>
- AUTH-05: Session persists via httpOnly cookies + middleware refresh
- AUTH-06: Logout exists and properly invalidates session (or flagged as missing)
- AUTH-07: Token refresh handled by Supabase getUser()
- Audit report documents all findings with test procedures
</success_criteria>

<output>
After completion, create `.planning/phases/25-api-authentication-jwt-security/25-03-SUMMARY.md`
</output>
