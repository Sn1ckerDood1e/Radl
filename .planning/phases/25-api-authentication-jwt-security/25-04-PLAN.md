---
phase: 25-api-authentication-jwt-security
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/auth/logout/route.ts
  - src/app/(dashboard)/[teamSlug]/settings/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can log out from the application"
    - "Session is invalidated on logout"
    - "Context cookies are cleared on logout"
    - "User is redirected to login page after logout"
  artifacts:
    - path: "src/app/api/auth/logout/route.ts"
      provides: "POST endpoint for logout"
      exports: ["POST"]
    - path: "src/app/(dashboard)/[teamSlug]/settings/page.tsx"
      provides: "Logout button in settings UI"
      contains: "logout"
  key_links:
    - from: "settings/page.tsx"
      to: "/api/auth/logout"
      via: "fetch POST"
      pattern: "fetch.*api/auth/logout"
    - from: "src/app/api/auth/logout/route.ts"
      to: "supabase.auth.signOut"
      via: "direct call"
      pattern: "signOut"
---

<objective>
Implement logout functionality to close AUTH-06 verification gap.

Purpose: Users currently cannot log out of the application - this is a critical security issue identified in phase verification. Sessions can only end by manual cookie clearing or token expiry.

Output:
- POST /api/auth/logout endpoint
- Logout button in settings page
- Proper session invalidation and cookie cleanup
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-api-authentication-jwt-security/25-VERIFICATION.md

# Existing utilities that MUST be used
@src/lib/auth/club-context.ts (clearCurrentClubId at line 34-37)
@src/lib/auth/facility-context.ts (clearCurrentFacilityId at line 34-37)
@src/lib/supabase/server.ts (createClient for server-side Supabase)

# Files to modify
@src/app/(dashboard)/[teamSlug]/settings/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create logout API endpoint</name>
  <files>src/app/api/auth/logout/route.ts</files>
  <action>
Create POST /api/auth/logout endpoint that:

1. Import createClient from '@/lib/supabase/server'
2. Import clearCurrentClubId from '@/lib/auth/club-context'
3. Import clearCurrentFacilityId from '@/lib/auth/facility-context'
4. Import NextResponse from 'next/server'

5. Export async POST handler:
   - Create supabase client via createClient()
   - Call supabase.auth.signOut() to invalidate the session
   - Call clearCurrentClubId() to remove club context cookie
   - Call clearCurrentFacilityId() to remove facility context cookie
   - Return JSON response with success: true and redirect URL '/login'
   - On error, return 500 with error message

Note: signOut() invalidates the session server-side and clears auth cookies automatically. The context cookies (rowops_current_club, rowops_current_facility) must be cleared separately using the existing utility functions.
  </action>
  <verify>
File exists at src/app/api/auth/logout/route.ts with POST export.
Run: grep -l "signOut" src/app/api/auth/logout/route.ts
  </verify>
  <done>
POST /api/auth/logout endpoint exists, calls signOut() and clears context cookies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add logout button to settings page</name>
  <files>src/app/(dashboard)/[teamSlug]/settings/page.tsx</files>
  <action>
Add a logout section to the settings page with a working logout button.

1. Add state for logout loading:
   const [loggingOut, setLoggingOut] = useState(false);

2. Add handleLogout function:
   - Set loggingOut to true
   - POST to '/api/auth/logout'
   - On success, use router.push('/login') to redirect
   - On error, show toast or set error state
   - Always set loggingOut to false in finally

3. Add a new section between "Security Settings Link" section and "Regatta Central Settings Section" (around line 622-625):

```tsx
{/* Account Section */}
<div className="bg-zinc-900 rounded-xl border border-zinc-800 p-6 mb-6">
  <h2 className="text-lg font-semibold text-white mb-2">Account</h2>
  <p className="text-sm text-zinc-400 mb-4">
    Sign out of your RowOps account on this device.
  </p>
  <button
    onClick={handleLogout}
    disabled={loggingOut}
    className="inline-flex items-center gap-2 px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg transition-colors disabled:opacity-50"
  >
    <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
    </svg>
    {loggingOut ? 'Signing out...' : 'Sign Out'}
  </button>
</div>
```

The button uses a door/arrow icon (standard logout iconography), zinc styling to match other buttons on the page, and shows loading state during logout.
  </action>
  <verify>
Run: grep -l "handleLogout" src/app/(dashboard)/[teamSlug]/settings/page.tsx
Run: grep -l "api/auth/logout" src/app/(dashboard)/[teamSlug]/settings/page.tsx
  </verify>
  <done>
Settings page has logout button that calls /api/auth/logout and redirects to /login on success.
  </done>
</task>

</tasks>

<verification>
1. Grep confirms signOut is called: `grep -r "signOut" src/app/api/auth/logout/`
2. Grep confirms logout API exists: `ls src/app/api/auth/logout/route.ts`
3. Grep confirms UI wiring: `grep "api/auth/logout" src/app/(dashboard)/[teamSlug]/settings/page.tsx`
4. Manual test: Navigate to settings, click "Sign Out", verify redirect to /login
5. Verify session cleared: After logout, try accessing protected route - should redirect to login
</verification>

<success_criteria>
- [ ] POST /api/auth/logout endpoint exists and calls signOut()
- [ ] Context cookies (club, facility) cleared on logout
- [ ] Logout button visible in settings page
- [ ] Clicking logout redirects to /login
- [ ] Session is fully invalidated (protected routes require re-login)
</success_criteria>

<output>
After completion, create `.planning/phases/25-api-authentication-jwt-security/25-04-SUMMARY.md`
</output>
