---
phase: 11-mfa-sso
plan: 10
type: execute
wave: 3
depends_on: ["11-05", "11-08", "11-09"]
files_modified:
  - src/app/(dashboard)/[slug]/settings/security/page.tsx
  - src/components/settings/mfa-section.tsx
  - src/components/settings/permission-grants-section.tsx
autonomous: true

must_haves:
  truths:
    - "User can enable/disable MFA from settings page"
    - "Admin can view and manage active permission grants"
    - "Admin can reset MFA for other users"
  artifacts:
    - path: "src/app/(dashboard)/[slug]/settings/security/page.tsx"
      provides: "Security settings page"
      exports: ["default"]
    - path: "src/components/settings/mfa-section.tsx"
      provides: "MFA management section"
      exports: ["MfaSection"]
    - path: "src/components/settings/permission-grants-section.tsx"
      provides: "Permission grants management"
      exports: ["PermissionGrantsSection"]
  key_links:
    - from: "src/app/(dashboard)/[slug]/settings/security/page.tsx"
      to: "/api/mfa/factors"
      via: "fetch"
      pattern: "fetch.*api/mfa"
    - from: "src/components/settings/permission-grants-section.tsx"
      to: "/api/permission-grants"
      via: "fetch"
      pattern: "fetch.*api/permission-grants"
---

<objective>
Create security settings page with MFA management and permission grants UI.

Purpose: Per CONTEXT.md - MFA setup available in user profile settings (personal) and admin security panel (org-wide). Enable admins to manage temporary permission grants.

Output: Complete security settings UI with MFA and permission grant management.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-mfa-sso/11-CONTEXT.md
@src/components/mfa/mfa-setup-dialog.tsx
@src/components/mfa/mfa-verify-dialog.tsx
@src/lib/validations/permission-grant.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MFA section component</name>
  <files>src/components/settings/mfa-section.tsx</files>
  <action>
Create the MFA management section for settings:

```tsx
'use client';

import { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { MfaSetupDialog } from '@/components/mfa/mfa-setup-dialog';

interface MfaStatus {
  currentLevel: 'aal1' | 'aal2';
  needsMfaVerification: boolean;
  factors: Array<{
    id: string;
    friendlyName: string | null;
    status: string;
  }>;
  remainingBackupCodes: number;
}

export function MfaSection() {
  const [status, setStatus] = useState<MfaStatus | null>(null);
  const [loading, setLoading] = useState(true);
  const [showSetup, setShowSetup] = useState(false);
  const [removing, setRemoving] = useState(false);

  const fetchStatus = async () => {
    try {
      const res = await fetch('/api/mfa/factors');
      if (res.ok) {
        const data = await res.json();
        setStatus(data);
      }
    } catch (error) {
      console.error('Failed to fetch MFA status:', error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchStatus();
  }, []);

  const handleRemoveMfa = async (factorId: string) => {
    if (!confirm('Are you sure you want to disable two-factor authentication?')) {
      return;
    }

    setRemoving(true);
    try {
      const res = await fetch('/api/mfa/unenroll', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ factorId }),
      });

      if (res.ok) {
        await fetchStatus();
      }
    } catch (error) {
      console.error('Failed to remove MFA:', error);
    } finally {
      setRemoving(false);
    }
  };

  const handleRegenerateBackupCodes = async () => {
    if (!confirm('This will invalidate your existing backup codes. Continue?')) {
      return;
    }

    try {
      const res = await fetch('/api/mfa/backup-codes', {
        method: 'POST',
      });

      if (res.ok) {
        const data = await res.json();
        // Show backup codes in a dialog or alert
        alert(`New backup codes:\n\n${data.backupCodes.join('\n')}\n\nSave these somewhere safe!`);
        await fetchStatus();
      }
    } catch (error) {
      console.error('Failed to regenerate backup codes:', error);
    }
  };

  if (loading) {
    return (
      <div className="p-4 bg-card rounded-lg border">
        <div className="animate-pulse h-20 bg-muted rounded" />
      </div>
    );
  }

  const hasMfa = status?.factors && status.factors.length > 0;
  const verifiedFactor = status?.factors?.find(f => f.status === 'verified');

  return (
    <div className="p-4 bg-card rounded-lg border space-y-4">
      <div>
        <h3 className="font-semibold">Two-Factor Authentication</h3>
        <p className="text-sm text-muted-foreground">
          Add an extra layer of security to your account.
        </p>
      </div>

      {hasMfa && verifiedFactor ? (
        <div className="space-y-3">
          <div className="flex items-center gap-2 text-sm">
            <span className="inline-block w-2 h-2 bg-green-500 rounded-full" />
            <span>Enabled via {verifiedFactor.friendlyName || 'Authenticator App'}</span>
          </div>

          {status && (
            <p className="text-sm text-muted-foreground">
              {status.remainingBackupCodes} backup codes remaining
            </p>
          )}

          <div className="flex gap-2">
            <Button
              variant="outline"
              size="sm"
              onClick={handleRegenerateBackupCodes}
            >
              Regenerate Backup Codes
            </Button>
            <Button
              variant="destructive"
              size="sm"
              onClick={() => handleRemoveMfa(verifiedFactor.id)}
              disabled={removing}
            >
              {removing ? 'Removing...' : 'Disable MFA'}
            </Button>
          </div>
        </div>
      ) : (
        <Button onClick={() => setShowSetup(true)}>
          Enable Two-Factor Authentication
        </Button>
      )}

      <MfaSetupDialog
        open={showSetup}
        onOpenChange={setShowSetup}
        onComplete={() => fetchStatus()}
      />
    </div>
  );
}
```

Create directory: `src/components/settings/`
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>MFA section component created</done>
</task>

<task type="auto">
  <name>Task 2: Create permission grants section</name>
  <files>src/components/settings/permission-grants-section.tsx</files>
  <action>
Create the permission grants management section:

```tsx
'use client';

import { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog';
import { grantDurations, type GrantDuration } from '@/lib/validations/permission-grant';

interface PermissionGrant {
  id: string;
  userId: string;
  roles: string[];
  reason: string | null;
  expiresAt: string;
  createdAt: string;
}

interface PermissionGrantsSectionProps {
  clubId: string;
  isAdmin: boolean;
}

export function PermissionGrantsSection({ clubId, isAdmin }: PermissionGrantsSectionProps) {
  const [grants, setGrants] = useState<PermissionGrant[]>([]);
  const [loading, setLoading] = useState(true);
  const [showCreate, setShowCreate] = useState(false);
  const [creating, setCreating] = useState(false);

  // Create form state
  const [userId, setUserId] = useState('');
  const [selectedRoles, setSelectedRoles] = useState<string[]>([]);
  const [duration, setDuration] = useState<GrantDuration>('1_week');
  const [reason, setReason] = useState('');

  const fetchGrants = async () => {
    try {
      const res = await fetch('/api/permission-grants');
      if (res.ok) {
        const data = await res.json();
        setGrants(data.grants);
      }
    } catch (error) {
      console.error('Failed to fetch grants:', error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    if (isAdmin) {
      fetchGrants();
    } else {
      setLoading(false);
    }
  }, [isAdmin]);

  const handleCreateGrant = async () => {
    if (!userId || selectedRoles.length === 0) return;

    setCreating(true);
    try {
      const res = await fetch('/api/permission-grants', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          clubId,
          userId,
          roles: selectedRoles,
          duration,
          reason: reason || undefined,
        }),
      });

      if (res.ok) {
        setShowCreate(false);
        setUserId('');
        setSelectedRoles([]);
        setReason('');
        await fetchGrants();
      }
    } catch (error) {
      console.error('Failed to create grant:', error);
    } finally {
      setCreating(false);
    }
  };

  const handleRevokeGrant = async (grantId: string) => {
    if (!confirm('Revoke this permission grant?')) return;

    try {
      const res = await fetch(`/api/permission-grants/${grantId}`, {
        method: 'DELETE',
      });

      if (res.ok) {
        await fetchGrants();
      }
    } catch (error) {
      console.error('Failed to revoke grant:', error);
    }
  };

  const toggleRole = (role: string) => {
    setSelectedRoles(prev =>
      prev.includes(role)
        ? prev.filter(r => r !== role)
        : [...prev, role]
    );
  };

  if (!isAdmin) {
    return null;
  }

  if (loading) {
    return (
      <div className="p-4 bg-card rounded-lg border">
        <div className="animate-pulse h-32 bg-muted rounded" />
      </div>
    );
  }

  return (
    <div className="p-4 bg-card rounded-lg border space-y-4">
      <div className="flex items-center justify-between">
        <div>
          <h3 className="font-semibold">Temporary Permission Grants</h3>
          <p className="text-sm text-muted-foreground">
            Grant temporary elevated access to team members.
          </p>
        </div>

        <Dialog open={showCreate} onOpenChange={setShowCreate}>
          <DialogTrigger asChild>
            <Button size="sm">Grant Access</Button>
          </DialogTrigger>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Grant Temporary Access</DialogTitle>
            </DialogHeader>

            <div className="space-y-4">
              <div>
                <label className="text-sm font-medium">User ID</label>
                <Input
                  value={userId}
                  onChange={(e) => setUserId(e.target.value)}
                  placeholder="Enter user ID"
                />
              </div>

              <div>
                <label className="text-sm font-medium">Roles to Grant</label>
                <div className="flex gap-2 mt-1">
                  {['CLUB_ADMIN', 'COACH'].map((role) => (
                    <button
                      key={role}
                      type="button"
                      onClick={() => toggleRole(role)}
                      className={`px-3 py-1 text-sm rounded-full border ${
                        selectedRoles.includes(role)
                          ? 'bg-primary text-primary-foreground'
                          : 'bg-background'
                      }`}
                    >
                      {role}
                    </button>
                  ))}
                </div>
              </div>

              <div>
                <label className="text-sm font-medium">Duration</label>
                <select
                  value={duration}
                  onChange={(e) => setDuration(e.target.value as GrantDuration)}
                  className="w-full mt-1 px-3 py-2 border rounded-md bg-background"
                >
                  {Object.entries(grantDurations).map(([key, { label }]) => (
                    <option key={key} value={key}>
                      {label}
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label className="text-sm font-medium">Reason (optional)</label>
                <Input
                  value={reason}
                  onChange={(e) => setReason(e.target.value)}
                  placeholder="e.g., Covering for head coach"
                />
              </div>

              <Button
                onClick={handleCreateGrant}
                disabled={!userId || selectedRoles.length === 0 || creating}
                className="w-full"
              >
                {creating ? 'Creating...' : 'Grant Access'}
              </Button>
            </div>
          </DialogContent>
        </Dialog>
      </div>

      {grants.length === 0 ? (
        <p className="text-sm text-muted-foreground">
          No active permission grants.
        </p>
      ) : (
        <div className="space-y-2">
          {grants.map((grant) => (
            <div
              key={grant.id}
              className="flex items-center justify-between p-3 bg-muted rounded-lg"
            >
              <div>
                <div className="text-sm font-medium">
                  {grant.roles.join(', ')}
                </div>
                <div className="text-xs text-muted-foreground">
                  Expires: {new Date(grant.expiresAt).toLocaleDateString()}
                  {grant.reason && ` - ${grant.reason}`}
                </div>
              </div>
              <Button
                variant="destructive"
                size="sm"
                onClick={() => handleRevokeGrant(grant.id)}
              >
                Revoke
              </Button>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
```
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>Permission grants section component created</done>
</task>

<task type="auto">
  <name>Task 3: Create security settings page</name>
  <files>src/app/(dashboard)/[slug]/settings/security/page.tsx</files>
  <action>
Create the security settings page that combines MFA and permission grants:

```tsx
import { getClaimsForApiRoute } from '@/lib/auth/claims';
import { redirect } from 'next/navigation';
import { MfaSection } from '@/components/settings/mfa-section';
import { PermissionGrantsSection } from '@/components/settings/permission-grants-section';

export default async function SecuritySettingsPage({
  params,
}: {
  params: Promise<{ slug: string }>;
}) {
  const { slug } = await params;
  const { user, clubId, roles, error } = await getClaimsForApiRoute();

  if (error || !user || !clubId) {
    redirect('/login');
  }

  const isAdmin = roles.includes('FACILITY_ADMIN') || roles.includes('CLUB_ADMIN');

  return (
    <div className="container max-w-2xl py-8 space-y-8">
      <div>
        <h1 className="text-2xl font-bold">Security Settings</h1>
        <p className="text-muted-foreground">
          Manage your account security and team access.
        </p>
      </div>

      {/* Personal MFA settings - available to all users */}
      <section>
        <h2 className="text-lg font-semibold mb-4">Your Security</h2>
        <MfaSection />
      </section>

      {/* Admin-only: Permission grants */}
      {isAdmin && (
        <section>
          <h2 className="text-lg font-semibold mb-4">Team Access</h2>
          <PermissionGrantsSection clubId={clubId} isAdmin={isAdmin} />
        </section>
      )}

      {/* Admin-only: Team MFA management could go here in future */}
    </div>
  );
}
```

Create necessary directory structure: `src/app/(dashboard)/[slug]/settings/security/`
  </action>
  <verify>TypeScript compiles without errors. Page accessible at /[slug]/settings/security</verify>
  <done>Security settings page created with MFA and permission grants sections</done>
</task>

</tasks>

<verification>
1. All TypeScript files compile without errors
2. Security settings page renders for authenticated users
3. MFA section shows enable/disable based on status
4. Permission grants section only visible to admins
</verification>

<success_criteria>
- Users can enable/disable MFA from /settings/security
- Users can regenerate backup codes
- Admins can view active permission grants
- Admins can create new temporary grants with duration selection
- Admins can revoke active grants
</success_criteria>

<output>
After completion, create `.planning/phases/11-mfa-sso/11-10-SUMMARY.md`
</output>
