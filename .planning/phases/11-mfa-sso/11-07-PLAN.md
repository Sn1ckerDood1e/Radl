---
phase: 11-mfa-sso
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/auth/sso.ts
  - src/lib/validations/sso.ts
autonomous: true

must_haves:
  truths:
    - "System can store and retrieve SSO configuration per facility"
    - "System can map IDP groups to RowOps roles"
    - "System defaults unmapped users to ATHLETE role"
  artifacts:
    - path: "src/lib/auth/sso.ts"
      provides: "SSO configuration and role mapping functions"
      exports: ["getSsoConfig", "updateSsoConfig", "mapSsoRoles"]
    - path: "src/lib/validations/sso.ts"
      provides: "SSO configuration validation schemas"
      exports: ["ssoConfigSchema", "roleMappingSchema"]
  key_links:
    - from: "src/lib/auth/sso.ts"
      to: "prisma.ssoConfig"
      via: "Database operations"
      pattern: "prisma\\.ssoConfig"
---

<objective>
Create SSO configuration and role mapping utilities.

Purpose: Enable facility admins to configure SAML SSO and map identity provider groups to RowOps roles. Per CONTEXT.md: SSO is configured at facility level, users without matching roles default to ATHLETE.

Output: SSO configuration management and role mapping functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-mfa-sso/11-CONTEXT.md
@.planning/phases/11-mfa-sso/11-RESEARCH.md
@src/lib/prisma.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SSO validation schemas</name>
  <files>src/lib/validations/sso.ts</files>
  <action>
Create Zod validation schemas for SSO configuration:

```typescript
import { z } from 'zod';

/**
 * Valid roles that can be mapped from SSO
 */
const mappableRoles = ['FACILITY_ADMIN', 'CLUB_ADMIN', 'COACH', 'ATHLETE', 'PARENT'] as const;

/**
 * Schema for a single role mapping entry
 */
export const roleMappingSchema = z.object({
  idpValue: z.string().min(1).max(255),  // Value from IDP claim
  rowopsRoles: z.array(z.enum(mappableRoles)).min(1),
});

/**
 * Schema for SSO configuration update
 */
export const ssoConfigSchema = z.object({
  enabled: z.boolean().optional(),
  ssoProviderId: z.string().optional().nullable(),
  idpDomain: z.string().min(1).max(255).optional().nullable(),
  idpGroupClaim: z.string().min(1).max(100).optional(),
  roleMappings: z.array(roleMappingSchema).optional(),
  defaultRole: z.enum(mappableRoles).optional(),
  allowOverride: z.boolean().optional(),
});

/**
 * Schema for initiating SSO login
 */
export const ssoLoginSchema = z.object({
  domain: z.string().min(1).max(255),
  redirectTo: z.string().url().optional(),
});

export type RoleMapping = z.infer<typeof roleMappingSchema>;
export type SsoConfigInput = z.infer<typeof ssoConfigSchema>;
export type SsoLoginInput = z.infer<typeof ssoLoginSchema>;
```
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>SSO validation schemas created</done>
</task>

<task type="auto">
  <name>Task 2: Create SSO configuration and role mapping functions</name>
  <files>src/lib/auth/sso.ts</files>
  <action>
Create SSO helper functions:

```typescript
import { prisma } from '@/lib/prisma';
import type { Role, SsoConfig } from '@/generated/prisma';
import type { RoleMapping, SsoConfigInput } from '@/lib/validations/sso';

/**
 * SSO configuration with typed role mappings
 */
export interface SsoConfigWithMappings extends Omit<SsoConfig, 'roleMappings'> {
  roleMappings: RoleMapping[];
}

/**
 * Get SSO configuration for a facility.
 * Returns null if no configuration exists.
 */
export async function getSsoConfig(
  facilityId: string
): Promise<SsoConfigWithMappings | null> {
  const config = await prisma.ssoConfig.findUnique({
    where: { facilityId },
  });

  if (!config) return null;

  return {
    ...config,
    roleMappings: (config.roleMappings as RoleMapping[]) || [],
  };
}

/**
 * Create or update SSO configuration for a facility.
 */
export async function updateSsoConfig(
  facilityId: string,
  input: SsoConfigInput
): Promise<SsoConfigWithMappings> {
  const config = await prisma.ssoConfig.upsert({
    where: { facilityId },
    create: {
      facilityId,
      enabled: input.enabled ?? false,
      ssoProviderId: input.ssoProviderId ?? null,
      idpDomain: input.idpDomain ?? null,
      idpGroupClaim: input.idpGroupClaim ?? 'groups',
      roleMappings: (input.roleMappings as object[]) ?? [],
      defaultRole: input.defaultRole ?? 'ATHLETE',
      allowOverride: input.allowOverride ?? true,
    },
    update: {
      ...(input.enabled !== undefined && { enabled: input.enabled }),
      ...(input.ssoProviderId !== undefined && { ssoProviderId: input.ssoProviderId }),
      ...(input.idpDomain !== undefined && { idpDomain: input.idpDomain }),
      ...(input.idpGroupClaim !== undefined && { idpGroupClaim: input.idpGroupClaim }),
      ...(input.roleMappings !== undefined && { roleMappings: input.roleMappings as object[] }),
      ...(input.defaultRole !== undefined && { defaultRole: input.defaultRole }),
      ...(input.allowOverride !== undefined && { allowOverride: input.allowOverride }),
    },
  });

  return {
    ...config,
    roleMappings: (config.roleMappings as RoleMapping[]) || [],
  };
}

/**
 * Map SSO/IDP claims to RowOps roles.
 *
 * Per CONTEXT.md:
 * - Configurable mapping from IDP groups/claims to RowOps roles
 * - Default to ATHLETE if no mapping matches
 * - Role updates on next login
 *
 * @param facilityId - Facility the user is logging into
 * @param idpClaims - Claims from identity provider
 * @returns Array of mapped RowOps roles
 */
export async function mapSsoRoles(
  facilityId: string,
  idpClaims: Record<string, unknown>
): Promise<Role[]> {
  const config = await getSsoConfig(facilityId);

  if (!config || !config.enabled) {
    return [config?.defaultRole ?? 'ATHLETE'];
  }

  // Get groups/roles from the configured claim
  const claimValue = idpClaims[config.idpGroupClaim];
  const groups: string[] = Array.isArray(claimValue)
    ? claimValue.map(String)
    : typeof claimValue === 'string'
      ? [claimValue]
      : [];

  // Find matching role mappings
  const mappedRoles: Role[] = [];

  for (const mapping of config.roleMappings) {
    if (groups.includes(mapping.idpValue)) {
      mappedRoles.push(...(mapping.rowopsRoles as Role[]));
    }
  }

  // Return mapped roles or default
  if (mappedRoles.length > 0) {
    return [...new Set(mappedRoles)]; // Deduplicate
  }

  return [config.defaultRole];
}

/**
 * Check if SSO is enabled and configured for a facility.
 */
export async function isSsoEnabled(facilityId: string): Promise<boolean> {
  const config = await prisma.ssoConfig.findUnique({
    where: { facilityId },
    select: { enabled: true, ssoProviderId: true },
  });

  return config?.enabled === true && config.ssoProviderId !== null;
}

/**
 * Get the IDP domain for a facility (for SSO login routing).
 */
export async function getSsoDomain(facilityId: string): Promise<string | null> {
  const config = await prisma.ssoConfig.findUnique({
    where: { facilityId },
    select: { idpDomain: true, enabled: true },
  });

  if (!config?.enabled) return null;
  return config.idpDomain;
}

/**
 * Check if facility admin override is allowed for SSO users.
 * Per CONTEXT.md: "Facility admin can override SSO-derived roles"
 */
export async function canOverrideSsoRoles(facilityId: string): Promise<boolean> {
  const config = await prisma.ssoConfig.findUnique({
    where: { facilityId },
    select: { allowOverride: true },
  });

  return config?.allowOverride ?? true;
}
```
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>SSO configuration and role mapping functions created</done>
</task>

</tasks>

<verification>
1. All TypeScript files compile without errors
2. `mapSsoRoles` correctly applies configured mappings
3. Default to ATHLETE when no mapping matches
4. Functions handle missing/unconfigured facilities gracefully
</verification>

<success_criteria>
- `getSsoConfig` returns typed configuration with role mappings
- `updateSsoConfig` creates or updates facility SSO settings
- `mapSsoRoles` maps IDP groups to RowOps roles per configuration
- Unmapped users default to ATHLETE role
- Override setting controls if admins can modify SSO-derived roles
</success_criteria>

<output>
After completion, create `.planning/phases/11-mfa-sso/11-07-SUMMARY.md`
</output>
