---
phase: 11-mfa-sso
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "System can store MFA backup codes hashed with SHA-256"
    - "System can track temporary permission grants with expiration"
    - "System can store SSO configuration per facility"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "MfaBackupCode, PermissionGrant, SsoConfig models"
      contains: "model MfaBackupCode"
  key_links:
    - from: "PermissionGrant"
      to: "ClubMembership"
      via: "clubId + userId reference"
      pattern: "clubId.*String"
---

<objective>
Add Prisma models for MFA backup codes, temporary permission grants, and SSO configuration.

Purpose: Database foundation for Phase 11 MFA and SSO features - backup code storage, time-bounded elevated access, and facility-level SSO configuration.

Output: Extended Prisma schema with three new models, generated client, and database pushed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-mfa-sso/11-CONTEXT.md
@.planning/phases/11-mfa-sso/11-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MfaBackupCode and PermissionGrant models</name>
  <files>prisma/schema.prisma</files>
  <action>
Add two new models to the Prisma schema:

**MfaBackupCode model:**
```prisma
model MfaBackupCode {
  id        String   @id @default(uuid())
  userId    String   // Supabase auth user ID
  codeHash  String   // SHA-256 hash of backup code
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([userId])
  @@unique([userId, codeHash])
}
```

**PermissionGrant model:**
```prisma
model PermissionGrant {
  id          String    @id @default(uuid())
  clubId      String    // Club where grant applies
  userId      String    // Who receives elevated access
  grantedBy   String    // Who granted it
  roles       Role[]    // Elevated roles granted
  reason      String?   // Why granted (audit trail)
  expiresAt   DateTime  // When grant expires
  revokedAt   DateTime? // Soft revoke before expiration
  notifiedAt  DateTime? // When expiration warning sent
  createdAt   DateTime  @default(now())

  @@index([clubId])
  @@index([userId])
  @@index([expiresAt])
  @@index([userId, clubId])
}
```

Place after AuditLog model. Follow existing schema formatting conventions.
  </action>
  <verify>Run `npx prisma validate` - should pass with no errors</verify>
  <done>MfaBackupCode and PermissionGrant models added to schema</done>
</task>

<task type="auto">
  <name>Task 2: Add SsoConfig model</name>
  <files>prisma/schema.prisma</files>
  <action>
Add SsoConfig model for facility-level SSO configuration:

```prisma
model SsoConfig {
  id             String   @id @default(uuid())
  facilityId     String   @unique  // Facility where SSO applies (currently maps to Team.id)
  enabled        Boolean  @default(false)
  ssoProviderId  String?  // From Supabase SSO setup
  idpDomain      String?  // e.g., 'company.com'
  idpGroupClaim  String   @default("groups")  // Which claim contains group membership
  roleMappings   Json     @default("[]")  // Array of { idpValue, rowopsRoles }
  defaultRole    Role     @default(ATHLETE)  // Default if no mapping matches
  allowOverride  Boolean  @default(true)  // Facility admin can override SSO roles
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([facilityId])
  @@index([ssoProviderId])
}
```

Place after PermissionGrant model.
  </action>
  <verify>Run `npx prisma validate` - should pass with no errors</verify>
  <done>SsoConfig model added to schema</done>
</task>

<task type="auto">
  <name>Task 3: Generate Prisma client and push schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Generate Prisma client and push schema to database:

```bash
npx prisma generate
npx prisma db push
```

This updates the TypeScript types and applies schema changes to the database.
  </action>
  <verify>Both commands complete without errors. New types available in `@/generated/prisma`</verify>
  <done>Prisma client regenerated with MfaBackupCode, PermissionGrant, SsoConfig types; database schema updated</done>
</task>

</tasks>

<verification>
1. `npx prisma validate` passes
2. `npx prisma generate` completes without errors
3. TypeScript can import `MfaBackupCode`, `PermissionGrant`, `SsoConfig` from `@/generated/prisma`
</verification>

<success_criteria>
- Three new models (MfaBackupCode, PermissionGrant, SsoConfig) exist in schema
- All indexes and constraints applied correctly
- Prisma client has new types for use in application code
</success_criteria>

<output>
After completion, create `.planning/phases/11-mfa-sso/11-01-SUMMARY.md`
</output>
