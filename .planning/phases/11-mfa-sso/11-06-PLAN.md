---
phase: 11-mfa-sso
plan: 06
type: execute
wave: 2
depends_on: ["11-01", "11-04"]
files_modified:
  - src/lib/permissions/ability.ts
  - src/lib/auth/claims.ts
autonomous: true

must_haves:
  truths:
    - "CASL ability builder includes temporary grants in role calculation"
    - "Claims helper includes effective roles with grants"
  artifacts:
    - path: "src/lib/permissions/ability.ts"
      provides: "Ability builder with grant support"
      exports: ["defineAbilityFor"]
    - path: "src/lib/auth/claims.ts"
      provides: "Claims with effective roles"
      exports: ["getClaimsForApiRoute"]
  key_links:
    - from: "src/lib/auth/claims.ts"
      to: "src/lib/auth/permission-grant.ts"
      via: "Effective roles lookup"
      pattern: "getUserEffectiveRoles"
---

<objective>
Integrate permission grants into CASL ability system.

Purpose: Ensure temporary elevated access works seamlessly with existing permission checks. Users with grants should have their elevated roles reflected in ability checks.

Output: Updated claims helper and ability builder that include permission grants.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-mfa-sso/11-CONTEXT.md
@src/lib/permissions/ability.ts
@src/lib/auth/claims.ts
@src/lib/auth/permission-grant.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update claims helper to include effective roles with grants</name>
  <files>src/lib/auth/claims.ts</files>
  <action>
Update `getClaimsForApiRoute` to include permission grants in role calculation:

1. Import `getUserEffectiveRoles` from `@/lib/auth/permission-grant`

2. After getting membership roles, call `getUserEffectiveRoles` to merge any active grants:

```typescript
// After getting base roles from membership...
if (clubId) {
  const membership = await prisma.clubMembership.findFirst({
    where: {
      clubId,
      userId: user.id,
      isActive: true,
    },
  });

  if (membership) {
    // Get effective roles including any temporary grants
    const effectiveRoles = await getUserEffectiveRoles(
      user.id,
      clubId,
      membership.roles as Role[]
    );
    roles = effectiveRoles.map(r => r.toString());
  }
}
```

3. Add the import at the top of the file:
```typescript
import { getUserEffectiveRoles } from './permission-grant';
import type { Role } from '@/generated/prisma';
```

The rest of the function remains the same. The key change is that `roles` now includes both base membership roles AND any active permission grants.
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>Claims helper updated to include permission grants in effective roles</done>
</task>

<task type="auto">
  <name>Task 2: Add UserContext type documentation</name>
  <files>src/lib/permissions/ability.ts</files>
  <action>
Update the `UserContext` interface documentation to clarify that roles may include temporary grants:

```typescript
/**
 * User context for ability creation.
 * Passed from auth layer to define what user can do.
 *
 * NOTE: The `roles` array may include both:
 * - Base roles from ClubMembership
 * - Temporary roles from active PermissionGrants
 *
 * The auth layer (claims.ts) handles merging these before
 * passing to the ability builder.
 */
export interface UserContext {
  userId: string;
  clubId: string;
  roles: ('FACILITY_ADMIN' | 'CLUB_ADMIN' | 'COACH' | 'ATHLETE' | 'PARENT')[];
  linkedAthleteIds?: string[];  // For PARENT role - IDs of athletes they can see
}
```

The `defineAbilityFor` function itself does not need changes - it already iterates over the `roles` array and grants permissions for each role. Since grants add to this array, they will automatically be processed.

The architecture is clean: permission grants are merged at the claims layer, and the ability builder remains role-based without knowledge of grants.
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>UserContext documentation updated to clarify grant inclusion</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. `getClaimsForApiRoute` returns roles that include grants
3. No changes needed to ability builder (roles array already processed correctly)
</verification>

<success_criteria>
- User with COACH base role + CLUB_ADMIN grant sees CLUB_ADMIN permissions
- Grant expiration removes elevated role from effective roles
- Existing permission checks work unchanged (transparent integration)
</success_criteria>

<output>
After completion, create `.planning/phases/11-mfa-sso/11-06-SUMMARY.md`
</output>
