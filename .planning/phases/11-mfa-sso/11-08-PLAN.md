---
phase: 11-mfa-sso
plan: 08
type: execute
wave: 2
depends_on: ["11-01", "11-07"]
files_modified:
  - src/app/api/sso/config/route.ts
  - src/lib/audit/actions.ts
autonomous: true

must_haves:
  truths:
    - "Facility admin can view SSO configuration via API"
    - "Facility admin can update SSO configuration via API"
    - "SSO configuration changes are audit logged"
  artifacts:
    - path: "src/app/api/sso/config/route.ts"
      provides: "SSO configuration endpoint"
      exports: ["GET", "PUT"]
  key_links:
    - from: "src/app/api/sso/config/route.ts"
      to: "src/lib/auth/sso.ts"
      via: "SSO config functions"
      pattern: "import.*getSsoConfig|updateSsoConfig"
---

<objective>
Create SSO configuration API endpoint for facility admins.

Purpose: Enable facility admins to view and update SSO settings including role mappings. Per CONTEXT.md: SSO is configured at facility level only.

Output: SSO configuration API endpoint with proper authorization.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-mfa-sso/11-CONTEXT.md
@src/lib/auth/sso.ts
@src/lib/auth/claims.ts
@src/lib/audit/logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SSO audit actions</name>
  <files>src/lib/audit/actions.ts</files>
  <action>
Add new audit action types for SSO operations to the AUDITABLE_ACTIONS array:

```typescript
// Add these to the AUDITABLE_ACTIONS array:
{
  action: 'SSO_CONFIG_UPDATED',
  description: 'Facility admin updated SSO configuration',
},
{
  action: 'SSO_ENABLED',
  description: 'SSO was enabled for facility',
},
{
  action: 'SSO_DISABLED',
  description: 'SSO was disabled for facility',
},
{
  action: 'SSO_ROLE_MAPPING_CHANGED',
  description: 'SSO role mappings were modified',
},
```
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>SSO audit actions added</done>
</task>

<task type="auto">
  <name>Task 2: Create SSO configuration API endpoint</name>
  <files>src/app/api/sso/config/route.ts</files>
  <action>
Create the SSO configuration API endpoint:

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getClaimsForApiRoute } from '@/lib/auth/claims';
import { getSsoConfig, updateSsoConfig } from '@/lib/auth/sso';
import { ssoConfigSchema } from '@/lib/validations/sso';
import { createAuditLogger } from '@/lib/audit/logger';

/**
 * GET /api/sso/config
 * Get SSO configuration for current facility/club
 *
 * Note: Currently facility = club (Team). When facility model is added
 * in Phase 12, this will need to look up the parent facility.
 */
export async function GET() {
  try {
    const { user, clubId, roles, error } = await getClaimsForApiRoute();

    if (error || !user || !clubId) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    // Only FACILITY_ADMIN can view SSO config
    // (In current schema, FACILITY_ADMIN at club level = facility admin)
    if (!roles.includes('FACILITY_ADMIN')) {
      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
    }

    const config = await getSsoConfig(clubId);

    if (!config) {
      // Return empty config template
      return NextResponse.json({
        config: {
          facilityId: clubId,
          enabled: false,
          ssoProviderId: null,
          idpDomain: null,
          idpGroupClaim: 'groups',
          roleMappings: [],
          defaultRole: 'ATHLETE',
          allowOverride: true,
        },
      });
    }

    return NextResponse.json({ config });
  } catch (error) {
    console.error('Failed to get SSO config:', error);
    return NextResponse.json(
      { error: 'Failed to get SSO configuration' },
      { status: 500 }
    );
  }
}

/**
 * PUT /api/sso/config
 * Update SSO configuration for current facility/club
 */
export async function PUT(request: NextRequest) {
  try {
    const { user, clubId, roles, error } = await getClaimsForApiRoute();

    if (error || !user || !clubId) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    // Only FACILITY_ADMIN can update SSO config
    if (!roles.includes('FACILITY_ADMIN')) {
      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
    }

    const body = await request.json();
    const parsed = ssoConfigSchema.safeParse(body);

    if (!parsed.success) {
      return NextResponse.json(
        { error: 'Invalid input', details: parsed.error.flatten() },
        { status: 400 }
      );
    }

    // Get current config to detect changes
    const oldConfig = await getSsoConfig(clubId);

    const config = await updateSsoConfig(clubId, parsed.data);

    // Audit log with appropriate action
    const logger = createAuditLogger(request, { userId: user.id, clubId });

    // Determine which audit action to use
    let auditAction = 'SSO_CONFIG_UPDATED';
    const metadata: Record<string, unknown> = {
      changes: parsed.data,
    };

    // Check for specific significant changes
    if (parsed.data.enabled !== undefined) {
      if (parsed.data.enabled && !oldConfig?.enabled) {
        auditAction = 'SSO_ENABLED';
      } else if (!parsed.data.enabled && oldConfig?.enabled) {
        auditAction = 'SSO_DISABLED';
      }
    }

    if (parsed.data.roleMappings !== undefined) {
      auditAction = 'SSO_ROLE_MAPPING_CHANGED';
      metadata.mappingCount = parsed.data.roleMappings.length;
    }

    await logger.log({
      action: auditAction,
      targetType: 'SsoConfig',
      targetId: config.id,
      metadata,
    });

    return NextResponse.json({ config });
  } catch (error) {
    console.error('Failed to update SSO config:', error);
    return NextResponse.json(
      { error: 'Failed to update SSO configuration' },
      { status: 500 }
    );
  }
}
```

Create necessary directory: `src/app/api/sso/config/`
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>SSO configuration API endpoint created with audit logging</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. GET /api/sso/config returns 403 for non-FACILITY_ADMIN
3. PUT /api/sso/config validates input and logs changes
</verification>

<success_criteria>
- GET /api/sso/config returns current SSO configuration
- PUT /api/sso/config updates configuration with validation
- Only FACILITY_ADMIN can access these endpoints
- Configuration changes are audit logged with specific actions
</success_criteria>

<output>
After completion, create `.planning/phases/11-mfa-sso/11-08-SUMMARY.md`
</output>
