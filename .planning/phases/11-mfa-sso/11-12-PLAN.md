---
phase: 11-mfa-sso
plan: 12
type: execute
wave: 4
depends_on: ["11-06", "11-09", "11-10", "11-11"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "User can complete full MFA enrollment flow"
    - "Admin can create and revoke permission grants"
    - "SSO configuration saves and loads correctly"
  artifacts: []
  key_links: []
---

<objective>
Verify Phase 11 MFA & SSO implementation with end-to-end testing.

Purpose: Ensure all features work together correctly before marking phase complete.

Output: Verified phase with all requirements met.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-mfa-sso/11-CONTEXT.md
@.planning/milestones/v2.0-ROADMAP.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build and type check</name>
  <files></files>
  <action>
Run full build and type check to ensure no errors:

```bash
npm run build
npx tsc --noEmit
```

Fix any TypeScript or build errors before proceeding.
  </action>
  <verify>Build completes successfully with no errors</verify>
  <done>Codebase builds and passes type checking</done>
</task>

<task type="auto">
  <name>Task 2: Test API endpoints</name>
  <files></files>
  <action>
Start dev server and test each API endpoint:

```bash
npm run dev
```

Test MFA endpoints (unauthenticated should return 401):
- GET /api/mfa/factors
- POST /api/mfa/enroll
- POST /api/mfa/verify
- POST /api/mfa/unenroll
- GET /api/mfa/backup-codes
- POST /api/mfa/backup-codes

Test permission grants endpoints:
- GET /api/permission-grants
- POST /api/permission-grants
- DELETE /api/permission-grants/[id]

Test SSO endpoint:
- GET /api/sso/config
- PUT /api/sso/config

Verify all return proper HTTP status codes.
  </action>
  <verify>All endpoints respond correctly with proper auth checks</verify>
  <done>API endpoints verified</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete MFA & SSO feature set:
- MFA enrollment with QR code and backup codes
- MFA verification (TOTP and backup code)
- Permission grants with expiration
- SSO configuration UI
- Security settings page
  </what-built>
  <how-to-verify>
1. Navigate to /[slug]/settings/security
2. Click "Enable Two-Factor Authentication"
3. Verify QR code displays and can be scanned
4. Enter TOTP code from authenticator app
5. Verify backup codes are shown
6. Confirm MFA is now enabled
7. (Admin only) Create a test permission grant
8. (Facility admin only) Navigate to /[slug]/settings/sso
9. Add a test role mapping and save
10. Verify configuration loads on page refresh
  </how-to-verify>
  <resume-signal>Type "verified" if all features work correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 11 success criteria from roadmap:
1. [x] Facility and club admins can enable MFA via authenticator app (TOTP)
2. [x] Enterprise customers can configure SAML SSO with identity provider
3. [x] Facility admin can grant custom permissions for edge cases
4. [x] SSO users inherit roles from identity provider claims
</verification>

<success_criteria>
All four success criteria verified:
- MFA enrollment flow completes successfully
- SSO configuration can be saved and retrieved
- Permission grants work with automatic expiration
- Role mapping configured for SSO users
</success_criteria>

<output>
After completion, create `.planning/phases/11-mfa-sso/11-12-SUMMARY.md`
</output>
