---
phase: 11-mfa-sso
plan: 11
type: execute
wave: 3
depends_on: ["11-08"]
files_modified:
  - src/app/(dashboard)/[slug]/settings/sso/page.tsx
  - src/components/settings/sso-config-form.tsx
autonomous: true

must_haves:
  truths:
    - "Facility admin can view SSO configuration"
    - "Facility admin can configure role mappings"
    - "SSO configuration changes are saved"
  artifacts:
    - path: "src/app/(dashboard)/[slug]/settings/sso/page.tsx"
      provides: "SSO settings page"
      exports: ["default"]
    - path: "src/components/settings/sso-config-form.tsx"
      provides: "SSO configuration form"
      exports: ["SsoConfigForm"]
  key_links:
    - from: "src/app/(dashboard)/[slug]/settings/sso/page.tsx"
      to: "/api/sso/config"
      via: "fetch"
      pattern: "fetch.*api/sso/config"
---

<objective>
Create SSO configuration UI for facility admins.

Purpose: Per CONTEXT.md - facility admins can configure SAML SSO with role mappings. This is a hybrid setup approach with self-service UI.

Output: SSO configuration page with role mapping editor.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-mfa-sso/11-CONTEXT.md
@src/lib/validations/sso.ts
@src/components/ui/button.tsx
@src/components/ui/input.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SSO configuration form component</name>
  <files>src/components/settings/sso-config-form.tsx</files>
  <action>
Create the SSO configuration form:

```tsx
'use client';

import { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';

interface RoleMapping {
  idpValue: string;
  rowopsRoles: string[];
}

interface SsoConfig {
  facilityId: string;
  enabled: boolean;
  ssoProviderId: string | null;
  idpDomain: string | null;
  idpGroupClaim: string;
  roleMappings: RoleMapping[];
  defaultRole: string;
  allowOverride: boolean;
}

const AVAILABLE_ROLES = ['FACILITY_ADMIN', 'CLUB_ADMIN', 'COACH', 'ATHLETE', 'PARENT'];

export function SsoConfigForm() {
  const [config, setConfig] = useState<SsoConfig | null>(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');

  // Editable fields
  const [enabled, setEnabled] = useState(false);
  const [idpDomain, setIdpDomain] = useState('');
  const [idpGroupClaim, setIdpGroupClaim] = useState('groups');
  const [roleMappings, setRoleMappings] = useState<RoleMapping[]>([]);
  const [defaultRole, setDefaultRole] = useState('ATHLETE');
  const [allowOverride, setAllowOverride] = useState(true);

  useEffect(() => {
    fetchConfig();
  }, []);

  const fetchConfig = async () => {
    try {
      const res = await fetch('/api/sso/config');
      if (res.ok) {
        const data = await res.json();
        setConfig(data.config);
        // Populate form
        setEnabled(data.config.enabled);
        setIdpDomain(data.config.idpDomain || '');
        setIdpGroupClaim(data.config.idpGroupClaim || 'groups');
        setRoleMappings(data.config.roleMappings || []);
        setDefaultRole(data.config.defaultRole || 'ATHLETE');
        setAllowOverride(data.config.allowOverride ?? true);
      } else if (res.status !== 403) {
        setError('Failed to load SSO configuration');
      }
    } catch (err) {
      setError('Failed to load SSO configuration');
    } finally {
      setLoading(false);
    }
  };

  const handleSave = async () => {
    setSaving(true);
    setError('');
    setSuccess('');

    try {
      const res = await fetch('/api/sso/config', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          enabled,
          idpDomain: idpDomain || null,
          idpGroupClaim,
          roleMappings,
          defaultRole,
          allowOverride,
        }),
      });

      if (res.ok) {
        setSuccess('Configuration saved successfully');
        await fetchConfig();
      } else {
        const data = await res.json();
        setError(data.error || 'Failed to save configuration');
      }
    } catch (err) {
      setError('Failed to save configuration');
    } finally {
      setSaving(false);
    }
  };

  const addMapping = () => {
    setRoleMappings([...roleMappings, { idpValue: '', rowopsRoles: [] }]);
  };

  const updateMapping = (index: number, field: keyof RoleMapping, value: string | string[]) => {
    const updated = [...roleMappings];
    updated[index] = { ...updated[index], [field]: value };
    setRoleMappings(updated);
  };

  const removeMapping = (index: number) => {
    setRoleMappings(roleMappings.filter((_, i) => i !== index));
  };

  const toggleMappingRole = (index: number, role: string) => {
    const current = roleMappings[index].rowopsRoles;
    const updated = current.includes(role)
      ? current.filter(r => r !== role)
      : [...current, role];
    updateMapping(index, 'rowopsRoles', updated);
  };

  if (loading) {
    return (
      <div className="p-4 bg-card rounded-lg border">
        <div className="animate-pulse h-48 bg-muted rounded" />
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Enable/Disable toggle */}
      <div className="p-4 bg-card rounded-lg border space-y-4">
        <div className="flex items-center justify-between">
          <div>
            <h3 className="font-semibold">SSO Status</h3>
            <p className="text-sm text-muted-foreground">
              Enable SAML single sign-on for your facility.
            </p>
          </div>
          <label className="flex items-center gap-2">
            <input
              type="checkbox"
              checked={enabled}
              onChange={(e) => setEnabled(e.target.checked)}
              className="rounded"
            />
            <span className="text-sm">{enabled ? 'Enabled' : 'Disabled'}</span>
          </label>
        </div>

        {!config?.ssoProviderId && enabled && (
          <div className="p-3 bg-amber-50 dark:bg-amber-950 text-amber-800 dark:text-amber-200 rounded-lg text-sm">
            <strong>Note:</strong> SSO requires Supabase CLI configuration.
            Contact RowOps support for assisted setup.
          </div>
        )}
      </div>

      {/* IDP Domain */}
      <div className="p-4 bg-card rounded-lg border space-y-4">
        <div>
          <h3 className="font-semibold">Identity Provider Domain</h3>
          <p className="text-sm text-muted-foreground">
            The email domain for SSO login (e.g., company.com).
          </p>
        </div>
        <Input
          value={idpDomain}
          onChange={(e) => setIdpDomain(e.target.value)}
          placeholder="company.com"
        />
      </div>

      {/* Role Mappings */}
      <div className="p-4 bg-card rounded-lg border space-y-4">
        <div className="flex items-center justify-between">
          <div>
            <h3 className="font-semibold">Role Mappings</h3>
            <p className="text-sm text-muted-foreground">
              Map identity provider groups to RowOps roles.
            </p>
          </div>
          <Button size="sm" variant="outline" onClick={addMapping}>
            Add Mapping
          </Button>
        </div>

        <div>
          <label className="text-sm text-muted-foreground">
            Group claim name from IDP:
          </label>
          <Input
            value={idpGroupClaim}
            onChange={(e) => setIdpGroupClaim(e.target.value)}
            placeholder="groups"
            className="mt-1"
          />
        </div>

        {roleMappings.length === 0 ? (
          <p className="text-sm text-muted-foreground">
            No role mappings configured. Users will default to {defaultRole}.
          </p>
        ) : (
          <div className="space-y-3">
            {roleMappings.map((mapping, index) => (
              <div key={index} className="p-3 bg-muted rounded-lg space-y-2">
                <div className="flex items-center gap-2">
                  <Input
                    value={mapping.idpValue}
                    onChange={(e) => updateMapping(index, 'idpValue', e.target.value)}
                    placeholder="IDP group name"
                    className="flex-1"
                  />
                  <Button
                    size="sm"
                    variant="destructive"
                    onClick={() => removeMapping(index)}
                  >
                    Remove
                  </Button>
                </div>
                <div className="flex flex-wrap gap-2">
                  {AVAILABLE_ROLES.map((role) => (
                    <button
                      key={role}
                      type="button"
                      onClick={() => toggleMappingRole(index, role)}
                      className={`px-2 py-1 text-xs rounded-full border ${
                        mapping.rowopsRoles.includes(role)
                          ? 'bg-primary text-primary-foreground'
                          : 'bg-background'
                      }`}
                    >
                      {role}
                    </button>
                  ))}
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Default Role */}
      <div className="p-4 bg-card rounded-lg border space-y-4">
        <div>
          <h3 className="font-semibold">Default Role</h3>
          <p className="text-sm text-muted-foreground">
            Role assigned when no mapping matches.
          </p>
        </div>
        <select
          value={defaultRole}
          onChange={(e) => setDefaultRole(e.target.value)}
          className="w-full px-3 py-2 border rounded-md bg-background"
        >
          {AVAILABLE_ROLES.map((role) => (
            <option key={role} value={role}>
              {role}
            </option>
          ))}
        </select>
      </div>

      {/* Allow Override */}
      <div className="p-4 bg-card rounded-lg border">
        <label className="flex items-center gap-3">
          <input
            type="checkbox"
            checked={allowOverride}
            onChange={(e) => setAllowOverride(e.target.checked)}
            className="rounded"
          />
          <div>
            <span className="font-medium">Allow manual role override</span>
            <p className="text-sm text-muted-foreground">
              Facility admins can override SSO-derived roles for individual users.
            </p>
          </div>
        </label>
      </div>

      {/* Status messages */}
      {error && (
        <div className="p-3 bg-destructive/10 text-destructive rounded-lg text-sm">
          {error}
        </div>
      )}
      {success && (
        <div className="p-3 bg-green-50 dark:bg-green-950 text-green-800 dark:text-green-200 rounded-lg text-sm">
          {success}
        </div>
      )}

      {/* Save button */}
      <div className="flex justify-end">
        <Button onClick={handleSave} disabled={saving}>
          {saving ? 'Saving...' : 'Save Configuration'}
        </Button>
      </div>
    </div>
  );
}
```
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>SSO configuration form component created</done>
</task>

<task type="auto">
  <name>Task 2: Create SSO settings page</name>
  <files>src/app/(dashboard)/[slug]/settings/sso/page.tsx</files>
  <action>
Create the SSO settings page (facility admin only):

```tsx
import { getClaimsForApiRoute } from '@/lib/auth/claims';
import { redirect } from 'next/navigation';
import { SsoConfigForm } from '@/components/settings/sso-config-form';

export default async function SsoSettingsPage({
  params,
}: {
  params: Promise<{ slug: string }>;
}) {
  const { slug } = await params;
  const { user, clubId, roles, error } = await getClaimsForApiRoute();

  if (error || !user || !clubId) {
    redirect('/login');
  }

  // Only FACILITY_ADMIN can access SSO settings
  if (!roles.includes('FACILITY_ADMIN')) {
    redirect(`/${slug}/settings`);
  }

  return (
    <div className="container max-w-2xl py-8 space-y-8">
      <div>
        <h1 className="text-2xl font-bold">Single Sign-On (SSO)</h1>
        <p className="text-muted-foreground">
          Configure SAML SSO for your facility. All clubs under this facility
          will use the same identity provider.
        </p>
      </div>

      <SsoConfigForm />

      <div className="p-4 bg-muted rounded-lg text-sm space-y-2">
        <h3 className="font-semibold">Need help setting up SSO?</h3>
        <p className="text-muted-foreground">
          SAML SSO requires configuration in your identity provider (Okta, Azure AD,
          Google Workspace, etc.) and the Supabase CLI. Contact RowOps support for
          assisted setup.
        </p>
        <p className="text-muted-foreground">
          You'll need to provide your IDP's SAML metadata URL or upload the metadata file.
        </p>
      </div>
    </div>
  );
}
```

Create necessary directory: `src/app/(dashboard)/[slug]/settings/sso/`
  </action>
  <verify>TypeScript compiles without errors. Page accessible at /[slug]/settings/sso</verify>
  <done>SSO settings page created for facility admins</done>
</task>

</tasks>

<verification>
1. All TypeScript files compile without errors
2. SSO settings page only accessible to FACILITY_ADMIN
3. Form saves configuration via PUT /api/sso/config
4. Role mappings can be added, edited, and removed
</verification>

<success_criteria>
- SSO settings page redirects non-FACILITY_ADMIN users
- Form displays current SSO configuration
- Admins can enable/disable SSO
- Admins can configure IDP domain and group claim
- Admins can add/edit/remove role mappings
- Admins can set default role and override preference
- Configuration saves successfully
</success_criteria>

<output>
After completion, create `.planning/phases/11-mfa-sso/11-11-SUMMARY.md`
</output>
