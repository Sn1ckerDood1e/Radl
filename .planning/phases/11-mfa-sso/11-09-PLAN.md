---
phase: 11-mfa-sso
plan: 09
type: execute
wave: 3
depends_on: ["11-03"]
files_modified:
  - src/components/mfa/mfa-setup-dialog.tsx
  - src/components/mfa/mfa-verify-dialog.tsx
  - src/components/mfa/backup-codes-display.tsx
autonomous: true

must_haves:
  truths:
    - "User can see QR code to scan with authenticator app"
    - "User can enter and verify TOTP code"
    - "User can see and save backup codes"
  artifacts:
    - path: "src/components/mfa/mfa-setup-dialog.tsx"
      provides: "MFA enrollment UI"
      exports: ["MfaSetupDialog"]
    - path: "src/components/mfa/mfa-verify-dialog.tsx"
      provides: "MFA verification UI"
      exports: ["MfaVerifyDialog"]
    - path: "src/components/mfa/backup-codes-display.tsx"
      provides: "Backup codes display component"
      exports: ["BackupCodesDisplay"]
  key_links:
    - from: "src/components/mfa/mfa-setup-dialog.tsx"
      to: "/api/mfa/enroll"
      via: "fetch"
      pattern: "fetch.*api/mfa/enroll"
    - from: "src/components/mfa/mfa-verify-dialog.tsx"
      to: "/api/mfa/verify"
      via: "fetch"
      pattern: "fetch.*api/mfa/verify"
---

<objective>
Create MFA setup UI components for enrollment, verification, and backup codes.

Purpose: Enable users to enroll in MFA through a guided UI flow with QR code scanning, code verification, and backup code display.

Output: React components for complete MFA enrollment flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-mfa-sso/11-CONTEXT.md
@.planning/phases/11-mfa-sso/11-RESEARCH.md
@src/components/ui/dialog.tsx
@src/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backup codes display component</name>
  <files>src/components/mfa/backup-codes-display.tsx</files>
  <action>
Create reusable backup codes display component:

```tsx
'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';

interface BackupCodesDisplayProps {
  codes: string[];
  onConfirm: () => void;
}

/**
 * Displays backup codes and requires confirmation before continuing.
 * Used during MFA setup and backup code regeneration.
 */
export function BackupCodesDisplay({ codes, onConfirm }: BackupCodesDisplayProps) {
  const [confirmed, setConfirmed] = useState(false);

  const handleCopy = async () => {
    const text = codes.join('\n');
    await navigator.clipboard.writeText(text);
  };

  const handleDownload = () => {
    const text = codes.join('\n');
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'rowops-backup-codes.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  return (
    <div className="space-y-4">
      <div>
        <h3 className="text-lg font-semibold">Save Your Backup Codes</h3>
        <p className="text-sm text-muted-foreground mt-1">
          Store these codes somewhere safe. Each code can only be used once
          to access your account if you lose your authenticator.
        </p>
      </div>

      <div className="bg-muted p-4 rounded-lg">
        <div className="grid grid-cols-2 gap-2">
          {codes.map((code, i) => (
            <code
              key={i}
              className="font-mono text-sm bg-background px-2 py-1 rounded"
            >
              {code}
            </code>
          ))}
        </div>
      </div>

      <div className="flex gap-2">
        <Button variant="outline" size="sm" onClick={handleCopy}>
          Copy All
        </Button>
        <Button variant="outline" size="sm" onClick={handleDownload}>
          Download
        </Button>
      </div>

      <div className="border-t pt-4">
        <label className="flex items-center gap-2 text-sm">
          <input
            type="checkbox"
            checked={confirmed}
            onChange={(e) => setConfirmed(e.target.checked)}
            className="rounded"
          />
          I have saved my backup codes
        </label>
      </div>

      <Button
        onClick={onConfirm}
        disabled={!confirmed}
        className="w-full"
      >
        Continue
      </Button>
    </div>
  );
}
```

Create directory: `src/components/mfa/`
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>Backup codes display component created</done>
</task>

<task type="auto">
  <name>Task 2: Create MFA setup dialog</name>
  <files>src/components/mfa/mfa-setup-dialog.tsx</files>
  <action>
Create the MFA enrollment dialog with multi-step flow:

```tsx
'use client';

import { useState } from 'react';
import { QRCodeSVG } from 'qrcode.react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { BackupCodesDisplay } from './backup-codes-display';

interface MfaSetupDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onComplete: () => void;
}

type SetupStep = 'intro' | 'qr' | 'verify' | 'backup' | 'complete';

interface EnrollmentData {
  id: string;
  totp: {
    qr_code: string;
    secret: string;
    uri: string;
  };
  backupCodes: string[];
}

export function MfaSetupDialog({
  open,
  onOpenChange,
  onComplete,
}: MfaSetupDialogProps) {
  const [step, setStep] = useState<SetupStep>('intro');
  const [enrollment, setEnrollment] = useState<EnrollmentData | null>(null);
  const [code, setCode] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleStartEnroll = async () => {
    setLoading(true);
    setError('');

    try {
      const res = await fetch('/api/mfa/enroll', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ friendlyName: 'Authenticator App' }),
      });

      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.error || 'Failed to start enrollment');
      }

      const data = await res.json();
      setEnrollment(data);
      setStep('qr');
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to start enrollment');
    } finally {
      setLoading(false);
    }
  };

  const handleVerify = async () => {
    if (!enrollment || code.length !== 6) return;

    setLoading(true);
    setError('');

    try {
      const res = await fetch('/api/mfa/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          factorId: enrollment.id,
          code,
        }),
      });

      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.error || 'Invalid code');
      }

      setStep('backup');
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Verification failed');
    } finally {
      setLoading(false);
    }
  };

  const handleBackupConfirm = () => {
    setStep('complete');
    setTimeout(() => {
      onComplete();
      onOpenChange(false);
      // Reset state for next open
      setStep('intro');
      setEnrollment(null);
      setCode('');
    }, 1500);
  };

  const handleClose = () => {
    onOpenChange(false);
    // Reset state
    setStep('intro');
    setEnrollment(null);
    setCode('');
    setError('');
  };

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle>
            {step === 'intro' && 'Enable Two-Factor Authentication'}
            {step === 'qr' && 'Scan QR Code'}
            {step === 'verify' && 'Verify Setup'}
            {step === 'backup' && 'Backup Codes'}
            {step === 'complete' && 'Setup Complete'}
          </DialogTitle>
        </DialogHeader>

        {step === 'intro' && (
          <div className="space-y-4">
            <p className="text-sm text-muted-foreground">
              Add an extra layer of security to your account with an
              authenticator app like Google Authenticator or 1Password.
            </p>
            {error && <p className="text-sm text-destructive">{error}</p>}
            <Button
              onClick={handleStartEnroll}
              disabled={loading}
              className="w-full"
            >
              {loading ? 'Setting up...' : 'Get Started'}
            </Button>
          </div>
        )}

        {step === 'qr' && enrollment && (
          <div className="space-y-4">
            <p className="text-sm text-muted-foreground">
              Scan this QR code with your authenticator app:
            </p>

            <div className="flex justify-center p-4 bg-white rounded-lg">
              <QRCodeSVG value={enrollment.totp.uri} size={200} />
            </div>

            <details className="text-sm">
              <summary className="cursor-pointer text-muted-foreground hover:text-foreground">
                Can't scan? Enter code manually
              </summary>
              <code className="block mt-2 p-2 bg-muted rounded text-xs break-all">
                {enrollment.totp.secret}
              </code>
            </details>

            <Button onClick={() => setStep('verify')} className="w-full">
              Continue
            </Button>
          </div>
        )}

        {step === 'verify' && (
          <div className="space-y-4">
            <p className="text-sm text-muted-foreground">
              Enter the 6-digit code from your authenticator app:
            </p>

            <Input
              type="text"
              inputMode="numeric"
              maxLength={6}
              value={code}
              onChange={(e) => setCode(e.target.value.replace(/\D/g, ''))}
              placeholder="000000"
              className="text-center text-2xl tracking-widest font-mono"
              autoFocus
            />

            {error && <p className="text-sm text-destructive">{error}</p>}

            <Button
              onClick={handleVerify}
              disabled={code.length !== 6 || loading}
              className="w-full"
            >
              {loading ? 'Verifying...' : 'Verify'}
            </Button>
          </div>
        )}

        {step === 'backup' && enrollment && (
          <BackupCodesDisplay
            codes={enrollment.backupCodes}
            onConfirm={handleBackupConfirm}
          />
        )}

        {step === 'complete' && (
          <div className="text-center py-4">
            <div className="text-4xl mb-2">âœ“</div>
            <p className="text-lg font-medium">Two-factor authentication enabled!</p>
          </div>
        )}
      </DialogContent>
    </Dialog>
  );
}
```
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>MFA setup dialog created with complete enrollment flow</done>
</task>

<task type="auto">
  <name>Task 3: Create MFA verify dialog</name>
  <files>src/components/mfa/mfa-verify-dialog.tsx</files>
  <action>
Create MFA verification dialog for login challenges:

```tsx
'use client';

import { useState } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';

interface MfaVerifyDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  factorId: string;
  onSuccess: () => void;
  onCancel?: () => void;
}

type VerifyMode = 'totp' | 'backup';

export function MfaVerifyDialog({
  open,
  onOpenChange,
  factorId,
  onSuccess,
  onCancel,
}: MfaVerifyDialogProps) {
  const [mode, setMode] = useState<VerifyMode>('totp');
  const [code, setCode] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleVerify = async () => {
    setLoading(true);
    setError('');

    try {
      const body = mode === 'totp'
        ? { factorId, code }
        : { code: code.toUpperCase() };

      const res = await fetch('/api/mfa/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });

      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.error || 'Invalid code');
      }

      onSuccess();
      onOpenChange(false);
      setCode('');
      setMode('totp');
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Verification failed');
    } finally {
      setLoading(false);
    }
  };

  const handleClose = () => {
    if (onCancel) {
      onCancel();
    }
    onOpenChange(false);
    setCode('');
    setError('');
    setMode('totp');
  };

  const codeLength = mode === 'totp' ? 6 : 8;
  const codePattern = mode === 'totp' ? /^\d+$/ : /^[A-Za-z0-9]+$/;

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle>Two-Factor Authentication</DialogTitle>
        </DialogHeader>

        <div className="space-y-4">
          <p className="text-sm text-muted-foreground">
            {mode === 'totp'
              ? 'Enter the 6-digit code from your authenticator app:'
              : 'Enter one of your backup codes:'}
          </p>

          <Input
            type="text"
            inputMode={mode === 'totp' ? 'numeric' : 'text'}
            maxLength={codeLength}
            value={code}
            onChange={(e) => {
              const value = e.target.value;
              if (value === '' || codePattern.test(value)) {
                setCode(value);
              }
            }}
            placeholder={mode === 'totp' ? '000000' : 'ABCD1234'}
            className="text-center text-2xl tracking-widest font-mono"
            autoFocus
          />

          {error && <p className="text-sm text-destructive">{error}</p>}

          <Button
            onClick={handleVerify}
            disabled={code.length !== codeLength || loading}
            className="w-full"
          >
            {loading ? 'Verifying...' : 'Verify'}
          </Button>

          <button
            type="button"
            onClick={() => {
              setMode(mode === 'totp' ? 'backup' : 'totp');
              setCode('');
              setError('');
            }}
            className="w-full text-sm text-muted-foreground hover:text-foreground"
          >
            {mode === 'totp'
              ? 'Use a backup code instead'
              : 'Use authenticator app instead'}
          </button>
        </div>
      </DialogContent>
    </Dialog>
  );
}
```
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>MFA verification dialog created with TOTP and backup code support</done>
</task>

</tasks>

<verification>
1. All TypeScript files compile without errors
2. Components use existing UI primitives (Dialog, Button, Input)
3. QRCodeSVG renders correctly with TOTP URI
</verification>

<success_criteria>
- MfaSetupDialog guides user through enrollment with QR code
- MfaVerifyDialog accepts both TOTP codes and backup codes
- BackupCodesDisplay shows codes with copy/download options
- All components handle loading and error states
</success_criteria>

<output>
After completion, create `.planning/phases/11-mfa-sso/11-09-SUMMARY.md`
</output>
