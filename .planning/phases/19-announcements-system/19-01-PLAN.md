---
phase: 19-announcements-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/permissions/subjects.ts
  - src/lib/permissions/ability.ts
  - src/lib/validations/announcement.ts
autonomous: true

must_haves:
  truths:
    - "Announcement model exists in database with priority, title, body, expiry, practiceId"
    - "AnnouncementRead tracks which users have read which announcements"
    - "Coaches can manage announcements, athletes can read them"
    - "Validation enforces title length, body length, expiry in future"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Announcement and AnnouncementRead models with AnnouncementPriority enum"
      contains: "model Announcement"
    - path: "src/lib/permissions/subjects.ts"
      provides: "Announcement CASL subject"
      contains: "Announcement"
    - path: "src/lib/permissions/ability.ts"
      provides: "Coach manage, all read permissions for Announcement"
      contains: "can('manage', 'Announcement'"
    - path: "src/lib/validations/announcement.ts"
      provides: "Zod schemas for announcement CRUD"
      exports: ["createAnnouncementSchema", "updateAnnouncementSchema", "announcementPrioritySchema"]
  key_links:
    - from: "prisma/schema.prisma"
      to: "src/lib/validations/announcement.ts"
      via: "enum values match"
      pattern: "z\\.enum\\(\\['INFO', 'WARNING', 'URGENT'\\]\\)"
---

<objective>
Create the data foundation for the announcements system: database models, CASL permissions, and validation schemas.

Purpose: Establish the core data layer that API endpoints will build upon. Announcements need team-scoped storage with priority levels, optional practice linking, expiry dates, and per-user read tracking.

Output: Prisma schema with Announcement/AnnouncementRead models, CASL rules for coach manage + athlete read, Zod schemas for validation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-announcements-system/19-CONTEXT.md
@.planning/phases/19-announcements-system/19-RESEARCH.md

# Codebase patterns
@prisma/schema.prisma
@src/lib/permissions/subjects.ts
@src/lib/permissions/ability.ts
@src/lib/validations/practice.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Announcement and AnnouncementRead models to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add AnnouncementPriority enum with values INFO, WARNING, URGENT (in that order).

Add Announcement model with fields:
- id: String @id @default(uuid())
- teamId: String (required, relation to Team)
- title: String (100 char limit enforced at validation layer)
- body: String (1000 char limit at validation layer)
- priority: AnnouncementPriority @default(INFO)
- createdBy: String (userId who created)
- practiceId: String? (optional relation to Practice, onDelete: SetNull)
- expiresAt: DateTime? (null means no expiry)
- archivedAt: DateTime? (soft delete via archive)
- createdAt: DateTime @default(now())
- updatedAt: DateTime @updatedAt

Add relations:
- team: Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
- practice: Practice? @relation(fields: [practiceId], references: [id], onDelete: SetNull)
- readReceipts: AnnouncementRead[]

Add indexes:
- @@index([teamId, archivedAt]) for active announcements query
- @@index([teamId, priority, createdAt]) for sorted dashboard view
- @@index([practiceId]) for practice-linked lookups

Add AnnouncementRead model with fields:
- id: String @id @default(uuid())
- announcementId: String
- userId: String
- readAt: DateTime @default(now())
- announcement: Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)

Add constraints:
- @@unique([announcementId, userId]) to prevent duplicate reads
- @@index([userId])
- @@index([announcementId])

Add reverse relation on Team model: announcements Announcement[]
Add reverse relation on Practice model: announcements Announcement[]

Run prisma db push after schema changes.
  </action>
  <verify>
`npx prisma db push` succeeds without errors.
`npx prisma generate` creates types including Announcement, AnnouncementRead, AnnouncementPriority.
  </verify>
  <done>
Announcement and AnnouncementRead models exist in schema.prisma with all specified fields, relations, and indexes. Database is synchronized.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Announcement subject to CASL permissions</name>
  <files>src/lib/permissions/subjects.ts, src/lib/permissions/ability.ts</files>
  <action>
In src/lib/permissions/subjects.ts:
1. Import Announcement type from @/generated/prisma
2. Add Announcement to the Subjects type mapping (alongside Team, Practice, etc.)
3. Add 'Announcement' to SUBJECTS array

In src/lib/permissions/ability.ts:
Add Announcement permissions for each role:

FACILITY_ADMIN (facility view):
- can('read', 'Announcement') — read all in facility

FACILITY_ADMIN (club drill-down):
- can('read', 'Announcement', { teamId: user.clubId })

FACILITY_ADMIN (legacy mode):
- can('read', 'Announcement')

CLUB_ADMIN:
- can('read', 'Announcement', { teamId: user.clubId })

COACH:
- can('manage', 'Announcement', { teamId: user.clubId })

ATHLETE:
- can('read', 'Announcement', { teamId: user.clubId })

PARENT:
- can('read', 'Announcement', { teamId: user.clubId })

Note: Only COACH can create/update/delete (via 'manage'). All other roles can only read.
  </action>
  <verify>
TypeScript compilation succeeds: `npx tsc --noEmit`
Announcement appears in SubjectName type.
  </verify>
  <done>
Announcement is a recognized CASL subject. COACH role can manage announcements, all roles can read announcements in their team.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Zod validation schemas for announcements</name>
  <files>src/lib/validations/announcement.ts</files>
  <action>
Create new file src/lib/validations/announcement.ts following the pattern from practice.ts.

Add schemas:
1. announcementPrioritySchema: z.enum(['INFO', 'WARNING', 'URGENT'])

2. createAnnouncementSchema: z.object({
  title: z.string().min(1, 'Title is required').max(100, 'Title too long'),
  body: z.string().min(1, 'Body is required').max(1000, 'Body too long'),
  priority: announcementPrioritySchema.default('INFO'),
  practiceId: z.string().uuid().optional().nullable(),
  expiresAt: z.string().datetime().optional().nullable(),
}).refine that expiresAt must be in future if provided

3. updateAnnouncementSchema: createAnnouncementSchema.partial() — all fields optional

4. markAsReadSchema: z.object({}) — empty, just validates request exists

Export types:
- AnnouncementPriority
- CreateAnnouncementInput
- UpdateAnnouncementInput

Follow existing codebase patterns:
- Use z.string().datetime() for dates (not z.date())
- Use .optional().nullable() pattern for optional fields
- Include refine for business rules
  </action>
  <verify>
TypeScript compilation succeeds.
Types are correctly inferred: CreateAnnouncementInput includes all expected fields.
  </verify>
  <done>
src/lib/validations/announcement.ts exports createAnnouncementSchema, updateAnnouncementSchema, and announcementPrioritySchema with proper type inference.
  </done>
</task>

</tasks>

<verification>
1. `npx prisma db push` — schema synchronized with database
2. `npx prisma generate` — client generated with new types
3. `npx tsc --noEmit` — no TypeScript errors
4. Check generated types include Announcement, AnnouncementRead, AnnouncementPriority
</verification>

<success_criteria>
- Announcement model in schema with priority enum, relations to Team and Practice
- AnnouncementRead model for tracking per-user read state
- CASL recognizes Announcement subject with proper role permissions
- Validation schemas enforce title/body limits and expiry-in-future rule
- All TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/19-announcements-system/19-01-SUMMARY.md`
</output>
