---
phase: 19-announcements-system
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - src/app/api/announcements/route.ts
  - src/app/api/announcements/[id]/route.ts
  - src/app/api/announcements/[id]/read/route.ts
  - src/lib/utils/announcement-helpers.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/announcements returns active announcements for user's team, sorted by priority"
    - "POST /api/announcements creates announcement (coaches only)"
    - "PATCH /api/announcements/[id] updates announcement (coaches only)"
    - "DELETE /api/announcements/[id] archives announcement (sets archivedAt)"
    - "POST /api/announcements/[id]/read marks announcement as read for current user"
    - "Practice-linked announcements auto-filter by practice end time"
  artifacts:
    - path: "src/app/api/announcements/route.ts"
      provides: "GET list, POST create endpoints"
      exports: ["GET", "POST"]
    - path: "src/app/api/announcements/[id]/route.ts"
      provides: "PATCH update, DELETE archive endpoints"
      exports: ["PATCH", "DELETE"]
    - path: "src/app/api/announcements/[id]/read/route.ts"
      provides: "POST mark as read endpoint"
      exports: ["POST"]
    - path: "src/lib/utils/announcement-helpers.ts"
      provides: "Priority sorting, expiry checking utilities"
      exports: ["sortAnnouncementsByPriority", "buildActiveAnnouncementsQuery"]
  key_links:
    - from: "src/app/api/announcements/route.ts"
      to: "src/lib/validations/announcement.ts"
      via: "schema validation"
      pattern: "createAnnouncementSchema\\.safeParse"
    - from: "src/app/api/announcements/route.ts"
      to: "src/lib/utils/announcement-helpers.ts"
      via: "helper import"
      pattern: "sortAnnouncementsByPriority"
---

<objective>
Build the API layer for announcements: CRUD endpoints with proper authorization and the mark-as-read functionality.

Purpose: Enable frontend to fetch, create, update, archive, and mark announcements as read. API enforces CASL permissions (coach-only create/update, all roles can read).

Output: Three API route files plus a helpers library for priority sorting and query building.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-announcements-system/19-CONTEXT.md
@.planning/phases/19-announcements-system/19-RESEARCH.md
@.planning/phases/19-announcements-system/19-01-SUMMARY.md

# API patterns
@src/app/api/practices/route.ts
@src/app/api/practices/[id]/route.ts
@src/lib/validations/announcement.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create announcement helpers library</name>
  <files>src/lib/utils/announcement-helpers.ts</files>
  <action>
Create src/lib/utils/announcement-helpers.ts with:

1. PRIORITY_ORDER constant:
```typescript
const PRIORITY_ORDER = { URGENT: 0, WARNING: 1, INFO: 2 } as const;
```

2. sortAnnouncementsByPriority function:
- Takes array of announcements (with priority field)
- Sorts by priority (URGENT first, then WARNING, then INFO)
- Within same priority, sorts by createdAt descending (newest first)
- Returns sorted array (does not mutate original)

3. buildActiveAnnouncementsQuery function:
- Takes teamId and optional practiceId
- Returns Prisma where clause for active announcements:
  - archivedAt: null (not archived)
  - OR clause for expiry:
    - Non-practice: expiresAt null OR expiresAt > now
    - Practice-linked: practice.endTime > now
- Optionally filter by practiceId for practice-detail page

Note: Prisma sorts enums alphabetically (INFO, URGENT, WARNING) which doesn't match business priority order. Always use client-side sort after query.
  </action>
  <verify>
TypeScript compilation succeeds.
Export types are correct.
  </verify>
  <done>
Helper functions exist for priority sorting and query building. Handles practice-linked auto-expiry logic.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GET/POST /api/announcements endpoints</name>
  <files>src/app/api/announcements/route.ts</files>
  <action>
Create src/app/api/announcements/route.ts following practices/route.ts pattern.

GET endpoint:
1. Get auth context via getAuthContext(request)
2. Handle 401/403 with standard responses
3. Extract optional query params: practiceId (for practice-specific announcements)
4. Build where clause using buildActiveAnnouncementsQuery(context.clubId, practiceId)
5. Query announcements with include:
   - readReceipts filtered to current user: { where: { userId: context.userId } }
   - practice: { select: { id, name, date, endTime } }
   - creator info if needed
6. Sort results using sortAnnouncementsByPriority
7. Map results to include `isRead: readReceipts.length > 0` boolean
8. Return { announcements: [...] }

POST endpoint:
1. Get auth context
2. Check permission: context.ability.can('manage', 'Announcement')
3. Parse and validate body with createAnnouncementSchema
4. If practiceId provided, verify practice belongs to team
5. Create announcement with:
   - teamId: context.clubId
   - createdBy: context.userId
   - validated data fields
6. Return { announcement }, status 201

Use standard error handlers: unauthorizedResponse, forbiddenResponse, serverErrorResponse
  </action>
  <verify>
`curl -X GET http://localhost:3000/api/announcements` with auth returns announcement list.
`curl -X POST http://localhost:3000/api/announcements` with coach auth and valid body creates announcement.
Non-coach POST returns 403.
  </verify>
  <done>
GET returns active announcements sorted by priority with read status. POST creates announcements (coach-only).
  </done>
</task>

<task type="auto">
  <name>Task 3: Create PATCH/DELETE /api/announcements/[id] and POST read endpoints</name>
  <files>src/app/api/announcements/[id]/route.ts, src/app/api/announcements/[id]/read/route.ts</files>
  <action>
Create src/app/api/announcements/[id]/route.ts:

PATCH endpoint (update):
1. Get auth context
2. Check permission: context.ability.can('manage', 'Announcement')
3. Extract id from params
4. Verify announcement exists and belongs to team (teamId: context.clubId)
5. Parse body with updateAnnouncementSchema
6. If practiceId changing, verify new practice belongs to team
7. Update announcement with validated fields
8. Return { announcement }

DELETE endpoint (archive, not hard delete):
1. Get auth context
2. Check permission: context.ability.can('manage', 'Announcement')
3. Extract id from params
4. Verify announcement exists and belongs to team
5. Set archivedAt: new Date() (soft delete)
6. Return { success: true }

Create src/app/api/announcements/[id]/read/route.ts:

POST endpoint (mark as read):
1. Get auth context (any authenticated user can mark as read)
2. Extract id from params
3. Verify announcement exists and belongs to user's team
4. Upsert AnnouncementRead:
   - where: { announcementId_userId: { announcementId: id, userId: context.userId } }
   - create: { announcementId: id, userId: context.userId }
   - update: {} (no-op if already exists)
5. Return { success: true }

Note: Using upsert prevents duplicate key errors if user marks same announcement read multiple times.
  </action>
  <verify>
`curl -X PATCH /api/announcements/{id}` with coach auth updates announcement.
`curl -X DELETE /api/announcements/{id}` with coach auth sets archivedAt.
`curl -X POST /api/announcements/{id}/read` with any auth creates read receipt.
Non-coach PATCH/DELETE returns 403.
  </verify>
  <done>
PATCH updates announcements, DELETE archives them (soft delete), POST read marks as read with upsert to prevent duplicates.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` — server starts without errors
2. `npx tsc --noEmit` — TypeScript compilation passes
3. Manual API tests:
   - GET /api/announcements returns empty array initially
   - POST /api/announcements with coach creates announcement
   - GET returns the created announcement with isRead: false
   - POST /api/announcements/{id}/read marks it read
   - GET now returns isRead: true
   - PATCH updates title/body/priority
   - DELETE sets archivedAt, subsequent GET excludes it
</verification>

<success_criteria>
- All API endpoints return correct status codes (200, 201, 400, 401, 403, 404)
- CASL permissions enforced (only coaches can create/update/delete)
- Priority sorting works correctly (URGENT > WARNING > INFO)
- Practice-linked announcements filter by practice.endTime
- Read receipts tracked per-user with upsert pattern
- Archived announcements excluded from GET results
</success_criteria>

<output>
After completion, create `.planning/phases/19-announcements-system/19-02-SUMMARY.md`
</output>
