---
phase: 19-announcements-system
plan: 04
type: execute
wave: 4
depends_on: ["19-03"]
files_modified:
  - src/app/(dashboard)/[teamSlug]/announcements/page.tsx
  - src/components/announcements/create-announcement-form.tsx
  - src/app/(dashboard)/[teamSlug]/page.tsx
  - src/app/(dashboard)/[teamSlug]/layout.tsx
autonomous: false

must_haves:
  truths:
    - "Coach can access /[teamSlug]/announcements to manage announcements"
    - "Coach can create announcements with title, body, priority, optional expiry and practice link"
    - "Coach can edit and archive existing announcements"
    - "Dashboard shows announcements widget for all users"
    - "Urgent announcements show as banner at top of team pages"
    - "Athletes see announcements on dashboard but cannot create/edit"
  artifacts:
    - path: "src/app/(dashboard)/[teamSlug]/announcements/page.tsx"
      provides: "Coach announcement management page"
      contains: "AnnouncementList"
    - path: "src/components/announcements/create-announcement-form.tsx"
      provides: "Form for creating/editing announcements"
      exports: ["CreateAnnouncementForm"]
    - path: "src/app/(dashboard)/[teamSlug]/page.tsx"
      provides: "Dashboard with announcements widget"
      contains: "AnnouncementList"
    - path: "src/app/(dashboard)/[teamSlug]/layout.tsx"
      provides: "Layout with urgent banner integration"
      contains: "AnnouncementBanner"
  key_links:
    - from: "src/app/(dashboard)/[teamSlug]/announcements/page.tsx"
      to: "/api/announcements"
      via: "form submission"
      pattern: "fetch.*api/announcements"
    - from: "src/app/(dashboard)/[teamSlug]/layout.tsx"
      to: "src/components/announcements/announcement-banner.tsx"
      via: "component import"
      pattern: "AnnouncementBanner"
---

<objective>
Integrate announcements into the application: coach management page, dashboard widget, and urgent banner in layout.

Purpose: Complete the user-facing announcements experience. Coaches get a dedicated page to create/manage announcements. All users see announcements on dashboard. Urgent items show as banners.

Output: Management page, create/edit form, dashboard integration, and layout banner integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-announcements-system/19-CONTEXT.md
@.planning/phases/19-announcements-system/19-RESEARCH.md
@.planning/phases/19-announcements-system/19-03-SUMMARY.md

# Page patterns
@src/app/(dashboard)/[teamSlug]/page.tsx
@src/app/(dashboard)/[teamSlug]/layout.tsx
@src/components/practices/practice-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create announcement management page and form</name>
  <files>src/app/(dashboard)/[teamSlug]/announcements/page.tsx, src/components/announcements/create-announcement-form.tsx</files>
  <action>
Create src/components/announcements/create-announcement-form.tsx:

'use client' component for creating/editing announcements.

Props interface:
```typescript
interface CreateAnnouncementFormProps {
  teamSlug: string;
  practices?: Array<{ id: string; name: string; date: string }>;  // For practice linking
  announcement?: {  // If editing
    id: string;
    title: string;
    body: string;
    priority: 'INFO' | 'WARNING' | 'URGENT';
    practiceId?: string | null;
    expiresAt?: string | null;
  };
  onSuccess?: () => void;
  onCancel?: () => void;
}
```

Form fields:
- Title: Input (required, max 100 chars)
- Body: Textarea (required, max 1000 chars)
- Priority: Select with three options (INFO default, WARNING, URGENT)
- Practice Link: Optional Select showing upcoming practices
- Expiry: Optional date picker (or leave empty for no expiry)

Submit handler:
- POST /api/announcements for new
- PATCH /api/announcements/{id} for edit
- Show toast on success (sonner)
- Call onSuccess callback

Use existing form patterns: Input, Select from shadcn/ui, Button for submit.
Client-side validation with Zod before submit.

---

Create src/app/(dashboard)/[teamSlug]/announcements/page.tsx:

Server component with client interactivity via child components.

1. Get auth context, verify coach role (redirect if not coach)
2. Fetch active announcements for team (server-side)
3. Fetch upcoming practices for practice-link dropdown
4. Render page structure:
   - Header: "Announcements" with description
   - Create button (opens form in dialog or inline)
   - List of announcements with edit/archive actions

For each announcement:
- Show AnnouncementCard
- Edit button -> opens form with announcement data
- Archive button -> DELETE /api/announcements/{id}

Include EmptyState when no announcements with "Create your first announcement" CTA.

Page accessible only to coaches (check ability.can('manage', 'Announcement')).
Athletes who visit see redirect or access denied.
  </action>
  <verify>
Coach can access /[teamSlug]/announcements page.
Form validates input and submits successfully.
New announcements appear in list.
Edit pre-fills form with existing data.
Archive removes from list.
Non-coaches redirected away.
  </verify>
  <done>
Coach management page exists at /[teamSlug]/announcements. Form supports create/edit with validation. Archive removes announcements from active list.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate announcements into dashboard and layout</name>
  <files>src/app/(dashboard)/[teamSlug]/page.tsx, src/app/(dashboard)/[teamSlug]/layout.tsx</files>
  <action>
Update src/app/(dashboard)/[teamSlug]/page.tsx:

Add announcements section to dashboard:

1. Fetch active announcements for team (server-side, include read status for current user)
2. Add AnnouncementList widget to dashboard layout:
   - Place ABOVE the "Main Navigation Cards" section
   - After any alerts (damage reports) but before navigation cards
   - Pass initialAnnouncements for SSR

For coaches: Show "Manage" link to /[teamSlug]/announcements in widget header.
For athletes: Show read-only list.

If no announcements, optionally hide widget or show subtle empty state.

---

Update src/app/(dashboard)/[teamSlug]/layout.tsx:

Add urgent announcement banner:

1. Fetch most recent URGENT announcement that is:
   - Not archived
   - Not expired
   - Not practice-linked OR practice hasn't ended

2. If urgent announcement exists, render AnnouncementBanner:
   - Place inside main content area, at top before children
   - NOT in the nav areas

Layout structure update:
```tsx
<main className="flex-1 overflow-y-auto pb-20 md:pb-0">
  {urgentAnnouncement && (
    <div className="container mx-auto px-4 pt-4">
      <AnnouncementBanner announcement={urgentAnnouncement} />
    </div>
  )}
  <div className="container mx-auto px-4 py-8">
    {children}
  </div>
</main>
```

Note: Only show the MOST RECENT urgent announcement as banner to avoid banner fatigue.
Multiple urgent announcements still appear in dashboard list.
  </action>
  <verify>
Dashboard shows announcements widget with correct data.
Urgent announcement appears as banner at top of team pages.
Dismissing banner persists across navigation within team.
Widget shows "Manage" link for coaches only.
  </verify>
  <done>
Dashboard displays announcements widget. Layout shows urgent banner. Widget respects coach/athlete role differences.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete announcements flow</name>
  <what-built>Complete announcements system including data model, API, components, and page integrations</what-built>
  <how-to-verify>
Test the full announcements flow:

1. **As Coach:**
   - Navigate to team dashboard
   - Click "Manage" in announcements widget OR go to /{teamSlug}/announcements
   - Create INFO announcement with title "Practice reminder" and body "Bring water"
   - Verify it appears in dashboard widget
   - Create URGENT announcement with title "Dock closed" and body "Use alternate entrance"
   - Verify red banner appears at top of team pages
   - Dismiss banner with X button
   - Navigate to different team page - banner should stay dismissed
   - Refresh page - banner should stay dismissed
   - Edit the INFO announcement to change priority to WARNING
   - Verify amber color in widget
   - Archive the WARNING announcement
   - Verify it disappears from widget

2. **As Athlete:**
   - Log in as athlete on same team
   - Navigate to team dashboard
   - Verify announcements widget shows (read-only)
   - Verify NO "Manage" link
   - Verify cannot access /{teamSlug}/announcements directly
   - Click announcement to expand body
   - Click "Mark as read"
   - Verify visual change (dimmed, checkmark)
   - Verify urgent banner shows if not dismissed

3. **Practice-Linked Test:**
   - As coach, create announcement linked to a future practice
   - Verify it shows on dashboard
   - (Future: verify it shows on practice detail page)

Expected behaviors:
- Priority colors: blue (INFO), amber (WARNING), red (URGENT)
- Sort order: URGENT first, then WARNING, then INFO
- Banner only for most recent URGENT
- Dismissed state persists via localStorage
  </how-to-verify>
  <resume-signal>Type "approved" if all flows work correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npm run dev` — app runs without errors
2. `npx tsc --noEmit` — TypeScript passes
3. Coach flow: create, edit, archive announcements
4. Athlete flow: view, mark as read, cannot manage
5. Banner: shows for urgent, dismisses with persistence
6. Dashboard: widget shows sorted announcements
</verification>

<success_criteria>
- Coach management page at /[teamSlug]/announcements
- Form validates and submits correctly
- Dashboard widget displays announcements for all users
- Coaches see "Manage" link, athletes do not
- Urgent banner appears in layout for URGENT priority
- Banner dismissal persists in localStorage
- Mark as read updates visual state
- Priority sorting correct (URGENT > WARNING > INFO)
- ANN-01, ANN-02, ANN-03 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/19-announcements-system/19-04-SUMMARY.md`
</output>
