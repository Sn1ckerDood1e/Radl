---
phase: 36-admin-foundation-auth
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/auth/admin-authorize.ts
  - src/lib/auth/claims.ts
  - src/lib/permissions/ability.ts
  - src/lib/permissions/subjects.ts
  - src/lib/permissions/actions.ts
  - src/lib/audit/actions.ts
  - src/lib/audit/logger.ts
autonomous: true

must_haves:
  truths:
    - "isSuperAdmin() function queries database to verify super admin status"
    - "requireSuperAdmin() redirects non-admins to home page (silent redirect)"
    - "CASL abilities grant can('manage', 'all') to super admins"
    - "Admin audit logging captures before/after state in metadata"
  artifacts:
    - path: "src/lib/auth/admin-authorize.ts"
      provides: "Super admin verification helpers"
      exports: ["isSuperAdmin", "requireSuperAdmin", "getSuperAdminContext"]
    - path: "src/lib/permissions/ability.ts"
      provides: "Extended CASL ability with isSuperAdmin support"
      contains: "isSuperAdmin"
    - path: "src/lib/audit/logger.ts"
      provides: "Extended audit logging with admin action support"
      exports: ["logAdminAction"]
  key_links:
    - from: "src/lib/auth/admin-authorize.ts"
      to: "prisma.superAdmin"
      via: "findUnique query"
      pattern: "prisma\\.superAdmin\\.findUnique"
    - from: "src/lib/permissions/ability.ts"
      to: "can('manage', 'all')"
      via: "super admin condition"
      pattern: "can\\('manage',\\s*'all'\\)"
---

<objective>
Create authentication and permission infrastructure for super admin

Purpose: AUTH-02 requires database verification on every request, AUTH-04 requires CASL integration with can('manage', 'all'). This plan creates the auth helpers, extends CASL abilities, and enhances audit logging for admin actions.

Output: admin-authorize.ts with database-verified super admin checks, extended ability.ts with isSuperAdmin support, enhanced audit logger for admin actions with before/after state
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/36-admin-foundation-auth/36-CONTEXT.md
@.planning/phases/36-admin-foundation-auth/36-RESEARCH.md
@src/lib/auth/authorize.ts
@src/lib/auth/claims.ts
@src/lib/permissions/ability.ts
@src/lib/permissions/subjects.ts
@src/lib/permissions/actions.ts
@src/lib/audit/logger.ts
@src/lib/audit/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin-authorize.ts with database-verified super admin checks</name>
  <files>src/lib/auth/admin-authorize.ts</files>
  <action>
Create a new file src/lib/auth/admin-authorize.ts with super admin authentication helpers.

Key functions:

1. `isSuperAdmin(userId: string): Promise<boolean>`
   - Queries SuperAdmin table directly
   - Returns true if record exists, false otherwise
   - SECURITY: Always queries database, never trusts JWT claims alone

2. `requireSuperAdmin(): Promise<User>`
   - Calls requireAuth() from authorize.ts
   - Calls isSuperAdmin() with user ID
   - If not super admin, redirects to '/' (silent redirect per CONTEXT.md)
   - Returns user object if authorized

3. `getSuperAdminContext(): Promise<AdminContext | null>`
   - For API routes that need admin context
   - Returns { userId, isSuperAdmin: true } or null
   - Does NOT redirect, just returns null for unauthorized

Important:
- Import requireAuth, getAuthUser from './authorize'
- Import prisma from '@/lib/prisma'
- Import redirect from 'next/navigation'
- Include JSDoc comments explaining security rationale (database-verified, not JWT)
  </action>
  <verify>
- File exists at src/lib/auth/admin-authorize.ts
- Exports isSuperAdmin, requireSuperAdmin, getSuperAdminContext
- Contains prisma.superAdmin.findUnique query
- Silent redirect to '/' for non-admins
  </verify>
  <done>admin-authorize.ts provides database-verified super admin authentication helpers</done>
</task>

<task type="auto">
  <name>Task 2: Extend CASL ability.ts with super admin support</name>
  <files>src/lib/permissions/ability.ts, src/lib/permissions/subjects.ts, src/lib/permissions/actions.ts, src/lib/auth/claims.ts</files>
  <action>
Extend the CASL ability system to support super admin with full platform access.

**ability.ts changes:**

1. Add `isSuperAdmin?: boolean` to UserContext interface

2. Add super admin handling at the START of defineAbilityFor():
```typescript
// SUPER ADMIN - platform owner, full access
if (user.isSuperAdmin) {
  can('manage', 'all');  // CASL special keyword for full access
  return build();  // Early return - no need to process other roles
}
```

The `can('manage', 'all')` pattern is CASL's built-in way to grant all permissions on all subjects.

**subjects.ts changes:**

Add 'all' as a valid subject (CASL special keyword):
```typescript
export type AppSubjects =
  | Subjects<{...existing...}>
  | 'AuditLog'
  | 'ApiKey'
  | 'all';  // CASL special keyword for super admin
```

**actions.ts changes:**

Add admin-specific action:
```typescript
// Admin-specific
accessAdminPanel: 'access-admin-panel',
```

**claims.ts changes:**

If CustomJwtPayload interface exists, add:
```typescript
is_super_admin?: boolean;
```

This allows the JWT claim to be typed correctly when checking via fast path (though database is source of truth).
  </action>
  <verify>
- UserContext interface includes isSuperAdmin?: boolean
- defineAbilityFor checks isSuperAdmin first
- 'all' added to AppSubjects type
- TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>CASL abilities extended with super admin support granting can('manage', 'all')</done>
</task>

<task type="auto">
  <name>Task 3: Extend audit logger for admin actions with before/after state</name>
  <files>src/lib/audit/logger.ts, src/lib/audit/actions.ts</files>
  <action>
Enhance the audit logging system to support admin actions with before/after state capture.

**actions.ts additions:**

Add admin-specific audit actions:
```typescript
// Admin panel actions
ADMIN_USER_CREATED: 'ADMIN_USER_CREATED',
ADMIN_USER_DEACTIVATED: 'ADMIN_USER_DEACTIVATED',
ADMIN_USER_REACTIVATED: 'ADMIN_USER_REACTIVATED',
ADMIN_PASSWORD_RESET: 'ADMIN_PASSWORD_RESET',
ADMIN_ROLE_CHANGED: 'ADMIN_ROLE_CHANGED',
ADMIN_MEMBERSHIP_ADDED: 'ADMIN_MEMBERSHIP_ADDED',
ADMIN_MEMBERSHIP_REMOVED: 'ADMIN_MEMBERSHIP_REMOVED',
ADMIN_FACILITY_CREATED: 'ADMIN_FACILITY_CREATED',
ADMIN_FACILITY_UPDATED: 'ADMIN_FACILITY_UPDATED',
ADMIN_CLUB_CREATED: 'ADMIN_CLUB_CREATED',
ADMIN_CLUB_UPDATED: 'ADMIN_CLUB_UPDATED',
```

Also add to AUDIT_ACTION_DESCRIPTIONS.

**logger.ts additions:**

1. Add AdminAuditEntry interface extending AuditEntry:
```typescript
export interface AdminAuditEntry extends AuditEntry {
  beforeState?: Record<string, unknown>;
  afterState?: Record<string, unknown>;
}
```

2. Add logAdminAction function:
```typescript
/**
 * Log an admin action with before/after state capture.
 * Uses 'PLATFORM' as clubId to indicate platform-level action.
 *
 * AUDT-01 compliance: Records actor, action, target, timestamp, and state changes.
 */
export async function logAdminAction(
  context: { userId: string; ipAddress?: string; userAgent?: string },
  entry: AdminAuditEntry
): Promise<void> {
  await prisma.auditLog.create({
    data: {
      clubId: 'PLATFORM',  // Special marker for platform-level actions
      userId: context.userId,
      action: entry.action,
      targetType: entry.targetType,
      targetId: entry.targetId ?? null,
      metadata: {
        ...(entry.metadata as Record<string, unknown> || {}),
        beforeState: entry.beforeState ?? null,
        afterState: entry.afterState ?? null,
      },
      ipAddress: context.ipAddress ?? null,
      userAgent: context.userAgent ?? null,
    },
  });
}
```

3. Add createAdminAuditLogger factory:
```typescript
/**
 * Create bound admin audit logger from request.
 * Auto-extracts IP and user agent.
 */
export function createAdminAuditLogger(
  request: Request,
  userId: string
) {
  const forwardedFor = request.headers.get('x-forwarded-for');
  const ipAddress = forwardedFor?.split(',')[0]?.trim() ??
    request.headers.get('x-real-ip') ??
    undefined;
  const userAgent = request.headers.get('user-agent') ?? undefined;

  return {
    log: (entry: AdminAuditEntry) =>
      logAdminAction({ userId, ipAddress, userAgent }, entry),
  };
}
```
  </action>
  <verify>
- actions.ts contains ADMIN_* actions
- logger.ts exports AdminAuditEntry interface
- logger.ts exports logAdminAction function
- logger.ts exports createAdminAuditLogger function
- Uses 'PLATFORM' as clubId for admin actions
  </verify>
  <done>Audit logging extended with admin-specific actions and before/after state capture (AUDT-01)</done>
</task>

</tasks>

<verification>
After all tasks:

1. Type checking:
   - `npx tsc --noEmit` passes with no type errors

2. Export verification:
   - admin-authorize.ts exports: isSuperAdmin, requireSuperAdmin, getSuperAdminContext
   - ability.ts UserContext has isSuperAdmin
   - logger.ts exports: logAdminAction, createAdminAuditLogger, AdminAuditEntry

3. Integration check:
   - isSuperAdmin queries prisma.superAdmin
   - defineAbilityFor handles isSuperAdmin with can('manage', 'all')
   - logAdminAction uses 'PLATFORM' clubId
</verification>

<success_criteria>
- admin-authorize.ts provides isSuperAdmin(), requireSuperAdmin(), getSuperAdminContext()
- Database query (not JWT) verifies super admin status
- CASL abilities grant can('manage', 'all') to super admins
- Audit logging supports admin actions with before/after state (AUDT-01)
- All TypeScript types correct and compiling
</success_criteria>

<output>
After completion, create `.planning/phases/36-admin-foundation-auth/36-02-SUMMARY.md`
</output>
