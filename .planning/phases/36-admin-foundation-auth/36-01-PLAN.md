---
phase: 36-admin-foundation-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - supabase/migrations/00018_super_admin.sql
  - scripts/seed-super-admin.ts
autonomous: true

must_haves:
  truths:
    - "SuperAdmin table exists in database with userId unique index"
    - "Access token hook includes is_super_admin claim in JWT"
    - "Seed script can create first super admin record"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "SuperAdmin model definition"
      contains: "model SuperAdmin"
    - path: "supabase/migrations/00018_super_admin.sql"
      provides: "SuperAdmin table creation and access token hook update"
      contains: "is_super_admin"
    - path: "scripts/seed-super-admin.ts"
      provides: "Script to create first super admin"
      contains: "prisma.superAdmin.create"
  key_links:
    - from: "supabase/migrations/00018_super_admin.sql"
      to: "public.SuperAdmin"
      via: "CREATE TABLE statement"
      pattern: "CREATE TABLE.*SuperAdmin"
    - from: "supabase/migrations/00018_super_admin.sql"
      to: "custom_access_token_hook"
      via: "ALTER FUNCTION"
      pattern: "is_super_admin"
---

<objective>
Create database infrastructure for super admin authentication

Purpose: AUTH-01 requires super admin role stored in database table (not JWT claims only). The SuperAdmin table provides database-verified access control, and the access token hook update adds is_super_admin claim for fast middleware checks while database query remains the source of truth.

Output: SuperAdmin Prisma model, Supabase migration creating table and updating access token hook, seed script for creating first super admin
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/36-admin-foundation-auth/36-CONTEXT.md
@.planning/phases/36-admin-foundation-auth/36-RESEARCH.md
@prisma/schema.prisma
@supabase/migrations/00003_custom_access_token_hook.sql
@supabase/migrations/00006_facility_access_token_hook.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SuperAdmin model to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the SuperAdmin model to the Prisma schema. This model tracks platform-level admin status independent of facility/club membership.

Add after the AuditLog model (around line 932):

```prisma
// Super admin for platform-level access (database-verified, not just JWT)
model SuperAdmin {
  id        String   @id @default(uuid())
  userId    String   @unique  // Supabase auth.users ID
  createdAt DateTime @default(now())
  createdBy String?  // userId who granted super admin (for audit trail)

  @@index([userId])
}
```

Run `npx prisma generate` to update the Prisma client.

Important:
- userId is unique (one SuperAdmin record per user)
- createdBy is optional (first super admin may be seeded without an actor)
- Index on userId for fast lookups
  </action>
  <verify>
- `npx prisma generate` completes without errors
- `grep -n "model SuperAdmin" prisma/schema.prisma` shows the new model
- TypeScript can import SuperAdmin type from generated client
  </verify>
  <done>SuperAdmin model added to schema.prisma with userId unique constraint and proper index</done>
</task>

<task type="auto">
  <name>Task 2: Create Supabase migration for SuperAdmin table and access token hook</name>
  <files>supabase/migrations/00018_super_admin.sql</files>
  <action>
Create a new migration file that:
1. Creates the SuperAdmin table to match Prisma schema
2. Adds RLS policies for SuperAdmin table (only super admins can query it)
3. Updates the custom_access_token_hook to include is_super_admin claim

The migration should:
- Create table with same structure as Prisma model (id UUID, userId TEXT UNIQUE, createdAt TIMESTAMPTZ, createdBy TEXT)
- Enable RLS on SuperAdmin table
- Add policy allowing only super admins to read (prevents regular users from seeing who is admin)
- Modify custom_access_token_hook to SELECT EXISTS from SuperAdmin and add is_super_admin boolean claim

Note: Look at 00006_facility_access_token_hook.sql for the current hook structure. The hook already handles team_id, facility_id, club_id, and roles. Add is_super_admin check at the beginning so it's evaluated first.

The hook update should be CREATE OR REPLACE FUNCTION to update the existing function.
  </action>
  <verify>
- File exists at supabase/migrations/00018_super_admin.sql
- SQL syntax is valid (no obvious syntax errors)
- Contains CREATE TABLE "SuperAdmin"
- Contains SELECT EXISTS for super admin check
- Contains is_super_admin claim addition
  </verify>
  <done>Migration creates SuperAdmin table with RLS and updates access token hook to include is_super_admin claim</done>
</task>

<task type="auto">
  <name>Task 3: Create seed script for first super admin</name>
  <files>scripts/seed-super-admin.ts</files>
  <action>
Create a TypeScript script to seed the first super admin. This script:
- Takes a user ID (or email to look up) as command-line argument
- Creates a SuperAdmin record for that user
- Logs success/failure

Per CONTEXT.md: "First super admin created via database seed/migration script"

Script pattern:
```typescript
// scripts/seed-super-admin.ts
// Usage: npx tsx scripts/seed-super-admin.ts <userId>

import { PrismaClient } from '../src/generated/prisma';

const prisma = new PrismaClient();

async function main() {
  const userId = process.argv[2];

  if (!userId) {
    console.error('Usage: npx tsx scripts/seed-super-admin.ts <userId>');
    console.error('  userId: Supabase auth.users ID (UUID)');
    process.exit(1);
  }

  // Check if already exists
  const existing = await prisma.superAdmin.findUnique({
    where: { userId },
  });

  if (existing) {
    console.log(`User ${userId} is already a super admin (since ${existing.createdAt})`);
    process.exit(0);
  }

  // Create super admin
  const superAdmin = await prisma.superAdmin.create({
    data: {
      userId,
      createdBy: null, // First admin has no creator
    },
  });

  console.log(`Created super admin record:`);
  console.log(`  ID: ${superAdmin.id}`);
  console.log(`  User ID: ${superAdmin.userId}`);
  console.log(`  Created: ${superAdmin.createdAt}`);
}

main()
  .catch((e) => {
    console.error('Error:', e.message);
    process.exit(1);
  })
  .finally(() => prisma.$disconnect());
```

Also add a README comment at top explaining:
- This is a one-time setup script
- Super admin cannot be granted via UI (intentional security)
- Additional super admins require direct database INSERT
  </action>
  <verify>
- File exists at scripts/seed-super-admin.ts
- Running `npx tsx scripts/seed-super-admin.ts` without args shows usage message
- Script imports PrismaClient from correct path
  </verify>
  <done>Seed script allows creating first super admin by user ID via command line</done>
</task>

</tasks>

<verification>
After all tasks:

1. Schema validation:
   - `npx prisma validate` passes
   - SuperAdmin model is in schema.prisma

2. Migration readiness:
   - 00018_super_admin.sql exists and has valid SQL
   - Migration includes table creation, RLS, and hook update

3. Seed script:
   - scripts/seed-super-admin.ts exists
   - Can be parsed by TypeScript (`npx tsc --noEmit scripts/seed-super-admin.ts` or similar)
</verification>

<success_criteria>
- SuperAdmin model added to Prisma schema with userId unique constraint
- Migration file creates SuperAdmin table with proper RLS
- Access token hook updated to include is_super_admin boolean claim
- Seed script ready to create first super admin via command line
- All artifacts committed to git
</success_criteria>

<output>
After completion, create `.planning/phases/36-admin-foundation-auth/36-01-SUMMARY.md`
</output>
