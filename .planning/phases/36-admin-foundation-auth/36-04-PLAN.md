---
phase: 36-admin-foundation-auth
plan: 04
type: execute
wave: 2
depends_on: ["36-01", "36-02"]
files_modified:
  - src/app/(admin)/layout.tsx
  - src/app/(admin)/page.tsx
  - src/components/admin/admin-sidebar.tsx
  - src/components/admin/admin-header.tsx
  - src/components/admin/platform-stats.tsx
  - src/components/layout/dashboard-header.tsx
  - src/app/(dashboard)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Super admin can navigate to /admin and see admin dashboard"
    - "Non-admin user attempting /admin is redirected to home"
    - "Super admin without MFA is redirected to MFA setup"
    - "Admin panel has sidebar navigation (Users, Facilities, Clubs, Audit Log)"
    - "Admin Panel link appears in user menu for super admins only"
  artifacts:
    - path: "src/app/(admin)/layout.tsx"
      provides: "Admin layout with super admin verification and MFA check"
      contains: "requireSuperAdmin"
    - path: "src/app/(admin)/page.tsx"
      provides: "Admin dashboard with platform stats"
      contains: "Platform"
    - path: "src/components/admin/admin-sidebar.tsx"
      provides: "Admin navigation sidebar"
      exports: ["AdminSidebar"]
    - path: "src/components/admin/admin-header.tsx"
      provides: "Admin header with user info"
      exports: ["AdminHeader"]
  key_links:
    - from: "src/app/(admin)/layout.tsx"
      to: "requireSuperAdmin()"
      via: "import and call"
      pattern: "await requireSuperAdmin"
    - from: "src/app/(admin)/layout.tsx"
      to: "supabase.auth.mfa"
      via: "MFA check"
      pattern: "mfa\\.getAuthenticatorAssuranceLevel|mfa\\.listFactors"
---

<objective>
Create the admin route group with protected layout and dashboard

Purpose: AUTH-05 requires separate (admin) route group with protected layout. This plan creates the admin shell including layout (with super admin + MFA verification), dashboard page, sidebar, and header. Also adds "Admin Panel" link to regular dashboard for super admins.

Output: Working /admin route with sidebar navigation, platform stats dashboard, and proper access control
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/36-admin-foundation-auth/36-CONTEXT.md
@.planning/phases/36-admin-foundation-auth/36-RESEARCH.md
@.planning/phases/36-admin-foundation-auth/36-02-SUMMARY.md (if exists)
@src/app/(dashboard)/layout.tsx
@src/components/layout/dashboard-header.tsx
@src/lib/auth/admin-authorize.ts (from plan 36-02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin layout with super admin and MFA verification</name>
  <files>src/app/(admin)/layout.tsx</files>
  <action>
Create the admin layout that:
1. Verifies super admin status (database query)
2. Checks MFA enrollment and AAL level
3. Provides admin-specific navigation context

Important security requirements:
- Call requireSuperAdmin() from admin-authorize.ts (database-verified)
- Check MFA enrollment with listFactors()
- Check AAL level with getAuthenticatorAssuranceLevel()
- Redirect to /mfa-setup if no TOTP enrolled
- Redirect to /mfa-verify if AAL1 but MFA enrolled

Structure:
```typescript
import { redirect } from 'next/navigation';
import { requireSuperAdmin } from '@/lib/auth/admin-authorize';
import { createClient } from '@/lib/supabase/server';
import { AdminSidebar } from '@/components/admin/admin-sidebar';
import { AdminHeader } from '@/components/admin/admin-header';
import { AbilityProvider } from '@/components/permissions/ability-provider';
import type { UserContext } from '@/lib/permissions/ability';

export default async function AdminLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  // 1. Verify super admin status (database-verified)
  const user = await requireSuperAdmin();

  // 2. Verify MFA enrollment and session level
  const supabase = await createClient();
  const [aalResult, factorsResult] = await Promise.all([
    supabase.auth.mfa.getAuthenticatorAssuranceLevel(),
    supabase.auth.mfa.listFactors(),
  ]);

  const hasTOTP = (factorsResult.data?.totp?.length ?? 0) > 0;
  const currentLevel = aalResult.data?.currentLevel;
  const nextLevel = aalResult.data?.nextLevel;

  // No MFA configured - must set up
  if (!hasTOTP) {
    redirect('/mfa-setup?required=admin');
  }

  // MFA enrolled but session is AAL1 - must verify
  if (currentLevel !== 'aal2' && nextLevel === 'aal2') {
    redirect('/mfa-verify?redirect=/admin');
  }

  // 3. Build admin context for CASL
  const adminContext: UserContext = {
    userId: user.id,
    clubId: '',  // No club context in admin
    roles: [],   // No tenant roles
    viewMode: null,
    isSuperAdmin: true,
  };

  // Get user email for header display
  const { data: { user: authUser } } = await supabase.auth.getUser();

  return (
    <AbilityProvider user={adminContext}>
      <div className="min-h-screen bg-[var(--background)]">
        <AdminHeader userEmail={authUser?.email ?? 'Admin'} />
        <div className="flex">
          <AdminSidebar />
          <main className="flex-1 p-6">
            {children}
          </main>
        </div>
      </div>
    </AbilityProvider>
  );
}
```
  </action>
  <verify>
- File exists at src/app/(admin)/layout.tsx
- Calls requireSuperAdmin()
- Checks MFA status with both listFactors() and getAuthenticatorAssuranceLevel()
- Redirects to MFA setup if no TOTP enrolled
- Redirects to MFA verify if AAL1
- Wraps children in AbilityProvider with isSuperAdmin: true
  </verify>
  <done>Admin layout verifies super admin status and MFA before allowing access</done>
</task>

<task type="auto">
  <name>Task 2: Create admin sidebar and header components</name>
  <files>src/components/admin/admin-sidebar.tsx, src/components/admin/admin-header.tsx</files>
  <action>
Create the admin navigation components.

**src/components/admin/admin-sidebar.tsx:**

Sidebar with navigation links matching CONTEXT.md specification:
- Dashboard (home icon) -> /admin
- Users (users icon) -> /admin/users (Phase 37)
- Facilities (building icon) -> /admin/facilities (Phase 38)
- Clubs (users-group icon) -> /admin/clubs (Phase 38)
- Audit Log (scroll icon) -> /admin/audit (Phase 40)

Also include a "Return to App" link at the bottom.

Use shadcn/ui navigation patterns (similar to dashboard sidebar). Use lucide-react icons.

```typescript
'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { cn } from '@/lib/utils';
import {
  LayoutDashboard,
  Users,
  Building2,
  UsersRound,
  ScrollText,
  ArrowLeft,
} from 'lucide-react';

const navItems = [
  { href: '/admin', label: 'Dashboard', icon: LayoutDashboard },
  { href: '/admin/users', label: 'Users', icon: Users },
  { href: '/admin/facilities', label: 'Facilities', icon: Building2 },
  { href: '/admin/clubs', label: 'Clubs', icon: UsersRound },
  { href: '/admin/audit', label: 'Audit Log', icon: ScrollText },
];

export function AdminSidebar() {
  const pathname = usePathname();

  return (
    <aside className="w-64 min-h-screen border-r bg-card">
      <div className="p-4">
        <h2 className="font-semibold text-lg mb-4">Admin Panel</h2>
        <nav className="space-y-1">
          {navItems.map((item) => {
            const isActive = pathname === item.href ||
              (item.href !== '/admin' && pathname.startsWith(item.href));
            return (
              <Link
                key={item.href}
                href={item.href}
                className={cn(
                  'flex items-center gap-3 px-3 py-2 rounded-md text-sm',
                  isActive
                    ? 'bg-primary text-primary-foreground'
                    : 'hover:bg-muted'
                )}
              >
                <item.icon className="h-4 w-4" />
                {item.label}
              </Link>
            );
          })}
        </nav>
      </div>
      <div className="absolute bottom-4 left-4 right-4">
        <Link
          href="/"
          className="flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground"
        >
          <ArrowLeft className="h-4 w-4" />
          Return to App
        </Link>
      </div>
    </aside>
  );
}
```

**src/components/admin/admin-header.tsx:**

Simple header showing "Admin Panel" title and user email.

```typescript
import { Badge } from '@/components/ui/badge';

interface AdminHeaderProps {
  userEmail: string;
}

export function AdminHeader({ userEmail }: AdminHeaderProps) {
  return (
    <header className="h-14 border-b bg-card flex items-center justify-between px-6">
      <div className="flex items-center gap-3">
        <span className="font-semibold">Radl Admin</span>
        <Badge variant="secondary">Super Admin</Badge>
      </div>
      <div className="text-sm text-muted-foreground">
        {userEmail}
      </div>
    </header>
  );
}
```
  </action>
  <verify>
- src/components/admin/admin-sidebar.tsx exists
- src/components/admin/admin-header.tsx exists
- Sidebar has all navigation items (Dashboard, Users, Facilities, Clubs, Audit Log)
- Sidebar has "Return to App" link
- Header shows "Radl Admin" and Super Admin badge
  </verify>
  <done>Admin sidebar and header provide navigation structure for admin panel</done>
</task>

<task type="auto">
  <name>Task 3: Create admin dashboard page with platform stats</name>
  <files>src/app/(admin)/page.tsx, src/components/admin/platform-stats.tsx</files>
  <action>
Create the admin dashboard landing page showing platform statistics.

**src/app/(admin)/page.tsx:**

```typescript
import { prisma } from '@/lib/prisma';
import { PlatformStats } from '@/components/admin/platform-stats';

export default async function AdminDashboardPage() {
  // Fetch platform-wide statistics
  const [userCount, facilityCount, clubCount, recentAuditLogs] = await Promise.all([
    // Count unique users across all memberships
    prisma.clubMembership.groupBy({
      by: ['userId'],
      _count: true,
    }).then(groups => groups.length),

    prisma.facility.count(),

    prisma.team.count(),

    // Recent admin audit logs (last 10)
    prisma.auditLog.findMany({
      where: { clubId: 'PLATFORM' },
      orderBy: { createdAt: 'desc' },
      take: 10,
      select: {
        id: true,
        action: true,
        targetType: true,
        createdAt: true,
      },
    }),
  ]);

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl font-bold">Platform Dashboard</h1>
        <p className="text-muted-foreground">
          Overview of your Radl platform
        </p>
      </div>

      <PlatformStats
        userCount={userCount}
        facilityCount={facilityCount}
        clubCount={clubCount}
      />

      <div className="space-y-4">
        <h2 className="text-lg font-semibold">Recent Admin Activity</h2>
        {recentAuditLogs.length === 0 ? (
          <p className="text-muted-foreground">No admin activity yet.</p>
        ) : (
          <div className="rounded-md border">
            <table className="w-full">
              <thead>
                <tr className="border-b bg-muted/50">
                  <th className="p-2 text-left text-sm font-medium">Action</th>
                  <th className="p-2 text-left text-sm font-medium">Target</th>
                  <th className="p-2 text-left text-sm font-medium">Time</th>
                </tr>
              </thead>
              <tbody>
                {recentAuditLogs.map((log) => (
                  <tr key={log.id} className="border-b last:border-0">
                    <td className="p-2 text-sm">{log.action}</td>
                    <td className="p-2 text-sm">{log.targetType}</td>
                    <td className="p-2 text-sm text-muted-foreground">
                      {new Date(log.createdAt).toLocaleString()}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
}
```

**src/components/admin/platform-stats.tsx:**

```typescript
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Users, Building2, UsersRound } from 'lucide-react';

interface PlatformStatsProps {
  userCount: number;
  facilityCount: number;
  clubCount: number;
}

export function PlatformStats({ userCount, facilityCount, clubCount }: PlatformStatsProps) {
  const stats = [
    { label: 'Total Users', value: userCount, icon: Users },
    { label: 'Facilities', value: facilityCount, icon: Building2 },
    { label: 'Clubs', value: clubCount, icon: UsersRound },
  ];

  return (
    <div className="grid gap-4 md:grid-cols-3">
      {stats.map((stat) => (
        <Card key={stat.label}>
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium text-muted-foreground">
              {stat.label}
            </CardTitle>
            <stat.icon className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{stat.value.toLocaleString()}</div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
}
```
  </action>
  <verify>
- src/app/(admin)/page.tsx exists
- src/components/admin/platform-stats.tsx exists
- Dashboard shows user count, facility count, club count
- Dashboard shows recent admin activity
  </verify>
  <done>Admin dashboard displays platform statistics and recent admin activity</done>
</task>

<task type="auto">
  <name>Task 4: Add Admin Panel link to dashboard header for super admins</name>
  <files>src/components/layout/dashboard-header.tsx, src/app/(dashboard)/layout.tsx</files>
  <action>
Modify the dashboard header to show an "Admin Panel" link in the user menu dropdown for super admins only.

The check should use the JWT claim `is_super_admin` for fast UI display (the actual admin route does database verification).

**Changes to src/components/layout/dashboard-header.tsx:**

1. Accept an `isSuperAdmin` prop (optional boolean)
2. In the user menu dropdown, add a link to /admin if isSuperAdmin is true

In the dropdown menu (wherever user menu is rendered), add:
```tsx
{isSuperAdmin && (
  <>
    <DropdownMenuSeparator />
    <DropdownMenuItem asChild>
      <Link href="/admin" className="flex items-center gap-2">
        <Shield className="h-4 w-4" />
        Admin Panel
      </Link>
    </DropdownMenuItem>
  </>
)}
```

Import Shield icon from lucide-react.

**Changes to src/app/(dashboard)/layout.tsx:**

1. Get the JWT claims and check is_super_admin
2. Pass isSuperAdmin prop to DashboardHeader

Add to the layout:
```typescript
// Get super admin status from JWT claims for UI display
const { data: { session } } = await supabase.auth.getSession();
const isSuperAdmin = session?.user?.app_metadata?.is_super_admin === true ||
  (session?.access_token &&
   JSON.parse(atob(session.access_token.split('.')[1]))?.is_super_admin === true);
```

Then pass to DashboardHeader:
```tsx
<DashboardHeader isSuperAdmin={isSuperAdmin} ... />
```
  </action>
  <verify>
- DashboardHeader accepts isSuperAdmin prop
- Admin Panel link appears in user menu when isSuperAdmin is true
- Link navigates to /admin
- Shield icon is displayed
- Dashboard layout passes isSuperAdmin prop
  </verify>
  <done>Super admins see "Admin Panel" link in dashboard user menu</done>
</task>

</tasks>

<verification>
After all tasks:

1. Admin route access:
   - /admin loads without error for super admin
   - /admin redirects to / for non-super admin
   - /admin redirects to /mfa-setup for super admin without MFA
   - /admin redirects to /mfa-verify for super admin with MFA but AAL1 session

2. Navigation:
   - Sidebar links are present (Dashboard, Users, Facilities, Clubs, Audit Log)
   - "Return to App" link works
   - Active state highlights correct nav item

3. Dashboard:
   - Platform stats cards show counts
   - Recent activity table displays (may be empty initially)

4. Regular dashboard integration:
   - "Admin Panel" link appears in user menu for super admins
   - Link navigates to /admin
</verification>

<success_criteria>
- Super admin can navigate to /admin and see admin dashboard
- Non-admin users redirected to home (AUTH-05)
- Super admin without MFA redirected to setup (AUTH-06)
- Admin panel has sidebar with all navigation items
- Platform stats display on dashboard
- "Admin Panel" link appears in regular dashboard for super admins
</success_criteria>

<output>
After completion, create `.planning/phases/36-admin-foundation-auth/36-04-SUMMARY.md`
</output>
