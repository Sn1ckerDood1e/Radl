---
phase: 36-admin-foundation-auth
plan: 03
type: execute
wave: 2
depends_on: ["36-01", "36-02"]
files_modified:
  - src/app/(auth)/mfa-setup/page.tsx
  - src/app/(auth)/mfa-verify/page.tsx
  - src/components/auth/mfa-setup-form.tsx
  - src/components/auth/mfa-verify-form.tsx
  - src/lib/actions/mfa.ts
autonomous: true

must_haves:
  truths:
    - "Super admin without MFA configured sees MFA setup page"
    - "MFA setup page shows QR code for TOTP enrollment"
    - "User can verify TOTP code to complete enrollment"
    - "MFA verify page allows step-up authentication for admin access"
  artifacts:
    - path: "src/app/(auth)/mfa-setup/page.tsx"
      provides: "MFA enrollment page for super admins"
      contains: "MFA"
    - path: "src/app/(auth)/mfa-verify/page.tsx"
      provides: "MFA verification page for session step-up"
      contains: "verify"
    - path: "src/components/auth/mfa-setup-form.tsx"
      provides: "TOTP enrollment UI with QR code"
      contains: "qr"
    - path: "src/lib/actions/mfa.ts"
      provides: "Server actions for MFA enrollment and verification"
      exports: ["enrollMFA", "verifyMFAEnrollment", "verifyMFAChallenge"]
  key_links:
    - from: "src/components/auth/mfa-setup-form.tsx"
      to: "supabase.auth.mfa.enroll"
      via: "server action"
      pattern: "mfa\\.enroll"
    - from: "src/components/auth/mfa-verify-form.tsx"
      to: "supabase.auth.mfa.verify"
      via: "server action"
      pattern: "mfa\\.verify"
---

<objective>
Create MFA enrollment and verification pages for super admin access

Purpose: AUTH-06 requires MFA enforcement for super admin accounts. Super admins without MFA configured must be blocked from /admin until they set up TOTP. This plan creates the MFA setup and verification pages using Supabase's built-in MFA API.

Output: MFA setup page with QR code enrollment, MFA verify page for session step-up, server actions for MFA operations

Note: These pages are wired into the admin flow by plan 36-04, which checks MFA status in the admin layout and redirects to these pages as needed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/36-admin-foundation-auth/36-CONTEXT.md
@.planning/phases/36-admin-foundation-auth/36-RESEARCH.md
@src/app/(auth)/login/page.tsx
@src/app/(auth)/layout.tsx
@src/lib/supabase/server.ts
@src/lib/supabase/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MFA server actions</name>
  <files>src/lib/actions/mfa.ts</files>
  <action>
Create server actions for MFA operations using Supabase's MFA API.

Create src/lib/actions/mfa.ts with 'use server' directive:

```typescript
'use server';

import { createClient } from '@/lib/supabase/server';
import { revalidatePath } from 'next/cache';

/**
 * Start MFA enrollment for current user.
 * Returns QR code and secret for authenticator app.
 */
export async function enrollMFA() {
  const supabase = await createClient();

  const { data, error } = await supabase.auth.mfa.enroll({
    factorType: 'totp',
    friendlyName: 'Radl Admin TOTP',
  });

  if (error) {
    return { success: false, error: error.message };
  }

  return {
    success: true,
    factorId: data.id,
    qrCode: data.totp.qr_code,    // Base64 QR code image
    secret: data.totp.secret,      // Manual entry backup
    uri: data.totp.uri,            // Full otpauth:// URI
  };
}

/**
 * Verify TOTP code during enrollment.
 * Completes MFA setup if code is valid.
 */
export async function verifyMFAEnrollment(factorId: string, code: string) {
  const supabase = await createClient();

  // Create challenge
  const { data: challenge, error: challengeError } =
    await supabase.auth.mfa.challenge({ factorId });

  if (challengeError) {
    return { success: false, error: challengeError.message };
  }

  // Verify with TOTP code
  const { data, error } = await supabase.auth.mfa.verify({
    factorId,
    challengeId: challenge.id,
    code,
  });

  if (error) {
    return { success: false, error: error.message };
  }

  revalidatePath('/admin');
  return { success: true };
}

/**
 * Verify MFA challenge for session step-up (AAL2).
 * Used when user has MFA enrolled but session is AAL1.
 */
export async function verifyMFAChallenge(code: string) {
  const supabase = await createClient();

  // Get the user's TOTP factors
  const { data: factors, error: factorsError } =
    await supabase.auth.mfa.listFactors();

  if (factorsError || !factors?.totp?.length) {
    return { success: false, error: 'No MFA factors configured' };
  }

  const factorId = factors.totp[0].id;

  // Create challenge
  const { data: challenge, error: challengeError } =
    await supabase.auth.mfa.challenge({ factorId });

  if (challengeError) {
    return { success: false, error: challengeError.message };
  }

  // Verify
  const { data, error } = await supabase.auth.mfa.verify({
    factorId,
    challengeId: challenge.id,
    code,
  });

  if (error) {
    return { success: false, error: error.message };
  }

  revalidatePath('/admin');
  return { success: true };
}

/**
 * Get current MFA status for user.
 */
export async function getMFAStatus() {
  const supabase = await createClient();

  const [aalResult, factorsResult] = await Promise.all([
    supabase.auth.mfa.getAuthenticatorAssuranceLevel(),
    supabase.auth.mfa.listFactors(),
  ]);

  return {
    currentLevel: aalResult.data?.currentLevel ?? null,
    nextLevel: aalResult.data?.nextLevel ?? null,
    hasTOTP: (factorsResult.data?.totp?.length ?? 0) > 0,
    factors: factorsResult.data?.totp ?? [],
  };
}
```
  </action>
  <verify>
- File exists at src/lib/actions/mfa.ts
- Contains 'use server' directive
- Exports enrollMFA, verifyMFAEnrollment, verifyMFAChallenge, getMFAStatus
- Uses Supabase MFA API methods
  </verify>
  <done>Server actions provide MFA enrollment and verification using Supabase MFA API</done>
</task>

<task type="auto">
  <name>Task 2: Create MFA setup page and form component</name>
  <files>src/app/(auth)/mfa-setup/page.tsx, src/components/auth/mfa-setup-form.tsx</files>
  <action>
Create the MFA setup page that displays QR code for TOTP enrollment.

**src/app/(auth)/mfa-setup/page.tsx:**

- Server component that checks if user already has MFA
- Shows MfaSetupForm component
- Handles `required=true` query param (from admin redirect)
- If MFA already enrolled, redirects to appropriate destination

```typescript
import { redirect } from 'next/navigation';
import { getMFAStatus } from '@/lib/actions/mfa';
import { getAuthUser } from '@/lib/auth/authorize';
import { MfaSetupForm } from '@/components/auth/mfa-setup-form';

export default async function MfaSetupPage({
  searchParams,
}: {
  searchParams: Promise<{ required?: string; redirect?: string }>;
}) {
  const user = await getAuthUser();
  if (!user) redirect('/login');

  const params = await searchParams;
  const isRequired = params.required === 'true' || params.required === 'admin';
  const redirectTo = params.redirect ?? '/admin';

  // Check if already enrolled
  const { hasTOTP } = await getMFAStatus();
  if (hasTOTP) {
    redirect(redirectTo);
  }

  return (
    <div className="flex min-h-screen items-center justify-center p-4">
      <div className="w-full max-w-md space-y-6">
        <div className="text-center">
          <h1 className="text-2xl font-bold">Set Up Two-Factor Authentication</h1>
          {isRequired && (
            <p className="mt-2 text-muted-foreground">
              Two-factor authentication is required for admin access.
            </p>
          )}
        </div>
        <MfaSetupForm redirectTo={redirectTo} />
      </div>
    </div>
  );
}
```

**src/components/auth/mfa-setup-form.tsx:**

Client component with three stages:
1. Initial: Show "Set up MFA" button
2. Scan: Show QR code and secret, ask for TOTP code
3. Done: Show success message

```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { enrollMFA, verifyMFAEnrollment } from '@/lib/actions/mfa';

interface MfaSetupFormProps {
  redirectTo: string;
}

type Stage = 'initial' | 'scan' | 'verify';

export function MfaSetupForm({ redirectTo }: MfaSetupFormProps) {
  const router = useRouter();
  const [stage, setStage] = useState<Stage>('initial');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [enrollmentData, setEnrollmentData] = useState<{
    factorId: string;
    qrCode: string;
    secret: string;
  } | null>(null);
  const [code, setCode] = useState('');

  const handleStartEnrollment = async () => {
    setLoading(true);
    setError(null);

    const result = await enrollMFA();

    if (!result.success) {
      setError(result.error ?? 'Failed to start enrollment');
      setLoading(false);
      return;
    }

    setEnrollmentData({
      factorId: result.factorId!,
      qrCode: result.qrCode!,
      secret: result.secret!,
    });
    setStage('scan');
    setLoading(false);
  };

  const handleVerify = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!enrollmentData) return;

    setLoading(true);
    setError(null);

    const result = await verifyMFAEnrollment(enrollmentData.factorId, code);

    if (!result.success) {
      setError(result.error ?? 'Invalid code');
      setLoading(false);
      return;
    }

    setStage('verify');
    // Redirect after short delay to show success
    setTimeout(() => router.push(redirectTo), 1500);
  };

  // Render based on stage - implement all three stages
  // Stage 1: Button to start
  // Stage 2: QR code + manual secret + code input
  // Stage 3: Success message
}
```

Use existing UI components (Button, Input, Card from shadcn/ui). Show the QR code as an img tag with src={qrCode}. Show the secret for manual entry with copy button.
  </action>
  <verify>
- src/app/(auth)/mfa-setup/page.tsx exists
- src/components/auth/mfa-setup-form.tsx exists
- Page handles required query param
- Form shows QR code from enrollment data
- Form handles verification flow
  </verify>
  <done>MFA setup page allows super admins to enroll in TOTP with QR code</done>
</task>

<task type="auto">
  <name>Task 3: Create MFA verify page and form component</name>
  <files>src/app/(auth)/mfa-verify/page.tsx, src/components/auth/mfa-verify-form.tsx</files>
  <action>
Create the MFA verification page for session step-up (when user has MFA enrolled but current session is AAL1).

**src/app/(auth)/mfa-verify/page.tsx:**

```typescript
import { redirect } from 'next/navigation';
import { getMFAStatus } from '@/lib/actions/mfa';
import { getAuthUser } from '@/lib/auth/authorize';
import { MfaVerifyForm } from '@/components/auth/mfa-verify-form';

export default async function MfaVerifyPage({
  searchParams,
}: {
  searchParams: Promise<{ redirect?: string }>;
}) {
  const user = await getAuthUser();
  if (!user) redirect('/login');

  const params = await searchParams;
  const redirectTo = params.redirect ?? '/admin';

  // Check MFA status
  const { hasTOTP, currentLevel, nextLevel } = await getMFAStatus();

  // No MFA configured - redirect to setup
  if (!hasTOTP) {
    redirect(`/mfa-setup?required=true&redirect=${encodeURIComponent(redirectTo)}`);
  }

  // Already at AAL2 - redirect to destination
  if (currentLevel === 'aal2') {
    redirect(redirectTo);
  }

  return (
    <div className="flex min-h-screen items-center justify-center p-4">
      <div className="w-full max-w-md space-y-6">
        <div className="text-center">
          <h1 className="text-2xl font-bold">Verify Your Identity</h1>
          <p className="mt-2 text-muted-foreground">
            Enter the code from your authenticator app to continue.
          </p>
        </div>
        <MfaVerifyForm redirectTo={redirectTo} />
      </div>
    </div>
  );
}
```

**src/components/auth/mfa-verify-form.tsx:**

```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { verifyMFAChallenge } from '@/lib/actions/mfa';

interface MfaVerifyFormProps {
  redirectTo: string;
}

export function MfaVerifyForm({ redirectTo }: MfaVerifyFormProps) {
  const router = useRouter();
  const [code, setCode] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);

    const result = await verifyMFAChallenge(code);

    if (!result.success) {
      setError(result.error ?? 'Verification failed');
      setLoading(false);
      return;
    }

    router.push(redirectTo);
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>Enter Verification Code</CardTitle>
        <CardDescription>
          Open your authenticator app and enter the 6-digit code.
        </CardDescription>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit} className="space-y-4">
          {error && (
            <Alert variant="destructive">
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}
          <Input
            type="text"
            inputMode="numeric"
            pattern="[0-9]*"
            maxLength={6}
            value={code}
            onChange={(e) => setCode(e.target.value.replace(/\D/g, ''))}
            placeholder="000000"
            className="text-center text-2xl tracking-widest"
            autoFocus
          />
          <Button type="submit" className="w-full" disabled={loading || code.length !== 6}>
            {loading ? 'Verifying...' : 'Verify'}
          </Button>
        </form>
      </CardContent>
    </Card>
  );
}
```
  </action>
  <verify>
- src/app/(auth)/mfa-verify/page.tsx exists
- src/components/auth/mfa-verify-form.tsx exists
- Page checks AAL level and redirects appropriately
- Form accepts 6-digit code and calls verifyMFAChallenge
- Redirects to destination on success
  </verify>
  <done>MFA verify page allows session step-up for users with TOTP enrolled</done>
</task>

</tasks>

<verification>
After all tasks:

1. Type checking:
   - `npx tsc --noEmit` passes

2. MFA flow verification:
   - mfa-setup page exists at (auth)/mfa-setup/page.tsx
   - mfa-verify page exists at (auth)/mfa-verify/page.tsx
   - Server actions use Supabase MFA API

3. Component integration:
   - Forms use shadcn/ui components
   - Proper loading and error states
   - Redirect handling works

4. Integration with admin layout (verified by plan 36-04):
   - Plan 36-04 creates the admin layout that checks MFA status
   - Admin layout redirects to /mfa-setup if no TOTP enrolled
   - Admin layout redirects to /mfa-verify if AAL1 but MFA enrolled
</verification>

<success_criteria>
- MFA setup page shows QR code for TOTP enrollment
- MFA verify page allows code entry for session step-up
- Server actions wrap Supabase MFA API correctly
- Pages handle required query param for admin enforcement
- All forms have proper loading, error states, and validation
</success_criteria>

<output>
After completion, create `.planning/phases/36-admin-foundation-auth/36-03-SUMMARY.md`
</output>
