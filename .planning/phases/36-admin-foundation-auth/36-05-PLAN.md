---
phase: 36-admin-foundation-auth
plan: 05
type: execute
wave: 3
depends_on: ["36-02", "36-03", "36-04"]
files_modified:
  - src/components/admin/admin-session-timeout.tsx
  - src/app/(admin)/layout.tsx
autonomous: false

must_haves:
  truths:
    - "Admin session expires after 30 minutes of inactivity"
    - "User is signed out and redirected to login on timeout"
    - "Activity resets the timeout timer"
    - "All phase 36 requirements are met and working together"
  artifacts:
    - path: "src/components/admin/admin-session-timeout.tsx"
      provides: "Client-side inactivity timeout hook"
      exports: ["AdminSessionTimeout"]
  key_links:
    - from: "src/components/admin/admin-session-timeout.tsx"
      to: "supabase.auth.signOut"
      via: "timeout callback"
      pattern: "signOut"
    - from: "src/app/(admin)/layout.tsx"
      to: "AdminSessionTimeout"
      via: "component inclusion"
      pattern: "<AdminSessionTimeout"
---

<objective>
Implement admin session timeout and verify complete phase integration

Purpose: AUTH-03 requires admin session timeout at 30 minutes of inactivity. This plan implements client-side inactivity detection that signs out the user after 30 minutes without activity. Also includes verification checkpoint to ensure all phase requirements work together.

Output: Admin session timeout component, integrated admin layout, verified complete phase functionality
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/36-admin-foundation-auth/36-CONTEXT.md
@.planning/phases/36-admin-foundation-auth/36-RESEARCH.md
@.planning/phases/36-admin-foundation-auth/36-01-SUMMARY.md
@.planning/phases/36-admin-foundation-auth/36-02-SUMMARY.md
@.planning/phases/36-admin-foundation-auth/36-03-SUMMARY.md
@.planning/phases/36-admin-foundation-auth/36-04-SUMMARY.md
@src/app/(admin)/layout.tsx
@src/lib/supabase/client.ts
@src/lib/auth/admin-authorize.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin session timeout component</name>
  <files>src/components/admin/admin-session-timeout.tsx</files>
  <action>
Create a client component that monitors user activity and signs out after 30 minutes of inactivity.

Per RESEARCH.md, this is admin-specific (not Supabase-wide setting) so regular users aren't affected.

```typescript
'use client';

import { useEffect, useRef, useCallback } from 'react';
import { useRouter } from 'next/navigation';
import { createClient } from '@/lib/supabase/client';

const ADMIN_TIMEOUT_MS = 30 * 60 * 1000; // 30 minutes

/**
 * Admin session timeout component.
 * Signs out user after 30 minutes of inactivity.
 *
 * Activity events that reset the timer:
 * - mousedown, keydown, touchstart, scroll, mousemove
 *
 * AUTH-03 compliance: Admin session expires after 30 minutes of inactivity.
 */
export function AdminSessionTimeout() {
  const router = useRouter();
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);
  const lastActivityRef = useRef<number>(Date.now());

  const handleTimeout = useCallback(async () => {
    const supabase = createClient();
    await supabase.auth.signOut();
    router.push('/login?timeout=admin');
  }, [router]);

  const resetTimeout = useCallback(() => {
    lastActivityRef.current = Date.now();

    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current);
    }

    timeoutRef.current = setTimeout(handleTimeout, ADMIN_TIMEOUT_MS);
  }, [handleTimeout]);

  useEffect(() => {
    // Activity events to track
    const activityEvents = [
      'mousedown',
      'keydown',
      'touchstart',
      'scroll',
      'mousemove',
    ];

    // Throttle activity detection to avoid excessive resets
    let lastReset = 0;
    const throttledReset = () => {
      const now = Date.now();
      // Only reset if more than 1 second since last reset
      if (now - lastReset > 1000) {
        lastReset = now;
        resetTimeout();
      }
    };

    // Add listeners
    activityEvents.forEach((event) => {
      window.addEventListener(event, throttledReset, { passive: true });
    });

    // Start initial timeout
    resetTimeout();

    // Cleanup
    return () => {
      activityEvents.forEach((event) => {
        window.removeEventListener(event, throttledReset);
      });
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }
    };
  }, [resetTimeout]);

  // Also check on visibility change (tab becomes active)
  useEffect(() => {
    const handleVisibilityChange = () => {
      if (document.visibilityState === 'visible') {
        // Check if we should have timed out while tab was hidden
        const elapsed = Date.now() - lastActivityRef.current;
        if (elapsed >= ADMIN_TIMEOUT_MS) {
          handleTimeout();
        } else {
          // Tab became visible, reset timeout for remaining time
          if (timeoutRef.current) {
            clearTimeout(timeoutRef.current);
          }
          timeoutRef.current = setTimeout(
            handleTimeout,
            ADMIN_TIMEOUT_MS - elapsed
          );
        }
      }
    };

    document.addEventListener('visibilitychange', handleVisibilityChange);
    return () => {
      document.removeEventListener('visibilitychange', handleVisibilityChange);
    };
  }, [handleTimeout]);

  // This component renders nothing - it's just for the side effect
  return null;
}
```

Key features:
- 30-minute timeout (AUTH-03)
- Tracks mousedown, keydown, touchstart, scroll, mousemove
- Throttled to avoid excessive timer resets
- Handles tab visibility (checks timeout when tab becomes active)
- Signs out via Supabase and redirects to /login?timeout=admin
  </action>
  <verify>
- File exists at src/components/admin/admin-session-timeout.tsx
- Exports AdminSessionTimeout component
- Uses ADMIN_TIMEOUT_MS = 30 * 60 * 1000
- Calls supabase.auth.signOut() on timeout
- Redirects to /login?timeout=admin
  </verify>
  <done>Admin session timeout component tracks inactivity and signs out after 30 minutes</done>
</task>

<task type="auto">
  <name>Task 2: Integrate session timeout into admin layout</name>
  <files>src/app/(admin)/layout.tsx</files>
  <action>
Add the AdminSessionTimeout component to the admin layout.

Update src/app/(admin)/layout.tsx to include the timeout component.

Add import:
```typescript
import { AdminSessionTimeout } from '@/components/admin/admin-session-timeout';
```

Add the component inside the layout (after AbilityProvider, before the div):
```typescript
return (
  <AbilityProvider user={adminContext}>
    <AdminSessionTimeout />
    <div className="min-h-screen bg-[var(--background)]">
      {/* ... rest of layout ... */}
    </div>
  </AbilityProvider>
);
```

The component must be inside the layout so it's rendered on every admin page but not on non-admin pages.
  </action>
  <verify>
- AdminSessionTimeout is imported in layout.tsx
- AdminSessionTimeout is rendered inside the layout
- Component is placed after AbilityProvider
  </verify>
  <done>Admin layout includes session timeout component for 30-minute inactivity enforcement</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete admin panel foundation including:
- SuperAdmin database table and Prisma model
- Database-verified super admin authentication
- MFA enrollment and verification pages
- Admin route group with protected layout
- Admin sidebar navigation
- Platform stats dashboard
- 30-minute session timeout
- CASL integration with can('manage', 'all')
- Admin audit logging with before/after state
- "Admin Panel" link in dashboard for super admins
  </what-built>
  <how-to-verify>
**Pre-requisites (run if not already done):**
1. Apply database migration: `npx prisma db push` or apply the migration manually
2. Create a test super admin record:
   - Get your Supabase user ID (from auth.users table or Supabase dashboard)
   - Run: `npx tsx scripts/seed-super-admin.ts <your-user-id>`

**Test flow:**

1. **Non-admin access denied (AUTH-02, AUTH-05):**
   - Create a second test user (not super admin)
   - Log in as non-admin user
   - Navigate to /admin
   - Expected: Silent redirect to home page (not 403, not "access denied" message)

2. **MFA enforcement (AUTH-06):**
   - Log in as super admin (who does NOT have MFA set up yet)
   - Navigate to /admin
   - Expected: Redirect to /mfa-setup with message about admin access requirement
   - Complete MFA setup (scan QR code with authenticator app)
   - Enter TOTP code
   - Expected: Redirect to /admin after successful verification

3. **Admin dashboard access (AUTH-05, AUTH-04):**
   - Now logged in as super admin with MFA
   - Navigate to /admin
   - Expected: See admin dashboard with platform stats
   - Sidebar shows: Dashboard, Users, Facilities, Clubs, Audit Log
   - Header shows "Radl Admin" and "Super Admin" badge

4. **Session timeout (AUTH-03):**
   - Open browser dev tools console
   - Modify ADMIN_TIMEOUT_MS temporarily to 10000 (10 seconds) for testing
   - Stay inactive for 10+ seconds
   - Expected: Automatic sign out and redirect to /login?timeout=admin
   - (Reset ADMIN_TIMEOUT_MS back to 30 minutes after testing)

5. **Regular dashboard integration:**
   - Log in as super admin
   - Navigate to regular dashboard (any club page)
   - Open user menu dropdown
   - Expected: "Admin Panel" link visible with shield icon
   - Click it
   - Expected: Navigate to /admin

6. **Audit logging (AUDT-01):**
   - (This will be more thoroughly tested in later phases when admin actions exist)
   - For now, verify the logAdminAction function exists:
   - Check that src/lib/audit/logger.ts exports logAdminAction
  </how-to-verify>
  <resume-signal>
Type "approved" if all verification steps pass, or describe any issues found that need fixing.
  </resume-signal>
</task>

</tasks>

<verification>
Phase 36 requirements verification:

| Requirement | Implementation | Verification |
|-------------|----------------|--------------|
| AUTH-01: SuperAdmin table | Prisma model + migration | SuperAdmin record can be created |
| AUTH-02: Database verification | requireSuperAdmin() queries DB | Non-admin redirected on every request |
| AUTH-03: 30-min timeout | AdminSessionTimeout component | Signs out after inactivity |
| AUTH-04: CASL can('manage', 'all') | isSuperAdmin in UserContext | Super admin has full access |
| AUTH-05: (admin) route group | Separate layout with verification | /admin works for super admin only |
| AUTH-06: MFA enforcement | Layout checks AAL level | Redirects to MFA setup/verify |
| AUDT-01: Admin action logging | logAdminAction with before/after | Function exists and usable |
</verification>

<success_criteria>
- Admin session times out after 30 minutes of inactivity (AUTH-03)
- All phase 36 requirements working together
- Human verification confirms all success criteria from ROADMAP.md:
  1. Super admin can navigate to /admin and see dashboard
  2. Non-admin redirected to home (not shown admin UI)
  3. Session expires after 30 minutes requiring re-login
  4. Super admin without MFA prompted to configure
  5. Admin actions create audit log entries with before/after state
</success_criteria>

<output>
After completion, create `.planning/phases/36-admin-foundation-auth/36-05-SUMMARY.md`
</output>
