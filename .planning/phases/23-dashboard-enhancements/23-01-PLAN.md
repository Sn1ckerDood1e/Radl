---
phase: 23-dashboard-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/dashboard/sparkline.tsx
  - src/lib/dashboard/aggregations.ts
autonomous: true

must_haves:
  truths:
    - "Sparkline component renders SVG polyline from number array"
    - "Weekly usage aggregation converts equipment logs to sparkline data"
    - "Sparkline handles edge cases: empty data, single point, flat line"
  artifacts:
    - path: "src/components/dashboard/sparkline.tsx"
      provides: "Reusable sparkline visualization component"
      exports: ["Sparkline"]
    - path: "src/lib/dashboard/aggregations.ts"
      provides: "Usage data aggregation utilities"
      exports: ["aggregateUsageByWeek", "usageToSparklineData"]
  key_links:
    - from: "src/components/dashboard/sparkline.tsx"
      to: "SVG polyline"
      via: "points attribute calculation"
      pattern: "points=.*join"
---

<objective>
Create the sparkline component and usage aggregation utilities for equipment trends visualization.

Purpose: Provides the foundation for the Usage Trends widget. Sparkline is a compact trend visualization without axes or labels.
Output: Reusable Sparkline component and aggregateUsageByWeek utility function.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-dashboard-enhancements/23-CONTEXT.md
@.planning/phases/23-dashboard-enhancements/23-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Sparkline component</name>
  <files>src/components/dashboard/sparkline.tsx</files>
  <action>
Create a minimal SVG sparkline component following the pattern from RESEARCH.md.

Component requirements:
- Props: data (number[]), width (default 120), height (default 32), strokeColor (default 'currentColor'), strokeWidth (default 1.5), className
- Guard against edge cases: return null if data.length < 2
- Handle flat line (all same values): use `const range = max - min || 1` to avoid division by zero
- Generate polyline points by scaling data to fit SVG viewport with padding for stroke width
- Use strokeLinecap="round" and strokeLinejoin="round" for smooth appearance
- Add aria-hidden="true" since this is decorative visualization
- Export as named export

Example API:
```tsx
<Sparkline
  data={[10, 15, 12, 18, 14, 20]}
  width={120}
  height={32}
  strokeColor="var(--text-muted)"
  className="text-emerald-400"
/>
```
  </action>
  <verify>
`npx tsc --noEmit` passes with no type errors for the new component.
  </verify>
  <done>
Sparkline component exists at src/components/dashboard/sparkline.tsx with proper TypeScript types and edge case handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create usage aggregation utilities</name>
  <files>src/lib/dashboard/aggregations.ts</files>
  <action>
Create utility functions for aggregating equipment usage logs into weekly buckets for sparkline display.

Functions to implement:

1. `aggregateUsageByWeek(usageLogs, seasonStart, seasonEnd)`:
   - Input: Array of usage logs with usageDate and practice (with startTime, endTime)
   - Generate all weeks in the date range using date-fns `eachWeekOfInterval`
   - For each week, sum practice durations (endTime - startTime in minutes) for logs within that week
   - Use `isWithinInterval` from date-fns for week boundary checking
   - Return array of { weekStart: Date, totalMinutes: number }

2. `usageToSparklineData(weeklyUsage)`:
   - Input: Array of { weekStart, totalMinutes }
   - Output: number[] (just the totalMinutes values for sparkline)

Type definitions:
```typescript
interface WeeklyUsage {
  weekStart: Date;
  totalMinutes: number;
}

interface UsageLogWithPractice {
  usageDate: Date;
  practice: {
    startTime: Date;
    endTime: Date;
  };
}
```

Note: The practice durations are computed from startTime/endTime, NOT a stored duration field.
  </action>
  <verify>
`npx tsc --noEmit` passes. Create a simple test case mentally:
- 3 weeks: Jan 1-7, Jan 8-14, Jan 15-21
- 2 logs in week 1 (each 60 min), 1 log in week 2 (90 min), 0 in week 3
- Expected: [120, 90, 0]
  </verify>
  <done>
Aggregation utilities exist at src/lib/dashboard/aggregations.ts with proper TypeScript types and date-fns integration.
  </done>
</task>

</tasks>

<verification>
- Both files exist and export their functions/components
- TypeScript compilation succeeds: `npx tsc --noEmit`
- Sparkline handles: empty array, single value, normal data, flat line (all same values)
- Aggregation handles: empty logs, logs spanning multiple weeks, season with no activity
</verification>

<success_criteria>
- Sparkline component renders SVG polyline from number array
- aggregateUsageByWeek correctly buckets usage logs by week
- Edge cases handled gracefully (no crashes on empty/minimal data)
</success_criteria>

<output>
After completion, create `.planning/phases/23-dashboard-enhancements/23-01-SUMMARY.md`
</output>
