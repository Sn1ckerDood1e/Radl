---
phase: 23-dashboard-enhancements
plan: 05
type: execute
wave: 2
depends_on: [23-01, 23-02, 23-03]
files_modified:
  - src/lib/dashboard/queries.ts
autonomous: true

must_haves:
  truths:
    - "getTodaysPracticesForCoach returns practices with athlete counts"
    - "getAthleteNextPractice returns athlete's practice with their assignment"
    - "getAttentionItems returns equipment needing inspection and practices needing lineups"
  artifacts:
    - path: "src/lib/dashboard/queries.ts"
      provides: "Dashboard data fetching functions"
      exports: ["getTodaysPracticesForCoach", "getAthleteNextPractice", "getAttentionItems", "getUsageTrendsData"]
  key_links:
    - from: "src/lib/dashboard/queries.ts"
      to: "Prisma models"
      via: "database queries"
      pattern: "prisma\\.(practice|equipment|season)"
---

<objective>
Create the dashboard-specific data fetching functions for both coach and athlete dashboards.

Purpose: Centralize complex queries that aggregate data for dashboard widgets. These functions are called from the page server component.
Output: Reusable query functions that the page can call in parallel.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-dashboard-enhancements/23-CONTEXT.md
@.planning/phases/23-dashboard-enhancements/23-RESEARCH.md
@src/lib/equipment/usage-logger.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create coach dashboard queries</name>
  <files>src/lib/dashboard/queries.ts</files>
  <action>
Create data fetching functions for the coach dashboard.

Functions to implement:

1. `getTodaysPracticesForCoach(teamId: string)`:
   - Query practices where date is today (compare date string, not full datetime to avoid timezone issues)
   - Use: `new Date().toISOString().split('T')[0]` for today string
   - Include blocks with lineup.seats count and landAssignments count for athlete totals
   - Compute athleteCount per practice by summing unique athletes across blocks
   - Return sorted by startTime ascending
   - Also return "nextPractice" if no practices today (first future practice)

2. `getAttentionItems(teamId: string, teamSlug: string)`:
   - Query equipment needing inspection (use readiness thresholds from teamSettings)
   - Query practices in next 14 days with WATER blocks having no lineups (lineup: { none: {} })
   - Return array of AttentionItem objects with type, count, label, href

3. `getUsageTrendsData(teamId: string)`:
   - Find active season for team (status: 'ACTIVE', most recent by startDate)
   - Get usage logs within season date range using getUsageLogsForTeam from usage-logger.ts
   - Aggregate by week using aggregateUsageByWeek from aggregations.ts
   - Compute total hours (sum of all minutes / 60)
   - Return { sparklineData, totalHours, seasonName }

Type definitions at top of file:
```typescript
export interface TodaysPracticeData {
  id: string;
  name: string;
  startTime: Date;
  endTime: Date;
  athleteCount: number;
  blockCount: number;
}

export interface AttentionItem {
  type: 'equipment_inspection' | 'lineup_needed' | 'practice_unpublished';
  count: number;
  label: string;
  href: string;
}

export interface UsageTrendsData {
  sparklineData: number[];
  totalHours: number;
  seasonName?: string;
}
```

Important: Use date string comparison for "today" to avoid timezone issues (per RESEARCH.md pitfall #1).
  </action>
  <verify>
`npx tsc --noEmit` passes with no type errors.
  </verify>
  <done>
Coach dashboard queries implemented: getTodaysPracticesForCoach, getAttentionItems, getUsageTrendsData.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create athlete dashboard query</name>
  <files>src/lib/dashboard/queries.ts</files>
  <action>
Add athlete-specific query function to the same file.

Function to implement:

`getAthleteNextPractice(teamId: string, userId: string)`:
1. First get athlete's profile ID via TeamMember -> AthleteProfile
2. Query next practice where:
   - teamId matches
   - date >= now
   - status is PUBLISHED
   - Has block where athlete is assigned (via lineup.seats or landAssignments)
3. Include the athlete's specific assignment:
   - For WATER blocks: boat name, boatClass, seat position, side
   - For LAND/ERG blocks: any groupName from landAssignments
4. If no practice with assignment, also query count of upcoming practices (for "X practices exist but you're not assigned")
5. Return practice info + assignment + unassignedPracticeCount

Return type:
```typescript
export interface AthleteNextPracticeData {
  practice: {
    id: string;
    name: string;
    date: Date;
    startTime: Date;
    endTime: Date;
  } | null;
  assignment: {
    blockType: 'WATER' | 'ERG' | 'LAND' | 'MEETING';
    boatName?: string;
    boatClass?: string;
    seatPosition?: number;
    seatSide?: 'PORT' | 'STARBOARD' | null;
    groupName?: string;
  } | null;
  unassignedPracticeCount: number;
}
```

Query approach (per RESEARCH.md to avoid N+1):
- Use single query with filtered includes for the athlete's assignments
- The WHERE clause filters to practices where athlete has at least one assignment
- The include filters to only that athlete's seats/assignments

Handle case where user has no AthleteProfile (they might be coach-only) - return null practice.
  </action>
  <verify>
`npx tsc --noEmit` passes with no type errors.
  </verify>
  <done>
getAthleteNextPractice implemented with single query pattern, returns practice + assignment + unassigned count.
  </done>
</task>

</tasks>

<verification>
- All functions exist and export correctly
- TypeScript compilation succeeds: `npx tsc --noEmit`
- getTodaysPracticesForCoach uses date string comparison (not datetime)
- getAthleteNextPractice uses filtered includes (not N+1 queries)
- getAttentionItems filters to next 14 days for practices
</verification>

<success_criteria>
- getTodaysPracticesForCoach returns today's practices with computed athlete counts
- getAthleteNextPractice returns athlete's next practice with their specific seat/boat assignment
- getAttentionItems returns equipment and lineup attention items with counts
- getUsageTrendsData returns sparkline data and total hours for current season
</success_criteria>

<output>
After completion, create `.planning/phases/23-dashboard-enhancements/23-05-SUMMARY.md`
</output>
