---
phase: 28-onboarding-flow-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(auth)/signup/page.tsx
  - src/app/api/auth/callback/route.ts
autonomous: true
requirements:
  - ONBD-01
  - ONBD-05

must_haves:
  truths:
    - "User visiting /join/{code} unauthenticated can complete signup and return to join page"
    - "Signup page preserves redirect parameter through verification flow"
    - "After email verification, user lands on intended destination"
  artifacts:
    - path: "src/app/(auth)/signup/page.tsx"
      provides: "Signup form with redirect parameter handling"
      contains: "useSearchParams"
    - path: "src/app/api/auth/callback/route.ts"
      provides: "Auth callback with redirect support"
      contains: "redirect"
  key_links:
    - from: "src/app/(auth)/signup/page.tsx"
      to: "/api/auth/signup"
      via: "fetch with redirect in body"
      pattern: "redirect"
    - from: "src/app/api/auth/callback/route.ts"
      to: "redirect destination"
      via: "NextResponse.redirect"
      pattern: "next.*redirect"
---

<objective>
Fix signup redirect parameter handling so users can complete the join flow

Purpose: When unauthenticated users visit /join/{code}, they're redirected to /signup?redirect=/join/{code}. Currently the signup page ignores this parameter, breaking the onboarding flow for invited members.

Output: Signup page that reads, preserves, and uses the redirect parameter after successful signup verification.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-onboarding-flow-testing/28-RESEARCH.md

# Current implementation
@src/app/(auth)/signup/page.tsx
@src/app/api/auth/callback/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add redirect parameter handling to signup page</name>
  <files>src/app/(auth)/signup/page.tsx</files>
  <action>
Update the signup page to:

1. Import `useSearchParams` from 'next/navigation'
2. Read the `redirect` query parameter on mount
3. Store it in local state (survives form interaction)
4. Include `redirect` in the POST body to `/api/auth/signup`
5. Display the redirect destination on the success screen (e.g., "After verification, you'll continue to join the team")

Implementation notes:
- Use `useSearchParams()` hook to read query params
- The redirect value should be URL-decoded and validated (must start with `/` to prevent open redirect)
- Pass `redirectTo` in the API request body
- On success screen, show context-aware message if redirect exists

Example code pattern:
```typescript
const searchParams = useSearchParams();
const [redirectTo] = useState(() => {
  const redirect = searchParams.get('redirect');
  // Validate: must start with / to prevent open redirect
  return redirect?.startsWith('/') ? redirect : null;
});
```
  </action>
  <verify>
1. Visit `/signup?redirect=/join/TESTCODE`
2. Inspect React state - redirectTo should be `/join/TESTCODE`
3. Submit signup form
4. Check network request - body should include `redirectTo: "/join/TESTCODE"`
  </verify>
  <done>Signup page reads and includes redirect parameter in API request</done>
</task>

<task type="auto">
  <name>Task 2: Update auth callback to handle redirect after verification</name>
  <files>src/app/api/auth/callback/route.ts</files>
  <action>
Update the auth callback route to:

1. Read `next` parameter from URL (existing behavior)
2. Also check for a `redirect` parameter in the token metadata if Supabase supports it
3. Ensure redirect validation (must start with `/` and be same-origin)
4. Redirect to the intended destination after successful code exchange

The flow is:
- Signup sends `redirectTo` to signup API
- Signup API passes it to Supabase as `emailRedirectTo` with the redirect encoded
- Callback extracts it from the `next` query parameter
- Callback redirects user to that destination

Ensure the existing `next` parameter logic handles the join path correctly.

Security: Always validate redirect URLs are relative paths (start with /) to prevent open redirect attacks.
  </action>
  <verify>
1. Check that `/api/auth/callback?code=xxx&next=/join/TESTCODE` redirects to `/join/TESTCODE`
2. Check that invalid redirects (external URLs) are rejected and default to `/`
3. Check that missing `next` param defaults to `/`
  </verify>
  <done>Auth callback respects redirect parameter and safely redirects users</done>
</task>

<task type="auto">
  <name>Task 3: Update signup API to pass redirect to Supabase</name>
  <files>src/app/api/auth/signup/route.ts</files>
  <action>
Update the signup API route to:

1. Accept `redirectTo` in the request body
2. Validate it (must start with `/`)
3. Build the full callback URL with the redirect encoded:
   `${origin}/api/auth/callback?next=${encodeURIComponent(redirectTo)}`
4. Pass this as `emailRedirectTo` option to Supabase signUp

Example:
```typescript
const { redirectTo } = body;
const validRedirect = redirectTo?.startsWith('/') ? redirectTo : '/';
const callbackUrl = `${origin}/api/auth/callback?next=${encodeURIComponent(validRedirect)}`;

const { data, error } = await supabase.auth.signUp({
  email,
  password,
  options: {
    emailRedirectTo: callbackUrl,
  },
});
```
  </action>
  <verify>
1. POST to `/api/auth/signup` with body `{ email, password, redirectTo: "/join/ABC" }`
2. Check Supabase email template includes the correct callback URL with `next` parameter
3. Clicking verification link should redirect to `/join/ABC`
  </verify>
  <done>Signup API passes redirect destination through email verification flow</done>
</task>

</tasks>

<verification>
## End-to-end test

1. Open incognito browser
2. Visit `http://localhost:3000/join/TEAMCODE` (use real team code)
3. Should redirect to `/signup?redirect=/join/TEAMCODE`
4. Complete signup with new email
5. Check email for verification link
6. Click verification link
7. Should land on `/join/TEAMCODE` after verification
8. Should see join form (not login page)

## Security verification

1. Try signup with `redirect=https://evil.com` - should be rejected/ignored
2. Try signup with `redirect=//evil.com` - should be rejected/ignored
3. Try signup with `redirect=/join/code` - should work
</verification>

<success_criteria>
- Unauthenticated user at /join/{code} completes signup and returns to join page
- Redirect parameter validated (relative paths only)
- No open redirect vulnerability introduced
- Existing signup flow (without redirect) continues to work
</success_criteria>

<output>
After completion, create `.planning/phases/28-onboarding-flow-testing/28-01-SUMMARY.md`
</output>
