---
phase: 28-onboarding-flow-testing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/teams/route.ts
autonomous: true
requirements:
  - ONBD-03

must_haves:
  truths:
    - "Team creator has both TeamMember and ClubMembership records"
    - "Team creator's ClubMembership has COACH role"
    - "RBAC queries against ClubMembership work for team creators"
  artifacts:
    - path: "src/app/api/teams/route.ts"
      provides: "Team creation with ClubMembership"
      contains: "clubMembership.create"
  key_links:
    - from: "src/app/api/teams/route.ts"
      to: "prisma.$transaction"
      via: "atomic creation of Team + TeamMember + ClubMembership"
      pattern: "tx\\.clubMembership\\.create"
---

<objective>
Fix team creation to create ClubMembership for consistency with RBAC model

Purpose: Currently team creation only creates TeamMember, but the RBAC system uses ClubMembership for permission checks. This causes inconsistency where team creators may fail RBAC queries until they rejoin through another path.

Output: Team creation API that atomically creates both TeamMember (legacy compat) and ClubMembership (RBAC).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-onboarding-flow-testing/28-RESEARCH.md

# Current implementation
@src/app/api/teams/route.ts

# Schema reference
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ClubMembership creation to team creation transaction</name>
  <files>src/app/api/teams/route.ts</files>
  <action>
Update the team creation API to create ClubMembership in addition to TeamMember within the same transaction.

Current code creates:
1. Team record
2. TeamMember with COACH role

Updated code should create:
1. Team record
2. TeamMember with COACH role (for legacy compatibility)
3. ClubMembership with clubId = team.id, userId = user.id, roles = ['COACH']

Implementation:
```typescript
const team = await prisma.$transaction(async (tx) => {
  // Create Team record
  const newTeam = await tx.team.create({
    data: {
      name,
      slug,
      primaryColor,
      secondaryColor,
      joinCode,
    },
  });

  // Create TeamMember record with COACH role (legacy)
  await tx.teamMember.create({
    data: {
      teamId: newTeam.id,
      userId: user.id,
      role: 'COACH',
    },
  });

  // Create ClubMembership record with COACH role (RBAC)
  await tx.clubMembership.create({
    data: {
      clubId: newTeam.id,
      userId: user.id,
      roles: ['COACH'],
      isActive: true,
    },
  });

  return newTeam;
});
```

Note: In this codebase, Team and Club are the same entity (Team.id = ClubMembership.clubId). The ClubMembership model uses "clubId" but references Team.
  </action>
  <verify>
1. Create a new team via the API
2. Query database: `SELECT * FROM "TeamMember" WHERE "teamId" = '{newTeamId}'`
3. Query database: `SELECT * FROM "ClubMembership" WHERE "clubId" = '{newTeamId}'`
4. Both should have records for the creator with COACH role
  </verify>
  <done>Team creation atomically creates both TeamMember and ClubMembership with COACH role</done>
</task>

<task type="auto">
  <name>Task 2: Verify RBAC queries work for team creator</name>
  <files>src/app/api/teams/route.ts</files>
  <action>
After adding ClubMembership creation, verify that existing RBAC patterns work correctly for the team creator.

Test the following after team creation:
1. Creator can access team dashboard (no redirect to onboarding)
2. Creator has COACH permissions (can create practices, manage equipment)
3. CASL ability check returns correct permissions

No code changes needed - this is a verification task. Run these checks:

```bash
# After creating a team, test the dashboard access
curl -X GET http://localhost:3000/api/teams/{teamSlug}/me \
  -H "Cookie: {session_cookie}"

# Check that the response includes COACH role in both systems
```

If issues are found, document them for follow-up.
  </action>
  <verify>
1. Create new team as fresh user
2. Access team dashboard - should work without redirect
3. Access equipment page - should show "Add Equipment" button (coach permission)
4. Access roster page - should show "Invite Link" section (coach permission)
  </verify>
  <done>Team creator has full COACH permissions immediately after team creation</done>
</task>

</tasks>

<verification>
## Database verification

```sql
-- After team creation, verify both records exist
SELECT tm.*, cm.*
FROM "TeamMember" tm
LEFT JOIN "ClubMembership" cm ON cm."clubId" = tm."teamId" AND cm."userId" = tm."userId"
WHERE tm."teamId" = '{new_team_id}';
```

Both tm and cm should have records with COACH role.

## Functional verification

1. Sign up as new user
2. Create team "Test Rowing Club"
3. Verify immediate access to:
   - Team dashboard (/{teamSlug})
   - Equipment management (/{teamSlug}/equipment with Add button)
   - Roster with invite link (/{teamSlug}/roster with team code)
   - Settings (/{teamSlug}/settings)
4. No permission denied errors
</verification>

<success_criteria>
- Team creation transaction includes ClubMembership.create
- ClubMembership has roles: ['COACH']
- Team creator passes all RBAC checks immediately
- Existing team creation flow works without regression
</success_criteria>

<output>
After completion, create `.planning/phases/28-onboarding-flow-testing/28-02-SUMMARY.md`
</output>
