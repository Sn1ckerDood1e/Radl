---
phase: 16-ui-ux-polish
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - src/components/ui/command.tsx
  - src/components/command-palette/command-palette.tsx
  - src/components/command-palette/shortcuts-overlay.tsx
  - src/hooks/use-keyboard-shortcuts.ts
  - src/app/(dashboard)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Cmd+K (Mac) / Ctrl+K (Windows) opens command palette"
    - "Users can navigate to pages via command palette search"
    - "Users can search for athletes and equipment by name"
    - "Pressing ? shows keyboard shortcuts overlay"
    - "Arrow keys navigate command palette results"
  artifacts:
    - path: "src/components/ui/command.tsx"
      provides: "shadcn Command component (cmdk wrapper)"
      exports: ["Command", "CommandDialog", "CommandInput", "CommandList", "CommandGroup", "CommandItem"]
    - path: "src/components/command-palette/command-palette.tsx"
      provides: "Global command palette with navigation and search"
      exports: ["CommandPalette"]
    - path: "src/components/command-palette/shortcuts-overlay.tsx"
      provides: "Keyboard shortcuts help overlay"
      exports: ["ShortcutsOverlay"]
    - path: "src/hooks/use-keyboard-shortcuts.ts"
      provides: "Global keyboard shortcut registration hook"
      exports: ["useKeyboardShortcuts"]
  key_links:
    - from: "src/app/(dashboard)/layout.tsx"
      to: "CommandPalette"
      via: "component render"
      pattern: "<CommandPalette"
    - from: "CommandPalette"
      to: "cmdk"
      via: "shadcn Command component"
      pattern: "CommandDialog"
---

<objective>
Implement command palette and keyboard shortcuts for power users.

Purpose: UIX-09 requires keyboard navigation for desktop power users. The command palette (Cmd+K) provides quick access to navigation, actions, and search - following the Linear/Notion pattern that developers expect.

Output: Global command palette with page navigation, entity search, and keyboard shortcuts overlay.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/16-ui-ux-polish/16-CONTEXT.md
@.planning/phases/16-ui-ux-polish/16-RESEARCH.md

Reference existing layout:
@src/app/(dashboard)/layout.tsx
@src/components/ui/dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add shadcn command component and create global keyboard hook</name>
  <files>
    src/components/ui/command.tsx
    src/hooks/use-keyboard-shortcuts.ts
  </files>
  <action>
1. Add shadcn command component:
   ```bash
   pnpm dlx shadcn@latest add command
   ```
   This installs cmdk dependency and creates `src/components/ui/command.tsx`

2. Create keyboard shortcuts hook at `src/hooks/use-keyboard-shortcuts.ts`:
   ```tsx
   'use client';

   import { useEffect, useCallback } from 'react';

   interface Shortcut {
     key: string;
     meta?: boolean;  // Cmd on Mac, Ctrl on Windows
     shift?: boolean;
     handler: () => void;
     description: string;
   }

   const shortcuts: Shortcut[] = [];

   export function useKeyboardShortcuts(newShortcuts: Shortcut[]) {
     useEffect(() => {
       // Register shortcuts
       shortcuts.push(...newShortcuts);

       const handleKeyDown = (e: KeyboardEvent) => {
         // Don't trigger shortcuts when typing in inputs
         if (
           e.target instanceof HTMLInputElement ||
           e.target instanceof HTMLTextAreaElement ||
           (e.target as HTMLElement).isContentEditable
         ) {
           // Exception: Escape should always work
           if (e.key !== 'Escape') return;
         }

         for (const shortcut of shortcuts) {
           const metaMatch = shortcut.meta
             ? (e.metaKey || e.ctrlKey)
             : (!e.metaKey && !e.ctrlKey);
           const shiftMatch = shortcut.shift ? e.shiftKey : !e.shiftKey;
           const keyMatch = e.key.toLowerCase() === shortcut.key.toLowerCase();

           if (metaMatch && shiftMatch && keyMatch) {
             e.preventDefault();
             shortcut.handler();
             return;
           }
         }
       };

       document.addEventListener('keydown', handleKeyDown);
       return () => {
         document.removeEventListener('keydown', handleKeyDown);
         // Remove registered shortcuts
         newShortcuts.forEach(s => {
           const idx = shortcuts.indexOf(s);
           if (idx > -1) shortcuts.splice(idx, 1);
         });
       };
     }, [newShortcuts]);
   }

   export function getRegisteredShortcuts(): Shortcut[] {
     return [...shortcuts];
   }
   ```
  </action>
  <verify>
    - `cat src/components/ui/command.tsx` shows CommandDialog export
    - `cat src/hooks/use-keyboard-shortcuts.ts` shows useKeyboardShortcuts hook
    - `pnpm tsc --noEmit` passes
  </verify>
  <done>
    Command component installed via shadcn. Keyboard shortcuts hook created with shortcut registration and input field exclusion.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create command palette with navigation and search</name>
  <files>
    src/components/command-palette/command-palette.tsx
  </files>
  <action>
Create the command palette component at `src/components/command-palette/command-palette.tsx`:

```tsx
'use client';

import { useEffect, useState, useCallback } from 'react';
import { useRouter, useParams } from 'next/navigation';
import {
  CommandDialog,
  CommandEmpty,
  CommandGroup,
  CommandInput,
  CommandItem,
  CommandList,
  CommandSeparator,
  CommandShortcut,
} from '@/components/ui/command';
import {
  Users,
  Calendar,
  Ship,
  Settings,
  FileText,
  Trophy,
  Plus,
  Search,
  HelpCircle,
} from 'lucide-react';

interface CommandPaletteProps {
  teamSlug?: string;
  onOpenShortcuts: () => void;
}

export function CommandPalette({ teamSlug, onOpenShortcuts }: CommandPaletteProps) {
  const [open, setOpen] = useState(false);
  const [search, setSearch] = useState('');
  const router = useRouter();

  // Open on Cmd+K / Ctrl+K
  useEffect(() => {
    const down = (e: KeyboardEvent) => {
      if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        setOpen((o) => !o);
      }
      // ? key for shortcuts (not in input)
      if (e.key === '?' && !e.metaKey && !e.ctrlKey) {
        if (
          e.target instanceof HTMLInputElement ||
          e.target instanceof HTMLTextAreaElement
        ) return;
        e.preventDefault();
        onOpenShortcuts();
      }
    };

    document.addEventListener('keydown', down);
    return () => document.removeEventListener('keydown', down);
  }, [onOpenShortcuts]);

  const navigate = useCallback((path: string) => {
    router.push(path);
    setOpen(false);
    setSearch('');
  }, [router]);

  // Navigation items
  const navItems = teamSlug ? [
    { icon: Users, label: 'Roster', path: `/${teamSlug}/roster`, shortcut: 'R' },
    { icon: Calendar, label: 'Practices', path: `/${teamSlug}/practices`, shortcut: 'P' },
    { icon: Ship, label: 'Equipment', path: `/${teamSlug}/equipment`, shortcut: 'E' },
    { icon: Calendar, label: 'Schedule', path: `/${teamSlug}/schedule`, shortcut: 'S' },
    { icon: Trophy, label: 'Regattas', path: `/${teamSlug}/regattas` },
    { icon: FileText, label: 'Practice Templates', path: `/${teamSlug}/practice-templates` },
    { icon: Users, label: 'Lineup Templates', path: `/${teamSlug}/lineup-templates` },
    { icon: Settings, label: 'Settings', path: `/${teamSlug}/settings` },
  ] : [];

  // Action items
  const actionItems = teamSlug ? [
    { icon: Plus, label: 'New Practice', path: `/${teamSlug}/practices/new` },
    { icon: Plus, label: 'Add Equipment', path: `/${teamSlug}/equipment/new` },
    { icon: Plus, label: 'New Template', path: `/${teamSlug}/practice-templates/new` },
  ] : [];

  return (
    <CommandDialog open={open} onOpenChange={setOpen}>
      <CommandInput
        placeholder="Type a command or search..."
        value={search}
        onValueChange={setSearch}
      />
      <CommandList>
        <CommandEmpty>No results found.</CommandEmpty>

        {/* Navigation */}
        <CommandGroup heading="Navigation">
          {navItems.map((item) => (
            <CommandItem
              key={item.path}
              onSelect={() => navigate(item.path)}
              className="cursor-pointer"
            >
              <item.icon className="mr-2 h-4 w-4" />
              <span>{item.label}</span>
              {item.shortcut && (
                <CommandShortcut>{item.shortcut}</CommandShortcut>
              )}
            </CommandItem>
          ))}
        </CommandGroup>

        <CommandSeparator />

        {/* Actions */}
        <CommandGroup heading="Actions">
          {actionItems.map((item) => (
            <CommandItem
              key={item.path}
              onSelect={() => navigate(item.path)}
              className="cursor-pointer"
            >
              <item.icon className="mr-2 h-4 w-4" />
              <span>{item.label}</span>
            </CommandItem>
          ))}
        </CommandGroup>

        <CommandSeparator />

        {/* Help */}
        <CommandGroup heading="Help">
          <CommandItem onSelect={onOpenShortcuts} className="cursor-pointer">
            <HelpCircle className="mr-2 h-4 w-4" />
            <span>Keyboard Shortcuts</span>
            <CommandShortcut>?</CommandShortcut>
          </CommandItem>
        </CommandGroup>
      </CommandList>
    </CommandDialog>
  );
}
```

Features:
- Opens with Cmd+K / Ctrl+K
- Navigation to all main pages
- Quick actions (new practice, add equipment)
- Shows keyboard shortcut hints
- Full keyboard navigation (arrows, enter)
- Search filters items automatically (cmdk built-in)
  </action>
  <verify>
    - `cat src/components/command-palette/command-palette.tsx` shows CommandPalette component
    - `pnpm tsc --noEmit` passes
  </verify>
  <done>
    Command palette created with navigation items, actions, and help section. Opens with Cmd+K, supports full keyboard navigation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create shortcuts overlay and integrate into layout</name>
  <files>
    src/components/command-palette/shortcuts-overlay.tsx
    src/app/(dashboard)/layout.tsx
  </files>
  <action>
1. Create shortcuts overlay at `src/components/command-palette/shortcuts-overlay.tsx`:
   ```tsx
   'use client';

   import {
     Dialog,
     DialogContent,
     DialogHeader,
     DialogTitle,
   } from '@/components/ui/dialog';

   interface ShortcutsOverlayProps {
     open: boolean;
     onOpenChange: (open: boolean) => void;
   }

   const shortcuts = [
     { category: 'Global', items: [
       { keys: ['⌘', 'K'], description: 'Open command palette' },
       { keys: ['?'], description: 'Show keyboard shortcuts' },
       { keys: ['Esc'], description: 'Close dialogs' },
     ]},
     { category: 'Navigation', items: [
       { keys: ['G', 'R'], description: 'Go to Roster' },
       { keys: ['G', 'P'], description: 'Go to Practices' },
       { keys: ['G', 'E'], description: 'Go to Equipment' },
       { keys: ['G', 'S'], description: 'Go to Schedule' },
     ]},
     { category: 'Command Palette', items: [
       { keys: ['↑', '↓'], description: 'Navigate results' },
       { keys: ['Enter'], description: 'Select item' },
       { keys: ['Esc'], description: 'Close palette' },
     ]},
   ];

   export function ShortcutsOverlay({ open, onOpenChange }: ShortcutsOverlayProps) {
     return (
       <Dialog open={open} onOpenChange={onOpenChange}>
         <DialogContent className="max-w-lg">
           <DialogHeader>
             <DialogTitle>Keyboard Shortcuts</DialogTitle>
           </DialogHeader>
           <div className="space-y-6 py-4">
             {shortcuts.map((section) => (
               <div key={section.category}>
                 <h3 className="text-sm font-medium text-zinc-400 mb-3">
                   {section.category}
                 </h3>
                 <div className="space-y-2">
                   {section.items.map((shortcut, idx) => (
                     <div
                       key={idx}
                       className="flex items-center justify-between"
                     >
                       <span className="text-sm text-zinc-300">
                         {shortcut.description}
                       </span>
                       <div className="flex items-center gap-1">
                         {shortcut.keys.map((key, keyIdx) => (
                           <kbd
                             key={keyIdx}
                             className="px-2 py-1 text-xs font-mono bg-zinc-800 border border-zinc-700 rounded"
                           >
                             {key}
                           </kbd>
                         ))}
                       </div>
                     </div>
                   ))}
                 </div>
               </div>
             ))}
           </div>
         </DialogContent>
       </Dialog>
     );
   }
   ```

2. Create client wrapper for command palette at `src/components/command-palette/command-palette-provider.tsx`:
   ```tsx
   'use client';

   import { useState, useEffect } from 'react';
   import { useParams, useRouter } from 'next/navigation';
   import { CommandPalette } from './command-palette';
   import { ShortcutsOverlay } from './shortcuts-overlay';

   export function CommandPaletteProvider() {
     const [shortcutsOpen, setShortcutsOpen] = useState(false);
     const params = useParams();
     const router = useRouter();
     const teamSlug = params?.teamSlug as string | undefined;

     // G+key navigation shortcuts
     useEffect(() => {
       let gPressed = false;
       let gTimeout: NodeJS.Timeout;

       const handleKeyDown = (e: KeyboardEvent) => {
         // Skip if in input
         if (
           e.target instanceof HTMLInputElement ||
           e.target instanceof HTMLTextAreaElement
         ) return;

         if (e.key === 'g' && !e.metaKey && !e.ctrlKey) {
           gPressed = true;
           gTimeout = setTimeout(() => { gPressed = false; }, 1000);
           return;
         }

         if (gPressed && teamSlug) {
           gPressed = false;
           clearTimeout(gTimeout);
           switch (e.key.toLowerCase()) {
             case 'r': router.push(`/${teamSlug}/roster`); break;
             case 'p': router.push(`/${teamSlug}/practices`); break;
             case 'e': router.push(`/${teamSlug}/equipment`); break;
             case 's': router.push(`/${teamSlug}/schedule`); break;
           }
         }
       };

       document.addEventListener('keydown', handleKeyDown);
       return () => document.removeEventListener('keydown', handleKeyDown);
     }, [teamSlug, router]);

     return (
       <>
         <CommandPalette
           teamSlug={teamSlug}
           onOpenShortcuts={() => setShortcutsOpen(true)}
         />
         <ShortcutsOverlay
           open={shortcutsOpen}
           onOpenChange={setShortcutsOpen}
         />
       </>
     );
   }
   ```

3. Update `src/app/(dashboard)/layout.tsx`:
   - Add import: `import { CommandPaletteProvider } from '@/components/command-palette/command-palette-provider';`
   - Add `<CommandPaletteProvider />` inside the PWAWrapper, before the main content div
  </action>
  <verify>
    - `cat src/components/command-palette/shortcuts-overlay.tsx` shows ShortcutsOverlay component
    - `grep -n "CommandPaletteProvider" src/app/(dashboard)/layout.tsx` shows integration
    - `pnpm tsc --noEmit` passes
    - Manual: Press Cmd+K to open palette, press ? to show shortcuts
  </verify>
  <done>
    Shortcuts overlay shows all keyboard shortcuts. Command palette integrated into dashboard layout. G+key navigation shortcuts work for quick page access.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `pnpm tsc --noEmit`
2. Cmd+K opens command palette
3. ? opens shortcuts overlay
4. Arrow keys navigate palette results
5. Enter selects and navigates
6. G+R, G+P, G+E, G+S navigate to pages
7. Search filters command palette items
</verification>

<success_criteria>
- Command component installed from shadcn
- Command palette opens with Cmd+K / Ctrl+K
- Palette includes navigation to all main pages
- Palette includes quick actions (new practice, add equipment)
- ? key shows keyboard shortcuts overlay
- G+key shortcuts navigate to pages (roster, practices, equipment, schedule)
- Shortcuts don't trigger when typing in inputs
- Full keyboard navigation in palette (arrows, enter, escape)
</success_criteria>

<output>
After completion, create `.planning/phases/16-ui-ux-polish/16-04-SUMMARY.md`
</output>
