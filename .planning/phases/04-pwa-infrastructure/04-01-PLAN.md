---
phase: 04-pwa-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - next.config.ts
  - package.json
  - src/app/sw.ts
  - src/app/layout.tsx
  - public/manifest.json
  - public/icons/icon-192x192.png
  - public/icons/icon-512x512.png
  - src/components/pwa/register-sw.tsx
autonomous: true

must_haves:
  truths:
    - "App can be installed as PWA from browser"
    - "Service worker is registered and active"
    - "Static assets are cached by service worker"
    - "Offline fallback page shows when offline with no cache"
  artifacts:
    - path: "next.config.ts"
      provides: "Serwist integration with webpack"
      contains: "withSerwist"
    - path: "src/app/sw.ts"
      provides: "Service worker entry point"
      exports: ["serwist"]
    - path: "public/manifest.json"
      provides: "PWA manifest with icons and metadata"
      contains: "Radl"
    - path: "src/components/pwa/register-sw.tsx"
      provides: "Service worker registration component"
      exports: ["RegisterServiceWorker"]
  key_links:
    - from: "next.config.ts"
      to: "src/app/sw.ts"
      via: "Serwist swSrc config"
      pattern: "swSrc.*sw\\.ts"
    - from: "src/app/layout.tsx"
      to: "src/components/pwa/register-sw.tsx"
      via: "Component import and render"
      pattern: "RegisterServiceWorker"
---

<objective>
Set up PWA foundation with Serwist service worker integration

Purpose: Enable PWA installation and establish service worker caching infrastructure that all offline features depend on
Output: Working PWA manifest, service worker with caching strategies, and registration component
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pwa-infrastructure/04-RESEARCH.md

# Key files
@next.config.ts
@package.json
@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install PWA dependencies and configure Serwist</name>
  <files>
    - package.json
    - next.config.ts
  </files>
  <action>
Install PWA dependencies:
```bash
npm install @serwist/next dexie dexie-react-hooks web-push
npm install -D serwist
```

Update next.config.ts to integrate Serwist:
```typescript
import withSerwistInit from "@serwist/next";

const revision = crypto.randomUUID();

const withSerwist = withSerwistInit({
  swSrc: "src/app/sw.ts",
  swDest: "public/sw.js",
  additionalPrecacheEntries: [{ url: "/~offline", revision }],
});

export default withSerwist({
  // Keep existing config options
});
```

Update package.json scripts:
- Keep "dev": "next dev" (uses Turbopack, fine for dev)
- Change "build": "next build --webpack" (CRITICAL: Serwist requires webpack)

Add public/sw.js to .gitignore (it's generated at build time).
  </action>
  <verify>
`npm run build` completes successfully and generates public/sw.js
  </verify>
  <done>
Serwist integrated with webpack builds, dependencies installed
  </done>
</task>

<task type="auto">
  <name>Task 2: Create service worker and PWA manifest</name>
  <files>
    - src/app/sw.ts
    - public/manifest.json
    - public/icons/icon-192x192.png
    - public/icons/icon-512x512.png
  </files>
  <action>
Create src/app/sw.ts with caching strategies from research:
```typescript
import { defaultCache } from "@serwist/next/worker";
import { Serwist, NetworkFirst, CacheFirst, NetworkOnly } from "serwist";
import { ExpirationPlugin } from "@serwist/expiration";

declare const self: ServiceWorkerGlobalScope;

const serwist = new Serwist({
  precacheEntries: self.__SW_MANIFEST,
  skipWaiting: true,
  clientsClaim: true,
  navigationPreload: true,
  runtimeCaching: [
    // Auth routes - NEVER cache
    {
      urlPattern: /^\/api\/auth\/.*/,
      handler: new NetworkOnly(),
    },
    // API routes - network first with 5min cache fallback
    {
      urlPattern: /^\/api\/.*/,
      handler: new NetworkFirst({
        cacheName: "api-cache",
        plugins: [
          new ExpirationPlugin({
            maxEntries: 50,
            maxAgeSeconds: 5 * 60,
          }),
        ],
      }),
    },
    // Static images - cache first
    {
      urlPattern: /\.(?:png|jpg|jpeg|svg|gif|webp)$/,
      handler: new CacheFirst({
        cacheName: "image-cache",
        plugins: [
          new ExpirationPlugin({
            maxEntries: 100,
            maxAgeSeconds: 30 * 24 * 60 * 60,
          }),
        ],
      }),
    },
    // Default cache for everything else
    ...defaultCache,
  ],
});

serwist.addEventListeners();
```

Create public/manifest.json:
```json
{
  "name": "Radl - Crew Team Management",
  "short_name": "Radl",
  "description": "Manage your rowing team's schedule, lineups, and equipment",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#0066cc",
  "orientation": "portrait-primary",
  "scope": "/",
  "icons": [
    {
      "src": "/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ]
}
```

Create placeholder icons in public/icons/:
- icon-192x192.png: Blue square with "RO" text (simple placeholder)
- icon-512x512.png: Blue square with "RO" text (simple placeholder)

Use a simple approach - create colored placeholder PNGs using Node.js canvas or download generic placeholder icons. The icons can be replaced with proper branded icons later.
  </action>
  <verify>
- src/app/sw.ts exists with proper caching strategies
- public/manifest.json is valid JSON with correct structure
- public/icons/ contains both icon files
  </verify>
  <done>
Service worker entry point and PWA manifest created with proper caching strategies
  </done>
</task>

<task type="auto">
  <name>Task 3: Create registration component and wire into app</name>
  <files>
    - src/components/pwa/register-sw.tsx
    - src/app/layout.tsx
  </files>
  <action>
Create src/components/pwa/register-sw.tsx:
```typescript
'use client';

import { useEffect } from 'react';

export function RegisterServiceWorker() {
  useEffect(() => {
    if (
      typeof window !== 'undefined' &&
      'serviceWorker' in navigator &&
      process.env.NODE_ENV === 'production'
    ) {
      navigator.serviceWorker
        .register('/sw.js')
        .then((registration) => {
          console.log('SW registered:', registration.scope);
        })
        .catch((error) => {
          console.error('SW registration failed:', error);
        });
    }
  }, []);

  return null;
}
```

Update src/app/layout.tsx:
1. Import RegisterServiceWorker component
2. Add manifest link in head: `<link rel="manifest" href="/manifest.json" />`
3. Add theme-color meta: `<meta name="theme-color" content="#0066cc" />`
4. Render RegisterServiceWorker inside body (it returns null, just runs effect)

The component only registers in production to avoid development issues.
  </action>
  <verify>
- `npm run build && npm run start` - service worker is registered (check DevTools > Application > Service Workers)
- Manifest detected in DevTools > Application > Manifest
- Lighthouse PWA audit passes installability criteria
  </verify>
  <done>
Service worker registration wired into app layout, PWA installable
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with webpack and generates public/sw.js
2. Running `npm run start` shows service worker registered in DevTools
3. DevTools Application tab shows:
   - Service worker active and controlling page
   - Manifest detected with correct metadata
   - Cache Storage populated with precached assets
4. In DevTools, check "Offline" in Network tab - app shell still loads
</verification>

<success_criteria>
1. Service worker registered and active in production build
2. PWA manifest properly detected by browser
3. App is installable (Chrome shows install option in address bar)
4. Static assets cached by service worker (verified in DevTools Cache Storage)
5. Build script uses --webpack flag for Serwist compatibility
</success_criteria>

<output>
After completion, create `.planning/phases/04-pwa-infrastructure/04-01-SUMMARY.md`
</output>
