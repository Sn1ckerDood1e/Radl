---
phase: 04-pwa-infrastructure
plan: 06
type: execute
wave: 3
depends_on: ["04-04"]
files_modified:
  - src/lib/push/triggers.ts
  - src/app/api/lineups/[id]/route.ts
  - src/app/api/practices/[id]/route.ts
  - src/components/pwa/notification-settings.tsx
  - src/app/(dashboard)/[teamSlug]/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "Athlete receives notification when added to lineup"
    - "Athlete receives notification when practice is updated"
    - "Athlete receives notification when practice is cancelled"
    - "User can enable/disable push notifications"
  artifacts:
    - path: "src/lib/push/triggers.ts"
      provides: "Functions to trigger notifications on events"
      exports: ["notifyLineupAssignment", "notifyPracticeChange", "notifyPracticeCancelled"]
    - path: "src/components/pwa/notification-settings.tsx"
      provides: "UI for notification preferences"
      exports: ["NotificationSettings"]
  key_links:
    - from: "src/app/api/lineups/[id]/route.ts"
      to: "src/lib/push/triggers.ts"
      via: "notifyLineupAssignment call on seat assignment"
      pattern: "notifyLineupAssignment"
    - from: "src/app/api/practices/[id]/route.ts"
      to: "src/lib/push/triggers.ts"
      via: "notifyPracticeChange on update"
      pattern: "notifyPracticeChange"
---

<objective>
Implement notification triggers for lineup and practice events

Purpose: Athletes stay informed about schedule changes and assignments via push notifications
Output: Notification trigger functions integrated into API routes, notification settings UI
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pwa-infrastructure/04-CONTEXT.md
@.planning/phases/04-pwa-infrastructure/04-04-SUMMARY.md

# Existing API routes to modify
@src/app/api/lineups/[id]/route.ts
@src/app/api/practices/[id]/route.ts
@src/app/(dashboard)/[teamSlug]/settings/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notification trigger functions</name>
  <files>
    - src/lib/push/triggers.ts
  </files>
  <action>
Create src/lib/push/triggers.ts:

```typescript
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;

// Server-side Supabase client for calling Edge Functions
const supabase = createClient(supabaseUrl, supabaseServiceKey);

interface NotificationPayload {
  teamId: string;
  userIds?: string[]; // If not provided, sends to all team members
  title: string;
  body: string;
  url?: string;
  tag?: string;
}

/**
 * Send push notification via Supabase Edge Function
 * Non-blocking - errors are logged but don't fail the calling operation
 */
async function sendNotification(payload: NotificationPayload): Promise<void> {
  try {
    const { error } = await supabase.functions.invoke('send-notification', {
      body: payload,
    });

    if (error) {
      console.error('Failed to send notification:', error);
    }
  } catch (err) {
    console.error('Notification error:', err);
    // Don't throw - notifications are supplementary
  }
}

/**
 * Notify athletes when they are assigned to a lineup
 * Called after seat assignment in lineup API
 */
export async function notifyLineupAssignment(params: {
  teamId: string;
  athleteUserIds: string[]; // Users to notify (new assignments)
  practiceName: string;
  practiceDate: string;
  practiceId: string;
}): Promise<void> {
  const { teamId, athleteUserIds, practiceName, practiceDate, practiceId } = params;

  if (athleteUserIds.length === 0) return;

  await sendNotification({
    teamId,
    userIds: athleteUserIds,
    title: 'Lineup Assignment',
    body: `You've been assigned to ${practiceName} on ${practiceDate}`,
    url: `/practices/${practiceId}`,
    tag: `lineup-${practiceId}`, // Prevents duplicate notifications for same practice
  });
}

/**
 * Notify athletes when a practice is updated (time, location, etc.)
 * Called after practice update in practice API
 */
export async function notifyPracticeChange(params: {
  teamId: string;
  practiceName: string;
  practiceDate: string;
  practiceId: string;
  changeDescription: string; // e.g., "Time changed to 6:30 AM"
}): Promise<void> {
  const { teamId, practiceName, practiceDate, practiceId, changeDescription } = params;

  await sendNotification({
    teamId,
    // No userIds = all team members with subscriptions
    title: 'Practice Updated',
    body: `${practiceName} (${practiceDate}): ${changeDescription}`,
    url: `/practices/${practiceId}`,
    tag: `practice-change-${practiceId}`,
  });
}

/**
 * Notify athletes when a practice is cancelled
 * Called when practice status changes or deleted
 */
export async function notifyPracticeCancelled(params: {
  teamId: string;
  practiceName: string;
  practiceDate: string;
}): Promise<void> {
  const { teamId, practiceName, practiceDate } = params;

  await sendNotification({
    teamId,
    title: 'Practice Cancelled',
    body: `${practiceName} on ${practiceDate} has been cancelled`,
    url: '/schedule',
    tag: `practice-cancelled-${practiceName}-${practiceDate}`,
  });
}

/**
 * Notify coaches when an athlete joins the team
 * Called after invitation acceptance
 */
export async function notifyAthleteJoined(params: {
  teamId: string;
  coachUserIds: string[];
  athleteName: string;
}): Promise<void> {
  const { teamId, coachUserIds, athleteName } = params;

  if (coachUserIds.length === 0) return;

  await sendNotification({
    teamId,
    userIds: coachUserIds,
    title: 'New Team Member',
    body: `${athleteName} has joined the team`,
    url: '/roster',
    tag: `athlete-joined-${Date.now()}`,
  });
}

/**
 * Notify coaches when a damage report is filed
 * (Extends existing damage notification system)
 */
export async function notifyDamageReported(params: {
  teamId: string;
  coachUserIds: string[];
  equipmentName: string;
  location: string;
  reportId: string;
}): Promise<void> {
  const { teamId, coachUserIds, equipmentName, location, reportId } = params;

  if (coachUserIds.length === 0) return;

  await sendNotification({
    teamId,
    userIds: coachUserIds,
    title: 'Damage Reported',
    body: `${equipmentName}: ${location}`,
    url: `/equipment?reportId=${reportId}`,
    tag: `damage-${reportId}`,
  });
}
```

Key design decisions:
- All notification functions are non-blocking (errors logged but not thrown)
- Tags prevent duplicate notifications for rapid changes
- Flexible userIds param: undefined = all team subscribers
- Simple interface - just import and call
  </action>
  <verify>
- File compiles: `npx tsc --noEmit src/lib/push/triggers.ts`
- Exports all trigger functions
  </verify>
  <done>
Notification trigger functions created for lineup assignments, practice changes, and cancellations
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate triggers into API routes</name>
  <files>
    - src/app/api/lineups/[id]/route.ts
    - src/app/api/practices/[id]/route.ts
  </files>
  <action>
Update src/app/api/lineups/[id]/route.ts:

1. Import notification trigger:
```typescript
import { notifyLineupAssignment } from '@/lib/push/triggers';
```

2. After successful seat assignment (PUT/PATCH), identify new athletes and notify:
```typescript
// After saving seats, identify newly assigned athletes
const newlyAssignedAthleteIds = newSeats
  .filter(s => !existingSeats.some(e => e.athleteId === s.athleteId))
  .map(s => s.athleteId);

if (newlyAssignedAthleteIds.length > 0) {
  // Get user IDs from athlete profiles
  const athletes = await prisma.athleteProfile.findMany({
    where: { id: { in: newlyAssignedAthleteIds } },
    include: { teamMember: true },
  });

  const athleteUserIds = athletes.map(a => a.teamMember.userId);

  // Get practice details for notification
  const practice = await prisma.practice.findFirst({
    where: { blocks: { some: { lineup: { id: lineupId } } } },
  });

  if (practice) {
    // Fire and forget - don't await
    notifyLineupAssignment({
      teamId: claims.team_id,
      athleteUserIds,
      practiceName: practice.name,
      practiceDate: format(practice.date, 'MMM d'),
      practiceId: practice.id,
    });
  }
}
```

Update src/app/api/practices/[id]/route.ts:

1. Import notification triggers:
```typescript
import { notifyPracticeChange, notifyPracticeCancelled } from '@/lib/push/triggers';
import { format } from 'date-fns';
```

2. After successful PATCH (update), detect significant changes and notify:
```typescript
// Compare old vs new for significant changes
const significantChanges: string[] = [];

if (oldPractice.startTime !== newPractice.startTime) {
  significantChanges.push(`Time changed to ${format(newPractice.startTime, 'h:mm a')}`);
}
if (oldPractice.date !== newPractice.date) {
  significantChanges.push(`Date changed to ${format(newPractice.date, 'MMM d')}`);
}
// Add other significant fields as needed

if (significantChanges.length > 0 && newPractice.status === 'PUBLISHED') {
  notifyPracticeChange({
    teamId: claims.team_id,
    practiceName: newPractice.name,
    practiceDate: format(newPractice.date, 'MMM d'),
    practiceId: newPractice.id,
    changeDescription: significantChanges.join(', '),
  });
}
```

3. On DELETE, notify if practice was published:
```typescript
// Before delete, check if was published
const practice = await prisma.practice.findUnique({ where: { id } });

// After successful delete
if (practice?.status === 'PUBLISHED') {
  notifyPracticeCancelled({
    teamId: claims.team_id,
    practiceName: practice.name,
    practiceDate: format(practice.date, 'MMM d'),
  });
}
```

Important: All notification calls should be fire-and-forget (no await in the response path) so they don't slow down API responses.
  </action>
  <verify>
- API routes compile without errors
- Updating a published practice triggers notification (check Supabase function logs)
- Deleting a published practice sends cancellation notification
  </verify>
  <done>
Notification triggers integrated into lineup and practice API routes
  </done>
</task>

<task type="auto">
  <name>Task 3: Create notification settings UI</name>
  <files>
    - src/components/pwa/notification-settings.tsx
    - src/app/(dashboard)/[teamSlug]/settings/page.tsx
  </files>
  <action>
Create src/components/pwa/notification-settings.tsx:

```typescript
'use client';

import { useState, useEffect } from 'react';
import {
  isPushSupported,
  getNotificationPermission,
  subscribeToPush,
  unsubscribeFromPush,
  getCurrentSubscription,
} from '@/lib/push/subscribe';

export function NotificationSettings() {
  const [isSupported, setIsSupported] = useState(false);
  const [permission, setPermission] = useState<NotificationPermission | null>(null);
  const [isSubscribed, setIsSubscribed] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    async function checkStatus() {
      const supported = isPushSupported();
      setIsSupported(supported);

      if (supported) {
        setPermission(getNotificationPermission());
        const subscription = await getCurrentSubscription();
        setIsSubscribed(!!subscription);
      }
      setIsLoading(false);
    }
    checkStatus();
  }, []);

  const handleToggle = async () => {
    setError(null);
    setIsLoading(true);

    try {
      if (isSubscribed) {
        await unsubscribeFromPush();
        setIsSubscribed(false);
      } else {
        await subscribeToPush();
        setIsSubscribed(true);
        setPermission('granted');
      }
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to update notifications');
    } finally {
      setIsLoading(false);
    }
  };

  if (!isSupported) {
    return (
      <div className="bg-gray-50 p-4 rounded-lg">
        <h3 className="font-medium text-gray-900">Push Notifications</h3>
        <p className="text-sm text-gray-500 mt-1">
          Push notifications are not supported in your browser.
        </p>
      </div>
    );
  }

  if (permission === 'denied') {
    return (
      <div className="bg-gray-50 p-4 rounded-lg">
        <h3 className="font-medium text-gray-900">Push Notifications</h3>
        <p className="text-sm text-gray-500 mt-1">
          Notifications are blocked. Please enable them in your browser settings.
        </p>
      </div>
    );
  }

  return (
    <div className="bg-gray-50 p-4 rounded-lg">
      <div className="flex items-center justify-between">
        <div>
          <h3 className="font-medium text-gray-900">Push Notifications</h3>
          <p className="text-sm text-gray-500 mt-1">
            {isSubscribed
              ? 'Receive alerts for lineup assignments and schedule changes'
              : 'Get notified about practice updates and assignments'}
          </p>
        </div>
        <button
          onClick={handleToggle}
          disabled={isLoading}
          className={`relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 ${
            isSubscribed ? 'bg-blue-600' : 'bg-gray-200'
          } ${isLoading ? 'opacity-50 cursor-not-allowed' : ''}`}
          role="switch"
          aria-checked={isSubscribed}
        >
          <span
            className={`pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${
              isSubscribed ? 'translate-x-5' : 'translate-x-0'
            }`}
          />
        </button>
      </div>

      {error && (
        <p className="text-sm text-red-600 mt-2">{error}</p>
      )}

      {isSubscribed && (
        <div className="mt-3 text-sm text-gray-600">
          <p>You will be notified when:</p>
          <ul className="list-disc list-inside mt-1 space-y-0.5">
            <li>You are assigned to a lineup</li>
            <li>Practice times or locations change</li>
            <li>A practice is cancelled</li>
          </ul>
        </div>
      )}
    </div>
  );
}
```

Update src/app/(dashboard)/[teamSlug]/settings/page.tsx to include NotificationSettings:

1. Import the component:
```typescript
import { NotificationSettings } from '@/components/pwa/notification-settings';
```

2. Add to the settings page in appropriate section:
```typescript
<section className="mt-8">
  <h2 className="text-lg font-semibold mb-4">Notifications</h2>
  <NotificationSettings />
</section>
```

Per CONTEXT.md decision: Using simple all-or-nothing toggle rather than category-based preferences for v1 simplicity.
  </action>
  <verify>
- Component compiles without errors
- Settings page includes notification settings section
- Toggle enables/disables push subscription
- Shows appropriate state for denied/unsupported browsers
  </verify>
  <done>
Notification settings UI created with toggle switch and integrated into team settings
  </done>
</task>

</tasks>

<verification>
1. Enable notifications in settings page
2. Have coach assign athlete to a lineup
3. Athlete receives push notification (if browser supports and Edge Function deployed)
4. Update practice time - team members receive notification
5. Delete published practice - team receives cancellation notification
6. Disable notifications in settings - no more notifications received
</verification>

<success_criteria>
1. Athletes notified on lineup assignment
2. All team members notified on practice changes (published practices only)
3. Team notified when practice cancelled
4. Simple on/off toggle for notification preferences
5. Graceful handling of unsupported browsers
6. Non-blocking notification delivery (doesn't slow API responses)
</success_criteria>

<output>
After completion, create `.planning/phases/04-pwa-infrastructure/04-06-SUMMARY.md`
</output>
