---
phase: 34-ux-polish
plan: 03
type: execute
wave: 2
depends_on:
  - "34-01"
files_modified:
  - src/components/ui/button.tsx
  - src/lib/toast-helpers.ts
autonomous: true

must_haves:
  truths:
    - "Form submit buttons show spinner only after 300ms"
    - "Error toasts include retry action where retriable"
    - "ERRR-02 (onTouched validation) is verified as already complete"
    - "ERRR-04 (optimistic updates) coverage is documented"
  artifacts:
    - path: "src/components/ui/button.tsx"
      provides: "Button with loading prop using DelayedSpinner"
      exports: ["Button", "ButtonProps"]
    - path: "src/lib/toast-helpers.ts"
      provides: "Error toast helpers with consistent retry"
      exports: ["showErrorToast", "showSuccessToast", "showActionableError"]
  key_links:
    - from: "src/components/ui/button.tsx"
      to: "src/components/ui/delayed-spinner.tsx"
      via: "import { DelayedSpinner }"
      pattern: "import.*DelayedSpinner"
---

<objective>
Integrate DelayedSpinner into Button component and verify error handling consistency across the app.

Purpose: Implements LOAD-03 integration (300ms spinner delay in buttons) and verifies ERRR-01/ERRR-02/ERRR-03 requirements are satisfied.

Output:
- Button component enhanced with loading prop that uses DelayedSpinner
- Verification that error handling patterns are consistent
- Documentation that ERRR-02 is already complete
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-ux-polish/34-RESEARCH.md
@.planning/phases/34-ux-polish/34-01-SUMMARY.md

# Components to modify
@src/components/ui/button.tsx
@src/components/ui/delayed-spinner.tsx
@src/lib/toast-helpers.ts

# Form validation reference
@src/components/ui/form-field.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance Button with loading prop</name>
  <files>src/components/ui/button.tsx</files>
  <action>
Add a `loading` prop to the Button component that displays DelayedSpinner.

Changes to make:
1. Import DelayedSpinner from './delayed-spinner'
2. Add `loading?: boolean` to ButtonProps
3. When loading=true:
   - Set disabled=true automatically
   - Prepend DelayedSpinner with appropriate size based on button size
   - Optionally show loading text or keep children visible

Implementation pattern:
```tsx
import { DelayedSpinner } from './delayed-spinner';

interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  // ... existing props
  loading?: boolean;
}

function Button({
  loading = false,
  disabled,
  children,
  size,
  ...props
}: ButtonProps) {
  // Determine spinner size based on button size
  const spinnerSize = size === 'sm' ? 'sm' : size === 'lg' ? 'lg' : 'md';

  return (
    <button
      disabled={disabled || loading}
      {...props}
    >
      {loading && (
        <DelayedSpinner
          size={spinnerSize}
          className="mr-2"
        />
      )}
      {children}
    </button>
  );
}
```

IMPORTANT: Read the existing button.tsx first to understand its current structure (uses Slot, buttonVariants, etc.) and integrate the loading prop accordingly.

The loading prop should:
- Work with all button variants (default, destructive, outline, etc.)
- Work with all sizes (default, sm, lg, icon)
- Not break existing usage (backward compatible)
  </action>
  <verify>
1. File updated at src/components/ui/button.tsx
2. ButtonProps includes loading?: boolean
3. Button imports DelayedSpinner
4. TypeScript compiles: `npx tsc --noEmit src/components/ui/button.tsx`
  </verify>
  <done>
Button component accepts loading prop, shows DelayedSpinner when loading=true, automatically disables button during loading.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify ERRR-02 form validation compliance</name>
  <files>audit-only</files>
  <action>
Verify that ERRR-02 (form validation errors shown on blur) is already implemented.

Research confirmed: All forms use `mode: 'onTouched'` which shows errors on blur.

Verification steps:
1. Grep for useForm calls to confirm mode: 'onTouched' pattern:
   ```bash
   grep -r "mode:.*onTouched" src/
   grep -r "useForm" src/ | head -20
   ```

2. Check FormField component displays errors correctly:
   - Read src/components/ui/form-field.tsx
   - Verify it shows error message when field is touched and invalid

3. Sample check a few forms:
   - src/components/forms/create-team-form.tsx
   - src/components/athletes/athlete-form.tsx
   - src/components/equipment/equipment-form.tsx

Document findings in SUMMARY.md under "ERRR-02 Verification" section.

NO CODE CHANGES NEEDED - this is verification only.
  </action>
  <verify>
1. Grep shows mode: 'onTouched' in all useForm calls
2. FormField displays error on touched state
3. No forms use mode: 'onSubmit' or 'onChange' (which would not meet ERRR-02)
  </verify>
  <done>
ERRR-02 verified as already complete. All forms use mode: 'onTouched' for blur-based validation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Audit error toast retry consistency</name>
  <files>audit-only</files>
  <action>
Audit API error handling to verify retry actions are provided where appropriate.

Check patterns:
1. Search for showErrorToast usage:
   ```bash
   grep -r "showErrorToast" src/ --include="*.tsx" --include="*.ts"
   ```

2. Search for toast.error usage (should use showErrorToast instead for retry support):
   ```bash
   grep -r "toast\.error" src/ --include="*.tsx" --include="*.ts"
   ```

3. For each toast.error found, determine if it should have retry:
   - Network/fetch errors: SHOULD have retry
   - Validation errors: Should NOT have retry (user must fix input)
   - Auth errors: Should NOT have retry (re-login needed)

4. Document any inconsistencies found.

If issues found:
- List specific files that need retry added
- Note in SUMMARY.md for potential future fix

If all consistent:
- Document that ERRR-01 and ERRR-03 are satisfied

NO MAJOR CODE CHANGES in this task - audit and document only.
If 1-2 simple fixes needed (adding retry to existing showErrorToast), those can be done.
  </action>
  <verify>
1. Audit complete - documented which calls have/lack retry
2. ERRR-01 (error messages with icon and action) verified
3. ERRR-03 (network errors with retry) verified
  </verify>
  <done>
Error handling audit complete. ERRR-01 and ERRR-03 compliance documented. Any gaps noted for future work.
  </done>
</task>

<task type="auto">
  <name>Task 4: Audit optimistic update coverage (ERRR-04)</name>
  <files>audit-only</files>
  <action>
Verify ERRR-04 (optimistic UI updates with rollback) coverage across the app.

Research confirmed: useOfflineMutation hook exists at src/hooks/use-offline-mutation.ts

Verification steps:
1. Read useOfflineMutation hook to understand its API:
   ```bash
   cat src/hooks/use-offline-mutation.ts
   ```

2. Search for existing usage:
   ```bash
   grep -r "useOfflineMutation" src/ --include="*.tsx" --include="*.ts"
   ```

3. Identify key mutation operations that would benefit from optimistic updates:
   - Create operations (new athlete, new equipment, new practice)
   - Update operations (edit profile, update status)
   - Delete operations (remove from roster, delete equipment)

4. Document findings:
   - Which operations currently use optimistic updates
   - Which key operations could benefit but don't use it
   - Whether ERRR-04 is satisfied or needs future work

NO CODE CHANGES - verification and documentation only.
If useOfflineMutation isn't widely used, document as known limitation for future work.
  </action>
  <verify>
1. useOfflineMutation hook examined
2. Usage across codebase documented
3. ERRR-04 compliance assessed (satisfied, partial, or gap)
  </verify>
  <done>
ERRR-04 verified. Optimistic update coverage documented. Any gaps noted for future work.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. TypeScript compiles: `npx tsc --noEmit`
2. Button loading prop works (can test in dev)
3. ERRR-02 verified via grep/code review
4. Error toast audit complete with findings documented
</verification>

<success_criteria>
1. Button component has working loading prop with DelayedSpinner
2. ERRR-02 verified as already implemented (mode: 'onTouched')
3. ERRR-01 and ERRR-03 verified or gaps documented
4. ERRR-04 coverage documented (useOfflineMutation audit)
5. No regression in existing button usage
</success_criteria>

<output>
After completion, create `.planning/phases/34-ux-polish/34-03-SUMMARY.md`

Include sections:
- Button loading prop implementation
- ERRR-02 Verification (onTouched mode)
- Error Toast Audit (ERRR-01, ERRR-03)
- Any gaps or future work identified
</output>
