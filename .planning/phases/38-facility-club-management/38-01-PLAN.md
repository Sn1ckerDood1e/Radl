---
phase: 38-facility-club-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/admin/facilities/route.ts
  - src/app/api/admin/facilities/[facilityId]/route.ts
  - src/lib/validations/facility.ts
  - src/lib/audit/actions.ts
autonomous: true

must_haves:
  truths:
    - "Super admin can list all facilities with club and member counts"
    - "Super admin can create a facility with auto-generated slug"
    - "Super admin can view facility details with aggregate stats"
    - "Super admin can update facility details"
    - "Super admin can delete a facility with cascade impact returned"
  artifacts:
    - path: "src/app/api/admin/facilities/route.ts"
      provides: "GET (list), POST (create) handlers"
      exports: ["GET", "POST"]
    - path: "src/app/api/admin/facilities/[facilityId]/route.ts"
      provides: "GET (detail), PATCH (update), DELETE handlers"
      exports: ["GET", "PATCH", "DELETE"]
    - path: "src/lib/validations/facility.ts"
      provides: "Zod schemas for facility operations"
      exports: ["createFacilitySchema", "updateFacilitySchema"]
  key_links:
    - from: "src/app/api/admin/facilities/route.ts"
      to: "prisma.facility"
      via: "Prisma queries"
      pattern: "prisma\\.facility\\."
    - from: "src/app/api/admin/facilities/route.ts"
      to: "createAdminAuditLogger"
      via: "Audit logging"
      pattern: "audit\\.log"
---

<objective>
Create facility management API endpoints for super admin operations.

Purpose: Enable super admins to manage all facilities (physical locations) through a REST API with full CRUD support, aggregate statistics, and audit logging.

Output: Complete API layer for facility management covering FCLT-01 through FCLT-05.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-facility-club-management/38-RESEARCH.md
@.planning/phases/38-facility-club-management/38-CONTEXT.md

Reference established admin API patterns:
@src/app/api/admin/users/route.ts
@src/app/api/admin/users/[userId]/route.ts
@src/lib/auth/admin-authorize.ts
@src/lib/audit/logger.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create facility validation schemas</name>
  <files>src/lib/validations/facility.ts</files>
  <action>
Create Zod validation schemas for facility operations:

**createFacilitySchema:**
- name: string, required, 1-100 chars
- slug: string, optional (auto-generated if not provided), lowercase alphanumeric with hyphens, 1-50 chars
- address: string, optional, max 200 chars
- city: string, optional, max 100 chars
- state: string, optional, max 100 chars
- country: string, optional, default 'US', max 2 chars
- timezone: string, optional, default 'America/New_York'
- phone: string, optional, max 20 chars
- email: string, optional, valid email or empty string
- website: string, optional, valid URL or empty string
- description: string, optional, max 500 chars

**updateFacilitySchema:** Partial version of create schema (all fields optional)

Export both schemas.
  </action>
  <verify>TypeScript compiles: `cd /home/hb/radl && npx tsc --noEmit src/lib/validations/facility.ts`</verify>
  <done>Both schemas exported and type-check correctly</done>
</task>

<task type="auto">
  <name>Task 2: Create facilities list and create API</name>
  <files>src/app/api/admin/facilities/route.ts</files>
  <action>
Create API route with GET and POST handlers following established admin patterns from /api/admin/users/route.ts:

**GET handler (FCLT-01):**
1. Verify super admin via getSuperAdminContext()
2. Fetch all facilities with aggregate stats:
   ```typescript
   const facilities = await prisma.facility.findMany({
     select: {
       id: true, name: true, slug: true, city: true, state: true, createdAt: true,
       _count: { select: { clubs: true } },
       clubs: { select: { _count: { select: { clubMemberships: true } } } }
     },
     orderBy: { name: 'asc' }
   });
   ```
3. Calculate total member count per facility (sum of club memberships)
4. Return `{ success: true, facilities, total: facilities.length }`

**POST handler (FCLT-02):**
1. Verify super admin
2. Parse and validate body with createFacilitySchema
3. Generate slug from name if not provided (use generateSlug from @/lib/utils/slug)
4. Check slug uniqueness, append suffix if collision (e.g., riverside-2)
5. Create facility via Prisma
6. Log ADMIN_FACILITY_CREATED via createAdminAuditLogger
7. Return `{ success: true, facility }` with status 201
  </action>
  <verify>`curl` test after dev server running, or TypeScript compile check</verify>
  <done>GET returns facilities array with clubCount and memberCount; POST creates and returns facility</done>
</task>

<task type="auto">
  <name>Task 3: Create facility detail, update, and delete API</name>
  <files>src/app/api/admin/facilities/[facilityId]/route.ts, src/lib/audit/actions.ts</files>
  <action>
Create API route with GET, PATCH, DELETE handlers:

**GET handler (FCLT-04):**
1. Verify super admin
2. Validate facilityId is UUID
3. Fetch facility with full details and nested stats:
   ```typescript
   const facility = await prisma.facility.findUnique({
     where: { id: facilityId },
     include: {
       clubs: {
         select: {
           id: true, name: true, slug: true, createdAt: true,
           _count: { select: { clubMemberships: true } }
         },
         orderBy: { name: 'asc' }
       },
       _count: { select: { clubs: true, memberships: true } }
     }
   });
   ```
4. Return 404 if not found
5. Calculate aggregate stats (total members across clubs)
6. Return `{ success: true, facility }`

**PATCH handler (FCLT-03):**
1. Verify super admin
2. Validate facilityId
3. Parse body with updateFacilitySchema
4. Fetch current state for audit
5. Update facility
6. Log ADMIN_FACILITY_UPDATED with before/after
7. Return updated facility

**DELETE handler (FCLT-05):**
1. Verify super admin
2. Validate facilityId
3. Fetch facility with cascade counts:
   - Club count
   - Total member count (sum across all clubs)
   - Equipment count (facility-owned)
4. If `?confirm=true` query param:
   - Delete facility (cascades to clubs via Prisma relations)
   - Log deletion with cascade summary
   - Return success
5. If no confirm:
   - Return `{ requiresConfirmation: true, cascade: { clubs, members, equipment } }`
   - This allows UI to show type-to-confirm dialog

**Update actions.ts:** Add `ADMIN_FACILITY_DELETED` action with description "Super admin deleted a facility".
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>All three handlers work; DELETE returns cascade info before confirmation</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `cd /home/hb/radl && npm run build` succeeds
2. New API routes exist at expected paths
3. Audit actions include ADMIN_FACILITY_DELETED
4. All endpoints require super admin (getSuperAdminContext)
</verification>

<success_criteria>
- Super admin can GET /api/admin/facilities and receive list with stats
- Super admin can POST /api/admin/facilities to create facility
- Super admin can GET /api/admin/facilities/[id] for detail view
- Super admin can PATCH /api/admin/facilities/[id] to update
- Super admin can DELETE /api/admin/facilities/[id] (with confirmation flow)
- All mutations logged to audit log
</success_criteria>

<output>
After completion, create `.planning/phases/38-facility-club-management/38-01-SUMMARY.md`
</output>
