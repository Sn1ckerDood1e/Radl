---
phase: 38-facility-club-management
plan: 04
type: execute
wave: 2
depends_on: ["38-01"]
files_modified:
  - src/app/(admin)/admin/facilities/new/page.tsx
  - src/app/(admin)/admin/facilities/[facilityId]/edit/page.tsx
  - src/components/admin/facilities/facility-form.tsx
  - src/components/admin/type-to-confirm-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Super admin can create a new facility via form"
    - "Super admin can edit existing facility details"
    - "Facility slug auto-generates from name on create"
    - "Delete requires typing facility name to confirm"
    - "Form shows validation errors on field blur"
  artifacts:
    - path: "src/app/(admin)/admin/facilities/new/page.tsx"
      provides: "Create facility page"
      min_lines: 20
    - path: "src/app/(admin)/admin/facilities/[facilityId]/edit/page.tsx"
      provides: "Edit facility page"
      min_lines: 30
    - path: "src/components/admin/facilities/facility-form.tsx"
      provides: "Shared create/edit form component"
      exports: ["FacilityForm"]
    - path: "src/components/admin/type-to-confirm-dialog.tsx"
      provides: "Reusable type-to-confirm delete dialog"
      exports: ["TypeToConfirmDialog"]
  key_links:
    - from: "src/components/admin/facilities/facility-form.tsx"
      to: "/api/admin/facilities"
      via: "POST/PATCH fetch"
      pattern: "fetch.*api/admin/facilities"
    - from: "src/components/admin/type-to-confirm-dialog.tsx"
      to: "inputValue === entityName"
      via: "Confirmation check"
      pattern: "inputValue.*===.*entityName"
---

<objective>
Build facility create/edit forms and type-to-confirm delete dialog.

Purpose: Enable super admins to create new facilities, edit existing ones, and safely delete with typed confirmation.

Output: Create page, edit page, shared form component, and reusable delete dialog (FCLT-02, FCLT-03, FCLT-05 UI).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/38-facility-club-management/38-RESEARCH.md
@.planning/phases/38-facility-club-management/38-CONTEXT.md

Reference established form patterns:
@src/components/admin/users/user-form.tsx
@src/app/(admin)/admin/users/new/page.tsx
@src/app/(admin)/admin/users/[userId]/edit/page.tsx

Validation schemas from 38-01:
@src/lib/validations/facility.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create type-to-confirm dialog component</name>
  <files>src/components/admin/type-to-confirm-dialog.tsx</files>
  <action>
Create reusable type-to-confirm dialog component (per CONTEXT.md requirement for GitHub-style delete):

```typescript
'use client';

import { useState, useEffect } from 'react';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';

interface TypeToConfirmDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  title: string;                    // e.g., "Delete Facility"
  description: string;              // e.g., "This will delete 5 clubs and 120 members"
  confirmText: string;              // Text user must type (e.g., facility name)
  confirmLabel?: string;            // Label above input (default: "To confirm, type")
  actionLabel?: string;             // Button text (default: "Delete")
  onConfirm: () => void | Promise<void>;
  isLoading?: boolean;
  variant?: 'destructive' | 'warning';
}

export function TypeToConfirmDialog({ ... }: TypeToConfirmDialogProps) {
  const [inputValue, setInputValue] = useState('');
  const isConfirmEnabled = inputValue === confirmText;

  // Reset input when dialog opens/closes
  useEffect(() => {
    if (!open) setInputValue('');
  }, [open]);

  const handleConfirm = async () => {
    if (isConfirmEnabled) {
      await onConfirm();
    }
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle className={variant === 'destructive' ? 'text-destructive' : ''}>
            {title}
          </DialogTitle>
          <DialogDescription>{description}</DialogDescription>
        </DialogHeader>
        <div className="space-y-4 py-4">
          <Label htmlFor="confirm-input">
            {confirmLabel || 'To confirm, type'} <strong>{confirmText}</strong>
          </Label>
          <Input
            id="confirm-input"
            value={inputValue}
            onChange={(e) => setInputValue(e.target.value)}
            placeholder={confirmText}
            autoComplete="off"
            autoFocus
          />
        </div>
        <DialogFooter>
          <Button variant="outline" onClick={() => onOpenChange(false)} disabled={isLoading}>
            Cancel
          </Button>
          <Button
            variant={variant === 'destructive' ? 'destructive' : 'default'}
            onClick={handleConfirm}
            disabled={!isConfirmEnabled || isLoading}
          >
            {isLoading ? 'Processing...' : (actionLabel || 'Delete')}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

Export the component.
  </action>
  <verify>TypeScript compiles; component exports correctly</verify>
  <done>Dialog requires exact text match before enabling confirm button</done>
</task>

<task type="auto">
  <name>Task 2: Create shared facility form component</name>
  <files>src/components/admin/facilities/facility-form.tsx</files>
  <action>
Create client component following UserForm pattern:

**Props:**
- mode: 'create' | 'edit'
- facilityId?: string (required for edit)
- defaultValues?: Partial<FacilityFormData>

**Form fields (using react-hook-form with zodResolver):**
- Name (required)
- Slug (optional, auto-generated from name on blur if empty during create)
- Address
- City
- State
- Country (default 'US')
- Timezone (default 'America/New_York')
- Phone
- Email
- Website
- Description (textarea)

**Form sections:**
1. Basic Info: Name, Slug, Description
2. Location: Address, City, State, Country, Timezone
3. Contact: Phone, Email, Website

**Behavior:**
- Use mode: 'onTouched', reValidateMode: 'onChange' (per project convention)
- On name blur in create mode, auto-generate slug if slug field is empty
- Use generateSlug from @/lib/utils/slug
- On submit:
  - POST to /api/admin/facilities (create) or PATCH to /api/admin/facilities/[id] (edit)
  - Show success toast and redirect to /admin/facilities
  - Show error toast with retry on failure

**For slug field:** Add note that slug will be auto-generated if left empty.
  </action>
  <verify>Form submits to correct endpoint based on mode</verify>
  <done>Form handles create/edit with proper validation and auto-slug</done>
</task>

<task type="auto">
  <name>Task 3: Create facility new and edit pages</name>
  <files>
    src/app/(admin)/admin/facilities/new/page.tsx
    src/app/(admin)/admin/facilities/[facilityId]/edit/page.tsx
  </files>
  <action>
**new/page.tsx - Simple wrapper:**
```typescript
import { FacilityForm } from '@/components/admin/facilities/facility-form';

export default function NewFacilityPage() {
  return (
    <div className="max-w-2xl">
      <h1 className="text-2xl font-bold mb-6">Create Facility</h1>
      <FacilityForm mode="create" />
    </div>
  );
}
```

**[facilityId]/edit/page.tsx - Server component with data fetch:**

1. Extract facilityId from params
2. Fetch facility data from API (server component fetch pattern)
3. Return notFound() if not found
4. Render header with breadcrumb and facility name
5. Render FacilityForm with mode="edit", facilityId, and defaultValues from fetched data

Include delete section at bottom of edit page:
- "Danger Zone" section with red border
- Button "Delete Facility" that:
  1. First fetches cascade info from DELETE /api/admin/facilities/[id] (without confirm=true)
  2. Opens TypeToConfirmDialog with cascade warning as description
  3. On confirm, calls DELETE with ?confirm=true
  4. On success, redirects to /admin/facilities

This combines edit and delete on one page (common admin pattern).
  </action>
  <verify>Create page works; edit page loads data and shows delete zone</verify>
  <done>Both pages functional; delete shows type-to-confirm with cascade warning</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `cd /home/hb/radl && npm run build` succeeds
2. /admin/facilities/new shows create form
3. /admin/facilities/[id]/edit shows edit form with existing data
4. Slug auto-generates from name on create
5. Delete shows cascade warning and requires typing facility name
</verification>

<success_criteria>
- Super admin can create facility via form at /admin/facilities/new
- Slug auto-generates from name during creation
- Super admin can edit facility at /admin/facilities/[id]/edit
- Delete section shows cascade impact (clubs, members)
- Delete requires typing exact facility name to confirm
- All form fields validate correctly
</success_criteria>

<output>
After completion, create `.planning/phases/38-facility-club-management/38-04-SUMMARY.md`
</output>
