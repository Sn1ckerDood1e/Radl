---
phase: 38-facility-club-management
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/admin/clubs/route.ts
  - src/app/api/admin/clubs/[clubId]/route.ts
  - src/app/api/admin/clubs/[clubId]/move/route.ts
  - src/lib/validations/club.ts
  - src/lib/audit/actions.ts
autonomous: true

must_haves:
  truths:
    - "Super admin can list all clubs with member counts globally"
    - "Super admin can filter clubs by facility"
    - "Super admin can create a club assigned to a facility"
    - "Super admin can view club details with members and settings"
    - "Super admin can update club details"
    - "Super admin can delete a club with membership impact warning"
    - "Super admin can move a club between facilities"
  artifacts:
    - path: "src/app/api/admin/clubs/route.ts"
      provides: "GET (list), POST (create) handlers"
      exports: ["GET", "POST"]
    - path: "src/app/api/admin/clubs/[clubId]/route.ts"
      provides: "GET (detail), PATCH (update), DELETE handlers"
      exports: ["GET", "PATCH", "DELETE"]
    - path: "src/app/api/admin/clubs/[clubId]/move/route.ts"
      provides: "POST handler for moving club"
      exports: ["POST"]
    - path: "src/lib/validations/club.ts"
      provides: "Zod schemas for club operations"
      exports: ["createClubSchema", "updateClubSchema", "moveClubSchema"]
  key_links:
    - from: "src/app/api/admin/clubs/route.ts"
      to: "prisma.team"
      via: "Prisma queries"
      pattern: "prisma\\.team\\."
    - from: "src/app/api/admin/clubs/[clubId]/move/route.ts"
      to: "ADMIN_CLUB_UPDATED"
      via: "Audit logging"
      pattern: "action.*MOVE_CLUB"
---

<objective>
Create club management API endpoints for super admin operations.

Purpose: Enable super admins to manage all clubs (rowing teams) through a REST API with full CRUD support, facility filtering, move between facilities, and audit logging.

Output: Complete API layer for club management covering CLUB-01 through CLUB-06.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-facility-club-management/38-RESEARCH.md
@.planning/phases/38-facility-club-management/38-CONTEXT.md

Reference established admin API patterns:
@src/app/api/admin/users/route.ts
@src/app/api/admin/users/[userId]/route.ts
@src/lib/auth/admin-authorize.ts
@src/lib/audit/logger.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create club validation schemas</name>
  <files>src/lib/validations/club.ts</files>
  <action>
Create Zod validation schemas for club operations:

**createClubSchema:**
- name: string, required, 1-100 chars
- slug: string, optional (auto-generated), lowercase alphanumeric with hyphens, 1-50 chars
- facilityId: string, required, valid UUID
- primaryColor: string, optional, hex color regex (#XXXXXX), default '#0891b2' (teal-500)
- secondaryColor: string, optional, hex color regex, default '#164e63' (teal-900)

Note: Per CONTEXT.md, team colors are deferred but schema has required fields, so provide sensible defaults.

**updateClubSchema:** Partial of createClubSchema except facilityId cannot be updated here (use move endpoint)

**moveClubSchema:**
- targetFacilityId: string, required, valid UUID

Export all three schemas.
  </action>
  <verify>TypeScript compiles: `cd /home/hb/radl && npx tsc --noEmit src/lib/validations/club.ts`</verify>
  <done>All three schemas exported and type-check correctly</done>
</task>

<task type="auto">
  <name>Task 2: Create clubs list and create API</name>
  <files>src/app/api/admin/clubs/route.ts</files>
  <action>
Create API route with GET and POST handlers:

**GET handler (CLUB-01):**
1. Verify super admin via getSuperAdminContext()
2. Parse optional query params:
   - facilityId: filter by facility
3. Fetch clubs with stats:
   ```typescript
   const clubs = await prisma.team.findMany({
     where: facilityId ? { facilityId } : undefined,
     select: {
       id: true, name: true, slug: true, facilityId: true, createdAt: true,
       facility: { select: { id: true, name: true } },
       _count: { select: { clubMemberships: true } }
     },
     orderBy: [
       { facility: { name: 'asc' } },
       { name: 'asc' }
     ]
   });
   ```
4. Return `{ success: true, clubs, total: clubs.length }`

**POST handler (CLUB-02):**
1. Verify super admin
2. Parse and validate body with createClubSchema
3. Verify facilityId exists (return 404 if not)
4. Generate slug from name if not provided
5. Check slug uniqueness, append suffix if collision
6. Generate joinCode (use generateTeamCode from @/lib/utils/team-code or generate 8-char alphanumeric)
7. Create club via Prisma with all required fields:
   - name, slug, facilityId, primaryColor, secondaryColor, joinCode
8. Also create TeamSettings record (required relation):
   ```typescript
   await prisma.teamSettings.create({ data: { teamId: club.id } });
   ```
9. Log ADMIN_CLUB_CREATED
10. Return `{ success: true, club }` with status 201
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>GET returns clubs array with memberCount; POST creates club with settings</done>
</task>

<task type="auto">
  <name>Task 3: Create club detail, update, delete, and move APIs</name>
  <files>src/app/api/admin/clubs/[clubId]/route.ts, src/app/api/admin/clubs/[clubId]/move/route.ts, src/lib/audit/actions.ts</files>
  <action>
**[clubId]/route.ts - GET, PATCH, DELETE:**

**GET handler (CLUB-04):**
1. Verify super admin
2. Validate clubId is UUID
3. Fetch club with details:
   ```typescript
   const club = await prisma.team.findUnique({
     where: { id: clubId },
     include: {
       facility: { select: { id: true, name: true } },
       settings: true,
       _count: { select: { clubMemberships: true, equipment: true } }
     }
   });
   ```
4. Return 404 if not found
5. Return `{ success: true, club }`

**PATCH handler (CLUB-03):**
1. Verify super admin
2. Parse body with updateClubSchema
3. Fetch current state for audit
4. If slug changed, check uniqueness
5. Update club
6. Log ADMIN_CLUB_UPDATED with before/after
7. Return updated club

**DELETE handler (CLUB-05):**
1. Verify super admin
2. Fetch club with cascade counts:
   - Member count (clubMemberships)
   - Equipment count
3. If `?confirm=true`:
   - Delete club (cascades automatically)
   - Log ADMIN_CLUB_DELETED
   - Return success
4. If no confirm:
   - Return `{ requiresConfirmation: true, cascade: { members, equipment } }`

**[clubId]/move/route.ts - POST (CLUB-06):**

1. Verify super admin
2. Parse body with moveClubSchema
3. Fetch current club with facility
4. Fetch target facility (return 404 if not exists)
5. Update club.facilityId
6. Log ADMIN_CLUB_UPDATED with:
   - beforeState: { facilityId: old, facilityName: old }
   - afterState: { facilityId: new, facilityName: new }
   - metadata: { action: 'MOVE_CLUB', memberCount: N }
7. Return `{ success: true, club }`

**Update actions.ts:** Add `ADMIN_CLUB_DELETED` action with description "Super admin deleted a club".
  </action>
  <verify>TypeScript compiles; all handlers use getSuperAdminContext</verify>
  <done>All handlers work; move updates facilityId and logs audit</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `cd /home/hb/radl && npm run build` succeeds
2. New API routes exist at expected paths
3. Audit actions include ADMIN_CLUB_DELETED
4. Club creation also creates TeamSettings
5. Move operation updates facilityId and logs properly
</verification>

<success_criteria>
- Super admin can GET /api/admin/clubs and receive list with stats
- Super admin can GET /api/admin/clubs?facilityId=X to filter by facility
- Super admin can POST /api/admin/clubs to create club
- Super admin can GET /api/admin/clubs/[id] for detail view
- Super admin can PATCH /api/admin/clubs/[id] to update
- Super admin can DELETE /api/admin/clubs/[id] (with confirmation flow)
- Super admin can POST /api/admin/clubs/[id]/move to transfer between facilities
- All mutations logged to audit log
</success_criteria>

<output>
After completion, create `.planning/phases/38-facility-club-management/38-02-SUMMARY.md`
</output>
