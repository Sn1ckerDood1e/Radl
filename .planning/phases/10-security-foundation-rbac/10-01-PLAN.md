---
phase: 10-security-foundation-rbac
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/generated/prisma/*
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Database schema includes 5-role enum (FACILITY_ADMIN, CLUB_ADMIN, COACH, ATHLETE, PARENT)"
    - "ClubMembership model supports multiple roles per user per club"
    - "AuditLog model exists with proper indexes for 365-day retention queries"
    - "ApiKey model exists with SHA-256 hash storage pattern"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Extended Role enum, ClubMembership, AuditLog, ApiKey models"
      contains: "enum Role"
  key_links:
    - from: "prisma/schema.prisma"
      to: "src/generated/prisma"
      via: "prisma generate"
      pattern: "ClubMembership|AuditLog|ApiKey"
---

<objective>
Add new database models for RBAC, audit logging, and API key authentication.

Purpose: Foundation schemas must exist before any business logic. This plan extends the Prisma schema with ClubMembership (replacing TeamMember for multi-club), AuditLog (security-critical action tracking), and ApiKey (external integration auth).

Output: Extended schema.prisma with new models, generated Prisma client with new types.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-security-foundation-rbac/10-CONTEXT.md
@.planning/phases/10-security-foundation-rbac/10-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Role enum and add ClubMembership model</name>
  <files>prisma/schema.prisma</files>
  <action>
Update the Role enum to add FACILITY_ADMIN and CLUB_ADMIN values before COACH:

```prisma
enum Role {
  FACILITY_ADMIN
  CLUB_ADMIN
  COACH
  ATHLETE
  PARENT
}
```

Add ClubMembership model that supports multi-club membership with multiple roles:

```prisma
// Club membership supporting multi-club with multiple roles per user
model ClubMembership {
  id        String   @id @default(uuid())
  clubId    String   // References Team.id (club = team in current schema)
  userId    String   // Supabase auth user ID
  roles     Role[]   // Array of roles (can be COACH + ATHLETE)
  isActive  Boolean  @default(true)
  joinedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  club Team @relation("ClubMemberships", fields: [clubId], references: [id], onDelete: Cascade)

  @@unique([clubId, userId])
  @@index([userId])
  @@index([clubId])
  @@index([userId, isActive])
}
```

Update Team model to add the ClubMemberships relation:
```prisma
clubMemberships ClubMembership[] @relation("ClubMemberships")
```

Keep existing TeamMember model - it will coexist for backward compatibility until data migration runs.
  </action>
  <verify>Run `npx prisma validate` - should pass with no errors</verify>
  <done>Role enum has 5 values, ClubMembership model exists with roles array and proper indexes</done>
</task>

<task type="auto">
  <name>Task 2: Add AuditLog and ApiKey models</name>
  <files>prisma/schema.prisma</files>
  <action>
Add AuditLog model for security-critical operation tracking:

```prisma
// Audit log for security-critical operations (365-day retention)
model AuditLog {
  id          String   @id @default(uuid())
  clubId      String   // Tenant scoping
  userId      String   // Who performed action
  action      String   // e.g., 'ROLE_CHANGED', 'MEMBER_REMOVED', 'DATA_EXPORTED'
  targetType  String   // e.g., 'ClubMembership', 'Practice', 'Equipment'
  targetId    String?  // ID of affected record (nullable for bulk ops)
  metadata    Json     @default("{}")  // Action-specific details
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([clubId])
  @@index([userId])
  @@index([createdAt])
  @@index([clubId, createdAt])
  @@index([action])
}
```

Add ApiKey model for external integration authentication:

```prisma
// API keys for external integrations (sk_ prefix pattern)
model ApiKey {
  id           String    @id @default(uuid())
  clubId       String
  name         String    // User-friendly name
  keyPrefix    String    // First 8 chars for identification (e.g., 'sk_live_a')
  keyHash      String    @unique  // SHA-256 hash of full key
  createdBy    String    // userId who created the key
  permissions  Json      @default("{}")  // Reserved for future scoped permissions
  lastUsedAt   DateTime?
  expiresAt    DateTime? // Optional expiration
  revokedAt    DateTime? // Soft delete via revocation
  createdAt    DateTime  @default(now())

  club Team @relation("ApiKeys", fields: [clubId], references: [id], onDelete: Cascade)

  @@index([clubId])
  @@index([keyPrefix])
  @@index([createdBy])
}
```

Update Team model to add the ApiKeys relation:
```prisma
apiKeys ApiKey[] @relation("ApiKeys")
```
  </action>
  <verify>Run `npx prisma validate` - should pass with no errors</verify>
  <done>AuditLog and ApiKey models exist with proper indexes and relations</done>
</task>

<task type="auto">
  <name>Task 3: Generate Prisma client and push schema</name>
  <files>src/generated/prisma/*</files>
  <action>
Run Prisma commands to generate client and push schema changes:

1. Generate the Prisma client: `npx prisma generate`
2. Push schema to database: `npx prisma db push`

These commands update the generated types and apply schema changes to the database.

Note: db push is safe here because we're only adding new models and enum values - no destructive changes.
  </action>
  <verify>
Run `npx prisma generate` - should complete without errors.
Run `npx prisma db push` - should apply changes without data loss warnings.
Verify generated types include ClubMembership, AuditLog, ApiKey by checking src/generated/prisma/index.d.ts exists.
  </verify>
  <done>Prisma client generated with new types, database schema updated with new tables</done>
</task>

</tasks>

<verification>
1. `npx prisma validate` passes
2. `npx prisma generate` completes successfully
3. Database has new tables: ClubMembership, AuditLog, ApiKey
4. Role enum in database has 5 values
</verification>

<success_criteria>
- Role enum expanded to 5 roles: FACILITY_ADMIN, CLUB_ADMIN, COACH, ATHLETE, PARENT
- ClubMembership model exists with roles array, proper indexes
- AuditLog model exists with clubId, action, metadata fields and indexes for time-based queries
- ApiKey model exists with keyHash, expiresAt, revokedAt fields
- Prisma client generated with new types available for import
- All existing TeamMember functionality preserved (no breaking changes)
</success_criteria>

<output>
After completion, create `.planning/phases/10-security-foundation-rbac/10-01-SUMMARY.md`
</output>
