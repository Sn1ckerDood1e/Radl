---
phase: 10-security-foundation-rbac
plan: 05
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/lib/audit/logger.ts
  - src/lib/audit/actions.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Audit logger records security-critical actions to AuditLog table"
    - "Audit entries include clubId, userId, action, targetType, metadata"
    - "IP address and user agent captured from request headers"
    - "~10 action types defined for security-critical operations"
  artifacts:
    - path: "src/lib/audit/logger.ts"
      provides: "Audit logging functions"
      exports: ["logAuditEvent", "createAuditLogger"]
    - path: "src/lib/audit/actions.ts"
      provides: "Auditable action type definitions"
      exports: ["AUDITABLE_ACTIONS", "AuditAction"]
  key_links:
    - from: "src/lib/audit/logger.ts"
      to: "prisma.auditLog"
      via: "create"
      pattern: "auditLog\\.create"
---

<objective>
Create audit logging infrastructure for security-critical operations.

Purpose: Compliance and security require logging of sensitive operations (role changes, data exports, member removal). The audit logger captures who did what, when, and from where (IP/user agent).

Output: Audit logging utilities ready for instrumentation in API routes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-security-foundation-rbac/10-CONTEXT.md
@.planning/phases/10-security-foundation-rbac/10-RESEARCH.md
@.planning/phases/10-security-foundation-rbac/10-01-SUMMARY.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define auditable actions</name>
  <files>src/lib/audit/actions.ts</files>
  <action>
Create `src/lib/audit/actions.ts` with ~10 security-critical action types:

```typescript
/**
 * Auditable actions for security-critical operations.
 *
 * Per CONTEXT.md decision: ~10 action types covering role changes,
 * deletions, exports, and auth events.
 *
 * These actions are logged to AuditLog with 365-day retention.
 */
export const AUDITABLE_ACTIONS = {
  // Role management
  ROLE_ASSIGNED: 'ROLE_ASSIGNED',      // Role added to user
  ROLE_REMOVED: 'ROLE_REMOVED',        // Role removed from user
  ROLE_CHANGED: 'ROLE_CHANGED',        // Role modified

  // Membership
  MEMBER_INVITED: 'MEMBER_INVITED',    // Invitation sent
  MEMBER_REMOVED: 'MEMBER_REMOVED',    // Member removed from club
  MEMBER_JOINED: 'MEMBER_JOINED',      // Invitation accepted

  // Deletion
  CLUB_DELETED: 'CLUB_DELETED',        // Club/team deleted
  PRACTICE_DELETED: 'PRACTICE_DELETED', // Practice deleted
  EQUIPMENT_DELETED: 'EQUIPMENT_DELETED', // Equipment deleted

  // Data access
  DATA_EXPORTED: 'DATA_EXPORTED',      // CSV export performed

  // API key management
  API_KEY_CREATED: 'API_KEY_CREATED',
  API_KEY_REVOKED: 'API_KEY_REVOKED',

  // Auth events (optional - captured by Supabase, but useful for correlation)
  LOGIN_SUSPICIOUS: 'LOGIN_SUSPICIOUS', // Unusual login pattern detected
} as const;

export type AuditAction = keyof typeof AUDITABLE_ACTIONS;

/**
 * Human-readable descriptions for audit actions.
 * Used in audit log UI for display.
 */
export const AUDIT_ACTION_DESCRIPTIONS: Record<AuditAction, string> = {
  ROLE_ASSIGNED: 'Role assigned to member',
  ROLE_REMOVED: 'Role removed from member',
  ROLE_CHANGED: 'Member role changed',
  MEMBER_INVITED: 'Member invited to club',
  MEMBER_REMOVED: 'Member removed from club',
  MEMBER_JOINED: 'Member joined club',
  CLUB_DELETED: 'Club deleted',
  PRACTICE_DELETED: 'Practice deleted',
  EQUIPMENT_DELETED: 'Equipment deleted',
  DATA_EXPORTED: 'Data exported',
  API_KEY_CREATED: 'API key created',
  API_KEY_REVOKED: 'API key revoked',
  LOGIN_SUSPICIOUS: 'Suspicious login detected',
};
```

Create the directory if needed: `src/lib/audit/`
  </action>
  <verify>TypeScript compilation passes: `npx tsc --noEmit src/lib/audit/actions.ts`</verify>
  <done>~13 auditable actions defined with type safety and descriptions</done>
</task>

<task type="auto">
  <name>Task 2: Create audit logger utilities</name>
  <files>src/lib/audit/logger.ts</files>
  <action>
Create `src/lib/audit/logger.ts`:

```typescript
import { prisma } from '@/lib/prisma';
import type { AuditAction } from './actions';

/**
 * Context for audit log entries.
 * Captures who and where.
 */
export interface AuditContext {
  clubId: string;
  userId: string;
  ipAddress?: string;
  userAgent?: string;
}

/**
 * Entry data for audit log.
 * Captures what happened.
 */
export interface AuditEntry {
  action: AuditAction;
  targetType: string;       // e.g., 'ClubMembership', 'Practice', 'Equipment'
  targetId?: string;        // ID of affected record (nullable for bulk ops)
  metadata?: Record<string, unknown>;  // Action-specific details
}

/**
 * Logs a security-critical action to the audit log.
 *
 * @param context - Who performed the action and from where
 * @param entry - What action was performed
 *
 * @example
 * await logAuditEvent(
 *   { clubId, userId, ipAddress: '1.2.3.4' },
 *   {
 *     action: 'ROLE_CHANGED',
 *     targetType: 'ClubMembership',
 *     targetId: membership.id,
 *     metadata: { oldRoles: ['ATHLETE'], newRoles: ['COACH'] }
 *   }
 * );
 */
export async function logAuditEvent(
  context: AuditContext,
  entry: AuditEntry
): Promise<void> {
  await prisma.auditLog.create({
    data: {
      clubId: context.clubId,
      userId: context.userId,
      action: entry.action,
      targetType: entry.targetType,
      targetId: entry.targetId ?? null,
      metadata: entry.metadata ?? {},
      ipAddress: context.ipAddress ?? null,
      userAgent: context.userAgent ?? null,
    },
  });
}

/**
 * Creates a bound audit logger from request headers.
 * Extracts IP and user agent automatically.
 *
 * @param request - Next.js request object
 * @param context - Base context (clubId, userId)
 * @returns Bound logger with log() method
 *
 * @example
 * const audit = createAuditLogger(request, { clubId, userId });
 * await audit.log({
 *   action: 'MEMBER_REMOVED',
 *   targetType: 'ClubMembership',
 *   targetId: membership.id,
 * });
 */
export function createAuditLogger(
  request: Request,
  context: Pick<AuditContext, 'clubId' | 'userId'>
) {
  // Extract IP from x-forwarded-for (first IP in chain) or x-real-ip
  const forwardedFor = request.headers.get('x-forwarded-for');
  const ipAddress = forwardedFor?.split(',')[0]?.trim() ??
    request.headers.get('x-real-ip') ??
    undefined;

  const userAgent = request.headers.get('user-agent') ?? undefined;

  return {
    /**
     * Log an audit event with auto-extracted request context.
     */
    log: (entry: AuditEntry) =>
      logAuditEvent(
        {
          ...context,
          ipAddress,
          userAgent,
        },
        entry
      ),
  };
}

/**
 * Batch log multiple audit events (for bulk operations).
 *
 * @param context - Shared context for all events
 * @param entries - Array of audit entries
 */
export async function logAuditEventBatch(
  context: AuditContext,
  entries: AuditEntry[]
): Promise<void> {
  if (entries.length === 0) return;

  await prisma.auditLog.createMany({
    data: entries.map((entry) => ({
      clubId: context.clubId,
      userId: context.userId,
      action: entry.action,
      targetType: entry.targetType,
      targetId: entry.targetId ?? null,
      metadata: entry.metadata ?? {},
      ipAddress: context.ipAddress ?? null,
      userAgent: context.userAgent ?? null,
    })),
  });
}
```
  </action>
  <verify>TypeScript compilation passes: `npx tsc --noEmit src/lib/audit/logger.ts`</verify>
  <done>Audit logger created with single event, batch, and request-bound variants</done>
</task>

</tasks>

<verification>
1. TypeScript compiles all new files
2. AUDITABLE_ACTIONS covers ~13 security-critical action types
3. logAuditEvent creates AuditLog records with all required fields
4. createAuditLogger extracts IP and user agent from request headers
5. logAuditEventBatch efficiently handles bulk operations
</verification>

<success_criteria>
- src/lib/audit/actions.ts exports AUDITABLE_ACTIONS and AuditAction type
- src/lib/audit/logger.ts exports logAuditEvent, createAuditLogger, logAuditEventBatch
- Audit entries include: clubId, userId, action, targetType, targetId, metadata, ipAddress, userAgent
- IP extraction handles x-forwarded-for (proxy) and x-real-ip headers
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-security-foundation-rbac/10-05-SUMMARY.md`
</output>
