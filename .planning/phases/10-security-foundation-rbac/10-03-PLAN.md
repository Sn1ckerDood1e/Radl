---
phase: 10-security-foundation-rbac
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/lib/auth/club-context.ts
  - src/lib/auth/claims.ts
  - src/app/api/clubs/switch/route.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Current club ID is stored in httpOnly cookie"
    - "User can switch between clubs they belong to"
    - "Club switch API verifies membership before allowing switch"
    - "Claims helper includes current club context"
  artifacts:
    - path: "src/lib/auth/club-context.ts"
      provides: "Club cookie management functions"
      exports: ["getCurrentClubId", "setCurrentClubId", "CLUB_COOKIE_NAME"]
    - path: "src/app/api/clubs/switch/route.ts"
      provides: "Club switch API endpoint"
      exports: ["POST"]
  key_links:
    - from: "src/lib/auth/club-context.ts"
      to: "next/headers"
      via: "cookies()"
      pattern: "cookies\\(\\)"
    - from: "src/app/api/clubs/switch/route.ts"
      to: "prisma.clubMembership"
      via: "findFirst"
      pattern: "clubMembership\\.findFirst"
---

<objective>
Implement club context management with cookie persistence and switch API.

Purpose: Multi-club users need to select which club they're operating in. The current club is stored in an httpOnly cookie for security (not accessible to client JavaScript). The switch API verifies membership before allowing club changes.

Output: Club context utilities and switch API ready for use by dashboard and API routes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-security-foundation-rbac/10-CONTEXT.md
@.planning/phases/10-security-foundation-rbac/10-RESEARCH.md
@.planning/phases/10-security-foundation-rbac/10-01-SUMMARY.md
@src/lib/auth/claims.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create club context utilities</name>
  <files>src/lib/auth/club-context.ts</files>
  <action>
Create `src/lib/auth/club-context.ts` with cookie management for current club:

```typescript
import { cookies } from 'next/headers';

export const CLUB_COOKIE_NAME = 'radl_current_club';
const CLUB_COOKIE_MAX_AGE = 60 * 60 * 24 * 365; // 1 year

/**
 * Gets the current club ID from the httpOnly cookie.
 * Returns null if no club selected (user needs to select one).
 */
export async function getCurrentClubId(): Promise<string | null> {
  const cookieStore = await cookies();
  return cookieStore.get(CLUB_COOKIE_NAME)?.value ?? null;
}

/**
 * Sets the current club ID in httpOnly cookie.
 * Called after switch API verifies membership.
 */
export async function setCurrentClubId(clubId: string): Promise<void> {
  const cookieStore = await cookies();
  cookieStore.set(CLUB_COOKIE_NAME, clubId, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'lax',
    maxAge: CLUB_COOKIE_MAX_AGE,
    path: '/',
  });
}

/**
 * Clears the current club cookie.
 * Called on logout or when user is removed from club.
 */
export async function clearCurrentClubId(): Promise<void> {
  const cookieStore = await cookies();
  cookieStore.delete(CLUB_COOKIE_NAME);
}
```
  </action>
  <verify>TypeScript compilation passes: `npx tsc --noEmit src/lib/auth/club-context.ts`</verify>
  <done>Club context utilities created with get, set, and clear functions</done>
</task>

<task type="auto">
  <name>Task 2: Create club switch API endpoint</name>
  <files>src/app/api/clubs/switch/route.ts</files>
  <action>
Create `src/app/api/clubs/switch/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { getClaimsForApiRoute } from '@/lib/auth/claims';
import { setCurrentClubId } from '@/lib/auth/club-context';
import { unauthorizedResponse, forbiddenResponse, serverErrorResponse } from '@/lib/errors';

/**
 * POST /api/clubs/switch
 * Switch to a different club the user is a member of.
 * Stores selection in httpOnly cookie.
 */
export async function POST(request: NextRequest) {
  try {
    const { user, error } = await getClaimsForApiRoute();
    if (error || !user) return unauthorizedResponse();

    const body = await request.json();
    const { clubId } = body;

    if (!clubId || typeof clubId !== 'string') {
      return NextResponse.json(
        { error: 'clubId is required' },
        { status: 400 }
      );
    }

    // Verify user has active membership in target club
    const membership = await prisma.clubMembership.findFirst({
      where: {
        clubId,
        userId: user.id,
        isActive: true,
      },
      include: {
        club: {
          select: {
            id: true,
            name: true,
            slug: true,
          },
        },
      },
    });

    if (!membership) {
      return forbiddenResponse('Not a member of this club');
    }

    // Set the club cookie
    await setCurrentClubId(clubId);

    return NextResponse.json({
      success: true,
      club: membership.club,
      roles: membership.roles,
    });
  } catch (error) {
    return serverErrorResponse(error, 'clubs/switch:POST');
  }
}
```

Create the directory if needed: `src/app/api/clubs/switch/`
  </action>
  <verify>
TypeScript compilation passes: `npx tsc --noEmit src/app/api/clubs/switch/route.ts`
  </verify>
  <done>Club switch API created with membership verification</done>
</task>

<task type="auto">
  <name>Task 3: Extend claims helper with club context</name>
  <files>src/lib/auth/claims.ts</files>
  <action>
Update `src/lib/auth/claims.ts` to include club context:

1. Update CustomJwtPayload interface to include club_id:
```typescript
export interface CustomJwtPayload {
  sub: string;
  email: string;
  team_id: string | null;      // Legacy - kept for backward compatibility
  club_id?: string | null;     // New - current club from cookie
  user_role: 'COACH' | 'ATHLETE' | 'PARENT' | null;  // Legacy single role
  user_roles?: string[];       // New - all roles in current club
}
```

2. Update ClaimsResult to include clubId and roles:
```typescript
export type ClaimsResult = {
  user: User | null;
  claims: CustomJwtPayload | null;
  clubId: string | null;       // Current club from cookie
  roles: string[];             // Roles in current club
  error: string | null;
};
```

3. Update getClaimsForApiRoute to include club context:

After getting the base claims, add:

```typescript
import { getCurrentClubId } from './club-context';

// ... existing code ...

// Get current club from cookie
const clubId = await getCurrentClubId();
let roles: string[] = [];

if (clubId) {
  // Get user's roles in current club
  const membership = await prisma.clubMembership.findFirst({
    where: {
      clubId,
      userId: user.id,
      isActive: true,
    },
  });

  if (membership) {
    roles = membership.roles;
  }
}

// If no club selected but user has legacy TeamMember, use that
if (!clubId && claims.team_id) {
  // Backward compatibility with TeamMember
  if (claims.user_role) {
    roles = [claims.user_role];
  }
}

return {
  user,
  claims,
  clubId: clubId || claims.team_id,  // Fall back to legacy team_id
  roles,
  error: null,
};
```

Keep backward compatibility with the old structure - team_id and user_role still work.
  </action>
  <verify>
TypeScript compilation passes: `npx tsc --noEmit src/lib/auth/claims.ts`
  </verify>
  <done>Claims helper extended with club context and roles array</done>
</task>

</tasks>

<verification>
1. TypeScript compiles all new and modified files
2. getCurrentClubId and setCurrentClubId work with Next.js cookies API
3. Club switch API verifies ClubMembership before allowing switch
4. Claims helper returns clubId and roles array
5. Backward compatibility maintained - team_id still works for legacy data
</verification>

<success_criteria>
- src/lib/auth/club-context.ts exports getCurrentClubId, setCurrentClubId, clearCurrentClubId
- Cookie uses httpOnly, secure (in production), sameSite: 'lax'
- POST /api/clubs/switch verifies membership before setting cookie
- ClaimsResult includes clubId and roles fields
- Legacy team_id/user_role still work for existing TeamMember data
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-security-foundation-rbac/10-03-SUMMARY.md`
</output>
