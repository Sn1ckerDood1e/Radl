---
phase: 10-security-foundation-rbac
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - src/lib/permissions/ability.ts
  - src/lib/permissions/actions.ts
  - src/lib/permissions/subjects.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "CASL ability factory creates permissions without role inheritance"
    - "FACILITY_ADMIN cannot create lineups unless also has COACH role"
    - "PARENT can only see linked athlete data and team schedule"
    - "Permissions are defined for all 5 roles with tenant scoping"
  artifacts:
    - path: "src/lib/permissions/ability.ts"
      provides: "defineAbilityFor factory function"
      exports: ["defineAbilityFor", "AppAbility"]
    - path: "src/lib/permissions/actions.ts"
      provides: "Action type definitions"
      exports: ["Action", "ACTIONS"]
    - path: "src/lib/permissions/subjects.ts"
      provides: "Subject type definitions"
      exports: ["AppSubjects", "SUBJECTS"]
  key_links:
    - from: "src/lib/permissions/ability.ts"
      to: "@casl/ability"
      via: "import"
      pattern: "AbilityBuilder|PureAbility"
    - from: "src/lib/permissions/ability.ts"
      to: "@casl/prisma"
      via: "import"
      pattern: "createPrismaAbility"
---

<objective>
Install CASL packages and create the ability factory for role-based permissions.

Purpose: CASL is the industry-standard RBAC library for JavaScript. The ability factory defines what each role can do, implementing the "no inheritance" policy from CONTEXT.md (FACILITY_ADMIN can manage clubs but not create lineups unless also COACH).

Output: CASL packages installed, ability factory ready for use in API routes and React components.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-security-foundation-rbac/10-CONTEXT.md
@.planning/phases/10-security-foundation-rbac/10-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install CASL packages</name>
  <files>package.json, package-lock.json</files>
  <action>
Install the three CASL packages needed for isomorphic permissions:

```bash
npm install @casl/ability @casl/prisma @casl/react
```

These provide:
- @casl/ability: Core ability definition and checking
- @casl/prisma: Prisma query integration with accessibleBy()
- @casl/react: React hooks and Can component
  </action>
  <verify>
Run `npm list @casl/ability @casl/prisma @casl/react` - all three packages should be listed.
Check package.json includes all three as dependencies.
  </verify>
  <done>CASL packages installed and available for import</done>
</task>

<task type="auto">
  <name>Task 2: Create action and subject definitions</name>
  <files>src/lib/permissions/actions.ts, src/lib/permissions/subjects.ts</files>
  <action>
Create `src/lib/permissions/actions.ts` with all permission actions:

```typescript
/**
 * Permission actions for CASL ability definitions.
 * These match security-critical operations and standard CRUD.
 */

export const ACTIONS = {
  // Standard CRUD
  manage: 'manage',  // All CRUD operations
  create: 'create',
  read: 'read',
  update: 'update',
  delete: 'delete',

  // Role management (auditable)
  assignRole: 'assign-role',

  // Audit and data access
  viewAuditLog: 'view-audit-log',
  exportData: 'export-data',

  // API key management
  manageApiKeys: 'manage-api-keys',

  // Member management (auditable)
  inviteMember: 'invite-member',
  removeMember: 'remove-member',

  // Practice/lineup specific
  publishPractice: 'publish-practice',
} as const;

export type Action = typeof ACTIONS[keyof typeof ACTIONS];
```

Create `src/lib/permissions/subjects.ts` with subject definitions:

```typescript
import type { Subjects } from '@casl/prisma';
import type {
  Team,
  Practice,
  Lineup,
  Equipment,
  AthleteProfile,
  Season,
  ClubMembership,
  AuditLog,
  ApiKey,
  Regatta,
  Entry,
} from '@/generated/prisma';

/**
 * Subject types for CASL ability definitions.
 * Maps Prisma models to CASL subjects with field typing.
 */
export type AppSubjects = Subjects<{
  Team: Team;
  Practice: Practice;
  Lineup: Lineup;
  Equipment: Equipment;
  AthleteProfile: AthleteProfile;
  Season: Season;
  ClubMembership: ClubMembership;
  AuditLog: AuditLog;
  ApiKey: ApiKey;
  Regatta: Regatta;
  Entry: Entry;
}>;

export const SUBJECTS = [
  'Team',
  'Practice',
  'Lineup',
  'Equipment',
  'AthleteProfile',
  'Season',
  'ClubMembership',
  'AuditLog',
  'ApiKey',
  'Regatta',
  'Entry',
] as const;

export type SubjectName = typeof SUBJECTS[number];
```
  </action>
  <verify>
TypeScript compilation passes: `npx tsc --noEmit src/lib/permissions/actions.ts src/lib/permissions/subjects.ts`
  </verify>
  <done>Action and subject type definitions created with proper typing</done>
</task>

<task type="auto">
  <name>Task 3: Create ability factory with role-specific permissions</name>
  <files>src/lib/permissions/ability.ts</files>
  <action>
Create `src/lib/permissions/ability.ts` with the ability factory:

```typescript
import { AbilityBuilder, PureAbility } from '@casl/ability';
import { createPrismaAbility, PrismaQuery } from '@casl/prisma';
import type { AppSubjects } from './subjects';
import type { Action } from './actions';

/**
 * Application ability type combining actions and subjects with Prisma query support.
 */
export type AppAbility = PureAbility<[Action, AppSubjects | 'all'], PrismaQuery>;

/**
 * User context for ability creation.
 * Passed from auth layer to define what user can do.
 */
export interface UserContext {
  userId: string;
  clubId: string;
  roles: ('FACILITY_ADMIN' | 'CLUB_ADMIN' | 'COACH' | 'ATHLETE' | 'PARENT')[];
  linkedAthleteIds?: string[];  // For PARENT role - IDs of athletes they can see
}

/**
 * Defines abilities for a user based on their roles in current club.
 *
 * IMPORTANT: No role inheritance - each role grants specific permissions only.
 * A FACILITY_ADMIN cannot create lineups unless they ALSO have COACH role.
 * Users can hold multiple roles explicitly for expanded capabilities.
 *
 * @param user - User context with roles and club
 * @returns CASL ability instance for permission checking
 */
export function defineAbilityFor(user: UserContext): AppAbility {
  const { can, build } = new AbilityBuilder<AppAbility>(createPrismaAbility);

  // FACILITY_ADMIN - manages all clubs in facility, no lineup creation
  if (user.roles.includes('FACILITY_ADMIN')) {
    // Admin powers for all clubs (facility-wide)
    can('manage', 'Team');
    can('assign-role', 'Team');
    can('view-audit-log', 'AuditLog');  // All audit logs in facility
    can('export-data', 'Team');
    can('manage-api-keys', 'ApiKey');
    can('invite-member', 'Team');
    can('remove-member', 'Team');
    can('read', 'Practice');
    can('read', 'Lineup');
    can('read', 'Equipment');
    can('read', 'AthleteProfile');
    can('read', 'Season');
    can('read', 'Regatta');
    can('read', 'Entry');
    // NOTE: Cannot create/update lineups, practices - must also have COACH role
  }

  // CLUB_ADMIN - manages their specific club
  if (user.roles.includes('CLUB_ADMIN')) {
    can('manage', 'Team', { id: user.clubId });
    can('assign-role', 'ClubMembership', { clubId: user.clubId });
    can('view-audit-log', 'AuditLog', { clubId: user.clubId });
    can('export-data', 'Team', { id: user.clubId });
    can('manage-api-keys', 'ApiKey', { clubId: user.clubId });
    can('invite-member', 'ClubMembership', { clubId: user.clubId });
    can('remove-member', 'ClubMembership', { clubId: user.clubId });
    can('read', 'Practice', { teamId: user.clubId });
    can('read', 'Lineup');  // Can see lineups in their club
    can('read', 'Equipment', { teamId: user.clubId });
    can('read', 'AthleteProfile');  // View roster
    can('read', 'Season', { teamId: user.clubId });
    can('read', 'Regatta', { teamId: user.clubId });
    can('read', 'Entry');
    // NOTE: Cannot create/edit lineups, practices - must also have COACH role
  }

  // COACH - creates lineups, manages practices
  if (user.roles.includes('COACH')) {
    can('manage', 'Practice', { teamId: user.clubId });
    can('publish-practice', 'Practice', { teamId: user.clubId });
    can('manage', 'Lineup');  // Full lineup control
    can('manage', 'Equipment', { teamId: user.clubId });
    can('read', 'AthleteProfile');  // View all athletes for lineup
    can('manage', 'Season', { teamId: user.clubId });
    can('manage', 'Regatta', { teamId: user.clubId });
    can('manage', 'Entry');
    // Own audit log entries only
    can('view-audit-log', 'AuditLog', { clubId: user.clubId, userId: user.userId });
  }

  // ATHLETE - views their own data and team schedule
  if (user.roles.includes('ATHLETE')) {
    can('read', 'Practice', { teamId: user.clubId });  // All practices (published only enforced at query)
    can('read', 'Lineup');  // See lineups they're in
    can('read', 'Equipment', { teamId: user.clubId });  // Boat info
    can('read', 'Season', { teamId: user.clubId });
    can('read', 'Regatta', { teamId: user.clubId });
    can('read', 'Entry');  // Race entries
    can('update', 'AthleteProfile', { teamMemberId: user.userId });  // Own profile only
  }

  // PARENT - sees linked athlete(s) data + team schedule
  if (user.roles.includes('PARENT') && user.linkedAthleteIds?.length) {
    can('read', 'Practice', { teamId: user.clubId });  // Team schedule
    can('read', 'AthleteProfile', { id: { in: user.linkedAthleteIds } });  // Linked athletes only
    can('read', 'Lineup');  // Filtered server-side to show only linked athletes
    can('read', 'Regatta', { teamId: user.clubId });
    can('read', 'Entry');
  }

  return build();
}

/**
 * Creates an empty ability (no permissions).
 * Used when user has no valid context.
 */
export function createEmptyAbility(): AppAbility {
  const { build } = new AbilityBuilder<AppAbility>(createPrismaAbility);
  return build();
}
```
  </action>
  <verify>
TypeScript compilation passes: `npx tsc --noEmit src/lib/permissions/ability.ts`
  </verify>
  <done>Ability factory created with role-specific permissions, no inheritance pattern implemented</done>
</task>

</tasks>

<verification>
1. All three CASL packages installed: `npm list @casl/ability @casl/prisma @casl/react`
2. TypeScript compilation passes for all new files
3. Ability factory correctly implements no-inheritance pattern (test: FACILITY_ADMIN without COACH cannot manage Lineup)
</verification>

<success_criteria>
- @casl/ability, @casl/prisma, @casl/react installed as dependencies
- src/lib/permissions/actions.ts exports Action type and ACTIONS constant
- src/lib/permissions/subjects.ts exports AppSubjects type and SUBJECTS constant
- src/lib/permissions/ability.ts exports defineAbilityFor function and AppAbility type
- FACILITY_ADMIN permissions include Team management but NOT Lineup/Practice creation
- COACH permissions include Lineup/Practice creation
- PARENT permissions scoped to linkedAthleteIds
- All TypeScript types compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-security-foundation-rbac/10-02-SUMMARY.md`
</output>
