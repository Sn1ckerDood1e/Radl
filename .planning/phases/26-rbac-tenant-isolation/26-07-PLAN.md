---
phase: 26-rbac-tenant-isolation
plan: 07
type: execute
wave: 3
depends_on: ["26-03"]
files_modified:
  - .planning/phases/26-rbac-tenant-isolation/26-07-API-RESPONSE-AUDIT.md
autonomous: true

must_haves:
  truths:
    - "API responses don't include data from other tenants"
    - "Shared equipment responses don't leak club ownership details to other clubs"
    - "Error messages don't reveal existence of cross-tenant resources"
  artifacts:
    - path: ".planning/phases/26-rbac-tenant-isolation/26-07-API-RESPONSE-AUDIT.md"
      provides: "API response data leak audit"
      contains: "| Endpoint | Fields Returned |"
  key_links:
    - from: "src/app/api/**/route.ts"
      to: "NextResponse.json"
      via: "response payload"
      pattern: "NextResponse\\.json"
---

<objective>
Audit API responses for potential data leaks across tenants.

Purpose: Verify ISOL-06 (API responses don't leak data from other tenants). Check that even with proper filtering, response payloads don't accidentally include sensitive cross-tenant information.

Output: Audit document confirming no cross-tenant data in API responses.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-rbac-tenant-isolation/26-RESEARCH.md
@.planning/phases/26-rbac-tenant-isolation/26-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit Response Payloads</name>
  <files>.planning/phases/26-rbac-tenant-isolation/26-07-API-RESPONSE-AUDIT.md</files>
  <action>
Review API routes that return data and document response shapes:

1. **Equipment API** (/api/equipment):
   - Does shared equipment include `clubId` of the owning club?
   - Does `ownerType: 'FACILITY'` reveal facility structure?
   - Are usage logs from other clubs included?

2. **Practices API** (/api/practices):
   - Does response include any cross-club references?
   - Are lineups filtered to current club only?
   - Do nested includes leak data?

3. **Athletes API** (/api/athletes):
   - Does roster response include athletes from other clubs?
   - Are parent links exposed across club boundaries?

4. **Audit Logs API** (/api/audit-logs):
   - Are logs filtered by club/facility correctly?
   - Do log details reveal other tenant actions?

For each endpoint, document:
| Field | Type | Potential Leak? | Mitigation |
|-------|------|-----------------|------------|
| equipment.clubId | UUID | Could identify owning club | Consider omitting for shared equipment |
| equipment.usageLogs | Relation | Could include other clubs | Verify filter applied |
  </action>
  <verify>Response payload audit complete for high-risk endpoints</verify>
  <done>API response shapes documented with leak risk assessment</done>
</task>

<task type="auto">
  <name>Task 2: Verify Error Message Safety</name>
  <files>.planning/phases/26-rbac-tenant-isolation/26-07-API-RESPONSE-AUDIT.md</files>
  <action>
Check error messages for information disclosure:

1. **404 vs 403 Decision**:
   - When user requests resource from other tenant, what error?
   - 404 is safer (doesn't confirm existence)
   - 403 reveals resource exists but is forbidden

2. **Current Pattern Audit**:
```typescript
// Find patterns like:
if (!resource) return NotFound('Resource not found');  // GOOD - doesn't reveal
if (!canAccess) return Forbidden('Cannot access');      // REVEALS existence

// Should be:
if (!resource || !canAccess) return NotFound('Resource not found');  // SAFE
```

3. **Grep for pattern:**
```bash
grep -r "forbiddenResponse\|Forbidden\|403" src/app/api --include="*.ts"
```

Document any routes that reveal resource existence to unauthorized users.
  </action>
  <verify>Error message patterns documented with safety assessment</verify>
  <done>ISOL-06 assessment complete: No data leak in API responses or error messages</done>
</task>

</tasks>

<verification>
- [ ] All data-returning endpoints audited
- [ ] Response payload fields documented
- [ ] Potential leak risks identified
- [ ] Error message patterns assessed
- [ ] ISOL-06 compliance determination made
</verification>

<success_criteria>
ISOL-06: API responses don't leak cross-tenant data
Error safety: 404 used appropriately to hide resource existence
Shared equipment: Ownership details not exposed to non-owners
</success_criteria>

<output>
After completion, create `.planning/phases/26-rbac-tenant-isolation/26-07-SUMMARY.md`
</output>
