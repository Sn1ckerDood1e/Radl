---
phase: 26-rbac-tenant-isolation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/__tests__/permissions/ability.test.ts
autonomous: true

must_haves:
  truths:
    - "FACILITY_ADMIN cannot create practices or lineups without COACH role"
    - "CLUB_ADMIN can only access their own club's data"
    - "COACH can manage practices and equipment"
    - "ATHLETE can only view data, not modify practices"
    - "Each role has explicitly verified permissions"
  artifacts:
    - path: "src/__tests__/permissions/ability.test.ts"
      provides: "CASL ability unit tests"
      min_lines: 100
      exports: []
  key_links:
    - from: "src/__tests__/permissions/ability.test.ts"
      to: "src/lib/permissions/ability.ts"
      via: "import defineAbilityFor"
      pattern: "import.*defineAbilityFor"
---

<objective>
Create comprehensive unit tests for CASL ability definitions covering all 5 roles.

Purpose: Verify RBAC-01 through RBAC-04 (FACILITY_ADMIN, CLUB_ADMIN, COACH, ATHLETE permissions) at the ability definition level. These tests validate that the permission rules are correctly defined before testing enforcement.

Output: Vitest test file with passing tests for all role boundary requirements.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-rbac-tenant-isolation/26-RESEARCH.md
@src/lib/permissions/ability.ts
@src/lib/permissions/subjects.ts
@src/lib/permissions/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CASL Ability Unit Tests</name>
  <files>src/__tests__/permissions/ability.test.ts</files>
  <action>
Create test file with describe blocks for each role requirement:

**RBAC-01: FACILITY_ADMIN Tests**
```typescript
describe('RBAC-01: FACILITY_ADMIN permissions', () => {
  it('can read practices in facility view mode', () => {
    const ability = defineAbilityFor({
      userId: 'user-1',
      clubId: 'club-a',
      facilityId: 'facility-1',
      roles: ['FACILITY_ADMIN'],
      viewMode: 'facility',
    });
    expect(ability.can('read', 'Practice')).toBe(true);
  });

  it('cannot create practices without COACH role', () => {
    const ability = defineAbilityFor({
      userId: 'user-1',
      clubId: 'club-a',
      facilityId: 'facility-1',
      roles: ['FACILITY_ADMIN'],  // No COACH
      viewMode: 'facility',
    });
    expect(ability.can('create', 'Practice')).toBe(false);
    expect(ability.can('manage', 'Practice')).toBe(false);
  });

  it('cannot create lineups without COACH role', () => {
    const ability = defineAbilityFor({
      userId: 'user-1',
      clubId: 'club-a',
      roles: ['FACILITY_ADMIN'],
      viewMode: 'facility',
    });
    expect(ability.can('create', 'Lineup')).toBe(false);
    expect(ability.can('manage', 'Lineup')).toBe(false);
  });

  it('CAN create practices when also has COACH role', () => {
    const ability = defineAbilityFor({
      userId: 'user-1',
      clubId: 'club-a',
      facilityId: 'facility-1',
      roles: ['FACILITY_ADMIN', 'COACH'],  // Both roles
      viewMode: 'club',
    });
    expect(ability.can('manage', 'Practice', { teamId: 'club-a' })).toBe(true);
    expect(ability.can('manage', 'Lineup')).toBe(true);
  });
});
```

**RBAC-02: CLUB_ADMIN Tests**
- Can manage own club settings
- Cannot access other clubs
- Cannot create lineups without COACH role

**RBAC-03: COACH Tests**
- Can manage practices for their club
- Can manage equipment
- Can create and manage lineups

**RBAC-04: ATHLETE Tests**
- Can read practices (published only - enforced at query level)
- Can read lineups they're in
- Cannot create or modify practices
- Cannot create or modify equipment

**No Role Tests**
- Empty ability returns false for all actions

Import from @/lib/permissions/ability and use Vitest's describe/it/expect.
  </action>
  <verify>npm test -- src/__tests__/permissions/ability.test.ts passes</verify>
  <done>All RBAC-01 through RBAC-04 ability tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Add Cross-Role Boundary Tests</name>
  <files>src/__tests__/permissions/ability.test.ts</files>
  <action>
Add tests that verify role boundaries are maintained:

**Club Isolation Tests**
```typescript
describe('Club isolation', () => {
  it('COACH cannot manage other clubs practices', () => {
    const ability = defineAbilityFor({
      userId: 'user-1',
      clubId: 'club-a',
      roles: ['COACH'],
      viewMode: 'club',
    });
    // Can manage own club
    expect(ability.can('manage', 'Practice', { teamId: 'club-a' })).toBe(true);
    // Cannot manage other club
    expect(ability.can('manage', 'Practice', { teamId: 'club-b' })).toBe(false);
  });

  it('CLUB_ADMIN cannot manage other clubs', () => {
    const ability = defineAbilityFor({
      userId: 'user-1',
      clubId: 'club-a',
      roles: ['CLUB_ADMIN'],
      viewMode: 'club',
    });
    expect(ability.can('manage', 'Team', { id: 'club-a' })).toBe(true);
    expect(ability.can('manage', 'Team', { id: 'club-b' })).toBe(false);
  });
});
```

**Privilege Escalation Prevention**
- ATHLETE cannot assign roles
- COACH cannot change team settings
- CLUB_ADMIN cannot access other clubs
  </action>
  <verify>npm test -- src/__tests__/permissions/ability.test.ts passes with cross-role tests</verify>
  <done>Cross-role boundary tests verify no privilege escalation possible in ability definitions</done>
</task>

</tasks>

<verification>
- [ ] Test file exists at src/__tests__/permissions/ability.test.ts
- [ ] All 5 roles have test coverage (FACILITY_ADMIN, CLUB_ADMIN, COACH, ATHLETE, PARENT)
- [ ] npm test runs without failures
- [ ] Tests cover both positive cases (can do X) and negative cases (cannot do Y)
</verification>

<success_criteria>
RBAC-01: Tests verify FACILITY_ADMIN can only do facility-level operations
RBAC-02: Tests verify CLUB_ADMIN can only access their club
RBAC-03: Tests verify COACH can manage practices/equipment
RBAC-04: Tests verify ATHLETE can only view their schedule
All tests PASS with npm test
</success_criteria>

<output>
After completion, create `.planning/phases/26-rbac-tenant-isolation/26-02-SUMMARY.md`
</output>
