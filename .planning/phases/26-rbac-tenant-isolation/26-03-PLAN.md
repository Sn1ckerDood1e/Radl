---
phase: 26-rbac-tenant-isolation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/26-rbac-tenant-isolation/26-03-CASL-ENFORCEMENT-AUDIT.md
autonomous: true

must_haves:
  truths:
    - "All API routes using accessibleBy are documented"
    - "All API routes missing accessibleBy are identified"
    - "CASL permission checks are enumerated for each route"
  artifacts:
    - path: ".planning/phases/26-rbac-tenant-isolation/26-03-CASL-ENFORCEMENT-AUDIT.md"
      provides: "API route CASL enforcement audit"
      contains: "| Route | accessibleBy | ability.can |"
  key_links:
    - from: "src/app/api/**/*.ts"
      to: "@casl/prisma"
      via: "import accessibleBy"
      pattern: "accessibleBy\\(context\\.ability\\)"
---

<objective>
Audit all API routes for CASL permission enforcement at the server-side.

Purpose: Verify RBAC-06 (CASL permissions enforced server-side, not just client). Identify routes that rely only on client-side CASL checks or manual filtering instead of proper accessibleBy() integration.

Output: Audit document showing which routes have proper CASL enforcement and which need remediation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-rbac-tenant-isolation/26-RESEARCH.md
@src/app/api/practices/route.ts
@src/app/api/equipment/route.ts
@src/app/api/lineups/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enumerate API Routes</name>
  <files>.planning/phases/26-rbac-tenant-isolation/26-03-CASL-ENFORCEMENT-AUDIT.md</files>
  <action>
Scan all API routes in src/app/api/ and document:

1. **Route inventory**: List all route.ts files with their HTTP methods (GET, POST, PUT, DELETE, PATCH)

2. **Auth pattern detection**: For each route, identify:
   - Uses getAuthContext? (yes/no)
   - Uses accessibleBy? (yes/no)
   - Uses ability.can? (yes/no)
   - Manual clubId/teamId filter? (yes/no)
   - No auth check? (CRITICAL)

Use grep/ripgrep to find patterns:
```bash
# Find all route files
find src/app/api -name "route.ts" | wc -l

# Find routes using accessibleBy
grep -r "accessibleBy" src/app/api --include="route.ts" -l

# Find routes using ability.can
grep -r "ability.can\|ability\.cannot" src/app/api --include="route.ts" -l

# Find routes with getAuthContext
grep -r "getAuthContext" src/app/api --include="route.ts" -l

# Find routes without getAuthContext (potential gaps)
find src/app/api -name "route.ts" -exec grep -L "getAuthContext" {} \;
```
  </action>
  <verify>Route inventory complete with HTTP methods</verify>
  <done>All API routes enumerated</done>
</task>

<task type="auto">
  <name>Task 2: Document CASL Enforcement Status</name>
  <files>.planning/phases/26-rbac-tenant-isolation/26-03-CASL-ENFORCEMENT-AUDIT.md</files>
  <action>
Create audit document with:

1. **Summary table**:
| Route | Methods | getAuthContext | accessibleBy | ability.can | Manual Filter | Status |
|-------|---------|----------------|--------------|-------------|---------------|--------|
| /api/practices | GET, POST | yes | yes | yes | no | OK |
| /api/lineups | GET, POST | yes | yes | yes | no | OK |
| /api/seasons | GET, POST | yes | no | yes | clubId | PARTIAL |

2. **RBAC-06 Compliance**:
   - COMPLIANT: Routes using accessibleBy for queries
   - PARTIAL: Routes with ability.can but manual filtering
   - NON-COMPLIANT: Routes missing server-side CASL

3. **Risk Assessment**:
   - HIGH: Routes with sensitive data but no accessibleBy
   - MEDIUM: Routes with manual filtering that could be improved
   - LOW: Read-only routes with proper auth

4. **Remediation Priority**:
   - List routes that need accessibleBy added
   - Note which are blocking for RBAC-06 pass
  </action>
  <verify>Audit document categorizes all routes by CASL enforcement status</verify>
  <done>CASL enforcement audit complete with RBAC-06 compliance status for each route</done>
</task>

</tasks>

<verification>
- [ ] All routes from src/app/api enumerated
- [ ] Each route has HTTP methods documented
- [ ] accessibleBy usage clearly marked
- [ ] ability.can checks documented
- [ ] Routes missing CASL enforcement flagged
- [ ] RBAC-06 compliance determination made
</verification>

<success_criteria>
RBAC-06 assessment complete: Know which routes comply and which don't
Gap list exists: Routes needing accessibleBy are prioritized
No blind spots: Every API route is accounted for
</success_criteria>

<output>
After completion, create `.planning/phases/26-rbac-tenant-isolation/26-03-SUMMARY.md`
</output>
