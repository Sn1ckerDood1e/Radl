---
phase: 26-rbac-tenant-isolation
plan: 05
type: execute
wave: 2
depends_on: ["26-02"]
files_modified:
  - src/__tests__/api/practices.test.ts
  - src/__tests__/api/equipment.test.ts
autonomous: true

must_haves:
  truths:
    - "ATHLETE cannot POST to /api/practices"
    - "COACH can POST to /api/practices for their club"
    - "COACH cannot POST to /api/practices for other clubs"
    - "API returns 403 for unauthorized role"
  artifacts:
    - path: "src/__tests__/api/practices.test.ts"
      provides: "API route integration tests for RBAC"
      min_lines: 80
      contains: "describe('RBAC"
    - path: "src/__tests__/api/equipment.test.ts"
      provides: "Equipment API RBAC tests"
      min_lines: 50
  key_links:
    - from: "src/__tests__/api/practices.test.ts"
      to: "src/app/api/practices/route.ts"
      via: "mock getAuthContext"
      pattern: "vi\\.mock.*get-auth-context"
---

<objective>
Create API route integration tests that verify RBAC enforcement end-to-end.

Purpose: Verify RBAC-03 (COACH can manage practices/equipment) and RBAC-04 (ATHLETE cannot modify) at the API route level. These tests validate that permission checks work correctly with different user roles.

Output: Integration test files that mock auth context and verify correct 403 responses for unauthorized actions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-rbac-tenant-isolation/26-RESEARCH.md
@.planning/phases/26-rbac-tenant-isolation/26-02-SUMMARY.md
@src/app/api/practices/route.ts
@src/app/api/equipment/route.ts
@src/lib/auth/get-auth-context.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Practices API RBAC Tests</name>
  <files>src/__tests__/api/practices.test.ts</files>
  <action>
Create integration tests for /api/practices with mocked auth context:

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { POST, GET } from '@/app/api/practices/route';
import { NextRequest } from 'next/server';
import { defineAbilityFor } from '@/lib/permissions/ability';

// Mock the auth module
vi.mock('@/lib/auth/get-auth-context');
vi.mock('@/lib/prisma', () => ({
  prisma: {
    practice: {
      findMany: vi.fn().mockResolvedValue([]),
      create: vi.fn(),
    },
    season: {
      findFirst: vi.fn(),
    },
  },
}));

describe('RBAC: /api/practices', () => {
  const { getAuthContext } = require('@/lib/auth/get-auth-context');
  const { prisma } = require('@/lib/prisma');

  beforeEach(() => {
    vi.clearAllMocks();
  });

  describe('POST - Create Practice', () => {
    const validBody = {
      seasonId: 'season-1',
      name: 'Morning Practice',
      date: '2026-02-01',
      startTime: '2026-02-01T06:00:00Z',
      endTime: '2026-02-01T08:00:00Z',
      blocks: [{ type: 'WATER' }],
    };

    it('allows COACH to create practice', async () => {
      getAuthContext.mockResolvedValue({
        success: true,
        context: {
          userId: 'user-1',
          clubId: 'club-a',
          roles: ['COACH'],
          ability: defineAbilityFor({
            userId: 'user-1',
            clubId: 'club-a',
            roles: ['COACH'],
            viewMode: 'club',
          }),
        },
      });

      prisma.season.findFirst.mockResolvedValue({ id: 'season-1', teamId: 'club-a' });
      prisma.practice.create.mockResolvedValue({ id: 'practice-1', ...validBody });

      const request = new NextRequest('http://localhost/api/practices', {
        method: 'POST',
        body: JSON.stringify(validBody),
      });

      const response = await POST(request);
      expect(response.status).not.toBe(403);
    });

    it('denies ATHLETE from creating practice (403)', async () => {
      getAuthContext.mockResolvedValue({
        success: true,
        context: {
          userId: 'user-1',
          clubId: 'club-a',
          roles: ['ATHLETE'],
          ability: defineAbilityFor({
            userId: 'user-1',
            clubId: 'club-a',
            roles: ['ATHLETE'],
            viewMode: 'club',
          }),
        },
      });

      const request = new NextRequest('http://localhost/api/practices', {
        method: 'POST',
        body: JSON.stringify(validBody),
      });

      const response = await POST(request);
      expect(response.status).toBe(403);
    });

    it('denies CLUB_ADMIN without COACH role (403)', async () => {
      getAuthContext.mockResolvedValue({
        success: true,
        context: {
          userId: 'user-1',
          clubId: 'club-a',
          roles: ['CLUB_ADMIN'],  // No COACH
          ability: defineAbilityFor({
            userId: 'user-1',
            clubId: 'club-a',
            roles: ['CLUB_ADMIN'],
            viewMode: 'club',
          }),
        },
      });

      const request = new NextRequest('http://localhost/api/practices', {
        method: 'POST',
        body: JSON.stringify(validBody),
      });

      const response = await POST(request);
      expect(response.status).toBe(403);
    });
  });
});
```

Note: Tests mock prisma to avoid database calls - focus is on RBAC, not DB.
  </action>
  <verify>npm test -- src/__tests__/api/practices.test.ts passes</verify>
  <done>Practices API RBAC tests pass with correct 403 for ATHLETE</done>
</task>

<task type="auto">
  <name>Task 2: Create Equipment API RBAC Tests</name>
  <files>src/__tests__/api/equipment.test.ts</files>
  <action>
Create integration tests for /api/equipment:

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { POST, GET } from '@/app/api/equipment/route';
import { NextRequest } from 'next/server';
import { defineAbilityFor } from '@/lib/permissions/ability';

vi.mock('@/lib/auth/get-auth-context');
vi.mock('@/lib/prisma', () => ({
  prisma: {
    equipment: {
      findMany: vi.fn().mockResolvedValue([]),
      create: vi.fn(),
    },
  },
}));

describe('RBAC: /api/equipment', () => {
  const { getAuthContext } = require('@/lib/auth/get-auth-context');
  const { prisma } = require('@/lib/prisma');

  beforeEach(() => {
    vi.clearAllMocks();
  });

  describe('POST - Create Equipment', () => {
    const validBody = {
      name: 'Racing Shell 8+',
      type: 'SHELL',
      seatCount: 8,
    };

    it('allows COACH to create equipment', async () => {
      getAuthContext.mockResolvedValue({
        success: true,
        context: {
          userId: 'user-1',
          clubId: 'club-a',
          roles: ['COACH'],
          ability: defineAbilityFor({
            userId: 'user-1',
            clubId: 'club-a',
            roles: ['COACH'],
            viewMode: 'club',
          }),
        },
      });

      prisma.equipment.create.mockResolvedValue({ id: 'equip-1', ...validBody });

      const request = new NextRequest('http://localhost/api/equipment', {
        method: 'POST',
        body: JSON.stringify(validBody),
      });

      const response = await POST(request);
      expect(response.status).not.toBe(403);
    });

    it('denies ATHLETE from creating equipment (403)', async () => {
      getAuthContext.mockResolvedValue({
        success: true,
        context: {
          userId: 'user-1',
          clubId: 'club-a',
          roles: ['ATHLETE'],
          ability: defineAbilityFor({
            userId: 'user-1',
            clubId: 'club-a',
            roles: ['ATHLETE'],
            viewMode: 'club',
          }),
        },
      });

      const request = new NextRequest('http://localhost/api/equipment', {
        method: 'POST',
        body: JSON.stringify(validBody),
      });

      const response = await POST(request);
      expect(response.status).toBe(403);
    });
  });
});
```
  </action>
  <verify>npm test -- src/__tests__/api/equipment.test.ts passes</verify>
  <done>Equipment API RBAC tests pass with correct 403 for ATHLETE</done>
</task>

</tasks>

<verification>
- [ ] Test files exist in src/__tests__/api/
- [ ] Tests mock getAuthContext with different roles
- [ ] Tests verify 403 returned for unauthorized roles
- [ ] Tests verify success for authorized roles
- [ ] npm test runs without failures
</verification>

<success_criteria>
RBAC-03: COACH can create practices and equipment (tests pass)
RBAC-04: ATHLETE cannot create practices or equipment (403 returned)
No-inheritance verified: CLUB_ADMIN without COACH cannot create practices
</success_criteria>

<output>
After completion, create `.planning/phases/26-rbac-tenant-isolation/26-05-SUMMARY.md`
</output>
