---
phase: 26-rbac-tenant-isolation
plan: 04
type: execute
wave: 2
depends_on: ["26-01"]
files_modified:
  - supabase/tests/rls-policies.test.sql
  - .planning/phases/26-rbac-tenant-isolation/26-04-RLS-TEST-RESULTS.md
autonomous: true

must_haves:
  truths:
    - "Cross-tenant data access is blocked at database level"
    - "User A cannot see Team B's data"
    - "RLS policies correctly filter by tenant context"
  artifacts:
    - path: "supabase/tests/rls-policies.test.sql"
      provides: "pgTAP tests for RLS cross-tenant isolation"
      min_lines: 50
      contains: "SELECT plan("
  key_links:
    - from: "supabase/tests/rls-policies.test.sql"
      to: "pg_policies"
      via: "tests.authenticate_as"
      pattern: "tests\\.authenticate_as"
---

<objective>
Create pgTAP tests to verify RLS policies block cross-tenant access.

Purpose: Verify ISOL-03 (cross-tenant data access blocked) at the database level using pgTAP testing framework. These tests prove that even if application layer has bugs, the database enforces isolation.

Output: pgTAP test file that can be run in CI and test results document.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-rbac-tenant-isolation/26-RESEARCH.md
@.planning/phases/26-rbac-tenant-isolation/26-01-SUMMARY.md
@supabase/migrations/00005_facility_rls_helpers.sql
@supabase/migrations/00008_facility_rls_policies.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable pgTAP and Test Helpers</name>
  <files>supabase/tests/rls-policies.test.sql</files>
  <action>
First, ensure pgTAP and supabase-test-helpers are enabled:

1. Check if extensions exist:
```sql
SELECT * FROM pg_extension WHERE extname IN ('pgtap', 'basejump-supabase_test_helpers');
```

2. If not installed, create migration or run directly:
```sql
CREATE EXTENSION IF NOT EXISTS pgtap;
CREATE EXTENSION IF NOT EXISTS "basejump-supabase_test_helpers";
```

Note: If these extensions aren't available in your Supabase instance, you may need to enable them in the Dashboard (Database > Extensions).

Document which extensions are available and any blockers.
  </action>
  <verify>Extensions installed or documented as unavailable</verify>
  <done>pgTAP availability confirmed</done>
</task>

<task type="auto">
  <name>Task 2: Create RLS Cross-Tenant Tests</name>
  <files>supabase/tests/rls-policies.test.sql</files>
  <action>
Create pgTAP test file for tables that HAVE policies (from 26-01 audit):

```sql
-- supabase/tests/rls-policies.test.sql
-- Tests for RLS cross-tenant isolation (ISOL-03)

BEGIN;
SELECT plan(10);  -- Adjust based on actual tests

-- =============================================================================
-- Setup: Create test users with different tenant contexts
-- =============================================================================

-- Create test users
SELECT tests.create_supabase_user('club_a_coach', 'coach_a@test.com');
SELECT tests.create_supabase_user('club_b_coach', 'coach_b@test.com');

-- Set up JWT claims for Club A user
-- Note: This simulates the custom_access_token_hook setting claims

-- =============================================================================
-- Test 1: Equipment visibility by owner
-- =============================================================================

-- Club A coach can see their equipment
SELECT tests.authenticate_as('club_a_coach');
SELECT ok(
  EXISTS(SELECT 1 FROM "Equipment" WHERE "teamId" = 'club-a-id'),
  'Club A coach can query their equipment'
);

-- Club A coach cannot see Club B equipment (non-shared)
SELECT is_empty(
  $$ SELECT * FROM "Equipment" WHERE "teamId" = 'club-b-id' AND "isShared" = false $$,
  'Club A coach cannot see Club B non-shared equipment'
);

-- =============================================================================
-- Test 2: Facility visibility
-- =============================================================================

SELECT tests.authenticate_as('club_a_coach');
SELECT ok(
  (SELECT COUNT(*) FROM "Facility" WHERE id = 'facility-1') <= 1,
  'User can only see their facility'
);

-- =============================================================================
-- Test 3: Team/Club isolation
-- =============================================================================

SELECT tests.authenticate_as('club_a_coach');
SELECT is_empty(
  $$ SELECT * FROM "Team" WHERE id = 'club-b-id' $$,
  'Club A user cannot see Club B team'
);

-- =============================================================================
-- Cleanup
-- =============================================================================

SELECT tests.clear_authentication();
SELECT * FROM finish();
ROLLBACK;
```

Adapt tests based on 26-01 audit - only test tables that HAVE policies. For tables without policies, document as "cannot test - no policies".
  </action>
  <verify>pgTAP tests run without SQL errors</verify>
  <done>RLS cross-tenant tests created for tables with policies</done>
</task>

<task type="auto">
  <name>Task 3: Run Tests and Document Results</name>
  <files>.planning/phases/26-rbac-tenant-isolation/26-04-RLS-TEST-RESULTS.md</files>
  <action>
Run the pgTAP tests and document results:

1. Execute tests:
```bash
# Using supabase CLI (if available)
supabase db test

# Or directly in SQL Editor
\i supabase/tests/rls-policies.test.sql
```

2. Create results document:
```markdown
# RLS Test Results

**Date:** YYYY-MM-DD
**Test File:** supabase/tests/rls-policies.test.sql

## Summary

| Result | Count |
|--------|-------|
| PASS | X |
| FAIL | Y |
| SKIP | Z |

## Test Results

| Test | Result | Notes |
|------|--------|-------|
| Equipment cross-tenant | PASS | Club A cannot see Club B equipment |
| Facility isolation | PASS | Users see only their facility |
| Team isolation | SKIP | No RLS policy exists |

## ISOL-03 Assessment

Based on test results:
- PASS: Tables with policies correctly block cross-tenant access
- FAIL: [list any failures]
- BLOCKED: Tables without policies cannot be tested

## Recommendations

[Any remediation needed]
```
  </action>
  <verify>Test results document exists with PASS/FAIL status for each test</verify>
  <done>ISOL-03 verification complete with documented test results</done>
</task>

</tasks>

<verification>
- [ ] pgTAP extension availability documented
- [ ] Test file exists at supabase/tests/rls-policies.test.sql
- [ ] Tests cover Equipment, Facility, FacilityMembership (tables with policies)
- [ ] Cross-tenant access attempts documented as blocked or unblocked
- [ ] Results document created with PASS/FAIL for each test
</verification>

<success_criteria>
ISOL-03: Cross-tenant data access is proven blocked for tables with RLS policies
Test coverage: All tables with policies have cross-tenant tests
Documentation: Test results show which tables pass isolation requirements
</success_criteria>

<output>
After completion, create `.planning/phases/26-rbac-tenant-isolation/26-04-SUMMARY.md`
</output>
