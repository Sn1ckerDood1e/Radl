---
phase: 26-rbac-tenant-isolation
plan: 06
type: execute
wave: 2
depends_on: ["26-01"]
files_modified:
  - .planning/phases/26-rbac-tenant-isolation/26-06-JWT-CLAIMS-AUDIT.md
autonomous: true

must_haves:
  truths:
    - "JWT claims include facility_id, club_id, and user_roles"
    - "RLS helper functions correctly read JWT claims"
    - "Data access patterns match JWT claim structure"
  artifacts:
    - path: ".planning/phases/26-rbac-tenant-isolation/26-06-JWT-CLAIMS-AUDIT.md"
      provides: "JWT claims and RLS helper function audit"
      contains: "| Claim | RLS Function | Usage |"
  key_links:
    - from: "custom_access_token_hook"
      to: "get_current_facility_id()"
      via: "request.jwt.claims"
      pattern: "current_setting.*request.jwt.claims"
---

<objective>
Verify JWT claims match data access patterns in RLS policies.

Purpose: Verify ISOL-04 (JWT claims match data access patterns) by auditing the custom_access_token_hook, RLS helper functions, and policy usage. Ensure claims are correctly set and read.

Output: Audit document confirming claim -> RLS function -> policy chain is intact.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-rbac-tenant-isolation/26-RESEARCH.md
@.planning/phases/26-rbac-tenant-isolation/26-01-SUMMARY.md
@supabase/migrations/00006_facility_access_token_hook.sql
@supabase/migrations/00005_facility_rls_helpers.sql
@supabase/migrations/00008_facility_rls_policies.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document JWT Claim Chain</name>
  <files>.planning/phases/26-rbac-tenant-isolation/26-06-JWT-CLAIMS-AUDIT.md</files>
  <action>
Trace the complete claim lifecycle:

1. **Custom Access Token Hook** (00006_facility_access_token_hook.sql):
   - What claims are added to the JWT?
   - How are facility_id, club_id, user_roles populated?
   - What happens if user has no club/facility membership?

2. **RLS Helper Functions** (00005_facility_rls_helpers.sql):
   - get_current_facility_id() - How does it read the claim?
   - get_current_club_id() - Same analysis
   - has_role() - How does it check user_roles array?
   - is_facility_admin(), is_coach_or_higher() - Role checks

3. **Claim Usage in Policies** (00008_facility_rls_policies.sql):
   - Which policies use which helper functions?
   - Are there any policies with hardcoded values instead of claims?

Document as a flow:
```
User Login
    ↓
custom_access_token_hook fires
    ↓
Claims added: { facility_id, club_id, user_roles }
    ↓
Request to Supabase
    ↓
RLS policy checks: get_current_facility_id() = request.jwt.claims.facility_id
    ↓
Data filtered by tenant
```
  </action>
  <verify>JWT claim flow documented from login to policy evaluation</verify>
  <done>Complete claim lifecycle documented</done>
</task>

<task type="auto">
  <name>Task 2: Verify Claim-Policy Alignment</name>
  <files>.planning/phases/26-rbac-tenant-isolation/26-06-JWT-CLAIMS-AUDIT.md</files>
  <action>
Create verification table:

| Claim | RLS Function | Policies Using | Data Column | Match? |
|-------|--------------|----------------|-------------|--------|
| facility_id | get_current_facility_id() | equipment_select_hierarchical, facility_select | Facility.id, Equipment.facilityId | YES |
| club_id | get_current_club_id() | equipment_select_hierarchical | Equipment.clubId, Equipment.teamId | YES |
| user_roles | has_role('COACH') | equipment_insert_hierarchical | N/A (permission check) | YES |

Check for mismatches:
1. Policies using column names that don't exist
2. Helper functions reading wrong claim names
3. Missing claims for required data access patterns

**ISOL-04 Assessment:**
- If all claims map correctly to RLS functions and policies: PASS
- If any mismatch found: FAIL with details
  </action>
  <verify>Claim-policy alignment table complete with Match? column</verify>
  <done>ISOL-04 verification complete: JWT claims match data access patterns</done>
</task>

</tasks>

<verification>
- [ ] All JWT claims documented (facility_id, club_id, user_roles)
- [ ] All RLS helper functions documented
- [ ] Policy usage of helpers documented
- [ ] Claim -> Policy chain traced end-to-end
- [ ] Any mismatches flagged
</verification>

<success_criteria>
ISOL-04: JWT claims correctly map to data access patterns
Claim lifecycle: Documented from login to RLS evaluation
No mismatches: All policies use correct helper functions
</success_criteria>

<output>
After completion, create `.planning/phases/26-rbac-tenant-isolation/26-06-SUMMARY.md`
</output>
