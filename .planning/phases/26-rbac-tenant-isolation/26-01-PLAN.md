---
phase: 26-rbac-tenant-isolation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/26-rbac-tenant-isolation/26-01-RLS-AUDIT.md
autonomous: true

must_haves:
  truths:
    - "All tables with tenant data have RLS enabled"
    - "Tables with RLS enabled have appropriate policies defined"
    - "Gap between RLS enabled and policies defined is documented"
  artifacts:
    - path: ".planning/phases/26-rbac-tenant-isolation/26-01-RLS-AUDIT.md"
      provides: "Complete RLS status for all tables"
      contains: "| Table | RLS Enabled | Policies |"
  key_links:
    - from: "pg_tables.rowsecurity"
      to: "pg_policies"
      via: "SQL query"
      pattern: "SELECT.*rowsecurity.*FROM pg_tables"
---

<objective>
Audit RLS status for all database tables and document gaps.

Purpose: Establish baseline for ISOL-01 (all tables have RLS) and ISOL-02 (RLS filters by tenant) requirements. Identify which tables have RLS enabled but lack policies (blocking all access).

Output: Comprehensive audit document showing RLS status and policy gaps.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-rbac-tenant-isolation/26-RESEARCH.md
@prisma/schema.prisma
@supabase/migrations/00001_enable_rls.sql
@supabase/migrations/00002_rls_policies.sql
@supabase/migrations/00008_facility_rls_policies.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Query RLS Status</name>
  <files>.planning/phases/26-rbac-tenant-isolation/26-01-RLS-AUDIT.md</files>
  <action>
Run SQL queries against the Supabase database to capture RLS status:

1. Query all tables with RLS enabled status:
```sql
SELECT
  tablename,
  rowsecurity as rls_enabled
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY tablename;
```

2. Query all existing policies:
```sql
SELECT
  tablename,
  policyname,
  cmd,
  roles
FROM pg_policies
WHERE schemaname = 'public'
ORDER BY tablename, policyname;
```

3. Find tables with RLS enabled but NO policies:
```sql
SELECT t.tablename, t.rowsecurity
FROM pg_tables t
WHERE t.schemaname = 'public'
  AND t.rowsecurity = true
  AND NOT EXISTS (
    SELECT 1 FROM pg_policies p
    WHERE p.tablename = t.tablename
    AND p.schemaname = 'public'
  );
```

Use `npx supabase db query` or the Supabase Dashboard SQL Editor.
  </action>
  <verify>SQL queries execute without error and return results</verify>
  <done>RLS status for all tables captured</done>
</task>

<task type="auto">
  <name>Task 2: Create RLS Audit Document</name>
  <files>.planning/phases/26-rbac-tenant-isolation/26-01-RLS-AUDIT.md</files>
  <action>
Create a comprehensive audit document with:

1. **Summary table** of all tables:
   - Table name
   - RLS enabled (yes/no)
   - Policy count
   - Policy names (if any)
   - Status (OK / MISSING POLICIES / RLS DISABLED)

2. **Critical gaps** section listing tables with:
   - RLS enabled but no policies (blocks all access)
   - Sensitive data without any RLS

3. **Policy coverage by requirement**:
   - ISOL-01: List tables meeting/not meeting RLS enabled requirement
   - ISOL-02: List tables with proper tenant filtering policies

4. **Recommendations**:
   - Which tables need policies added
   - Which tables are OK with service role bypass
   - Priority order for remediation

Format as markdown table for easy review.
  </action>
  <verify>Audit document exists and contains all tables from schema</verify>
  <done>26-01-RLS-AUDIT.md contains complete RLS status for all tables with gap analysis</done>
</task>

</tasks>

<verification>
- [ ] All tables from prisma/schema.prisma are included in audit
- [ ] Tables with RLS enabled but no policies are clearly flagged
- [ ] Audit document is machine-parseable (markdown tables)
- [ ] Gap analysis maps to ISOL-01 and ISOL-02 requirements
</verification>

<success_criteria>
ISOL-01 status is determined: We know exactly which tables have RLS enabled
ISOL-02 status is determined: We know which policies filter by tenant
Critical gap list is documented: Tables that block all access are identified
</success_criteria>

<output>
After completion, create `.planning/phases/26-rbac-tenant-isolation/26-01-SUMMARY.md`
</output>
