---
phase: 27-secrets-logging-rate-limiting
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/audit/actions.ts
  - supabase/migrations/00009_audit_log_immutability.sql
  - src/lib/errors/index.ts
  - .planning/phases/27-secrets-logging-rate-limiting/27-02-SUMMARY.md
autonomous: true

must_haves:
  truths:
    - "AuditLog table has RLS enabled with INSERT-only policy"
    - "UPDATE and DELETE operations on AuditLog are blocked by trigger"
    - "PERMISSION_DENIED events are logged when forbiddenResponse is called"
    - "Auth event types (LOGIN_SUCCESS, LOGIN_FAILED, LOGOUT) exist in actions.ts"
  artifacts:
    - path: "src/lib/audit/actions.ts"
      provides: "Auth event action types"
      contains: "LOGIN_SUCCESS"
    - path: "supabase/migrations/00009_audit_log_immutability.sql"
      provides: "RLS + immutability trigger"
      contains: "audit_log_immutable"
    - path: "src/lib/errors/index.ts"
      provides: "forbiddenResponse with logging"
      contains: "logAuditEvent"
  key_links:
    - from: "src/lib/errors/index.ts"
      to: "src/lib/audit/logger.ts"
      via: "import logAuditEvent"
      pattern: "import.*logAuditEvent"
    - from: "supabase/migrations/00009_audit_log_immutability.sql"
      to: "AuditLog table"
      via: "ALTER TABLE"
      pattern: "ALTER TABLE.*AuditLog.*ROW LEVEL SECURITY"
---

<objective>
Extend audit logging infrastructure for auth events, permission denials, and immutability.

Purpose: AUDIT-01 through AUDIT-05 require comprehensive logging of security events. This plan adds missing action types, creates immutability constraints, and integrates logging into error responses.

Output:
- Extended audit actions with auth events (LOGIN_SUCCESS, LOGIN_FAILED, LOGOUT, etc.)
- Database migration for AuditLog RLS + immutability trigger
- Updated forbiddenResponse to log PERMISSION_DENIED events
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-secrets-logging-rate-limiting/27-RESEARCH.md

# Existing audit infrastructure
@src/lib/audit/actions.ts
@src/lib/audit/logger.ts
@src/lib/errors/index.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auth event types to audit actions</name>
  <files>src/lib/audit/actions.ts</files>
  <action>
Extend `AUDITABLE_ACTIONS` with auth event types:

```typescript
// Authentication events (Phase 27 - AUDIT-01)
LOGIN_SUCCESS: 'LOGIN_SUCCESS',           // User logged in successfully
LOGIN_FAILED: 'LOGIN_FAILED',             // Failed login attempt
LOGOUT: 'LOGOUT',                         // User logged out
PASSWORD_RESET_REQUESTED: 'PASSWORD_RESET_REQUESTED',  // Password reset email sent
PASSWORD_RESET_COMPLETED: 'PASSWORD_RESET_COMPLETED',  // Password successfully reset
SIGNUP_SUCCESS: 'SIGNUP_SUCCESS',         // New user registered
SIGNUP_FAILED: 'SIGNUP_FAILED',           // Registration failed (after rate limit)

// Permission events (Phase 27 - AUDIT-03)
PERMISSION_DENIED: 'PERMISSION_DENIED',   // 403 response logged
```

Also add corresponding entries to `AUDIT_ACTION_DESCRIPTIONS`:
- LOGIN_SUCCESS: 'User logged in successfully'
- LOGIN_FAILED: 'Failed login attempt'
- LOGOUT: 'User logged out'
- PASSWORD_RESET_REQUESTED: 'Password reset requested'
- PASSWORD_RESET_COMPLETED: 'Password reset completed'
- SIGNUP_SUCCESS: 'New user registered'
- SIGNUP_FAILED: 'User registration failed'
- PERMISSION_DENIED: 'Access denied to resource'

Place auth events after MFA operations section. Place PERMISSION_DENIED after permission grants section.
  </action>
  <verify>
- `grep -c "LOGIN_SUCCESS" src/lib/audit/actions.ts` returns 2 (const + description)
- `grep -c "PERMISSION_DENIED" src/lib/audit/actions.ts` returns 2
- `npx tsc --noEmit` passes (TypeScript compilation)
  </verify>
  <done>
- 8 new audit action types added
- Descriptions added for all new types
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AuditLog immutability migration</name>
  <files>supabase/migrations/00009_audit_log_immutability.sql</files>
  <action>
Create migration file `supabase/migrations/00009_audit_log_immutability.sql`:

```sql
-- Phase 27: AuditLog Immutability
-- Ensures audit logs cannot be modified or deleted after creation

-- Enable RLS on AuditLog table
ALTER TABLE "AuditLog" ENABLE ROW LEVEL SECURITY;

-- INSERT policy: Allow inserts from authenticated users
-- Note: Prisma uses service role which bypasses RLS, but this is defense-in-depth
CREATE POLICY "audit_log_insert" ON "AuditLog"
  FOR INSERT
  TO authenticated
  WITH CHECK (true);

-- SELECT policy: Only admins can view audit logs, scoped by club
CREATE POLICY "audit_log_select_admin" ON "AuditLog"
  FOR SELECT
  TO authenticated
  USING (
    "clubId" = public.get_current_club_id() AND
    (public.is_club_admin_or_higher() OR public.is_facility_admin())
  );

-- Self-view policy: Users can view their own actions
CREATE POLICY "audit_log_select_own" ON "AuditLog"
  FOR SELECT
  TO authenticated
  USING ("userId" = auth.uid()::text);

-- NO UPDATE policy = updates blocked by RLS
-- NO DELETE policy = deletes blocked by RLS

-- Trigger as defense-in-depth (catches service role modifications)
CREATE OR REPLACE FUNCTION prevent_audit_log_modification()
RETURNS TRIGGER AS $$
BEGIN
  RAISE EXCEPTION 'Audit logs are immutable and cannot be modified or deleted';
END;
$$ LANGUAGE plpgsql;

-- Create trigger BEFORE UPDATE OR DELETE
CREATE TRIGGER audit_log_immutable
BEFORE UPDATE OR DELETE ON "AuditLog"
FOR EACH ROW
EXECUTE FUNCTION prevent_audit_log_modification();

-- Add documentation comment
COMMENT ON TABLE "AuditLog" IS 'Immutable audit log. Retention: 365 days. RLS enabled.';
```

Note: The migration uses existing RLS helper functions (get_current_club_id, is_club_admin_or_higher, is_facility_admin) from previous migrations.
  </action>
  <verify>
- File exists: `ls supabase/migrations/00009_audit_log_immutability.sql`
- SQL syntax valid: `npx supabase db lint` or manual review
- Contains RLS enable, INSERT policy, SELECT policies, trigger
  </verify>
  <done>
- Migration file created with RLS + trigger
- Blocks UPDATE and DELETE via both RLS and trigger
- SELECT scoped to admins + self-view
  </done>
</task>

<task type="auto">
  <name>Task 3: Add PERMISSION_DENIED logging to forbiddenResponse</name>
  <files>src/lib/errors/index.ts</files>
  <action>
Modify `forbiddenResponse` to optionally log PERMISSION_DENIED events.

Add new function signature with audit context:

```typescript
import { logAuditEvent, type AuditContext } from '@/lib/audit/logger';

/**
 * Standard 403 Forbidden response with optional audit logging.
 * @param message - Optional custom message, defaults to 'Forbidden'
 * @param auditContext - Optional context for audit logging (clubId, userId required for logging)
 * @param targetInfo - Optional target info for audit log (targetType, targetId)
 */
export function forbiddenResponse(
  message?: string,
  auditContext?: Pick<AuditContext, 'clubId' | 'userId' | 'ipAddress'>,
  targetInfo?: { targetType: string; targetId?: string }
): NextResponse {
  // Log PERMISSION_DENIED if context provided
  if (auditContext?.clubId && auditContext?.userId) {
    logAuditEvent(
      {
        clubId: auditContext.clubId,
        userId: auditContext.userId,
        ipAddress: auditContext.ipAddress,
      },
      {
        action: 'PERMISSION_DENIED',
        targetType: targetInfo?.targetType || 'Unknown',
        targetId: targetInfo?.targetId,
        metadata: { message: message || 'Forbidden' },
      }
    ).catch((err) => {
      // Fire-and-forget, but log errors
      console.error('[audit] Failed to log PERMISSION_DENIED:', err);
    });
  }

  return NextResponse.json(
    { error: message || 'Forbidden' },
    { status: 403 }
  );
}
```

This maintains backward compatibility (auditContext is optional) while enabling logging when context is available.

Update import at top of file to include audit types.
  </action>
  <verify>
- `grep "PERMISSION_DENIED" src/lib/errors/index.ts` shows logging code
- `grep "logAuditEvent" src/lib/errors/index.ts` shows import and usage
- `npx tsc --noEmit` passes
- Existing callers still work (no required params added)
  </verify>
  <done>
- forbiddenResponse logs PERMISSION_DENIED when context provided
- Backward compatible (context optional)
- Fire-and-forget pattern for performance
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `npx tsc --noEmit` passes (TypeScript valid)
2. `grep -c "LOGIN_SUCCESS\|LOGIN_FAILED\|LOGOUT\|PERMISSION_DENIED" src/lib/audit/actions.ts` >= 4
3. `ls supabase/migrations/00009_audit_log_immutability.sql` exists
4. `grep "PERMISSION_DENIED" src/lib/errors/index.ts` shows logging
</verification>

<success_criteria>
- AUDIT-01 (partial): Auth event types defined (logging in Plan 03)
- AUDIT-03: PERMISSION_DENIED logging integrated into forbiddenResponse
- AUDIT-04: Existing AuditLog schema already includes user ID, timestamp, details
- AUDIT-05: Immutability enforced via RLS + trigger
</success_criteria>

<output>
After completion, create `.planning/phases/27-secrets-logging-rate-limiting/27-02-SUMMARY.md`
</output>
