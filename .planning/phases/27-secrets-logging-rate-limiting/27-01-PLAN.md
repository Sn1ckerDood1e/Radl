---
phase: 27-secrets-logging-rate-limiting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/check-bundle-secrets.sh
  - .github/workflows/security.yml
  - .planning/phases/27-secrets-logging-rate-limiting/27-01-SUMMARY.md
autonomous: true

must_haves:
  truths:
    - "No secrets appear in client-side JavaScript bundle after build"
    - "Service role key is only referenced in server-side code"
    - "All NEXT_PUBLIC_ variables contain only public data"
    - "No hardcoded credentials exist in source code"
  artifacts:
    - path: "scripts/check-bundle-secrets.sh"
      provides: "Bundle secrets scanner"
      min_lines: 20
    - path: ".github/workflows/security.yml"
      provides: "CI/CD secrets scanning"
      contains: "trufflehog"
  key_links:
    - from: ".github/workflows/security.yml"
      to: "scripts/check-bundle-secrets.sh"
      via: "workflow step"
      pattern: "check-bundle-secrets"
---

<objective>
Verify secrets management requirements through automated scanning and manual audit.

Purpose: SECR-01 through SECR-05 require proof that no secrets leak to client bundles or source code. This plan creates verification scripts and CI/CD automation.

Output:
- Bundle secrets scanner script
- GitHub Actions workflow with TruffleHog
- Environment variable audit document
- Verification results for all 5 SECR requirements
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-secrets-logging-rate-limiting/27-RESEARCH.md

# Relevant codebase files
@.env.example
@src/lib/supabase/admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bundle secrets scanner and CI workflow</name>
  <files>scripts/check-bundle-secrets.sh, .github/workflows/security.yml</files>
  <action>
1. Create `scripts/check-bundle-secrets.sh`:
   - Check for secret patterns in `.next/static/chunks/` directory
   - Patterns to detect: `service_role`, `sk_live`, `sk_test`, `DATABASE_URL`, `DIRECT_URL`, `RESEND_API_KEY`, `VAPID_PRIVATE`, `RC_CLIENT_SECRET`, `supabase_service`
   - Exit 0 if no secrets found, exit 1 with details if found
   - Make executable (chmod +x)

2. Create `.github/workflows/security.yml`:
   - Trigger on push to main/develop and pull requests
   - Job 1: TruffleHog secrets scan (trufflesecurity/trufflehog@main with fetch-depth: 0)
   - Job 2: Bundle check (npm ci, npm run build, run check-bundle-secrets.sh)
   - Use Ubuntu latest runner
  </action>
  <verify>
- `bash scripts/check-bundle-secrets.sh` runs without error (after `npm run build`)
- `.github/workflows/security.yml` has valid YAML syntax (use `yq` or online validator)
  </verify>
  <done>
- Bundle scanner script exists and is executable
- CI workflow file exists with TruffleHog and bundle check jobs
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify secrets requirements and create audit document</name>
  <files>.planning/phases/27-secrets-logging-rate-limiting/27-SECRETS-AUDIT.md</files>
  <action>
Perform manual verification of all SECR requirements:

**SECR-01: No secrets in client bundle**
- Run `npm run build`
- Run `scripts/check-bundle-secrets.sh`
- Search `.next/static/` for any env patterns
- Document result

**SECR-02: NEXT_PUBLIC_ properly scoped**
- List all NEXT_PUBLIC_ variables from `.env.example`
- Verify each is safe for client exposure:
  - NEXT_PUBLIC_SUPABASE_URL: Public API endpoint (safe)
  - NEXT_PUBLIC_SUPABASE_ANON_KEY: Anonymous key with RLS (safe)
  - NEXT_PUBLIC_APP_URL: Public URL (safe)
  - NEXT_PUBLIC_VAPID_PUBLIC_KEY: Public key for web-push (safe)
- Document result

**SECR-03: Service role not client-accessible**
- Search codebase for `SUPABASE_SERVICE_ROLE_KEY` usage
- Verify all usages are in server-only files (route.ts, server actions, lib/ server modules)
- Check it's NOT in any 'use client' files or passed to client components
- Document result

**SECR-04: API keys hashed in database**
- Check `src/lib/auth/api-key.ts` for SHA-256 hashing
- Verify ApiKey model stores `keyHash` not plaintext
- Document result

**SECR-05: No hardcoded credentials**
- Run TruffleHog locally: `npx trufflehog git file://. --results=verified,unknown`
- Review any findings
- Document result

Create `27-SECRETS-AUDIT.md` with:
- Summary table (requirement, status, evidence)
- Detailed findings for each requirement
- Any remediation notes (if issues found)
  </action>
  <verify>
- `27-SECRETS-AUDIT.md` exists with all 5 requirements documented
- Each requirement has PASS/FAIL status with evidence
  </verify>
  <done>
- All 5 SECR requirements verified
- Audit document created with evidence
- Any issues identified with remediation plan
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `scripts/check-bundle-secrets.sh` exists and runs successfully
2. `.github/workflows/security.yml` exists with valid syntax
3. `27-SECRETS-AUDIT.md` documents all 5 SECR requirements
4. No blocking issues found (or remediation plan documented)
</verification>

<success_criteria>
- SECR-01: Bundle scanner confirms no secrets in client chunks
- SECR-02: All 4 NEXT_PUBLIC_ variables verified as safe
- SECR-03: Service role key only in server-side code
- SECR-04: API keys use SHA-256 hashing
- SECR-05: TruffleHog scan clean (or issues documented with remediation)
</success_criteria>

<output>
After completion, create `.planning/phases/27-secrets-logging-rate-limiting/27-01-SUMMARY.md`
</output>
