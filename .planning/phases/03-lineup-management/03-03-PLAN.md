---
phase: 03-lineup-management
plan: 03
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - src/app/api/equipment-usage/route.ts
  - src/app/api/equipment/[id]/usage/route.ts
  - src/lib/equipment/usage-logger.ts
autonomous: true

must_haves:
  truths:
    - "Equipment usage log is auto-created when boat assigned to lineup"
    - "Usage logs can be queried by equipment or by date range"
    - "Usage log includes practice context (date, name)"
  artifacts:
    - path: "src/lib/equipment/usage-logger.ts"
      provides: "Helper function to create usage log entries"
      exports: ["createUsageLog", "deleteUsageLogForLineup"]
    - path: "src/app/api/equipment-usage/route.ts"
      provides: "GET for listing usage logs"
      exports: ["GET"]
    - path: "src/app/api/equipment/[id]/usage/route.ts"
      provides: "GET for equipment-specific usage history"
      exports: ["GET"]
  key_links:
    - from: "src/lib/equipment/usage-logger.ts"
      to: "prisma.equipmentUsageLog"
      via: "database create"
      pattern: "prisma\\.equipmentUsageLog\\.create"
    - from: "src/app/api/lineups/[id]/route.ts"
      to: "src/lib/equipment/usage-logger.ts"
      via: "function call on boat assignment"
      pattern: "createUsageLog"
---

<objective>
Implement automatic equipment usage logging when boats are assigned to lineups (EQUIP-01 requirement).

Purpose: Track boat usage for maintenance planning and historical records. Auto-generate logs so coaches don't have to manually track.
Output: Usage logs created automatically on lineup boat assignment, queryable via API.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-lineup-management/03-CONTEXT.md
@.planning/phases/03-lineup-management/03-01-SUMMARY.md (will exist after plan 01)

# Existing patterns
@src/lib/equipment/readiness.ts
@src/app/api/equipment/[id]/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usage logging helper functions</name>
  <files>src/lib/equipment/usage-logger.ts</files>
  <action>
Create src/lib/equipment/usage-logger.ts:

1. createUsageLog function:
   ```typescript
   async function createUsageLog({
     equipmentId,
     teamId,
     practiceId,
     lineupId,
     usageDate,
   }: {
     equipmentId: string;
     teamId: string;
     practiceId: string;
     lineupId: string;
     usageDate: Date;
   }): Promise<EquipmentUsageLog>
   ```
   - Check if log already exists for this equipment + practice (idempotent)
   - If exists, update the lineupId if different
   - If not exists, create new log entry
   - Return the log entry

2. deleteUsageLogForLineup function:
   ```typescript
   async function deleteUsageLogForLineup(lineupId: string): Promise<void>
   ```
   - Delete all usage logs associated with the lineup
   - Called when lineup is deleted or boat is unassigned

3. getUsageLogsForEquipment function:
   ```typescript
   async function getUsageLogsForEquipment(
     equipmentId: string,
     options?: { startDate?: Date; endDate?: Date; limit?: number }
   ): Promise<EquipmentUsageLog[]>
   ```
   - Return usage logs with practice details
   - Support date range filtering
   - Default limit of 50, ordered by usageDate desc

4. getUsageLogsForTeam function:
   ```typescript
   async function getUsageLogsForTeam(
     teamId: string,
     options?: { startDate?: Date; endDate?: Date; equipmentId?: string }
   ): Promise<EquipmentUsageLog[]>
   ```
   - Return usage logs for all team equipment
   - Include equipment name in response
   - Support filtering by specific equipment

Export all functions for use in API routes and lineup logic.
  </action>
  <verify>Run `npx tsc --noEmit` - should compile with no type errors</verify>
  <done>Usage logging helper functions created and exported</done>
</task>

<task type="auto">
  <name>Task 2: Integrate usage logging into lineup API</name>
  <files>src/app/api/lineups/route.ts, src/app/api/lineups/[id]/route.ts, src/app/api/practices/[id]/blocks/[blockId]/lineup/route.ts</files>
  <action>
Update lineup API endpoints to auto-create usage logs:

1. In src/app/api/lineups/route.ts POST handler:
   - After creating lineup with boatId, call createUsageLog()
   - Pass: equipmentId=boatId, teamId from claims, practiceId from block.practice, lineupId, usageDate from practice.date

2. In src/app/api/lineups/[id]/route.ts:
   - PATCH handler:
     - If boatId is being changed from null to value: create usage log
     - If boatId is being changed from value to null: delete usage log
     - If boatId is being changed to different boat: delete old log, create new log
   - DELETE handler:
     - Before deleting lineup, call deleteUsageLogForLineup(lineupId)

3. In src/app/api/practices/[id]/blocks/[blockId]/lineup/route.ts PUT handler:
   - If replacing a lineup that had a boat: delete old usage log
   - If new lineup has a boat: create new usage log

Important: Use Prisma transactions to ensure usage log changes are atomic with lineup changes.

Error handling:
- If usage log creation fails, don't fail the whole request (log warning)
- Usage logs are supplementary data, not critical path
  </action>
  <verify>
Manual test:
1. Create lineup with boat - verify usage log created
2. Update lineup to different boat - verify old log deleted, new log created
3. Update lineup to remove boat - verify log deleted
4. Delete lineup with boat - verify log deleted
  </verify>
  <done>Usage logs auto-created/deleted with lineup boat changes</done>
</task>

<task type="auto">
  <name>Task 3: Create usage log query API endpoints</name>
  <files>src/app/api/equipment-usage/route.ts, src/app/api/equipment/[id]/usage/route.ts</files>
  <action>
Create src/app/api/equipment-usage/route.ts:

1. GET handler for team usage logs:
   - Auth: require team member
   - Query params:
     - startDate: ISO string (optional)
     - endDate: ISO string (optional)
     - equipmentId: string (optional, filter to specific equipment)
   - Call getUsageLogsForTeam with team_id from claims
   - Return array of usage logs with equipment and practice details:
     ```json
     {
       "usageLogs": [
         {
           "id": "...",
           "equipment": { "id": "...", "name": "Varsity 8+", "boatClass": "EIGHT_8_PLUS" },
           "practice": { "id": "...", "name": "Tuesday AM", "date": "2026-01-21" },
           "usageDate": "2026-01-21T06:00:00Z"
         }
       ]
     }
     ```

Create src/app/api/equipment/[id]/usage/route.ts:

1. GET handler for equipment-specific usage:
   - Auth: require team member
   - Verify equipment belongs to team
   - Query params: startDate, endDate, limit (default 50)
   - Call getUsageLogsForEquipment
   - Return usage logs with practice details (not equipment - already known)
   - Include summary: total uses in period, last used date

This completes EQUIP-01: "Auto-generate usage logs from practice assignments"
  </action>
  <verify>
1. GET /api/equipment-usage returns logs for team
2. GET /api/equipment-usage?equipmentId=xxx filters correctly
3. GET /api/equipment/[id]/usage returns equipment-specific history
4. Date range filtering works correctly
  </verify>
  <done>Usage log query endpoints working with proper filtering</done>
</task>

</tasks>

<verification>
All checks must pass:
1. `npx tsc --noEmit` - TypeScript compiles
2. Creating lineup with boat creates usage log
3. Changing boat updates usage log correctly
4. Deleting lineup deletes associated usage log
5. GET endpoints return properly formatted data
6. Team scoping works (can't see other team's usage logs)
</verification>

<success_criteria>
- Usage log auto-created when boat assigned to lineup
- Usage log auto-deleted when boat unassigned or lineup deleted
- Usage logs queryable by equipment and by team
- Date range filtering works for historical analysis
- EQUIP-01 requirement complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-lineup-management/03-03-SUMMARY.md`
</output>
