---
phase: 03-lineup-management
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - src/app/api/lineups/route.ts
  - src/app/api/lineups/[id]/route.ts
  - src/app/api/practices/[id]/blocks/[blockId]/lineup/route.ts
autonomous: true

must_haves:
  truths:
    - "Coach can create a lineup for a water block"
    - "Coach can update lineup seat assignments"
    - "Coach can assign a boat to a lineup"
    - "System prevents duplicate athletes in same lineup"
  artifacts:
    - path: "src/app/api/lineups/route.ts"
      provides: "POST for creating lineups"
      exports: ["POST"]
    - path: "src/app/api/lineups/[id]/route.ts"
      provides: "GET, PATCH, DELETE for lineup management"
      exports: ["GET", "PATCH", "DELETE"]
    - path: "src/app/api/practices/[id]/blocks/[blockId]/lineup/route.ts"
      provides: "GET/PUT for block-specific lineup access"
      exports: ["GET", "PUT"]
  key_links:
    - from: "src/app/api/lineups/route.ts"
      to: "prisma.lineup.create"
      via: "database query"
      pattern: "prisma\\.lineup\\.create"
    - from: "src/app/api/lineups/[id]/route.ts"
      to: "prisma.seatAssignment"
      via: "nested update"
      pattern: "prisma\\.lineup\\.update"
---

<objective>
Create the lineup CRUD API endpoints for managing lineups on practice blocks, including seat assignment and boat assignment.

Purpose: The lineup editor UI needs API endpoints to persist lineup data. This enables coaches to save and modify lineup configurations.
Output: Complete lineup API with proper auth, validation, and team scoping.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-lineup-management/03-CONTEXT.md
@.planning/phases/03-lineup-management/03-01-SUMMARY.md (will exist after plan 01)

# Existing patterns
@src/app/api/practices/route.ts
@src/app/api/practices/[id]/route.ts
@src/lib/auth/authorize.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lineup CRUD API endpoints</name>
  <files>src/app/api/lineups/route.ts, src/app/api/lineups/[id]/route.ts</files>
  <action>
Create src/app/api/lineups/route.ts:

1. POST handler for creating a lineup:
   - Auth: getClaimsForApiRoute(), require COACH role
   - Validate body with createLineupSchema
   - Verify blockId exists and belongs to team (join through Practice)
   - Verify block.type === 'WATER' (lineups only for water blocks)
   - Verify block doesn't already have a lineup (one per block)
   - If boatId provided: verify boat exists, belongs to team, is SHELL type
   - Create lineup with nested seats using Prisma transaction
   - Return 201 with created lineup including seats

2. GET handler (optional, for listing):
   - Auth: require team member
   - Query params: practiceId (required)
   - Return all lineups for the practice with seats

Create src/app/api/lineups/[id]/route.ts:

1. GET handler:
   - Auth: require team member
   - Fetch lineup by id, verify team ownership via block.practice.teamId
   - Include: seats (with athlete.displayName), boat, block
   - Return lineup with full details

2. PATCH handler:
   - Auth: require COACH role
   - Validate body with updateLineupSchema
   - Verify lineup exists and belongs to team
   - If boatId changing: verify new boat exists, belongs to team, is SHELL type
   - If seats provided: delete all existing SeatAssignments, create new ones
   - Use Prisma transaction for atomic update
   - Return updated lineup

3. DELETE handler:
   - Auth: require COACH role
   - Verify lineup exists and belongs to team
   - Delete lineup (cascades to seats)
   - Return 204

Follow existing patterns from src/app/api/practices/[id]/route.ts:
- Use getClaimsForApiRoute() for auth
- Return proper error responses (401, 403, 404)
- Include relations in responses for complete data
  </action>
  <verify>
Create a test practice with water block, then:
- POST /api/lineups with valid data returns 201
- GET /api/lineups/[id] returns lineup with seats
- PATCH /api/lineups/[id] with new seats updates correctly
- DELETE /api/lineups/[id] returns 204
- Duplicate athlete in seats returns validation error
  </verify>
  <done>Lineup CRUD endpoints working with proper auth and validation</done>
</task>

<task type="auto">
  <name>Task 2: Create block-specific lineup endpoint</name>
  <files>src/app/api/practices/[id]/blocks/[blockId]/lineup/route.ts</files>
  <action>
Create src/app/api/practices/[id]/blocks/[blockId]/lineup/route.ts:

This provides a more intuitive API path for getting/setting a block's lineup.

1. GET handler:
   - Auth: require team member
   - Verify practice exists and belongs to team
   - Verify block exists and belongs to practice
   - Return block's lineup if exists (with seats, boat), or null if no lineup

2. PUT handler (create or replace):
   - Auth: require COACH role
   - Verify practice exists and belongs to team
   - Verify block exists and belongs to practice
   - Verify block.type === 'WATER'
   - If block has existing lineup: delete it
   - Create new lineup with provided data
   - This is a "replace" operation - simpler than partial updates
   - Return 200 with created lineup

This endpoint is used by the lineup editor to save changes. The editor builds
the complete lineup locally, then PUTs the whole thing.

Include proper error messages:
- 404 if practice not found
- 404 if block not found
- 400 if block is not WATER type
- 400 if validation fails
  </action>
  <verify>
For a water block:
- GET returns null when no lineup exists
- PUT creates lineup, GET returns it
- PUT again replaces the lineup
- PUT on a LAND block returns 400 error
  </verify>
  <done>Block-specific lineup endpoint working for lineup editor</done>
</task>

<task type="auto">
  <name>Task 3: Create land assignment API endpoint</name>
  <files>src/app/api/practices/[id]/blocks/[blockId]/assignments/route.ts</files>
  <action>
Create src/app/api/practices/[id]/blocks/[blockId]/assignments/route.ts:

For land/erg blocks, we use simpler group-based assignment (not seat positions).

1. GET handler:
   - Auth: require team member
   - Verify practice/block exist and belong to team
   - Return all LandAssignment records for block with athlete info

2. PUT handler (replace all assignments):
   - Auth: require COACH role
   - Verify practice/block exist and belong to team
   - Verify block.type is LAND or ERG (not WATER)
   - Validate body: { athleteIds: string[] }
   - Delete all existing LandAssignment for block
   - Create new LandAssignment for each athleteId
   - Use transaction for atomicity
   - Return 200 with count of assignments

This matches the replace-all pattern established for template blocks in Phase 2.

Error handling:
- 400 if block is WATER type (use lineup endpoint instead)
- 400 if athleteId doesn't exist or doesn't belong to team
  </action>
  <verify>
For a LAND block:
- GET returns empty array initially
- PUT with athleteIds creates assignments
- GET returns assigned athletes
- PUT with different athleteIds replaces assignments
- PUT on WATER block returns 400
  </verify>
  <done>Land/erg assignment endpoint working for group-based assignment</done>
</task>

</tasks>

<verification>
All checks must pass:
1. `npx tsc --noEmit` - TypeScript compiles
2. Lineup CRUD respects team scoping (can't access other team's lineups)
3. Role guards work (only coaches can create/update/delete)
4. Validation rejects invalid data (duplicate athletes, wrong block type)
5. Block-specific endpoint correctly handles create/replace pattern
6. Land assignment endpoint works for LAND/ERG blocks only
</verification>

<success_criteria>
- POST /api/lineups creates lineup with seats
- GET/PATCH/DELETE /api/lineups/[id] work correctly
- PUT /api/practices/[id]/blocks/[blockId]/lineup creates/replaces lineup
- PUT /api/practices/[id]/blocks/[blockId]/assignments handles land/erg blocks
- All endpoints follow established auth and error handling patterns
</success_criteria>

<output>
After completion, create `.planning/phases/03-lineup-management/03-02-SUMMARY.md`
</output>
