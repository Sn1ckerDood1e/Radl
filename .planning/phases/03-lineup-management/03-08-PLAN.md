---
phase: 03-lineup-management
plan: 08
type: execute
wave: 4
depends_on: [03-05, 03-06, 03-07]
files_modified:
  - src/app/(dashboard)/[teamSlug]/practices/[id]/practice-detail-client.tsx
  - src/app/(dashboard)/[teamSlug]/practices/[id]/page.tsx
  - src/app/(dashboard)/[teamSlug]/lineup-templates/page.tsx
  - src/app/(dashboard)/[teamSlug]/lineup-templates/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Lineup editor accessible from practice detail page"
    - "Coach can open lineup editor for each block"
    - "Lineup templates page lists team's saved templates"
    - "Template detail page shows and allows editing"
  artifacts:
    - path: "src/app/(dashboard)/[teamSlug]/practices/[id]/practice-detail-client.tsx"
      provides: "Updated practice detail with lineup editor integration"
      exports: ["PracticeDetailClient"]
    - path: "src/app/(dashboard)/[teamSlug]/lineup-templates/page.tsx"
      provides: "Lineup templates list page"
      exports: ["default"]
    - path: "src/app/(dashboard)/[teamSlug]/lineup-templates/[id]/page.tsx"
      provides: "Lineup template detail/edit page"
      exports: ["default"]
  key_links:
    - from: "practice-detail-client.tsx"
      to: "src/components/lineups/lineup-editor.tsx"
      via: "component composition"
      pattern: "LineupEditor"
    - from: "lineup-templates/page.tsx"
      to: "/api/lineup-templates"
      via: "fetch GET"
      pattern: "fetch.*lineup-templates"
---

<objective>
Integrate lineup editor into practice detail page and create lineup templates management UI.

Purpose: Coaches need to access lineup building from the practice flow, and need a place to manage saved lineup templates.
Output: Working integration with practice UI and standalone templates management pages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-lineup-management/03-CONTEXT.md
@.planning/phases/03-lineup-management/03-05-SUMMARY.md (water lineup builder)
@.planning/phases/03-lineup-management/03-06-SUMMARY.md (land lineup builder)
@.planning/phases/03-lineup-management/03-07-SUMMARY.md (lineup templates)

# Existing patterns
@src/app/(dashboard)/[teamSlug]/practices/[id]/practice-detail-client.tsx
@src/app/(dashboard)/[teamSlug]/practice-templates/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update practice detail page with lineup editor</name>
  <files>src/app/(dashboard)/[teamSlug]/practices/[id]/practice-detail-client.tsx, src/app/(dashboard)/[teamSlug]/practices/[id]/page.tsx</files>
  <action>
Update the practice detail page to include lineup editing for each block.

Update src/app/(dashboard)/[teamSlug]/practices/[id]/page.tsx:
1. Fetch additional data needed for lineup editor:
   - Team's athletes (eligible for current season)
   - Team's boats (SHELL type, with availability status)
   - Team's ERG count (for erg blocks)
2. Pass this data to PracticeDetailClient

Update src/app/(dashboard)/[teamSlug]/practices/[id]/practice-detail-client.tsx:

1. Add state for currently selected block for lineup editing:
   ```typescript
   const [editingLineupBlockId, setEditingLineupBlockId] = useState<string | null>(null);
   ```

2. For each block in the practice, add an "Edit Lineup" button (coaches only):
   - WATER blocks: show "Edit Lineup" or "Create Lineup" based on whether lineup exists
   - LAND/ERG blocks: show "Manage Assignments"

3. When "Edit Lineup" clicked, show the LineupEditor component:
   - Pass the block, athletes, boats
   - Pass onSaveWaterLineup that calls PUT /api/practices/[id]/blocks/[blockId]/lineup
   - Pass onSaveLandAssignments that calls PUT /api/practices/[id]/blocks/[blockId]/assignments
   - For water blocks: also pass lineup templates picker and save-as-template button

4. Show lineup preview in view mode:
   - For WATER blocks with lineup: show boat name and seat count (e.g., "Varsity 8+ - 8 athletes")
   - For LAND/ERG blocks with assignments: show athlete count

5. Layout:
   - Block list on left (existing)
   - When block selected for lineup editing, show LineupEditor below or in a slide-out panel

6. Add "Quick-fill" button that shows LineupTemplatePicker

7. Add "Save as Template" button when lineup has assigned athletes

Data fetching approach:
- Athletes: fetch /api/athletes with eligibility filter
- Boats: fetch /api/equipment?type=SHELL with availability computed
- Use useMemo to compute boat availability from damage reports and manualUnavailable
  </action>
  <verify>
- Practice detail page loads with block list
- Each block shows Edit Lineup / Manage Assignments button
- Clicking opens LineupEditor
- Saving lineup persists via API
- Lineup preview shows in view mode
  </verify>
  <done>Practice detail page integrated with lineup editor</done>
</task>

<task type="auto">
  <name>Task 2: Create lineup templates list page</name>
  <files>src/app/(dashboard)/[teamSlug]/lineup-templates/page.tsx</files>
  <action>
Create src/app/(dashboard)/[teamSlug]/lineup-templates/page.tsx:

Follow the pattern from practice-templates/page.tsx:

```typescript
import { prisma } from '@/lib/prisma';
import { createServerClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import Link from 'next/link';
import { Plus } from 'lucide-react';

interface PageProps {
  params: Promise<{ teamSlug: string }>;
}

export default async function LineupTemplatesPage({ params }: PageProps) {
  const { teamSlug } = await params;
  const supabase = await createServerClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) redirect('/');

  // Get team by slug
  const team = await prisma.team.findUnique({
    where: { slug: teamSlug },
    include: {
      members: {
        where: { userId: user.id },
      },
    },
  });

  if (!team || team.members.length === 0) redirect('/');

  const isCoach = team.members[0].role === 'COACH';

  // Fetch lineup templates
  const templates = await prisma.lineupTemplate.findMany({
    where: { teamId: team.id },
    include: {
      _count: { select: { seats: true } },
      defaultBoat: { select: { name: true } },
    },
    orderBy: { name: 'asc' },
  });

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold text-zinc-100">Lineup Templates</h1>
        {isCoach && (
          <Link
            href={`/${teamSlug}/lineup-templates/new`}
            className="flex items-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-white font-medium transition-colors"
          >
            <Plus className="h-5 w-5" />
            New Template
          </Link>
        )}
      </div>

      {templates.length > 0 ? (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {templates.map(template => (
            <Link
              key={template.id}
              href={`/${teamSlug}/lineup-templates/${template.id}`}
              className="p-4 bg-zinc-900 border border-zinc-800 rounded-lg hover:border-zinc-700 transition-colors"
            >
              <h3 className="font-medium text-zinc-200">{template.name}</h3>
              <p className="text-sm text-zinc-500 mt-1">
                {template.boatClass.replace(/_/g, ' ')} - {template._count.seats} seats
              </p>
              {template.defaultBoat && (
                <p className="text-sm text-zinc-600 mt-1">
                  Default boat: {template.defaultBoat.name}
                </p>
              )}
            </Link>
          ))}
        </div>
      ) : (
        <div className="text-center py-12 bg-zinc-900 border border-zinc-800 rounded-lg">
          <p className="text-zinc-400">No lineup templates yet</p>
          <p className="text-zinc-500 text-sm mt-1">
            Save a lineup from the practice editor to create a template
          </p>
        </div>
      )}
    </div>
  );
}
```

This mirrors the practice-templates list page pattern.
  </action>
  <verify>
- Page loads at /[teamSlug]/lineup-templates
- Templates list renders
- New Template link visible for coaches
- Empty state shows when no templates
  </verify>
  <done>Lineup templates list page created</done>
</task>

<task type="auto">
  <name>Task 3: Create lineup template detail page</name>
  <files>src/app/(dashboard)/[teamSlug]/lineup-templates/[id]/page.tsx</files>
  <action>
Create src/app/(dashboard)/[teamSlug]/lineup-templates/[id]/page.tsx:

```typescript
import { prisma } from '@/lib/prisma';
import { createServerClient } from '@/lib/supabase/server';
import { redirect, notFound } from 'next/navigation';
import { LineupTemplateDetailClient } from './lineup-template-detail-client';

interface PageProps {
  params: Promise<{ teamSlug: string; id: string }>;
}

export default async function LineupTemplateDetailPage({ params }: PageProps) {
  const { teamSlug, id } = await params;
  const supabase = await createServerClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) redirect('/');

  // Get team and verify membership
  const team = await prisma.team.findUnique({
    where: { slug: teamSlug },
    include: {
      members: {
        where: { userId: user.id },
        include: { athleteProfile: true },
      },
    },
  });

  if (!team || team.members.length === 0) redirect('/');

  const isCoach = team.members[0].role === 'COACH';

  // Fetch template with seats and athletes
  const template = await prisma.lineupTemplate.findUnique({
    where: { id, teamId: team.id },
    include: {
      seats: {
        include: {
          athlete: { select: { id: true, displayName: true, sidePreference: true } },
        },
        orderBy: { position: 'asc' },
      },
      defaultBoat: { select: { id: true, name: true, boatClass: true } },
    },
  });

  if (!template) notFound();

  // Fetch team athletes for editing
  const athletes = await prisma.athleteProfile.findMany({
    where: {
      teamMember: { teamId: team.id },
    },
    select: { id: true, displayName: true, sidePreference: true },
    orderBy: { displayName: 'asc' },
  });

  // Fetch boats matching boat class
  const boats = await prisma.equipment.findMany({
    where: {
      teamId: team.id,
      type: 'SHELL',
      boatClass: template.boatClass,
      status: 'ACTIVE',
    },
    select: { id: true, name: true, boatClass: true },
  });

  return (
    <LineupTemplateDetailClient
      template={template}
      athletes={athletes}
      boats={boats}
      isCoach={isCoach}
      teamSlug={teamSlug}
    />
  );
}
```

Create src/app/(dashboard)/[teamSlug]/lineup-templates/[id]/lineup-template-detail-client.tsx:

```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { BoatClass, Side } from '@/generated/prisma';
import { ArrowLeft, Pencil, Trash2 } from 'lucide-react';
import Link from 'next/link';
import { getSeatsForBoatClass } from '@/lib/lineup/position-labels';

interface Athlete {
  id: string;
  displayName: string | null;
  sidePreference?: Side | null;
}

interface Seat {
  position: number;
  side: Side;
  athlete: Athlete | null;
}

interface Template {
  id: string;
  name: string;
  boatClass: BoatClass;
  seats: Array<{
    position: number;
    side: Side;
    athlete: Athlete | null;
  }>;
  defaultBoat: { id: string; name: string; boatClass: BoatClass | null } | null;
}

interface Props {
  template: Template;
  athletes: Athlete[];
  boats: Array<{ id: string; name: string; boatClass: BoatClass | null }>;
  isCoach: boolean;
  teamSlug: string;
}

export function LineupTemplateDetailClient({
  template,
  athletes,
  boats,
  isCoach,
  teamSlug,
}: Props) {
  const router = useRouter();
  const [isEditing, setIsEditing] = useState(false);
  const [isDeleting, setIsDeleting] = useState(false);
  const [name, setName] = useState(template.name);
  const [selectedBoatId, setSelectedBoatId] = useState(template.defaultBoat?.id || '');
  const [seats, setSeats] = useState(template.seats);

  // Get seat template for this boat class
  const seatTemplate = getSeatsForBoatClass(template.boatClass);

  async function handleSave() {
    const response = await fetch(`/api/lineup-templates/${template.id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name,
        defaultBoatId: selectedBoatId || null,
        seats: seats.map(s => ({
          position: s.position,
          side: s.side,
          athleteId: s.athlete?.id || null,
        })),
      }),
    });

    if (response.ok) {
      router.refresh();
      setIsEditing(false);
    }
  }

  async function handleDelete() {
    if (!confirm('Delete this template?')) return;
    setIsDeleting(true);

    const response = await fetch(`/api/lineup-templates/${template.id}`, {
      method: 'DELETE',
    });

    if (response.ok) {
      router.push(`/${teamSlug}/lineup-templates`);
    } else {
      setIsDeleting(false);
    }
  }

  function updateSeatAthlete(position: number, athleteId: string | null) {
    setSeats(prev =>
      prev.map(s =>
        s.position === position
          ? { ...s, athlete: athleteId ? athletes.find(a => a.id === athleteId) || null : null }
          : s
      )
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <Link
            href={`/${teamSlug}/lineup-templates`}
            className="p-2 text-zinc-400 hover:text-zinc-300 transition-colors"
          >
            <ArrowLeft className="h-5 w-5" />
          </Link>
          {isEditing ? (
            <input
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              className="text-2xl font-bold bg-transparent border-b border-zinc-600 focus:border-zinc-400 outline-none text-zinc-100"
            />
          ) : (
            <h1 className="text-2xl font-bold text-zinc-100">{template.name}</h1>
          )}
        </div>

        {isCoach && (
          <div className="flex gap-2">
            {isEditing ? (
              <>
                <button
                  onClick={() => setIsEditing(false)}
                  className="px-4 py-2 text-zinc-400 hover:text-zinc-300 transition-colors"
                >
                  Cancel
                </button>
                <button
                  onClick={handleSave}
                  className="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-white transition-colors"
                >
                  Save
                </button>
              </>
            ) : (
              <>
                <button
                  onClick={() => setIsEditing(true)}
                  className="flex items-center gap-2 px-4 py-2 text-zinc-400 hover:text-zinc-300 transition-colors"
                >
                  <Pencil className="h-4 w-4" />
                  Edit
                </button>
                <button
                  onClick={handleDelete}
                  disabled={isDeleting}
                  className="flex items-center gap-2 px-4 py-2 text-red-400 hover:text-red-300 transition-colors disabled:opacity-50"
                >
                  <Trash2 className="h-4 w-4" />
                  Delete
                </button>
              </>
            )}
          </div>
        )}
      </div>

      {/* Boat class and default boat */}
      <div className="bg-zinc-900 border border-zinc-800 rounded-lg p-4">
        <p className="text-sm text-zinc-500">Boat Class</p>
        <p className="text-zinc-200">{template.boatClass.replace(/_/g, ' ')}</p>

        <div className="mt-4">
          <p className="text-sm text-zinc-500 mb-1">Default Boat</p>
          {isEditing ? (
            <select
              value={selectedBoatId}
              onChange={(e) => setSelectedBoatId(e.target.value)}
              className="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-sm"
            >
              <option value="">No default boat</option>
              {boats.map(b => (
                <option key={b.id} value={b.id}>{b.name}</option>
              ))}
            </select>
          ) : (
            <p className="text-zinc-200">
              {template.defaultBoat?.name || 'None'}
            </p>
          )}
        </div>
      </div>

      {/* Seat assignments */}
      <div className="bg-zinc-900 border border-zinc-800 rounded-lg p-4">
        <h3 className="font-medium text-zinc-200 mb-4">Default Athletes</h3>

        <div className="space-y-2">
          {seatTemplate.map(seat => {
            const templateSeat = seats.find(s => s.position === seat.position);
            const athlete = templateSeat?.athlete;

            return (
              <div
                key={seat.position}
                className="flex items-center gap-4 p-2 bg-zinc-800/50 rounded"
              >
                <div className="w-16 text-sm text-zinc-400">
                  {seat.label}
                  {seat.side !== 'NONE' && (
                    <span className={`ml-1 text-xs ${seat.side === 'PORT' ? 'text-blue-400' : 'text-green-400'}`}>
                      ({seat.side[0]})
                    </span>
                  )}
                </div>

                {isEditing ? (
                  <select
                    value={athlete?.id || ''}
                    onChange={(e) => updateSeatAthlete(seat.position, e.target.value || null)}
                    className="flex-1 px-2 py-1 bg-zinc-700 border border-zinc-600 rounded text-sm"
                  >
                    <option value="">Unassigned</option>
                    {athletes.map(a => (
                      <option key={a.id} value={a.id}>
                        {a.displayName || 'Unnamed'}
                      </option>
                    ))}
                  </select>
                ) : (
                  <span className="flex-1 text-sm text-zinc-300">
                    {athlete?.displayName || <span className="text-zinc-600">Unassigned</span>}
                  </span>
                )}
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
}
```

Export the client component.
  </action>
  <verify>
- Detail page loads at /[teamSlug]/lineup-templates/[id]
- View mode shows template name, boat class, default boat, seats
- Edit mode allows changing name, boat, athletes
- Save persists changes
- Delete removes template
  </verify>
  <done>Lineup template detail page with view/edit modes created</done>
</task>

</tasks>

<verification>
All checks must pass:
1. `npx tsc --noEmit` - TypeScript compiles
2. Practice detail page shows lineup editor for blocks
3. Saving lineup from practice persists via API
4. Templates list page shows team's templates
5. Template detail page shows and edits template
6. Delete template works
7. Navigation between pages works
</verification>

<success_criteria>
- Lineup editor accessible from practice detail
- Each block shows appropriate edit button
- Lineup preview shows in view mode
- Templates list page works
- Template detail page with view/edit/delete
- All coach-only actions gated properly
- All pages integrate with existing UI patterns
</success_criteria>

<output>
After completion, create `.planning/phases/03-lineup-management/03-08-SUMMARY.md`
</output>
