---
phase: 20-public-issue-reporting
plan: 05
type: execute
wave: 3
depends_on: [20-02, 20-03]
files_modified:
  - src/app/api/qr-export/route.ts
  - src/components/equipment/qr-bulk-export.tsx
  - src/app/(dashboard)/[teamSlug]/equipment/page.tsx
autonomous: true

must_haves:
  truths:
    - "Coach can export all equipment QR codes as PDF"
    - "PDF has multiple QR codes per page in grid layout"
    - "Each QR code has equipment name label"
    - "Export button visible only to coaches on equipment list page"
    - "PDF downloads automatically when generated"
  artifacts:
    - path: "src/app/api/qr-export/route.ts"
      provides: "API endpoint generating PDF with all equipment QR codes"
      exports: ["GET"]
    - path: "src/components/equipment/qr-bulk-export.tsx"
      provides: "Button component triggering bulk QR export"
      exports: ["QRBulkExportButton"]
  key_links:
    - from: "src/components/equipment/qr-bulk-export.tsx"
      to: "/api/qr-export"
      via: "fetch GET request"
      pattern: "fetch.*qr-export"
    - from: "src/app/api/qr-export/route.ts"
      to: "jspdf"
      via: "PDF generation library"
      pattern: "jsPDF"
---

<objective>
Create bulk QR code export functionality to generate a printable PDF containing QR codes for all team equipment.

Purpose: Enable coaches to print QR stickers for their entire fleet at once, rather than downloading individual PNGs. The PDF format is optimized for label sheets or standard printing.
Output: API endpoint generating QR code PDF, UI button on equipment list page for coaches.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-public-issue-reporting/20-CONTEXT.md
@.planning/phases/20-public-issue-reporting/20-RESEARCH.md
@.planning/phases/20-public-issue-reporting/20-01-SUMMARY.md
@src/app/(dashboard)/[teamSlug]/equipment/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create QR export API endpoint</name>
  <files>src/app/api/qr-export/route.ts</files>
  <action>
Create an API endpoint that generates a PDF containing QR codes for all team equipment:

```typescript
// src/app/api/qr-export/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { jsPDF } from 'jspdf';
import { prisma } from '@/lib/prisma';
import { createClient } from '@/lib/supabase/server';

// QR code generation using a simple QR library approach
// We'll use a data URL approach since jsPDF works well with images

export async function GET(request: NextRequest) {
  try {
    // Authenticate user
    const supabase = await createClient();
    const { data: { user }, error: authError } = await supabase.auth.getUser();

    if (authError || !user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    // Get teamId from query params
    const teamId = request.nextUrl.searchParams.get('teamId');
    if (!teamId) {
      return NextResponse.json({ error: 'teamId required' }, { status: 400 });
    }

    // Verify user is a coach on this team
    const membership = await prisma.teamMember.findUnique({
      where: { teamId_userId: { teamId, userId: user.id } },
      select: { role: true },
    });

    if (!membership || membership.role !== 'COACH') {
      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
    }

    // Get team name and all equipment
    const team = await prisma.team.findUnique({
      where: { id: teamId },
      select: { name: true },
    });

    const equipment = await prisma.equipment.findMany({
      where: { teamId },
      select: { id: true, name: true, type: true },
      orderBy: [{ type: 'asc' }, { name: 'asc' }],
    });

    if (equipment.length === 0) {
      return NextResponse.json({ error: 'No equipment found' }, { status: 404 });
    }

    // Create PDF
    const pdf = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: 'letter', // 8.5 x 11 inches
    });

    const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://rowops.app';

    // Layout: 3 columns x 4 rows = 12 QR codes per page
    const cols = 3;
    const rows = 4;
    const qrSize = 50; // mm
    const marginX = 15; // mm from edge
    const marginY = 20; // mm from top
    const gapX = (215.9 - 2 * marginX - cols * qrSize) / (cols - 1); // Letter width is 215.9mm
    const gapY = 12; // mm between rows
    const labelHeight = 8; // mm for equipment name

    // Add title to first page
    pdf.setFontSize(16);
    pdf.setFont('helvetica', 'bold');
    pdf.text(`${team?.name || 'Team'} - Equipment QR Codes`, marginX, 12);
    pdf.setFontSize(10);
    pdf.setFont('helvetica', 'normal');
    pdf.text(`Generated: ${new Date().toLocaleDateString()}`, marginX, 17);

    let currentPage = 0;
    let itemIndex = 0;

    for (const item of equipment) {
      const pageIndex = Math.floor(itemIndex / (cols * rows));
      const positionOnPage = itemIndex % (cols * rows);
      const col = positionOnPage % cols;
      const row = Math.floor(positionOnPage / cols);

      // Add new page if needed
      if (pageIndex > currentPage) {
        pdf.addPage();
        currentPage = pageIndex;
      }

      const x = marginX + col * (qrSize + gapX);
      const y = marginY + row * (qrSize + labelHeight + gapY);

      // Generate QR code as SVG string (using simple encoding)
      const reportUrl = `${baseUrl}/report/${item.id}`;

      // Draw placeholder box for QR code (actual QR would need qrcode library on server)
      // For now, we'll use a text-based approach with the URL
      pdf.setDrawColor(0);
      pdf.setLineWidth(0.5);
      pdf.rect(x, y, qrSize, qrSize);

      // Add QR code URL as tiny text (temporary - will be replaced with actual QR)
      pdf.setFontSize(6);
      pdf.text(reportUrl, x + 2, y + qrSize / 2, { maxWidth: qrSize - 4 });

      // Equipment name label below QR
      pdf.setFontSize(9);
      pdf.setFont('helvetica', 'bold');
      const nameLines = pdf.splitTextToSize(item.name, qrSize);
      pdf.text(nameLines[0], x + qrSize / 2, y + qrSize + 5, { align: 'center' });

      itemIndex++;
    }

    // Get PDF as buffer
    const pdfBuffer = Buffer.from(pdf.output('arraybuffer'));

    // Return PDF
    const fileName = `${team?.name?.toLowerCase().replace(/\s+/g, '-') || 'team'}-qr-codes.pdf`;

    return new NextResponse(pdfBuffer, {
      status: 200,
      headers: {
        'Content-Type': 'application/pdf',
        'Content-Disposition': `attachment; filename="${fileName}"`,
      },
    });
  } catch (error) {
    console.error('QR export error:', error);
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
  }
}
```

Note: This initial version creates placeholder boxes with URLs. For production QR codes, we need to either:
1. Install `qrcode` package and generate QR as data URLs server-side
2. Use a client-side approach where we generate QR SVGs and convert to PDF

For now, the structure and layout are correct. We'll enhance with actual QR codes.
  </action>
  <verify>GET `/api/qr-export?teamId={id}` returns PDF; PDF has correct layout with equipment names</verify>
  <done>API endpoint creates PDF with placeholder QR code layout for all team equipment</done>
</task>

<task type="auto">
  <name>Task 2: Add server-side QR code generation</name>
  <files>src/app/api/qr-export/route.ts</files>
  <action>
Install qrcode package for server-side QR generation and update the API:

1. Install dependency:
```bash
npm install qrcode
npm install -D @types/qrcode
```

2. Update the API to generate actual QR codes:

```typescript
import QRCode from 'qrcode';

// Inside the loop, replace the placeholder with actual QR:
const reportUrl = `${baseUrl}/report/${item.id}`;

// Generate QR code as data URL
const qrDataUrl = await QRCode.toDataURL(reportUrl, {
  width: qrSize * 10, // Higher resolution for print
  margin: 1,
  errorCorrectionLevel: 'M',
});

// Add QR code image to PDF
pdf.addImage(qrDataUrl, 'PNG', x, y, qrSize, qrSize);
```

The full updated loop should be:
```typescript
for (const item of equipment) {
  const pageIndex = Math.floor(itemIndex / (cols * rows));
  const positionOnPage = itemIndex % (cols * rows);
  const col = positionOnPage % cols;
  const row = Math.floor(positionOnPage / cols);

  // Add new page if needed
  if (pageIndex > currentPage) {
    pdf.addPage();
    currentPage = pageIndex;
  }

  const x = marginX + col * (qrSize + gapX);
  const y = marginY + row * (qrSize + labelHeight + gapY);

  // Generate QR code
  const reportUrl = `${baseUrl}/report/${item.id}`;
  const qrDataUrl = await QRCode.toDataURL(reportUrl, {
    width: 500, // High resolution for print quality
    margin: 1,
    errorCorrectionLevel: 'M',
  });

  // Add QR code to PDF
  pdf.addImage(qrDataUrl, 'PNG', x, y, qrSize, qrSize);

  // Equipment name label below QR
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'bold');
  const truncatedName = item.name.length > 20 ? item.name.substring(0, 18) + '...' : item.name;
  pdf.text(truncatedName, x + qrSize / 2, y + qrSize + 5, { align: 'center' });

  itemIndex++;
}
```
  </action>
  <verify>PDF contains actual scannable QR codes, not placeholders</verify>
  <done>QR codes in PDF are scannable and link to correct report URLs</done>
</task>

<task type="auto">
  <name>Task 3: Create bulk export button component</name>
  <files>src/components/equipment/qr-bulk-export.tsx</files>
  <action>
Create a button component that triggers the bulk QR export:

```typescript
// src/components/equipment/qr-bulk-export.tsx
'use client';

import { useState } from 'react';
import { showErrorToast, showSuccessToast } from '@/lib/toast-helpers';

interface QRBulkExportButtonProps {
  teamId: string;
  equipmentCount: number;
}

export function QRBulkExportButton({ teamId, equipmentCount }: QRBulkExportButtonProps) {
  const [isExporting, setIsExporting] = useState(false);

  const handleExport = async () => {
    if (equipmentCount === 0) {
      showErrorToast({ message: 'No equipment to export' });
      return;
    }

    setIsExporting(true);

    try {
      const response = await fetch(`/api/qr-export?teamId=${teamId}`);

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Export failed');
      }

      // Get the PDF blob
      const blob = await response.blob();

      // Create download link
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;

      // Extract filename from Content-Disposition header or use default
      const disposition = response.headers.get('Content-Disposition');
      const filenameMatch = disposition?.match(/filename="(.+)"/);
      link.download = filenameMatch?.[1] || 'qr-codes.pdf';

      link.click();
      URL.revokeObjectURL(url);

      showSuccessToast(`Exported ${equipmentCount} QR codes`);
    } catch (error) {
      showErrorToast({
        message: 'Failed to export QR codes',
        description: error instanceof Error ? error.message : undefined,
      });
    } finally {
      setIsExporting(false);
    }
  };

  return (
    <button
      type="button"
      onClick={handleExport}
      disabled={isExporting || equipmentCount === 0}
      className="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-emerald-600 rounded-lg hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed"
    >
      {isExporting ? (
        <>
          <svg className="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
          </svg>
          Generating PDF...
        </>
      ) : (
        <>
          <svg className="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
          </svg>
          Export All QR Codes
        </>
      )}
    </button>
  );
}
```

The button:
- Shows loading spinner during export
- Downloads PDF automatically
- Shows toast on success/failure
- Disabled when no equipment
- Uses emerald color to match app theme
  </action>
  <verify>Button renders; clicking triggers download; loading state shows during generation</verify>
  <done>QRBulkExportButton component triggers PDF download with loading state</done>
</task>

<task type="auto">
  <name>Task 4: Add export button to equipment list page</name>
  <files>src/app/(dashboard)/[teamSlug]/equipment/page.tsx</files>
  <action>
Add the QRBulkExportButton to the equipment list page header, visible only to coaches:

1. Import the component at the top:
```typescript
import { QRBulkExportButton } from '@/components/equipment/qr-bulk-export';
```

2. Add the button in the page header area, next to existing action buttons:

Look for the existing header section (likely contains "Add Equipment" button) and add:
```tsx
{isCoach && (
  <div className="flex items-center gap-3">
    <QRBulkExportButton teamId={team.id} equipmentCount={equipment.length} />
    {/* Existing Add Equipment button */}
  </div>
)}
```

The button should be positioned alongside other coach actions (like Add Equipment).

If there's no coach check wrapper, add one. The page should pass isCoach to determine visibility.
  </action>
  <verify>Equipment list page shows "Export All QR Codes" button for coaches; button not visible to athletes</verify>
  <done>Equipment list page has bulk export button visible to coaches</done>
</task>

</tasks>

<verification>
1. Navigate to `/[teamSlug]/equipment` as coach - "Export All QR Codes" button visible
2. Navigate as athlete - button NOT visible
3. Click export button - loading spinner shows
4. PDF downloads automatically
5. Open PDF - multiple pages with 12 QR codes each in grid layout
6. Scan QR code from PDF - navigates to correct report page
7. Each QR has equipment name label below
</verification>

<success_criteria>
- qrcode package installed and typed
- API generates multi-page PDF with 12 QR codes per page
- Each QR code scannable and links to /report/[equipmentId]
- Equipment names appear below each QR code
- Export button shows loading state during generation
- PDF filename includes team name
- Button only visible to coaches
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/20-public-issue-reporting/20-05-SUMMARY.md`
</output>
