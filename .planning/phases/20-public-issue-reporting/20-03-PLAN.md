---
phase: 20-public-issue-reporting
plan: 03
type: execute
wave: 2
depends_on: [20-01]
files_modified:
  - src/app/api/equipment/[id]/damage-reports/route.ts
  - src/lib/email/client.ts
  - src/lib/email/templates/critical-alert.ts
autonomous: true

must_haves:
  truths:
    - "API accepts severity, category, and reporterName fields"
    - "API silently rejects honeypot-filled submissions"
    - "In-app notifications always created for damage reports"
    - "Email sent to coaches only for CRITICAL severity issues"
    - "Email gracefully degrades if RESEND_API_KEY not configured"
  artifacts:
    - path: "src/app/api/equipment/[id]/damage-reports/route.ts"
      provides: "Extended API with severity-based notifications"
      min_lines: 130
    - path: "src/lib/email/client.ts"
      provides: "Resend email client with graceful fallback"
      exports: ["sendEmail"]
    - path: "src/lib/email/templates/critical-alert.ts"
      provides: "Critical damage alert email template"
      exports: ["sendCriticalDamageAlert"]
  key_links:
    - from: "src/app/api/equipment/[id]/damage-reports/route.ts"
      to: "src/lib/email/templates/critical-alert.ts"
      via: "conditional import for critical severity"
      pattern: "severity === 'CRITICAL'"
    - from: "src/lib/email/templates/critical-alert.ts"
      to: "src/lib/email/client.ts"
      via: "sendEmail import"
      pattern: "sendEmail"
---

<objective>
Extend the damage report API with severity-based notification routing and email alerts for critical issues.

Purpose: Complete the backend for enhanced issue reporting - honeypot validation, storing new fields, in-app notifications for all reports, and email notifications for critical severity issues only.
Output: Extended API route handling all new fields, email infrastructure with Resend, critical alert email template.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-public-issue-reporting/20-CONTEXT.md
@.planning/phases/20-public-issue-reporting/20-RESEARCH.md
@.planning/phases/20-public-issue-reporting/20-01-SUMMARY.md
@src/app/api/equipment/[id]/damage-reports/route.ts
@src/lib/rate-limit/index.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email client with Resend</name>
  <files>src/lib/email/client.ts</files>
  <action>
Create the email client directory and file:

```typescript
// src/lib/email/client.ts
import { Resend } from 'resend';

// Singleton Resend client - created lazily when API key available
let resendClient: Resend | null = null;

function getResendClient(): Resend | null {
  if (resendClient) return resendClient;

  const apiKey = process.env.RESEND_API_KEY;
  if (!apiKey) {
    console.warn('Email disabled: RESEND_API_KEY not set');
    return null;
  }

  resendClient = new Resend(apiKey);
  return resendClient;
}

export interface EmailOptions {
  to: string | string[];
  subject: string;
  html: string;
  replyTo?: string;
}

/**
 * Send an email via Resend
 * Returns success: true if sent, success: false if disabled or failed
 * Gracefully degrades when API key not configured
 */
export async function sendEmail(options: EmailOptions): Promise<{ success: boolean; error?: string }> {
  const client = getResendClient();

  if (!client) {
    return { success: false, error: 'Email not configured' };
  }

  try {
    // Use onboarding domain for now, switch to custom domain in production
    const fromAddress = process.env.RESEND_FROM_ADDRESS || 'RowOps <onboarding@resend.dev>';

    const { error } = await client.emails.send({
      from: fromAddress,
      to: options.to,
      subject: options.subject,
      html: options.html,
      replyTo: options.replyTo,
    });

    if (error) {
      console.error('Resend error:', error);
      return { success: false, error: error.message };
    }

    return { success: true };
  } catch (err) {
    console.error('Email send error:', err);
    return { success: false, error: err instanceof Error ? err.message : 'Unknown error' };
  }
}
```

Create the directory first: `mkdir -p src/lib/email`
  </action>
  <verify>TypeScript compiles; importing sendEmail works</verify>
  <done>Email client created with graceful fallback when RESEND_API_KEY not set</done>
</task>

<task type="auto">
  <name>Task 2: Create critical damage alert email template</name>
  <files>src/lib/email/templates/critical-alert.ts</files>
  <action>
Create the email template for critical damage alerts:

```typescript
// src/lib/email/templates/critical-alert.ts
import { sendEmail } from '../client';

export interface CriticalAlertData {
  teamName: string;
  equipmentName: string;
  equipmentId: string;
  reporterName: string;
  location: string;
  description: string;
  category?: string;
  photoUrl?: string;
  reportId: string;
}

/**
 * Send critical damage alert email to coaches
 * Called only for CRITICAL severity reports
 */
export async function sendCriticalDamageAlert(
  recipientEmails: string[],
  data: CriticalAlertData
): Promise<{ success: boolean; sent: number }> {
  if (recipientEmails.length === 0) {
    return { success: true, sent: 0 };
  }

  const appUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://rowops.app';
  const equipmentUrl = `${appUrl}/equipment/${data.equipmentId}`;

  const html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.5; color: #1f2937; max-width: 600px; margin: 0 auto; padding: 20px;">
  <div style="background-color: #dc2626; color: white; padding: 16px 20px; border-radius: 8px 8px 0 0;">
    <h1 style="margin: 0; font-size: 18px; font-weight: 600;">
      [CRITICAL] Equipment Damage Report
    </h1>
  </div>

  <div style="border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 8px 8px; padding: 20px;">
    <p style="margin: 0 0 16px;">
      A critical damage report has been submitted for <strong>${data.teamName}</strong>.
    </p>

    <table style="width: 100%; border-collapse: collapse; margin-bottom: 16px;">
      <tr>
        <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb; color: #6b7280; width: 120px;">Equipment:</td>
        <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb; font-weight: 500;">${data.equipmentName}</td>
      </tr>
      <tr>
        <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb; color: #6b7280;">Location:</td>
        <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">${data.location}</td>
      </tr>
      ${data.category ? `
      <tr>
        <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb; color: #6b7280;">Category:</td>
        <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">${data.category}</td>
      </tr>
      ` : ''}
      <tr>
        <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb; color: #6b7280;">Reported by:</td>
        <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">${data.reporterName}</td>
      </tr>
      <tr>
        <td style="padding: 8px 0; color: #6b7280;">Reference:</td>
        <td style="padding: 8px 0; font-family: monospace;">${data.reportId.substring(0, 8).toUpperCase()}</td>
      </tr>
    </table>

    <div style="background-color: #f9fafb; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
      <p style="margin: 0; color: #374151;">${data.description}</p>
    </div>

    ${data.photoUrl ? `
    <p style="margin: 0 0 16px;">
      <a href="${data.photoUrl}" style="color: #2563eb;">View attached photo</a>
    </p>
    ` : ''}

    <a href="${equipmentUrl}" style="display: inline-block; background-color: #059669; color: white; text-decoration: none; padding: 12px 24px; border-radius: 6px; font-weight: 500;">
      View Equipment Details
    </a>

    <p style="margin: 16px 0 0; font-size: 12px; color: #9ca3af;">
      This equipment should be taken out of service until inspected.
    </p>
  </div>

  <p style="margin: 16px 0 0; font-size: 12px; color: #9ca3af; text-align: center;">
    Sent by RowOps - Equipment Management for Rowing Teams
  </p>
</body>
</html>
  `.trim();

  const result = await sendEmail({
    to: recipientEmails,
    subject: `[CRITICAL] Damage: ${data.equipmentName} - ${data.teamName}`,
    html,
  });

  return {
    success: result.success,
    sent: result.success ? recipientEmails.length : 0,
  };
}
```

Create the directory first: `mkdir -p src/lib/email/templates`
  </action>
  <verify>TypeScript compiles; template function is importable</verify>
  <done>Critical damage alert email template created with equipment details and action link</done>
</task>

<task type="auto">
  <name>Task 3: Extend damage reports API with new fields and notifications</name>
  <files>src/app/api/equipment/[id]/damage-reports/route.ts</files>
  <action>
Update the existing POST handler to:

1. **Check honeypot first (after rate limit):**
```typescript
// After rate limit check, before database operations
const body = await request.json();

// Honeypot check - silent rejection (return 201 to not reveal detection)
if (body.honeypot) {
  return NextResponse.json({ success: true, damageReport: { id: 'blocked' } }, { status: 201 });
}
```

2. **Update validation to use extended schema:**
The validation already uses `createDamageReportSchema` which now includes new fields.

3. **Extract new fields from validated data:**
```typescript
const { location, description, severity, category, reporterName } = validationResult.data;
```

4. **Update damageReport creation with new fields:**
```typescript
const damageReport = await prisma.damageReport.create({
  data: {
    equipmentId,
    teamId,
    reportedBy, // Still tracks userId if authenticated
    reporterName, // Always required now
    location,
    description,
    severity, // MINOR | MODERATE | CRITICAL
    category: category || null,
    photoUrl,
    status: 'OPEN',
  },
});
```

5. **Update notification title to include severity:**
```typescript
const severityPrefix = severity === 'CRITICAL' ? '[CRITICAL] ' : '';
await prisma.notification.createMany({
  data: notifyUserIds.map(userId => ({
    teamId,
    userId,
    type: 'DAMAGE_REPORT',
    title: `${severityPrefix}Damage: ${equipment.name}`,
    message: `${reporterName}: ${description.substring(0, 80)}${description.length > 80 ? '...' : ''}`,
    linkUrl: `/equipment/${equipment.id}`,
  })),
});
```

6. **Send email for CRITICAL severity only:**
```typescript
// Send email notification for critical issues
if (severity === 'CRITICAL') {
  // Get coach emails
  const coachMembers = await prisma.teamMember.findMany({
    where: { teamId, role: 'COACH' },
    select: { userId: true },
  });

  // Fetch user emails from Supabase (TeamMember doesn't store email)
  const supabaseAdmin = await createClient();
  const { data: users } = await supabaseAdmin.auth.admin.listUsers();

  const coachEmails = coachMembers
    .map(m => users?.users?.find(u => u.id === m.userId)?.email)
    .filter((email): email is string => !!email);

  if (coachEmails.length > 0) {
    const { sendCriticalDamageAlert } = await import('@/lib/email/templates/critical-alert');
    await sendCriticalDamageAlert(coachEmails, {
      teamName: equipment.team?.name || 'Unknown Team',
      equipmentName: equipment.name,
      equipmentId: equipment.id,
      reporterName,
      location,
      description,
      category: category || undefined,
      photoUrl: photoUrl || undefined,
      reportId: damageReport.id,
    });
  }
}
```

Note: The email sending is best-effort - failures are logged but don't fail the request. This requires updating the equipment query to include team name.

7. **Update equipment query to include team name:**
```typescript
const equipment = await prisma.equipment.findUnique({
  where: { id: equipmentId },
  select: { id: true, teamId: true, name: true, team: { select: { name: true } } },
});
```
  </action>
  <verify>API accepts severity/category/reporterName; honeypot submissions silently rejected; critical issues trigger email (if configured)</verify>
  <done>API stores all new fields, honeypot protection active, severity-based notification routing complete</done>
</task>

</tasks>

<verification>
1. POST to `/api/equipment/{id}/damage-reports` with honeypot filled - returns 201 but no DB record
2. POST with valid data - creates DamageReport with severity, category, reporterName
3. POST with CRITICAL severity - notification title includes [CRITICAL] prefix
4. POST with CRITICAL severity and RESEND_API_KEY set - email sent to coaches
5. POST with CRITICAL severity without RESEND_API_KEY - no error, just logs warning
6. Check notification message includes reporter name
</verification>

<success_criteria>
- Honeypot-filled requests return 201 but create no database record
- DamageReport records have severity, category, reporterName stored
- All damage reports create in-app notifications
- CRITICAL severity notifications have [CRITICAL] prefix
- CRITICAL severity triggers email when RESEND_API_KEY configured
- Email gracefully degrades when not configured
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/20-public-issue-reporting/20-03-SUMMARY.md`
</output>
