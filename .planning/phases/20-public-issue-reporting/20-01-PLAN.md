---
phase: 20-public-issue-reporting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/validations/damage-report.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "DamageReport model includes severity field with MINOR, MODERATE, CRITICAL values"
    - "DamageReport model includes category and reporterName fields"
    - "Zod validation schema enforces required reporter name and severity"
    - "jspdf and resend libraries are available for use"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "ReportSeverity enum and extended DamageReport model"
      contains: "enum ReportSeverity"
    - path: "src/lib/validations/damage-report.ts"
      provides: "Extended validation schema with severity, category, reporterName"
      exports: ["createDamageReportSchema", "CreateDamageReportInput"]
  key_links:
    - from: "src/lib/validations/damage-report.ts"
      to: "prisma/schema.prisma"
      via: "matching severity enum values"
      pattern: "MINOR|MODERATE|CRITICAL"
---

<objective>
Extend the data foundation for public issue reporting with severity levels, categories, and required reporter name.

Purpose: Enable structured issue classification (severity/category) and accountability (reporter name) for damage reports. Install dependencies needed for QR bulk export and email notifications.
Output: Updated Prisma schema with ReportSeverity enum and extended DamageReport model, enhanced Zod validation, installed jspdf and resend libraries.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-public-issue-reporting/20-CONTEXT.md
@.planning/phases/20-public-issue-reporting/20-RESEARCH.md
@prisma/schema.prisma
@src/lib/validations/damage-report.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies</name>
  <files>package.json</files>
  <action>
Install the two libraries needed for Phase 20:

```bash
npm install jspdf resend
```

- jspdf: PDF generation for bulk QR code export
- resend: Email API for critical severity notifications

Verify installation completes without errors.
  </action>
  <verify>`npm list jspdf resend` shows both packages installed</verify>
  <done>jspdf and resend appear in package.json dependencies and are importable</done>
</task>

<task type="auto">
  <name>Task 2: Extend Prisma schema with severity enum and DamageReport fields</name>
  <files>prisma/schema.prisma</files>
  <action>
Add ReportSeverity enum and extend DamageReport model:

1. Add new enum ReportSeverity (place near other enums like DamageReportStatus):
```prisma
enum ReportSeverity {
  MINOR      // Cosmetic damage, can still use
  MODERATE   // Functional impact, needs attention
  CRITICAL   // Unsafe to use, immediate action required
}
```

2. Add three new fields to DamageReport model:
- `severity ReportSeverity @default(MODERATE)` - Required severity classification
- `category String?` - Optional category (Hull, Rigging, Hardware, Other, etc.)
- `reporterName String` - Required reporter name (replaces anonymous behavior)

The existing `reportedBy` field remains for userId when authenticated, but reporterName is always required now.

Run `npx prisma db push` to apply schema changes.
  </action>
  <verify>`npx prisma validate` passes; `npx prisma studio` shows new fields on DamageReport</verify>
  <done>DamageReport model has severity (enum), category (String?), and reporterName (String) fields</done>
</task>

<task type="auto">
  <name>Task 3: Extend Zod validation schema</name>
  <files>src/lib/validations/damage-report.ts</files>
  <action>
Extend the createDamageReportSchema to include new fields:

1. Add severity field with enum validation:
```typescript
severity: z.enum(['MINOR', 'MODERATE', 'CRITICAL']),
```

2. Add reporterName as required string with minimum length:
```typescript
reporterName: z.string().min(2, 'Please provide your name'),
```

3. Add optional category field:
```typescript
category: z.string().optional(),
```

4. Add honeypot field for bot detection (empty string validation):
```typescript
honeypot: z.string().max(0, 'Bot detected').optional(),
```

Update the CreateDamageReportInput type export to reflect new fields.

The schema should now validate:
- location (existing)
- description (existing)
- severity (new, required, enum)
- reporterName (new, required, min 2 chars)
- category (new, optional)
- honeypot (new, optional, must be empty if present)
  </action>
  <verify>TypeScript compiles without errors; schema rejects missing severity/reporterName</verify>
  <done>Validation schema enforces severity enum, required reporterName, optional category, honeypot detection</done>
</task>

</tasks>

<verification>
1. Run `npm list jspdf resend` - both packages listed
2. Run `npx prisma validate` - schema is valid
3. Run `npx prisma db push` - migrations applied
4. Create test file importing schema - TypeScript compiles
5. Verify zod schema rejects: `{ location: "x", description: "y" }` (missing severity/reporterName)
6. Verify zod schema accepts: `{ location: "x", description: "y", severity: "CRITICAL", reporterName: "John" }`
</verification>

<success_criteria>
- jspdf ^4.0.0 and resend in package.json
- prisma/schema.prisma has ReportSeverity enum with MINOR, MODERATE, CRITICAL
- DamageReport has severity, category, reporterName fields
- Zod schema validates all new fields with proper constraints
- Honeypot validation rejects non-empty values silently
- `npm run build` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/20-public-issue-reporting/20-01-SUMMARY.md`
</output>
