---
phase: 20-public-issue-reporting
plan: 02
type: execute
wave: 2
depends_on: [20-01]
files_modified:
  - src/components/equipment/damage-report-form.tsx
  - src/app/report/[equipmentId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User sees severity radio buttons (Minor, Moderate, Critical)"
    - "User sees category dropdown with sensible options"
    - "User must provide their name before submitting"
    - "Form has invisible honeypot field for bot protection"
    - "Form optimized for mobile (48px touch targets, camera capture)"
  artifacts:
    - path: "src/components/equipment/damage-report-form.tsx"
      provides: "Enhanced form with severity, category, reporterName, honeypot"
      min_lines: 280
    - path: "src/app/report/[equipmentId]/page.tsx"
      provides: "Public report page with team branding"
  key_links:
    - from: "src/components/equipment/damage-report-form.tsx"
      to: "/api/equipment/[id]/damage-reports"
      via: "fetch POST with new fields"
      pattern: "severity.*reporterName.*category"
---

<objective>
Enhance the public damage report form with severity levels, category selection, required reporter name, and bot protection.

Purpose: Transform the basic damage report form into a structured issue reporting tool with accountability (name required), classification (severity/category), and spam protection (honeypot). Mobile-first design for QR code scanning workflow.
Output: Enhanced DamageReportForm component with all new fields, honeypot protection, and mobile-optimized UI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-public-issue-reporting/20-CONTEXT.md
@.planning/phases/20-public-issue-reporting/20-RESEARCH.md
@.planning/phases/20-public-issue-reporting/20-01-SUMMARY.md
@src/components/equipment/damage-report-form.tsx
@src/lib/validations/damage-report.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add honeypot field for bot protection</name>
  <files>src/components/equipment/damage-report-form.tsx</files>
  <action>
Add an invisible honeypot field to catch bots:

1. Register honeypot in useForm:
```typescript
const { register, ... } = useForm<CreateDamageReportInput>({
  resolver: zodResolver(createDamageReportSchema),
  defaultValues: {
    honeypot: '', // Start empty, bots will fill it
  },
});
```

2. Add invisible honeypot field to form (after the form element, before other fields):
```tsx
{/* Honeypot - invisible to humans, catches bots */}
<div className="absolute -left-[9999px]" aria-hidden="true">
  <label htmlFor="website" className="sr-only">Leave empty</label>
  <input
    type="text"
    id="website"
    autoComplete="off"
    tabIndex={-1}
    {...register('honeypot')}
  />
</div>
```

The honeypot uses:
- Absolute positioning off-screen (not display:none which bots detect)
- Generic name "website" that attracts bots
- tabIndex={-1} to prevent keyboard focus
- autoComplete="off" to prevent browser autofill
- aria-hidden="true" for screen readers
  </action>
  <verify>Form renders without visible honeypot field; DOM shows hidden input exists</verify>
  <done>Honeypot field present in DOM but invisible to users</done>
</task>

<task type="auto">
  <name>Task 2: Add reporter name and severity/category fields</name>
  <files>src/components/equipment/damage-report-form.tsx</files>
  <action>
Add three new form fields with mobile-optimized styling:

1. **Reporter Name field** (add at top of form, before location):
```tsx
<div>
  <label htmlFor="reporterName" className="block text-sm font-medium text-gray-700">
    Your Name *
  </label>
  <input
    type="text"
    id="reporterName"
    {...register('reporterName')}
    className="mt-1 block w-full h-12 rounded-lg border border-gray-300 px-4 text-base shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
    placeholder="Enter your name"
    autoComplete="name"
  />
  {errors.reporterName && (
    <p className="mt-1 text-sm text-red-600">{errors.reporterName.message}</p>
  )}
</div>
```

2. **Severity Radio Buttons** (add after description):
```tsx
<fieldset>
  <legend className="block text-sm font-medium text-gray-700 mb-2">
    Severity *
  </legend>
  <div className="space-y-2">
    {[
      { value: 'MINOR', label: 'Minor', desc: 'Cosmetic damage, can still use safely' },
      { value: 'MODERATE', label: 'Moderate', desc: 'Functional impact, needs attention' },
      { value: 'CRITICAL', label: 'Critical', desc: 'Unsafe to use, immediate action needed' },
    ].map((opt) => (
      <label
        key={opt.value}
        className="flex items-start gap-3 p-4 rounded-lg border border-gray-300 cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50"
      >
        <input
          type="radio"
          value={opt.value}
          {...register('severity')}
          className="mt-0.5 w-5 h-5 text-blue-600"
        />
        <div>
          <span className="text-base font-medium">{opt.label}</span>
          <p className="text-sm text-gray-500">{opt.desc}</p>
        </div>
      </label>
    ))}
  </div>
  {errors.severity && (
    <p className="mt-1 text-sm text-red-600">{errors.severity.message}</p>
  )}
</fieldset>
```

3. **Category Dropdown** (add after severity):
```tsx
<div>
  <label htmlFor="category" className="block text-sm font-medium text-gray-700">
    Category (optional)
  </label>
  <select
    id="category"
    {...register('category')}
    className="mt-1 block w-full h-12 rounded-lg border border-gray-300 px-4 text-base shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white"
  >
    <option value="">Select a category...</option>
    <option value="Hull">Hull / Shell</option>
    <option value="Rigging">Rigging / Oarlocks</option>
    <option value="Hardware">Hardware / Fittings</option>
    <option value="Seat/Slides">Seat / Slides</option>
    <option value="Steering">Rudder / Steering</option>
    <option value="Other">Other</option>
  </select>
</div>
```

All inputs use:
- h-12 (48px) for WCAG touch target compliance
- text-base (16px) to prevent iOS zoom
- rounded-lg for modern appearance
- Large tap areas on radio buttons via p-4 padding
  </action>
  <verify>Form shows name input, severity radios, and category dropdown; all are tappable on mobile</verify>
  <done>Form has reporterName (required), severity radio (required), and category dropdown (optional)</done>
</task>

<task type="auto">
  <name>Task 3: Update form submission and success state</name>
  <files>src/components/equipment/damage-report-form.tsx</files>
  <action>
Update the onSubmit handler and success state:

1. **Update onSubmit to include new fields:**
```typescript
const onSubmit = async (data: CreateDamageReportInput) => {
  setIsSubmitting(true);

  try {
    let photoUrl: string | null = null;
    if (photoFile) {
      photoUrl = await uploadPhoto(photoFile);
    }

    const response = await fetch(`/api/equipment/${equipmentId}/damage-reports`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        location: data.location,
        description: data.description,
        severity: data.severity,
        category: data.category || null,
        reporterName: data.reporterName,
        honeypot: data.honeypot, // Server will check this
        photoUrl,
      }),
    });
    // ... rest of handler
  }
};
```

2. **Add state for report ID and "Report Another" flow:**
```typescript
const [reportId, setReportId] = useState<string | null>(null);
// In success handler:
setReportId(result.damageReport.id);
```

3. **Enhance success view with reference number and Report Another button:**
```tsx
if (isSuccess) {
  return (
    <div className="bg-white rounded-lg shadow p-6">
      <div className="text-center">
        <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
          <svg className="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
          </svg>
        </div>
        <h3 className="text-lg font-medium text-gray-900">Report Submitted</h3>
        {reportId && (
          <p className="mt-1 text-sm text-gray-500">
            Reference: {reportId.substring(0, 8).toUpperCase()}
          </p>
        )}
        <p className="mt-2 text-sm text-gray-500">
          Thank you for reporting this issue. The coaching staff has been notified.
        </p>
        <button
          type="button"
          onClick={() => {
            setIsSuccess(false);
            setReportId(null);
            setPhotoFile(null);
            setPhotoPreview(null);
            reset(); // react-hook-form reset
          }}
          className="mt-4 inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
        >
          Report Another Issue
        </button>
      </div>
    </div>
  );
}
```

4. **Import reset from useForm:**
```typescript
const { register, handleSubmit, formState: { errors }, reset } = useForm<CreateDamageReportInput>({...});
```
  </action>
  <verify>Submit includes all new fields; success shows reference number and "Report Another" button</verify>
  <done>Form submission includes severity/category/reporterName/honeypot; success shows reference and allows reporting another issue</done>
</task>

</tasks>

<verification>
1. Load `/report/{equipmentId}` - form shows all fields
2. Try submitting with empty name - validation error appears
3. Try submitting without severity selected - validation error appears
4. Check honeypot field is not visible but exists in DOM
5. Submit valid form - success screen shows reference number
6. Click "Report Another" - form resets for new submission
7. Test on mobile viewport - all inputs are 48px+ height, no text zoom on focus
</verification>

<success_criteria>
- Reporter name field is required with min 2 chars
- Severity has three radio options with descriptions
- Category dropdown has 6 sensible options plus empty default
- Honeypot field exists but is invisible (off-screen positioning)
- All inputs are 48px height for mobile touch targets
- Success state shows truncated report ID as reference
- "Report Another" button resets form state
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/20-public-issue-reporting/20-02-SUMMARY.md`
</output>
