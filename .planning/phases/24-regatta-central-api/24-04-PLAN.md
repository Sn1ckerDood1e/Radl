---
phase: 24-regatta-central-api
plan: 04
type: execute
wave: 3
depends_on: ["24-02", "24-03"]
files_modified:
  - src/components/calendar/unified-calendar.tsx
  - src/app/api/schedule/route.ts
autonomous: true

must_haves:
  truths:
    - "Calendar shows RC regattas alongside practices"
    - "Multi-day regattas display with spanning bar"
    - "Clicking regatta shows detail popup"
    - "Blue color differentiates regattas from practices"
  artifacts:
    - path: "src/components/calendar/unified-calendar.tsx"
      provides: "Calendar with RC regatta integration"
      contains: "rcRegattas"
    - path: "src/app/api/schedule/route.ts"
      provides: "Schedule endpoint including RC regattas"
      contains: "RCPublicRegatta"
  key_links:
    - from: "src/components/calendar/unified-calendar.tsx"
      to: "/api/regattas/upcoming"
      via: "fetch for RC regattas"
      pattern: "api/regattas/upcoming"
    - from: "src/components/calendar/unified-calendar.tsx"
      to: "src/components/calendar/regatta-detail-card.tsx"
      via: "popup on click"
      pattern: "RegattaDetailCard"
---

<objective>
Integrate RC regattas into the unified calendar with multi-day event visualization.

Purpose: Display RC regattas on the team calendar per RC-03, with click-to-popup detail cards and visual spanning bars for multi-day events.

Output: Updated unified-calendar.tsx with RC regatta fetching, multi-day bar rendering, and detail popup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-regatta-central-api/24-02-SUMMARY.md
@.planning/phases/24-regatta-central-api/24-03-SUMMARY.md

# Existing infrastructure
@src/components/calendar/unified-calendar.tsx
@src/components/calendar/regatta-detail-card.tsx
@src/app/api/schedule/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add RC regatta fetching to unified calendar</name>
  <files>src/components/calendar/unified-calendar.tsx</files>
  <action>
1. Open src/components/calendar/unified-calendar.tsx.

2. Add state for RC regattas and selected regatta popup:

```typescript
import { RegattaDetailCard } from './regatta-detail-card';
import type { RCPublicRegatta } from '@/lib/regatta-central/types';

// Add state
const [rcRegattas, setRcRegattas] = useState<RCPublicRegatta[]>([]);
const [selectedRegatta, setSelectedRegatta] = useState<RCPublicRegatta | null>(null);
const [rcCachedAt, setRcCachedAt] = useState<string | null>(null);
```

3. Add fetch function for RC regattas (fetch once on mount, not per-month):

```typescript
// Fetch RC regattas (separate from month-based practice fetch)
const fetchRcRegattas = useCallback(async () => {
  try {
    const response = await fetch('/api/regattas/upcoming');
    if (response.ok) {
      const data = await response.json();
      if (data.regattas) {
        setRcRegattas(data.regattas.map((r: RCPublicRegatta) => ({
          ...r,
          startDate: new Date(r.startDate),
          endDate: r.endDate ? new Date(r.endDate) : null,
        })));
        setRcCachedAt(data.cachedAt);
      }
    }
  } catch (error) {
    console.error('Failed to fetch RC regattas:', error);
  }
}, []);

useEffect(() => {
  fetchRcRegattas();
}, [fetchRcRegattas]);
```

4. Combine RC regattas with displayEvents for calendar dot indicators:

```typescript
// Get all event dates including RC regattas for this month
const getRcRegattaDatesForMonth = (month: Date): Date[] => {
  const monthStart = startOfMonth(month);
  const monthEnd = endOfMonth(month);

  return rcRegattas.flatMap((r) => {
    const dates: Date[] = [];
    let current = new Date(r.startDate);
    const end = r.endDate || r.startDate;

    while (current <= end) {
      if (current >= monthStart && current <= monthEnd) {
        dates.push(new Date(current));
      }
      current.setDate(current.getDate() + 1);
    }

    return dates;
  });
};

// Update eventDates to include RC regattas
const eventDates = [
  ...displayEvents.map((e) => new Date(e.date)),
  ...getRcRegattaDatesForMonth(currentMonth),
];
```

5. Update getEventsForDate to include RC regattas:

```typescript
const getRcRegattasForDate = (date: Date): RCPublicRegatta[] => {
  const dateStr = format(date, 'yyyy-MM-dd');
  return rcRegattas.filter((r) => {
    const start = format(r.startDate, 'yyyy-MM-dd');
    const end = r.endDate ? format(r.endDate, 'yyyy-MM-dd') : start;
    return dateStr >= start && dateStr <= end;
  });
};
```

6. Add modifiers for RC regatta styling (blue dots instead of emerald):

Update the DayPicker modifiers:
```typescript
modifiers={{
  hasEvent: eventDates.filter(d =>
    displayEvents.some(e => e.date === format(d, 'yyyy-MM-dd'))
  ),
  hasRegatta: eventDates.filter(d =>
    rcRegattas.some(r => {
      const start = format(r.startDate, 'yyyy-MM-dd');
      const end = r.endDate ? format(r.endDate, 'yyyy-MM-dd') : start;
      const dateStr = format(d, 'yyyy-MM-dd');
      return dateStr >= start && dateStr <= end;
    })
  ),
}}
modifiersClassNames={{
  hasEvent: 'has-event',
  hasRegatta: 'has-regatta',
  selected: 'selected-day',
  today: 'today-day',
}}
```

7. Add CSS for regatta indicators (blue dot):

```css
.has-regatta .calendar-day-btn::before {
  content: '';
  position: absolute;
  bottom: 4px;
  left: calc(50% + 5px);
  transform: translateX(-50%);
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background-color: #3b82f6;
}
.has-event.has-regatta .calendar-day-btn::after {
  left: calc(50% - 5px);
}
```
  </action>
  <verify>
- TypeScript compiles with `npx tsc --noEmit`
- Calendar fetches RC regattas on mount
- Blue dots appear on regatta days
  </verify>
  <done>Calendar fetches RC regattas, displays blue dot indicators, handles multi-day spanning</done>
</task>

<task type="auto">
  <name>Task 2: Add regatta detail popup and event list display</name>
  <files>src/components/calendar/unified-calendar.tsx</files>
  <action>
1. Continue editing src/components/calendar/unified-calendar.tsx.

2. Update the selected date events panel to show RC regattas:

```typescript
// Get RC regattas for selected date
const selectedRcRegattas = selectedDate ? getRcRegattasForDate(selectedDate) : [];
```

3. Add regatta display in the events panel (before practices):

```typescript
{/* Selected day events */}
<div className="space-y-3">
  {/* RC Regattas first */}
  {selectedRcRegattas.map((regatta) => (
    <button
      key={`rc-${regatta.id}`}
      onClick={() => setSelectedRegatta(regatta)}
      className="w-full text-left p-3 rounded-lg border bg-blue-500/10 border-blue-500/30 hover:bg-blue-500/20 transition-colors"
    >
      <div className="flex items-center gap-2">
        <svg
          className="h-4 w-4 flex-shrink-0 text-blue-400"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"
          />
        </svg>
        <div className="min-w-0 flex-1">
          <p className="text-sm font-medium text-blue-300 truncate">
            {regatta.name}
          </p>
          <p className="text-xs text-blue-400/70">
            {regatta.endDate && differenceInDays(regatta.endDate, regatta.startDate) > 0
              ? `${format(regatta.startDate, 'MMM d')} - ${format(regatta.endDate, 'MMM d')}`
              : format(regatta.startDate, 'h:mm a')}
            {regatta.location && ` â€¢ ${regatta.location}`}
          </p>
        </div>
        <span className="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-blue-500/20 text-blue-400">
          RC
        </span>
      </div>
    </button>
  ))}

  {/* Practices */}
  {selectedEvents.map((event) =>
    event.type === 'practice' ? (
      <PracticeCard ... />
    ) : (
      <RegattaCard ... />
    )
  )}
</div>
```

4. Add popup overlay for regatta detail card:

```typescript
{/* Regatta detail popup */}
{selectedRegatta && (
  <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50">
    <div className="relative">
      <RegattaDetailCard
        regatta={selectedRegatta}
        onClose={() => setSelectedRegatta(null)}
      />
    </div>
  </div>
)}
```

5. Add click-outside handling:

```typescript
// In the overlay div
<div
  className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50"
  onClick={(e) => {
    if (e.target === e.currentTarget) {
      setSelectedRegatta(null);
    }
  }}
>
```

6. Add required imports:

```typescript
import { differenceInDays } from 'date-fns';
```
  </action>
  <verify>
- TypeScript compiles with `npx tsc --noEmit`
- Clicking RC regatta opens detail popup
- Clicking outside popup closes it
- RC regattas display above practices in event list
  </verify>
  <done>
- RC regattas appear in selected day event list with blue styling
- Clicking regatta opens RegattaDetailCard popup
- Click outside or X button closes popup
- Blue "RC" badge distinguishes from local regattas
  </done>
</task>

<task type="auto">
  <name>Task 3: Add multi-day event spanning visualization</name>
  <files>src/components/calendar/unified-calendar.tsx</files>
  <action>
1. Continue editing src/components/calendar/unified-calendar.tsx.

2. Add modifiers for multi-day regatta spanning (first day, middle days, last day):

```typescript
// Calculate spanning modifiers for multi-day regattas
const getSpanningModifiers = (date: Date): string[] => {
  const dateStr = format(date, 'yyyy-MM-dd');
  const classes: string[] = [];

  rcRegattas.forEach((r) => {
    if (!r.endDate || differenceInDays(r.endDate, r.startDate) === 0) return;

    const startStr = format(r.startDate, 'yyyy-MM-dd');
    const endStr = format(r.endDate, 'yyyy-MM-dd');

    if (dateStr === startStr) {
      classes.push('regatta-span-start');
    } else if (dateStr === endStr) {
      classes.push('regatta-span-end');
    } else if (dateStr > startStr && dateStr < endStr) {
      classes.push('regatta-span-middle');
    }
  });

  return classes;
};
```

3. Update DayPicker to apply spanning classes dynamically.

Use custom day render via react-day-picker's components prop:

```typescript
<DayPicker
  mode="single"
  selected={selectedDate}
  onSelect={setSelectedDate}
  month={currentMonth}
  onMonthChange={setCurrentMonth}
  modifiers={{ hasEvent, hasRegatta }}
  modifiersClassNames={{ hasEvent: 'has-event', hasRegatta: 'has-regatta', selected: 'selected-day', today: 'today-day' }}
  components={{
    Day: ({ date, ...props }) => {
      const spanClasses = getSpanningModifiers(date).join(' ');
      return (
        <td className={`${props.className || ''} ${spanClasses}`} {...props}>
          {/* Default day rendering */}
        </td>
      );
    },
  }}
  classNames={{ ... }}
/>
```

Note: react-day-picker v9 has limited customization. Alternative approach using CSS pseudo-elements on grid:

4. Add CSS for spanning bars (using ::before on cells):

```css
/* Multi-day regatta spanning bar */
.regatta-span-start .calendar-day-btn {
  position: relative;
}
.regatta-span-start .calendar-day-btn::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 50%;
  right: -4px;
  height: 4px;
  background-color: #3b82f6;
  border-radius: 2px 0 0 2px;
}
.regatta-span-middle .calendar-day-btn::after {
  content: '';
  position: absolute;
  top: 2px;
  left: -4px;
  right: -4px;
  height: 4px;
  background-color: #3b82f6;
}
.regatta-span-end .calendar-day-btn::after {
  content: '';
  position: absolute;
  top: 2px;
  left: -4px;
  right: 50%;
  height: 4px;
  background-color: #3b82f6;
  border-radius: 0 2px 2px 0;
}
/* Reset dot position when spanning */
.regatta-span-start .calendar-day-btn::before,
.regatta-span-middle .calendar-day-btn::before,
.regatta-span-end .calendar-day-btn::before {
  display: none;
}
```

5. Apply spanning classes via className calculation in day rendering. Since react-day-picker v9 uses custom modifiers, create custom modifiers for each span type:

```typescript
// Build spanning modifiers
const spanStartDates: Date[] = [];
const spanMiddleDates: Date[] = [];
const spanEndDates: Date[] = [];

rcRegattas.forEach((r) => {
  if (!r.endDate || differenceInDays(r.endDate, r.startDate) === 0) return;

  let current = new Date(r.startDate);
  const end = r.endDate;
  let isFirst = true;

  while (current <= end) {
    if (current >= startOfMonth(currentMonth) && current <= endOfMonth(currentMonth)) {
      if (isFirst) {
        spanStartDates.push(new Date(current));
        isFirst = false;
      } else if (format(current, 'yyyy-MM-dd') === format(end, 'yyyy-MM-dd')) {
        spanEndDates.push(new Date(current));
      } else {
        spanMiddleDates.push(new Date(current));
      }
    }
    current.setDate(current.getDate() + 1);
  }
});

// In modifiers:
modifiers={{
  hasEvent: ...,
  hasRegatta: ...,
  regattaSpanStart: spanStartDates,
  regattaSpanMiddle: spanMiddleDates,
  regattaSpanEnd: spanEndDates,
}}
modifiersClassNames={{
  ...
  regattaSpanStart: 'regatta-span-start',
  regattaSpanMiddle: 'regatta-span-middle',
  regattaSpanEnd: 'regatta-span-end',
}}
```
  </action>
  <verify>
- TypeScript compiles with `npx tsc --noEmit`
- Multi-day regattas show horizontal spanning bar
- Single-day regattas show only dot indicator
- Linting passes with `npm run lint`
  </verify>
  <done>
- Multi-day regattas display blue spanning bar across days
- Bar has rounded start/end and flat middle sections
- Dot indicator hidden on spanning days (bar replaces it)
- Single-day regattas keep dot indicator
  </done>
</task>

</tasks>

<verification>
1. Type check: `npx tsc --noEmit` passes
2. Linting: `npm run lint` passes
3. Visual: Calendar shows blue dots for single-day, spanning bars for multi-day regattas
4. Interaction: Clicking regatta opens detail popup
</verification>

<success_criteria>
- RC regattas appear on calendar with blue visual indicators
- Multi-day events show horizontal spanning bar
- Single-day events show blue dot
- Clicking regatta shows RegattaDetailCard popup
- RC regattas appear in selected day event list
- Blue color clearly differentiates from emerald practices
</success_criteria>

<output>
After completion, create `.planning/phases/24-regatta-central-api/24-04-SUMMARY.md`
</output>
