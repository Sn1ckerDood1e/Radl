---
phase: 24-regatta-central-api
plan: 06
type: execute
wave: 4
depends_on: ["24-04", "24-05"]
files_modified:
  - src/components/calendar/unified-calendar.tsx
  - src/components/calendar/regatta-detail-card.tsx
autonomous: false

must_haves:
  truths:
    - "RC regattas display on calendar when connected"
    - "Multi-day events show spanning bar"
    - "Click shows detail popup with RC link"
    - "Region filtering works as configured"
  artifacts:
    - path: ".planning/phases/24-regatta-central-api/24-VERIFICATION.md"
      provides: "Phase verification results"
      contains: "RC-01"
  key_links:
    - from: "unified-calendar.tsx"
      to: "/api/regattas/upcoming"
      via: "fetch on mount"
      pattern: "api/regattas/upcoming"
    - from: "settings page"
      to: "calendar display"
      via: "regattaRegions filter"
      pattern: "regattaRegions"
---

<objective>
Final integration verification and visual polish for RC regatta calendar display.

Purpose: Verify all Phase 24 requirements (RC-01 through RC-04) are satisfied and the integration works end-to-end with proper visual differentiation.

Output: Verified RC regatta integration with complete requirement coverage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-regatta-central-api/24-04-SUMMARY.md
@.planning/phases/24-regatta-central-api/24-05-SUMMARY.md

# Implementation files
@src/components/calendar/unified-calendar.tsx
@src/components/calendar/regatta-detail-card.tsx
@src/app/api/regattas/upcoming/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify and polish calendar integration</name>
  <files>src/components/calendar/unified-calendar.tsx</files>
  <action>
1. Open src/components/calendar/unified-calendar.tsx.

2. Verify all integrations are complete:
   - RC regatta fetching on mount
   - Blue dot indicators for single-day events
   - Spanning bar for multi-day events
   - RC regattas in selected day list
   - Click opens detail popup
   - Export includes RC regattas

3. Add stale data indicator when RC data is cached:

```typescript
{/* Add near staleness indicator */}
{rcCachedAt && (
  <p className="text-xs text-zinc-500 text-center mt-1">
    Regattas updated {formatDistanceToNow(new Date(rcCachedAt), { addSuffix: true })}
  </p>
)}
```

4. Add empty state when no RC regattas (but RC is connected):

In the events panel when selectedRcRegattas is empty but rcRegattas has items:
```typescript
{rcRegattas.length > 0 && selectedRcRegattas.length === 0 && selectedEvents.length === 0 && (
  <p className="text-sm text-zinc-500">
    No events on this day. Check the calendar for upcoming regattas.
  </p>
)}
```

5. Ensure export handler includes RC regattas:

Update handleExport to include rcRegattas in exportData:
```typescript
const exportData = [
  ...displayEvents.map(e => ({ ... })),
  ...rcRegattas.map(r => ({
    date: format(r.startDate, 'yyyy-MM-dd'),
    name: r.name,
    type: 'Regatta (RC)',
    startTime: format(r.startDate, 'HH:mm'),
    endTime: r.endDate ? format(r.endDate, 'HH:mm') : '',
    location: r.location || '',
    status: r.registrationStatus,
  })),
];
```
  </action>
  <verify>
- TypeScript compiles with `npx tsc --noEmit`
- Calendar displays RC regattas correctly
- Export includes RC regattas
  </verify>
  <done>Calendar integration verified and polished with stale indicator, empty states, and export inclusion</done>
</task>

<task type="auto">
  <name>Task 2: Create verification document</name>
  <files>.planning/phases/24-regatta-central-api/24-VERIFICATION.md</files>
  <action>
1. Create verification document at .planning/phases/24-regatta-central-api/24-VERIFICATION.md.

2. Document requirement coverage:

```markdown
# Phase 24: Regatta Central API â€” Verification

## Requirements Coverage

| Requirement | Status | Evidence |
|-------------|--------|----------|
| RC-01: Regatta schedules | SATISFIED | `/api/regattas/upcoming` fetches from RC API via OAuth |
| RC-02: Regatta display | SATISFIED | `RegattaDetailCard` shows name, date, location, registration |
| RC-03: Calendar integration | SATISFIED | `unified-calendar.tsx` displays RC regattas with blue styling |
| RC-04: API caching | SATISFIED | 6-hour Cache-Control TTL, stale-while-revalidate |

## Truths Verification

| Truth | Verified |
|-------|----------|
| RC regattas appear on calendar | Yes - blue indicators, spanning bars |
| Multi-day events show range | Yes - spanning bar CSS, date range in card |
| Click shows detail popup | Yes - RegattaDetailCard with onClose |
| Caching prevents rate limits | Yes - 6-hour TTL in route.ts |
| Region filtering works | Yes - TeamSettings.regattaRegions |

## Key Links Verification

| From | To | Via | Verified |
|------|----|----|----------|
| unified-calendar.tsx | /api/regattas/upcoming | fetch on mount | Yes |
| /api/regattas/upcoming | RC client | getPublicRegattas | Yes |
| RC client | RC API | OAuth bearer token | Yes |
| Settings page | TeamSettings | regattaRegions field | Yes |
| /api/regattas/upcoming | TeamSettings | region filter | Yes |

## Artifacts Created

- `src/lib/regatta-central/types.ts` - RCPublicRegatta types
- `src/lib/regatta-central/client.ts` - getPublicRegattas method
- `src/app/api/regattas/upcoming/route.ts` - Cached API endpoint
- `src/components/calendar/registration-badge.tsx` - Status badge
- `src/components/calendar/regatta-detail-card.tsx` - Detail popup
- `src/components/calendar/unified-calendar.tsx` - RC integration
- `src/app/[teamSlug]/settings/page.tsx` - Region config UI
- `prisma/schema.prisma` - regattaRegions field

## Decisions Implemented

| Decision | Implementation |
|----------|---------------|
| Blue color for regattas | Blue-500 theme in all regatta UI |
| 6-hour cache TTL | Cache-Control s-maxage=21600 |
| Click shows popup | RegattaDetailCard with overlay |
| Multi-day spanning bar | CSS pseudo-elements on calendar days |
| US default region | Fallback in /api/regattas/upcoming |
```
  </action>
  <verify>
- File exists at correct path
- All requirements documented as SATISFIED
- Evidence provided for each
  </verify>
  <done>Verification document created with complete requirement coverage</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete RC regatta calendar integration:
- RC regattas fetched from API with 6-hour caching
- Calendar shows blue dot for single-day, spanning bar for multi-day
- Clicking regatta opens detail popup with name, date, location, registration status
- Region filtering configurable in team settings
  </what-built>
  <how-to-verify>
1. Navigate to team settings page
2. Scroll to "Regatta Central" section
3. Verify region checkboxes appear (US should be default)
4. Select additional regions if desired, click Save
5. Navigate to calendar (Schedule page)
6. Look for blue indicators on calendar days (if RC is connected)
7. Click on a day with a regatta indicator
8. Verify regatta appears in event list with blue "RC" badge
9. Click the regatta to open detail popup
10. Verify popup shows: name, date(s), location, registration status, RC link
11. Click "View on RC" link to verify it opens Regatta Central
12. Close popup with X or click outside
13. For multi-day regattas: verify spanning bar connects multiple days

Note: Requires RC connection to see actual data. Without RC connection, calendar shows empty RC state gracefully.
  </how-to-verify>
  <resume-signal>Type "verified" to confirm or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. Type check: `npx tsc --noEmit` passes
2. Linting: `npm run lint` passes
3. Manual: User verified calendar and settings UI
4. All 4 requirements satisfied (RC-01, RC-02, RC-03, RC-04)
</verification>

<success_criteria>
- All RC-01 through RC-04 requirements satisfied
- Calendar displays RC regattas with proper visual differentiation
- Multi-day events show spanning bars
- Detail popup shows all required information
- Region configuration works and persists
- Caching prevents excessive API calls
- Graceful degradation when RC unavailable
</success_criteria>

<output>
After completion, create `.planning/phases/24-regatta-central-api/24-06-SUMMARY.md`
</output>
