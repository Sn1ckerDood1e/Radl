---
phase: 24-regatta-central-api
plan: 05
type: execute
wave: 3
depends_on: ["24-01"]
files_modified:
  - src/app/[teamSlug]/settings/page.tsx
  - src/lib/validations/team-settings.ts
  - src/app/api/settings/route.ts
autonomous: true

must_haves:
  truths:
    - "User can configure regatta region preferences"
    - "Region settings persist to database"
    - "Default shows US if no regions configured"
  artifacts:
    - path: "src/app/[teamSlug]/settings/page.tsx"
      provides: "Region filter UI in team settings"
      contains: "regattaRegions"
    - path: "src/app/api/settings/route.ts"
      provides: "API support for regattaRegions"
      contains: "regattaRegions"
  key_links:
    - from: "src/app/[teamSlug]/settings/page.tsx"
      to: "src/app/api/settings/route.ts"
      via: "PATCH request with regattaRegions"
      pattern: "regattaRegions"
---

<objective>
Add region filter configuration UI to team settings.

Purpose: Allow teams to configure which regions to fetch regattas from per CONTEXT.md "Region filter: User-configurable in team settings" decision.

Output: Updated settings page with region selection, API support for saving region preferences.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-regatta-central-api/24-01-SUMMARY.md

# Existing infrastructure
@src/app/[teamSlug]/settings/page.tsx
@src/app/api/settings/route.ts
@src/lib/validations/team-settings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update validation schema for regattaRegions</name>
  <files>src/lib/validations/team-settings.ts</files>
  <action>
1. Open src/lib/validations/team-settings.ts.

2. Add regattaRegions to the team settings validation schema:

```typescript
// Common region codes for rowing (ISO 3166-1 alpha-2)
export const REGATTA_REGIONS = [
  { code: 'US', name: 'United States' },
  { code: 'CA', name: 'Canada' },
  { code: 'GB', name: 'United Kingdom' },
  { code: 'AU', name: 'Australia' },
  { code: 'NZ', name: 'New Zealand' },
  { code: 'DE', name: 'Germany' },
  { code: 'NL', name: 'Netherlands' },
  { code: 'FR', name: 'France' },
  { code: 'IT', name: 'Italy' },
  { code: 'ES', name: 'Spain' },
] as const;

export const VALID_REGION_CODES = REGATTA_REGIONS.map(r => r.code);
```

3. Add to the update schema:

```typescript
export const updateTeamSettingsSchema = z.object({
  // ... existing fields ...
  regattaRegions: z.array(
    z.string().refine(
      (code) => VALID_REGION_CODES.includes(code),
      { message: 'Invalid region code' }
    )
  ).max(10, 'Maximum 10 regions').optional(),
});
```

4. Export the REGATTA_REGIONS constant for UI consumption.
  </action>
  <verify>
- TypeScript compiles with `npx tsc --noEmit`
- Schema validates valid region codes
- Schema rejects invalid region codes
  </verify>
  <done>Validation schema updated with regattaRegions array validation, REGATTA_REGIONS constant exported</done>
</task>

<task type="auto">
  <name>Task 2: Update settings API for regattaRegions</name>
  <files>src/app/api/settings/route.ts</files>
  <action>
1. Open src/app/api/settings/route.ts.

2. Ensure the GET endpoint returns regattaRegions:

In the select for teamSettings:
```typescript
select: {
  damageNotifyUserIds: true,
  readinessInspectSoonDays: true,
  readinessNeedsAttentionDays: true,
  readinessOutOfServiceDays: true,
  regattaRegions: true,  // Add this
}
```

3. Ensure the PATCH endpoint handles regattaRegions updates:

In the upsert data:
```typescript
data: {
  ...existingFields,
  regattaRegions: validData.regattaRegions ?? undefined,
}
```

4. Use undefined (not null) to skip updating when not provided, preserving existing value.
  </action>
  <verify>
- TypeScript compiles with `npx tsc --noEmit`
- GET returns regattaRegions field
- PATCH accepts and persists regattaRegions
  </verify>
  <done>Settings API GET returns regattaRegions, PATCH updates regattaRegions when provided</done>
</task>

<task type="auto">
  <name>Task 3: Add region selector to settings UI</name>
  <files>src/app/[teamSlug]/settings/page.tsx</files>
  <action>
1. Open src/app/[teamSlug]/settings/page.tsx.

2. Import the region constants:
```typescript
import { REGATTA_REGIONS } from '@/lib/validations/team-settings';
```

3. Add state for regatta regions:
```typescript
const [regattaRegions, setRegattaRegions] = useState<string[]>([]);
```

4. Load initial value from API response:
```typescript
// In the useEffect that fetches settings
if (data.regattaRegions) {
  setRegattaRegions(data.regattaRegions);
}
```

5. Add a new section for Regatta Central settings (place after Equipment Readiness, before Appearance):

```tsx
{/* Regatta Central Section */}
<section className="bg-zinc-900 border border-zinc-800 rounded-lg p-6">
  <h2 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
    <svg className="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9" />
    </svg>
    Regatta Central
  </h2>
  <p className="text-sm text-zinc-400 mb-4">
    Select regions to show upcoming regattas on your calendar.
  </p>

  <div className="space-y-3">
    <label className="text-sm font-medium text-zinc-300">
      Regatta Regions
    </label>
    <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
      {REGATTA_REGIONS.map((region) => (
        <label
          key={region.code}
          className="flex items-center gap-2 p-2 rounded-lg bg-zinc-800/50 hover:bg-zinc-800 cursor-pointer transition-colors"
        >
          <input
            type="checkbox"
            checked={regattaRegions.includes(region.code)}
            onChange={(e) => {
              if (e.target.checked) {
                setRegattaRegions([...regattaRegions, region.code]);
              } else {
                setRegattaRegions(regattaRegions.filter(r => r !== region.code));
              }
            }}
            className="h-4 w-4 rounded border-zinc-600 bg-zinc-800 text-blue-500 focus:ring-blue-500 focus:ring-offset-zinc-900"
          />
          <span className="text-sm text-zinc-300">{region.name}</span>
        </label>
      ))}
    </div>
    {regattaRegions.length === 0 && (
      <p className="text-xs text-zinc-500">
        No regions selected. United States will be used by default.
      </p>
    )}
  </div>

  <div className="mt-4 flex justify-end">
    <button
      onClick={handleSaveRegions}
      disabled={isSaving}
      className="px-4 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-zinc-700 disabled:cursor-not-allowed text-white text-sm font-medium rounded-lg transition-colors"
    >
      {isSaving ? 'Saving...' : 'Save Regions'}
    </button>
  </div>
</section>
```

6. Add save handler:

```typescript
const handleSaveRegions = async () => {
  setIsSaving(true);
  try {
    const response = await fetch('/api/settings', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ regattaRegions }),
    });

    if (response.ok) {
      toast.success('Regatta regions saved');
    } else {
      const data = await response.json();
      toast.error(data.error || 'Failed to save regions');
    }
  } catch (error) {
    toast.error('Failed to save regions');
  } finally {
    setIsSaving(false);
  }
};
```

7. Use blue color scheme for RC section to match calendar regatta styling.
  </action>
  <verify>
- TypeScript compiles with `npx tsc --noEmit`
- Settings page renders region checkboxes
- Selecting/deselecting updates state
- Save button persists to API
- Linting passes with `npm run lint`
  </verify>
  <done>
- Regatta Central section added to settings page
- Checkbox grid for region selection
- Save button persists to TeamSettings.regattaRegions
- Blue color scheme matches calendar regatta styling
- Default message shows when no regions selected
  </done>
</task>

</tasks>

<verification>
1. Type check: `npx tsc --noEmit` passes
2. Linting: `npm run lint` passes
3. Functional: Can select regions and save, reload shows persisted selection
4. API: GET returns regattaRegions, PATCH updates correctly
</verification>

<success_criteria>
- Settings page has Regatta Central section with region checkboxes
- Region selection persists to database via API
- GET /api/settings returns regattaRegions array
- PATCH /api/settings accepts and updates regattaRegions
- Empty selection shows "US by default" message
- Blue color scheme matches calendar regatta display
</success_criteria>

<output>
After completion, create `.planning/phases/24-regatta-central-api/24-05-SUMMARY.md`
</output>
