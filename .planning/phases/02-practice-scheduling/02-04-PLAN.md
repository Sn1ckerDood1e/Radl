---
phase: 02-practice-scheduling
plan: 04
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - src/app/api/practice-templates/route.ts
  - src/app/api/practice-templates/[id]/route.ts
  - src/app/api/practice-templates/apply/route.ts
  - src/app/api/block-templates/route.ts
  - src/app/api/block-templates/[id]/route.ts
autonomous: true

must_haves:
  truths:
    - "Coach can create and manage practice templates"
    - "Coach can create and manage block templates"
    - "Coach can apply a practice template to create a new practice"
    - "Template application copies data (no ongoing link)"
  artifacts:
    - path: "src/app/api/practice-templates/route.ts"
      provides: "GET list and POST create for practice templates"
      exports: ["GET", "POST"]
    - path: "src/app/api/practice-templates/[id]/route.ts"
      provides: "GET, PATCH, DELETE for practice templates"
      exports: ["GET", "PATCH", "DELETE"]
    - path: "src/app/api/practice-templates/apply/route.ts"
      provides: "POST to create practice from template"
      exports: ["POST"]
    - path: "src/app/api/block-templates/route.ts"
      provides: "GET list and POST create for block templates"
      exports: ["GET", "POST"]
    - path: "src/app/api/block-templates/[id]/route.ts"
      provides: "GET, PATCH, DELETE for block templates"
      exports: ["GET", "PATCH", "DELETE"]
  key_links:
    - from: "src/app/api/practice-templates/apply/route.ts"
      to: "prisma.practice.create"
      via: "copy-on-apply pattern"
      pattern: "prisma\\.practice\\.create.*blocks.*create"
    - from: "src/app/api/practice-templates/route.ts"
      to: "createPracticeTemplateSchema"
      via: "validation import"
      pattern: "createPracticeTemplateSchema"
---

<objective>
Build the template system API: practice templates (full practice structure) and block templates (reusable individual blocks).

Purpose: Templates enable coaches to quickly create practices from saved structures, improving efficiency for recurring practice patterns.
Output: Complete template CRUD API with apply functionality for creating practices from templates.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-practice-scheduling/02-CONTEXT.md
@.planning/phases/02-practice-scheduling/02-RESEARCH.md
@.planning/phases/02-practice-scheduling/02-01-SUMMARY.md
@.planning/phases/02-practice-scheduling/02-02-SUMMARY.md

# Established patterns
@src/app/api/practices/route.ts
@src/lib/validations/template.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create practice template CRUD API</name>
  <files>src/app/api/practice-templates/route.ts, src/app/api/practice-templates/[id]/route.ts</files>
  <action>
Create src/app/api/practice-templates/route.ts:

GET /api/practice-templates:
- Auth: require team_id, COACH role
- List all practice templates for team
- Include blocks ordered by position
- Order by name ASC
- Return { templates: PracticeTemplate[] }

POST /api/practice-templates:
- Auth: require COACH role
- Validate body with createPracticeTemplateSchema
- Create template with nested blocks (assign position from array index)
- Return { template } with status 201

Create src/app/api/practice-templates/[id]/route.ts:

GET /api/practice-templates/[id]:
- Auth: require COACH role
- Fetch template with blocks
- Verify ownership (teamId match)
- Return { template }

PATCH /api/practice-templates/[id]:
- Auth: require COACH role
- Validate body with updatePracticeTemplateSchema
- Only update template fields (name, defaultStartTime, defaultEndTime)
- For blocks: use same pattern as practice blocks (separate add/remove/reorder or replace all)
- Simple approach: Accept optional blocks array, if provided, delete all existing and recreate
- Return { template }

DELETE /api/practice-templates/[id]:
- Auth: require COACH role
- Verify ownership
- Delete template (blocks cascade)
- Return 204

Follow established API patterns from practices/route.ts.
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors</verify>
  <done>Practice template CRUD endpoints functional</done>
</task>

<task type="auto">
  <name>Task 2: Create template apply endpoint</name>
  <files>src/app/api/practice-templates/apply/route.ts</files>
  <action>
Create src/app/api/practice-templates/apply/route.ts:

POST /api/practice-templates/apply:
- Auth: require COACH role
- Request body:
```typescript
const applyTemplateSchema = z.object({
  templateId: z.string().uuid(),
  seasonId: z.string().uuid(),
  date: z.string().datetime(), // The date for the new practice
  name: z.string().min(1).max(100).optional(), // Override template name
});
```

Implementation (copy-on-apply pattern):
1. Fetch template with blocks
2. Verify template ownership
3. Combine date with template's defaultStartTime/defaultEndTime:
```typescript
import { parse, format, set } from 'date-fns';

const practiceDate = new Date(validatedData.date);
const [startHour, startMin] = template.defaultStartTime.split(':').map(Number);
const [endHour, endMin] = template.defaultEndTime.split(':').map(Number);

const startTime = set(practiceDate, { hours: startHour, minutes: startMin, seconds: 0 });
const endTime = set(practiceDate, { hours: endHour, minutes: endMin, seconds: 0 });
```

4. Create practice with copied blocks:
```typescript
const practice = await prisma.practice.create({
  data: {
    teamId: claims.team_id,
    seasonId: validatedData.seasonId,
    name: validatedData.name || template.name,
    date: practiceDate,
    startTime,
    endTime,
    status: 'DRAFT',
    blocks: {
      create: template.blocks.map((block, index) => ({
        position: index,
        type: block.type,
        durationMinutes: block.durationMinutes,
        category: block.category,
        notes: block.notes,
      }))
    }
  },
  include: {
    blocks: { orderBy: { position: 'asc' } }
  }
});
```

5. Return { practice } with status 201

Key: This creates an independent copy. Editing the template later does NOT affect this practice.
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors</verify>
  <done>Apply template creates independent practice copy</done>
</task>

<task type="auto">
  <name>Task 3: Create block template CRUD API</name>
  <files>src/app/api/block-templates/route.ts, src/app/api/block-templates/[id]/route.ts</files>
  <action>
Create src/app/api/block-templates/route.ts:

GET /api/block-templates:
- Auth: require team_id, COACH role
- Query param: type (optional filter by BlockType)
- List all block templates for team
- Order by type ASC, name ASC
- Return { templates: BlockTemplate[] }

POST /api/block-templates:
- Auth: require COACH role
- Validate body with createBlockTemplateSchema
- Create block template
- Return { template } with status 201

Create src/app/api/block-templates/[id]/route.ts:

GET /api/block-templates/[id]:
- Auth: require COACH role
- Fetch template
- Verify ownership
- Return { template }

PATCH /api/block-templates/[id]:
- Auth: require COACH role
- Validate body with updateBlockTemplateSchema
- Update template
- Return { template }

DELETE /api/block-templates/[id]:
- Auth: require COACH role
- Verify ownership
- Delete template
- Return 204

Note: Block templates are simpler than practice templates - no nested structure. They're used when building practices manually (coach can insert a saved block into any practice).
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors</verify>
  <done>Block template CRUD endpoints functional</done>
</task>

</tasks>

<verification>
All checks must pass:
1. `npx tsc --noEmit` - all files compile
2. Practice template CRUD works (create, read, update, delete)
3. Block template CRUD works
4. Apply template creates practice with copied blocks
5. Created practice is independent (no reference back to template)
6. All endpoints require COACH role
</verification>

<success_criteria>
- Coach can save practice structure as template (PRAC-03)
- Coach can apply template to create new practice
- Coach can manage reusable block templates
- Template edits don't affect existing practices (copy-on-apply)
- All templates are team-scoped
</success_criteria>

<output>
After completion, create `.planning/phases/02-practice-scheduling/02-04-SUMMARY.md`
</output>
