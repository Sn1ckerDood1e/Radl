---
phase: 02-practice-scheduling
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/practices/equipment-availability-panel.tsx
  - src/components/practices/practice-form.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Coach can see equipment availability when creating a practice"
    - "Unavailable equipment is visually differentiated from available"
    - "Coach can see reason why equipment is unavailable"
    - "Equipment panel is collapsible to not clutter the form"
  artifacts:
    - path: "src/components/practices/equipment-availability-panel.tsx"
      provides: "Collapsible panel showing equipment with readiness status"
      exports: ["EquipmentAvailabilityPanel"]
    - path: "src/components/practices/practice-form.tsx"
      provides: "Practice form with equipment availability section"
      contains: "EquipmentAvailabilityPanel"
  key_links:
    - from: "src/components/practices/equipment-availability-panel.tsx"
      to: "/api/equipment"
      via: "fetch GET"
      pattern: "fetch.*api/equipment"
    - from: "src/components/practices/practice-form.tsx"
      to: "equipment-availability-panel.tsx"
      via: "import and render"
      pattern: "EquipmentAvailabilityPanel"
---

<objective>
Add equipment availability display to the practice form so coaches can see which equipment is available/unavailable when planning a practice.

Purpose: The equipment readiness API exists and returns isAvailable/unavailableReasons, but the practice form does not display this information. Coaches need visibility into equipment status when planning to avoid assigning damaged boats.

Output: Collapsible equipment availability panel in practice-form.tsx showing equipment status with visual differentiation and unavailability reasons.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-practice-scheduling/02-03-SUMMARY.md

# Existing API (already built, returns readiness)
@src/app/api/equipment/route.ts
@src/lib/equipment/readiness.ts

# Target file to modify
@src/components/practices/practice-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create equipment availability panel component</name>
  <files>src/components/practices/equipment-availability-panel.tsx</files>
  <action>
Create src/components/practices/equipment-availability-panel.tsx:

A collapsible panel that fetches and displays equipment availability:
```typescript
'use client';

import { useState, useEffect } from 'react';
import { ChevronDown, ChevronUp, AlertTriangle, CheckCircle, Ship, Anchor } from 'lucide-react';

interface EquipmentItem {
  id: string;
  name: string;
  type: string;
  boatClass: string | null;
  isAvailable: boolean;
  unavailableReasons: string[];
}

interface EquipmentAvailabilityPanelProps {
  className?: string;
}

export function EquipmentAvailabilityPanel({ className }: EquipmentAvailabilityPanelProps) {
  const [isExpanded, setIsExpanded] = useState(false);
  const [equipment, setEquipment] = useState<EquipmentItem[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [hasFetched, setHasFetched] = useState(false);

  // Lazy load: only fetch when panel is expanded for the first time
  useEffect(() => {
    if (isExpanded && !hasFetched) {
      fetchEquipment();
    }
  }, [isExpanded, hasFetched]);

  const fetchEquipment = async () => {
    setIsLoading(true);
    setError(null);
    try {
      const response = await fetch('/api/equipment');
      if (!response.ok) throw new Error('Failed to load equipment');
      const data = await response.json();
      setEquipment(data.equipment);
      setHasFetched(true);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to load equipment');
    } finally {
      setIsLoading(false);
    }
  };

  // Count available vs unavailable
  const availableCount = equipment.filter(e => e.isAvailable).length;
  const unavailableCount = equipment.filter(e => !e.isAvailable).length;

  // Group by type (SHELL, OAR, LAUNCH, OTHER)
  const groupedEquipment = equipment.reduce((acc, item) => {
    const group = acc[item.type] || [];
    group.push(item);
    acc[item.type] = group;
    return acc;
  }, {} as Record<string, EquipmentItem[]>);

  const typeOrder = ['SHELL', 'OAR', 'LAUNCH', 'OTHER'];
  const typeLabels: Record<string, string> = {
    SHELL: 'Boats',
    OAR: 'Oars',
    LAUNCH: 'Launches',
    OTHER: 'Other Equipment',
  };

  return (
    <div className={`border border-zinc-700 rounded-lg bg-zinc-800/50 ${className || ''}`}>
      {/* Header - always visible */}
      <button
        type="button"
        onClick={() => setIsExpanded(!isExpanded)}
        className="w-full px-4 py-3 flex items-center justify-between text-left hover:bg-zinc-800 transition-colors rounded-lg"
      >
        <div className="flex items-center gap-2">
          <Ship className="h-4 w-4 text-zinc-400" />
          <span className="text-sm font-medium text-zinc-300">Equipment Availability</span>
          {hasFetched && (
            <span className="text-xs text-zinc-500">
              ({availableCount} available{unavailableCount > 0 ? `, ${unavailableCount} unavailable` : ''})
            </span>
          )}
        </div>
        {isExpanded ? (
          <ChevronUp className="h-4 w-4 text-zinc-500" />
        ) : (
          <ChevronDown className="h-4 w-4 text-zinc-500" />
        )}
      </button>

      {/* Expanded content */}
      {isExpanded && (
        <div className="px-4 pb-4 border-t border-zinc-700">
          {isLoading && (
            <p className="text-sm text-zinc-500 py-4 text-center">Loading equipment...</p>
          )}

          {error && (
            <p className="text-sm text-red-400 py-4 text-center">{error}</p>
          )}

          {!isLoading && !error && equipment.length === 0 && (
            <p className="text-sm text-zinc-500 py-4 text-center">No equipment found</p>
          )}

          {!isLoading && !error && equipment.length > 0 && (
            <div className="space-y-4 pt-3">
              {/* Unavailable equipment alert */}
              {unavailableCount > 0 && (
                <div className="flex items-start gap-2 p-3 bg-amber-500/10 border border-amber-500/30 rounded-lg">
                  <AlertTriangle className="h-4 w-4 text-amber-400 mt-0.5 flex-shrink-0" />
                  <p className="text-xs text-amber-300">
                    {unavailableCount} piece{unavailableCount > 1 ? 's' : ''} of equipment {unavailableCount > 1 ? 'are' : 'is'} currently unavailable due to damage or maintenance.
                  </p>
                </div>
              )}

              {/* Equipment list grouped by type */}
              {typeOrder
                .filter(type => groupedEquipment[type]?.length > 0)
                .map(type => (
                  <div key={type}>
                    <h4 className="text-xs font-medium text-zinc-500 uppercase tracking-wide mb-2">
                      {typeLabels[type]}
                    </h4>
                    <div className="space-y-1">
                      {groupedEquipment[type].map(item => (
                        <EquipmentRow key={item.id} item={item} />
                      ))}
                    </div>
                  </div>
                ))}
            </div>
          )}

          {/* Info note */}
          <p className="text-xs text-zinc-600 mt-4 pt-3 border-t border-zinc-700">
            Equipment assignment happens in lineups (Phase 3). This panel shows current availability for planning.
          </p>
        </div>
      )}
    </div>
  );
}

function EquipmentRow({ item }: { item: EquipmentItem }) {
  const [showReasons, setShowReasons] = useState(false);

  if (item.isAvailable) {
    return (
      <div className="flex items-center gap-2 py-1.5 px-2 rounded bg-zinc-800/50">
        <CheckCircle className="h-3.5 w-3.5 text-emerald-500 flex-shrink-0" />
        <span className="text-sm text-zinc-300">{item.name}</span>
        {item.boatClass && (
          <span className="text-xs text-zinc-500">({item.boatClass})</span>
        )}
      </div>
    );
  }

  return (
    <div className="py-1.5 px-2 rounded bg-red-500/5 border border-red-500/10">
      <button
        type="button"
        onClick={() => setShowReasons(!showReasons)}
        className="w-full flex items-center gap-2 text-left"
      >
        <AlertTriangle className="h-3.5 w-3.5 text-red-400 flex-shrink-0" />
        <span className="text-sm text-zinc-400 line-through">{item.name}</span>
        {item.boatClass && (
          <span className="text-xs text-zinc-600 line-through">({item.boatClass})</span>
        )}
        <span className="text-xs text-red-400 ml-auto">Unavailable</span>
      </button>
      {showReasons && item.unavailableReasons.length > 0 && (
        <ul className="mt-2 ml-5 space-y-1">
          {item.unavailableReasons.map((reason, idx) => (
            <li key={idx} className="text-xs text-red-300/70">
              - {reason}
            </li>
          ))}
        </ul>
      )}
    </div>
  );
}
```

Features:
- Collapsed by default (minimizes visual clutter)
- Lazy loads equipment data only when expanded
- Groups equipment by type (SHELL, OAR, LAUNCH, OTHER)
- Shows available equipment with green checkmark
- Shows unavailable equipment with red styling, strikethrough name
- Click unavailable item to reveal reasons (damage reports, manual override)
- Summary in header shows counts at a glance
- Warning banner when any equipment is unavailable
- Informational note explaining this is for visibility, not assignment (that's Phase 3)
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors</verify>
  <done>Equipment availability panel component created with lazy loading and status display</done>
</task>

<task type="auto">
  <name>Task 2: Integrate equipment panel into practice form</name>
  <files>src/components/practices/practice-form.tsx</files>
  <action>
Modify src/components/practices/practice-form.tsx:

Add the EquipmentAvailabilityPanel below the blocks section (before submit buttons):

1. Add import at top:
```typescript
import { EquipmentAvailabilityPanel } from './equipment-availability-panel';
```

2. Add section between blocks and submit buttons (around line 265, after the Blocks Section div):
```tsx
{/* Equipment Availability Section */}
<div>
  <label className={labelClassName}>
    Equipment Status
  </label>
  <p className="text-xs text-zinc-500 mt-1 mb-3">
    Review equipment availability before planning your practice
  </p>
  <EquipmentAvailabilityPanel />
</div>
```

Place this new section:
- AFTER the Blocks section (line ~265)
- BEFORE the Submit Buttons div (which starts with the border-t)

The existing form structure is:
1. Error display
2. Hidden seasonId
3. Name input
4. Date/Time row
5. Notes textarea
6. Blocks section
7. **NEW: Equipment Availability section**
8. Submit buttons

This placement makes sense because:
- Equipment info is relevant context for practice planning
- It's informational, not a form field, so it goes after main inputs
- Before submit buttons keeps workflow clean
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors.
Equipment panel appears in practice form.
Panel is collapsed by default.
Expanding panel fetches and displays equipment with availability status.
  </verify>
  <done>Equipment availability panel integrated into practice form</done>
</task>

</tasks>

<verification>
All checks must pass:
1. `npx tsc --noEmit` - all files compile
2. /[teamSlug]/practices/new shows equipment availability panel
3. Panel is collapsed by default
4. Expanding panel shows equipment grouped by type
5. Available equipment shown with green indicator
6. Unavailable equipment shown with red styling and strikethrough
7. Clicking unavailable equipment shows reasons
8. Edit practice page also shows equipment panel
</verification>

<success_criteria>
- Coach can see equipment marked unavailable when planning a practice (EQUIP-02)
- Equipment availability is visually clear (available vs unavailable)
- Unavailability reasons are accessible (damage reports, manual override)
- Panel does not clutter form when collapsed
- Panel lazy loads to avoid unnecessary API calls
</success_criteria>

<output>
After completion, create `.planning/phases/02-practice-scheduling/02-08-SUMMARY.md`
</output>
