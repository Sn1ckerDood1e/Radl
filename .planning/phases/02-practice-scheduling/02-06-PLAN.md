---
phase: 02-practice-scheduling
plan: 06
type: execute
wave: 4
depends_on: ["02-02", "02-03", "02-05"]
files_modified:
  - src/app/(dashboard)/[teamSlug]/schedule/page.tsx
  - src/components/calendar/unified-calendar.tsx
  - src/components/calendar/calendar-day.tsx
  - src/components/calendar/practice-card.tsx
  - src/components/calendar/regatta-card.tsx
  - src/app/api/schedule/route.ts
autonomous: false

must_haves:
  truths:
    - "Coach and athlete can view unified calendar"
    - "Calendar shows practices and regattas together"
    - "Clicking a date shows events for that day"
    - "Unavailable equipment shows warning when assigning"
  artifacts:
    - path: "src/app/(dashboard)/[teamSlug]/schedule/page.tsx"
      provides: "Schedule/calendar page"
      min_lines: 30
    - path: "src/components/calendar/unified-calendar.tsx"
      provides: "Main calendar component"
      exports: ["UnifiedCalendar"]
    - path: "src/components/calendar/practice-card.tsx"
      provides: "Minimal practice card for calendar"
      exports: ["PracticeCard"]
    - path: "src/app/api/schedule/route.ts"
      provides: "Combined practices + regattas endpoint"
      exports: ["GET"]
  key_links:
    - from: "src/components/calendar/unified-calendar.tsx"
      to: "react-day-picker"
      via: "DayPicker import"
      pattern: "import.*DayPicker.*react-day-picker"
    - from: "src/app/api/schedule/route.ts"
      to: "prisma.practice"
      via: "query practices"
      pattern: "prisma\\.practice\\.findMany"
---

<objective>
Build the unified calendar view showing practices and regattas, with equipment availability warnings.

Purpose: This is the primary interface for viewing the team schedule - coaches use it for planning, athletes use it to see their schedule.
Output: Working calendar page with practice/regatta cards and equipment availability integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-practice-scheduling/02-CONTEXT.md
@.planning/phases/02-practice-scheduling/02-RESEARCH.md
@.planning/phases/02-practice-scheduling/02-02-SUMMARY.md
@.planning/phases/02-practice-scheduling/02-03-SUMMARY.md
@.planning/phases/02-practice-scheduling/02-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install calendar dependencies and create schedule API</name>
  <files>package.json, src/app/api/schedule/route.ts</files>
  <action>
Install dependencies:
```bash
npm install react-day-picker date-fns
```

Create src/app/api/schedule/route.ts:

GET /api/schedule - Unified endpoint for calendar data:
- Auth: require team_id
- Query params:
  - seasonId (optional, defaults to any active season)
  - startDate, endDate (required for range query)
- Fetch both practices and regattas in date range
- Athletes only see PUBLISHED practices
- Return combined data:
```typescript
interface ScheduleEvent {
  id: string;
  type: 'practice' | 'regatta';
  name: string;
  date: string; // ISO date
  startTime: string; // ISO datetime
  endTime?: string; // ISO datetime
  status?: 'DRAFT' | 'PUBLISHED'; // practices only
  location?: string; // regattas only
}

// Response
{ events: ScheduleEvent[] }
```

Query both in parallel:
```typescript
const [practices, regattas] = await Promise.all([
  prisma.practice.findMany({
    where: {
      teamId: claims.team_id,
      date: { gte: new Date(startDate), lte: new Date(endDate) },
      ...(claims.user_role !== 'COACH' ? { status: 'PUBLISHED' } : {}),
    },
    select: { id: true, name: true, date: true, startTime: true, endTime: true, status: true },
    orderBy: { startTime: 'asc' },
  }),
  prisma.regatta.findMany({
    where: {
      teamId: claims.team_id,
      startDate: { gte: new Date(startDate), lte: new Date(endDate) },
    },
    select: { id: true, name: true, startDate: true, endDate: true, location: true },
    orderBy: { startDate: 'asc' },
  }),
]);
```

Transform to ScheduleEvent[] and return.
  </action>
  <verify>
Run `npm ls react-day-picker` - package installed
Run `npx tsc --noEmit` - no type errors
  </verify>
  <done>Calendar dependencies installed, schedule API returns unified event data</done>
</task>

<task type="auto">
  <name>Task 2: Create calendar components</name>
  <files>src/components/calendar/unified-calendar.tsx, src/components/calendar/calendar-day.tsx, src/components/calendar/practice-card.tsx, src/components/calendar/regatta-card.tsx</files>
  <action>
Create src/components/calendar/practice-card.tsx:

Minimal practice card (per CONTEXT.md - time + name only):
```typescript
'use client';

import { format } from 'date-fns';
import Link from 'next/link';

interface PracticeCardProps {
  practice: {
    id: string;
    name: string;
    startTime: string;
    status: 'DRAFT' | 'PUBLISHED';
  };
  teamSlug: string;
  isCoach: boolean;
}

export function PracticeCard({ practice, teamSlug, isCoach }: PracticeCardProps) {
  const time = format(new Date(practice.startTime), 'h:mm a');
  const isDraft = practice.status === 'DRAFT';

  return (
    <Link
      href={`/${teamSlug}/practices/${practice.id}`}
      className={`block p-2 rounded-md border ${
        isDraft
          ? 'border-yellow-500/50 bg-yellow-500/10'
          : 'border-zinc-700 bg-zinc-800 hover:bg-zinc-700'
      }`}
    >
      <div className="flex items-center gap-2">
        <span className="text-xs text-zinc-400">{time}</span>
        <span className="text-sm font-medium truncate">{practice.name}</span>
        {isDraft && isCoach && (
          <span className="text-xs px-1.5 py-0.5 rounded bg-yellow-500/20 text-yellow-400">
            Draft
          </span>
        )}
      </div>
    </Link>
  );
}
```

Create src/components/calendar/regatta-card.tsx:

Regatta placeholder card:
```typescript
'use client';

import { MapPin } from 'lucide-react';

interface RegattaCardProps {
  regatta: {
    id: string;
    name: string;
    location?: string;
  };
  teamSlug: string;
}

export function RegattaCard({ regatta, teamSlug }: RegattaCardProps) {
  return (
    <div className="p-2 rounded-md border border-emerald-500/50 bg-emerald-500/10">
      <div className="flex items-center gap-2">
        <span className="text-sm font-medium text-emerald-400">{regatta.name}</span>
      </div>
      {regatta.location && (
        <div className="flex items-center gap-1 mt-1 text-xs text-zinc-400">
          <MapPin className="h-3 w-3" />
          <span>{regatta.location}</span>
        </div>
      )}
    </div>
  );
}
```

Create src/components/calendar/unified-calendar.tsx:

Main calendar using react-day-picker:
```typescript
'use client';

import { useState, useEffect } from 'react';
import { DayPicker } from 'react-day-picker';
import { format, startOfMonth, endOfMonth, isSameDay, addMonths, subMonths } from 'date-fns';
import { ChevronLeft, ChevronRight, Plus } from 'lucide-react';
import { PracticeCard } from './practice-card';
import { RegattaCard } from './regatta-card';
import Link from 'next/link';
import 'react-day-picker/style.css';

interface ScheduleEvent {
  id: string;
  type: 'practice' | 'regatta';
  name: string;
  date: string;
  startTime: string;
  endTime?: string;
  status?: 'DRAFT' | 'PUBLISHED';
  location?: string;
}

interface UnifiedCalendarProps {
  teamSlug: string;
  seasonId?: string;
  isCoach: boolean;
}

export function UnifiedCalendar({ teamSlug, seasonId, isCoach }: UnifiedCalendarProps) {
  const [month, setMonth] = useState(new Date());
  const [selectedDate, setSelectedDate] = useState<Date | undefined>(new Date());
  const [events, setEvents] = useState<ScheduleEvent[]>([]);
  const [loading, setLoading] = useState(true);

  // Fetch events for current month view
  useEffect(() => {
    const fetchEvents = async () => {
      setLoading(true);
      const start = startOfMonth(month);
      const end = endOfMonth(month);
      const params = new URLSearchParams({
        startDate: start.toISOString(),
        endDate: end.toISOString(),
        ...(seasonId && { seasonId }),
      });

      try {
        const res = await fetch(`/api/schedule?${params}`);
        if (res.ok) {
          const data = await res.json();
          setEvents(data.events);
        }
      } catch (err) {
        console.error('Failed to fetch schedule:', err);
      } finally {
        setLoading(false);
      }
    };

    fetchEvents();
  }, [month, seasonId]);

  // Events for selected date
  const selectedEvents = selectedDate
    ? events.filter(e => isSameDay(new Date(e.date), selectedDate))
    : [];

  // Days that have events (for highlighting)
  const eventDates = events.map(e => new Date(e.date));

  return (
    <div className="flex flex-col lg:flex-row gap-6">
      {/* Calendar picker */}
      <div className="flex-shrink-0">
        <div className="flex items-center justify-between mb-4">
          <button
            onClick={() => setMonth(subMonths(month, 1))}
            className="p-2 hover:bg-zinc-800 rounded"
          >
            <ChevronLeft className="h-5 w-5" />
          </button>
          <h2 className="text-lg font-semibold">
            {format(month, 'MMMM yyyy')}
          </h2>
          <button
            onClick={() => setMonth(addMonths(month, 1))}
            className="p-2 hover:bg-zinc-800 rounded"
          >
            <ChevronRight className="h-5 w-5" />
          </button>
        </div>

        <DayPicker
          mode="single"
          selected={selectedDate}
          onSelect={setSelectedDate}
          month={month}
          onMonthChange={setMonth}
          modifiers={{ hasEvent: eventDates }}
          modifiersClassNames={{
            hasEvent: 'font-bold text-emerald-400',
            selected: 'bg-emerald-600 text-white',
            today: 'border border-emerald-500',
          }}
          className="text-zinc-100"
        />
      </div>

      {/* Event list for selected date */}
      <div className="flex-1 min-w-0">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-lg font-semibold">
            {selectedDate ? format(selectedDate, 'EEEE, MMMM d') : 'Select a date'}
          </h3>
          {isCoach && selectedDate && (
            <Link
              href={`/${teamSlug}/practices/new?date=${format(selectedDate, 'yyyy-MM-dd')}`}
              className="flex items-center gap-1 px-3 py-1.5 text-sm bg-emerald-600 hover:bg-emerald-700 rounded-md"
            >
              <Plus className="h-4 w-4" />
              Add Practice
            </Link>
          )}
        </div>

        {loading ? (
          <div className="text-zinc-500">Loading...</div>
        ) : selectedEvents.length > 0 ? (
          <div className="space-y-2">
            {selectedEvents.map(event =>
              event.type === 'practice' ? (
                <PracticeCard
                  key={event.id}
                  practice={{
                    id: event.id,
                    name: event.name,
                    startTime: event.startTime,
                    status: event.status!,
                  }}
                  teamSlug={teamSlug}
                  isCoach={isCoach}
                />
              ) : (
                <RegattaCard
                  key={event.id}
                  regatta={{
                    id: event.id,
                    name: event.name,
                    location: event.location,
                  }}
                  teamSlug={teamSlug}
                />
              )
            )}
          </div>
        ) : selectedDate ? (
          <p className="text-zinc-500">No events scheduled</p>
        ) : null}
      </div>
    </div>
  );
}
```

Style the calendar to match dark theme - may need to override react-day-picker CSS variables.
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors</verify>
  <done>Calendar components created with practice and regatta cards</done>
</task>

<task type="auto">
  <name>Task 3: Create schedule page</name>
  <files>src/app/(dashboard)/[teamSlug]/schedule/page.tsx</files>
  <action>
Create src/app/(dashboard)/[teamSlug]/schedule/page.tsx:

Server component wrapper for calendar:
```typescript
import { cookies } from 'next/headers';
import { createClient } from '@/lib/supabase/server';
import { prisma } from '@/lib/prisma';
import { redirect } from 'next/navigation';
import { UnifiedCalendar } from '@/components/calendar/unified-calendar';

interface SchedulePageProps {
  params: Promise<{ teamSlug: string }>;
  searchParams: Promise<{ seasonId?: string }>;
}

export default async function SchedulePage({ params, searchParams }: SchedulePageProps) {
  const { teamSlug } = await params;
  const { seasonId } = await searchParams;

  // Get user and team context
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    redirect('/login');
  }

  // Get team member to check role
  const team = await prisma.team.findUnique({
    where: { slug: teamSlug },
    select: { id: true, name: true },
  });

  if (!team) {
    redirect('/');
  }

  const teamMember = await prisma.teamMember.findFirst({
    where: { teamId: team.id, userId: user.id },
    select: { role: true },
  });

  if (!teamMember) {
    redirect('/');
  }

  const isCoach = teamMember.role === 'COACH';

  // Get active seasons for season selector
  const seasons = await prisma.season.findMany({
    where: { teamId: team.id, status: 'ACTIVE' },
    orderBy: { startDate: 'desc' },
    select: { id: true, name: true },
  });

  return (
    <div className="p-6">
      <div className="flex items-center justify-between mb-6">
        <h1 className="text-2xl font-bold">Schedule</h1>
        {seasons.length > 1 && (
          <SeasonSelector seasons={seasons} currentSeasonId={seasonId} teamSlug={teamSlug} />
        )}
      </div>

      <UnifiedCalendar
        teamSlug={teamSlug}
        seasonId={seasonId || seasons[0]?.id}
        isCoach={isCoach}
      />
    </div>
  );
}

// Client component for season switching
'use client';
function SeasonSelector({
  seasons,
  currentSeasonId,
  teamSlug,
}: {
  seasons: { id: string; name: string }[];
  currentSeasonId?: string;
  teamSlug: string;
}) {
  const router = useRouter();

  return (
    <select
      value={currentSeasonId || ''}
      onChange={(e) => {
        const url = e.target.value
          ? `/${teamSlug}/schedule?seasonId=${e.target.value}`
          : `/${teamSlug}/schedule`;
        router.push(url);
      }}
      className="bg-zinc-800 border border-zinc-700 rounded px-3 py-1.5 text-sm"
    >
      {seasons.map((season) => (
        <option key={season.id} value={season.id}>
          {season.name}
        </option>
      ))}
    </select>
  );
}
```

Note: The SeasonSelector needs to be in a separate client component file if using 'use client'. Extract to src/components/calendar/season-selector.tsx.
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors</verify>
  <done>Schedule page renders unified calendar with season selector</done>
</task>

</tasks>

<verification>
All checks must pass:
1. `npx tsc --noEmit` - all files compile
2. react-day-picker and date-fns installed
3. /[teamSlug]/schedule renders calendar
4. Calendar shows practices with correct styling
5. Calendar shows regatta placeholders
6. Clicking date shows events for that day
7. Coach sees draft practices, athlete only sees published
</verification>

<success_criteria>
- Unified calendar shows practices and regattas (PRAC-04)
- Both coach and athlete can view calendar
- Coach sees draft practices, athlete only sees published
- Day selection shows event list
- Quick-add practice link for coaches
- Season filtering works
</success_criteria>

<checkpoint type="human-verify">
  <what-built>Unified calendar view with practices and regatta placeholders</what-built>
  <how-to-verify>
1. Visit /[teamSlug]/schedule as a coach
2. Verify calendar renders with month navigation
3. Create a practice from the practices page
4. Verify practice appears on calendar
5. Click the date to see practice card
6. Verify draft practices show with yellow styling
7. Switch to athlete view (if possible) and verify only published practices show
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</checkpoint>

<output>
After completion, create `.planning/phases/02-practice-scheduling/02-06-SUMMARY.md`
</output>
