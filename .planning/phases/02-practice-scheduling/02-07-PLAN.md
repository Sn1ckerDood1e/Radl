---
phase: 02-practice-scheduling
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/[teamSlug]/practice-templates/page.tsx
  - src/app/(dashboard)/[teamSlug]/practice-templates/new/page.tsx
  - src/app/(dashboard)/[teamSlug]/practice-templates/[id]/page.tsx
  - src/components/templates/template-form.tsx
  - src/components/templates/template-card.tsx
  - src/app/(dashboard)/[teamSlug]/practices/new/page.tsx
  - src/app/(dashboard)/[teamSlug]/practices/[id]/practice-detail-client.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Coach can view list of practice templates"
    - "Coach can create a new practice template"
    - "Coach can edit an existing template"
    - "Coach can save a practice structure as a template"
    - "Coach can apply a template when creating a new practice"
  artifacts:
    - path: "src/app/(dashboard)/[teamSlug]/practice-templates/page.tsx"
      provides: "Template list page"
      min_lines: 40
    - path: "src/components/templates/template-form.tsx"
      provides: "Template create/edit form"
      exports: ["TemplateForm"]
    - path: "src/app/(dashboard)/[teamSlug]/practices/[id]/practice-detail-client.tsx"
      provides: "Save as Template button"
      contains: "Save as Template"
  key_links:
    - from: "src/app/(dashboard)/[teamSlug]/practice-templates/page.tsx"
      to: "/api/practice-templates"
      via: "server component fetch"
      pattern: "prisma.practiceTemplate.findMany"
    - from: "src/components/templates/template-form.tsx"
      to: "/api/practice-templates"
      via: "fetch POST/PATCH"
      pattern: "fetch.*api/practice-templates"
    - from: "src/app/(dashboard)/[teamSlug]/practices/new/page.tsx"
      to: "/api/practice-templates/apply"
      via: "ApplyTemplateModal fetch"
      pattern: "fetch.*practice-templates/apply"
---

<objective>
Build the template system UI to enable coaches to create, manage, and apply practice templates.

Purpose: The template API exists but has no frontend integration. Coaches cannot currently use the template system despite the backend being ready. This gap closure adds the missing UI layer.

Output: Functional template management pages, Save as Template button on practice detail, and Apply Template option on new practice page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-practice-scheduling/02-04-SUMMARY.md

# Existing API routes (already built, no changes needed)
@src/app/api/practice-templates/route.ts
@src/app/api/practice-templates/[id]/route.ts
@src/app/api/practice-templates/apply/route.ts

# Existing UI patterns to follow
@src/components/practices/practice-form.tsx
@src/app/(dashboard)/[teamSlug]/practices/new/page.tsx
@src/app/(dashboard)/[teamSlug]/practices/[id]/practice-detail-client.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create template list and card components</name>
  <files>src/app/(dashboard)/[teamSlug]/practice-templates/page.tsx, src/components/templates/template-card.tsx</files>
  <action>
Create src/components/templates/template-card.tsx:

A card component for displaying a practice template in a list:
```typescript
'use client';

import Link from 'next/link';
import { Clock, Layers } from 'lucide-react';
import type { BlockType } from '@/lib/validations/practice';

interface TemplateCardProps {
  template: {
    id: string;
    name: string;
    defaultStartTime: string;
    defaultEndTime: string;
    blocks: Array<{ type: BlockType }>;
  };
  teamSlug: string;
}
```

Features:
- Display template name as link to detail page
- Show default time range (e.g., "06:00 - 08:00")
- Show block count with type breakdown (e.g., "3 blocks: 2 Water, 1 Land")
- Use zinc/emerald dark theme matching existing cards

Create src/app/(dashboard)/[teamSlug]/practice-templates/page.tsx:

Server component listing all practice templates for the team:
- Require COACH role (use requireRole from @/lib/auth/authorize)
- Query prisma.practiceTemplate.findMany with blocks included
- Display TemplateCard for each template in a grid
- "New Template" button linking to /practice-templates/new
- Empty state: "No templates yet. Create your first template to save practice structures."
- Add breadcrumb navigation

Follow pattern from src/app/(dashboard)/[teamSlug]/practices/page.tsx.
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors. Template list page renders.</verify>
  <done>Template list page at /[teamSlug]/practice-templates displays templates</done>
</task>

<task type="auto">
  <name>Task 2: Create template form and create/edit pages</name>
  <files>src/components/templates/template-form.tsx, src/app/(dashboard)/[teamSlug]/practice-templates/new/page.tsx, src/app/(dashboard)/[teamSlug]/practice-templates/[id]/page.tsx</files>
  <action>
Create src/components/templates/template-form.tsx:

A form for creating/editing practice templates, similar to practice-form.tsx:
```typescript
'use client';

import { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { useRouter } from 'next/navigation';
import { BlockEditor } from '@/components/practices/block-editor';
import { z } from 'zod';

// Form schema for templates (time as strings HH:MM, not DateTime)
const templateFormSchema = z.object({
  name: z.string().min(1, 'Name is required').max(100),
  defaultStartTime: z.string().regex(/^\d{2}:\d{2}$/, 'Use HH:MM format'),
  defaultEndTime: z.string().regex(/^\d{2}:\d{2}$/, 'Use HH:MM format'),
  blocks: z.array(z.object({
    type: z.enum(['WATER', 'LAND', 'ERG']),
    durationMinutes: z.number().positive().optional().nullable(),
    category: z.string().optional().nullable(),
    notes: z.string().optional().nullable(),
  })).min(1, 'At least one block required'),
});

interface TemplateFormProps {
  teamSlug: string;
  template?: {
    id: string;
    name: string;
    defaultStartTime: string;
    defaultEndTime: string;
    blocks: Array<{
      id: string;
      type: BlockType;
      durationMinutes?: number | null;
      category?: string | null;
      notes?: string | null;
    }>;
  };
  onSuccess?: () => void;
}
```

Form fields:
- name: text input
- defaultStartTime: time input (type="time")
- defaultEndTime: time input (type="time")
- blocks: Reuse BlockEditor component from practices

Submit:
- Create mode: POST to /api/practice-templates
- Edit mode: PATCH to /api/practice-templates/[id]
- Redirect to template detail on success

Create src/app/(dashboard)/[teamSlug]/practice-templates/new/page.tsx:

Server component wrapper:
- Require COACH role
- Render TemplateForm in create mode
- Add breadcrumb: Practice Templates / New Template

Create src/app/(dashboard)/[teamSlug]/practice-templates/[id]/page.tsx:

Server component for template detail/edit:
- Require COACH role
- Fetch template with blocks from prisma
- Display template details (name, times, blocks)
- "Edit" button toggles to TemplateForm in edit mode
- "Delete" button with confirmation
- "Apply Template" button links to new practice page with template pre-selected
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors. Create and edit forms work.</verify>
  <done>Template create/edit pages functional with form validation</done>
</task>

<task type="auto">
  <name>Task 3: Add Save as Template and Apply Template integrations</name>
  <files>src/app/(dashboard)/[teamSlug]/practices/[id]/practice-detail-client.tsx, src/app/(dashboard)/[teamSlug]/practices/new/page.tsx</files>
  <action>
Modify src/app/(dashboard)/[teamSlug]/practices/[id]/practice-detail-client.tsx:

Add "Save as Template" button for coaches in the header actions (next to Edit/Delete):
```typescript
const [isSavingTemplate, setIsSavingTemplate] = useState(false);

const handleSaveAsTemplate = async () => {
  setIsSavingTemplate(true);
  setError(null);

  try {
    // Convert practice to template format
    const templateData = {
      name: `${practice.name} Template`,
      defaultStartTime: new Date(practice.startTime).toTimeString().slice(0, 5),
      defaultEndTime: new Date(practice.endTime).toTimeString().slice(0, 5),
      blocks: practice.blocks.map(b => ({
        type: b.type,
        durationMinutes: b.durationMinutes,
        category: b.category,
        notes: b.notes,
      })),
    };

    const response = await fetch('/api/practice-templates', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(templateData),
    });

    const result = await response.json();
    if (!response.ok) throw new Error(result.error || 'Failed to save template');

    // Redirect to template detail
    router.push(`/${teamSlug}/practice-templates/${result.template.id}`);
  } catch (err) {
    setError(err instanceof Error ? err.message : 'An error occurred');
  } finally {
    setIsSavingTemplate(false);
  }
};
```

Add button in header (coach only):
```tsx
<button
  onClick={handleSaveAsTemplate}
  disabled={isSavingTemplate}
  className="px-4 py-2 rounded-lg text-sm font-medium text-zinc-300 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 transition-colors"
>
  {isSavingTemplate ? 'Saving...' : 'Save as Template'}
</button>
```

Modify src/app/(dashboard)/[teamSlug]/practices/new/page.tsx:

Add "From Template" section above the form when templates exist:
1. Fetch available templates in server component:
```typescript
const templates = await prisma.practiceTemplate.findMany({
  where: { teamId: team.id },
  include: { blocks: { orderBy: { position: 'asc' } } },
  orderBy: { name: 'asc' },
});
```

2. Add ApplyTemplateSection client component after season selector:
```typescript
// Client component for template selection and application
interface ApplyTemplateSectionProps {
  templates: Array<{
    id: string;
    name: string;
    defaultStartTime: string;
    defaultEndTime: string;
  }>;
  seasonId: string;
  teamSlug: string;
}

function ApplyTemplateSection({ templates, seasonId, teamSlug }: ApplyTemplateSectionProps) {
  const [selectedTemplateId, setSelectedTemplateId] = useState<string>('');
  const [selectedDate, setSelectedDate] = useState<string>('');
  const [isApplying, setIsApplying] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const router = useRouter();

  const handleApply = async () => {
    if (!selectedTemplateId || !selectedDate) return;

    setIsApplying(true);
    setError(null);

    try {
      const response = await fetch('/api/practice-templates/apply', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          templateId: selectedTemplateId,
          seasonId,
          date: new Date(selectedDate).toISOString(),
        }),
      });

      const result = await response.json();
      if (!response.ok) throw new Error(result.error);

      // Redirect to the newly created practice
      router.push(`/${teamSlug}/practices/${result.practice.id}`);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to apply template');
    } finally {
      setIsApplying(false);
    }
  };

  // Render template dropdown, date picker, and Apply button
}
```

3. Display section only when templates.length > 0:
```tsx
{templates.length > 0 && (
  <div className="mb-6 p-4 bg-zinc-900 rounded-lg border border-zinc-800">
    <h3 className="text-sm font-medium text-zinc-300 mb-3">Quick Create from Template</h3>
    <ApplyTemplateSection
      templates={templates}
      seasonId={selectedSeasonId}
      teamSlug={teamSlug}
    />
    <p className="text-xs text-zinc-500 mt-2">Or create a custom practice below</p>
  </div>
)}
```
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors.
Save as Template button appears on practice detail.
Apply Template section appears on new practice page when templates exist.
  </verify>
  <done>Save as Template and Apply Template integrations complete</done>
</task>

</tasks>

<verification>
All checks must pass:
1. `npx tsc --noEmit` - all files compile
2. /[teamSlug]/practice-templates - lists templates (coach only)
3. /[teamSlug]/practice-templates/new - creates template
4. /[teamSlug]/practice-templates/[id] - shows template detail, allows edit/delete
5. Practice detail page shows "Save as Template" button for coaches
6. New practice page shows template selector when templates exist
7. Applying template creates practice and redirects to detail page
</verification>

<success_criteria>
- Coach can save practice structure as template (PRAC-03)
- Coach can apply template to create new practice
- Coach can view, create, edit, delete templates
- Template list shows block summary
- All template UI uses existing dark theme
</success_criteria>

<output>
After completion, create `.planning/phases/02-practice-scheduling/02-07-SUMMARY.md`
</output>
