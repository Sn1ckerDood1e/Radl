---
phase: 02-practice-scheduling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/validations/practice.ts
  - src/lib/validations/template.ts
autonomous: true

must_haves:
  truths:
    - "Practice model exists with team, season, date, time, status fields"
    - "PracticeBlock model exists with position-based ordering"
    - "PracticeTemplate and BlockTemplate models exist for reusable structures"
    - "Equipment has manual unavailability fields"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Practice, PracticeBlock, PracticeTemplate, BlockTemplate, Regatta models; Equipment extensions"
      contains: "model Practice"
    - path: "src/lib/validations/practice.ts"
      provides: "Zod schemas for practice and block validation"
      exports: ["createPracticeSchema", "updatePracticeSchema", "createBlockSchema"]
    - path: "src/lib/validations/template.ts"
      provides: "Zod schemas for template validation"
      exports: ["createPracticeTemplateSchema", "createBlockTemplateSchema"]
  key_links:
    - from: "prisma/schema.prisma"
      to: "Season model"
      via: "Practice.seasonId relation"
      pattern: "seasonId.*String"
    - from: "prisma/schema.prisma"
      to: "Team model"
      via: "Practice.teamId relation"
      pattern: "teamId.*String"
---

<objective>
Create the data foundation for practice scheduling: Prisma models for Practice, PracticeBlock, templates, and regatta placeholders, plus Zod validation schemas.

Purpose: All Phase 2 features require these data models. This is the foundation layer that enables all subsequent plans.
Output: Database schema ready for migration, validation schemas ready for API use.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-practice-scheduling/02-CONTEXT.md
@.planning/phases/02-practice-scheduling/02-RESEARCH.md

# Existing patterns
@prisma/schema.prisma
@src/lib/validations/equipment.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Practice and Block models to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the following to prisma/schema.prisma:

1. PracticeStatus enum:
   - DRAFT (only visible to coaches)
   - PUBLISHED (visible to all team members)

2. BlockType enum:
   - WATER
   - LAND
   - ERG

3. Practice model:
   - id: String @id @default(uuid())
   - teamId: String (relation to Team)
   - seasonId: String (relation to Season)
   - name: String (e.g., "Tuesday Steady State")
   - date: DateTime (the practice date)
   - startTime: DateTime (full datetime for start)
   - endTime: DateTime (full datetime for end)
   - status: PracticeStatus @default(DRAFT)
   - notes: String? (optional coach notes)
   - createdAt, updatedAt timestamps
   - Relation: blocks PracticeBlock[]
   - Indexes: [teamId], [teamId, seasonId], [teamId, date]

4. PracticeBlock model:
   - id: String @id @default(uuid())
   - practiceId: String (relation to Practice, onDelete: Cascade)
   - position: Int (0, 1, 2... for ordering)
   - type: BlockType
   - durationMinutes: Int? (optional, blocks are ordered not time-slotted)
   - category: String? (e.g., "steady-state", "intervals", "technique")
   - notes: String? (block-specific notes)
   - Index: [practiceId, position]

5. PracticeTemplate model:
   - id: String @id @default(uuid())
   - teamId: String
   - name: String
   - defaultStartTime: String (time only, e.g., "06:00")
   - defaultEndTime: String (time only, e.g., "08:00")
   - createdAt, updatedAt
   - Relation: blocks TemplateBlock[]
   - Index: [teamId]

6. TemplateBlock model (for practice templates):
   - id: String @id @default(uuid())
   - templateId: String (relation to PracticeTemplate, onDelete: Cascade)
   - position: Int
   - type: BlockType
   - durationMinutes: Int?
   - category: String?
   - notes: String?
   - Index: [templateId, position]

7. BlockTemplate model (standalone reusable blocks):
   - id: String @id @default(uuid())
   - teamId: String
   - name: String (e.g., "5k Erg Test", "Steady State 30min")
   - type: BlockType
   - durationMinutes: Int?
   - category: String?
   - notes: String?
   - createdAt, updatedAt
   - Index: [teamId, type]

8. Regatta model (placeholder for Phase 5):
   - id: String @id @default(uuid())
   - teamId: String
   - seasonId: String
   - name: String
   - location: String?
   - startDate: DateTime
   - endDate: DateTime?
   - createdAt, updatedAt
   - Index: [teamId], [teamId, seasonId]

9. Extend Equipment model:
   - Add: manualUnavailable Boolean @default(false)
   - Add: manualUnavailableNote String?

10. Update Season model to include relations:
    - practices Practice[]
    - regattas Regatta[]

11. Update Team model to include relations:
    - practices Practice[]
    - practiceTemplates PracticeTemplate[]
    - blockTemplates BlockTemplate[]
    - regattas Regatta[]

Follow existing schema patterns: uuid IDs, teamId on all team-scoped models, standard timestamps.
  </action>
  <verify>Run `npx prisma validate` - should pass with no errors</verify>
  <done>Prisma schema contains all new models with proper relations and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create Zod validation schemas for practices and templates</name>
  <files>src/lib/validations/practice.ts, src/lib/validations/template.ts</files>
  <action>
Create src/lib/validations/practice.ts:

1. blockTypeSchema: z.enum(['WATER', 'LAND', 'ERG'])

2. practiceStatusSchema: z.enum(['DRAFT', 'PUBLISHED'])

3. createBlockSchema:
   - type: blockTypeSchema (required)
   - durationMinutes: z.number().int().min(5).max(480).optional()
   - category: z.string().max(50).optional()
   - notes: z.string().max(500).optional()

4. createPracticeSchema:
   - seasonId: z.string().uuid()
   - name: z.string().min(1, 'Name is required').max(100)
   - date: z.string().datetime() (ISO string)
   - startTime: z.string().datetime()
   - endTime: z.string().datetime()
   - notes: z.string().max(1000).optional()
   - blocks: z.array(createBlockSchema).min(1, 'At least one block required')
   - Add refinement: endTime must be after startTime

5. updatePracticeSchema:
   - name, date, startTime, endTime, notes, status - all optional
   - No blocks (use separate block endpoints)

6. updateBlockSchema:
   - type, durationMinutes, category, notes - all optional

7. reorderBlocksSchema:
   - positions: z.array(z.object({ blockId: z.string().uuid(), position: z.number().int().min(0) }))

8. Export types: CreatePracticeInput, UpdatePracticeInput, CreateBlockInput, UpdateBlockInput

Create src/lib/validations/template.ts:

1. createTemplateBlockSchema (same fields as createBlockSchema)

2. createPracticeTemplateSchema:
   - name: z.string().min(1).max(100)
   - defaultStartTime: z.string().regex(/^([01]\d|2[0-3]):([0-5]\d)$/, 'Invalid time format (HH:MM)')
   - defaultEndTime: z.string().regex(/^([01]\d|2[0-3]):([0-5]\d)$/, 'Invalid time format (HH:MM)')
   - blocks: z.array(createTemplateBlockSchema).min(1)

3. updatePracticeTemplateSchema (partial of create, no blocks)

4. createBlockTemplateSchema:
   - name: z.string().min(1).max(100)
   - type: blockTypeSchema
   - durationMinutes: z.number().int().min(5).max(480).optional()
   - category: z.string().max(50).optional()
   - notes: z.string().max(500).optional()

5. updateBlockTemplateSchema (partial of create)

Follow existing validation patterns from equipment.ts: separate form and API schemas where needed, proper error messages.
  </action>
  <verify>Run `npx tsc --noEmit` - should compile with no type errors</verify>
  <done>Validation schemas exist and export proper types</done>
</task>

<task type="auto">
  <name>Task 3: Generate Prisma client and verify schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Run database migration to apply schema changes:

1. Run `npx prisma db push` to apply schema changes to database
2. Run `npx prisma generate` to regenerate client types
3. Verify the generated types include all new models

Note: Using db push (not migrate) for development. Migrations will be created before production deployment.

If db push fails due to existing data conflicts, the schema may need adjustments. Report any issues.
  </action>
  <verify>
Run `npx prisma validate` passes
Run `npx tsc --noEmit` passes (client types available)
  </verify>
  <done>Prisma client regenerated with new model types available for import</done>
</task>

</tasks>

<verification>
All checks must pass:
1. `npx prisma validate` - schema is valid
2. `npx prisma db push` - schema applied to database
3. `npx tsc --noEmit` - TypeScript compiles with new types
4. Practice, PracticeBlock, PracticeTemplate, BlockTemplate, Regatta models exist
5. Equipment model has manualUnavailable and manualUnavailableNote fields
</verification>

<success_criteria>
- Prisma schema contains all Phase 2 data models
- Zod validation schemas ready for API routes
- Database schema applied and Prisma client regenerated
- All existing functionality still works (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/02-practice-scheduling/02-01-SUMMARY.md`
</output>
