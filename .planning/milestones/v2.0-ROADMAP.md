# Milestone v2.0: Commercial Readiness

**Status:** IN PROGRESS
**Started:** 2026-01-22
**Phases:** 10-17
**Total Requirements:** 34

## Overview

v2.0 transforms RowOps from single-team platform to commercial-grade multi-facility SaaS. Eight phases deliver hierarchical tenancy (facility->club), mobile-first PWA experience, modern design system, and hardened security with comprehensive RBAC. Real-world scenario: Chattanooga Rowing (boathouse) hosts Lookout Rowing Club and Chattanooga Juniors, each with their own subscription, sharing some boats.

## Phases

### Phase 10: Security Foundation & RBAC

**Goal:** Application has bulletproof role hierarchy and tenant-scoped permissions foundation.
**Depends on:** None (foundation phase)
**Requirements:** SEC-04, SEC-05, SEC-06, SEC-07, SEC-11
**Plans:** 11 plans

Plans:
- [x] 10-01-PLAN.md - Schema migration (Role enum, ClubMembership, AuditLog, ApiKey)
- [x] 10-02-PLAN.md - CASL ability factory with role-specific permissions
- [x] 10-03-PLAN.md - Club context management with cookie persistence
- [x] 10-04-PLAN.md - React ability provider and Can component
- [x] 10-05-PLAN.md - Audit logging infrastructure
- [x] 10-06-PLAN.md - API key authentication utilities and middleware
- [x] 10-07-PLAN.md - API route integration with CASL permissions
- [x] 10-08-PLAN.md - API key management endpoints
- [x] 10-09-PLAN.md - Club switcher UI component
- [x] 10-10-PLAN.md - Audit log viewing and export endpoints
- [x] 10-11-PLAN.md - Role management and API key admin UI with verification

**Success Criteria:**
1. System enforces 5-role hierarchy (FACILITY_ADMIN -> CLUB_ADMIN -> COACH -> ATHLETE -> PARENT) with NO inheritance
2. User can have different roles in different clubs (admin in Club A, athlete in Club B)
3. All sensitive operations (role changes, team deletion, export) are logged with 365-day retention
4. User sessions refresh securely without re-login, expire appropriately on inactivity
5. External integrations can authenticate via API keys with scoped permissions

**Coverage:** 5/34 requirements

---

### Phase 11: MFA & SSO

**Goal:** Enterprise customers can use single sign-on and admins have multi-factor protection.
**Depends on:** Phase 10 (security foundation)
**Requirements:** SEC-08, SEC-09, SEC-10
**Plans:** 12 plans

Plans:
- [x] 11-01-PLAN.md - Database schema (MfaBackupCode, PermissionGrant, SsoConfig models)
- [x] 11-02-PLAN.md - MFA helper functions (Supabase integration, backup codes)
- [x] 11-03-PLAN.md - MFA API endpoints (enroll, verify, factors, unenroll, backup-codes)
- [x] 11-04-PLAN.md - Permission grant helper functions
- [x] 11-05-PLAN.md - Permission grants API and expiration cron job
- [x] 11-06-PLAN.md - CASL ability integration with permission grants
- [x] 11-07-PLAN.md - SSO configuration and role mapping utilities
- [x] 11-08-PLAN.md - SSO configuration API endpoint
- [x] 11-09-PLAN.md - MFA UI components (setup dialog, verify dialog, backup codes)
- [x] 11-10-PLAN.md - Security settings page (MFA section, permission grants)
- [x] 11-11-PLAN.md - SSO settings page (facility admin only)
- [x] 11-12-PLAN.md - End-to-end verification

**Success Criteria:**
1. Facility and club admins can enable MFA via authenticator app (TOTP)
2. Enterprise customers can configure SAML SSO with identity provider
3. Facility admin can grant custom permissions for edge cases (e.g., temporary elevated access)
4. SSO users inherit roles from identity provider claims

**Coverage:** 3/34 requirements

---

### Phase 12: Facility Schema Migration

**Goal:** Database supports facility->club hierarchy with backward-compatible equipment ownership.
**Depends on:** Phase 10 (security foundation must be stable)
**Requirements:** FAC-01, FAC-02, FAC-04
**Plans:** 7 plans

Plans:
- [ ] 12-01-PLAN.md - Prisma schema (Facility model, enums, relationships)
- [ ] 12-02-PLAN.md - RLS helper functions for facility hierarchy
- [ ] 12-03-PLAN.md - Update Custom Access Token Hook for facility claims
- [ ] 12-04-PLAN.md - Data migration (facility wrappers, equipment ownership)
- [ ] 12-05-PLAN.md - RLS policies for facility hierarchy
- [ ] 12-06-PLAN.md - TypeScript context helpers (claims, facility-context)
- [ ] 12-07-PLAN.md - End-to-end verification

**Success Criteria:**
1. Existing team-only installations continue working without migration
2. New facility can be created with multiple clubs under it
3. Equipment can be marked as facility-owned (shared), club-owned (exclusive), or team-owned (legacy)
4. Database RLS policies prevent cross-tenant data leaks even with connection pooling
5. All queries automatically filter by facility/club/team context with zero manual filtering

**Coverage:** 3/34 requirements

---

### Phase 13: Facility Auth Integration

**Goal:** Authentication system understands facility hierarchy and enforces tenant-scoped permissions.
**Depends on:** Phase 12 (schema must exist)
**Requirements:** Enables FAC-05, FAC-06 (auth needed before UI)

**Success Criteria:**
1. JWT claims include facility_id, club_id, team_id (nullable for backward compatibility)
2. User switching between clubs triggers cache invalidation and re-authentication
3. Facility admin can see aggregate data across all clubs in their facility
4. RLS policies use session variables to enforce facility/club boundaries
5. CASL ability checks work identically on client and server

**Coverage:** 0 requirements directly, enables 2 facility UI requirements

---

### Phase 14: Design System Foundation

**Goal:** Application has consistent component library with dark mode and mobile-first design.
**Depends on:** None (can run parallel with Phase 13)
**Requirements:** UIX-01, UIX-06

**Success Criteria:**
1. shadcn/ui components installed with Tailwind v4 theme configuration
2. User can toggle dark mode, preference persists across sessions
3. Top 5 high-traffic components migrated to shadcn/ui (Button, Dialog, DropdownMenu, Form inputs, Select)
4. Component migration tracking prevents drift (deprecated components tagged, new duplicates blocked)
5. Design system enforces 44px minimum touch targets by default

**Coverage:** 2/34 requirements

---

### Phase 15: Mobile PWA Improvements

**Goal:** Application provides native-app-quality mobile experience with offline-first architecture.
**Depends on:** None (can run parallel with Phases 13-14)
**Requirements:** MOB-01, MOB-02, MOB-03, MOB-04, MOB-05, MOB-06, MOB-07, MOB-08

**Success Criteria:**
1. All pages render correctly on mobile breakpoints (320px, 375px, 414px tested)
2. Interactive elements meet 44px minimum touch target on mobile (buttons, links, drag handles)
3. Offline mutations queue and sync when connectivity returns, conflicts auto-resolve or prompt user
4. Network connectivity indicator shows online/offline/syncing status
5. Swipe gestures work for common actions (swipe practice card to edit/delete)
6. Eligible users see PWA install prompt (iOS Safari, Android Chrome)
7. Bottom sheets replace traditional dropdowns on mobile for context menus
8. View transitions feel app-like with smooth animations between pages

**Coverage:** 8/34 requirements

---

### Phase 16: UI/UX Polish

**Goal:** Application provides modern, intuitive experience with helpful guidance and polished interactions.
**Depends on:** Phase 14 (design system foundation)
**Requirements:** UIX-02, UIX-03, UIX-04, UIX-05, UIX-07, UIX-08, UIX-09

**Success Criteria:**
1. Empty states for all list views provide helpful guidance ("No practices yet. Create your first practice to get started.")
2. Loading states use skeleton placeholders instead of spinners for content-heavy pages
3. Errors show actionable recovery ("Failed to save lineup. [Retry] [Discard changes]")
4. Forms validate inline with immediate feedback (email format, required fields, conflicts)
5. State transitions have micro-animations (success checkmark, delete slide-out)
6. New users complete onboarding flow that guides through first practice creation
7. Power users can use keyboard shortcuts (Cmd+K command palette, arrow keys for navigation)

**Coverage:** 7/34 requirements

---

### Phase 17: Facility UI Features

**Goal:** Facility admins can manage clubs and shared equipment through intuitive interface.
**Depends on:** Phases 12, 13, 14, 16 (schema + auth + design system + UX polish)
**Requirements:** FAC-03, FAC-05, FAC-06, FAC-07, FAC-08, FAC-09

**Success Criteria:**
1. Facility admin dashboard shows aggregate statistics (total clubs, athletes, equipment, upcoming events)
2. Facility admin can view all clubs under facility with drill-down to club details
3. Facility admin can manage shared equipment (create, edit, mark unavailable)
4. Clubs can reserve shared equipment via booking calendar, conflicts prevented
5. Facility admin can create facility-wide events visible to all clubs
6. Club admin can see subscription status with facility oversight (billing, limits)

**Coverage:** 6/34 requirements

---

## Progress

| Phase | Status | Requirements | Success Criteria |
|-------|--------|--------------|------------------|
| Phase 10: Security Foundation & RBAC | Complete (11 plans) | 5 | 5 |
| Phase 11: MFA & SSO | Complete (12 plans) | 3 | 4 |
| Phase 12: Facility Schema Migration | Planned (7 plans) | 3 | 5 |
| Phase 13: Facility Auth Integration | Pending | 0 (enables 2) | 5 |
| Phase 14: Design System Foundation | Pending | 2 | 5 |
| Phase 15: Mobile PWA Improvements | Pending | 8 | 8 |
| Phase 16: UI/UX Polish | Pending | 7 | 7 |
| Phase 17: Facility UI Features | Pending | 6 | 6 |

**Total:** 8/34 requirements complete

```
[##        ] 24% complete
```

## Requirement Coverage

| Category | Count | Phases |
|----------|-------|--------|
| Security & RBAC | 8 | Phase 10 (5), Phase 11 (3) |
| Facility Model | 9 | Phase 12 (3), Phase 17 (6) |
| Mobile PWA | 8 | Phase 15 (8) |
| UI/UX Polish | 9 | Phase 14 (2), Phase 16 (7) |

**Coverage:** 34/34 requirements mapped

## Phase Dependencies

```
Phase 10 (Security) ---+-> Phase 11 (MFA/SSO)
                       +-> Phase 12 (Schema) --> Phase 13 (Auth) --+
                                                                    +--> Phase 17 (Facility UI)
                           Phase 14 (Design) ----> Phase 16 (UX) --+

                           Phase 15 (Mobile) -- (parallel) --------+
```

**Critical path:** Phase 10 -> 12 -> 13 -> 17 (facility features blocking chain)
**Parallel opportunities:** Phase 15 (Mobile) can run parallel with Phases 13-14

## Key Decisions

| Decision | Rationale | Phase |
|----------|-----------|-------|
| Security foundation first | All features depend on stable hierarchical auth | Phase 10 |
| Expand-migrate-contract for schema | Backward compatibility for team-only installs | Phase 12 |
| JWT claims extension | Minimal change to existing auth system | Phase 13 |
| shadcn/ui over full framework | Copy-paste ownership, no runtime dependency | Phase 14 |
| Mobile parallel with auth | No dependency, can run simultaneously | Phase 15 |
| Facility UI last | Requires complete foundation (schema+auth+design) | Phase 17 |

## Technical Debt

**Incurred:**
- None yet (v2.0 just started)

**Planned mitigation:**
- Component migration tracking (Phase 14) to prevent drift
- RLS connection pooling tests (Phase 12) to prevent leaks
- Tenant-aware cache keys (Phase 15) to prevent cross-tenant data exposure

## Research Flags

**Phases needing deeper research during planning:**
- **Phase 13:** Custom Access Token Hook with Supabase Edge Functions (memory/timeout constraints)
- **Phase 17:** Equipment reservation conflict detection (partial boat availability logic)

**Standard patterns (skip research-phase):**
- **Phase 10:** Prisma Client Extensions, CASL setup
- **Phase 14:** shadcn/ui installation
- **Phase 15:** PWA offline-first, touch gestures
- **Phase 16:** Standard UI/UX patterns

---

*Roadmap created: 2026-01-22*
*Phase 10 planned: 2026-01-22 (11 plans in 5 waves)*
*Phase 10 completed: 2026-01-23*
*Phase 11 planned: 2026-01-23 (12 plans in 4 waves)*
*Phase 11 completed: 2026-01-23*
*Phase 12 planned: 2026-01-23 (7 plans in 5 waves)*
*For current project status, see .planning/ROADMAP.md*
