# Milestone v3.1: Admin Panel

**Status:** SHIPPED 2026-01-31
**Phases:** 36-40
**Total Plans:** 21

## Overview

Platform owner can manage all users, clubs, and memberships through a super-admin panel with full audit trail and compliance-ready logging.

## Phases

### Phase 36: Admin Foundation & Authentication

**Goal:** Super admin can securely access a protected admin panel with database-verified permissions
**Depends on:** None (foundational)
**Plans:** 5 plans

Plans:
- [x] 36-01-PLAN.md — Database foundation (SuperAdmin model, migration, seed script)
- [x] 36-02-PLAN.md — Auth & CASL (admin-authorize.ts, ability.ts extension, audit logger extension)
- [x] 36-03-PLAN.md — MFA setup (enrollment and verification pages)
- [x] 36-04-PLAN.md — Admin route group (layout, dashboard, sidebar, header)
- [x] 36-05-PLAN.md — Session timeout and verification checkpoint

**Requirements:**
- AUTH-01: Super admin role stored in database table (not JWT claims only)
- AUTH-02: Super admin login verified against database on every request
- AUTH-03: Admin session timeout at 30 minutes of inactivity
- AUTH-04: Super admin check in CASL abilities (`can('manage', 'all')`)
- AUTH-05: Separate `(admin)` route group with protected layout
- AUTH-06: MFA enforcement for super admin accounts
- AUDT-01: Log all admin actions (actor, action, target, timestamp, before/after)

---

### Phase 37: User Management

**Goal:** Super admin can fully manage platform users including creation, editing, deactivation, and bulk operations
**Depends on:** Phase 36 (admin auth required)
**Plans:** 5 plans

Plans:
- [x] 37-01-PLAN.md — Core user APIs (list, search, view, edit)
- [x] 37-02-PLAN.md — User operations APIs (create, deactivate, reactivate, password reset)
- [x] 37-03-PLAN.md — User list page with table, search, pagination
- [x] 37-04-PLAN.md — User detail and create pages
- [x] 37-05-PLAN.md — Bulk user creation via CSV upload

**Requirements:**
- USER-01: List all users with pagination (25 per page)
- USER-02: Search users by email, name, facility, club
- USER-03: Create user bypassing signup (admin sets email, generates password link)
- USER-04: View user details (profile, memberships, created date, last login)
- USER-05: Edit user profile (name, email, phone)
- USER-06: Deactivate user (soft disable, blocks login, preserves data)
- USER-07: Reactivate deactivated user
- USER-08: Reset user password (generate recovery link via Supabase Admin API)
- USER-09: Bulk user creation via CSV upload (email, name, optional role)

---

### Phase 38: Facility & Club Management

**Goal:** Super admin can manage all facilities and clubs with full CRUD operations and cross-facility actions
**Depends on:** Phase 36 (admin auth required)
**Plans:** 6 plans

Plans:
- [x] 38-01-PLAN.md — Facility APIs (list, create, detail, update, delete)
- [x] 38-02-PLAN.md — Club APIs (list, create, detail, update, delete, move)
- [x] 38-03-PLAN.md — Facility list and detail pages
- [x] 38-04-PLAN.md — Facility forms and type-to-confirm delete dialog
- [x] 38-05-PLAN.md — Club list and detail pages
- [x] 38-06-PLAN.md — Club forms and move dialog

**Requirements:**
- FCLT-01: List all facilities with club counts and member counts
- FCLT-02: Create facility (name, slug, location, contact info)
- FCLT-03: Edit facility details
- FCLT-04: View facility details with clubs and aggregate stats
- FCLT-05: Delete facility (soft delete with confirmation, cascade check)
- CLUB-01: List all clubs with member counts (global and by facility)
- CLUB-02: Create club (name, facility assignment, colors)
- CLUB-03: Edit club details
- CLUB-04: View club details with members and settings
- CLUB-05: Delete club (soft delete with confirmation, cascade check)
- CLUB-06: Move club between facilities

---

### Phase 39: Membership Management

**Goal:** Super admin can directly manage user-club relationships bypassing invitation flows
**Depends on:** Phase 37 (user management), Phase 38 (club management)
**Plans:** 4 plans

Plans:
- [x] 39-01-PLAN.md — Membership CRUD APIs (create, update roles, delete, list club members)
- [x] 39-02-PLAN.md — User detail membership UI (add to club, edit roles, remove)
- [x] 39-03-PLAN.md — Club members section (member list with add/edit/remove)
- [x] 39-04-PLAN.md — Bulk membership import via CSV

**Requirements:**
- MEMB-01: Add user to club with role(s) (bypasses invitation flow)
- MEMB-02: Remove user from club
- MEMB-03: Change user roles within club
- MEMB-04: View all memberships for a user (cross-org visibility)
- MEMB-05: Bulk add users to club via CSV (email + role)

---

### Phase 40: Audit Log Viewer & Export

**Goal:** Super admin can review and export audit history for compliance and debugging
**Depends on:** Phase 36 (audit logging infrastructure)
**Plans:** 1 plan

Plans:
- [x] 40-01-PLAN.md — Audit log viewer with filters, state diff display, and CSV export

**Requirements:**
- AUDT-02: Audit log viewer in admin panel (filterable by action, actor, date)
- AUDT-03: Audit log export (CSV download with date range filter)

---

## Milestone Summary

**Key Decisions:**
- Database-verified super admin (not JWT claims only) — security over performance
- SuperAdmin RLS blocks all writes — super admins created via seed script only
- Silent redirect for non-admins — no admin panel disclosure
- 'PLATFORM' clubId for admin audit — distinguishes platform-level logs
- 30-minute session timeout — security requirement for admin panel
- Soft delete for memberships — preserves audit trail
- Type-to-confirm delete pattern — GitHub-style safety for destructive actions
- URL-based filtering — bookmarkable search results
- Self-auditing export — CSV export logs DATA_EXPORTED action

**Issues Resolved:**
- Phase 36 missing VERIFICATION.md (verified via summaries)
- REQUIREMENTS.md checkboxes outdated (updated during audit)

**Technical Debt:**
- RLS security hardening still pending (7 migrations ready: 00010-00017)
- CASL migration identified (59 routes use legacy pattern)

---

*Archived: 2026-01-31*
*For current project status, see .planning/ROADMAP.md*
