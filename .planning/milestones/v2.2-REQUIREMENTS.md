# Requirements Archive: v2.2 Security Audit

**Archived:** 2026-01-29
**Status:** SHIPPED

This is the archived requirements specification for v2.2.
For current requirements, see `.planning/REQUIREMENTS.md` (created for next milestone).

---

# Requirements: Radl v2.2 Security Audit

**Defined:** 2026-01-28
**Core Value:** Coaches can plan practices with lineups and equipment, and athletes know where to be and what boat they're in.

## v2.2 Requirements

Security audit requirements to validate the app before beta testing.

### API Authentication

- [x] **AUTH-01**: All API routes require authentication (no unprotected endpoints)
- [x] **AUTH-02**: JWT signatures are verified on every request
- [x] **AUTH-03**: JWT expiration is enforced (expired tokens rejected)
- [x] **AUTH-04**: JWT claims are validated against expected structure
- [x] **AUTH-05**: Session persistence works correctly across browser refresh
- [x] **AUTH-06**: Logout properly invalidates session
- [x] **AUTH-07**: Token refresh works without re-authentication

### RBAC Permissions

- [x] **RBAC-01**: FACILITY_ADMIN can only access facility-level operations
- [x] **RBAC-02**: CLUB_ADMIN can only access their club's data
- [x] **RBAC-03**: COACH can manage practices/equipment but not club settings
- [x] **RBAC-04**: ATHLETE can only view their own schedule and assignments
- [ ] **RBAC-05**: PARENT can only view their linked athlete's data *(DEFERRED - ParentAthleteLink table missing)*
- [x] **RBAC-06**: CASL permissions are enforced server-side *(CONDITIONAL - 88 routes secure)*
- [x] **RBAC-07**: Role changes propagate immediately to permissions

### Tenant Isolation

- [x] **ISOL-01**: All database tables have RLS policies enabled *(CONDITIONAL - 5/43 core tenant tables)*
- [x] **ISOL-02**: RLS policies correctly filter by tenant (facility/club/team)
- [x] **ISOL-03**: Cross-tenant data access is blocked *(CONDITIONAL - pgTAP tests ready)*
- [x] **ISOL-04**: JWT claims match data access patterns
- [x] **ISOL-05**: Prisma queries include tenant filtering
- [x] **ISOL-06**: API responses don't leak data from other tenants

### Secrets & Environment

- [x] **SECR-01**: No secrets exposed in client-side JavaScript bundle
- [x] **SECR-02**: Environment variables properly scoped (NEXT_PUBLIC_ only for public)
- [x] **SECR-03**: Supabase service role key not accessible from client
- [x] **SECR-04**: API keys are hashed in database (not plaintext)
- [x] **SECR-05**: No hardcoded credentials in source code

### Audit Logging

- [x] **AUDIT-01**: Authentication events are logged (login, logout, failed attempts)
- [x] **AUDIT-02**: Data modification events are logged (create, update, delete)
- [x] **AUDIT-03**: Permission denied events are logged
- [x] **AUDIT-04**: Logs include user ID, timestamp, and action details
- [x] **AUDIT-05**: Logs are immutable (can't be modified after creation)

### Rate Limiting

- [x] **RATE-01**: Login endpoint has rate limiting
- [x] **RATE-02**: Signup endpoint has rate limiting
- [x] **RATE-03**: Password reset endpoint has rate limiting
- [x] **RATE-04**: Rate limit responses include proper headers
- [x] **RATE-05**: Rate limiting is per-IP (not global)

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| AUTH-01 | Phase 25 | Complete |
| AUTH-02 | Phase 25 | Complete |
| AUTH-03 | Phase 25 | Complete |
| AUTH-04 | Phase 25 | Complete |
| AUTH-05 | Phase 25 | Complete |
| AUTH-06 | Phase 25 | Complete |
| AUTH-07 | Phase 25 | Complete |
| RBAC-01 | Phase 26 | Complete |
| RBAC-02 | Phase 26 | Complete |
| RBAC-03 | Phase 26 | Complete |
| RBAC-04 | Phase 26 | Complete |
| RBAC-05 | Phase 26 | Deferred |
| RBAC-06 | Phase 26 | Conditional Pass |
| RBAC-07 | Phase 26 | Complete |
| ISOL-01 | Phase 26 | Conditional Pass |
| ISOL-02 | Phase 26 | Complete |
| ISOL-03 | Phase 26 | Conditional Pass |
| ISOL-04 | Phase 26 | Complete |
| ISOL-05 | Phase 26 | Complete |
| ISOL-06 | Phase 26 | Complete |
| SECR-01 | Phase 27 | Complete |
| SECR-02 | Phase 27 | Complete |
| SECR-03 | Phase 27 | Complete |
| SECR-04 | Phase 27 | Complete |
| SECR-05 | Phase 27 | Complete |
| AUDIT-01 | Phase 27 | Complete |
| AUDIT-02 | Phase 27 | Complete |
| AUDIT-03 | Phase 27 | Complete |
| AUDIT-04 | Phase 27 | Complete |
| AUDIT-05 | Phase 27 | Complete |
| RATE-01 | Phase 27 | Complete |
| RATE-02 | Phase 27 | Complete |
| RATE-03 | Phase 27 | Complete |
| RATE-04 | Phase 27 | Complete |
| RATE-05 | Phase 27 | Complete |

---

## Milestone Summary

**Shipped:** 33 of 35 requirements
**Conditional Pass:** 3 (RBAC-06, ISOL-01, ISOL-03)
**Deferred:** 1 (RBAC-05 - PARENT role, ParentAthleteLink table missing)
**Failed:** 0

**Adjusted:** None - all requirements implemented as specified

**Dropped:** None

---
*Archived: 2026-01-29 as part of v2.2 milestone completion*
