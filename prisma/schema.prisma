// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Facility model (boathouse/organization level)
model Facility {
  id                String      @id @default(uuid())
  name              String
  slug              String      @unique
  // Location
  address           String?
  city              String?
  state             String?
  country           String?     @default("US")
  timezone          String      @default("America/New_York")
  coordinates       Json? // { lat: number, lng: number }
  // Contact
  phone             String?
  email             String?
  website           String?
  // Branding
  logoUrl           String?
  description       String?
  // Billing (hybrid model)
  billingType       BillingType @default(FACILITY)
  bookingWindowDays Int         @default(30) // How far in advance clubs can book shared equipment
  // Timestamps
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  clubs       Team[]               @relation("FacilityClubs")
  equipment   Equipment[]          @relation("FacilityEquipment")
  memberships FacilityMembership[]

  @@index([slug])
}

// Multi-tenant team model (Club level in facility hierarchy)
model Team {
  id             String   @id @default(uuid())
  name           String
  slug           String   @unique
  primaryColor   String
  secondaryColor String
  logoUrl        String?
  joinCode       String   @unique // 8-char code for joining
  facilityId     String? // Nullable for backward compat during migration
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  facility          Facility?                 @relation("FacilityClubs", fields: [facilityId], references: [id])
  members           TeamMember[]
  invitations       Invitation[]
  equipment         Equipment[]
  settings          TeamSettings?
  seasons           Season[]
  practices         Practice[]
  practiceTemplates PracticeTemplate[]
  blockTemplates    BlockTemplate[]
  lineupTemplates   LineupTemplate[]
  regattas          Regatta[]
  rcConnection      RegattaCentralConnection?
  clubMemberships   ClubMembership[]          @relation("ClubMemberships")
  apiKeys           ApiKey[]                  @relation("ApiKeys")
  clubEquipment     Equipment[]               @relation("ClubEquipment")
  equipmentBookings EquipmentBooking[]        @relation("ClubBookings")
  announcements     Announcement[]
  workoutTemplates  WorkoutTemplate[]

  @@index([facilityId])
}

// Team membership linking users to teams with roles
model TeamMember {
  id        String   @id @default(uuid())
  teamId    String
  userId    String // References Supabase auth.users
  role      Role
  createdAt DateTime @default(now())

  team           Team            @relation(fields: [teamId], references: [id], onDelete: Cascade)
  athleteProfile AthleteProfile?

  @@unique([teamId, userId])
  @@index([userId]) // For RLS query performance
  @@index([teamId]) // For RLS query performance
}

// Club membership supporting multi-club with multiple roles per user
model ClubMembership {
  id        String   @id @default(uuid())
  clubId    String // References Team.id (club = team in current schema)
  userId    String // Supabase auth user ID
  roles     Role[] // Array of roles (can be COACH + ATHLETE)
  isActive  Boolean  @default(true)
  joinedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  club Team @relation("ClubMemberships", fields: [clubId], references: [id], onDelete: Cascade)

  @@unique([clubId, userId])
  @@index([userId])
  @@index([clubId])
  @@index([userId, isActive])
}

// FacilityMembership for facility-level roles (FACILITY_ADMIN)
model FacilityMembership {
  id         String   @id @default(uuid())
  facilityId String
  userId     String // Supabase auth user ID
  roles      Role[] // FACILITY_ADMIN only at this level
  isActive   Boolean  @default(true)
  joinedAt   DateTime @default(now())
  updatedAt  DateTime @updatedAt

  facility Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  @@unique([facilityId, userId])
  @@index([userId])
  @@index([facilityId])
}

// Invitation model for email invites and team code joins
model Invitation {
  id         String           @id @default(uuid())
  teamId     String
  email      String? // For email invites (nullable for code-based joins)
  userId     String? // User ID who is requesting to join (for team code joins)
  role       Role
  status     InvitationStatus @default(PENDING)
  invitedBy  String // User ID who created the invite
  athleteId  String? // For parent invites, links to the athlete
  createdAt  DateTime         @default(now())
  acceptedAt DateTime?

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId]) // For listing team invitations
  @@index([email]) // For looking up invitations by email
  @@index([userId]) // For looking up invitations by user
}

// Role enum for team members (expanded for RBAC)
enum Role {
  FACILITY_ADMIN
  CLUB_ADMIN
  COACH
  ATHLETE
  PARENT
}

// Invitation status enum
enum InvitationStatus {
  PENDING
  ACCEPTED
  REVOKED
}

// Equipment type enum
enum EquipmentType {
  SHELL
  OAR
  LAUNCH
  OTHER
}

// Equipment status enum
enum EquipmentStatus {
  ACTIVE
  INACTIVE
  RETIRED // For equipment no longer in use but kept for historical records/insurance
}

// Boat class enum (for shells)
enum BoatClass {
  SINGLE_1X
  DOUBLE_2X
  PAIR_2_MINUS
  COXED_PAIR_2_PLUS
  FOUR_4_MINUS
  COXED_FOUR_4_PLUS
  QUAD_4X
  EIGHT_8_PLUS
  OTHER
}

// Weight category enum (for shells)
enum WeightCategory {
  LIGHTWEIGHT
  MIDWEIGHT
  HEAVYWEIGHT
}

// Damage report status enum
enum DamageReportStatus {
  OPEN
  RESOLVED
}

// Report severity enum for public issue reporting
enum ReportSeverity {
  MINOR // Cosmetic damage, can still use
  MODERATE // Functional impact, needs attention
  CRITICAL // Unsafe to use, immediate action required
}

// Side preference enum (for rowers)
enum Side {
  PORT
  STARBOARD
  BOTH
}

// Regatta source enum (how regatta was created)
enum RegattaSource {
  REGATTA_CENTRAL
  MANUAL
}

// Entry status enum (race entry state)
enum EntryStatus {
  SCHEDULED
  SCRATCHED
  COMPLETED
}

// Notification type enum
enum NotificationType {
  DAMAGE_REPORT
  LINEUP_ASSIGNMENT
  PRACTICE_CHANGE
  PRACTICE_CANCELLED
  ATHLETE_JOINED
  EQUIPMENT_REQUEST // New: booking request notification
}

// Booking status enum
enum BookingStatus {
  PENDING // Request awaiting approval
  APPROVED // Confirmed booking
  DENIED // Request rejected
  CANCELLED // Booking cancelled by requester
}

// Announcement priority enum
enum AnnouncementPriority {
  INFO
  WARNING
  URGENT
}

// Season status enum
enum SeasonStatus {
  ACTIVE
  ARCHIVED
}

// Practice status enum
enum PracticeStatus {
  DRAFT // Only visible to coaches
  PUBLISHED // Visible to all team members
}

// Billing type enum (facility subscription model)
enum BillingType {
  FACILITY // Facility pays for all clubs
  CLUB // Each club has own subscription
  HYBRID // Mix - some clubs pay, some don't
}

// Equipment ownership type enum (hierarchy level)
enum EquipmentOwnerType {
  FACILITY // Shared across facility (boathouse boats)
  CLUB // Club-exclusive (club-owned boats)
  TEAM // Legacy team-owned (backward compat)
}

// Block type enum
enum BlockType {
  WATER
  LAND
  ERG
  MEETING
}

// Workout type enum (PM5-style workouts)
enum WorkoutType {
  SINGLE_TIME
  SINGLE_DISTANCE
  INTERVALS
  VARIABLE_INTERVALS
}

// Seat side enum (for sweep boats)
enum SeatSide {
  PORT
  STARBOARD
  NONE // For scull boats and coxswain
}

// Equipment model for tracking team assets (shells, oars, launches, etc.)
model Equipment {
  id                    String             @id @default(uuid())
  teamId                String? // Optional for facility-owned equipment
  type                  EquipmentType
  name                  String // e.g., "Varsity 8+", "Oar Set A"
  manufacturer          String?
  serialNumber          String?
  yearAcquired          Int?
  purchasePrice         Decimal? // For insurance purposes
  status                EquipmentStatus    @default(ACTIVE)
  notes                 String? // For rigging info, etc.
  // Shell-specific fields
  boatClass             BoatClass?
  weightCategory        WeightCategory?
  // Manual unavailability for practice scheduling
  manualUnavailable     Boolean            @default(false)
  manualUnavailableNote String?
  lastInspectedAt       DateTime? // When equipment was last inspected (null = never)
  // Ownership hierarchy
  ownerType             EquipmentOwnerType @default(TEAM)
  facilityId            String?
  clubId                String?
  isShared              Boolean            @default(false) // For club equipment shared with facility
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  team          Team?               @relation(fields: [teamId], references: [id], onDelete: Cascade)
  facility      Facility?           @relation("FacilityEquipment", fields: [facilityId], references: [id])
  club          Team?               @relation("ClubEquipment", fields: [clubId], references: [id])
  damageReports DamageReport[]
  usageLogs     EquipmentUsageLog[]
  lineups       Lineup[]
  templateBoats LineupTemplate[]
  entryLineups  EntryLineup[]
  bookings      EquipmentBooking[]

  @@index([teamId])
  @@index([teamId, type])
  @@index([facilityId])
  @@index([clubId])
  @@index([ownerType])
}

// Equipment booking for shared equipment reservation
model EquipmentBooking {
  id           String        @id @default(uuid())
  equipmentId  String
  clubId       String // Club making the booking
  practiceId   String? // Optional: linked to practice (automatic booking)
  startTime    DateTime
  endTime      DateTime
  status       BookingStatus @default(PENDING)
  requestedBy  String // userId who created request
  approvedBy   String? // userId who approved (if approved)
  deniedReason String? // Reason for denial (if denied)
  notes        String? // Optional booking notes
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  club      Team      @relation("ClubBookings", fields: [clubId], references: [id], onDelete: Cascade)
  practice  Practice? @relation(fields: [practiceId], references: [id], onDelete: SetNull)

  @@index([equipmentId, startTime, endTime])
  @@index([clubId])
  @@index([practiceId])
  @@index([status])
}

// Damage report model for tracking equipment damage
model DamageReport {
  id             String             @id @default(uuid())
  equipmentId    String
  teamId         String // Denormalized for easier RLS
  reportedBy     String? // userId who reported (optional for public reports)
  reporterName   String // Required reporter name for all reports
  location       String // Where on equipment
  description    String // What's wrong
  severity       ReportSeverity     @default(MODERATE)
  category       String? // Hull, Rigging, Hardware, Other, etc.
  photoUrl       String? // Supabase Storage URL
  status         DamageReportStatus @default(OPEN)
  resolvedAt     DateTime?
  resolvedBy     String?
  resolutionNote String? // Optional note on how issue was resolved
  archivedAt     DateTime? // When report was archived (MINOR reports after resolution)
  createdAt      DateTime           @default(now())

  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@index([equipmentId])
  @@index([teamId])
  @@index([teamId, status])
}

// Athlete profile model for rowing-specific data
model AthleteProfile {
  id             String   @id @default(uuid())
  teamMemberId   String   @unique
  displayName    String? // User's display name, set from invite or user input
  sidePreference Side?
  canBow         Boolean  @default(false)
  canCox         Boolean  @default(false)
  phone          String? // Personal phone
  emergencyName  String? // Emergency contact name
  emergencyPhone String? // Emergency contact phone
  photoUrl       String? // Supabase Storage URL
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  teamMember      TeamMember           @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  eligibility     AthleteEligibility[]
  seatAssignments SeatAssignment[]
  templateSeats   TemplateSeat[]
  landAssignments LandAssignment[]
  entrySeats      EntrySeat[]

  @@index([teamMemberId])
}

// Notification model for alerts (damage reports, etc.)
model Notification {
  id        String           @id @default(uuid())
  teamId    String
  userId    String // Recipient
  type      NotificationType
  title     String
  message   String
  linkUrl   String? // Where to navigate
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([userId, read])
  @@index([teamId])
}

// Team settings model for configurable team preferences
model TeamSettings {
  id                          String   @id @default(uuid())
  teamId                      String   @unique
  damageNotifyUserIds         String[] // Array of userIds to notify on damage reports
  // Equipment readiness thresholds (days since inspection)
  readinessInspectSoonDays    Int      @default(14) // Yellow: approaching inspection
  readinessNeedsAttentionDays Int      @default(21) // Amber: overdue for inspection
  readinessOutOfServiceDays   Int      @default(30) // Red: must inspect before use
  // Regatta Central region filtering
  regattaRegions              String[] @default([]) // RC region codes for regatta filtering (e.g., ["US", "CA"])
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
}

// Season container for practices, regattas, and eligibility
model Season {
  id        String       @id @default(uuid())
  teamId    String
  name      String // e.g., "Fall 2026", "Novice Training"
  startDate DateTime?
  endDate   DateTime?
  status    SeasonStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  team               Team                 @relation(fields: [teamId], references: [id], onDelete: Cascade)
  athleteEligibility AthleteEligibility[]
  practices          Practice[]
  regattas           Regatta[]

  @@index([teamId])
  @@index([teamId, status])
}

// Per-season eligibility tracking for athletes
model AthleteEligibility {
  id        String @id @default(uuid())
  seasonId  String
  athleteId String // References AthleteProfile.id

  isEligible     Boolean @default(false) // Manual override flag
  waiverSigned   Boolean @default(false)
  swimTestPassed Boolean @default(false)
  customFields   Json    @default("{}") // Team-defined requirements

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  season  Season         @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  athlete AthleteProfile @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@unique([seasonId, athleteId])
  @@index([seasonId])
  @@index([athleteId])
}

// Practice model for scheduled training sessions
model Practice {
  id        String         @id @default(uuid())
  teamId    String
  seasonId  String
  name      String // e.g., "Tuesday Steady State"
  date      DateTime // The practice date
  startTime DateTime // Full datetime for start
  endTime   DateTime // Full datetime for end
  status    PracticeStatus @default(DRAFT)
  notes     String? // Optional coach notes
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  team              Team                @relation(fields: [teamId], references: [id], onDelete: Cascade)
  season            Season              @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  blocks            PracticeBlock[]
  usageLogs         EquipmentUsageLog[]
  equipmentBookings EquipmentBooking[]
  announcements     Announcement[]

  @@index([teamId])
  @@index([teamId, seasonId])
  @@index([teamId, date])
}

// Practice block for ordered segments within a practice
model PracticeBlock {
  id              String    @id @default(uuid())
  practiceId      String
  position        Int // 0, 1, 2... for ordering
  type            BlockType
  title           String? // Block title (e.g., "Warm-up Row", "5k Erg Test")
  durationMinutes Int? // Optional, blocks are ordered not time-slotted
  category        String? // e.g., "steady-state", "intervals", "technique"
  notes           String? // Block-specific notes

  practice        Practice         @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  lineup          Lineup[]
  landAssignments LandAssignment[]
  workout         Workout?

  @@index([practiceId, position])
}

// Practice template for reusable practice structures
model PracticeTemplate {
  id               String   @id @default(uuid())
  teamId           String
  name             String
  defaultStartTime String // Time only, e.g., "06:00"
  defaultEndTime   String // Time only, e.g., "08:00"
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  team   Team            @relation(fields: [teamId], references: [id], onDelete: Cascade)
  blocks TemplateBlock[]

  @@index([teamId])
}

// Template block for practice templates
model TemplateBlock {
  id              String    @id @default(uuid())
  templateId      String
  position        Int
  type            BlockType
  durationMinutes Int?
  category        String?
  notes           String?

  template PracticeTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId, position])
}

// Standalone reusable block for quick insertion
model BlockTemplate {
  id              String    @id @default(uuid())
  teamId          String
  name            String // e.g., "5k Erg Test", "Steady State 30min"
  type            BlockType
  durationMinutes Int?
  category        String?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId, type])
}

// Workout model for PM5-style workout definitions attached to blocks
model Workout {
  id                String      @id @default(uuid())
  blockId           String      @unique // One workout per block
  type              WorkoutType
  notes             String?
  visibleToAthletes Boolean     @default(true) // Coach controls visibility
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  block     PracticeBlock     @relation(fields: [blockId], references: [id], onDelete: Cascade)
  intervals WorkoutInterval[]

  @@index([blockId])
}

// Workout interval model for PM5-style intervals
model WorkoutInterval {
  id               String  @id @default(uuid())
  workoutId        String
  position         Int // Order within workout (0-49, PM5 limit is 50)
  durationType     String // 'time' or 'distance'
  duration         Int // Seconds for time, meters for distance
  targetSplit      String? // "2:05.0" format for erg
  targetStrokeRate Int? // SPM for water workouts (16-40)
  restDuration     Int     @default(0) // Rest seconds after interval
  restType         String  @default("time") // 'time' or 'undefined'

  workout Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  @@unique([workoutId, position])
  @@index([workoutId])
}

// Workout template model for reusable workout definitions
model WorkoutTemplate {
  id        String      @id @default(uuid())
  teamId    String
  name      String
  type      WorkoutType
  notes     String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  team      Team                      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  intervals WorkoutTemplateInterval[]

  @@index([teamId])
  @@index([teamId, type])
}

// Workout template interval model
model WorkoutTemplateInterval {
  id               String  @id @default(uuid())
  templateId       String
  position         Int
  durationType     String
  duration         Int
  targetSplit      String?
  targetStrokeRate Int?
  restDuration     Int     @default(0)
  restType         String  @default("time")

  template WorkoutTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, position])
  @@index([templateId])
}

// Lineup model for water blocks - assigns athletes to boat positions
model Lineup {
  id        String   @id @default(uuid())
  blockId   String // Multiple lineups allowed per block (multiple boats)
  boatId    String? // Optional, nullable until boat assigned
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  block     PracticeBlock       @relation(fields: [blockId], references: [id], onDelete: Cascade)
  boat      Equipment?          @relation(fields: [boatId], references: [id])
  seats     SeatAssignment[]
  usageLogs EquipmentUsageLog[]

  @@index([blockId])
}

// Seat assignment for linking athletes to positions within lineups
model SeatAssignment {
  id        String   @id @default(uuid())
  lineupId  String
  athleteId String
  position  Int // 1-based: 1=Bow, 2-7=Middle, 8=Stroke, 9=Cox
  side      SeatSide

  lineup  Lineup         @relation(fields: [lineupId], references: [id], onDelete: Cascade)
  athlete AthleteProfile @relation(fields: [athleteId], references: [id])

  @@unique([lineupId, position]) // One athlete per position
  @@unique([lineupId, athleteId]) // Athlete can't be in multiple seats
  @@index([lineupId])
}

// Lineup template for reusable configurations
model LineupTemplate {
  id            String    @id @default(uuid())
  teamId        String
  name          String // e.g., "Varsity 1V Standard"
  boatClass     BoatClass // Target boat size
  defaultBoatId String? // Optional default boat
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  team        Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  seats       TemplateSeat[]
  defaultBoat Equipment?     @relation(fields: [defaultBoatId], references: [id])

  @@index([teamId])
  @@index([teamId, boatClass])
}

// Template seat for default athlete positions
model TemplateSeat {
  id         String   @id @default(uuid())
  templateId String
  athleteId  String? // Optional default athlete
  position   Int
  side       SeatSide

  template LineupTemplate  @relation(fields: [templateId], references: [id], onDelete: Cascade)
  athlete  AthleteProfile? @relation(fields: [athleteId], references: [id])

  @@unique([templateId, position])
  @@index([templateId])
}

// Equipment usage log for tracking boat assignments
model EquipmentUsageLog {
  id          String   @id @default(uuid())
  equipmentId String
  teamId      String // Denormalized for queries
  practiceId  String
  lineupId    String? // Optional, for tracking which lineup used it
  usageDate   DateTime // The practice date
  createdAt   DateTime @default(now())

  equipment Equipment @relation(fields: [equipmentId], references: [id])
  practice  Practice  @relation(fields: [practiceId], references: [id])
  lineup    Lineup?   @relation(fields: [lineupId], references: [id])

  @@index([equipmentId])
  @@index([teamId])
  @@index([practiceId])
}

// Land assignment for erg/land blocks - group-based
model LandAssignment {
  id        String @id @default(uuid())
  blockId   String
  athleteId String

  block   PracticeBlock  @relation(fields: [blockId], references: [id], onDelete: Cascade)
  athlete AthleteProfile @relation(fields: [athleteId], references: [id])

  @@unique([blockId, athleteId]) // Athlete assigned once per block
  @@index([blockId])
}

// Regatta model for race events
model Regatta {
  id          String        @id @default(uuid())
  teamId      String
  seasonId    String
  name        String
  location    String?
  venue       String? // Specific venue/course name
  timezone    String? // IANA timezone (e.g., 'America/New_York')
  startDate   DateTime
  endDate     DateTime?
  source      RegattaSource @default(MANUAL)
  rcRegattaId String? // Regatta Central ID if imported
  lastSyncAt  DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  team    Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  season  Season  @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  entries Entry[]

  @@unique([teamId, rcRegattaId])
  @@index([teamId])
  @@index([teamId, seasonId])
  @@index([teamId, startDate])
}

// Entry model for individual race entries within a regatta
model Entry {
  id              String      @id @default(uuid())
  regattaId       String
  eventName       String // e.g., "Women's Varsity 8+"
  eventCode       String? // RC event code
  rcEntryId       String? // Regatta Central entry ID
  scheduledTime   DateTime // Race time (UTC)
  meetingLocation String? // Where to rig/meet (REG-06)
  meetingTime     DateTime? // When to meet
  notes           String? // Special instructions (REG-07)
  status          EntryStatus @default(SCHEDULED)
  heat            String? // e.g., "Heat 1", "Final"
  lane            Int?
  placement       Int? // Result after race
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  regatta            Regatta             @relation(fields: [regattaId], references: [id], onDelete: Cascade)
  entryLineup        EntryLineup?
  notificationConfig NotificationConfig?

  @@unique([regattaId, rcEntryId])
  @@index([regattaId])
  @@index([regattaId, scheduledTime])
}

// EntryLineup model for race lineup assignments
model EntryLineup {
  id        String   @id @default(uuid())
  entryId   String   @unique
  boatId    String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  entry Entry       @relation(fields: [entryId], references: [id], onDelete: Cascade)
  boat  Equipment?  @relation(fields: [boatId], references: [id])
  seats EntrySeat[]

  @@index([entryId])
}

// EntrySeat model for athlete positions within race lineups
model EntrySeat {
  id            String   @id @default(uuid())
  entryLineupId String
  athleteId     String
  position      Int // 1=Bow, etc.
  side          SeatSide

  entryLineup EntryLineup    @relation(fields: [entryLineupId], references: [id], onDelete: Cascade)
  athlete     AthleteProfile @relation(fields: [athleteId], references: [id])

  @@unique([entryLineupId, position])
  @@unique([entryLineupId, athleteId])
  @@index([entryLineupId])
}

// NotificationConfig model for race notification scheduling
model NotificationConfig {
  id               String    @id @default(uuid())
  entryId          String    @unique
  leadTimeMinutes  Int       @default(60) // Default 1 hour before
  notificationSent Boolean   @default(false)
  scheduledFor     DateTime?
  sentAt           DateTime?

  entry Entry @relation(fields: [entryId], references: [id], onDelete: Cascade)

  @@index([scheduledFor, notificationSent])
}

// RegattaCentralConnection model for OAuth tokens per team
model RegattaCentralConnection {
  id              String    @id @default(uuid())
  teamId          String    @unique
  rcClubId        String // Regatta Central organization ID
  encryptedToken  String // AES-256 encrypted access token
  refreshToken    String // AES-256 encrypted refresh token
  expiresAt       DateTime
  lastSyncAt      DateTime?
  autoSyncEnabled Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
}

// Push notification subscriptions for Web Push Protocol
model PushSubscription {
  id             String    @id @default(uuid())
  userId         String // Supabase auth user ID
  teamId         String // For team-scoped notifications
  endpoint       String    @unique // Push service endpoint URL
  p256dh         String // Public key for encryption
  auth           String // Auth secret for encryption
  expirationTime DateTime? // Optional expiration from browser
  userAgent      String? // For debugging
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([userId])
  @@index([teamId])
  @@index([teamId, userId])
}

// Audit log for security-critical operations (365-day retention)
model AuditLog {
  id         String   @id @default(uuid())
  clubId     String // Tenant scoping
  userId     String // Who performed action
  action     String // e.g., 'ROLE_CHANGED', 'MEMBER_REMOVED', 'DATA_EXPORTED'
  targetType String // e.g., 'ClubMembership', 'Practice', 'Equipment'
  targetId   String? // ID of affected record (nullable for bulk ops)
  metadata   Json     @default("{}") // Action-specific details
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([clubId])
  @@index([userId])
  @@index([createdAt])
  @@index([clubId, createdAt])
  @@index([action])
}

// API keys for external integrations (sk_ prefix pattern)
model ApiKey {
  id          String    @id @default(uuid())
  clubId      String
  name        String // User-friendly name
  keyPrefix   String // First 8 chars for identification (e.g., 'sk_live_a')
  keyHash     String    @unique // SHA-256 hash of full key
  createdBy   String // userId who created the key
  permissions Json      @default("{}") // Reserved for future scoped permissions
  lastUsedAt  DateTime?
  expiresAt   DateTime? // Optional expiration
  revokedAt   DateTime? // Soft delete via revocation
  createdAt   DateTime  @default(now())

  club Team @relation("ApiKeys", fields: [clubId], references: [id], onDelete: Cascade)

  @@index([clubId])
  @@index([keyPrefix])
  @@index([createdBy])
}

// MFA backup codes for account recovery (SHA-256 hashed)
model MfaBackupCode {
  id        String    @id @default(uuid())
  userId    String // Supabase auth user ID
  codeHash  String // SHA-256 hash of backup code
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@unique([userId, codeHash])
  @@index([userId])
}

// Temporary permission grants with expiration (elevated access)
model PermissionGrant {
  id         String    @id @default(uuid())
  clubId     String // Club where grant applies
  userId     String // Who receives elevated access
  grantedBy  String // Who granted it
  roles      Role[] // Elevated roles granted
  reason     String? // Why granted (audit trail)
  expiresAt  DateTime // When grant expires
  revokedAt  DateTime? // Soft revoke before expiration
  notifiedAt DateTime? // When expiration warning sent
  createdAt  DateTime  @default(now())

  @@index([clubId])
  @@index([userId])
  @@index([expiresAt])
  @@index([userId, clubId])
}

// SSO configuration per facility (SAML/OIDC provider settings)
model SsoConfig {
  id            String   @id @default(uuid())
  facilityId    String   @unique // Facility where SSO applies (currently maps to Team.id)
  enabled       Boolean  @default(false)
  ssoProviderId String? // From Supabase SSO setup
  idpDomain     String? // e.g., 'company.com'
  idpGroupClaim String   @default("groups") // Which claim contains group membership
  roleMappings  Json     @default("[]") // Array of { idpValue, rowopsRoles }
  defaultRole   Role     @default(ATHLETE) // Default if no mapping matches
  allowOverride Boolean  @default(true) // Facility admin can override SSO roles
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([facilityId])
  @@index([ssoProviderId])
}

// Announcement model for team broadcasts
model Announcement {
  id         String               @id @default(uuid())
  teamId     String
  title      String
  body       String
  priority   AnnouncementPriority @default(INFO)
  createdBy  String // userId who created
  practiceId String?
  expiresAt  DateTime?
  archivedAt DateTime?
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt

  team         Team               @relation(fields: [teamId], references: [id], onDelete: Cascade)
  practice     Practice?          @relation(fields: [practiceId], references: [id], onDelete: SetNull)
  readReceipts AnnouncementRead[]

  @@index([teamId, archivedAt])
  @@index([teamId, priority, createdAt])
  @@index([practiceId])
}

// AnnouncementRead model for tracking per-user read state
model AnnouncementRead {
  id             String   @id @default(uuid())
  announcementId String
  userId         String
  readAt         DateTime @default(now())

  announcement Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)

  @@unique([announcementId, userId])
  @@index([userId])
  @@index([announcementId])
}
